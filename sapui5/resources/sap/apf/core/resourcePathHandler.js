/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
(function(){'use strict';jQuery.sap.declare("sap.apf.core.resourcePathHandler");jQuery.sap.require("sap.apf.core.utils.checkForTimeout");jQuery.sap.require("sap.apf.core.utils.filter");jQuery.sap.require("sap.apf.utils.hashtable");jQuery.sap.require("sap.apf.core.messageHandler");jQuery.sap.require("sap.apf.core.messageDefinition");jQuery.sap.require("sap.apf.core.odataProxy");jQuery.sap.require("sap.apf.core.layeredRepositoryProxy");jQuery.sap.require("sap.apf.core.constants");jQuery.sap.require("sap.apf.utils.startParameter");jQuery.sap.require("sap.apf.utils.utils");sap.apf.core.ResourcePathHandler=function(i){var t=this;var c=i.instances.coreApi;var m=i.instances.messageHandler;var h=new sap.apf.utils.Hashtable(m);var C;var p;var s=null;var b=false;var I=false;var P=sap.apf.core.OdataProxy;n();this.loadConfigFromFilePath=function(F){if(b){return;}if(c.getStartParameterFacade().getAnalyticalConfigurationId()){I=true;}var U=F;c.ajax({url:U,dataType:"json",success:q,error:function(J,S,E){var M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorLoadingRessource,rawText:"Error "+E+" when loading the configuration of the resource location: "+U});m.putMessage(M);},async:false});e();if(I){l();}else{d();}b=true;function q(D,S,J){var M=sap.apf.core.utils.checkForTimeout(J);if(M){m.putMessage(m.createMessageObject({code:sap.apf.core.constants.message.code.errorStartUp,rawText:"Timeout when loading application configuration from "+F+"."}));}if(!D||!D.applicationConfiguration){m.putMessage(m.createMessageObject({code:sap.apf.core.constants.message.code.errorStartUp,rawText:"The application configuration from "+F+" has no valid format."}));return;}if(D.applicationConfiguration.textResourceLocations===undefined){m.putMessage(m.createMessageObject({code:sap.apf.core.constants.message.code.errorStartUp,rawText:"The textResourceLocations is missing in the application configuration from "+F+"."}));return;}o(D);}};function u(){return c.getStartParameterFacade().isLrepActive();}function l(){var q=c.getStartParameterFacade().getAnalyticalConfigurationId();var r=q.applicationId;var v=q.configurationId;if(u()&&!r){m.putMessage(m.createMessageObject({code:"5024"}));}var w=new P({serviceRoot:p.path.service,entityTypes:{configuration:sap.apf.core.constants.entitySets.configuration,texts:sap.apf.core.constants.entitySets.texts}},{instances:{coreApi:c,messageHandler:m}});w.readEntity("configuration",function(x,y,z){if(z){m.putMessage(m.createMessageObject({code:"5022",aParameters:[v]}));}else{var A=JSON.parse(x.SerializedAnalyticalConfiguration);c.loadAnalyticalConfiguration(JSON.parse(x.SerializedAnalyticalConfiguration));r=r||x.Application;a(r,w);if(A.applicationTitle){C.appName=A.applicationTitle.key;C.appTitle=A.applicationTitle.key;}}},[{name:"AnalyticalConfiguration",value:v}],undefined,false,r,{layer:'ALL'});}function a(q,r){var v=new sap.apf.core.utils.Filter(m,'Application','eq',q);var w=new sap.apf.core.utils.Filter(m,'Language','eq',sap.apf.core.constants.developmentLanguage);w.addAnd(v);var x=["TextElement","TextElementDescription"];r.readCollection('texts',function(y,z,A){if(A){m.putMessage(m.createMessageObject({code:"5023",aParameters:[sap.apf.utils.uriParameter.getConfigurationId()]}));}else{c.loadTextElements(y);}},undefined,x,w,false,{layer:'ALL'});}function d(){var U=t.getResourceLocation(sap.apf.core.constants.resourceLocation.analyticalConfigurationLocation);var M;if(U!==""){c.ajax({url:U,dataType:"json",success:function(D,S,J){if(D){c.loadAnalyticalConfiguration(D);if(D.applicationTitle){C.appName=D.applicationTitle.key;C.appTitle=D.applicationTitle.key;}}else{M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorLoadingAnalyticalConfig,rawText:"No data received when loading analytical configuration file"+U});m.putMessage(M);}},error:function(J,S,E){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorLoadingAnalyticalConfig,rawText:"Error "+E+" when loading analytical configuration file"+U});m.putMessage(M);},async:false});}else{M=m.createMessageObject({code:sap.apf.core.constants.message.code.missingAnalyticalConfig,rawText:"No analytical configuration defined in the application configuration"});m.putMessage(M);}}function e(){c.loadMessageConfiguration(sap.apf.core.messageDefinition,true);f(sap.apf.core.constants.resourceLocation.applicationMessageDefinitionLocation,false);}function f(r,R){var U=t.getResourceLocation(r);if(U!==""){c.ajax({url:U,dataType:"json",success:q,error:function(J,S,E){var M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorLoadingAnalyticalConfig,rawText:"Error "+E+" when loading message configuration file"+U});m.putMessage(M);},async:false});}function q(D,S,J){var M;var v=sap.apf.core.utils.checkForTimeout(J);if(!v){if(D.messageConfiguration){c.loadMessageConfiguration(D.messageConfiguration.definitions,R);}}else{M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorLoadingAnalyticalConfig,rawText:"Timeout error when loading message configuration file"+U});m.putMessage(M);}}}function g(q){var M;if(!q||!q.path){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"persistence path configuration is missing in the application configuration"});m.putMessage(M);}if(!q.path.service){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"service in persistence path configuration is missing"});m.putMessage(M);}if(q.analyticalConfiguration){if(!q.analyticalConfiguration.service){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"service or entity set are missing in analytical configuration in the application configuration"});m.putMessage(M);}}}function j(q){var M;if(q.evaluations&&!q.evaluations.service){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"service in Smart Business service root configuration is missing"});m.putMessage(M);}if(q.evaluations&&(!q.evaluations.type||q.evaluations.type!=="smartBusinessRequest")){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"type in Smart Business configuration is not smartBusinessRequest"});m.putMessage(M);}if(q.evaluations&&!q.evaluations.entityType){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"entityType in Smart Business service root configuration is missing"});m.putMessage(M);}}this.getResourceLocation=function(r){return h.getItem(r);};this.getPersistenceConfiguration=function(){m.check(b,"RessourcePathHandler: configuration must be loaded before access to ressources");return p;};this.getConfigurationProperties=function(){m.check(b,"RessourcePathHandler: configuration must be loaded before access to ressources");return C;};function k(){var q=sap.apf.core.utils.uriGenerator;var r,v,w;var x=i.manifests.manifest;var y=i.manifests.baseManifest;if(b){return;}if(c.getStartParameterFacade().getAnalyticalConfigurationId()){I=true;}var z=q.getBaseURLOfComponent(sap.apf.utils.getComponentNameFromManifest(i.manifests.baseManifest));var A=q.getBaseURLOfComponent(sap.apf.utils.getComponentNameFromManifest(i.manifests.manifest));if(x["sap.app"].dataSources&&x["sap.app"].dataSources.PathPersistenceServiceRoot){w=x["sap.app"].dataSources.PathPersistenceServiceRoot.uri;}var B=y["sap.app"].i18n;B=q.addRelativeToAbsoluteURL(z,B);var D=x["sap.app"].i18n;D=q.addRelativeToAbsoluteURL(A,D);var E=x["sap.app"].title;var F=sap.apf.utils.createPseudoGuid();c.registerTextWithKey(F,E);var G="";if(x["sap.app"].dataSources&&x["sap.app"].dataSources.AnalyticalConfigurationLocation){G=x["sap.app"].dataSources.AnalyticalConfigurationLocation.uri;G=q.addRelativeToAbsoluteURL(A,G);}var H={"appName":F,"appTitle":F,"analyticalConfigurationLocation":G,"textResourceLocations":{"apfUiTextBundle":B,"applicationUiTextBundle":D},"persistence":{"path":{"service":w}}};if(x["sap.apf"]&&x["sap.apf"].appSpecificParameters){for(r in x["sap.apf"].appSpecificParameters){H[r]=x["sap.apf"].appSpecificParameters[r];}}if(u()){P=sap.apf.core.LayeredRepositoryProxy;}if(x["sap.app"].dataSources&&x["sap.app"].dataSources.SmartBusiness){v=x["sap.app"].dataSources.SmartBusiness.uri;H.smartBusiness={runtime:{service:v}};}if(x["sap.app"].dataSources&&x["sap.app"].dataSources.LogicalSystem){H.persistence.logicalSystem={service:x["sap.app"].dataSources.LogicalSystem.uri};}o({applicationConfiguration:H});e();if(I){l();}else{d();}b=true;}function n(){var A=c.getUriGenerator().getApfLocation();h.setItem(sap.apf.core.constants.resourceLocation.apfUiTextBundle,A+"resources/i18n/apfUi.properties");h.setItem(sap.apf.core.constants.resourceLocation.applicationMessageDefinitionLocation,"");h.setItem(sap.apf.core.constants.resourceLocation.applicationMessageTextBundle,"");h.setItem(sap.apf.core.constants.resourceLocation.applicationUiTextBundle,"");h.setItem(sap.apf.core.constants.resourceLocation.analyticalConfigurationLocation,"");}function o(q){function r(A){C=jQuery.extend(true,{},A);delete C.type;delete C.analyticalConfigurationLocation;delete C.applicationMessageDefinitionLocation;delete C.textResourceLocations;delete C.persistence;}var A=q.applicationConfiguration;r(A);var T=q.applicationConfiguration.textResourceLocations;p=q.applicationConfiguration.persistence;g(p);if(!p.path.entitySet){p.path.entitySet=sap.apf.core.constants.entitySets.analysisPath;}if(q.applicationConfiguration.smartBusiness){s=q.applicationConfiguration.smartBusiness;j(s);}var M;var U;var v;for(v in sap.apf.core.constants.resourceLocation){if(!sap.apf.core.constants.resourceLocation.hasOwnProperty(v)){continue;}if(A[v]!==undefined){U=A[v];}else if(T[v]!==undefined){U=T[v];}else{continue;}if(i.instances.fileExists.check(U)){h.setItem(v,U);}else if(!I){M=m.createMessageObject({code:sap.apf.core.constants.message.code.wrongRessourcePath,rawText:"The path "+U+" for resource location "+v+"is not valid."});m.putMessage(M);}}}if(i.manifests&&i.manifests.manifest){k();}};}());
