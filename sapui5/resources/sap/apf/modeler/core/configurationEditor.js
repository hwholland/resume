/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
jQuery.sap.declare("sap.apf.modeler.core.configurationEditor");jQuery.sap.require("sap.apf.utils.utils");(function(){'use strict';sap.apf.modeler.core.ConfigurationEditor=function(c,a,b,d){var t=this;var f;var e;var g=a.instances.configurationHandler;var p=a.instances.persistenceProxy;var m=a.instances.messageHandler;var h=a.instances.metadataFactory;var j=true;var s,k,l,n,o,q;var r;var u=new a.constructors.ConfigurationObjects(a);var v=new a.constructors.ConfigurationFactory({instances:{messageHandler:m},constructors:{RegistryProbe:a.constructors.RegistryProbe}});if(!d){s=new a.constructors.ElementContainer("Step",a.constructors.Step,a);k=new a.constructors.ElementContainer("Category",undefined,a);l=new a.constructors.ElementContainer("FacetFilter",a.constructors.FacetFilter,a);n=new a.constructors.ElementContainer("NavigationTarget",a.constructors.NavigationTarget,a);o=new a.constructors.ElementContainer("CategoryStepAssignment",a.constructors.ElementContainer,a);q=[];f={smartFilterBar:true};}else{s=d.stepContainer;k=d.categoryContainer;r=d.smartFilterBar;l=d.facetFilterContainer;n=d.navigationTargetContainer;o=d.categoryStepAssignmentContainer;q=d.serviceList;e=d.applicationTitle;f=d.filterOption;}this.registerService=function(i){var y=false;if(q.indexOf(i)===-1){if(h.getMetadata(i)){q.push(i);y=true;}}else{y=true;}return y;};this.getAllServices=function(){return q;};this.getAllEntitySetsOfService=function(i){var y=[];if(q.indexOf(i)>-1){y=h.getEntitySets(i);}return y;};this.getAllEntityTypesOfService=function(i){var y=[];if(q.indexOf(i)>-1){y=h.getEntityTypes(i);}return y;};this.getAllEntitySetsOfServiceWithGivenProperties=function(y,z){var A=[],B;var C=this.getAllEntitySetsOfService(y);if(!z||z.length===0){return C;}B=h.getMetadata(y);C.forEach(function(D){var E=B.getFilterableProperties(D);var F=true;for(var i=0;i<z.length;i++){if(E.indexOf(z[i])<=-1){F=false;break;}}if(F){A.push(D);}});return A;};this.getAllPropertiesOfEntitySet=function(i,y){var z=[];if(q.indexOf(i)>-1){z=h.getMetadata(i).getAllPropertiesOfEntitySet(y);}return z;};this.getAllKnownProperties=function(){var i=[];var y;q.forEach(function(z){y=h.getMetadata(z);i=i.concat(y.getAllProperties());});i=sap.apf.utils.eliminateDuplicatesInArray(m,i);return i;};this.getFilterablePropertiesAndParameters=function(){var i=[];var y;q.forEach(function(z){y=h.getMetadata(z);i=i.concat(y.getFilterablePropertiesAndParameters());});i=sap.apf.utils.eliminateDuplicatesInArray(m,i);return i;};this.setApplicationTitle=function(i){j=false;e=i;};this.getApplicationTitle=function(){return e;};this.getConfigurationName=function(){return g.getConfiguration(c.id||c).AnalyticalConfigurationName;};this.getCategoryStepAssignments=function(i){var y=[];if(!this.getCategory(i)){return false;}var z=o.getElement(i);if(z){z.getElements().forEach(function(A){y.push(A.stepId);});}return y;};this.addCategoryStepAssignment=function(i,y){if(!this.getCategory(i)||!this.getStep(y)){return false;}var z=o.getElement(i);if(!z){o.createElementWithProposedId({},i);z=o.getElement(i);}if(!z.getElement(y)){z.createElementWithProposedId({stepId:y},y);return true;}return false;};this.removeCategoryStepAssignment=function(i,y){var z;if(!y){var A=this.getCategoryStepAssignments(i);z=o.removeElement(i);if(z){w(A);}return!!z;}var B=o.getElement(i);if(!B){return false;}z=B.removeElement(y);if(B.getElements().length===0){o.removeElement(i);}if(z){w([y]);}return!!z;};function w(i){if(!i){return;}i.forEach(function(y){if(t.getCategoriesForStep(y).length===0){s.removeElement(y);}});}this.moveCategoryStepAssignmentBefore=function(i,y,z){var A=o.getElement(i);if(!A){return null;}return A.moveBefore(y,z);};this.moveCategoryStepAssignmentToEnd=function(i,y){var z=o.getElement(i);if(!z){return null;}return z.moveToEnd(y);};this.moveCategoryStepAssignmentUpOrDown=function(i,y,z){var A=o.getElement(i);if(!A){return null;}return A.moveUpOrDown(y,z);};this.getCategory=k.getElement;this.setCategory=function(i,y){j=false;return k.setElement(i,y);};this.createCategoryWithId=function(i,y){j=false;return k.createElementWithProposedId(i,y).getId();};this.removeCategory=function(i){var y=t.getCategoryStepAssignments(i);if(y){y.forEach(function(z){var A=t.getCategoriesForStep(z);if(!A||A.length<2){s.removeElement(z);}});}k.removeElement(i);};this.getCategories=k.getElements;this.copyCategory=function(i){var y=k.copyElement(i);if(!y){return;}t.getCategoryStepAssignments(i).forEach(function(z){_(z,y);});return y;};this.moveCategoryBefore=function(i,y){return k.moveBefore(i,y);};this.moveCategoryToEnd=function(i){return k.moveToEnd(i);};this.moveCategoryUpOrDown=function(i,y){return k.moveUpOrDown(i,y);};this.serialize=function(){return u.serializeConfiguration(t);};this.isSaved=function(){return j;};this.setIsUnsaved=function(){j=false;};this.save=function(i){function y(B,C,D){if(!D){j=true;g.replaceConfigurationId(c.id||c,B.AnalyticalConfiguration);c=B.AnalyticalConfiguration;}i(c,C,D);}function z(B,C){if(!C){j=true;}i(c.id||c,B,C);}var A={AnalyticalConfiguration:"",AnalyticalConfigurationName:g.getConfiguration(c.id||c).AnalyticalConfigurationName,Application:g.getApplicationId(),SerializedAnalyticalConfiguration:JSON.stringify(this.serialize()),CreatedByUser:"",CreationUTCDateTime:null,LastChangeUTCDateTime:null,LastChangedByUser:""};if(typeof c==='string'){if(c.indexOf("apf1972-")===0){p.create("configuration",A,y);}else{A.AnalyticalConfiguration=c;p.update("configuration",A,z,[{name:"AnalyticalConfiguration",value:c}]);}}else{if(c.id.indexOf("apf1972-")===0){A.AnalyticalConfiguration="";A.CreationUTCDateTime=null;A.LastChangeUTCDateTime=null;}else{A.AnalyticalConfiguration=c.id;A.CreationUTCDateTime=c.creationDate;A.LastChangeUTCDateTime=c.lastChangeDate;}if(c.updateExisting){p.update("configuration",A,z,[{name:"AnalyticalConfiguration",value:c.id}]);}else{p.create("configuration",A,y);}}};this.getFilterOption=function(){return jQuery.sap.extend({},f);};this.setFilterOption=function(i){if(i.none===true){r=null;y.call(this);z();}if(i.smartFilterBar===true){y.call(this);A();}if(i.facetFilter===true){r=null;B();}function y(){this.getFacetFilters().forEach(function(C){this.removeFacetFilter(C.getId());}.bind(this));}function z(){delete f.smartFilterBar;delete f.facetFilter;f.none=true;}function A(){f.smartFilterBar=true;delete f.facetFilter;delete f.none;}function B(){delete f.smartFilterBar;f.facetFilter=true;delete f.none;}};this.isDataLostByFilterOptionChange=function(){if(f.smartFilterBar===true){if(r&&(r.getService()||r.getEntityType())){return true;}}if(f.facetFilter===true){if(l.getElements().length>0){return true;}}return false;};this.getSmartFilterBar=function(){if(f.smartFilterBar===true){if(!r){r=new a.constructors.SmartFilterBar("SmartFilterBar-1");}return r;}return null;};this.createFacetFilterWithId=function(i){if(f.facetFilter===true){return l.createElementWithProposedId(undefined,i).getId();}return null;};this.createFacetFilter=function(){if(f.facetFilter===true){return l.createElement().getId();}return null;};this.removeFacetFilter=l.removeElement;this.getFacetFilter=l.getElement;this.getFacetFilters=l.getElements;this.copyFacetFilter=l.copyElement;this.moveFacetFilterBefore=function(i,y){return l.moveBefore(i,y);};this.moveFacetFilterToEnd=function(i){return l.moveToEnd(i);};this.moveFacetFilterUpOrDown=function(i,y){return l.moveUpOrDown(i,y);};this.createNavigationTargetWithId=function(i){return n.createElementWithProposedId(undefined,i).getId();};this.createNavigationTarget=function(){return n.createElement().getId();};this.removeNavigationTarget=n.removeElement;this.getNavigationTarget=n.getElement;this.getNavigationTargets=n.getElements;this.copyNavigationTarget=n.copyElement;this.moveNavigationTargetBefore=function(i,y){return n.moveBefore(i,y);};this.moveNavigationTargetToEnd=function(i){return n.moveToEnd(i);};this.moveNavigationTargetUpOrDown=function(i,y){return n.moveUpOrDown(i,y);};this.createStepWithId=function(i){return s.createElementWithProposedId(undefined,i).getId();};this.createStep=function(i){if(!this.getCategory(i)){return;}var y=s.createElement().getId();this.addCategoryStepAssignment(i,y);return y;};this.getStep=s.getElement;this.getSteps=s.getElements;this.getStepsNotAssignedToCategory=function(i){var y=this.getCategoryStepAssignments(i);var z=[];t.getSteps().forEach(function(A){var B=A.getId();if(y.indexOf(B)===-1){z.push(B);}});return z;};this.copyStep=function(i){var y=_(i);var z=this.getCategoriesForStep(i);if(!y){return false;}if(z){z.forEach(function(A){t.addCategoryStepAssignment(A,y);});}return y;};function _(i,y){if(y&&!t.getCategory(y)){return false;}var z=s.copyElement(i);if(!z){return false;}if(y){t.addCategoryStepAssignment(y,z);}return z;}this.getCategoriesForStep=function getCategoriesForStep(i){var y=[];var z=t.getCategories();if(z){z.forEach(function(A){var B=A.getId();var C=t.getCategoryStepAssignments(B);if(C&&C.indexOf(i)>-1){y.push(B);}});}return y;};this.getAssignableStepsForNavigationTarget=function(i){var y=[];t.getSteps().forEach(function(z){var A=false;z.getNavigationTargets().forEach(function(B){if(i===B){A=true;}});if(!A){y.push(z.getId());}});return y;};this.getStepsAssignedToNavigationTarget=function(i){var y=[];t.getSteps().forEach(function(z){var A=false;z.getNavigationTargets().forEach(function(B){if(i===B){A=true;}});if(A){y.push(z.getId());}});return y;};this.copy=function(i){var y={stepContainer:s,categoryContainer:k,facetFilterContainer:l,navigationTargetContainer:n,categoryStepAssignmentContainer:o,applicationTitle:e,serviceList:q,filterOption:f};var d=sap.apf.modeler.core.ConfigurationObjects.deepDataCopy(y);if(f.smartFilterBar===true&&r){d.smartFilterBar=z();}return new sap.apf.modeler.core.ConfigurationEditor(i,a,undefined,d);function z(){var A=new a.constructors.SmartFilterBar(r.getId());A.setService(r.getService());A.setEntityType(r.getEntityType());return A;}};if(typeof c==='string'){if(c.indexOf("apf1972-")===0){j=false;if(b){b(t,undefined);}}else if(!d){x(c,p,function(i,y){if(!y){var z=JSON.parse(i.SerializedAnalyticalConfiguration);t.setApplicationTitle(z.applicationTitle);v.loadConfig(z);u.mapToDesignTime(v.getRegistry(),t);j=true;b(t,undefined);}else{b(undefined,y);}});}}else{v.loadConfig(c.content);u.mapToDesignTime(v.getRegistry(),this);if(b){b(t,undefined);}}function x(i,y,b){y.readEntity("configuration",function(z,A,B){b(z,B);},[{name:"AnalyticalConfiguration",value:i}],undefined,true,g.getApplicationId());}};}());
