/* SAP APF Analysis Path Framework
* 
* (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
jQuery.sap.declare("sap.apf.ui.representations.table");jQuery.sap.require("sap.apf.core.constants");jQuery.sap.require('sap.apf.ui.utils.formatter');jQuery.sap.require("sap.apf.ui.representations.utils.paginationHandler");jQuery.sap.require("sap.apf.ui.representations.BaseUI5ChartRepresentation");(function(){'use strict';var t;function _(s){t.removeSelections();s.forEach(function(i){t.setSelectedItem(i);});}function a(T){T.UI5ChartHelper.filterValues=[];T.setFilter(T.oApi.createFilter());}function b(T,r){var F=T.getFilter().getInternalFilter().getFilterTermsForProperty(r);var i=F.map(function(o){return o.getValue();});return i;}function c(r,C,F){var i=[];var s=C[0].getBindingContext().getProperty(r);if(C[0].isSelected()){i.push(s);}else{var o=F.indexOf(s);if(o!==-1){F.splice(o,1);}}return i;}function d(T,i,F){if(i){a(T);T.filter=T.UI5ChartHelper.getFilterFromSelection(F);T.oApi.getActiveStep().getSelectedRepresentation().UI5ChartHelper.filterValues=T.UI5ChartHelper.filterValues;T.oApi.selectionChanged();}else{i=true;}}function e(A,r,F){var i=A.filter(function(o){var p=o.getBindingContext().getProperty(r);return F.indexOf(p)!==-1;});return i;}function f(E){var F=[],r;var R=this.oParameter.requiredFilters;r=R&&(R.length>0)?R[0]:undefined;var C=E.getParameters("listItems").listItems;if(this.UI5ChartHelper){F=r?b(this,r):[];}var s=R&&(R.length>0)?"MultiSelect":"None";t.setMode(s);if(E.getId()==="selectionChange"){var i=true;var o=c(r,C,F);F=F.concat(o.filter(function(q){return F.indexOf(q)<0;}));d(this,i,F);}var A=E.getSource().getItems();var p=e(A,r,F);_(p);}function g(T,p){var r=T.oParameter.requiredFilters;var R=r&&(r.length>0)?r[0]:undefined;var F=b(T,R);var s=p.getItems().filter(function(o){var q=o.getBindingContext().getProperty(R);return F.indexOf(q)!==-1;});var i=r&&(r.length>0)?"MultiSelect":"None";p.setMode(i);return s;}function h(i,T,o){var F=new sap.apf.ui.utils.formatter({getEventCallback:T.oApi.getEventCallback.bind(T.oApi),getTextNotHtmlEncoded:T.oApi.getTextNotHtmlEncoded},T.metadata,T.aDataResponse);var p=function(H){return function(I){if(T.metadata!==undefined){var J;if(i.value[H]&&I){J=F.getFormattedValue(i.value[H],I);if(J!==undefined){return J;}}}return I;};};var q=[];for(var r=0;r<i.name.length;r++){var s=new sap.m.Text().bindText(i.value[r],p(r),sap.ui.model.BindingMode.OneWay);q.push(s);}var u=[],v=[];for(var w=0;w<i.name.length;w++){var C=new sap.m.Column({header:new sap.m.Text({text:i.name[w]})});u.push(C);var x=new sap.m.Column();var y=new sap.ui.core.CustomData({value:{text:i.name[w],key:i.value[w]}});x.addCustomData(y);v.push(x);}var M=new sap.ui.model.json.JSONModel();M.setSizeLimit(10000);var z=T.getData();M.setData({tableData:z});var A=new sap.m.Table({items:{path:"/tableData",template:new sap.m.ColumnListItem({cells:q})}});var B;B=v;if(o){B=u;}B.forEach(function(H){A.addColumn(H);});A.setModel(M);if(T.metadata!==undefined){for(var D=0;D<i.name.length;D++){var E=T.metadata.getPropertyMetadata(i.value[D]);if(E.unit){var G=A.getColumns()[D];G.setHAlign(sap.ui.core.TextAlign.Right);}}}return A;}function j(C){var s,o;jQuery(".scrollContainer > div:first-child").css({"display":"table","width":"inherit"});if(o===undefined){o=jQuery(".tableWithoutHeaders").offset().top;}if(jQuery(".tableWithoutHeaders").offset().top!==o){s=((window.innerHeight-jQuery('.tableWithoutHeaders').offset().top))+"px";}else{s=((window.innerHeight-jQuery('.tableWithoutHeaders').offset().top)-(jQuery(".applicationFooter").height())-20)+"px";}document.querySelector('.tableWithoutHeaders').style.cssText+="height : "+s;sap.ui.Device.orientation.attachHandler(function(){C.rerender();});}function k(s,r){var i=[];i.push(new sap.ui.model.Sorter(s.property,s.descending));r.oTableRepresentation.getBinding("items").sort(i);r.oTableRepresentation.getParent().getParent().setBusy(false);}function l(T){var s=[];var i=T.getData();var o=i.map(function(p){return p[T.oParameter.requiredFilters[0]];});T.UI5ChartHelper.filterValues.forEach(function(p){if(o.indexOf(p[0])!==-1){s.push(p[0]);}});return s;}function m(T){var o=T.getData();var p=[];var C={name:[],value:[]};p=T.oParameter.dimensions.concat(T.oParameter.measures).length?T.oParameter.dimensions.concat(T.oParameter.measures):T.parameter.properties;if(o.length!==0){for(var i=0;i<p.length;i++){C.value[i]=p[i].fieldName;var q="";var r=T.metadata.getPropertyMetadata(p[i].fieldName).label||T.metadata.getPropertyMetadata(p[i].fieldName).name;var u="";if(T.metadata!==undefined&&T.metadata.getPropertyMetadata(p[i].fieldName).unit!==undefined){var U=T.metadata.getPropertyMetadata(p[i].fieldName).unit;u=T.getData()[0][U];q=p[i].fieldDesc===undefined||!T.oApi.getTextNotHtmlEncoded(p[i].fieldDesc).length?r+" ("+u+")":T.oApi.getTextNotHtmlEncoded(p[i].fieldDesc)+" ("+u+")";C.name[i]=q;}else{C.name[i]=p[i].fieldDesc===undefined||!T.oApi.getTextNotHtmlEncoded(p[i].fieldDesc).length?r:T.oApi.getTextNotHtmlEncoded(p[i].fieldDesc);}}}return C;}function n(v){var s={};var S=v.getSelectedSortItem();v.getSortItems().forEach(function(o){if(o.getId()===S){s.property=o.getKey();}});s.descending=v.getSortDescending();return s;}sap.apf.ui.representations.table=function(A,p){this.oViewSettingDialog=undefined;this.aDataResponse=[];this.oParameter=p;this.orderby=p.orderby;sap.apf.ui.representations.BaseUI5ChartRepresentation.apply(this,[A,p]);this.alternateRepresentation=p.alternateRepresentationType;this.type=sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION;this.oPaginationHandler=new sap.apf.ui.representations.utils.PaginationHandler();};sap.apf.ui.representations.table.prototype=Object.create(sap.apf.ui.representations.BaseUI5ChartRepresentation.prototype);sap.apf.ui.representations.table.prototype.constructor=sap.apf.ui.representations.table;sap.apf.ui.representations.table.prototype.setData=function(D,i){var s=this;var o=this.oPaginationHandler.getPagingOption().skip;if(o===undefined||o===0){this.aDataResponse=D;}else{D.map(function(p){s.aDataResponse.push(p);});}if(!i){this.oMessageObject=this.oApi.createMessageObject({code:"6004",aParameters:[this.oApi.getTextNotHtmlEncoded("step")]});this.oApi.putMessage(this.oMessageObject);}else{this.metadata=i;this.UI5ChartHelper.metadata=i;}};sap.apf.ui.representations.table.prototype.getSelectionFromChart=function(){var s=t.getSelectedItems();return s;};sap.apf.ui.representations.table.prototype.getSelections=function(){var s=[];var S=l(this);S.forEach(function(i){s.push({id:i,text:i});});return s;};sap.apf.ui.representations.table.prototype.getRequestOptions=function(F){if(F){this.oPaginationHandler.resetPaginationOption();}var r={paging:this.oPaginationHandler.getPagingOption(this.oParameter.top),orderby:[]};var o;if(this.orderby&&this.orderby.length){o=this.orderby.map(function(O){return{property:O.property,descending:!O.ascending};});r.orderby=o;}var s=this.oViewSettingDialog?n(this.oViewSettingDialog):{};if(s.property){o=[];o=[{property:s.property,descending:s.descending}];r.orderby=o;}return r;};sap.apf.ui.representations.table.prototype.getMainContent=function(s,i,w){var o=this;var T=this.getData();var p=this.oParameter.dimensions.concat(this.oParameter.measures).length?this.oParameter.dimensions.concat(this.oParameter.measures):this.oParameter.properties;var q=m(this);var M;if(!s){M=this.oApi.createMessageObject({code:"6002",aParameters:["title",this.oApi.getTextNotHtmlEncoded("step")]});this.oApi.putMessage(M);}if(p.length===0){M=this.oApi.createMessageObject({code:"6002",aParameters:["dimensions",s]});this.oApi.putMessage(M);}if(!T||T.length===0){M=this.oApi.createMessageObject({code:"6000",aParameters:[s]});this.oApi.putMessage(M);}var r=(w||1000)+"px";var u=[];for(var v=0;v<q.name.length;v++){var x=new sap.m.Column({header:new sap.m.Text({text:q.name[v]})});u.push(x);}var y=new sap.m.Table({headerText:s,showNoData:false,columns:u}).addStyleClass("tableWithHeaders");var z=new sap.ui.model.json.JSONModel();z.setSizeLimit(10000);z.setData({tableData:T});y.setModel(z);t=h(q,this);t.attachSelectionChange(f.bind(o));t.attachUpdateFinished(f.bind(o));this.oTableRepresentation=t;var A=new sap.m.ScrollContainer({content:t,height:"480px",horizontal:false,vertical:true}).addStyleClass("tableWithoutHeaders");var B=new sap.m.ScrollContainer({content:[y,A],width:r,horizontal:true,vertical:false}).addStyleClass("scrollContainer");t.addEventDelegate({onAfterRendering:function(){var S=o.oViewSettingDialog?n(o.oViewSettingDialog):{};if(o.oParameter.isAlternateRepresentation&&S.property){k(S,o);}j(B);if(!o.oParameter.top&&!o.oParameter.isAlternateRepresentation){o.oPaginationHandler.attachPaginationOnTable(o);}}});return new sap.ui.layout.VerticalLayout({content:[B]});};sap.apf.ui.representations.table.prototype.getThumbnailContent=function(){var T;var i=this.getData();var I=this.oParameter.isAlternateRepresentation?"sap-icon://table-view":"sap-icon://table-chart";if(i!==undefined&&i.length!==0){var o=new sap.ui.core.Icon({src:I,size:"70px"}).addStyleClass('thumbnailTableImage');T=o;}else{var p=new sap.m.Text({text:this.oApi.getTextNotHtmlEncoded("noDataText")}).addStyleClass('noDataText');T=new sap.ui.layout.VerticalLayout({content:p});}return T;};sap.apf.ui.representations.table.prototype.removeAllSelection=function(){a(this);t.removeSelections();this.oApi.getActiveStep().getSelectedRepresentation().UI5ChartHelper.filterValues=[];this.oApi.selectionChanged();};sap.apf.ui.representations.table.prototype.getPrintContent=function(s){var i=m(this);var o=true;var p=h(i,this,o);p.setHeaderText(s);p.setHeaderDesign(sap.m.ListHeaderDesign.Standard);p.getColumns().forEach(function(q){q.setWidth("75px");});var S=g(this,p);return{oTableForPrint:new sap.ui.layout.VerticalLayout({content:[p]}),aSelectedListItems:S};};sap.apf.ui.representations.table.prototype.createViewSettingDialog=function(){var T=this;var v=new sap.ui.view({type:sap.ui.core.mvc.ViewType.JS,viewName:"sap.apf.ui.reuse.view.viewSetting",viewData:T});this.oViewSettingDialog=v.getContent()[0];this.oViewSettingDialog.addStyleClass("sapUiSizeCompact");return this.oViewSettingDialog;};sap.apf.ui.representations.table.prototype.destroy=function(){if(this.UI5ChartHelper){this.UI5ChartHelper.destroy();this.UI5ChartHelper=null;}if(this.orderby){this.orderby=null;}if(this.oParameter){this.oParameter=null;}if(this.oViewSettingDialog){this.oViewSettingDialog.destroy();}if(this.aDataResponse){this.aDataResponse=null;}};}());
