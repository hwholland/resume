/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
jQuery.sap.declare("sap.ushell.ui.footerbar.UserPreferencesButton");jQuery.sap.require("sap.ushell.library");jQuery.sap.require("sap.ushell.ui.launchpad.ActionItem");sap.ushell.ui.launchpad.ActionItem.extend("sap.ushell.ui.footerbar.UserPreferencesButton",{metadata:{library:"sap.ushell"}});(function(){"use strict";jQuery.sap.require("sap.m.Dialog");jQuery.sap.require("sap.m.Button");jQuery.sap.require("sap.ushell.resources");jQuery.sap.require("sap.ushell.services.Container");jQuery.sap.require("sap.ushell.ui.launchpad.AccessibilityCustomData");jQuery.sap.declare("sap.ushell.ui.footerbar.UserPreferencesButton");sap.ushell.ui.footerbar.UserPreferencesButton.prototype.init=function(){if(sap.ushell.ui.launchpad.ActionItem.prototype.init){sap.ushell.ui.launchpad.ActionItem.prototype.init.apply(this,arguments);}this.setIcon('sap-icon://person-placeholder');this.translationBundle=sap.ushell.resources.i18n;this.setText(this.translationBundle.getText("userPreferences"));this.attachPress(this.showUserPreferencesDialog);};sap.ushell.ui.footerbar.UserPreferencesButton.prototype.createDialog=function(){var s;var c;var t=this;s=this._createSaveButton();c=this._createCancelButton();this.oDialog=new sap.m.Dialog({id:"userPreferencesDialog",title:"{/userPreferences/dialogTitle}",contentWidth:"29.6rem",content:null,contentHeight:"17rem",buttons:[s,c],afterClose:function(){t.oDialog.destroy();this.oUser.resetChangedProperties();}.bind(t),stretch:sap.ui.Device.system.phone}).addStyleClass("sapUshellUserPreferencesDialog");this._addDialogBackButton();this.oDialog.setModel(this.getModel());this.oDialog.addCustomData(new sap.ushell.ui.launchpad.AccessibilityCustomData({key:"aria-label",value:t.translationBundle.getText("UserPreferences_Dialog_Main_label"),writeToDom:true}));this.oDialog.addContent(this._getOriginalDialogContent());};sap.ushell.ui.footerbar.UserPreferencesButton.prototype._getOriginalDialogContent=function(){if(!this.oInitialContent){var u;var e;u=this._getUserDetailsControl();e=this._getEntryListControl();this.oInitialContent=new sap.ui.layout.VerticalLayout('userPreferencesLayout',{content:[u,e],width:"100%"});}return this.oInitialContent;};sap.ushell.ui.footerbar.UserPreferencesButton.prototype._getEntryListControl=function(){var e=this._getUserPrefEntriesTemplate();var x=this.getModel()&&this.getModel().getProperty('/enableHelp');var t=this,u=this.oUser.getFullName();var a=new sap.m.List('userPrefEnteryList',{items:{path:"/userPreferences/entries",template:e}});a.addCustomData(new sap.ushell.ui.launchpad.AccessibilityCustomData({key:"aria-label",value:t.translationBundle.getText("UserPreferences_EntryList_label")+u,writeToDom:true}));var o=a.onAfterRendering;a.onAfterRendering=function(){var E=this.getItems();var b;o.apply(this,arguments);for(var i=0;i<E.length;i++){b=E[i].getBindingContext().getPath();if(!t.getModel().getProperty(b+"/valueResult")){t._setEntryValueResult(b);}if(x){t._addXRayHelpId(b,E[i]);}}};return a;};sap.ushell.ui.footerbar.UserPreferencesButton.prototype._addXRayHelpId=function(e,l){var h=this.getModel().getProperty(e+"/entryHelpID");if(h){l.addStyleClass("help-id-"+h);}};sap.ushell.ui.footerbar.UserPreferencesButton.prototype._setEntryValueResult=function(e){var t=this;var i=this.getModel().getProperty(e+"/editable");var v=this.getModel().getProperty(e+"/valueArgument");if(typeof v==="function"){this.getModel().setProperty(e+"/valueResult",this.translationBundle.getText("genericLoading"));this.getModel().setProperty(e+"/editable",false);var V=v();V.done(function(a){t.getModel().setProperty(e+"/editable",i);t.getModel().setProperty(e+"/visible",typeof(a)==='object'?!!a.value:true);t.getModel().setProperty(e+"/valueResult",typeof(a)==='object'?a.displayText:a);});V.fail(function(){t.getModel().setProperty(e+"/valueResult",t.translationBundle.getText("loadingErrorMessage"));});}else if(!!v){this.getModel().setProperty(e+"/valueResult",v);this.getModel().setProperty(e+"/editable",i);}else{this.getModel().setProperty(e+"/valueResult",this.translationBundle.getText("loadingErrorMessage"));}};sap.ushell.ui.footerbar.UserPreferencesButton.prototype._getUserPrefEntriesTemplate=function(){var t=this;var p=function(e){var a=true;var b=e.getSource().getLabel();var c=e.getSource().getBindingContext().getPath();t.getModel().setProperty("/userPreferences/activeEntryPath",c);t._setDetailedEntryModeMode(true,c,b,c);t.oDialog.removeAllContent();var C=t.getModel().getProperty(c+"/contentResult");if(C){t.oDialog.addContent(C);}else{var B=null;var s=true,I=false;var d=t.getModel().getProperty(c+"/contentFunc");if(typeof d==="function"){t.getModel().setProperty(c+"/isDirty",true);var o=d();o.done(function(f){s=false;if(I===true){t.oDialog.removeAllContent();B.destroy();}if(f instanceof sap.ui.core.Control){t.getModel().setProperty(c+"/contentResult",f);t.oDialog.addContent(f);}else{a=false;}});o.fail(function(){s=false;if(I===true){t.oDialog.removeAllContent();B.destroy();}a=false;});o.always(function(){if(a===false){var E=new sap.m.FlexBox("userPrefErrorFlexBox",{height:"5rem",alignItems:sap.m.FlexAlignItems.Center,justifyContent:sap.m.FlexJustifyContent.Center,items:[new sap.m.Text("userPrefErrorText",{text:t.translationBundle.getText("loadingErrorMessage")})]});t.getModel().setProperty(c+"/contentResult",E);t.oDialog.addContent(E);}});if(s===true){B=new sap.m.BusyIndicator('userPrefLoadingBusyIndicator',{size:"2rem"});t.oDialog.addContent(B);I=true;}}}};var i=new sap.m.DisplayListItem({label:"{title}",value:"{valueResult}",tooltip:{path:"valueResult",formatter:function(v){return typeof(v)==='string'?v:"";}},type:{path:"editable",formatter:function(e){return(e===true)?"Navigation":"Inactive";}},visible:{path:"visible",formatter:function(v){return(v!==undefined)?v:true;}},press:p,customData:new sap.ushell.ui.launchpad.AccessibilityCustomData({key:"aria-label",value:{parts:[{path:'title'},{path:'valueResult'}],formatter:function(T,v){v=v?v:"";return T+" "+v;}},writeToDom:true})});return i;};sap.ushell.ui.footerbar.UserPreferencesButton.prototype._getUserDetailsControl=function(){return new sap.m.ObjectIdentifier({title:this.oUser.getFullName(),text:this.oUser.getEmail()}).addStyleClass("sapUshellUserPrefUserIdentifier");};sap.ushell.ui.footerbar.UserPreferencesButton.prototype._createCancelButton=function(){var t=this;return new sap.m.Button({id:"cancelButton",text:{parts:['/userPreferences/entries'],formatter:function(e){var E=e.some(function(o){return o.editable;});return E>0?t.translationBundle.getText("cancelBtn"):t.translationBundle.getText("close");}},press:t._dialogCancelButtonHandler.bind(t),visible:true});};sap.ushell.ui.footerbar.UserPreferencesButton.prototype._createSaveButton=function(){var t=this;return new sap.m.Button({id:"saveButton",text:this.translationBundle.getText("saveBtn"),press:t._dialogSaveButtonHandler.bind(t),visible:{parts:['/userPreferences/entries'],formatter:function(e){return e.some(function(E){return E.editable;});}}});};sap.ushell.ui.footerbar.UserPreferencesButton.prototype._setDetailedEntryModeMode=function(i,e,a,b){this.getModel().setProperty("/userPreferences/isDetailedEntryMode",!!i);this.getModel().setProperty("/userPreferences/dialogTitle",a);};sap.ushell.ui.footerbar.UserPreferencesButton.prototype.showUserPreferencesDialog=function(){this.oUser=sap.ushell.Container.getUser();this.createDialog();this.oDialog.open();};sap.ushell.ui.footerbar.UserPreferencesButton.prototype._dialogBackButtonHandler=function(e){this.getModel().setProperty("/userPreferences/isDetailedEntryMode",false);this.getModel().setProperty("/userPreferences/dialogTitle",this.translationBundle.getText("userPreferences"));this.oDialog.removeAllContent();this.oDialog.addContent(this._getOriginalDialogContent());this._setEntryValueResult(this.getModel().getProperty("/userPreferences/activeEntryPath"));this.getModel().setProperty("/userPreferences/activeEntryPath",null);};sap.ushell.ui.footerbar.UserPreferencesButton.prototype._destroyDialog=function(){this.oHeadBar.destroy();this.oInitialContent.destroy();this.oInitialContent=null;this._modelCleanUpToInitial();this._entriesCleanUp();this.oDialog.destroy();};sap.ushell.ui.footerbar.UserPreferencesButton.prototype._entriesCleanUp=function(){var e=this.getModel().getProperty("/userPreferences/entries");for(var i=0;i<e.length;i++){if(e[i].contentResult){e[i].contentResult.destroy();e[i].contentResult=null;}e[i].isDirty=false;e[i].valueResult=null;}this.getModel().setProperty("/userPreferences/entries",e);};sap.ushell.ui.footerbar.UserPreferencesButton.prototype._modelCleanUpToInitial=function(){this.getModel().setProperty("/userPreferences/isDetailedEntryMode",false);this.getModel().setProperty("/userPreferences/dialogTitle",this.translationBundle.getText("userPreferences"));};sap.ushell.ui.footerbar.UserPreferencesButton.prototype._dialogSaveButtonHandler=function(){var s;s=this._saveUserPrefEntries();var t=this;var i=this.getModel().getProperty("/userPreferences/isDetailedEntryMode");if(i){this.getModel().setProperty("/userPreferences/activeEntryPath",null);}s.done(function(){t._showSaveMessageToast();});s.fail(function(f){jQuery.sap.require("sap.m.MessageBox");var e;var a="";if(f.length===1){e=t.translationBundle.getText("savingEntryError")+" ";}else{e=t.translationBundle.getText("savingEntriesError")+"\n";}f.forEach(function(b){e+=b.entry+"\n";a+="Entry: "+b.entry+" - Error message: "+b.message+"\n";});sap.m.MessageBox.show(e,{icon:sap.m.MessageBox.Icon.ERROR,title:t.translationBundle.getText("Error"),actions:[sap.m.MessageBox.Action.OK]});jQuery.sap.log.error("Failed to save the following entries",a,"sap.ushell.ui.footerbar.UserPreferencesButton");});this.oDialog.close();this._destroyDialog();};sap.ushell.ui.footerbar.UserPreferencesButton.prototype._dialogCancelButtonHandler=function(){var e=this.getModel().getProperty("/userPreferences/entries");for(var i=0;i<e.length;i++){if(e[i]&&e[i].onCancel){e[i].onCancel();}}this.oDialog.close();this._destroyDialog();};sap.ushell.ui.footerbar.UserPreferencesButton.prototype._saveUserPrefEntries=function(){var e=this.getModel().getProperty("/userPreferences/entries");var r=jQuery.Deferred();var w;var c;var t=0;var f=0;var s=0;var p=[];var a=[];var b;var d=function(){s++;r.notify();};var g=function(h){a.push({entry:b,message:h});f++;r.notify();};for(var i=0;i<e.length;i++){if(e[i]&&e[i].isDirty===true){c=e[i].onSave();c.done(d);b=e[i].title;c.fail(g);p.push(c);t++;}}w=jQuery.when.apply(null,p);w.done(function(){r.resolve();});r.progress(function(){if(f>0&&(f+s===t)){r.reject(a);}});return r.promise();};sap.ushell.ui.footerbar.UserPreferencesButton.prototype._addDialogBackButton=function(){var t=this;var b=new sap.m.Button('userPrefBackBtn',{visible:"{/userPreferences/isDetailedEntryMode}",icon:sap.ui.core.IconPool.getIconURI("nav-back"),press:t._dialogBackButtonHandler.bind(t),tooltip:this.translationBundle.getText("feedbackGoBackBtn_tooltip")});var d=new sap.m.Text("userPrefTitle",{text:"{/userPreferences/dialogTitle}"});this.oHeadBar=new sap.m.Bar({contentLeft:[b],contentMiddle:[d]});this.oDialog.setCustomHeader(this.oHeadBar);};sap.ushell.ui.footerbar.UserPreferencesButton.prototype._showSaveMessageToast=function(){jQuery.sap.require("sap.m.MessageToast");var m=this.translationBundle.getText("savedChanges");sap.m.MessageToast.show(m,{duration:3000,width:"15em",my:"center bottom",at:"center bottom",of:window,offset:"0 -50",collision:"fit fit"});};}());
