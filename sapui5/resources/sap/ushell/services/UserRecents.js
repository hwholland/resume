// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.services.UserRecents");jQuery.sap.require("sap.ushell.services.Personalization");sap.ushell.services.AppType={OVP:"OVP",SEARCH:"Search",FACTSHEET:"FactSheet",COPILOT:"Co-Pilot",APP:"Application",getDisplayName:function(A){switch(A){case this.OVP:case this.SEARCH:case this.FACTSHEET:case this.COPILOT:return A;default:return"App";}}};function R(m,e,c,l,s){var r=[],u=function(I,t){return r.some(function(o){var f;if(e(o.oItem,I)){o.oItem=I;o.iTimestamp=t;o.iCount=o.iCount+1;f=true;}else{f=false;}return f;});},i=function(I,t){var n={oItem:I,iTimestamp:t,iCount:1};if(r.length===m){r.sort(c);r.pop();}r.push(n);};this.newItem=function(I){var d=new jQuery.Deferred();var t=+new Date(),A;l().done(function(L){r=L||[];A=u(I,t);if(!A){i(I,t);}s(r).done(function(f){d.resolve(f);}).fail(function(){d.reject();});});return d.promise();};this.getRecentItems=function(){var d=new jQuery.Deferred();l().done(function(L){L=L||[];L.sort(c);r=L.slice(0,m);d.resolve(jQuery.map(r,function(o){return o.oItem;}));});return d.promise();};}function a(m,e,c,l,s){var r=[],u=function(I,t){return r.some(function(o){var f;if(e(o.oItem,I)){if((o.oItem.appType===I.appType)||(o.oItem.appType!==I.appType&&I.appType!=='Application')){jQuery.extend(o.oItem,I);o.iTimestamp=t;o.oItem.timestamp=t;o.iCount=o.iCount+1;o.mobile=undefined;o.tablet=undefined;o.desktop=undefined;}f=true;r.sort(c);}else{f=false;}return f;});},i=function(I,t,d){I.timestamp=t;I.icon=d;var n={oItem:I,iTimestamp:t,iCount:1,mobile:undefined,tablet:undefined,desktop:undefined};if(r.length===m){r.pop();}r.unshift(n);};this.newItem=function(I){var d=new jQuery.Deferred();var t=+new Date(),f=I.icon?I.icon:this.getActivityIcon(I.appType),A;l().done(function(L){r=L||[];A=u(I,t);if(!A){i(I,t,f);}s(r).done(function(g){d.resolve(g);}).fail(function(){d.reject();});});return d.promise();};this.getActivityIcon=function(A){switch(A){case sap.ushell.services.AppType.OVP:return"sap-icon://competitor";case sap.ushell.services.AppType.SEARCH:return"sap-icon://search";case sap.ushell.services.AppType.COPILOT:return"sap-icon://BusinessSuiteInAppSymbols/icon-heart";case sap.ushell.services.AppType.FACTSHEET:return"sap-icon://lead";default:return"sap-icon://BusinessSuiteInAppSymbols/icon-heart";}};this.getRecentItems=function(){var d=new jQuery.Deferred(),f,A,C,I=false,g=[],h=function(L){var j=[],D=0,k;for(k=0;k<L.length&&D<30;k++){A=L[k];if(A[C]){j.push(A);D++;}}d.resolve(jQuery.map(j,function(o){return o.oItem;}));};if(sap.ui.Device.system.desktop){C="desktop";}else if(sap.ui.Device.system.tablet){C="tablet";}else{C="mobile";}l().done(function(L){L=L||[];for(f=0;f<L.length&&!I;f++){A=L[f];if(A[C]===undefined){g.push(A.oItem.appId);}else{I=true;}}if(g.length>0){sap.ushell.Container.getService("CrossApplicationNavigation").isIntentSupported(g).done(function(o){I=false;for(f=0;f<L.length&&!I;f++){A=L[f];if(A[C]===undefined){var j=o[A.oItem.appId];A[C]=j&&j.supported?true:false;}else{I=true;}}s(L).done(function(k){d.resolve(h(L));}).fail(function(){d.reject();});}).fail(function(M){d.reject(M);});}else{h(L);}});return d.promise();};}function b(l,s){var A,t=this,m=30;this.init=function(){var t=this,p,c=this.getDayFromDateObj(this.getCurrentDate()),d=false;if(t._oInitDeferred===undefined){t._oInitDeferred=jQuery.Deferred();}if(!d||c!==A.recentDay){d=true;p=l();p.done(function(e){A=e||{recentDay:null,recentAppsUsageMap:{}};t.calculateInitialUsage(c);t._oInitDeferred.resolve(A);});p.fail(function(){jQuery.sap.log.error("UShell-lib ; RecentAppsUsage ; Load data in Init failed");t._oInitDeferred.reject();});}return this._oInitDeferred.promise();};this.calculateInitialUsage=function(c){var t=this;if(c!=A.recentDay){this.addNewDay();A.recentDay=c;setTimeout(function(){t.cleanUnusedHashes();},3000);this.saveAppsUsage(A);}};this.addAppUsage=function(h){if(!sap.ushell.utils.validHash(h)){return jQuery.Deferred().reject("Non valid hash").promise();}var p=this.init();p.done(function(){var c=A.recentAppsUsageMap[h]||[];if(c.length==0){c[0]=1;}else{c[c.length-1]+=1;}A.recentAppsUsageMap[h]=c;t.saveAppsUsage(A);});p.fail(function(){jQuery.sap.log.error("Ushell-lib ; addAppUsage ; Initialization falied!");});return p;};this.getAppsUsage=function(){var r,p,t=this,d=jQuery.Deferred();p=t.init();p.done(function(){r=t.summarizeUsage();d.resolve(r);});p.fail(function(){d.reject("Not initialized yet");});return d.promise();};this.summarizeUsage=function(){var u={},h,c,d,f=true;for(h in A.recentAppsUsageMap){u[h]=this.getHashUsageSum(h);if(f){c=d=u[h];f=false;}else{if(u[h]<d){d=u[h];}else if(u[h]>c){c=u[h];}}}return{usageMap:u,maxUsage:c,minUsage:d};};this.addNewDay=function(){var h,c;for(h in A.recentAppsUsageMap){c=A.recentAppsUsageMap[h];c[c.length]=0;if(c.length>m){c=c.shift();}}};this.cleanUnusedHashes=function(){var u,h;for(h in A.recentAppsUsageMap){u=t.getHashUsageSum(h);if(u==0){delete(A.recentAppsUsageMap[h]);}}};this.getHashUsageSum=function(h){var c=0,d,e=A.recentAppsUsageMap[h],f=e.length;for(d=0;d<f;d++){c+=e[d];}return c;};this.saveAppsUsage=function(o){var p=s(o);p.fail(function(){jQuery.sap.log.error("Ushell-lib ; saveAppsUsage ; Save action failed");});p.done(function(d){});return p;};this.getCurrentDate=function(){return new Date();};this.getDayFromDateObj=function(d){return(d.getUTCFullYear()+"/"+(d.getUTCMonth()+1)+"/"+d.getUTCDate());};}sap.ushell.services.UserRecents=function(){var r,o,c,A,d,p,e,s,f,D,g,l,S,h="RecentApps",i="RecentActivity",j="AppsUsage",k="RecentSearches",m="RecentDataSources",P="sap.ushell.services.UserRecents";this.addActivity=function(q){return c.newItem(q);};this.getRecentActivity=function(){return c.getRecentItems();};this.noticeDataSource=function(q){if((q&&q.objectName&&q.objectName.value&&q.objectName.value.toLowerCase()==="$$all$$")||(q.objectName&&q.objectName.toLowerCase&&q.objectName.toLowerCase()==="$$all$$")){return;}d.newItem(q);return d.getRecentItems();};this.getRecentDataSources=function(){return d.getRecentItems();};this.noticeSearch=function(q){r.newItem(q);return r.getRecentItems();};this.getRecentSearches=function(){return r.getRecentItems();};this.noticeApp=function(q){o.newItem(q);return o.getRecentItems();};this.getRecentApps=function(){return o.getRecentItems();};this.initAppsUsage=function(){A.init(new Date());};this.addAppUsage=function(q){var t=sap.ushell.utils.getBasicHash(q);A.addAppUsage(t);};this.getAppsUsage=function(){return A.getAppsUsage();};p=sap.ushell.Container.getService("Personalization");try{e=p.getPersonalizer({container:P,item:h});f=p.getPersonalizer({container:P,item:i});s=p.getPersonalizer({container:P,item:k});D=p.getPersonalizer({container:P,item:m});g=p.getPersonalizer({container:P,item:j});}catch(n){jQuery.sap.log.error("Personalization service does not work:");jQuery.sap.log.error(n.name+": "+n.message);}l=function(q){var t,u;try{t=q.getPersData();}catch(n){jQuery.sap.log.error("Personalization service does not work:");jQuery.sap.log.error(n.name+": "+n.message);u=new jQuery.Deferred();u.reject(n);t=u.promise();}return t;};S=function(q,L){var t;try{t=q.setPersData(L);}catch(n){jQuery.sap.log.error("Personalization service does not work:");jQuery.sap.log.error(n.name+": "+n.message);}return t;};r=new R(10,function(x,y){var q=false;if(x.oDataSource&&y.oDataSource){if(x.oDataSource.objectName&&y.oDataSource.objectName){q=((x.sTerm===y.sTerm)&&(x.oDataSource.objectName.value===y.oDataSource.objectName.value));}if(!x.oDataSource.objectName&&!y.oDataSource.objectName){q=(x.sTerm===y.sTerm);}}if(!x.oDataSource&&!y.oDataSource){q=(x.sTerm===y.sTerm);}return q;},function(x,y){return y.iTimestamp-x.iTimestamp;},l.bind(this,s),S.bind(this,s));d=new R(6,function(x,y){if(x.objectName&&y.objectName){return x.objectName.value===y.objectName.value;}return false;},function(x,y){return y.iTimestamp-x.iTimestamp;},l.bind(this,D),S.bind(this,D));o=new R(6,function(x,y){return x.semanticObject===y.semanticObject&&x.action===y.action;},function(x,y){return y.iTimestamp-x.iTimestamp;},l.bind(this,e),S.bind(this,e));c=new a(500,function(x,y){if(x.appType===y.appType){if(x.appType!=='Application'){return x.url===y.url;}else{return x.appId===y.appId;}}else{if(x.appType==="Application"||y.appType==="Application"){return(x.appId===y.appId)&&(x.url===y.url);}else{return false;}}},function(x,y){return y.iTimestamp-x.iTimestamp;},l.bind(this,f),S.bind(this,f));A=new b(l.bind(this,g),S.bind(this,g));};sap.ushell.services.UserRecents.hasNoAdapter=true;}());
