// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.services.Personalization");jQuery.sap.require("sap.ushell.utils");jQuery.sap.require("sap.ui.core.format.DateFormat");var c="sap.ushell.personalization#",I="ITEM#",v="VARIANTSET#",A="yyyyMMddHHmmss",d="ADMIN#",f="sap-ushell-container-scope",g="sap-ushell-container-storageUTCTimestamp",h="sap-ushell-container-expireUTCTimestamp";function j(C){return c+C;}sap.ushell.services.Personalization=function(a,C,P,b){this._oConfig=b;this._sSeed=jQuery.sap.getObject("config.seed",undefined,b)||"ABC";this._oAdapterWithBackendAdapter=new sap.ushell.services.Personalization.WindowAdapter(this,a);this._oAdapterWindowOnly=new sap.ushell.services.Personalization.WindowAdapter(this,undefined);this._supportsGetWithoutSubsequentLoad=(a&&a.supportsGetWithoutSubsequentLoad===true);this._oContainerMap=new sap.ushell.utils.Map();this._oPendingOperationsMap=new sap.ushell.utils.Map();};sap.ushell.services.Personalization.prototype.SAVE_DEFERRED_DROPPED="Deferred save dropped (OK) - Data superseeded by subsequent save";sap.ushell.services.Personalization.prototype.constants={keyCategory:{"FIXED_KEY":"FIXED_KEY","GENERATED_KEY":"GENERATED_KEY"},writeFrequency:{"HIGH":"HIGH","LOW":"LOW"}};sap.ushell.services.Personalization.prototype.getGeneratedKey=function(){var C="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",D=new Date().getTime().toString(),r="",s,a=0,i;while(this._sSeed.length<40){this._sSeed=this._sSeed+Math.random().toString().substring(2);}for(i=0;i<3;i=i+1){a=this._sSeed.charCodeAt(i)+31*a;a=a&a;r=r+C[Math.abs(a%36)];}s=Math.random().toString().substring(2)+D+Math.random().toString().substring(2)+D+"1234523413542345698772";for(i=0;i<37;i=i+1){a=this._sSeed.charCodeAt(i)+parseInt(s[i],10)+31*a;a=a&a;r=r+C[Math.abs(a%36)];}return r.substring(0,40);};sap.ushell.services.Personalization.prototype.getPersonalizer=function(P,s,C){return new sap.ushell.services.Personalizer(this,this._oAdapterWithBackendAdapter,P,s,C);};sap.ushell.services.Personalization.prototype.getTransientPersonalizer=function(){return new sap.ushell.services.TransientPersonalizer();};function k(e,a){var b;for(b in a){if(typeof a[b]!=='function'){if(a.hasOwnProperty(b)){if(b===e){return true;}}}}return false;}function l(s){var C=sap.ushell.services.Personalization.prototype.constants,D={validity:Infinity,keyCategory:C.keyCategory.GENERATED_KEY,writeFrequency:C.writeFrequency.HIGH,clientStorageAllowed:false};if(!s){return D;}D.validity=s&&s.validity;if(D.validity===null||D.validity===undefined||typeof D.validity!=="number"){D.validity=Infinity;}if(!(typeof D.validity==="number"&&((D.validity>=0&&D.validity<1000)||D.validity===Infinity))){D.liftime=Infinity;}D.keyCategory=k(s.keyCategory,C.keyCategory)?s.keyCategory:D.keyCategory;D.writeFrequency=k(s.writeFrequency,C.writeFrequency)?s.writeFrequency:D.writeFrequency;if(typeof s.clientStorageAllowed==='boolean'&&(s.clientStorageAllowed===true||s.clientStorageAllowed===false)){D.clientStorageAllowed=s.clientStorageAllowed;}return D;}function m(C,s,_,a){var P="",L,b;if(typeof C!=="string"){throw new sap.ushell.utils.Error("sContainerKey is not a string: sap.ushell.services.Personalization"," ");}if(C.length>40){jQuery.sap.log.error("Personalization Service container key (\""+C+"\") should be less than 40 characters [current :"+C.length+"]");}s=this._adjustScope(s);P=j(C);L=window["sap-ushell-config"]&&window["sap-ushell-config"].services&&window["sap-ushell-config"].services.ShellNavigation&&window["sap-ushell-config"].services.ShellNavigation.config&&window["sap-ushell-config"].services.ShellNavigation.config.reload;b=_;if(s&&s.validity===0){if(L){s.validity=1440;}else{b=a;}}return{oAdapterForScope:b,oScope:s,sPrefixedContainerKey:P};}sap.ushell.services.Personalization.prototype.getContainer=function(C,s,a){return this._createContainer(C,s,false,a);};sap.ushell.services.Personalization.prototype.createEmptyContainer=function(C,s,a){return this._createContainer(C,s,true,a);};sap.ushell.services.Personalization.prototype._createContainer=function(C,s,b,a){var D=new jQuery.Deferred(),r,L,e;r=this._adjustScopePickAdapter(C,s,this._oAdapterWithBackendAdapter,this._oAdapterWindowOnly);e=new sap.ushell.services.Personalization.ContextContainer(this,r.oAdapterForScope,r.sPrefixedContainerKey,r.oScope,a);if(b&&this._supportsGetWithoutSubsequentLoad){L=new jQuery.Deferred();L.resolve(e);}else{L=e.load();}L.fail(function(){D.reject();}).done(function(){if(b||e._isExpired()){e.clear();}D.resolve(e);});return D.promise();};sap.ushell.services.Personalization.prototype.delContainer=function(C,s){var D={},P,a="",t=this;s=t._adjustScope(s);a=j(C);D=new jQuery.Deferred();P=t._pendingContainerOperations_cancelAddNext(C,null);P.always(function(){t.getContainer(C,s).fail(function(){t._pendingContainerOperations_cancelAddNext(C,D);D.reject();}).done(function(b){var e;t._pendingContainerOperations_cancelAddNext(C,D);if(s.validity===0){e=t._oAdapterWindowOnly;}else{e=t._oAdapterWithBackendAdapter;}e.delAdapterContainer(a,s).fail(function(){D.reject();}).done(function(){D.resolve();});});});return D.promise();};sap.ushell.services.Personalization.prototype._pendingContainerOperations_flushAddNext=function(C,D){var P,s;P=this._oPendingOperationsMap.get(C);if(!P){P=new jQuery.Deferred();P.resolve();}if(D!==null){this._oPendingOperationsMap.put(C,D);}if(!P||P.state()!=="pending"){return P;}clearTimeout(P._sapTimeoutId);P._sapTimeoutId=undefined;if(typeof P._sapFnSave==="function"){s=P._sapFnSave;P._sapFnSave=undefined;s();}return P;};sap.ushell.services.Personalization.prototype._pendingContainerOperations_cancelAddNext=function(C,D){var P;P=this._oPendingOperationsMap.get(C);if(!P){P=new jQuery.Deferred();P.resolve();}if(D!==null){this._oPendingOperationsMap.put(C,D);}if(!P||P.state()!=="pending"){return P;}if(P._sapTimeoutId){clearTimeout(P._sapTimeoutId);P._sapTimeoutId=undefined;P.resolve(sap.ushell.services.Personalization.prototype.SAVE_DEFERRED_DROPPED);}return P;};sap.ushell.services.Personalization.prototype.getPersonalizationContainer=function(C){var P="",a={},D={};if(typeof C!=="string"){throw new sap.ushell.utils.Error("sContainerKey is not a string: sap.ushell.services.Personalization"," ");}P=j(C);if(this._oContainerMap.containsKey(P)){return this._oContainerMap.get(P).promise();}D=new jQuery.Deferred();a=new sap.ushell.services.PersonalizationContainer(this._oAdapterWithBackendAdapter,P);a.done(function(b){D.resolve(b);}).fail(function(b){D.reject(b);});this._oContainerMap.put(P,D);return D.promise();};sap.ushell.services.Personalization.prototype.delPersonalizationContainer=function(C){var D={},P="",t=this;P=j(C);D=new jQuery.Deferred();this.getPersonalizationContainer(C).fail(function(){D.reject();}).done(function(a){t._oAdapterWithBackendAdapter.delAdapterContainer(P).fail(function(){D.reject();}).done(function(){t._oContainerMap.remove(P);D.resolve();});});return D.promise();};sap.ushell.services.Personalization.prototype._adjustScope=l;sap.ushell.services.Personalization.prototype._adjustScopePickAdapter=m;sap.ushell.services.Personalizer=function(s,a,P,S,C){this._sPersContainer="";this._sPersItem="";this._sPersVariant=null;this._oAdapter=a;this._oService=s;this._oScope=S;this._oComponent=C;if(!P||!P.container||!P.item||typeof P.container!=="string"||typeof P.item!=="string"){throw new sap.ushell.utils.Error("Invalid input for oPersId: sap.ushell.services.Personalization"," ");}this._sPersContainer=P.container;this._sPersItem=P.item;};sap.ushell.services.Personalizer.prototype._getContainer=function(P){if(!this._oGetContainerPromise){this._oGetContainerPromise=this._oService.getContainer(P,this._oScope,this._oComponent);}return this._oGetContainerPromise;};sap.ushell.services.Personalizer.prototype.getPersData=function(){var D={},t=this;D=new jQuery.Deferred();this._getContainer(this._sPersContainer).fail(function(){D.reject();}).done(function(C){D.resolve(C.getItemValue(t._sPersItem));});D.fail(function(){jQuery.sap.log.error("Fail to get Personalization data for Personalizer container: "+t._sPersContainer);});return D.promise();};sap.ushell.services.Personalizer.prototype.setPersData=function(V){var D={},t=this;D=new jQuery.Deferred();this._getContainer(this._sPersContainer).fail(function(){D.reject();}).done(function(C){C.setItemValue(t._sPersItem,V);C.save().fail(function(){D.reject();}).done(function(){D.resolve();});});D.fail(function(){jQuery.sap.log.error("Fail to set Personalization data for Personalizer container: "+t._sPersContainer);});return D.promise();};sap.ushell.services.Personalizer.prototype.delPersData=function(){var D={},t=this,M;D=new jQuery.Deferred();this._oService.getPersonalizationContainer(this._sPersContainer).fail(function(){D.reject();}).done(function(C){C.delItem(t._sPersItem);C.save().fail(function(){D.reject();}).done(function(){D.resolve();});});M=D.promise();M.fail(function(){jQuery.sap.log.error("Fail to delete Personalization data for Personalizer container: "+this._sPersContainer);});return M;};sap.ushell.services.TransientPersonalizer=function(){this._oValue=undefined;};sap.ushell.services.TransientPersonalizer.prototype.getPersData=function(){var D;D=new jQuery.Deferred();D.resolve(this._oValue);return D.promise();};sap.ushell.services.TransientPersonalizer.prototype.setPersData=function(V){var D;D=new jQuery.Deferred();this._oValue=V;D.resolve();return D.promise();};sap.ushell.services.TransientPersonalizer.prototype.delPersData=function(){var D;D=new jQuery.Deferred();this._oValue=undefined;D.resolve();return D.promise();};sap.ushell.services.TransientPersonalizer.prototype.setValue=function(V){this._oValue=V;};sap.ushell.services.TransientPersonalizer.prototype.getValue=function(){return this._oValue;};sap.ushell.services.PersonalizationContainer=function(a,C){this._sContainerKey=C;this._oAdapterContainer={};this._aLoadedVariantSetKeys=[];this._aLoadedItemKeys=[];var D={},t=this;this._init();D=new jQuery.Deferred();if(!this._sContainerKey||typeof this._sContainerKey!=="string"){throw new sap.ushell.utils.Error("Invalid container key: sap.ushell.services.Personalization"," ");}this._oAdapterContainer=a.getAdapterContainer(this._sContainerKey);this.load().fail(function(){D.reject();}).done(function(){D.resolve(t);});return D.promise();};sap.ushell.services.PersonalizationContainer.prototype._init=function(){this._oVariantSetMap={};this._oItemMap={};this._aLoadedVariantSetKeys=[];this._aLoadedItemKeys=[];this._oVariantSetMap=new sap.ushell.utils.Map();this._oItemMap=new sap.ushell.utils.Map();};function n(O){if(O===undefined){return undefined;}try{return JSON.parse(JSON.stringify(O));}catch(e){return undefined;}}function o(O){if(O===undefined){return undefined;}try{return JSON.parse(O);}catch(e){return undefined;}}sap.ushell.services.PersonalizationContainer.prototype.load=function(){var D={},i=[],V=[],a=[],M=[],t=this;function b(a){var N=[],P=[];N=a.filter(function(s){return s.indexOf(I)!==0;});if(N.length===0){return a;}P=a.filter(function(s){return s.indexOf(I)===0;});N.forEach(function(s){var e={},q="";q=I+s;e=n(t._oAdapterContainer.getItemValue(s));t._oAdapterContainer.setItemValue(q,e);t._oAdapterContainer.delItem(s);if(jQuery.inArray(q,P)===-1){P.push(q);}});return P;}D=new jQuery.Deferred();if(!this._sContainerKey){throw new sap.ushell.utils.Error("Invalid container key: sap.ushell.services.Personalization"," ");}this._init();this._oAdapterContainer.load().fail(function(){D.reject();}).done(function(){i=t._oAdapterContainer.getItemKeys().splice(0);V=i.filter(function(s){return s.indexOf(v)===0;});V.forEach(function(s){var e={};e=new sap.ushell.services.PersonalizationContainerVariantSet(s,t._oAdapterContainer);t._oVariantSetMap.put(s,e);});a=i.filter(function(s){return s.indexOf(v)!==0;});M=b(a);M.forEach(function(s){t._oItemMap.put(s,n(t._oAdapterContainer.getItemValue(s)));});t._aLoadedVariantSetKeys=t._oVariantSetMap.keys().splice(0);t._aLoadedItemKeys=t._oItemMap.keys().splice(0);D.resolve();});return D.promise();};sap.ushell.services.PersonalizationContainer.prototype.save=function(){var s,i;this._serializeVariantSets();this._serializeItems();s=new jQuery.Deferred();function S(){s.resolve();}function a(){s.reject();}try{i=this._oAdapterContainer.save();i.fail(a);i.done(S);}catch(e){s.reject();}return s.promise();};sap.ushell.services.PersonalizationContainer.prototype.getItemKeys=function(){return this._oItemMap.keys().map(function(e){return e.replace(I,"","");});};sap.ushell.services.PersonalizationContainer.prototype.getItemValue=function(i){if(typeof i!=="string"){return undefined;}return this._oItemMap.get(I+i);};sap.ushell.services.PersonalizationContainer.prototype.containsItem=function(i){if(typeof i!=="string"){return undefined;}return this._oItemMap.containsKey(I+i);};sap.ushell.services.PersonalizationContainer.prototype.setItemValue=function(i,a){if(typeof i!=="string"){throw new sap.ushell.utils.Error("Parameter value of sItemKey is not a string: sap.ushell.services.Personalization"," ");}this._oItemMap.put(I+i,a);};sap.ushell.services.PersonalizationContainer.prototype.delItem=function(i){if(typeof i!=="string"){return undefined;}if(this.containsItem(i)){this._oItemMap.remove(I+i);}};sap.ushell.services.PersonalizationContainer.prototype._serializeItems=function(){var i=[],D=[],t=this;i=this._oItemMap.keys();i.forEach(function(s){t._oAdapterContainer.setItemValue(s,n(t._oItemMap.get(s)));});D=this._aLoadedItemKeys.filter(function(s){return!(i.indexOf(s)>-1);});D.forEach(function(s){t._oAdapterContainer.delItem(s);});};sap.ushell.services.PersonalizationContainer.prototype.getVariantSetKeys=function(){var V=[],P=[];P=this._oVariantSetMap.keys();V=P.map(function(e){return e.replace(v,"","");});return V;};sap.ushell.services.PersonalizationContainer.prototype.containsVariantSet=function(V){return this._oVariantSetMap.containsKey(v+V);};sap.ushell.services.PersonalizationContainer.prototype.getVariantSet=function(V){var P,a={};P=v+V;a=this._oVariantSetMap.get(P);return a;};sap.ushell.services.PersonalizationContainer.prototype.addVariantSet=function(V){var e={},a={},P="";if(this.containsVariantSet(V)){throw new sap.ushell.utils.Error("Container already contains a variant set with key '"+V+"': sap.ushell.services.Personalization"," ");}P=v+V;e={currentVariant:null,variants:{}};this._oAdapterContainer.setItemValue(P,e);a=new sap.ushell.services.PersonalizationContainerVariantSet(P,this._oAdapterContainer);this._oVariantSetMap.put(P,a);return a;};sap.ushell.services.PersonalizationContainer.prototype._serializeVariantSets=function(){var V=[],D=[],t=this;V=this._oVariantSetMap.keys();V.forEach(function(s){var a={},b={};a=t._oVariantSetMap.get(s);b=a._serialize();t._oAdapterContainer.setItemValue(s,n(b));});D=this._aLoadedVariantSetKeys.filter(function(s){return!(V.indexOf(s)>-1);});D.forEach(function(s){t._oAdapterContainer.delItem(s);});};sap.ushell.services.PersonalizationContainer.prototype.delVariantSet=function(V){var P="";P=v+V;this._oVariantSetMap.remove(P);return this._oAdapterContainer.delItem(P);};sap.ushell.services.Personalization.ContextContainer=function(s,a,C,S,b){this._oService=s;this._sContainerKey=C;this._oAdapterContainer={};this._oScope=S||sap.ushell.services.Personalization.prototype._adjustScope(S);this._aLoadedKeys=[];this._oUnmodifiableContainer=undefined;var e;if(!(b instanceof sap.ui.core.UIComponent)&&b!==undefined){throw new Error("oComponent passed must be a UI5 Component or must be undefined");}if(b&&b.getMetadata&&b.getMetadata().getLibraryName){e=b.getMetadata().getLibraryName();}this.clear();if(!this._sContainerKey||typeof this._sContainerKey!=="string"){throw new sap.ushell.utils.Error("Invalid container key: sap.ushell.services.Personalization"," ");}this._oAdapterContainer=a.getAdapterContainer(this._sContainerKey,this._oScope,e);return this;};sap.ushell.services.Personalization.ContextContainer.prototype.getValidity=function(){return this._oScope.validity;};sap.ushell.services.Personalization.ContextContainer.prototype.clear=function(){this._oItemMap={};this._aLoadedItemKeys=[];this._clear=true;this._oItemMap=new sap.ushell.utils.Map();};sap.ushell.services.Personalization.ContextContainer.prototype.load=function(){var D={},P,t=this;D=new jQuery.Deferred();if(!this._sContainerKey){throw new sap.ushell.utils.Error("Invalid container key: sap.ushell.services.Personalization"," ");}this.clear();P=this._oService._pendingContainerOperations_flushAddNext(this._sContainerKey,D);P.always(function(){t._oAdapterContainer.load().fail(function(){D.reject();}).done(function(){t._copyFromAdapter();if(t._isExpired()){t.clear();}D.resolve();});});return D.promise();};sap.ushell.services.Personalization.ContextContainer.prototype._copyFromAdapter=function(){var t=this,a;a=t._oAdapterContainer.getItemKeys().splice(0);a.forEach(function(i){t._oItemMap.put(i,JSON.stringify(t._oAdapterContainer.getItemValue(i)));});this._aLoadedItemKeys=t._oItemMap.keys().splice(0);};sap.ushell.services.Personalization.ContextContainer.prototype._isExpired=function(){var F,t,T;if(this.getValidity()===Infinity||this.getValidity()===0){return false;}t=this._getItemValueInternal(d,h);F=sap.ui.core.format.DateFormat.getDateInstance({pattern:A});T=F.format(this._getNow(),true);return t&&T>t;};sap.ushell.services.Personalization.ContextContainer.prototype._getNow=function(){return new Date();};sap.ushell.services.Personalization.ContextContainer.prototype._copyToAdapterUpdatingValidity=function(){var i=[],D=[],t=this,N,F,T,s;if(this._clear){i=this._oAdapterContainer.getItemKeys().splice(0);i.forEach(function(a){t._oAdapterContainer.delItem(a);});this._clear=false;}if(this.getValidity()===Infinity||this.getValidity()===0){this._delItemInternal(d,f);this._delItemInternal(d,h);this._delItemInternal(d,g);}else{F=sap.ui.core.format.DateFormat.getDateInstance({pattern:A});N=this._getNow();s=F.format(N,true);T=F.format(new Date(N.getTime()+this.getValidity()*60000),true);this._setItemValueInternal(d,f,this._oScope);this._setItemValueInternal(d,h,T);this._setItemValueInternal(d,g,s);}i=this._oItemMap.keys();i.forEach(function(a){t._oAdapterContainer.setItemValue(a,o(t._oItemMap.get(a)));});D=this._aLoadedItemKeys.filter(function(a){return!(i.indexOf(a)>-1);});D.forEach(function(a){t._oAdapterContainer.delItem(a);});};sap.ushell.services.Personalization.ContextContainer.prototype.save=function(){var s,P,t=this;this._copyToAdapterUpdatingValidity();s=new jQuery.Deferred();P=this._oService._pendingContainerOperations_cancelAddNext(this._sContainerKey,s);P.always(function(){try{t._oAdapterContainer.save().fail(function(){s.reject();}).done(function(){s.resolve();});}catch(e){s.reject();}});return s.promise();};sap.ushell.services.Personalization.ContextContainer.prototype.saveDeferred=function(a){var s,P,t=this;this._copyToAdapterUpdatingValidity();s=new jQuery.Deferred();P=this._oService._pendingContainerOperations_cancelAddNext(this._sContainerKey,s);function D(){P.always(function(){try{t._oAdapterContainer.save().fail(function(){s.reject();}).done(function(){s.resolve();});}catch(e){s.reject();}});}s._sapFnSave=D;s._sapTimeoutId=setTimeout(D,a);return s.promise();};sap.ushell.services.Personalization.ContextContainer.prototype.flush=function(){var s,P;this._copyToAdapterUpdatingValidity();s=new jQuery.Deferred();P=this._oService._pendingContainerOperations_flushAddNext(this._sContainerKey,s);P.fail(function(){s.reject();}).done(function(){s.resolve();});return s.promise();};sap.ushell.services.Personalization.ContextContainer.prototype.getItemKeys=function(){var F=this._oItemMap.keys().filter(function(s){return s.indexOf(I)===0;});return F.map(function(e){return e.replace(I,"","");});};sap.ushell.services.Personalization.ContextContainer.prototype._getInternalKeys=function(){return this._oItemMap.keys().splice(0);};sap.ushell.services.Personalization.ContextContainer.prototype.getItemValue=function(i){return this._getItemValueInternal(I,i);};sap.ushell.services.Personalization.ContextContainer.prototype._getItemValueInternal=function(P,i){if(typeof i!=="string"||typeof P!=="string"){return undefined;}return o(this._oItemMap.get(P+i));};sap.ushell.services.Personalization.ContextContainer.prototype.containsItem=function(i){if(typeof i!=="string"){return undefined;}return this._oItemMap.containsKey(I+i);};sap.ushell.services.Personalization.ContextContainer.prototype.setItemValue=function(i,a){this._setItemValueInternal(I,i,a);};sap.ushell.services.Personalization.ContextContainer.prototype._setItemValueInternal=function(i,s,a){if(typeof s!=="string"||typeof i!=="string"){throw new sap.ushell.utils.Error("Parameter value of sItemKey or sItemValue is not a string: sap.ushell.services.Personalization"," ");}if(s.length>40){jQuery.sap.log.error("Personalization Service item key/variant set name (\""+s+"\") should be less than 40 characters [current :"+s.length+"]");}this._oItemMap.put(i+s,JSON.stringify(a));};sap.ushell.services.Personalization.ContextContainer.prototype.delItem=function(i){this._delItemInternal(I,i);};sap.ushell.services.Personalization.ContextContainer.prototype._delItemInternal=function(P,i){if(typeof i!=="string"){return undefined;}if(typeof P!=="string"){return undefined;}this._oItemMap.remove(P+i);};sap.ushell.services.Personalization.ContextContainer.prototype.getKey=function(){return this._sContainerKey.substring(c.length);};sap.ushell.services.Personalization.ContextContainer.prototype.getUnmodifiableContainer=function(){var t=this;if(!this._oUnmodifiableContainer){this._oUnmodifiableContainer=(function(){var u={};["clear","delItem","flush","load","save","saveDeferred","setItemValue"].forEach(function(F){u[F]=function(N){throw new sap.ushell.utils.Error("Function "+N+" can't be called on unmodifiable container","sap.ushell.services.Personalization.ContextContainer"," ");}.bind(undefined,F);});["containsItem","getItemKeys","getItemValue","getUnmodifiableContainer","getValidity"].forEach(function(F){if(t[F]){u[F]=t[F].bind(t);}});return u;}());}return this._oUnmodifiableContainer;};sap.ushell.services.Personalization.VariantSetAdapter=function(C){this._oContextContainer=C;};sap.ushell.services.Personalization.VariantSetAdapter.prototype.save=function(){return this._oContextContainer.save();};sap.ushell.services.Personalization.VariantSetAdapter.prototype.getVariantSetKeys=function(){var P=this._oContextContainer._getInternalKeys(),V=[];V=P.map(function(e){return e.replace(v,"","");});return V;};sap.ushell.services.Personalization.VariantSetAdapter.prototype.containsVariantSet=function(V){return this.getVariantSetKeys().indexOf(V)>=0;};sap.ushell.services.Personalization.VariantSetAdapter.prototype.getVariantSet=function(V){var a=this._oContextContainer._getItemValueInternal(v,V);if(!a){return undefined;}return new sap.ushell.services.Personalization.VariantSet(V,this._oContextContainer);};sap.ushell.services.Personalization.VariantSetAdapter.prototype.addVariantSet=function(V){var e={},a={};if(this.containsVariantSet(V)){throw new sap.ushell.utils.Error("Container already contains a variant set with key '"+V+"': sap.ushell.services.Personalization"," ");}e={currentVariant:null,variants:{}};this._oContextContainer._setItemValueInternal(v,V,e);a=new sap.ushell.services.Personalization.VariantSet(V,this._oContextContainer);return a;};sap.ushell.services.Personalization.VariantSetAdapter.prototype.delVariantSet=function(V){this._oContextContainer._delItemInternal(v,V);};sap.ushell.services.Personalization.VariantSet=function(V,C){var s,a,b=new sap.ushell.utils.Map(),e=new sap.ushell.utils.Map(),i,q;this._oContextContainer=C;this._sVariantSetKey=V;this._oVariantSetData=this._oContextContainer._getItemValueInternal(v,this._sVariantSetKey);if(!Object.prototype.hasOwnProperty.call(this._oVariantSetData,"currentVariant")){throw new sap.ushell.utils.Error("Corrupt variant set data: sap.ushell.services.Personalization"," ");}if(Object.prototype.hasOwnProperty.call(this._oVariantSetData,"variants")){for(s in this._oVariantSetData.variants){if(Object.prototype.hasOwnProperty.call(this._oVariantSetData.variants,s)){a=this._oVariantSetData.variants[s].name;i=this._oVariantSetData.variants[s].variantData;if(b.containsKey(a)){throw new sap.ushell.utils.Error("Variant name already exists: sap.ushell.services.Personalization"," ");}else{b.put(a,s);q=new sap.ushell.services.PersonalizationContainerVariant(s,a,i);e.put(s,q);}}}}else{throw new sap.ushell.utils.Error("Corrupt variant set data: sap.ushell.services.Personalization"," ");}return this;};sap.ushell.services.Personalization.VariantSet.prototype._getVariantSet=function(){return this._oVariantSetData;};sap.ushell.services.Personalization.VariantSet.prototype._serialize=function(){this._oContextContainer._setItemValueInternal(v,this._sVariantSetKey,this._oVariantSetData);};sap.ushell.services.Personalization.VariantSet.prototype.getCurrentVariantKey=function(){return this._getVariantSet().currentVariant;};sap.ushell.services.Personalization.VariantSet.prototype.setCurrentVariantKey=function(V){this._getVariantSet().currentVariant=V;this._serialize();};sap.ushell.services.Personalization.VariantSet.prototype.getVariantKeys=function(){var V=new sap.ushell.utils.Map(),a=this._getVariantSet(this._sVariantSetKey),s;if(Object.prototype.hasOwnProperty.call(a,"variants")){for(s in a.variants){if(Object.prototype.hasOwnProperty.call(a.variants,s)){V.put(s,"dummy");}}}else{throw new sap.ushell.utils.Error("Corrupt variant set data: sap.ushell.services.Personalization"," ");}return V.keys();};sap.ushell.services.Personalization.VariantSet.prototype.getVariantNamesAndKeys=function(){var V=new sap.ushell.utils.Map(),a=new sap.ushell.utils.Map(),b=this._getVariantSet(this._sVariantSetKey),s,e;if(Object.prototype.hasOwnProperty.call(b,"variants")){for(s in b.variants){if(Object.prototype.hasOwnProperty.call(b.variants,s)){e=b.variants[s].name;if(V.containsKey(e)){throw new sap.ushell.utils.Error("Variant name already exists: sap.ushell.services.Personalization"," ");}else{V.put(e,s);}a.put(s,"dummy");}}}else{throw new sap.ushell.utils.Error("Corrupt variant set data: sap.ushell.services.Personalization"," ");}return V.entries;};sap.ushell.services.Personalization.VariantSet.prototype.getVariant=function(V){if(typeof V!=="string"){return undefined;}var a=this._getVariantSet(this._sVariantSetKey),s,b,e;if(Object.prototype.hasOwnProperty.call(a,"variants")&&Object.prototype.hasOwnProperty.call(a.variants,V)){s=a.variants[V].name;e=a.variants[V].variantData;b=new sap.ushell.services.Personalization.Variant(this,V,s,e);return b;}return undefined;};sap.ushell.services.Personalization.VariantSet.prototype.getVariantKeyByName=function(V){if(typeof V!=="string"){return undefined;}var a=this._getVariantSet(this._sVariantSetKey),s;if(Object.prototype.hasOwnProperty.call(a,"variants")){for(s in a.variants){if(Object.prototype.hasOwnProperty.call(a.variants,s)){if(V===a.variants[s].name){return s;}}}}else{throw new sap.ushell.utils.Error("Corrupt variant set data: sap.ushell.services.Personalization"," ");}return undefined;};sap.ushell.services.Personalization.VariantSet.prototype.containsVariant=function(V){var a=this._getVariantSet();if(typeof V!=="string"){return undefined;}return Object.prototype.hasOwnProperty.call(a,"variants")&&Object.prototype.hasOwnProperty.call(a.variants,V);};sap.ushell.services.Personalization.VariantSet.prototype.addVariant=function(V){var K=[],M=0,s="",e={};K=this.getVariantKeys();M=parseInt(K.sort(function(a,b){return a-b;}).reverse()[0],10);s=isNaN(M)?"0":(M+1).toString();if(K.indexOf(s)>=0){throw new sap.ushell.utils.Error("Variant key '"+s+"' already exists in variant set"+this._sVariantSetKey+"': sap.ushell.services.Personalization"," ");}if(typeof V!=="string"){throw new sap.ushell.utils.Error("Parameter value of sVariantName is not a string: sap.ushell.services.Personalization"," ");}if(this.getVariantKeyByName(V)!==undefined){throw new sap.ushell.utils.Error("Variant name '"+V+"' already exists in variant set '"+this._sVariantSetKey+"' (Old key: '"+this.getVariantKeyByName(V)+"' New key: '"+s+"') ': sap.ushell.services.Personalization"," ");}e=new sap.ushell.services.Personalization.Variant(this,s,V);this._getVariantSet(this._sVariantSetKey).variants[s]={name:V,variantData:{}};this._serialize();return e;};sap.ushell.services.Personalization.VariantSet.prototype.delVariant=function(V){var a;if(typeof V!=="string"){return undefined;}a=this._getVariantSet();if(a&&a.variants){delete this._oVariantSetData.variants[V];}this._serialize();};sap.ushell.services.PersonalizationContainerVariantSet=function(V,a){var b,s,e,i,q;this._sVariantSetKey=V;this._oAdapterContainer=a;this._oVariantNameMap=new sap.ushell.utils.Map();this._oVariantMap=new sap.ushell.utils.Map();b=n(this._oAdapterContainer.getItemValue(V));if(b.hasOwnProperty("currentVariant")){this._sCurrentVariantKey=b.currentVariant;}else{throw new sap.ushell.utils.Error("Corrupt variant set data: sap.ushell.services.Personalization"," ");}if(b.hasOwnProperty("variants")){for(s in b.variants){if(b.variants.hasOwnProperty(s)){e=b.variants[s].name;i=b.variants[s].variantData;if(this._oVariantNameMap.containsKey(e)){throw new sap.ushell.utils.Error("Variant name already exists: sap.ushell.services.Personalization"," ");}else{this._oVariantNameMap.put(e,s);q=new sap.ushell.services.PersonalizationContainerVariant(s,e,i);this._oVariantMap.put(s,q);}}}}else{throw new sap.ushell.utils.Error("Corrupt variant set data: sap.ushell.services.Personalization"," ");}return this;};sap.ushell.services.PersonalizationContainerVariantSet.prototype.getCurrentVariantKey=function(){return this._sCurrentVariantKey;};sap.ushell.services.PersonalizationContainerVariantSet.prototype.setCurrentVariantKey=function(V){this._sCurrentVariantKey=V;};sap.ushell.services.PersonalizationContainerVariantSet.prototype.getVariantKeys=function(){return this._oVariantMap.keys();};sap.ushell.services.PersonalizationContainerVariantSet.prototype.getVariantNamesAndKeys=function(){return JSON.parse(JSON.stringify(this._oVariantNameMap.entries));};sap.ushell.services.PersonalizationContainerVariantSet.prototype.getVariant=function(V){if(typeof V!=="string"){return undefined;}return this._oVariantMap.get(V);};sap.ushell.services.PersonalizationContainerVariantSet.prototype.getVariantKeyByName=function(V){if(typeof V!=="string"){return undefined;}return this._oVariantNameMap.get(V);};sap.ushell.services.PersonalizationContainerVariantSet.prototype.containsVariant=function(V){if(typeof V!=="string"){return undefined;}return this._oVariantMap.containsKey(V);};sap.ushell.services.PersonalizationContainerVariantSet.prototype.addVariant=function(V){var M=0,s="",e={};M=parseInt(this._oVariantMap.keys().sort(function(a,b){return a-b;}).reverse()[0],10);s=isNaN(M)?"0":(M+1).toString();if(this._oVariantMap.containsKey(s)){throw new sap.ushell.utils.Error("Variant key '"+s+"' already exists in variant set"+this._sVariantSetKey+"': sap.ushell.services.Personalization"," ");}if(typeof V!=="string"){throw new sap.ushell.utils.Error("Parameter value of sVariantName is not a string: sap.ushell.services.Personalization"," ");}if(this._oVariantNameMap.containsKey(V)){throw new sap.ushell.utils.Error("Variant name '"+V+"' already exists in variant set '"+this._sVariantSetKey+"' (Old key: '"+this._oVariantNameMap.get(V)+"' New key: '"+s+"') ': sap.ushell.services.Personalization"," ");}e=new sap.ushell.services.PersonalizationContainerVariant(s,V);this._oVariantMap.put(s,e);this._oVariantNameMap.put(V,s);return e;};sap.ushell.services.PersonalizationContainerVariantSet.prototype._serialize=function(){var V=[],a={},b={},t=this;a.currentVariant=this._sCurrentVariantKey;V=this.getVariantKeys();V.forEach(function(s){var e={};e=t._oVariantMap.get(s);b[s]=e._serialize();});a.variants=b;return a;};sap.ushell.services.PersonalizationContainerVariantSet.prototype.delVariant=function(V){var a=this._oVariantMap.get(V);if(a){this._oVariantNameMap.remove(a.getVariantName());this._oVariantMap.remove(V);}};sap.ushell.services.Personalization.Variant=function(V,s,a){if(typeof s!=="string"){throw new sap.ushell.utils.Error("Parameter value of sVariantKey is not a string: sap.ushell.services.Personalization"," ");}if(typeof a!=="string"){throw new sap.ushell.utils.Error("Parameter value of sVariantName is not a string: sap.ushell.services.Personalization"," ");}this._oVariantSet=V;this._sVariantKey=s;this._sVariantName=a;};sap.ushell.services.Personalization.Variant.prototype.getVariantKey=function(){return this._sVariantKey;};sap.ushell.services.Personalization.Variant.prototype.getVariantName=function(){return this._sVariantName;};sap.ushell.services.Personalization.Variant.prototype.setVariantName=function(V){var a=this._oVariantSet._getVariantSet(),b;if(typeof V!=="string"){throw new sap.ushell.utils.Error("Parameter value of sVariantName is not a string: sap.ushell.services.Personalization"," ");}if(this._oVariantSet.getVariantKeyByName(V)!==undefined){throw new sap.ushell.utils.Error("Variant with name '"+V+"' already exists in variant set '"+this._oVariantSet._sVariantSetKey+"': sap.ushell.services.Personalization"," ");}if(Object.prototype.hasOwnProperty.call(a,"variants")&&Object.prototype.hasOwnProperty.call(a.variants,this._sVariantKey)){b=a.variants[this._sVariantKey];b.name=V;this._sVariantName=V;this._oVariantSet._serialize();}else{throw new sap.ushell.utils.Error("Variant does not longer exist"," ");}};sap.ushell.services.Personalization.Variant.prototype.getItemValue=function(i){if(typeof i!=="string"){return undefined;}var a=this._oVariantSet._getVariantSet().variants[this._sVariantKey].variantData;return Object.prototype.hasOwnProperty.call(a,i)&&n(a[i]);};sap.ushell.services.Personalization.Variant.prototype.setItemValue=function(i,a){if(typeof i!=="string"){throw new sap.ushell.utils.Error("Parameter value of sItemKey is not a string: sap.ushell.services.Personalization"," ");}var b,e=this._oVariantSet._getVariantSet().variants&&this._oVariantSet._getVariantSet().variants[this._sVariantKey];if(!e){throw new sap.ushell.utils.Error("Variant does not longer exist"," ");}if(!e.variantData){e.variantData={};}b=e.variantData;b[i]=n(a);this._oVariantSet._serialize();};sap.ushell.services.Personalization.Variant.prototype.containsItem=function(i){if(typeof i!=="string"){return undefined;}var a=this.oAccess.variantSet._getVariantSet().variants[this._sVariantKey].variantData;return Object.prototype.hasOwnProperty.call(a,i);};sap.ushell.services.Personalization.Variant.prototype.getItemKeys=function(){var a=this._oVariantSet._getVariantSet().variants[this._sVariantKey].variantData,i,b=[];for(i in a){if(Object.prototype.hasOwnProperty.call(a,i)){b.push(i);}}b.sort();return b;};sap.ushell.services.Personalization.Variant.prototype.delItem=function(i){if(typeof i!=="string"){return undefined;}var a=this.oVariantSet._getVariantSet().variants[this._sVariantKey].variantData;delete a[i];this.oVariantSet._serialize();};sap.ushell.services.PersonalizationContainerVariant=function(V,s,a){if(typeof V!=="string"){throw new sap.ushell.utils.Error("Parameter value of sVariantKey is not a string: sap.ushell.services.Personalization"," ");}if(typeof s!=="string"){throw new sap.ushell.utils.Error("Parameter value of sVariantName is not a string: sap.ushell.services.Personalization"," ");}if(a&&typeof a!=="object"){throw new sap.ushell.utils.Error("Parameter value of sVariantName is not a string: sap.ushell.services.Personalization"," ");}this._oVariantKey=V;this._oVariantName=s;this._oItemMap=new sap.ushell.utils.Map();this._oItemMap.entries=a||{};};sap.ushell.services.PersonalizationContainerVariant.prototype.getVariantKey=function(){return this._oVariantKey;};sap.ushell.services.PersonalizationContainerVariant.prototype.getVariantName=function(){return this._oVariantName;};sap.ushell.services.PersonalizationContainerVariant.prototype.getItemValue=function(i){if(typeof i!=="string"){return undefined;}return this._oItemMap.get(i);};sap.ushell.services.PersonalizationContainerVariant.prototype.setItemValue=function(i,a){if(typeof i!=="string"){throw new sap.ushell.utils.Error("Parameter value of sItemKey is not a string: sap.ushell.services.Personalization"," ");}return this._oItemMap.put(i,a);};sap.ushell.services.PersonalizationContainerVariant.prototype.containsItem=function(i){if(typeof i!=="string"){return undefined;}return this._oItemMap.containsKey(i);};sap.ushell.services.PersonalizationContainerVariant.prototype.getItemKeys=function(){return this._oItemMap.keys();};sap.ushell.services.PersonalizationContainerVariant.prototype.delItem=function(i){if(typeof i!=="string"){return undefined;}return this._oItemMap.remove(i);};sap.ushell.services.PersonalizationContainerVariant.prototype._serialize=function(){var i=[],V={},a={},t=this;V.name=this.getVariantName();i=this._oItemMap.keys();i.forEach(function(s){a[s]=t.getItemValue(s);});V.variantData=a;return V;};sap.ushell.services.Personalization.WindowAdapter=function(s,b){this._oBackendAdapter=b;if(!sap.ushell.services.Personalization.WindowAdapter.prototype.data){sap.ushell.services.Personalization.WindowAdapter.prototype.data={};}};sap.ushell.services.Personalization.WindowAdapter.prototype.getAdapterContainer=function(C,s,a){var b=this._oBackendAdapter&&this._oBackendAdapter.getAdapterContainer(C,s,a);return new sap.ushell.services.Personalization.WindowAdapterContainer(C,s,b);};sap.ushell.services.Personalization.WindowAdapter.prototype.delAdapterContainer=function(C,s){var D=new jQuery.Deferred();delete sap.ushell.services.Personalization.WindowAdapter.prototype.data[C];if(this._oBackendAdapter){this._oBackendAdapter.delAdapterContainer(C,s).done(function(){D.resolve();}).fail(function(M){D.reject(M);});}else{D.resolve();}return D.promise();};sap.ushell.services.Personalization.WindowAdapterContainer=function(C,s,b){this._oBackendContainer=b;this._oItemMap=new sap.ushell.utils.Map();this._sContainerKey=C;};function p(C){var i,a=C.getItemKeys();for(i=0;i<a.length;i=i+1){C.delItem(a[i]);}}sap.ushell.services.Personalization.WindowAdapterContainer.prototype.load=function(){var D=new jQuery.Deferred(),i,a,t=this;if(sap.ushell.services.Personalization.WindowAdapter.prototype.data[this._sContainerKey]){this._oItemMap.entries=n(sap.ushell.services.Personalization.WindowAdapter.prototype.data[this._sContainerKey]);if(this._oBackendContainer){p(this._oBackendContainer);a=this.getItemKeys();for(i=0;i<a.length;i=i+1){this._oBackendContainer.setItemValue(a[i],this._oItemMap.get(a[i]));}}D.resolve();}else{if(this._oBackendContainer){this._oBackendContainer.load().done(function(){a=t._oBackendContainer.getItemKeys();for(i=0;i<a.length;i=i+1){t.setItemValue(a[i],t._oBackendContainer.getItemValue(a[i]));}sap.ushell.services.Personalization.WindowAdapter.prototype.data[t._sContainerKey]=n(t._oItemMap.entries);D.resolve();}).fail(function(M){D.reject(M);});}else{sap.ushell.services.Personalization.WindowAdapter.prototype.data[this._sContainerKey]={};D.resolve();}}return D.promise();};sap.ushell.services.Personalization.WindowAdapterContainer.prototype.save=function(){var D=new jQuery.Deferred();sap.ushell.services.Personalization.WindowAdapter.prototype.data[this._sContainerKey]=n(this._oItemMap.entries);if(this._oBackendContainer){this._oBackendContainer.save().done(function(){D.resolve();}).fail(function(M){D.reject(M);});}else{D.resolve();}return D.promise();};sap.ushell.services.Personalization.WindowAdapterContainer.prototype.getItemKeys=function(){return this._oItemMap.keys();};sap.ushell.services.Personalization.WindowAdapterContainer.prototype.containsItem=function(i){this._oItemMap.containsKey(i);};sap.ushell.services.Personalization.WindowAdapterContainer.prototype.getItemValue=function(i){return this._oItemMap.get(i);};sap.ushell.services.Personalization.WindowAdapterContainer.prototype.setItemValue=function(i,a){this._oItemMap.put(i,a);if(this._oBackendContainer){this._oBackendContainer.setItemValue(i,a);}};sap.ushell.services.Personalization.WindowAdapterContainer.prototype.delItem=function(i){this._oItemMap.remove(i);if(this._oBackendContainer){this._oBackendContainer.delItem(i);}};}());
