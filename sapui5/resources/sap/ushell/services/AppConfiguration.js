// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.services.AppConfiguration");jQuery.sap.require("sap.ushell.utils");function A(){var m={},c=null,C=null,I=[],a=[];sap.ui.getCore().getEventBus().subscribe("sap.ushell.renderers.fiori2.Renderer","appOpened",b,this);function b(e,E,D){C=D;if(a.length){for(var i=0;i<a.length;i++){a[i]();}a.length=0;}}this.addActivity=function(r){var u=sap.ushell.Container.getService("UserRecents");return u.addActivity(r);};this.getCurrentAppliction=function(o){return c;};this.getMetadata=function(o){if(!o){o=c;}if(o){var h=hasher&&hasher.getHash?hasher.getHash():'',k=this._processKey(h);if(!(m.hasOwnProperty(k))){this.addMetadata(o,k);}if(!m[k]){m[k]={};}if(!m[k].title){m[k].title=o.text||sap.ushell.resources.i18n.getText("default_app_title");}return m[k];}return{};};this._processKey=function(e){var i=e.split('?')[0],p=e.split('?')[1],S,P={},f,g='',h='',o;if(p){S=p.split('&');S.forEach(function(j){var k=j.split('=');P[k[0]]=k[1];});f=Object.keys(P).sort();f.forEach(function(k,j){h=j?'&':'?';g+=h+k+'='+P[k];});return i+g;}o=sap.ushell.Container.getService("URLParsing").parseShellHash(e);i=o?o.semanticObject+"-"+o.action:"";return i;};this.setCurrentApplication=function(o){c=o;if(a.length){a.length=0;}};this.setHeaderHiding=function(h){if(sap.ui.Device.system.phone){if(c===C){s(h);}else{a.push(function(){s(h);});}}else{jQuery.sap.log.warning("Application configuration could not be trigger setHeaderHiding on Shell as the running device is not a phone");}};function s(h){var r=sap.ushell.Container.getRenderer("fiori2");if(r){r.setHeaderHiding(h);}}this.addApplicationSettingsButtons=function(B){if(c&&c===C){d(B);}else{a.push(function(){d(B);});}};function d(B){var i,e=[],r=sap.ushell.Container.getRenderer("fiori2"),o=r&&r.getComponentData?r.getComponentData():undefined,f=o?o.config:undefined;for(i=0;i<B.length;i++){var g=B[i];e.push(g.getId());g.setIcon(g.getIcon()||sap.ui.core.IconPool.getIconURI('action-settings'));if(f&&f.enableMeArea){g.addStyleClass('sapUshellActionItem');g.setType(sap.m.ButtonType.Unstyled);}}if(sap.ushell.Container&&r){if(I.length){r.hideActionButton(I,true);}I=e;r.showActionButton(e,true,undefined,true);}}this.setWindowTitle=function(t){window.document.title=t;};this.setIcons=function(i){jQuery.sap.setIcons(i);};this.getSettingsControl=function(){jQuery.sap.require("sap.ushell.ui.footerbar.SettingsButton");return new sap.ushell.ui.footerbar.SettingsButton();};this.getApplicationName=function(o){var M,e=(o&&o.additionalInformation)||null;if(e){M=/^SAPUI5\.Component=(.+)$/i.exec(e);if(M){return M[1];}}return null;};this.getApplicationUrl=function(o){var u=(o&&o.url)||null,S="P_TCODE",i;if(u){if(o.applicationType==="NWBC"&&u.indexOf(S)){return u;}i=u.indexOf("?");if(i>=0){u=u.slice(0,i);}if(u.slice(-1)!=='/'){u+='/';}}return u;};this.getPropertyValueFromConfig=function(o,p,r){var v;if(r&&o.hasOwnProperty(p+"Resource")){v=r.getText(o[p+"Resource"]);}else if(o.hasOwnProperty(p)){v=o[p];}return v;};this.getPropertyValueFromManifest=function(l,p,P){var M=p[P].manifestEntryKey,e=p[P].path,o=l.getManifestEntry(M);return jQuery.sap.getObject(e,undefined,o);};this.addMetadata=function(o,k){try{var f=this.getApplicationName(o),u=this.getApplicationUrl(o),g,l,h,p={"fullWidth":{"manifestEntryKey":"sap.ui","path":"fullWidth"},"hideLightBackground":{"manifestEntryKey":"sap.ui","path":"hideLightBackground"},"title":{"manifestEntryKey":"sap.app","path":"title"},"icon":{"manifestEntryKey":"sap.ui","path":"icons.icon"},"favIcon":{"manifestEntryKey":"sap.ui","path":"icons.favIcon"},"homeScreenIconPhone":{"manifestEntryKey":"sap.ui","path":"icons.phone"},"homeScreenIconPhone@2":{"manifestEntryKey":"sap.ui","path":"icons.phone@2"},"homeScreenIconTablet":{"manifestEntryKey":"sap.ui","path":"icons.tablet"},"homeScreenIconTablet@2":{"manifestEntryKey":"sap.ui","path":"icons.tablet@2"},"startupImage320x460":{"manifestEntryKey":"sap.ui","path":"icons.startupImage640x920"},"startupImage640x920":{"manifestEntryKey":"sap.ui","path":"icons.startupImage640x920"},"startupImage640x1096":{"manifestEntryKey":"sap.ui","path":"icons.startupImage640x1096"},"startupImage768x1004":{"manifestEntryKey":"sap.ui","path":"icons.startupImage768x1004"},"startupImage748x1024":{"manifestEntryKey":"sap.ui","path":"icons.startupImage748x1024"},"startupImage1536x2008":{"manifestEntryKey":"sap.ui","path":"icons.startupImage1536x2008"},"startupImage1496x2048":{"manifestEntryKey":"sap.ui","path":"icons.startupImage1496x2048"},"compactContentDensity":{"manifestEntryKey":"sap.ui5","path":"contentDensities.compact"},"cozyContentDensity":{"manifestEntryKey":"sap.ui5","path":"contentDensities.cozy"}},i,j,n,M,P,q,r,t=o&&o.componentHandle;if(k&&!(m.hasOwnProperty(k))){m[k]={};if(t){l=t.getMetadata();}else if(f){jQuery.sap.log.warning("No component handle available for '"+f+"'; fallback to component.load()",null,"sap.ushell.services.AppConfiguration");try{g=sap.ui.component.load({url:u,name:f});l=g.getMetadata();}catch(e){jQuery.sap.log.warning("Could not receive metadata of component",null,"sap.ushell.services.AppConfiguration");}}if(l){h=l.getConfig();M=(l.getManifest()!==undefined);if(h){q=h.resourceBundle||"";if(q){if(q.slice(0,1)!=='/'){q=u+q;}r=jQuery.sap.resources({url:q,locale:sap.ui.getCore().getConfiguration().getLanguage()});}}for(P in p){if(p.hasOwnProperty(P)){if(M){m[k][P]=this.getPropertyValueFromManifest(l,p,P);}if(h&&m[k][P]===undefined){m[k][P]=this.getPropertyValueFromConfig(h,P,r);}}}m[k].version=l.getVersion();m[k].libraryName=l.getLibraryName();}else if(sap.ushell.utils.isApplicationTypeNWBCRelated(o.applicationType)){var w="/~canvas;window=app/wda/",v=o.url.indexOf(w),W="/bc/gui/sap/its/webgui",x=o.url.indexOf(W);if(v>=0){m[k].libraryName=o.url.substring((v+w.length),o.url.indexOf("/",(v+w.length)));}if(x>=0){var E="etransaction=",y=o.url.indexOf(E,x+W.length),z=o.url.indexOf("&",y),B=(z>=0)?z:o.url.length;m[k].libraryName=o.url.substring(y+E.length,B)+" (TCODE)";}}else{jQuery.sap.log.warning("No technical information for the given application could be determined",null,"sap.ushell.services.AppConfiguration");}}i=["favIcon","homeScreenIconPhone","homeScreenIconPhone@2","homeScreenIconTablet","homeScreenIconTablet@2","startupImage320x460","startupImage640x920","startupImage640x1096","startupImage768x1004","startupImage748x1024","startupImage1536x2008","startupImage1496x2048"];j=(u&&u[u.length-1]==='/')?u.substring(0,u.length-1):u;n=function(u){if(u.match(/^https?:\/\/.*/)){return false;}return u&&u[0]!=='/';};i.forEach(function(F){var O=m[k][F],G=null;if(O){G=n(O)?j+"/"+O:O;}m[k][F]=G;});}catch(D){jQuery.sap.log.warning("Application configuration could not be parsed");}};}sap.ushell.services.AppConfiguration=new A();}());
