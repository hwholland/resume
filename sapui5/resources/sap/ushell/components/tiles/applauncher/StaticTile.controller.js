// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";sap.ui.getCore().loadLibrary("sap.m");jQuery.sap.require("sap.ui.core.IconPool");jQuery.sap.require("sap.ushell.components.tiles.utils");jQuery.sap.require("sap.ushell.components.tiles.utilsRT");sap.ui.controller("sap.ushell.components.tiles.applauncher.StaticTile",{onInit:function(){var s=this.getView(),v=s.getViewData(),t=v.chip,c=sap.ushell.components.tiles.utilsRT.getConfiguration(t,t.configurationUi.isEnabled(),false),m,k,K,a=this,N=c.navigation_target_url,S;S=t.url.getApplicationSystem();if(S){N+=((N.indexOf("?")<0)?"?":"&")+"sap-system="+S;}this.navigationTargetUrl=N;m=new sap.ui.model.json.JSONModel({config:c,nav:{navigation_target_url:(t.configurationUi&&t.configurationUi.isEnabled()?"":N)},search:{display_highlight_terms:[]}});s.setModel(m);if(t.types){t.types.attachSetType(function(d){if(a.tileType!=d){if(d==='link'){a.getView().removeAllContent();var l=a.getView().getLinkControl();a.getView().addContent(l);}else{a.getView().removeAllContent();var T=a.getView().getTileControl();a.getView().addContent(T);}a.tileType=d;}});}if(!this.tileType){var T=this.getView().getTileControl();this.getView().addContent(T);this.tileType="tile";}if(t.search){k=s.getModel().getProperty("/config/display_search_keywords");K=jQuery.grep(k.split(/[, ]+/),function(n,i){return n&&n!=="";});if(c.display_title_text&&c.display_title_text!==""&&K.indexOf(c.display_title_text)===-1){K.push(c.display_title_text);}if(c.display_subtitle_text&&c.display_subtitle_text!==""&&K.indexOf(c.display_subtitle_text)===-1){K.push(c.display_subtitle_text);}if(c.display_info_text&&c.display_info_text!==""&&K.indexOf(c.display_info_text)===-1){K.push(c.display_info_text);}t.search.setKeywords(K);t.search.attachHighlight(function(h){s.getModel().setProperty("/search/display_highlight_terms",h);});}if(t.bag&&t.bag.attachBagsUpdated){t.bag.attachBagsUpdated(function(u){if(u.indexOf("tileProperties")>-1){sap.ushell.components.tiles.utils._updateTilePropertiesTexts(s,t.bag.getBag('tileProperties'));}});}if(t.configuration&&t.configuration.attachConfigurationUpdated){t.configuration.attachConfigurationUpdated(function(u){if(u.indexOf("tileConfiguration")>-1){sap.ushell.components.tiles.utils._updateTileConfiguration(s,t.configuration.getParameterValueAsString("tileConfiguration"));}});}if(t.preview){t.preview.setTargetUrl(N);t.preview.setPreviewIcon(c.display_icon_url);t.preview.setPreviewTitle(c.display_title_text);}if(t.configurationUi.isEnabled()){t.configurationUi.setUiProvider(function(){var C=sap.ushell.components.tiles.utils.getConfigurationUi(s,"sap.ushell.components.tiles.applauncher.Configuration");t.configurationUi.attachCancel(a.onCancelConfiguration.bind(null,C));t.configurationUi.attachSave(a.onSaveConfiguration.bind(null,C));return C;});this.getView().getContent()[0].setTooltip(sap.ushell.components.tiles.utils.getResourceBundleModel().getResourceBundle().getText("edit_configuration.tooltip"));}if(t.actions){var A=c.actions,e;if(A){e=A.slice();}else{e=[];}var b=sap.ushell.components.tiles.utilsRT.getTileSettingsAction(m,this.onSaveRuntimeSettings.bind(this));e.push(b);t.actions.setActionsProvider(function(){return e;});}},onPress:function(e){var s=this.getView(),v=s.getViewData(),t=v.chip;if(t.configurationUi.isEnabled()){t.configurationUi.display();}else if(this.navigationTargetUrl){if(this.navigationTargetUrl[0]==='#'){hasher.setHash(this.navigationTargetUrl);}else{window.open(this.navigationTargetUrl,'_blank');}}},onSaveRuntimeSettings:function(s){var v=s.getModel(),t=this.getView().getViewData().chip,c=this.getView().getModel().getProperty("/config");c.display_title_text=v.getProperty('/title');c.display_subtitle_text=v.getProperty('/subtitle');c.display_info_text=v.getProperty('/info');c.display_search_keywords=v.getProperty('/keywords');var a=t.bag.getBag('tileProperties');a.setText('display_title_text',c.display_title_text);a.setText('display_subtitle_text',c.display_subtitle_text);a.setText('display_info_text',c.display_info_text);a.setText('display_search_keywords',c.display_search_keywords);function l(e){jQuery.sap.log.error(e,null,"sap.ushell.components.tiles.applauncher.StaticTile.controller");}a.save(function(){jQuery.sap.log.debug("property bag 'tileProperties' saved successfully");this.getView().getModel().setProperty('/config/display_title_text',c.display_title_text);this.getView().getModel().setProperty('/config/display_subtitle_text',c.display_subtitle_text);this.getView().getModel().setProperty('/config/display_info_text',c.display_info_text);this.getView().getModel().setProperty('/config/display_search_keywords',c.display_search_keywords);this.getView().getModel().refresh();}.bind(this),l);},onSaveConfiguration:function(c){var d=jQuery.Deferred();var m=c.getModel();var t=m.getProperty("/tileModel");var T=c.getViewData().chip;var a=sap.ushell.components.tiles.utils.tileActionsRows2TileActionsArray(m.getProperty("/config/tile_actions_rows"));var b={display_icon_url:m.getProperty("/config/display_icon_url"),navigation_use_semantic_object:m.getProperty("/config/navigation_use_semantic_object"),navigation_target_url:m.getProperty("/config/navigation_target_url"),navigation_semantic_object:jQuery.trim(m.getProperty("/config/navigation_semantic_object"))||"",navigation_semantic_action:jQuery.trim(m.getProperty("/config/navigation_semantic_action"))||"",navigation_semantic_parameters:jQuery.trim(m.getProperty("/config/navigation_semantic_parameters")),display_search_keywords:m.getProperty("/config/display_search_keywords")};var r=sap.ushell.components.tiles.utils.checkInputOnSaveConfig(c);if(!r){r=sap.ushell.components.tiles.utils.checkTileActions(c);}if(r){d.reject("mandatory_fields_missing");return d.promise();}if(b.navigation_use_semantic_object){b.navigation_target_url=sap.ushell.components.tiles.utilsRT.getSemanticNavigationUrl(b);m.setProperty("/config/navigation_target_url",b.navigation_target_url);}var e=T.bag.getBag('tileProperties');e.setText('display_title_text',m.getProperty("/config/display_title_text"));e.setText('display_subtitle_text',m.getProperty("/config/display_subtitle_text"));e.setText('display_info_text',m.getProperty("/config/display_info_text"));e.setText('display_search_keywords',b.display_search_keywords);var f=T.bag.getBag('tileNavigationActions');sap.ushell.components.tiles.utils.populateTileNavigationActionsBag(f,a);function l(E,o){jQuery.sap.log.error(E,null,"sap.ushell.components.tiles.applauncher.StaticTile.controller");d.reject(E,o);}T.writeConfiguration.setParameterValues({tileConfiguration:JSON.stringify(b)},function(){var C=sap.ushell.components.tiles.utilsRT.getConfiguration(T,false,false),o=sap.ushell.components.tiles.utilsRT.getConfiguration(T,true,false),m=new sap.ui.model.json.JSONModel({config:C,nav:{navigation_target_url:""},tileModel:t});c.setModel(m);t.setData({config:o,nav:{navigation_target_url:""}},false);if(T.preview){T.preview.setTargetUrl(C.navigation_target_url);T.preview.setPreviewIcon(C.display_icon_url);T.preview.setPreviewTitle(C.display_title_text);}e.save(function(){jQuery.sap.log.debug("property bag 'tileProperties' saved successfully");if(T.title){T.title.setTitle(C.display_title_text,function(){d.resolve();},l);}else{d.resolve();}},l);f.save(function(){jQuery.sap.log.debug("property bag 'navigationProperties' saved successfully");},l);},l);return d.promise();},onCancelConfiguration:function(c){var v=c.getViewData(),m=c.getModel(),t=m.getProperty("/tileModel"),T=v.chip,C=sap.ushell.components.tiles.utilsRT.getConfiguration(T,T.configurationUi.isEnabled(),false);c.getModel().setData({config:C,nav:{navigation_target_url:""},tileModel:t},false);}});}());
