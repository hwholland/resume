// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.components.factsheet.annotation.Mapping");sap.ushell.components.factsheet.annotation.Mapping={};sap.ushell.components.factsheet.annotation.Mapping.initialized=[];sap.ushell.components.factsheet.annotation.Mapping.parse=function(m,a){var x={},g,b,s,c,d,r,e,f,h,n,o,A,q={},t,u,S={},i,v,w={},y={},z="",B,C,D,E,F,G,H,T,I,J,K,M,L,j,N,O,P,Q,R,U,V,W,X,Y,Z,$,_,a1,b1,c1,d1,e1,f1;if(sap.ui.Device.browser.internet_explorer){x={setNameSpace:function(k){k.setProperty("SelectionNamespaces",'xmlns:edmx="http://docs.oasis-open.org/odata/ns/edmx" xmlns:d="http://docs.oasis-open.org/odata/ns/edm"');k.setProperty("SelectionLanguage","XPath");return k;},selectNodes:function(k,x,l){return l.selectNodes(x);},nextNode:function(k){return k.nextNode();},getNodeText:function(k){return k.text;}};}else{x={setNameSpace:function(k){return k;},nsResolver:function(p){var k={"edmx":"http://docs.oasis-open.org/odata/ns/edmx","d":"http://docs.oasis-open.org/odata/ns/edm"};return k[p]||null;},selectNodes:function(k,p,l){var g1=k.evaluate(p,l,this.nsResolver,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);g1.length=g1.snapshotLength;return g1;},nextNode:function(k,l){return k.snapshotItem(l);},getNodeText:function(k){return k.textContent;}};}g=function(k){var l;if(sap.ui.Device.browser.internet_explorer){l=new ActiveXObject("Microsoft.XMLHTTP");l.open("GET",k,false);l.send(null);return l.responseXML;}else{l=jQuery.sap.sjax({url:k,dataType:"xml"});if(l.success){return l.data;}}};b=function(m){var g1={},h1={},i1={},j1=false,i,k1,l1,m1,n1={},j,o1={},p1={},q1=false,r1,l,k,s1,t1,u1,v1,p,w1;for(i=m.dataServices.schema.length-1;i>=0;i-=1){g1=m.dataServices.schema[i];if(g1.entityType){k1=g1.namespace;l1=g1.entityType;m1=g1.complexType;for(j in l1){if(l1.hasOwnProperty(j)){n1=l1[j];p1={};if(n1.hasStream&&n1.hasStream==="true"){continue;}o1={};for(k in n1.property){r1=n1.property[k];if(r1.type.substring(0,k1.length)===k1){for(l in m1){if(m1[l].name===r1.type.substring(k1.length+1)){for(k in m1[l].property){s1=m1[l].property[k];o1[m1[l].name+"/"+s1.name]=s1.type;}}}}else{t1=r1.name;u1=r1.type;for(p in r1.extensions){v1=r1.extensions[p];if((v1.name==="display-format")&&(v1.value==="Date")){u1="Edm.Date";}else{q1=true;if(!p1[t1]){p1[t1]={};}if(v1.namespace&&!p1[t1][v1.namespace]){p1[t1][v1.namespace]={};}p1[t1][v1.namespace][v1.name]=v1.value;}}o1[t1]=u1;}}if(!h1[k1+"."+n1.name]){h1[k1+"."+n1.name]={};}h1[k1+"."+n1.name]=o1;if(q1){if(!i1[k1+"."+n1.name]){j1=true;}i1[k1+"."+n1.name]={};i1[k1+"."+n1.name]=p1;}}}}}if(j1){w1={types:h1,extensions:i1};}else{w1={types:h1};}return w1;};s=function(p,k,l,S){var g1,h1,i1='';for(g1 in p){if(p.hasOwnProperty(g1)){if(p[g1]){h1=p[g1];if(h1.Value&&h1.Value.Path){i1=c(h1.Value.Path,k,l,S);if(i1){p[g1].EdmType=i1;}continue;}if(h1.Path){i1=c(h1.Path,k,l,S);if(i1){p[g1].EdmType=i1;}continue;}if(h1.Facets){p[g1].Facets=s(h1.Facets,k,l,S);continue;}if(h1.Data){p[g1].Data=s(h1.Data,k,l,S);continue;}if(g1==="Data"){p.Data=s(h1,k,l,S);continue;}if(h1.Value&&h1.Value.Apply){p[g1].Value.Apply.Parameters=s(h1.Value.Apply.Parameters,k,l,S);continue;}if(h1.Value&&h1.Type&&(h1.Type==="Path")){i1=c(h1.Value,k,l,S);if(i1){p[g1].EdmType=i1;}}}}}return p;};c=function(p,k,l,S){var g1;if((p.charAt(0)==="@")&&(p.indexOf(S.Alias)===1)){p=p.slice(S.Alias.length+2);}if(p.indexOf("/")>=0){if(k[p.slice(0,p.indexOf("/"))]){l=p.slice(0,p.indexOf("/"));p=p.slice(p.indexOf("/")+1);}}for(g1 in k[l]){if(k[l].hasOwnProperty(g1)){if(p===g1){return k[l][g1];}}}};d=function(k){var l="",p="",i,g1={};for(i=0;i<k.attributes.length;i+=1){if((k.attributes[i].name!=="Property")&&(k.attributes[i].name!=="Term")){l=k.attributes[i].name;p=k.attributes[i].value;}}if(l.length>0){g1[l]=r(p);}return g1;};e=function(t,k){var l={},p,g1,h1,i1,j1,k1;if(k.hasChildNodes()){p=x.selectNodes(t,"./d:String",k);if(p.length>0){g1=x.nextNode(p,0);l["String"]=x.getNodeText(g1);}else{h1=x.selectNodes(t,"./d:Path",k);if(h1.length>0){i1=x.nextNode(h1,0);l["Path"]=x.getNodeText(i1);}else{j1=x.selectNodes(t,"./d:Apply",k);if(j1.length>0){k1=x.nextNode(j1,0);l["Apply"]=n(t,k1);}}}}return l;};f=function(t,k,l){var p={},g1,h1,I,i1,j1,k1,l1,m1,n1={},L,N,W,o1,p1;if(k.hasChildNodes()){g1=x.selectNodes(t,"./d:Record | ./d:Collection/d:Record | ./d:Collection/d:If/d:Record",k);if(g1.length){h1=0;for(I=0;I<g1.length;I+=1){i1=x.nextNode(g1,I);j1=h(t,i1,l);if(i1.getAttribute("Type")){j1["RecordType"]=r(i1.getAttribute("Type"));}if(h1===0){if(i1.nextElementSibling||(i1.parentNode.nodeName==="Collection")||(i1.parentNode.nodeName==="If")){p=[];p.push(j1);}else{p=j1;}}else{p.push(j1);}h1+=1;}}else{k1=x.selectNodes(t,"./d:UrlRef",k);if(k1.length>0){for(I=0;I<k1.length;I+=1){l1=x.nextNode(k1,I);p["UrlRef"]=e(t,l1);}}else{k1=x.selectNodes(t,"./d:Url",k);if(k1.length>0){for(I=0;I<k1.length;I+=1){l1=x.nextNode(k1,I);p["Url"]=e(t,l1);}}else{p1=x.selectNodes(t,"./d:Collection/d:AnnotationPath | ./d:Collection/d:PropertyPath",k);if(p1.length>0){p=[];for(I=0;I<p1.length;I+=1){m1=x.nextNode(p1,I);n1={};n1[m1.nodeName]=x.getNodeText(m1);p.push(n1);}}else{p=d(k);L=x.selectNodes(t,"./d:Annotation",k);N={};for(W=0;W<L.length;W+=1){N=x.nextNode(L,W);if(N.hasChildNodes()===false){o1=r(N.getAttribute("Term"));p[o1]=d(N);}}}}}}}else{p=d(k);}return p;};h=function(t,k,l){var p={},N={},L,W,g1,h1,I,i1,j1,k1,l1,m1;L=x.selectNodes(t,"./d:Annotation",k);for(W=0;W<L.length;W+=1){N=x.nextNode(L,W);if(N.hasChildNodes()===false){g1=r(N.getAttribute("Term"));p[g1]=d(N);}}h1=x.selectNodes(t,"./d:PropertyValue",k);if(h1.length>0){for(I=0;I<h1.length;I+=1){i1=x.nextNode(h1,I);j1=i1.getAttribute("Property");p[j1]=f(t,i1,l);k1=x.selectNodes(t,"./d:Apply",i1);l1=null;for(m1=0;m1<k1.length;m1+=1){l1=x.nextNode(k1,m1);if(l1){p[j1]={};p[j1]['Apply']=n(t,l1);}}}}else{p=f(t,k,l);}return p;};n=function(t,k){var l={},p,g1=null,h1=[],i;p=x.selectNodes(t,"./d:*",k);for(i=0;i<p.length;i+=1){g1=x.nextNode(p,i);switch(g1.nodeName){case"Apply":h1.push({"Type":"Apply","Value":n(t,g1)});break;case"LabeledElement":h1.push({"Name":g1.getAttribute("Name"),"Value":e(t,g1)});break;default:h1.push({"Type":g1.nodeName,"Value":x.getNodeText(g1)});break;}}l['Name']=k.getAttribute('Function');l['Parameters']=h1;return l;};o=function(l,p,g1){var h1,i,i1,j1,j,k;for(i=m.dataServices.schema.length-1;i>=0;i-=1){h1=m.dataServices.schema[i];if(h1.entityType){i1=h1.namespace+".";j1=h1.entityType;for(k=j1.length-1;k>=0;k-=1){if(i1+j1[k].name===l&&j1[k].navigationProperty){for(j=0;j<j1[k].navigationProperty.length;j+=1){if(j1[k].navigationProperty[j].name===p){return true;}}}}}}return false;};r=function(k){for(A in w){if(w.hasOwnProperty(A)){if(k.indexOf(A+".")>=0){k=k.replace(A+".",w[A]+".");return k;}}}return k;};if(this.initialized[a]){return this.initialized[a];}t=g(a);t=x.setNameSpace(t);u=x.selectNodes(t,"//d:Schema",t);for(i=0;i<u.length;i+=1){v=x.nextNode(u,i);S.Alias=v.getAttribute("Alias");S.Namespace=v.getAttribute("Namespace");}B=x.selectNodes(t,"//edmx:Reference",t);for(i=0;i<B.length;i+=1){C=x.nextNode(B,i);D=x.selectNodes(t,"./edmx:Include",C);if(D&&D.length>0){E=x.nextNode(D,0);if(E.getAttribute("Alias")){w[E.getAttribute("Alias")]=E.getAttribute("Namespace");}else{w[E.getAttribute("Namespace")]=E.getAttribute("Namespace");}}F=x.selectNodes(t,"./edmx:IncludeAnnotations",C);if(F.length>0){for(j=0;j<F.length;j+=1){G=x.nextNode(F,j);if(G.getAttribute("TargetNamespace")){z=G.getAttribute("TargetNamespace");if(!y[z]){y[z]={};}y[z][G.getAttribute("TermNamespace")]=C.getAttribute("Uri");}else{y[G.getAttribute("TermNamespace")]=C.getAttribute("Uri");}}}}if(y){q.annotationReferences=y;}q.aliasDefinitions=w;H=x.selectNodes(t,"//d:Term",t);if(H.length>0){T={};for(I=0;I<H.length;I+=1){J=x.nextNode(H,I);K=r(J.getAttribute("Type"));T["@"+S.Alias+"."+J.getAttribute("Name")]=K;}q.termDefinitions=T;}M=b(m);if(M.extensions){q.propertyExtensions=M.extensions;}L=x.selectNodes(t,"//d:Annotations ",t);for(I=0;I<L.length;I+=1){N=x.nextNode(L,I);if(N.hasChildNodes()===false){continue;}O=N.getAttribute("Target");P=O.split(".")[0];if(P&&w[P]){O=O.replace(new RegExp(P,""),w[P]);}Q=O;R=null;if(O.indexOf("/")>0){Q=O.split("/")[0];R=O.replace(Q+"/","");}if(!q[Q]){q[Q]={};}if(R){if(!q.propertyAnnotations){q.propertyAnnotations={};}if(!q.propertyAnnotations[Q]){q.propertyAnnotations[Q]={};}q.propertyAnnotations[Q][R]={};U=x.selectNodes(t,"./d:Annotation",N);for(W=0;W<U.length;W+=1){V=x.nextNode(U,W);if(V.hasChildNodes()===false){X=r(V.getAttribute("Term"));q.propertyAnnotations[Q][R][X]=d(V);}}}else{Z=Q.replace(w[P],P);U=x.selectNodes(t,"./d:Annotation",N);for(Y=0;Y<U.length;Y+=1){V=x.nextNode(U,Y);$=V.getAttribute("Qualifier");_=r(V.getAttribute("Term"));if($){_+="#"+$;}a1=f(t,V,Z);a1=s(a1,M.types,Q,S);q[Q][_]=a1;}b1=x.selectNodes(t,"//d:Annotations[contains(@Target, '"+Z+"')]//d:PropertyValue[contains(@Path, '/')]//@Path",t);for(i=0;i<b1.length;i+=1){c1=x.nextNode(b1,i);d1=c1.value;if(q.propertyAnnotations){if(q.propertyAnnotations[Q]){if(q.propertyAnnotations[Q][d1]){continue;}}}e1=d1.split('/');if(o(Q,e1[0],m)){if(!q.expand){q.expand={};}if(!q.expand[Q]){q.expand[Q]={};}q.expand[Q][e1[0]]=e1[0];}}f1=x.selectNodes(t,"//d:Annotations[contains(@Target, '"+Z+"')]//d:Path[contains(., '/')]",t);for(i=0;i<f1.length;i+=1){c1=x.nextNode(f1,i);d1=x.getNodeText(c1);if(q.propertyAnnotations[Q]){if(q.propertyAnnotations[Q][d1]){continue;}}if(!q.expand){q.expand={};}if(!q.expand[Q]){q.expand[Q]={};}e1=d1.split('/');if(o(Q,e1[0],m)){if(!q.expand){q.expand={};}if(!q.expand[Q]){q.expand[Q]={};}q.expand[Q][e1[0]]=e1[0];}}}this.initialized[a]=q;}return q;};}());
