// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";sap.ui.controller("sap.ushell.components.flp.launchpad.appfinder.Catalog",{oPopoverView:undefined,onInit:function(){var t=this;sap.ui.getCore().byId("catalogSelect").addEventDelegate({onBeforeRendering:this.onBeforeSelectRendering},this);var r=this.getView().parentComponent.getRouter();r.getRoute("catalog").attachPatternMatched(function(e){t.onShow(e);});r.getRoute("appFinder").attachPatternMatched(function(e){t.onShow(e);});this.timeoutId=0;},onBeforeRendering:function(){sap.ui.getCore().getEventBus().publish("renderCatalog");setTimeout(function(){jQuery('#catalogSelect').focus();},0);},onAfterRendering:function(){var m=this.getView().getModel(),c=m.getProperty('/catalogs'),t=this;if(!c.length){m.setProperty('/catalogs',[{title:sap.ushell.resources.i18n.getText('catalogsLoading'),"static":true,tiles:[],numIntentSupportedTiles:-1}]);m.setProperty('/catalogsNoDataText',sap.ushell.resources.i18n.getText('loadingTiles'));}else if(c[0].title!=sap.ushell.resources.i18n.getText('catalogsLoading')){m.setProperty('/catalogsNoDataText',sap.ushell.resources.i18n.getText('noFilteredItems'));}if(!this.PagingManager){this.lastCatalogId=0;jQuery.sap.require("sap.ushell.components.flp.launchpad.PagingManager");this.PagingManager=new sap.ushell.components.flp.launchpad.PagingManager('catalogPaging',{supportedElements:{tile:{className:'sapUshellTile'}},containerHeight:window.innerHeight,containerWidth:window.innerWidth});}if(this.PagingManager.currentPageIndex===0){t.allocateNextPage();}jQuery("#catalogTilesPage-cont").scroll(function(){var p=sap.ui.getCore().byId('catalogTilesPage'),s=p.getScrollDelegate(),a=s.getScrollTop(),b=s.getMaxScrollTop();if(b-a<=30+t.PagingManager.getTileHeight()){t.allocateNextPage();}});jQuery(window).resize(function(){var w=$(window).width(),a=$(window).height();t.PagingManager.setContainerSize(w,a);t.resetPageFilter();t.applyTileFilters();});},onShow:function(E){var v,h,m=this.getView().getModel(),c=m.getProperty("/catalogTiles")||[],d=E.getParameter('arguments').filters,D=d?JSON.parse(d):d,i;v=sap.ui.getCore().byId("viewPortContainer");if(v){v.shiftCenterTransition(false);}$.extend(this.getView().getViewData(),E);if(this.PagingManager){this.resetPageFilter();}this.categoryFilter=(D&&D.catalogSelector&&D.catalogSelector)||null;if(this.categoryFilter){this.categoryFilter=window.decodeURIComponent(this.categoryFilter);}this.searchFilter=(D&&D.tileFilter&&D.tileFilter)||null;if(this.searchFilter){this.searchFilter=window.decodeURIComponent(this.searchFilter);}h=(D&&D.tagFilter&&D.tagFilter)||"";if(h){try{this.tagFilter=JSON.parse(h);}catch(e){this.tagFilter=[];}}else{this.tagFilter=[];}if(this.tagFilter){m.setProperty("/selectedTags",this.tagFilter);}m.setProperty("/showCatalogHeaders",true);m.setProperty("/catalogSearchFilter",this.searchFilter);for(i=0;i<c.length;i=i+1){c[i].active=false;}if(this.categoryFilter||this.searchFilter){sap.ui.getCore().byId("catalogSelect").rerender();}else{if(sap.ui.getCore().byId("catalogSelect")){sap.ui.getCore().byId("catalogSelect").setSelectedItemId("");}}this.oRenderingFilter=new sap.ui.model.Filter('','EQ','a');this.oRenderingFilter.fnTest=function(a){if(a.catalogIndex<=this.lastCatalogId){return true;}if(this.allocateTiles>0){this.lastCatalogId=a.catalogIndex;this.allocateTiles--;return true;}return false;}.bind(this);if(this.PagingManager){this.applyTileFilters();}},resetPageFilter:function(){this.lastCatalogId=0;this.allocateTiles=this.PagingManager.getNumberOfAllocatedElements();},allocateNextPage:function(){if(!this.allocateTiles||this.allocateTiles===0){this.PagingManager.moveToNextPage();this.allocateTiles=this.PagingManager._calcElementsPerPage();this.applyTileFilters();}},onBeforeSelectRendering:function(){var s=sap.ui.getCore().byId("catalogSelect"),i=jQuery.grep(s.getItems(),jQuery.proxy(function(I){return I.getBindingContext().getObject().title===this.categoryFilter;},this));if(!i.length){i.push(s.getItemAt(0));}if(i[0]&&s.getSelectedItemId()!==i[0].getId()){window.setTimeout($.proxy(s.setSelectedItem,s,i[0].getId()),500);}},setTagsFilter:function(f){var p={catalogSelector:this.categoryFilter,tileFilter:this.searchFilter?encodeURIComponent(this.searchFilter):"",tagFilter:f,targetGroup:encodeURIComponent(this.getGroupContext())};this.getView().parentComponent.getRouter().navTo('appFinder',{'menu':'catalog',filters:JSON.stringify(p)},true);},setCategoryFilter:function(f){var p={catalogSelector:f,tileFilter:this.searchFilter?encodeURIComponent(this.searchFilter):"",tagFilter:JSON.stringify(this.tagFilter),targetGroup:encodeURIComponent(this.getGroupContext())};this.getView().parentComponent.getRouter().navTo('appFinder',{'menu':'catalog',filters:JSON.stringify(p)},true);},setSearchFilter:function(f){var p={catalogSelector:this.categoryFilter,tileFilter:f?encodeURIComponent(f):"",tagFilter:JSON.stringify(this.tagFilter),targetGroup:encodeURIComponent(this.getGroupContext())};this.getView().parentComponent.getRouter().navTo('appFinder',{'menu':'catalog','filters':JSON.stringify(p)});},getGroupContext:function(){var m=this.getView().getModel(),g=m.getProperty("/groupContext/path");return g?g:"";},applyTileFilters:function(){var f=[],o,s,c,C;if(this.tagFilter){o=new sap.ui.model.Filter('tags','EQ','v');o.fnTest=function(t){var i,a;if(this.tagFilter.length===0){return true;}for(i=0;i<this.tagFilter.length;i++){a=this.tagFilter[i];if(t.indexOf(a)===-1){return false;}}return true;}.bind(this);f.push(o);}this.searchFilter=this.searchFilter?this.searchFilter.replace(/\*/g,''):this.searchFilter;if(this.searchFilter){s=new sap.ui.model.Filter($.map(this.searchFilter.split(/[\s,]+/),function(v){return(v&&new sap.ui.model.Filter("keywords",sap.ui.model.FilterOperator.Contains,v))||(v&&new sap.ui.model.Filter("title",sap.ui.model.FilterOperator.Contains,v))||undefined;}),true);f.push(s);}if(this.categoryFilter){C=this.categoryFilter;c=new sap.ui.model.Filter("catalog",sap.ui.model.FilterOperator.EQ,C);f.push(c);}f.push(new sap.ui.model.Filter("isTileIntentSupported",sap.ui.model.FilterOperator.EQ,true));if(this.oRenderingFilter){f.push(this.oRenderingFilter);}sap.ui.getCore().byId("catalogTiles").getBinding("tiles").filter(f);},onLiveFilter:function(e){clearTimeout(this.timeoutId);var t=this,q=e.getParameter("newValue"),n=300;this.timeoutId=setTimeout(r,n,q);function r(q){if(q){t.setSearchFilter(q);}else{t.setSearchFilter();}}},onTagsFilter:function(e){var s=e.getParameters("selectedItem").changedItem,a=e.getParameter("selected"),b=[],c=s.getText();if(this.tagFilter){b=this.tagFilter;}if(a){b.push(c);}else{b=b.filter(function(d){return d!==c;});}this.setTagsFilter(b.length>0?JSON.stringify(b):"");},onCategoryFilter:function(e){var s=e.getParameter("selectedItem"),S=s.getBindingContext(),m=S.getModel();if(m.getProperty("static",S)){m.setProperty("/showCatalogHeaders",true);this.setCategoryFilter();this.selectedCategory=undefined;}else{m.setProperty("/showCatalogHeaders",false);this.setCategoryFilter(window.encodeURIComponent(s.getBindingContext().getObject().title));this.selectedCategory=s.getId();}},onTileAfterRendering:function(e){var f=e.getSource().getFootItems()[0];if(f!==undefined){f.addStyleClass("sapUshellCatalogPlusIcon");}},catalogTilePress:function(c){sap.ui.getCore().getEventBus().publish("launchpad","catalogTileClick");},onTileFooterClick:function(e){var c=e.getSource(),s=c.getBindingContext(),m=this.getView().getModel(),g=m.getProperty("/groupContext/path");if(g){this._handleTileFooterClickInGroupContext(s,g);}else{if((this.oPopoverView)&&(this.oPopoverView.getVisible()===true)){this.oPopoverView.setVisible(false);}var a=m.getProperty("/groups"),l=sap.ushell.Container.getService("LaunchPage"),b=this.getCatalogTileDataFromModel(s),t=b.tileData.associatedGroups,G=a.map(function(d){var r=l.getGroupId(d.object),f=!($.inArray(r,t)==-1);return{selected:f,initiallySelected:f,oGroup:d};});if(this.oPopoverView===undefined){this.oPopoverView=sap.ui.getCore().byId("groupListPopoverView");if(this.oPopoverView===undefined){this.oPopoverView=new sap.ui.view({id:"groupListPopoverView",type:sap.ui.core.mvc.ViewType.JS,viewName:"sap.ushell.components.flp.launchpad.appfinder.GroupListPopover",viewData:{enableHideGroups:m.getProperty("/enableHideGroups"),enableHelp:m.getProperty("/enableHelp")}});this.oPopoverView.setVisible(false);}}if(this.oPopoverView.getVisible()===false){this.oPopoverView.setGroupListSingleSelection(sap.m.ListMode.MultiSelect);this.oPopoverView.setGroupsData(G);this.oPopoverView.setVisible(true);this.oPopoverView.open(c).then(this._handlePopoverResponse.bind(this,s,b));}}},_handlePopoverResponse:function(s,c,r){var m=this.getView().getModel(),g=m.getProperty("/groups");var p=[];r.addToGroups.forEach(function(a){var i=g.indexOf(a);var G=new sap.ui.model.Context(m,"/groups/"+i);var b=this._addTile(s,G);p.push(b);}.bind(this));r.removeFromGroups.forEach(function(a){var t=s.getModel().getProperty(s.getPath()).id;var i=g.indexOf(a);var b=this._removeTile(t,i);p.push(b);}.bind(this));r.newGroups.forEach(function(a){var n=(a.length>0)?a:sap.ushell.resources.i18n.getText("new_group_name");var b=this._createGroupAndSaveTile(s,n);p.push(b);}.bind(this));jQuery.when.apply(jQuery,p).then(function(){var a=Array.prototype.slice.call(arguments);this._handlePopoverGroupsActionPromises(c,r,a);}.bind(this));},_handlePopoverGroupsActionPromises:function(c,p,r){var e=r.filter(function(g,i,r){return!g.status;});if(e.length){var E=this.prepareErrorMessage(e,c.tileData.title);var d=sap.ushell.components.flp.launchpad.DashboardManager();d.resetGroupsOnFailure(E.messageId,E.parameters);return;}var t=[];var l=sap.ushell.Container.getService("LaunchPage");p.allGroups.forEach(function(g){if(g.selected){var h=l.getGroupId(g.oGroup.object);t.push(h);}});var m=this.getView().getModel();if(p.newGroups.length){var a=m.getProperty("/groups");var n=a.slice(a.length-p.newGroups.length);n.forEach(function(g){var h=l.getGroupId(g.object);t.push(h);});}m.setProperty("/catalogTiles/"+c.tileIndex+"/associatedGroups",t);var f=(!!p.addToGroups[0])?p.addToGroups[0].title:"";if(!f.length&&p.newGroups.length){f=p.newGroups[0];}var b=(!!p.removeFromGroups[0])?p.removeFromGroups[0].title:"";var D=this.prepareDetailedMessage(c.tileData.title,p.addToGroups.length+p.newGroups.length,p.removeFromGroups.length,f,b);sap.m.MessageToast.show(D,{duration:3000,width:"15em",my:"center bottom",at:"center bottom",of:window,offset:"0 -50",collision:"fit fit"});},_getCatalogTileIndexInModel:function(s){var t=s.sPath,a=t.split("/"),b=a[a.length-1];return b;},_handleTileFooterClickInGroupContext:function(s,g){var l=sap.ushell.Container.getService("LaunchPage"),m=this.getView().getModel(),c=this.getCatalogTileDataFromModel(s),a=c.tileData.associatedGroups,G=m.getProperty(g),b=l.getGroupId(G.object),C=$.inArray(b,a),t=this._getCatalogTileIndexInModel(s),o,A,r,T,d,e=this;if(c.isBeingProcessed){return;}m.setProperty('/catalogTiles/'+t+'/isBeingProcessed',true);if(C==-1){o=new sap.ui.model.Context(s.getModel(),g);A=this._addTile(s,o);A.done(function(f){if(f.status==1){e._groupContextOperationSucceeded(s,c,G,true);}else{e._groupContextOperationFailed(c,G,true);}});A.always(function(){m.setProperty('/catalogTiles/'+t+'/isBeingProcessed',false);});}else{T=s.getModel().getProperty(s.getPath()).id;d=g.split('/')[2];r=this._removeTile(T,d);r.done(function(f){if(f.status==1){e._groupContextOperationSucceeded(s,c,G,false);}else{e._groupContextOperationFailed(c,G,false);}});r.always(function(){m.setProperty('/catalogTiles/'+t+'/isBeingProcessed',false);});}},_groupContextOperationSucceeded:function(s,c,g,t){var l=sap.ushell.Container.getService("LaunchPage"),G=l.getGroupId(g.object),a=c.tileData.associatedGroups,d,i;if(t){a.push(G);s.getModel().setProperty("/catalogTiles/"+c.tileIndex+"/associatedGroups",a);d=this.prepareDetailedMessage(c.tileData.title,1,0,g.title,"");}else{for(i in a){if(a[i]==G){a.splice(i,1);break;}}s.getModel().setProperty("/catalogTiles/"+c.tileIndex+"/associatedGroups",a);d=this.prepareDetailedMessage(c.tileData.title,0,1,"",g.title);}sap.m.MessageToast.show(d,{duration:3000,width:"15em",my:"center bottom",at:"center bottom",of:window,offset:"0 -50",collision:"fit fit"});},_groupContextOperationFailed:function(c,g,t){var d=sap.ushell.components.flp.launchpad.getDashboardManager(),e;if(t){e=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_add_to_group",parameters:[c.tileData.title,g.title]});}else{e=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_remove_from_group",parameters:[c.tileData.title,g.title]});}d.resetGroupsOnFailure(e.messageId,e.parameters);},prepareErrorMessage:function(e,t){var g,a,f,F,n=0,N=0,c=false,m;for(var i in e){g=e[i].group;a=e[i].action;if(a=='add'){n++;if(n==1){f=g.title;}}else if(a=='remove'){N++;if(N==1){F=g.title;}}else if(a=='addTileToNewGroup'){n++;if(n==1){f=g.title;}}else{c=true;}}if(c){if(e.length==1){m=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_create_new_group"});}else{m=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_some_actions"});}}else if(e.length==1){if(n){m=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_add_to_group",parameters:[t,f]});}else{m=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_remove_from_group",parameters:[t,F]});}}else{if(N==0){m=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_add_to_several_groups",parameters:[t]});}else if(n==0){m=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_remove_from_several_groups",parameters:[t]});}else{m=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_some_actions"});}}return m;},prepareDetailedMessage:function(t,n,a,f,b){var m;if(n==0){if(a==1){m=sap.ushell.resources.i18n.getText("tileRemovedFromSingleGroup",[t,b]);}else if(a>1){m=sap.ushell.resources.i18n.getText("tileRemovedFromSeveralGroups",[t,a]);}}else if(n==1){if(a==0){m=sap.ushell.resources.i18n.getText("tileAddedToSingleGroup",[t,f]);}else if(a==1){m=sap.ushell.resources.i18n.getText("tileAddedToSingleGroupAndRemovedFromSingleGroup",[t,f,b]);}else if(a>1){m=sap.ushell.resources.i18n.getText("tileAddedToSingleGroupAndRemovedFromSeveralGroups",[t,f,a]);}}else if(n>1){if(a==0){m=sap.ushell.resources.i18n.getText("tileAddedToSeveralGroups",[t,n]);}else if(a==1){m=sap.ushell.resources.i18n.getText("tileAddedToSeveralGroupsAndRemovedFromSingleGroup",[t,n,b]);}else if(a>1){m=sap.ushell.resources.i18n.getText("tileAddedToSeveralGroupsAndRemovedFromSeveralGroups",[t,n,a]);}}return m;},getCatalogTileDataFromModel:function(s){var t=this._getCatalogTileIndexInModel(s),m=s.getModel(),T=m.getProperty("/catalogTiles/"+t);return{tileData:T,tileIndex:t,isBeingProcessed:T.isBeingProcessed?true:false};},_addTile:function(t,g){var d=sap.ushell.components.flp.launchpad.getDashboardManager(),a=jQuery.Deferred(),p=d.createTile({catalogTileContext:t,groupContext:g});p.done(function(b){a.resolve(b);});return a;},_removeTile:function(t,i){var d=sap.ushell.components.flp.launchpad.getDashboardManager(),a=jQuery.Deferred(),p=d.deleteCatalogTileFromGroup({tileId:t,groupIndex:i});p.done(function(b){a.resolve(b);});return a;},_createGroupAndSaveTile:function(t,n){var d=sap.ushell.components.flp.launchpad.getDashboardManager(),a=jQuery.Deferred(),p=d.createGroupAndSaveTile({catalogTileContext:t,newGroupName:n});p.done(function(b){a.resolve(b);});return a;}});}());
