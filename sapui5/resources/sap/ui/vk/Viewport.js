/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","sap/ui/core/ResizeHandler","./Loco","./ViewportHandler","./GraphicsCore","./Messages"],function(q,l,C,R,L,V,G,M){"use strict";var a=C.extend("sap.ui.vk.Viewport",{metadata:{library:"sap.ui.vk",publicMethods:["setGraphicsCore","getGraphicsCore","setScene","setViewStateManager","beginGesture","endGesture","pan","rotate","zoom","tap","queueCommand","getViewInfo","setViewInfo"],properties:{showDebugInfo:"boolean"}}});a.prototype.init=function(){this._messages=new M();if(C.prototype.init){C.prototype.init(this);}this._graphicsCore=null;this._dvl=null;this._dvlRendererId=null;this._canvas=null;this._resizeListenerId=null;this._viewportHandler=new V(this);this._loco=new L();this._loco.addHandler(this._viewportHandler);this._dictionary={encodedProjectionType:{},decodedProjectionType:{perspective:sap.ve.dvl.DVLCAMERAPROJECTION.PERSPECTIVE,orthographic:sap.ve.dvl.DVLCAMERAPROJECTION.ORTHOGRAPHIC},encodedBindingType:{},decodedBindingType:{minimum:sap.ve.dvl.DVLCAMERAFOVBINDING.MIN,maximum:sap.ve.dvl.DVLCAMERAFOVBINDING.MAX,horizontal:sap.ve.dvl.DVLCAMERAFOVBINDING.HORZ,vertical:sap.ve.dvl.DVLCAMERAFOVBINDING.VERT}};this._dictionary.encodedProjectionType[sap.ve.dvl.DVLCAMERAPROJECTION.PERSPECTIVE]="perspective";this._dictionary.encodedProjectionType[sap.ve.dvl.DVLCAMERAPROJECTION.ORTHOGRAPHIC]="orthographic";this._dictionary.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.MIN]="minimum";this._dictionary.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.MAX]="maximum";this._dictionary.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.HORZ]="horizontal";this._dictionary.encodedBindingType[sap.ve.dvl.DVLCAMERAFOVBINDING.VERT]="vertical";};a.prototype.exit=function(){this._loco.removeHandler(this._viewportHandler);this._viewportHandler.destroy();if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this.setViewStateManager(null);this.setScene(null);this.setGraphicsCore(null);this._dictionary=null;if(C.prototype.exit){C.prototype.exit.apply(this);}};a.prototype.setGraphicsCore=function(g){if(g!=this._graphicsCore){if(g&&this._graphicsCore&&this._graphicsCore._getViewportCount()>0){q.sap.log.error(sap.ui.vk.getResourceBundle().getText(this._messages.messages.VIT18.summary),this._messages.messages.VIT18.code,"sap.ui.vk.Viewport");}if(this._graphicsCore){if(this._graphicsCore._unregisterViewport(this)){if(this._graphicsCore._getViewportCount()===0){this._dvl.Core.StopRenderLoop();}}}this._dvlRendererId=null;this._dvl=null;this._graphicsCore=g;if(this._graphicsCore){var s=this._graphicsCore._getViewportCount()===0;this._dvl=this._graphicsCore._getDvl();this._dvlRendererId=this._dvl.Core.GetRendererPtr();if(sap.ui.Device.os.ios){this._dvl.Renderer.SetBackgroundColor(0,0,0,1,1,1,1,1);}else{this._dvl.Renderer.SetBackgroundColor(0.5,0.5,0.5,0,0.5,0.5,0.5,0);}this._setCanvas(this._graphicsCore._getCanvas());this._graphicsCore._registerViewport(this);if(s){this._dvl.Core.StartRenderLoop();}this.setShowDebugInfo(this.getShowDebugInfo());}}return this;};a.prototype.getGraphicsCore=function(){return this._graphicsCore;};a.prototype._setCanvas=function(c){var s=this.getDomRef()&&this._canvas!==c;this._canvas=c;if(s){this.invalidate();}return this;};a.prototype.setScene=function(s){if(this._dvlRendererId){this._dvl.Renderer.AttachScene(s&&s._getDvlSceneId()||null);this._dvlSceneId=s?s._getDvlSceneId():null;}return this;};a.prototype._getStepAndProcedureIndexes=function(b,s){var c=-1,d=-1,e=false;for(var i=0;i<b.length;i++){if(!e){for(var j=0;j<b[i].steps.length;j++){if(b[i].steps[j].id===s){d=j;c=i;e=true;break;}}}else{break;}}return{stepIndex:d,procedureIndex:c};};a.prototype.getViewInfo=function(){if(this._dvlSceneId===null||this._dvlSceneId===undefined){return null;}var c=this._dvl.Scene.GetCurrentCamera(this._dvlSceneId),b=this._dvl.Camera.GetRotation(c),d={yaw:b[0],pitch:b[1],roll:b[2]};var e=this._dvl.Camera.GetOrigin(c),f={x:e[0],y:e[1],z:e[2]};var v={camera:{rotation:d,position:f,projectionType:this._dictionary.encodedProjectionType[this._dvl.Camera.GetProjection(c)],bindingType:this._dictionary.encodedBindingType[this._dvl.Camera.GetFOVBinding(c)]}};if(this._dictionary.encodedProjectionType[this._dvl.Camera.GetProjection(c)]==="perspective"){v.camera.fieldOfView=this._dvl.Camera.GetFOV(c);}else if(this._dictionary.encodedProjectionType[this._dvl.Camera.GetProjection(c)]==="orthographic"){v.camera.zoomFactor=this._dvl.Camera.GetOrthoZoomFactor(c);}var s=this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneId,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_STEP_INFO);if(s.stepId!==sap.ve.dvl.DVLID_INVALID){var g=s.StepId,h=s.StepTime,i=this._dvl.Scene.RetrieveProcedures(this._dvlSceneId),j=this._getStepAndProcedureIndexes(i.procedures,g);v.animation={animationTime:h,stepIndex:j.stepIndex,procedureIndex:j.procedureIndex};}return v;};a.prototype.setViewInfo=function(v){if(v.animation){var b=this._dvl.Scene.RetrieveProcedures(this._dvlSceneId);if(b.procedures.length>0&&v.animation.stepIndex!==-1&&v.animation.procedureIndex!==-1){if(v.animation.procedureIndex>=0&&v.animation.procedureIndex<b.procedures.length){if(v.animation.stepIndex>=0&&v.animation.stepIndex<b.procedures[v.animation.procedureIndex].steps.length){var c=v.animation.animationTime||0,s=b.procedures[v.animation.procedureIndex].steps[v.animation.stepIndex].id;this._dvl.Scene.ActivateStep(this._dvlSceneId,s,false,false,c);this._dvl.Scene.PauseCurrentStep(this._dvlSceneId);}else{q.sap.log.error(sap.ui.vk.getResourceBundle().getText(this._messages.messages.VIT26.summary),this._messages.messages.VIT26.code,"sap.ui.vk.Viewport");}}else{q.sap.log.error(sap.ui.vk.getResourceBundle().getText(this._messages.messages.VIT27.summary),this._messages.messages.VIT27.code,"sap.ui.vk.Viewport");}}else{this.resetView();}}var d=this._dictionary.decodedProjectionType[v.camera.projectionType],e=this._dvl.Scene.CreateCamera(this._dvlSceneId,d,sap.ve.dvl.DVLID_INVALID);this._dvl.Camera.SetOrigin(e,v.camera.position.x,v.camera.position.y,v.camera.position.z);var f=this._dictionary.decodedBindingType[v.camera.bindingType];this._dvl.Camera.SetFOVBinding(e,f);switch(d){case this._dictionary.decodedProjectionType.perspective:this._dvl.Camera.SetFOV(e,v.camera.fieldOfView);break;case this._dictionary.decodedProjectionType.orthographic:this._dvl.Camera.SetOrthoZoomFactor(e,v.camera.zoomFactor);break;default:q.sap.log.error(sap.ui.vk.getResourceBundle().getText(this._messages.messages.VIT19.summary),this._messages.messages.VIT19.code,"sap.ui.vk.Viewport");}this._dvl.Camera.SetRotation(e,v.camera.rotation.yaw,v.camera.rotation.pitch,v.camera.rotation.roll);this._dvl.Scene.ActivateCamera(this._dvlSceneId,e);this._dvl.Scene.DeleteNode(this._dvlSceneId,e);};a.prototype.onBeforeRendering=function(){if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}};a.prototype.onAfterRendering=function(){if(this._canvas){var d=this.getDomRef();d.appendChild(this._canvas);this._resizeListenerId=R.register(this,this._handleResize.bind(this));this._handleResize({size:{width:d.clientWidth,height:d.clientHeight}});}};a.prototype._handleResize=function(e){if(this._dvlRendererId&&this._canvas){var d=window.devicePixelRatio||1;var b=e.size.width*d;var c=e.size.height*d;this._dvl.Renderer.SetDimensions(b,c);this._dvl.Renderer.SetOptionF(sap.ve.dvl.DVLRENDEROPTIONF.DVLRENDEROPTIONF_DPI,96*d);this._canvas.width=b;this._canvas.height=c;this._canvas.style.width=e.size.width+"px";this._canvas.style.height=e.size.height+"px";return true;}};a.prototype.setViewStateManager=function(v){this._viewStateManager=v;return this;};a.prototype.shouldRenderFrame=function(){return this._dvlRendererId&&this._dvl.Renderer.ShouldRenderFrame();};a.prototype.renderFrame=function(){if(this._dvlRendererId){this._dvl.Renderer.RenderFrame(this._dvlRendererId);}return this;};a.prototype.renderFrameEx=function(v,b){if(this._dvlRendererId){this._dvl.Renderer.RenderFrameEx.apply(this,[].concat(v,b),this._dvlRendererId);}return this;};a.prototype.resetView=function(){if(this._dvlRendererId){this._dvl.Renderer.ResetView(this._dvlRendererId);}return this;};a.prototype.canIsolateNode=function(n){if(this._dvlRendererId){return this._dvl.Renderer.CanIsolateNode(n,this._dvlRendererId);}else{return false;}};a.prototype.setIsolatedNode=function(n){if(this._dvlRendererId){this._dvl.Renderer.SetIsolatedNode(n,this._dvlRendererId);}return this;};a.prototype.getIsolatedNode=function(){if(this._dvlRendererId){return this._dvl.Renderer.GetIsolatedNode(this._dvlRendererId);}else{return"i0000000000000000";}};a.prototype.setShowDebugInfo=function(v){this.setProperty("showDebugInfo",v,true);if(this._dvlRendererId){this._dvl.Renderer.SetOption(sap.ve.dvl.DVLRENDEROPTION.DVLRENDEROPTION_SHOW_DEBUG_INFO,v,this._dvlRendererId);}return this;};a.prototype.beginGesture=function(x,y){if(this._dvlRendererId){var b=window.devicePixelRatio||1;this._dvl.Renderer.BeginGesture(x*b,y*b,this._dvlRendererId);}return this;};a.prototype.endGesture=function(){if(this._dvlRendererId){this._dvl.Renderer.EndGesture(this._dvlRendererId);}return this;};a.prototype.pan=function(d,b){if(this._dvlRendererId){var c=window.devicePixelRatio||1;this._dvl.Renderer.Pan(d*c,b*c,this._dvlRendererId);}return this;};a.prototype.rotate=function(d,b){if(this._dvlRendererId){var c=window.devicePixelRatio||1;this._dvl.Renderer.Rotate(d*c,b*c,this._dvlRendererId);}return this;};a.prototype.zoom=function(d){if(this._dvlRendererId){this._dvl.Renderer.Zoom(d,this._dvlRendererId);}return this;};a.prototype.tap=function(x,y,i){if(this._dvlRendererId){var b=window.devicePixelRatio||1;this._dvl.Renderer.Tap(x*b,y*b,i,this._dvlRendererId);}return this;};a.prototype.queueCommand=function(c){if(this._dvlRendererId){this._dvl.Renderer._queueCommand(c,this._dvlRendererId);}return this;};var o={x:-2,y:-2};var r=2;var p=5;[{key:"left",dx:-r,dy:0},{key:"right",dx:+r,dy:0},{key:"up",dx:0,dy:-r},{key:"down",dx:0,dy:+r}].forEach(function(i){a.prototype["onsap"+i.key]=function(e){this.beginGesture(o.x,o.y);this.rotate(i.dx,i.dy);this.endGesture();this.renderFrame();e.preventDefault();e.stopPropagation();};});[{key:"left",dx:-p,dy:0},{key:"right",dx:+p,dy:0},{key:"up",dx:0,dy:-p},{key:"down",dx:0,dy:+p}].forEach(function(i){a.prototype["onsap"+i.key+"modifiers"]=function(e){if(e.shiftKey&&!(e.ctrlKey||e.altKey||e.metaKey)){this.beginGesture(o.x,o.y);this.pan(i.dx,i.dy);this.endGesture();this.renderFrame();e.preventDefault();e.stopPropagation();}};});[{key:"minus",d:0.98},{key:"plus",d:1.02}].forEach(function(i){a.prototype["onsap"+i.key]=function(e){this.beginGesture(this.$().width()/2,this.$().height()/2);this.zoom(i.d);this.endGesture();this.renderFrame();e.preventDefault();e.stopPropagation();};});return a;});
