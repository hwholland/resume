/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/base/EventProvider","./ve/dvl","./Scene","./NodeHierarchy","./ContentResource","./DownloadManager","./ViewStateManager","./DvlException","./Messages"],function(q,l,E,D,S,N,C,a,V,b,M){"use strict";function g(s){return s instanceof File?"local":"remote";}function c(s){return s instanceof File?s.name:s;}var d=function(s){Object.defineProperties(this,{source:{value:s,writable:false,enumerable:true},_refCount:{value:0,writable:true,enumerable:false}});};d.prototype.isInUse=function(){return this._refCount>0;};d.prototype.addRef=function(){++this._refCount;return this;};d.prototype.release=function(){--this._refCount;return this;};var e=function(i,s,r){Object.defineProperties(this,{dvlSceneId:{value:i,writable:false,enumerable:true},sourceDatum:{value:s,writable:false,enumerable:true},root:{value:!!r,writable:false,enumerable:true},_refCount:{value:0,writable:true,enumerable:false}});};e.prototype.isInUse=function(){return this._refCount>0;};e.prototype.addRef=function(){++this._refCount;return this;};e.prototype.release=function(){--this._refCount;return this;};e.prototype.destroy=function(){if(this.sourceDatum){this.sourceDatum.release();}};var f=function(i,j){Object.defineProperties(this,{source:{value:i.getSource()},sourceType:{value:i.getSourceType()},sourceId:{value:i.getSourceId(),writable:true},name:{value:i.getName()},localMatrix:{value:i.getLocalMatrix(),writable:true},children:{value:i.getContentResources().map(function(i){return new f(i);})},dvlSceneDatum:{value:null,writable:true},nodeProxy:{value:null,writable:true},fake:{value:!!j}});i._shadowContentResource=this;};f.prototype.destroy=function(){if(this.dvlSceneDatum){this.dvlSceneDatum.release();}};var h=function(v,s){Object.defineProperties(this,{vkScene:{value:v},shadowContentResource:{value:s}});};var G=E.extend("sap.ui.vk.GraphicsCore",{metadata:{publicMethods:["buildSceneTree","createViewStateManager","destroyScene","destroyViewStateManager","getApi","loadContentResourcesAsync","showDebugInfo"]},constructor:function(r,w){E.apply(this);var s=q.extend({},r,{filePackagePrefixURL:q.sap.getResourcePath("sap/ve")+"/"});this._dvlClientId=q.sap.uid();this._dvl=sap.ve.dvl.createRuntime(s);this._dvl.CreateCoreInstance(this._dvlClientId);sap.ui.vk.dvl.checkResult(this._dvl.Core.Init(this._DVLMajorVersion,this._DVLMinorVersion));var u=sap.ui.getCore();u.attachLocalizationChanged(this._onlocalizationChanged,this);sap.ui.vk.dvl.checkResult(this._dvl.Core.SetLocale(u.getConfiguration().getLanguageTag()));this._canvas=this._createRenderingCanvasAndContext(w);this._dvl.Core.InitRenderer();this._sourceData=[];this._dvlSceneData=[];this._vkSceneData=[];this._viewports=[];this._viewStateManagers=[];this._messages=new M();},_DVLMajorVersion:6,_DVLMinorVersion:0});G.prototype.destroy=function(){sap.ui.getCore().detachLocalizationChanged(this._onlocalizationChanged,this);this._viewports.slice().forEach(function(v){v.setGraphicsCore(null);});this._viewports=null;this._cleanupVkSceneData();this._vkSceneData=null;this._cleanupDvlSceneData();this._dvlSceneData=null;this._cleanupSourceData();this._sourceData=null;this._viewStateManagers.slice().forEach(this.destroyViewStateManager.bind(this));this._viewStateManagers=null;this._webGLContext=null;this._canvas=null;this._dvl.Core.DoneRenderer();this._dvl.Core.Release();this._dvl=null;E.prototype.destroy.apply(this);};G.prototype._createRenderingCanvasAndContext=function(w){var i=document.createElement("canvas");i.id=q.sap.uid();this._webGLContext=this._dvl.Core.CreateWebGLContext(i,w);return i;};G.prototype._getCanvas=function(){return this._canvas;};G.prototype._getWebGLContext=function(){return this._webGLContext;};G.prototype._getDvl=function(){return this._dvl;};G.prototype._getDvlClientId=function(){return this._dvlClientId;};G.prototype._findSourceData=function(p){var i=Object.getOwnPropertyNames(p);return this._sourceData.filter(function(j){return i.every(function(k){return p[k]===j[k];});});};G.prototype._destroySourceDatum=function(s){this._dvl.Core.DeleteFileByUrl(c(s.source),g(s.source));return this;};G.prototype._cleanupSourceData=function(){for(var i=this._sourceData.length-1;i>=0;--i){var s=this._sourceData[i];if(!s.isInUse()){this._sourceData.splice(i,1);this._destroySourceDatum(s);}}return this;};G.prototype._findDvlSceneData=function(p){var i=Object.getOwnPropertyNames(p);return this._dvlSceneData.filter(function(j){return i.every(function(k){return p[k]===j[k];});});};G.prototype._destroyDvlSceneDatum=function(i){this._dvl.Scene.Release(i.dvlSceneId);i.destroy();return this;};G.prototype._cleanupDvlSceneData=function(){for(var i=this._dvlSceneData.length-1;i>=0;--i){var j=this._dvlSceneData[i];if(!j.isInUse()){this._dvlSceneData.splice(i,1);this._destroyDvlSceneDatum(j);}}};G.prototype._findVkSceneData=function(p){var i=Object.getOwnPropertyNames(p);return this._vkSceneData.filter(function(j){return i.every(function(k){return p[k]===j[k];});});};G.prototype._cleanupVkSceneData=function(){for(var i=this._vkSceneData.length-1;i>=0;--i){this.destroyScene(this._vkSceneData[i].vkScene);}};G.prototype._destroyShadowContentResource=function(v,s){if(s.children){s.children.forEach(this._destroyShadowContentResource.bind(this,v));}if(s.nodeProxy){this._dvl.Scene.DeleteNode(v._getDvlSceneId(),s.nodeProxy.getNodeId());v.getDefaultNodeHierarchy().destroyNodeProxy(s.nodeProxy);}s.destroy();};G.prototype.loadContentResourcesAsync=function(i,o,j){var t=this;function k(i){var s=[];i.forEach(function enumerate(r){var u=r.getSource();if(u&&s.indexOf(u)<0&&t._findSourceData({source:u}).length===0){s.push(u);}r.getContentResources().forEach(enumerate);});return s;}var s=k(i);var m=[];if(s.length>0){var n;var p=new a(s).attachItemSucceeded(function(r){var u=r.getParameter("source");var v=u instanceof File;var w=v?u.name:u;var x=r.getParameter("response");if(this._isVDS4File(x)){q.sap.log.error(sap.ui.vk.getResourceBundle().getText(this._messages.messages.VIT20.summary),this._messages.messages.VIT20.code,"sap.ui.vk.GraphicsCore");}this._dvl.Core.CreateFileFromArrayBuffer(x,w,g(u));m.push(new d(u));},this).attachAllItemsCompleted(function(r){if(n){m.forEach(this._destroySourceDatum.bind(this));}else{Array.prototype.push.apply(this._sourceData,m);}if(o){o(n);}},this).attachItemFailed(function(r){n=n||[];n.push({source:r.getParameter("source"),status:r.getParameter("status"),statusText:r.getParameter("statusText")});},this);if(j){p.attachItemProgress(j,this);}p.start();}else if(o){o();}return this;};G.prototype._mergeContentResource=function(i,n,j,k,s){var m=this._dvl.Scene.CreateNode(i,j,s.name,k);s.nodeProxy=n.createNodeProxy(m);if(s.localMatrix){s.nodeProxy.setLocalMatrix(s.localMatrix);}if(s.source){var o=this._findSourceData({source:s.source})[0];var p=this._findDvlSceneData({sourceDatum:o,root:false})[0];if(!p){p=new e(sap.ui.vk.dvl.getPointer(this._dvl.Core.LoadSceneByUrl(c(o.source),null,g(o.source))),o,false);this._dvlSceneData.push(p);o.addRef();}s.dvlSceneDatum=p;p.addRef();this._dvl.Scene.RetrieveSceneInfo(p.dvlSceneId,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_CHILDREN).ChildNodes.forEach(function(r){this._dvl.Scene.CreateNodeCopy(i,r,m,sap.ve.dvl.DVLCREATENODECOPYFLAG.COPY_CHILDREN);}.bind(this));}s.children.forEach(this._mergeContentResource.bind(this,i,n,m,undefined));};G.prototype.buildSceneTree=function(i){if(i.length===0){return null;}var r;var j;var s=i.map(function(n){return new f(n);});if(s.length===1){j=s[0];if(j.source){var k=this._findSourceData({source:j.source})[0];r=new e(sap.ui.vk.dvl.getPointer(this._dvl.Core.LoadSceneByUrl(c(k.source),null,g(k.source))),k,true);k.addRef();}else{r=new e(this._dvl.Core.CreateEmptyScene(),null,true);}}else{var m=new C({sourceType:"vds",sourceId:q.sap.uid()});j=new f(m,true);m.destroy();m=null;Array.prototype.push.apply(j.children,s);s=[j];r=new e(this._dvl.Core.CreateEmptyScene(),null,true);}this._dvlSceneData.push(r);j.dvlSceneDatum=r;r.addRef();var v=new S(this,r.dvlSceneId);this._vkSceneData.push(new h(v,j));j.children.forEach(this._mergeContentResource.bind(this,r.dvlSceneId,v.getDefaultNodeHierarchy(),null,undefined));return v;};G.prototype.updateSceneTree=function(v,j){if(j.length===0){return null;}if(!v){return this.buildSceneTree(j);}var r=this._findVkSceneData({vkScene:v})[0].shadowContentResource;var o=!!r.source;var n=j.length===1&&!!j[0].getSource();if(!(o&&n&&r.source===j[0].getSource()||!o&&!n&&r.fake===j.length>1)){return this.buildSceneTree(j);}var t=this;var k=v._getDvlSceneId();var m=v.getDefaultNodeHierarchy();function u(s,j,p){function w(z,A){if(!z&&!A){return true;}else if(!!z^!!A){return false;}else{return z.source===A.getSource()&&z.sourceType===A.getSourceType()&&z.name===A.getName();}}function x(z,A){A._shadowContentResource=z;z.sourceId=A.getSourceId();z.localMatrix=A.getLocalMatrix();if(z.nodeProxy){z.nodeProxy.setLocalMatrix(z.localMatrix);}}var i=0;var y=q.sap.arrayDiff(s,j,w,true);y.forEach(function(z){for(;i<z.index;++i){u(s[i].children,j[i].getContentResources(),s[i].nodeProxy.getNodeId());x(s[i],j[i]);}if(z.type==="delete"){t._destroyShadowContentResource(v,s[z.index]);s.splice(z.index,1);}else if(z.type==="insert"){var A;if(i<s.length&&s[i].nodeProxy){A=s[i].nodeProxy.getNodeId();}var B=new f(j[z.index]);t._mergeContentResource(k,m,p,A,B);s.splice(z.index,0,B);++i;}});for(;i<s.length;++i){u(s[i].children,j[i].getContentResources(),s[i].nodeProxy&&s[i].nodeProxy.getNodeId());x(s[i],j[i]);}}u(r.fake?r.children:[r],j,0);return v;};G.prototype.destroyScene=function(v){var i;for(i=0;i<this._vkSceneData.length;++i){if(this._vkSceneData[i].vkScene===v){break;}}if(i===this._vkSceneData.length){q.sap.log.warning("Scene with id '"+v.getId()+"' is not created by this GraphicsCore.");return this;}var j=this._vkSceneData.splice(i,1)[0];this._destroyShadowContentResource(v,j.shadowContentResource);v.destroy();return this;};G.prototype._registerViewport=function(v){if(this._viewports.indexOf(v)>=0){return false;}this._viewports.push(v);return true;};G.prototype._unregisterViewport=function(v){var i=this._viewports.indexOf(v);if(i<0){return false;}this._viewports.splice(i,1);return true;};G.prototype._getViewportCount=function(){return this._viewports.length;};G.prototype.createViewStateManager=function(n){var v=new V(n);this._viewStateManagers.push(v);return v;};G.prototype.destroyViewStateManager=function(v){var i=this._viewStateManagers.indexOf(v);if(i>=0){this._viewStateManagers.splice(i,1)[0].destroy();}return this;};G.prototype.showDebugInfo=function(i){this._viewports.forEach(function(v){v.setShowDebugInfo(i);});return this;};G.prototype.getApi=function(i){switch(i){case sap.ui.vk.GraphicsCoreApi.LegacyDvl:return this._dvl;default:return null;}};G.prototype.collectGarbage=function(){this._cleanupDvlSceneData();this._cleanupSourceData();return this;};G.prototype._onlocalizationChanged=function(i){if(i.getParameter("changes").language){sap.ui.vk.dvl.checkResult(this._dvl.Core.SetLocale(sap.ui.getCore().getConfiguration().getLanguageTag()));}};G.prototype._isVDS4File=function(i){var j=new Uint8Array(i);var s=String.fromCharCode.apply(null,j.subarray(0,15));return(q.sap.startsWith(s,"SQLite format 3")||q.sap.startsWith(s,"ZV-"));};return G;});
