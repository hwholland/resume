/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/m/CheckBox','sap/m/ComboBox','sap/m/DatePicker','sap/m/TimePicker','sap/m/HBox','sap/m/Input','sap/m/Text','sap/m/ObjectIdentifier','sap/m/ObjectStatus','sap/m/Image','sap/m/Link','sap/m/VBox','sap/ui/comp/navpopover/SmartLink','sap/ui/comp/odata/MetadataAnalyser','sap/ui/comp/smartfield/ODataHelper','sap/ui/comp/smartfield/SmartField','sap/ui/comp/odata/ODataType','sap/ui/comp/odata/CriticalityMetadata','sap/ui/comp/util/FormatUtil','sap/ui/comp/navpopover/SemanticObjectController'],function(q,C,a,D,T,H,I,b,O,c,d,L,V,S,M,e,f,g,h,F,j){"use strict";var k=function(p){if(p){this._oParentODataModel=p.model;this._oMetadataAnalyser=p.metadataAnalyser;this._aODataFieldMetadata=p.fieldsMetadata;this._oLineItemAnnotation=p.lineItemAnnotation;this._oSemanticKeyAnnotation=p.semanticKeyAnnotation;this._isMobileTable=p.isMobileTable;this._oDateFormatSettings=p.dateFormatSettings;this._bEnableDescriptions=p.enableDescriptions;this._oCurrencyFormatSettings=p.currencyFormatSettings;this._oDefaultDropDownDisplayBehaviour=p.defaultDropDownDisplayBehaviour||"descriptionAndId";this.useSmartField=p.useSmartField==="true";this._sEntitySet=p.entitySet;this._oSemanticKeyAdditionalControl=p._semanticKeyAdditionalControl;this._oSemanticObjectController=p.semanticObjectController;}if(!this._oMetadataAnalyser&&this._oParentODataModel){this._oMetadataAnalyser=new M(this._oParentODataModel);this._intialiseMetadata();}this._mSmartField={};this._oHelper=new e(this._oMetadataAnalyser.oModel);this._aValueListProvider=[];this._aValueHelpProvider=[];this._aLinkHandlers=[];};k.prototype._intialiseMetadata=function(){if(!this._aODataFieldMetadata){this._aODataFieldMetadata=this._oMetadataAnalyser.getFieldsByEntitySetName(this.sEntity);}};k.prototype.getFieldViewMetadata=function(o,i){var l=this._createFieldMetadata(o);this._createFieldTemplate(l,i);return l;};k.prototype._createFieldTemplate=function(v,i){if(this.useSmartField){v.template=new f({value:{path:v.name},entitySet:this._sEntitySet,contextEditable:{path:"sm4rtM0d3l>/editable",mode:"OneWay"},controlContext:this._isMobileTable?"responsiveTable":"table",wrapping:false});if(g.isNumeric(v.type)||g.isDateOrTime(v.type)){v.template.setTextAlign("Right");v.template.setWidth("100%");}this._completeSmartField(v);v.template._setPendingEditState(i);}else{v.template=i?this._createEditableTemplate(v):this._createDisplayOnlyTemplate(v);}};k.prototype._completeSmartField=function(v){var o={annotations:{},path:v.name};if(!this._mSmartField.entitySetObject){this._mSmartField.entitySetObject=this._oHelper.oMeta.getODataEntitySet(this._sEntitySet);this._mSmartField.entityType=this._oHelper.oMeta.getODataEntityType(this._mSmartField.entitySetObject.entityType);}o.modelObject=this._oParentODataModel;o.entitySetObject=this._mSmartField.entitySetObject;o.entitySet=this._mSmartField.entitySetObject;o.entityType=this._mSmartField.entityType;this._oHelper.getProperty(o);o.annotations.uom=this._oHelper.getUnitOfMeasure2(o);o.annotations.text=this._oHelper.getTextProperty2(o);o.annotations.lineitem=this._oLineItemAnnotation;o.annotations.semantic=this._oMetadataAnalyser.getSemanticObjectAnnotationFromProperty(o.property.property);this._oHelper.getUOMTextAnnotation(o);if(o.property.property["sap:value-list"]||o.property.property["com.sap.vocabularies.Common.v1.ValueList"]){o.annotations.valuelist=this._oHelper.getValueListAnnotationPath(o);if(o.property.property["sap:value-list"]){o.annotations.valuelistType=o.property.property["sap:value-list"];}else{o.annotations.valuelistType=this._oMetadataAnalyser.getValueListSemantics(o.property.property["com.sap.vocabularies.Common.v1.ValueList"]);}}this._oHelper.getUOMValueListAnnotationPath(o);delete o.entitySet;v.template.data("configdata",{"configdata":o});v.template.data("dateFormatSettings",this._oDateFormatSettings);v.template.data("currencyFormatSettings",this._oCurrencyFormatSettings);v.template.data("defaultDropDownDisplayBehaviour",this._oDefaultDropDownDisplayBehaviour);if(o.annotations.uom||g.isNumeric(v.type)||g.isDateOrTime(v.type)){var A=v.template.getTextAlign();if(A==="Initial"){A="Right";}v.align=A;}};k.prototype._createEditableTemplate=function(v,B){var t=null,o,i,l;if(v.type==="Edm.DateTime"||v.type==="Edm.DateTimeOffset"){if(v.displayFormat==="Date"){o=this._oDateFormatSettings;i={displayFormat:"Date"};t=new D({dateValue:{path:v.name}});}}else if(v.type==="Edm.Boolean"){t=new C({selected:{path:v.name}});}else if(v.type==="Edm.Decimal"){i={precision:v.precision,scale:v.scale};}l=g.getType(v.type,o,i);if(v.semanticObject&&(!B)){t=this._createSmartLinkFieldTemplate(v,l,function(){var m=this._createEditableTemplate(v,true);if(m.setWrapping&&v.template&&v.template.getWrapping){m.setWrapping(v.template.getWrapping());}return m;}.bind(this));}if(!t){if(v.type==="Edm.Time"){t=new T({value:{path:v.name,type:l}});}else{t=new I({value:{path:v.name,type:l}});if(v.isMeasureField){t.bindProperty("description",{path:v.unit});t.setTextAlign("Right");t.setTextDirection("LTR");t.setFieldWidth("80%");}else if(this._bEnableDescriptions&&v.description){t.bindProperty("description",{path:v.description});}else if(g.isNumeric(v.type)||g.isDateOrTime(v.type)){t.setTextAlign("Right");t.setTextDirection("LTR");}if(v.hasValueListAnnotation){this._associateValueHelpAndSuggest(t,v);}}}return t;};k.prototype._associateValueHelpAndSuggest=function(o,i){o.setShowValueHelp(true);this._aValueHelpProvider.push(new sap.ui.comp.providers.ValueHelpProvider({loadAnnotation:true,fullyQualifiedFieldName:i.fullName,metadataAnalyser:this._oMetadataAnalyser,control:o,model:this._oParentODataModel,preventInitialDataFetchInValueHelpDialog:true,dateFormatSettings:this._oDateFormatSettings,takeOverInputValue:false,fieldName:i.fieldName,type:i.type,maxLength:i.maxLength,displayFormat:i.displayFormat,displayBehaviour:i.displayBehaviour,title:i.label}));o.setShowSuggestion(true);o.setFilterSuggests(false);this._aValueListProvider.push(new sap.ui.comp.providers.ValueListProvider({loadAnnotation:true,fullyQualifiedFieldName:i.fullName,metadataAnalyser:this._oMetadataAnalyser,control:o,model:this._oParentODataModel,dateFormatSettings:this._oDateFormatSettings,typeAheadEnabled:true,aggregation:"suggestionRows",displayFormat:i.displayFormat,displayBehaviour:i.displayBehaviour}));};k.prototype._createDisplayOnlyTemplate=function(v,B){var t=null,o=null,i,l,A,m;if(v.displayFormat==="Date"){i=this._oDateFormatSettings;l={displayFormat:"Date"};}else if(v.type==="Edm.Decimal"){l={precision:v.precision,scale:v.scale};}o=g.getType(v.type,i,l);if(g.isNumeric(v.type)||g.isDateOrTime(v.type)){A="Right";}if(this._isMobileTable){if(v.isImageURL){t=new d({src:{path:v.name},width:"3em",height:"3em"});}else if(this._oLineItemAnnotation&&this._oLineItemAnnotation.urlInfo&&this._oLineItemAnnotation.urlInfo[v.name]){t=this._createLink(v,o,this._oLineItemAnnotation.urlInfo[v.name]);}else if(this._oLineItemAnnotation&&this._oLineItemAnnotation.criticality&&this._oLineItemAnnotation.criticality[v.name]){t=this._createObjectStatusTemplate(v,o,this._oLineItemAnnotation.criticality[v.name]);}else if(this._oSemanticKeyAnnotation&&this._oSemanticKeyAnnotation.semanticKeyFields&&this._oSemanticKeyAnnotation.semanticKeyFields.indexOf(v.name)>-1){t=this._createObjectIdentifierTemplate(v,o,this._oSemanticKeyAnnotation.semanticKeyFields.indexOf(v.name)===0);}}if(!t){if(v.isMeasureField){t=this._createMeasureFieldTemplate(v,o);}else if(v.semanticObject&&(!B)){t=this._createSmartLinkFieldTemplate(v,o,function(){var n=this._createDisplayOnlyTemplate(v,true);if(n.setWrapping&&v.template&&v.template.getWrapping){n.setWrapping(v.template.getWrapping());}return n;}.bind(this));}else{m=this._getDefaultBindingInfo(v,o);t=new b({wrapping:false,textAlign:A,text:m});}}v.align=A;return t;};k.prototype._getDefaultBindingInfo=function(v,t){var B={path:v.name,type:t};if(this._bEnableDescriptions&&v.description){B={parts:[{path:v.name,type:t},{path:v.description}],formatter:function(i,s){return F.getFormattedExpressionFromDisplayBehaviour(v.displayBehaviour,i,s);}};}return B;};k.prototype._createLink=function(v,t,l){v.linkProperties=l.parameters;return new L({text:this._getDefaultBindingInfo(v,t),href:l.urlBinding});};k.prototype._createObjectIdentifierTemplate=function(v,t,i){var o,s,l,m;var n;var p=this;j.getDistinctSemanticObjects().then(function(r){n=j.hasDistinctSemanticObject(v.semanticObject,r);if(n){q.sap.require("sap.ui.comp.navpopover.NavigationPopoverHandler");m=new sap.ui.comp.navpopover.NavigationPopoverHandler({semanticObject:v.semanticObject,semanticObjectLabel:v.label,fieldName:v.name,semanticObjectController:p._oSemanticObjectController});p._aLinkHandlers.push(m);}});if(v.description){switch(v.displayBehaviour){case"descriptionAndId":s=v.description;l=v.name;break;case"idAndDescription":s=v.name;l=v.description;break;case"idOnly":s=v.name;break;default:s=v.description;break;}}else{s=v.name;}o=new O({title:s?{path:s}:undefined,text:l?{path:l}:undefined,titleActive:{path:"$sapuicompcontrolprovider_distinctSO>/distinctSemanticObjects/"+v.semanticObject,formatter:function(r){return!!r;}},titlePress:function(E){if(n&&m){m.setControl(E.getSource());m.openPopover();}}});o.setModel(j.getJSONModel(),"$sapuicompcontrolprovider_distinctSO");if(this._oSemanticKeyAdditionalControl&&i){this._bSemanticKeyAdditionalControlUsed=true;return new V({items:[o,this._oSemanticKeyAdditionalControl]}).addStyleClass("sapMTableContentMargin");}return o;};k.prototype._createObjectStatusTemplate=function(v,t,o){var s,i,l,B;l=h.getShowCriticalityIcon(o.criticalityRepresentationType);if(o.path){v.criticality=o.path;s={path:o.path,formatter:h.getCriticalityState};if(l){i={path:o.path,formatter:h.getCriticalityIcon};}}else{s=h.getCriticalityState(o.criticalityType);if(l){i=h.getCriticalityIcon(o.criticalityType);}}if(v.isMeasureField){B={parts:[{path:v.name,type:t},{path:v.unit}],formatter:F.getInlineMeasureUnitFormatter(),useRawValues:v.isCurrencyField};}else if(v.description){B={path:v.description};}else{B={path:v.name,type:t};}return new c({text:B,state:s,icon:i});};k.prototype._createSmartLinkFieldTemplate=function(v,t,i){var o=new S({semanticObject:v.semanticObject,semanticObjectLabel:v.label,fieldName:v.name,text:this._getDefaultBindingInfo(v,t)});o.setCreateControlCallback(i);return o;};k.prototype._createMeasureFieldTemplate=function(v,t){var o,i,u,E=false;E=!!(v.isCurrencyField&&this._oCurrencyFormatSettings&&this._oCurrencyFormatSettings.showCurrencySymbol);i=new b({wrapping:false,textAlign:"End",text:{parts:[{path:v.name,type:t},{path:v.unit}],formatter:v.isCurrencyField?F.getAmountCurrencyFormatter():F.getMeasureUnitFormatter(),useRawValues:v.isCurrencyField}});u=new b({wrapping:false,textAlign:"Begin",width:"2.5em",text:{path:v.unit,formatter:E?F.getCurrencySymbolFormatter():undefined}});o=new H({justifyContent:"End",items:[i,u]});o.addStyleClass("sapUiCompDirectionLTR");return o;};k.prototype._createFieldMetadata=function(o){var i=q.extend({},o);i.label=o.fieldLabel||o.name;i.quickInfo=o.quickInfo||i.label;i.displayBehaviour=i.displayBehaviour||this._oDefaultDropDownDisplayBehaviour;i.filterType=this._getFilterType(o);this._updateValueListMetadata(i);this._setAnnotationMetadata(i);return i;};k.prototype._updateValueListMetadata=function(o){o.hasValueListAnnotation=o["sap:value-list"]!==undefined;if(o.hasValueListAnnotation){o.hasFixedValues=o["sap:value-list"]==="fixed-values";}else if(o["com.sap.vocabularies.Common.v1.ValueList"]){o.hasValueListAnnotation=true;o.hasFixedValues=this._oMetadataAnalyser.getValueListSemantics(o["com.sap.vocabularies.Common.v1.ValueList"])==="fixed-values";}};k.prototype._setAnnotationMetadata=function(o){var A=null;if(!this.useSmartField&&o&&o.fullName){A=this._oMetadataAnalyser.getSemanticObjectAnnotation(o.fullName);if(A){o.semanticObject=A.semanticObject;}}};k.prototype._getFilterType=function(o){if(g.isNumeric(o.type)){return"numeric";}else if(o.type==="Edm.DateTime"&&o.displayFormat==="Date"){return"date";}else if(o.type==="Edm.String"){return"string";}else if(o.type==="Edm.Boolean"){return"boolean";}else if(o.type==="Edm.Time"){return"time";}return undefined;};k.prototype.destroy=function(){var l=function(A){var i;if(A){i=A.length;while(i--){A[i].destroy();}}};if(this._oMetadataAnalyser&&this._oMetadataAnalyser.destroy){this._oMetadataAnalyser.destroy();}this._oMetadataAnalyser=null;if(!this._bSemanticKeyAdditionalControlUsed&&this._oSemanticKeyAdditionalControl&&this._oSemanticKeyAdditionalControl.destroy){this._oSemanticKeyAdditionalControl.destroy();}l(this._aValueHelpProvider);this._aValueHelpProvider=null;l(this._aValueListProvider);this._aValueListProvider=null;l(this._aLinkHandlers);this._aLinkHandlers=null;if(this._oHelper){this._oHelper.destroy();}this._oHelper=null;this._mSmartField=null;this._aODataFieldMetadata=null;this._oCurrencyFormatter=null;this._oDateFormatSettings=null;this._oDefaultDropDownDisplayBehaviour=null;this._oLineItemAnnotation=null;this._oSemanticKeyAnnotation=null;this._oParentODataModel=null;this.bIsDestroyed=true;};return k;},true);
