/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(["jquery.sap.global","sap/m/Dialog","sap/m/FlexBox","sap/m/FlexItemData","sap/m/Text","sap/m/Button","sap/m/DialogType","sap/ui/core/mvc/XMLView","sap/ui/comp/smartform/SmartForm","sap/ui/comp/smartform/Group","sap/ui/comp/smartform/GroupElement","sap/ui/comp/odata/FieldSelector","sap/ui/fl/Utils","sap/ui/model/json/JSONModel","sap/ui/fl/FlexControllerFactory","sap/m/MessageBox","sap/ui/comp/transport/TransportSelection","sap/ui/fl/transport/Transports","sap/ui/fl/registry/Settings","sap/ui/fl/changeHandler/JsControlTreeModifier"],function(q,D,F,a,T,B,b,X,S,d,e,f,g,J,h,M,l,m,n,o){"use strict";var p=function(){this._oOriginalDataModelForDialog=null;};p.prototype.init=function(s){var P;this._oSmartForm=s;this._oDialogContent=null;this._textResources=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");this._oDialog=this._createDialog();var t=this;this._mergeErrorOccured=false;var c=this._getFlexController();if(this._oSmartForm){P={appDescriptor:g.getAppDescriptor(this._oSmartForm),siteId:g.getSiteId(this._oSmartForm)};}return n.getInstance(c.getComponentName(),P).then(function(i){if(!i.hasMergeErrorOccured()){t._oDialog.setContentHeight("60%");t._oDialog.setTitle(t._textResources.getText("FORM_PERS_DIALOG_TITLE"));t._oDialogContent=t._createDialogContent();t._oDialog.addContent(t._oDialogContent);}else{t._mergeErrorOccured=true;t._oDialog.setType(b.Message);t._oDialog.setTitle(t._textResources.getText("FORM_PERS_DIALOG_ERR_TITLE"));t._showMergeErrorMessageInDialog();}t._createButtons(i);});};p.prototype._createDialog=function(){var c;c=new D("smartFormPersDialog",{contentWidth:"60%",verticalScrolling:false,horizontalScrolling:false,afterClose:[this._destroyDialog,this]});return c;};p.prototype._createButtons=function(s){var O=new B(this._oDialog.getId()+'-OkButton');O.setText(this._textResources.getText("FORM_PERS_DIALOG_OK"));O.attachPress(this._dialogOkClicked.bind(this));this._oDialog.addButton(O);var c=new B(this._oDialog.getId()+'-CancelButton');c.setText(this._textResources.getText("FORM_PERS_DIALOG_CANCEL"));c.attachPress({sAction:"cancel"},this._closeDialog,this);this._oDialog.addButton(c);var i=new B(this._oDialog.getId()+'-RestoreButton');i.setText(this._textResources.getText("FORM_PERS_DIALOG_RESET"));i.attachPress({sAction:"discard"},this._confirmDiscardAllChanges,this);this._oDialog.addButton(i);if(!s.isProductiveSystem()&&!s.hasMergeErrorOccured()){var t=new B(this._oDialog.getId()+'-TransportButton');t.setText(this._textResources.getText("FORM_PERS_DIALOG_TRANSPORT"));t.attachPress({sAction:"transport"},this._confirmTransportAllChanges,this);if(this._oDialog){this._oDialog.addButton(t);}}};p.prototype._showTransportErrorMessage=function(E){return this._showMessage(M.Icon.ERROR,"FORM_PERS_TRANSPORT_ERROR_TITLE","FORM_PERS_TRANSPORT_ERROR_MESSAGE",E);};p.prototype._openTransportSelection=function(c,s){var t=this;return new Promise(function(r,i){var O=function(R){if(R&&R.getParameters){var u=R.getParameters().selectedTransport;var P=R.getParameters().selectedPackage;var v=R.getParameters().dialog;var w={transport:u,packageName:P,fromDialog:v};r(w);}else{r({});}};var E=function(u){if(s&&(u.sId===''||u.sId==='cancel')){r();}t._showTransportErrorMessage(u).then(function(){i(u);});};var j={};if(c){j["package"]=c.getPackage();j.namespace=c.getNamespace();j.name=c.getId();j.type=c.getDefinition().fileType;}var k=new sap.ui.comp.transport.TransportSelection();k.selectTransport(j,O,E,false,t._oSmartForm);});};p.prototype._dialogOkClicked=function(){var c=[];if(!this._mergeErrorOccured){c=this._getChangeDataFromDialog();}if(c.length===0){this._closeDialog();return new Promise(function(r,i){r({});});}var t=this;return t._createAndApplyChanges(c).then(function(){t._closeDialog();});};p.prototype._createAndApplyChanges=function(c){var t=this;return Promise.resolve().then(function(){var i;i=t._getFlexController();function v(C){return C&&C.selector&&C.selector.id;}c.filter(v).forEach(function(C){var j=o.bySelector(C.selector);i.createAndApplyChange(C,j);});})['catch'](function(E){g.log.error("Create and apply error: "+E);return E;}).then(function(E){return t._getFlexController().saveAll().then(function(){if(E){throw E;}});})['catch'](function(E){g.log.error("Create and apply and/or save error: "+E);return t._showApplySaveChangesErrorMessage(E);});};p.prototype._getFlexController=function(){return h.createForControl(this._oSmartForm);};p.prototype._createDialogContent=function(){var c,j,C;if(!this._oSmartForm){return undefined;}j=this._createModelFromSmartForm(this._oSmartForm);j.isMoveDownButtonEnabled=false;j.isMoveUpButtonEnabled=false;j.isMoveBottomButtonEnabled=false;j.isMoveTopButtonEnabled=false;this._oOriginalDataModelForDialog=JSON.parse(JSON.stringify(j));this._oModel=new J();this._oModel.setData(j);c=new sap.ui.comp.smartform.flexibility.DialogContent(this._oDialog.getId()+'-Content');c.setModel(this._oModel);var v=g.getViewForControl(this._oSmartForm);c.setViewId(v.createId(""));var i=this._getIgnoredFields(this._oSmartForm);C=g.getComponentClassName(this._oSmartForm);var P={appDescriptor:g.getAppDescriptor(this._oSmartForm),siteId:g.getSiteId(this._oSmartForm)};c.initialiseODataFieldSelector(this._oSmartForm.getModel(),this._oSmartForm.getEntityType(),C,i,this._mBindingPathToFieldListElement,this._mIdToFieldListElement,P);return c;};p.prototype._getIgnoredFields=function(s){if(s){var c=s.getIgnoredFields();if(c){var i=c.split(",");return i;}}return[];};p.prototype._createChangeSpecificDataFromDialogModel=function(j,c){var C=[],k;var r={};this._createNodeMap(j,r);var s={};this._createNodeMap(c,s);var i,I,N,t,u;var v=Object.keys(r);for(i=0;i<v.length;i++){I=v[i];if(s[I]&&s[I].node){N=r[I].node;t=s[I].node;if(N.label&&t.label&&N.label!==t.label){k=this._createLabelChange(I,t.label,t.type);if(k&&k.selector&&k.selector.id){C.push(k);}}if((N.isVisible&&!t.isVisible)||(!N.isVisible&&t.isVisible)){if(t.isVisible){u=true;}else{u=false;}C.push(this._createVisibilityChange(I,u));}}}var P={};for(i=0;i<c.length;i++){this._check4AddChanges(c[i],r,C,P);}for(i=0;i<c.length;i++){this._check4InterMoveChanges(c[i],s,r,C,P);this._check4IntraMoveChanges(c[i],s,r,C,P);}return C;};p.prototype._check4AddChanges=function(P,c,C,j){if(P&&P.id&&P.children){var i,s=0,I,k,r;k=P.id;if(c[k]&&c[k].node){var t=c[k].node;if(!j){j={};}j[k]={};j[k].index={};for(i=0;i<t.children.length;i++){r=t.children[i];I=r.id;j[k].index[I]=i;}}for(i=0;i<P.children.length;i++){r=P.children[i];if(r.id){I=r.id;if(!c[I]){var u=this._createAddChange(k,r,i);if(u&&u.selector&&u.selector.id){C.push(u);s++;if(!r.isVisible){C.push(this._createVisibilityChange(I,false));}}}else if(s>0&&j[k]&&j[k].index[I]!==undefined){j[k].index[I]=j[k].index[I]+s;}this._check4AddChanges(r,c,C,j);}}}};p.prototype._check4InterMoveChanges=function(P,c,r,C,s){if(P&&P.id&&P.children){var i,I,t,u,v=[],w={},x,y={};t=P.id;var L=P.children.length;for(i=0;i<L;i++){x=P.children[i];if(x.id){I=x.id;if(r[I]&&r[I].index!==undefined){if(!r[I].index[t]&&r[I].index[t]!==0){var j,z=[];z=Object.keys(r[I].index);for(j=0;j<z.length;j++){u=z[j];if(!w[u]){w[u]=[];}w[u].push({"id":I,"index":c[I].index[t]});var A,E=[],G,k;if(s[u]&&s[u].index[I]!==undefined){G=s[u].index[I];delete s[u].index[I];E=Object.keys(s[u].index);for(k=0;k<E.length;k++){A=E[k];if(s[u].index[A]>G){s[u].index[A]--;}}}if(s[t]){G=c[I].index[t];E=Object.keys(s[t].index);for(k=0;k<E.length;k++){A=E[k];if(s[t].index[A]>=G){s[t].index[A]++;}}s[t].index[I]=G;}}}}this._check4InterMoveChanges(x,c,r,C,s);}}if(w){v=Object.keys(w);for(i=0;i<v.length;i++){u=v[i];y=this._createMoveChange(u,P.type,w[u],P.id);if(y&&y.selector&&y.selector.id){C.push(y);}}}}};p.prototype._check4IntraMoveChanges=function(P,c,j,C,k){if(P&&P.id&&P.children){var i,I,s,r=[],t,u={};s=P.id;var L=P.children.length;for(i=0;i<L;i++){t=P.children[i];if(t.id){I=t.id;if(j[I]&&j[I].index!==undefined){if(j[I].index[s]!==undefined&&j[I].index[s]!==i){if(k[s]&&k[s].index[I]!==undefined&&k[s].index[I]!==i){r.push({"id":I,"index":c[I].index[s]});}}}this._check4IntraMoveChanges(t,c,j,C,k);}}if(r.length>0){u=this._createMoveChange(s,P.type,r,"");if(u&&u.selector&&u.selector.id){C.push(u);}}}};p.prototype._createAddChange=function(i,N,I){var A={};A.selector={};A.selector.id=i;A.index=I;A.newControlId=N.id;switch(N.type){case"form":A={};break;case"group":A.changeType="addGroup";if(!N.label){A.groupLabel="";}else{A.groupLabel=N.label;}break;case"field":A.changeType="addField";if(!N.label){A.fieldLabel="";}else{A.fieldLabel=N.label;}if(!N.fieldValue){A.fieldValue="";}else{A.fieldValue=N.fieldValue;}if(!N.valueProperty){A.valueProperty="";}else{A.valueProperty=N.valueProperty;}if(!N.jsType){A.jsType="";}else{A.jsType=N.jsType;}break;default:A={};break;}return A;};p.prototype._createLabelChange=function(i,L,t){var c={};c.selector={};c.selector.id=i;switch(t){case"form":c={};break;case"group":c.changeType="renameGroup";c.groupLabel=L;break;case"field":c.changeType="renameField";c.fieldLabel=L;break;default:c={};break;}return c;};p.prototype._createMoveChange=function(i,t,I,s){var c={};c.selector={};c.selector.id=i;switch(t){case"form":c.changeType="moveGroups";c.moveGroups=I;break;case"group":c.changeType="moveFields";c.moveFields=I;break;default:c={};break;}if(s){c.targetId=s;}return c;};p.prototype._createVisibilityChange=function(i,I){var v={};v.selector={};v.selector.id=i;if(I===true){v.changeType="unhideControl";}else{v.changeType="hideControl";}return v;};p.prototype._createNodeMap=function(j,N,P){if(!N){throw new Error("Node map instance must be provided");}if(!j||!j.length){return;}var c,I;var i,L=j.length;for(i=0;i<L;i++){c=j[i];if(c&&c.id){I=c.id;if(!N[I]){N[I]={};N[I].node=c;}if(P&&P.id){if(!N[I].index){N[I].index={};}N[I].index[P.id]=i;}if(c.children){this._createNodeMap(c.children,N,c);}}}};p.prototype.show=function(){this._oDialog.open();};p.prototype._showMergeErrorMessageInDialog=function(){var c=new F();c.setDirection("Column");c.setAlignItems("Start");var i=new T();i.setText(this._textResources.getText("FORM_PERS_DIALOG_ERR_DESC"));i.setLayoutData(new a({order:1,growFactor:1}));var j=new T();j.setText(this._textResources.getText("FORM_PERS_DIALOG_ERR_HINT"));j.setLayoutData(new a({order:1,growFactor:1}));c.addItem(i);c.addItem(j);this._oDialog.addContent(c);};p.prototype._closeDialog=function(){if(this._oDialog){this._oDialog.close();}this._destroyDialog();};p.prototype._destroyDialog=function(){if(this._oDialogContent){this._oDialogContent.destroy();this._oDialogContent=null;}if(this._oDialog){this._oDialog.destroy();this._oDialog=null;}};p.prototype._createSmartFormControlMap=function(s){var c=[];var C;if(s){C=s.getId();c[C]=s;var G=s.getGroups();if(G){for(var i=0;i<G.length;i++){var k=G[i];if(k){C=k.getId();c[C]=k;var r=k.getGroupElements();if(r){for(var j=0;j<r.length;j++){var t=r[j];if(t){C=t.getId();c[C]=t;}}}}}}}return c;};p.prototype._showDiscardSuccessMessage=function(){return this._showMessage(M.Icon.SUCCESS,"FORM_PERS_DISCARD_SUCCESS_TITLE","FORM_PERS_DISCARD_SUCCESS_MESSAGE");};p.prototype._showTransportSuccessMessage=function(){return this._showMessage(M.Icon.SUCCESS,"FORM_PERS_TRANSPORT_SUCCESS_TITLE","FORM_PERS_TRANSPORT_SUCCESS_MESSAGE");};p.prototype._showTransportInapplicableMessage=function(){return this._showMessage(M.Icon.INFORMATION,"FORM_PERS_TRANSPORT_INAPPLICABLE_TITLE","FORM_PERS_TRANSPORT_INAPPLICABLE_MESSAGE");};p.prototype._showDiscardErrorMessage=function(E){return this._showMessage(M.Icon.ERROR,"FORM_PERS_DISCARD_ERROR_TITLE","FORM_PERS_DISCARD_ERROR_MESSAGE",E);};p.prototype._showApplySaveChangesErrorMessage=function(E){return this._showMessage(M.Icon.ERROR,"FORM_PERS_APPLYSAVE_ERROR_TITLE","FORM_PERS_APPLYSAVE_ERROR_MESSAGE",E);};p.prototype._showMessage=function(c,t,s,E){return new Promise(function(r){if(E&&(E.sId===''||E.sId==='cancel')){r();}else{var i,j;if(E){j=[E.message||E];i=this._textResources.getText(s,j);}i=this._textResources.getText(s);var k=this._textResources.getText(t);M.show(i,{icon:c,title:k,onClose:r});}}.bind(this));};p.prototype._filterChangesForSmartForm=function(c,s){var r=[];var j=this._createSmartFormControlMap(s);for(var i=0;i<c.length;i++){var C=c[i];var k=C.getSelector().id;if(j[k]){r.push(C);}}return r;};p.prototype._setTransports=function(c,C,t,i){var j=this;if(C>=0){var k=c[C];if(i===true){if(k.getDefinition().packageName!=="$TMP"){k.setRequest(t);}C--;return j._setTransports(c,C,t,i);}else{if(k.getDefinition().packageName!=="$TMP"){return j._openTransportSelection(k).then(function(r){k.setRequest(r.transport);if(r.fromDialog===true){t=r.transport;i=true;}C--;return j._setTransports(c,C,t,i);});}else{C--;return j._setTransports(c,C,t,i);}}}else{return Promise.resolve();}};p.prototype._deleteChanges=function(c,s){var t=this;var i=this._filterChangesForSmartForm(c,s);var j=t._getFlexController();var C=i.length-1;return this._setTransports(i,C).then(function(){return j.discardChanges(i);}).then(function(){return t._showDiscardSuccessMessage();})["catch"](function(E){return t._showDiscardErrorMessage(E);});};p.prototype._confirmDiscardAllChanges=function(){var t=this;var P={appDescriptor:g.getAppDescriptor(t._oSmartForm),siteId:g.getSiteId(t._oSmartForm)};var c=function(A){if(A==="OK"){var j=t._getFlexController();j.getComponentChanges(P).then(function(C){var k=t._convertToChangeArray(C);return t._deleteChanges(k,t._oSmartForm);})["catch"](function(E){return t._showDiscardErrorMessage();}).then(function(){t._closeDialog();});}};var s=this._textResources.getText("FORM_PERS_RESET_MESSAGE");var i=this._textResources.getText("FORM_PERS_RESET_TITLE");M.confirm(s,{title:i,onClose:c});};p.prototype._confirmTransportAllChanges=function(){var t=this;return Promise.resolve().then(c)['catch'](i).then(j).then(k).then(r).then(s)['catch'](u).then(v);function c(){var C=t._getChangeDataFromDialog();if(C.length>0){return t._createAndApplyChanges(C);}}function i(E){g.log.error("SmartForm changes could not be applied or saved: "+E);return t._showApplySaveChangesErrorMessage(E).then(function(){throw new Error('createAndApply failed');});}function j(){return t._getAllLocalChanges();}function k(A){return!!A.length;}function r(w){if(w){return t._openTransportSelection(null,true);}else{return t._showTransportInapplicableMessage();}}function s(w){if(w&&w.transport&&w.packageName!=="$TMP"){return t._transportAllLocalChanges(w);}}function u(E){if(E.message==='createAndApply failed'){return;}g.log.error("transport error"+E);return t._showTransportErrorMessage(E);}function v(){t._closeDialog();}};p.prototype._getChangeDataFromDialog=function(){var c,C;c=this._oModel.getData();C=this._createChangeSpecificDataFromDialogModel([this._oOriginalDataModelForDialog],[c]);return C;};p.prototype._getAllLocalChanges=function(){var t=this;var P={appDescriptor:g.getAppDescriptor(t._oSmartForm),siteId:g.getSiteId(t._oSmartForm)};return t._getFlexController().getComponentChanges(P).then(function(c){var A=t._convertToChangeArray(c);return t._filterChangesForSmartForm(A,t._oSmartForm);});};p.prototype._transportAllLocalChanges=function(t){var c=this;return c._getAllLocalChanges().then(function(A){var i=c._convertToChangeTransportData(A);var j=new m();var k={};k.transportId=t.transport;k.changeIds=i;return j.makeChangesTransportable(k).then(function(){A.forEach(function(C){if(C.getPackage()==='$TMP'){var r=C.getDefinition();r.packageName='';C.setResponse(r);}});}).then(function(){return c._showTransportSuccessMessage();});});};p.prototype._convertToChangeTransportData=function(L){var t=[];var c=L.length;for(var i=0;i<c;i++){var C=L[i];var j={};j.namespace=C.getNamespace();j.fileName=C.getId();j.fileType=C.getDefinition().fileType;t.push(j);}return t;};p.prototype._convertToChangeArray=function(c){var C=c;if(!q.isArray(c)){C=[];var k=Object.keys(c);for(var i=0;i<k.length;i++){C.push(c[k[i]]);}}return C;};p.prototype._createModelFromSmartForm=function(s){var c,j,i,r,t,u,k,v;var w=this;this._mBindingPathToFieldListElement={};this._mIdToFieldListElement={};if(s){c=this._getModelNodeForSmartForm(s);j=s.getGroups();if(j){for(i=0;i<j.length;i++){r=j[i];if(!g.checkControlId(r)){continue;}t=this._getModelNodeForSmartGroup(r);c.children.push(t);if(r){u=r.getGroupElements();if(u){for(k=0;k<u.length;k++){if(!g.checkControlId(u[k])){continue;}var G=u[k];v=this._getModelNodeForSmartGroupElement(G);var x=!!(v.label);if(x){t.children.push(v);q.each(v.bindingPaths,function(y,z){w._mBindingPathToFieldListElement[z.path]=v;});this._mIdToFieldListElement[v.id]=v;}}}}}}}return c;};p.prototype._getModelNodeForSmartForm=function(s){var r={};r.id=s.getId();r.label=s.getTitle();r.isVisible=s.getVisible();r.type="form";r.children=[];return r;};p.prototype._getModelNodeForSmartGroup=function(s){var r={};r.id=s.getId();r.label=s.getLabel();r.isVisible=s.getVisible();r.type="group";r.children=[];return r;};p.prototype._determineRelevantBindingPathsOf=function(C,i){var t=this;if(!i){i=[];}if((!C)||(!C.getMetadata)){return;}var j=C.getMetadata();if(j){var P=j.getAllProperties();q.each(P,function(c,k){var r=c==='text'||c==='value'||c==='selected'||c==='selectedKey';if(r){var s=C.getBinding(c);if(s){var u=s.getPath();if(u){var v=t._getAbsoluteBindingPath(C,u);var I=function(w){return(w.path===v);};if(!i.some(I)){i.push({path:v});}}}}});var A=j.getAllAggregations();q.each(A,function(k,r){var v=C.getAggregation(k);if(!q.isArray(v)){var s=[];s.push(v);v=s;}if(v){for(var c=0;c<v.length;c++){t._determineRelevantBindingPathsOf(v[c],i);}}});}return i;};p.prototype._getAbsoluteBindingPath=function(c,s){var P='';var i=c.getModel();if(i){var j=i.getMetaModel();if(j){var k=c.getBindingContext();if(k){var r=k.getPath();if(r){var t=j.getMetaContext(r);if(t){var u=t.sPath;if(u){var E=j.getObject(u).name;if(E){P=P+E+'/';}}}}}}}return P+s;};p.prototype._getModelNodeForSmartGroupElement=function(G){var r={};r.id=G.getId();r.label=G.getLabelText();r.isVisible=G.getVisible();if(r.isVisible){r.isVisible=G.getVisibleBasedOnElements();}r.type="field";r.bindingPaths=this._determineRelevantBindingPathsOf(G);return r;};return p;},true);
