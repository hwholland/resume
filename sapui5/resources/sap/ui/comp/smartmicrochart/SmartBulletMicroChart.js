/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/comp/library','sap/ui/comp/providers/ChartProvider','sap/ui/core/Control','sap/suite/ui/microchart/library','sap/ui/core/CustomData','sap/m/ValueColor'],function(q,l,C,a,M,b,V){"use strict";var S=a.extend("sap.ui.comp.smartmicrochart.SmartBulletMicroChart",{metadata:{library:"sap.ui.comp",properties:{entitySet:{type:"string",group:"Misc",defaultValue:null},showLabel:{type:"boolean",group:"Appearance",defaultValue:true},chartType:{type:"string",group:"Misc",defaultValue:"Bullet"},enableAutoBinding:{type:"boolean",group:"Misc",defaultValue:false},chartBindingPath:{type:"string",group:"Misc",defaultValue:null},width:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:"164px"},isResponsive:{type:"boolean",group:"Appearance",defaultValue:false}},defaultAggregation:"_chart",aggregations:{_criticalityThresholds:{type:"sap.ui.core.CustomData",multiple:true,visibility:"hidden"},_chart:{type:"sap.suite.ui.microchart.BulletMicroChart",multiple:false,visibility:"hidden"}},associations:{chartTitle:{type:"sap.m.Label",group:"Misc",multiple:false},chartDescription:{type:"sap.m.Label",group:"Misc",multiple:false},unitOfMeasure:{type:"sap.m.Label",group:"Misc",multiple:false}},events:{initialize:{}}}});S._GOOD_COLOR=V.Good;S._CRITICAL_COLOR=V.Critical;S._ERROR_COLOR=V.Error;S._NEUTRAL_COLOR=V.Neutral;S._TARGET="com.sap.vocabularies.UI.v1.ImprovementDirectionType/Target";S._MINIMIZE="com.sap.vocabularies.UI.v1.ImprovementDirectionType/Minimize";S._MAXIMIZE="com.sap.vocabularies.UI.v1.ImprovementDirectionType/Maximize";S.prototype.init=function(){this._bIsInitialized=false;this._bMetaModelLoadAttached=false;this._bBarColorSet=false;this.setProperty("chartType","Bullet",true);this.setAggregation("_chart",new M.BulletMicroChart(),true);};S._mapCriticalityTypeWithColor=function(t){var T;if(!t){return S._NEUTRAL_COLOR;}else if(q.isNumeric(t)){T=t.toString();}else{T=t;}T=(T.match(/(?:CriticalityType\/)?([^\/]*)$/)||[])[1]||"";switch(T){case'Negative':case'1':return S._ERROR_COLOR;case'Positive':case'3':return S._GOOD_COLOR;case'Critical':case'2':return S._CRITICAL_COLOR;default:return S._NEUTRAL_COLOR;}};S.prototype.setChartType=function(){return this;};S.prototype.setEntitySet=function(e){if(this.getProperty("entitySet")!==e){this.setProperty("entitySet",e,true);this._initializeMetadata();}return this;};S.prototype.setShowLabel=function(s){if(this.getShowLabel()!==s){this.setProperty("showLabel",s,true);var c=this.getAggregation("_chart");c.setProperty("showActualValue",s,true);c.setProperty("showTargetValue",s,true);c.setProperty("showDeltaValue",s,true);c.setProperty("showValueMarker",s,true);this.invalidate();}return this;};S.prototype.setChartType=function(){return this;};S.prototype.propagateProperties=function(){if(a.prototype.propagateProperties){a.prototype.propagateProperties.apply(this,arguments);}this._initializeMetadata();};S.prototype.onBeforeRendering=function(){var c=this.getAggregation("_chart");c.setProperty("width",this.getWidth(),true);if(c.getMetadata().hasProperty("isResponsive")){c.setProperty("isResponsive",this.getIsResponsive(),true);M._passParentContextToChild(this,c);}};S.prototype._initializeMetadata=function(){if(!this._bIsInitialized){var m=this.getModel();if(m&&(m instanceof sap.ui.model.odata.v2.ODataModel||m instanceof sap.ui.model.odata.ODataModel)){if(!this._bMetaModelLoadAttached){m.getMetaModel().loaded().then(this._onMetadataInitialized.bind(this));this._bMetaModelLoadAttached=true;}}else if(m){this._onMetadataInitialized();}}};S.prototype._createChartProvider=function(){var m,e;e=this.getEntitySet();m=this.getModel();if(m&&e){this._oChartProvider=new C({entitySet:e,model:m});}};S.prototype._onMetadataInitialized=function(){var B;this._bMetaModelLoadAttached=false;if(!this._bIsInitialized){this._createChartProvider();if(this._oChartProvider){this._oChartViewMetadata=this._oChartProvider.getChartViewMetadata();if(this._oChartViewMetadata){this._oDataPointMetadata=this._oChartProvider.getChartDataPointMetadata();this._bIsInitialized=true;this.fireInitialize();this._createAndBindInnerChart();if(this.getEnableAutoBinding()){if(this.getChartBindingPath()){B=this.getChartBindingPath();this.bindElement(B);}else{q.sap.log.error("The property chartBindingPath is not set thus the property enableAutoBinding cannot be applied");}}}}}};S.prototype._createAndBindInnerChart=function(){if(!this._checkChartMetadata()){q.sap.log.error("The chart annotation contain errors. Please check the chart annotation.");return;}var Q=this._getDatapointQualifier();if(Q){this._oDataPointAnnotations=this._oDataPointMetadata.additionalAnnotations[Q];}else{this._oDataPointAnnotations=this._oDataPointMetadata.primaryAnnotation;}if(this._oDataPointAnnotations){if(!this._checkDataPointAnnotation()){return;}this.getAggregation("_chart").addDelegate({onBeforeRendering:this._calculateBarColor.bind(this)},this);this._bindValueProperties();this._bindAggregationActual();if(!this._bBarColorSet){this._bindValuesForCriticalityCalculation();}this._bindChartThresholds();this.setAssociation();}else{q.sap.log.error("The datapoint annotation is empty. Please check the datapoint annotation.");}};S.prototype._bindValueProperties=function(){var m,f;var i=this.getAggregation("_chart");if(this._oDataPointAnnotations.TargetValue&&this._oDataPointAnnotations.TargetValue.hasOwnProperty("Path")){i.bindProperty("targetValue",{path:this._oDataPointAnnotations.TargetValue.Path,type:"sap.ui.model.odata.type.Decimal"});}if(this._oDataPointAnnotations.ForecastValue&&this._oDataPointAnnotations.ForecastValue.hasOwnProperty("Path")){i.bindProperty("forecastValue",{path:this._oDataPointAnnotations.ForecastValue.Path,type:"sap.ui.model.odata.type.Decimal"});}if(this._oDataPointAnnotations.MaximumValue){if(this._oDataPointAnnotations.MaximumValue.hasOwnProperty("Path")){i.bindProperty("maxValue",{path:this._oDataPointAnnotations.MaximumValue.Path,type:"sap.ui.model.odata.type.Decimal"});}else if(this._oDataPointAnnotations.MaximumValue.hasOwnProperty("Decimal")){m=parseFloat(this._oDataPointAnnotations.MaximumValue.Decimal);i.setMaxValue(m,true);}}if(this._oDataPointAnnotations.MinimumValue){if(this._oDataPointAnnotations.MinimumValue.hasOwnProperty("Path")){i.bindProperty("minValue",{path:this._oDataPointAnnotations.MinimumValue.Path,type:"sap.ui.model.odata.type.Decimal"});}else if(this._oDataPointAnnotations.MinimumValue.hasOwnProperty("Decimal")){f=parseFloat(this._oDataPointAnnotations.MinimumValue.Decimal);i.setMinValue(f,true);}}};S.prototype._bindAggregationActual=function(){var c;if(this._oDataPointAnnotations.Criticality&&this._oDataPointAnnotations.Criticality.hasOwnProperty("Path")){c=new M.BulletMicroChartData({value:{path:this._oDataPointAnnotations.Value.Path,type:"sap.ui.model.odata.type.Decimal"},color:{path:this._oDataPointAnnotations.Criticality.Path,formatter:S._mapCriticalityTypeWithColor}});this._bBarColorSet=true;}else{c=new M.BulletMicroChartData({value:{path:this._oDataPointAnnotations.Value.Path,type:"sap.ui.model.odata.type.Decimal"}});}this.getAggregation("_chart").setAggregation("actual",c,true);};S.prototype._bindChartThresholds=function(){var d,c;if(this._oDataPointAnnotations.CriticalityCalculation&&this._oDataPointAnnotations.CriticalityCalculation.ImprovementDirection&&this._oDataPointAnnotations.CriticalityCalculation.ImprovementDirection.EnumMember){c=this._oDataPointAnnotations.CriticalityCalculation;d=c.ImprovementDirection.EnumMember;if(d!==S._MINIMIZE&&c.DeviationRangeLowValue&&c.DeviationRangeLowValue.Path){this._bindThresholdAggregation("thresholds",c.DeviationRangeLowValue.Path,S._ERROR_COLOR);}if(d!==S._MINIMIZE&&c.ToleranceRangeLowValue&&c.ToleranceRangeLowValue.Path){this._bindThresholdAggregation("thresholds",c.ToleranceRangeLowValue.Path,S._CRITICAL_COLOR);}if(d!==S._MAXIMIZE&&c.ToleranceRangeHighValue&&c.ToleranceRangeHighValue.Path){this._bindThresholdAggregation("thresholds",c.ToleranceRangeHighValue.Path,S._CRITICAL_COLOR);}if(d!==S._MAXIMIZE&&c.DeviationRangeHighValue&&c.DeviationRangeHighValue.Path){this._bindThresholdAggregation("thresholds",c.DeviationRangeHighValue.Path,S._ERROR_COLOR);}}};S.prototype._bindThresholdAggregation=function(A,p,c){var t=new M.BulletMicroChartData({value:{path:p,type:"sap.ui.model.odata.type.Decimal"},color:c});this.getAggregation("_chart").addAggregation(A,t,true);};S.prototype._bindValuesForCriticalityCalculation=function(){var c=this._oDataPointAnnotations.CriticalityCalculation;if(!c){return;}if(c.DeviationRangeLowValue&&c.DeviationRangeLowValue.hasOwnProperty("Path")){this._bindCriticalityValues("deviationLow",c.DeviationRangeLowValue.Path);}if(c.DeviationRangeHighValue&&c.DeviationRangeHighValue.hasOwnProperty("Path")){this._bindCriticalityValues("deviationHigh",c.DeviationRangeHighValue.Path);}if(c.ToleranceRangeLowValue&&c.ToleranceRangeLowValue.hasOwnProperty("Path")){this._bindCriticalityValues("toleranceLow",c.ToleranceRangeLowValue.Path);}if(c.ToleranceRangeHighValue&&c.ToleranceRangeHighValue.hasOwnProperty("Path")){this._bindCriticalityValues("toleranceHigh",c.ToleranceRangeHighValue.Path);}};S.prototype._bindCriticalityValues=function(c,s){var o=new b({key:c,value:"{"+s+"}"});this.addAggregation("_criticalityThresholds",o,false);};S.prototype._getDatapointQualifier=function(){var m,d,p,Q;if(this._oChartViewMetadata){if(this._oChartViewMetadata.annotation&&this._oChartViewMetadata.annotation.hasOwnProperty("MeasureAttributes")&&this._oChartViewMetadata.annotation.MeasureAttributes.length>0){m=this._oChartViewMetadata.annotation.MeasureAttributes[0];if(m.DataPoint&&m.DataPoint.hasOwnProperty("AnnotationPath")){Q=m.DataPoint.AnnotationPath;p=Q.split("#");if(p.length===2){d=p[1];}}}}return d;};S.prototype._calculateBarColor=function(){var t={},v,c,d,D,i,T,e;if(this._bBarColorSet){return;}t=this._getCriticalityThresholdsValues();if(q.isEmptyObject(t)){return;}v=this.getAggregation("_chart").getActual().getValue();c=this._oDataPointAnnotations.CriticalityCalculation;if(c.ImprovementDirection&&c.ImprovementDirection.EnumMember){d=c.ImprovementDirection.EnumMember;}else{q.sap.log.error("Without 'ImprovementDirection' annotation bar color cannot be calculated");return;}D=t.deviationLow;i=t.deviationHigh;T=t.toleranceLow;e=t.toleranceHigh;if(d&&d===S._TARGET){this._setBarColorForTarget(v,T,e,D,i);}else if(d&&d===S._MINIMIZE){this._setBarColorForMinimize(v,T,e,D,i);}else if(d&&d===S._MAXIMIZE){this._setBarColorForMaximize(v,T,e,D,i);}};S.prototype._getCriticalityThresholdsValues=function(){var t={},i;var c=this.getAggregation("_criticalityThresholds");if(c){var d=c.length;for(i=0;i<d;i++){if(c[i].getKey()&&c[i].getValue()!==null){t[c[i].getKey()]=c[i].getValue();}}}return t;};S.prototype._setBarColorForTarget=function(v,t,T,d,D){var i=this.getAggregation("_chart");if(v>=t&&v<=T){i.getActual().setProperty("color",S._GOOD_COLOR,true);}else if((v>=d&&v<t)||(v>T&&v<=D)){i.getActual().setProperty("color",S._CRITICAL_COLOR,true);}else if(v<d||v>D){i.getActual().setProperty("color",S._ERROR_COLOR,true);}};S.prototype._setBarColorForMinimize=function(v,t,T,d,D){var i=this.getAggregation("_chart");if(v<=T){i.getActual().setProperty("color",S._GOOD_COLOR,true);}else if(v>T&&v<=D){i.getActual().setProperty("color",S._CRITICAL_COLOR,true);}else if(v>D){i.getActual().setProperty("color",S._ERROR_COLOR,true);}};S.prototype._setBarColorForMaximize=function(v,t,T,d,D){var i=this.getAggregation("_chart");if(v>=t){i.getActual().setProperty("color",S._GOOD_COLOR,true);}else if(v<t&&v>=d){i.getActual().setProperty("color",S._CRITICAL_COLOR,true);}else if(v<d){i.getActual().setProperty("color",S._ERROR_COLOR,true);}};S.prototype._checkChartMetadata=function(){if(q.isEmptyObject(this._oChartViewMetadata)&&q.isEmptyObject(this._oDataPointMetadata)){q.sap.log.error("The Chart or DataPoint annotation is empty.");return false;}if(this._oChartViewMetadata.annotation&&this._oChartViewMetadata.annotation.ChartType){if(this._oChartViewMetadata.annotation.ChartType.EnumMember==="com.sap.vocabularies.UI.v1.ChartType/Bullet"){return true;}else{q.sap.log.error("The ChartType property in the Chart annotation is not bullet.");return false;}}else{q.sap.log.error("The Chart annotation is invalid.");return false;}};S.prototype._checkDataPointAnnotation=function(){var c;if(q.isEmptyObject(this._oDataPointAnnotations)){q.sap.log.error("The DataPoint annotation is an empty object.");return false;}if(this._oDataPointAnnotations.Value&&this._oDataPointAnnotations.Value.Path){c=this._oDataPointAnnotations.CriticalityCalculation;this._checkCriticalityMetadata(c);return true;}else{q.sap.log.error("The Value property does not exist in the DataPoint annotation. "+"This property is mandentory to generate the SmartBulletChart.");return false;}};S.prototype._checkCriticalityMetadata=function(c){var i;if(q.isEmptyObject(c)){q.sap.log.warning("The CriticalityCalculation property in DataPoint annotation is not provided.");return;}if(c.ImprovementDirection&&c.ImprovementDirection.EnumMember){i=c.ImprovementDirection.EnumMember;switch(i){case S._TARGET:this._checkCriticalityMetadataForTarget(c);break;case S._MINIMIZE:this._checkCriticalityMetadataForMinimize(c);break;case S._MAXIMIZE:this._checkCriticalityMetadataForMaximize(c);break;case"":q.sap.log.warning("The improvement direction in DatPoint annotation is empty, it must be either Target, Minimize or Maximize.");break;default:q.sap.log.warning("The improvement direction in DataPoint annotation must be either Target, Minimize or Maximize.");}}else{q.sap.log.warning("The ImprovementDirection property in DataPoint annotation is not provided.");}};S.prototype._checkCriticalityMetadataForTarget=function(c){if(!c.DeviationRangeLowValue||!c.DeviationRangeLowValue.Path){q.sap.log.warning("The DeviationRangeLowValue property in DataPoint annotation is missing for Target improvement direction.");}if(!c.ToleranceRangeLowValue||!c.ToleranceRangeLowValue.Path){q.sap.log.warning("The ToleranceRangeLowValue property in DataPoint annotation is missing for Target improvement direction.");}if(!c.ToleranceRangeHighValue||!c.ToleranceRangeHighValue.Path){q.sap.log.warning("The ToleranceRangeHighValue property in DataPoint annotation is missing for Target improvement direction.");}if(!c.DeviationRangeHighValue||!c.DeviationRangeHighValue.Path){q.sap.log.warning("The DeviationRangeHighValue property in DataPoint annotation is missing for Target improvement direction.");}};S.prototype._checkCriticalityMetadataForMinimize=function(c){if(!c.ToleranceRangeHighValue||!c.ToleranceRangeHighValue.Path){q.sap.log.warning("The ToleranceRangeHighValue property in DataPoint annotation is missing for Minimize improvement direction.");}if(!c.DeviationRangeHighValue||!c.DeviationRangeHighValue.Path){q.sap.log.warning("The DeviationRangeHighValue property in DataPoint annotation is missing for Minimize improvement direction.");}};S.prototype._checkCriticalityMetadataForMaximize=function(c){if(!c.DeviationRangeLowValue||!c.DeviationRangeLowValue.Path){q.sap.log.warning("The DeviationRangeLowValue property in DataPoint annotation is missing for Maximize improvement direction.");}if(!c.ToleranceRangeLowValue||!c.ToleranceRangeLowValue.Path){q.sap.log.warning("The ToleranceRangeLowValue property in DataPoint annotation is missing for Maximize improvement direction.");}};S.prototype.setAssociation=function(A,i,s){if(a.prototype.setAssociation){a.prototype.setAssociation.apply(this,arguments);}var u,c,o;o=sap.ui.getCore().byId(this.getAssociation("chartDescription"));if(o){if(!(o instanceof sap.m.Label)){q.sap.log.error("Control in association chartDescription should be of type sap.m.Label");}else{this._setChartDescription(o);}}c=sap.ui.getCore().byId(this.getAssociation("chartTitle"));if(c){if(!(c instanceof sap.m.Label)){q.sap.log.error("Control in association chartTitle should be of type sap.m.Label");}else{this._setChartTitle(c);}}u=sap.ui.getCore().byId(this.getAssociation("unitOfMeasure"));if(u){if(!(u instanceof sap.m.Label)){q.sap.log.error("Control in association unitOfMeasure should be of type sap.m.Label");}else{this._setUnitOfMeasure(u);}}return this;};S.prototype._setChartTitle=function(c){if(this._oChartViewMetadata&&this._oChartViewMetadata.annotation&&this._oChartViewMetadata.annotation.Title){if(this._oChartViewMetadata.annotation.Title.hasOwnProperty("Path")){c.bindProperty("text",{path:this._oChartViewMetadata.annotation.Title.Path});c.invalidate();}else if(this._oChartViewMetadata.annotation.Title.hasOwnProperty("String")){if(this._oChartViewMetadata.annotation.Title.String.indexOf("{")===0){var p=this._oChartViewMetadata.annotation.Title.String.split(">");c.bindProperty("text",{path:p[1].substring(0,p[1].length-1),model:p[0].substring(1,p[1].length)});c.invalidate();}else{c.setProperty("text",this._oChartViewMetadata.annotation.Title.String,false);}}}};S.prototype._setChartDescription=function(c){if(this._oChartViewMetadata&&this._oChartViewMetadata.annotation&&this._oChartViewMetadata.annotation.Description){if(this._oChartViewMetadata.annotation.Description.hasOwnProperty("Path")){c.bindProperty("text",{path:this._oChartViewMetadata.annotation.Description.Path});c.invalidate();}else if(this._oChartViewMetadata.annotation.Description.hasOwnProperty("String")){if(this._oChartViewMetadata.annotation.Description.String.indexOf("{")===0){var p=this._oChartViewMetadata.annotation.Description.String.split(">");c.bindProperty("text",{path:p[1].substring(0,p[1].length-1),model:p[0].substring(1,p[1].length)});c.invalidate();}else{c.setProperty("text",this._oChartViewMetadata.annotation.Description.String,false);}}}};S.prototype._setUnitOfMeasure=function(u){var U=this._getUnitOfMeasureAnnotation();if(U&&U.Path){u.bindProperty("text",{path:U.Path});u.invalidate();}else if(U&&U.String){if(U.String.indexOf("{")===0){var p=U.String.split(">");u.bindProperty("text",{path:p[1].substring(0,p[1].length-1),model:p[0].substring(1,p[1].length)});u.invalidate();}else{u.setProperty("text",U.String,false);}}};S.prototype._getUnitOfMeasureAnnotation=function(){var p,P;if(!this._oDataPointAnnotations){return{};}if(this._oDataPointAnnotations.Value&&this._oDataPointAnnotations.Value.Path){P=this._getPropertyAnnotation(this._oDataPointAnnotations.Value.Path);}if(P){for(p in P){if((p.indexOf("ISOCurrency")>-1)||(p.indexOf("Unit")>-1)){return P[p];}}}};S.prototype._getPropertyAnnotation=function(e){var m,E,o,p;m=this.getModel().getMetaModel();E=this._oChartProvider._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(this.getEntitySet());o=m.getODataEntityType(E);p=m.getODataProperty(o,e);return p;};return S;});
