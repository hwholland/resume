/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/comp/library','sap/suite/ui/microchart/library','sap/ui/core/Control','sap/ui/comp/providers/ChartProvider','sap/m/ValueColor','sap/ui/core/CustomData','sap/ui/model/odata/CountMode'],function(q,C,M,a,b,V,c,d){"use strict";var S=a.extend("sap.ui.comp.smartmicrochart.SmartAreaMicroChart",{metadata:{library:"sap.ui.comp",properties:{entitySet:{type:"string",group:"Misc",defaultValue:null},showLabel:{type:"boolean",group:"Appearance",defaultValue:true},chartType:{type:"string",group:"Misc",defaultValue:null},enableAutoBinding:{type:"boolean",group:"Misc",defaultValue:true},chartBindingPath:{type:"string",group:"Misc",defaultValue:null},width:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:"164px"},height:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:"74px"},isResponsive:{type:"boolean",group:"Appearance",defaultValue:false}},defaultAggregation:"_chart",aggregations:{_chart:{type:"sap.suite.ui.microchart.AreaMicroChart",multiple:false,visibility:"hidden"},_chartTexts:{type:"sap.m.ListBase",multiple:false,visibility:"hidden"}},associations:{chartTitle:{type:"sap.m.Label",group:"Misc",multiple:false},chartDescription:{type:"sap.m.Label",group:"Misc",multiple:false},unitOfMeasure:{type:"sap.m.Label",group:"Misc",multiple:false}},events:{initialize:{}}}});S.prototype.init=function(){this._bIsinitialized=false;this._bMetaModelLoadAttached=false;this.setProperty("chartType","Area",true);this.setAggregation("_chart",new M.AreaMicroChart(),true);};S.prototype.onBeforeRendering=function(){var o=this.getAggregation("_chart");o.setProperty("width",this.getWidth(),true);o.setProperty("height",this.getHeight(),true);if(o.getMetadata().hasProperty("isResponsive")){o.setProperty("isResponsive",this.getIsResponsive(),true);M._passParentContextToChild(this,o);}};S.prototype.setEntitySet=function(e){if(this.getProperty("entitySet")!==e){this.setProperty("entitySet",e,true);this._initializeMetadata();}return this;};S.prototype.setShowLabel=function(s){if(this.getShowLabel()!==s){this.setProperty("showLabel",s,true);this.getAggregation("_chart").setProperty("showLabel",s,true);this.invalidate();}return this;};S.prototype.setEnableAutoBinding=function(e){this.setProperty("enableAutoBinding",true,true);return this;};S.prototype.setChartType=function(){return this;};S.prototype.propagateProperties=function(){if(a.prototype.propagateProperties){a.prototype.propagateProperties.apply(this,arguments);}this._initializeMetadata();};S.prototype._initializeMetadata=function(){if(!this._bIsinitialized){var m=this.getModel();if(m&&(m instanceof sap.ui.model.odata.v2.ODataModel||m instanceof sap.ui.model.odata.ODataModel)){if(!this._bMetaModelLoadAttached){m.getMetaModel().loaded().then(this._onMetadataInitialized.bind(this));this._bMetaModelLoadAttached=true;}}else if(m){this._onMetadataInitialized();}}};S.prototype._createChartProvider=function(){var m,e;e=this.getEntitySet();m=this.getModel();if(m&&e){this._oChartProvider=new b({entitySet:e,model:m});}};S.prototype._onMetadataInitialized=function(){this._bMetaModelLoadAttached=false;if(!this._bIsinitialized){this._createChartProvider();if(this._oChartProvider){this._oChartViewMetadata=this._oChartProvider.getChartViewMetadata();this._oDataPointAnnotations=this._oChartProvider.getChartDataPointMetadata().additionalAnnotations[this._getDataPointQualifier()];if(this._oChartViewMetadata){this._bIsinitialized=true;this.fireInitialize();if(this.getEnableAutoBinding()){if(this.getChartBindingPath()){this._sBindingPath=this.getChartBindingPath();}else if(this.getEntitySet()){this._sBindingPath='/'+this.getEntitySet();}else{q.sap.log.warning("Neither the property chartBindingPath nor entitySet is set thus the property enableAutoBinding cannot be applied");}}this._createAndBindInnerChart();this._bindChartTexts();}}}};S.prototype._createAndBindInnerChart=function(){if(!this._checkChartMetadata()){q.sap.log.error("Created annotations not valid. Please review the annotations and metadata.");return;}this._buildChartItem("chart",this._oDataPointAnnotations.Value.Path);this._buildChartItem("target",this._oDataPointAnnotations.TargetValue.Path);if(!this._checkThresholdMetadata()){q.sap.log.error("Threshold annotations not ok. Please review annotation and metadata.");return;}this._buildThreshold();};S.prototype._buildThreshold=function(){var o=this._oDataPointAnnotations.CriticalityCalculation;var i=this.getAggregation("_chart");if(this._checkCriticalityCalculationData("Target")){this._buildChartItem("minThreshold",o.DeviationRangeLowValue.Path);this._buildChartItem("maxThreshold",o.DeviationRangeHighValue.Path);this._buildChartItem("innerMinThreshold",o.ToleranceRangeLowValue.Path);this._buildChartItem("innerMaxThreshold",o.ToleranceRangeHighValue.Path);i.getInnerMinThreshold().setProperty("color",V.Good,true);i.getInnerMaxThreshold().setProperty("color",V.Good,true);i.getMinThreshold().setProperty("color",V.Error,true);i.getMaxThreshold().setProperty("color",V.Error,true);}else if(this._checkCriticalityCalculationData("Minimize")){this._buildChartItem("minThreshold",o.ToleranceRangeHighValue.Path);this._buildChartItem("maxThreshold",o.DeviationRangeHighValue.Path);i.getMinThreshold().setProperty("color",V.Good,true);i.getMaxThreshold().setProperty("color",V.Error,true);}else if(this._checkCriticalityCalculationData("Maximize")){this._buildChartItem("minThreshold",o.DeviationRangeLowValue.Path);this._buildChartItem("maxThreshold",o.ToleranceRangeLowValue.Path);i.getMinThreshold().setProperty("color",V.Error,true);i.getMaxThreshold().setProperty("color",V.Good,true);}};S.prototype._checkCriticalityCalculationData=function(e){var o=this._oDataPointAnnotations.CriticalityCalculation;var s=o.ImprovementDirection.EnumMember;var D="com.sap.vocabularies.UI.v1.ImprovementDirectionType/"+e;if(e==="Target"&&s===D){return _(o,"DeviationRangeLowValue","Path")&&_(o,"DeviationRangeHighValue","Path")&&_(o,"ToleranceRangeLowValue","Path")&&_(o,"ToleranceRangeHighValue","Path");}else if(e==="Minimize"&&s===D){return _(o,"DeviationRangeHighValue","Path")&&_(o,"ToleranceRangeHighValue","Path");}else if(e==="Maximize"&&s===D){return _(o,"DeviationRangeLowValue","Path")&&_(o,"ToleranceRangeLowValue","Path");}return false;function _(f,m,p){return!q.isEmptyObject(f)&&!q.isEmptyObject(f[m])&&f[m][p];}};S.prototype._buildChartItem=function(A,p){var P,i;P=new M.AreaMicroChartPoint({x:{path:this._oChartViewMetadata.dimensionFields[0],type:"sap.ui.model.odata.type.Decimal"},y:{path:p,type:"sap.ui.model.odata.type.Decimal"}});i=new M.AreaMicroChartItem({points:{path:this._sBindingPath,template:P,parameters:{countMode:d.None}}});this.getAggregation("_chart").setAggregation(A,i,true);};S.prototype._getDataPointQualifier=function(){var m=[],D,p,Q;if(this._oChartViewMetadata){if(this._oChartViewMetadata.annotation.hasOwnProperty("MeasureAttributes")){m=this._oChartViewMetadata.annotation.MeasureAttributes;var l=m.length;for(var i=0;i<l;i++){if(m[i].DataPoint&&m[i].DataPoint.hasOwnProperty("AnnotationPath")){Q=m[i].DataPoint.AnnotationPath;p=Q.split("#");if(p.length===2){D=p[1];}}}}}return D;};S.prototype._checkChartMetadata=function(){if(this._oChartViewMetadata&&this._oChartViewMetadata.fields&&this._oChartViewMetadata.fields.length>0){return true;}else{q.sap.log.error("Annotations not ok. Please review annotation and metadata.");return false;}};S.prototype._checkThresholdMetadata=function(){if(this._oDataPointAnnotations.CriticalityCalculation&&this._oDataPointAnnotations.CriticalityCalculation.ImprovementDirection&&this._oDataPointAnnotations.CriticalityCalculation.ImprovementDirection.EnumMember){return true;}else{return false;}};S.prototype._bindChartTexts=function(){var t,l,L,D,u,U,B;if(this.getAggregation("_chartTexts")){return;}if(this.getChartDescription()){if(!(sap.ui.getCore().byId(this.getChartDescription())instanceof sap.m.Label)){q.sap.log.error("Control in association chartDescription should be of type sap.m.Label");}}if(this.getChartTitle()){if(!(sap.ui.getCore().byId(this.getChartTitle())instanceof sap.m.Label)){q.sap.log.error("Control in association chartTitle should be of type sap.m.Label");}}if(this.getUnitOfMeasure()){if(!(sap.ui.getCore().byId(this.getUnitOfMeasure())instanceof sap.m.Label)){q.sap.log.error("Control in association unitOfMeasure should be of type sap.m.Label");}}if(q.isEmptyObject(this._oChartViewMetadata)||q.isEmptyObject(this._oChartViewMetadata.annotation)){return;}if(this._oChartViewMetadata.annotation.Title){if(this._oChartViewMetadata.annotation.Title.hasOwnProperty("Path")){t="{"+this._oChartViewMetadata.annotation.Title.Path+"}";}else if(this._oChartViewMetadata.annotation.Title.hasOwnProperty("String")){t=this._oChartViewMetadata.annotation.Title.String;}}if(this._oChartViewMetadata.annotation.Description){if(this._oChartViewMetadata.annotation.Description.hasOwnProperty("Path")){D="{"+this._oChartViewMetadata.annotation.Description.Path+"}";}else if(this._oChartViewMetadata.annotation.Description.hasOwnProperty("String")){D=this._oChartViewMetadata.annotation.Description.String;}}u=this._getUnitOfMeasureAnnotation();if(!!u){if(u.Path){U="{"+u.Path+"}";}else if(u.String){U=u.String;}}if(t||D||U){l=new sap.m.StandardListItem({title:t,description:D,info:U});L=new sap.m.List({items:{path:this._sBindingPath,template:l}});this.setAggregation("_chartTexts",L,true);B=this.getAggregation("_chartTexts").getBinding("items");if(B){B.attachChange(this._setLabels,this);}}};S.prototype._setLabels=function(){var l,t,o,D,u,e,U;if(!this.getAggregation("_chartTexts")){return;}l=this.getAggregation("_chartTexts").getItems();if(l.length>0){t=this.getAggregation("_chartTexts").getItems()[0].getTitle();o=sap.ui.getCore().byId(this.getChartTitle());if(o){if(t){o.setProperty("text",t,false);}else{o.setProperty("text","",false);}}D=this.getAggregation("_chartTexts").getItems()[0].getDescription();e=sap.ui.getCore().byId(this.getChartDescription());if(e){if(D){e.setProperty("text",D,false);}else{e.setProperty("text","",false);}}u=this.getAggregation("_chartTexts").getItems()[0].getInfo();U=sap.ui.getCore().byId(this.getUnitOfMeasure());if(U){if(u){U.setProperty("text",u,false);}else{U.setProperty("text","",false);}}}};S.prototype._getUnitOfMeasureAnnotation=function(){var p,P;if(!this._oDataPointAnnotations){return;}if(this._oDataPointAnnotations.Value&&this._oDataPointAnnotations.Value.Path){P=this._getPropertyAnnotation(this._oDataPointAnnotations.Value.Path);}if(P){for(p in P){if((p.indexOf("ISOCurrency")>-1)||(p.indexOf("Unit")>-1)){return P[p];}}}};S.prototype._getPropertyAnnotation=function(e){var m,E,o,p;m=this.getModel().getMetaModel();E=this._oChartProvider._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(this.getEntitySet());o=m.getODataEntityType(E);p=m.getODataProperty(o,e);return p;};return S;});
