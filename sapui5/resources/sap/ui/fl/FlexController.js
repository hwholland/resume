/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2014-2016 SAP SE. All rights reserved
 */
sap.ui.define(["jquery.sap.global","sap/ui/fl/Persistence","sap/ui/fl/registry/ChangeRegistry","sap/ui/fl/Utils","sap/ui/fl/LrepConnector","sap/ui/fl/Change","sap/ui/fl/Cache","sap/ui/fl/registry/Settings","sap/ui/fl/ChangePersistenceFactory","sap/ui/core/mvc/View","sap/ui/fl/changeHandler/JsControlTreeModifier","sap/ui/fl/changeHandler/XmlTreeModifier","sap/ui/fl/context/ContextManager"],function(q,P,C,U,L,a,b,F,c,V,J,X,d){"use strict";var e=function(s){this._oChangePersistence=undefined;this._sComponentName=s||"";if(this._sComponentName){this._createChangePersistence();}};e.prototype.setComponentName=function(s){this._sComponentName=s;this._createChangePersistence();};e.prototype.getComponentName=function(){return this._sComponentName;};e.prototype.createChange=function(o,f){var g,h,i;if(!f){throw new Error("A flexiblity change cannot be created without a targeted control");}var j=d._getContextIdsFromUrl();if(j.length>1){throw new Error("More than one DesignTime Context is currently active");}var A=U.getAppComponentForControl(f);if(!A){throw new Error("No Application Component found - to offer flexibility the control with the id '"+f.getId()+"' has to have a valid relation to its owning application component.");}var s=f.getId();if(!o.selector){o.selector={};}if(U.hasLocalIdSuffix(f,A)){var l=A.getLocalId(s);if(!l){throw new Error("Generated id attribute found - to offer flexibility a stable control id is needed to assign the changes to, but for this control the id was generated by SAPUI5 "+f.getId());}o.selector.id=l;o.selector.idIsLocal=true;}else{o.selector.id=s;o.selector.idIsLocal=false;}var k=U.getAppDescriptor(f);var m=this.getComponentName();o.reference=m;if(k&&k["sap.app"]){o.componentName=k["sap.app"].componentName||k["sap.app"].id;}else{o.componentName=m;}o.packageName="$TMP";o.context=j.length===1?j[0]:"";g=a.createInitialFileContent(o);h=new a(g);var n=U.getControlType(f);i=this._getChangeHandler(h,n);if(i){i.completeChangeContent(h,o,{modifier:J,appComponent:A});}else{throw new Error('Change handler could not be retrieved for change '+JSON.stringify(o));}return h;};e.prototype.addChange=function(o,f){var g=this.createChange(o,f);this._oChangePersistence.addChange(g);return g;};e.prototype.addPreparedChange=function(o){this._oChangePersistence.addChange(o);return o;};e.prototype.createAndApplyChange=function(o,f){var g=this.addChange(o,f);try{var p={modifier:J,appComponent:U.getAppComponentForControl(f)};this._checkTargetAndApplyChange(g,f,p);}catch(E){this._oChangePersistence.deleteChange(g);throw E;}};e.prototype.saveAll=function(){return this._oChangePersistence.saveDirtyChanges();};e.prototype.processView=function(v,u){var p={unmergedChangesOnly:u};return this.processJsView(v,p);};e.prototype.processJsView=function(v,p){p.appComponent=U.getAppComponentForControl(v);p.appDescriptor=U.getAppDescriptor(v);p.modifier=J;p.view=v;return this.processViewByModifier(p);};e.prototype.processXmlView=function(v,p){var o=sap.ui.getCore().getComponent(p.componentId);var A=U.getAppComponentForControl(o);var m=o.getManifest();p.appComponent=A;p.appDescriptor=m;p.modifier=X;p.view=v;return this.processViewByModifier(p);};e.prototype.processViewByModifier=function(p){p.unmergedChangesOnly=p.unmergedChangesOnly||p.modifier===J;p.cleanMergedChangesAfterwards=p.cleanMergedChangesAfterwards||p.modifier===J;p.viewId=p.modifier.getId(p.view);p.siteId=U.getSiteId(p.appComponent);var g=F.getInstance(this.getComponentName(),p);return g.then(this._resolveGetFlexSettingsInstance.bind(this,p),this._handlePromiseChainError.bind(this,p.view));};e.prototype._resolveGetFlexSettingsInstance=function(p){var g;if(!p.unmergedChangesOnly){g=this._oChangePersistence.getChangesForView(p);}else{g=this._oChangePersistence.getUnmergedChangesForView(p);}return g.then(this._resolveGetChangesForView.bind(this,p));};e.prototype._resolveGetChangesForView=function(p,f){if(!p.unmergedChangesOnly){this._oChangePersistence.clearMergedChanges();}if(!Array.isArray(f)){q.sap.log("No list of changes was passed for processing the flexibility on view: "+p.view);return[];}f.forEach(function(o){try{var s=this._getSelectorOfChange(o);if(!s||!s.id){throw new Error("No selector in change found or no selector ID.");}var g=p.modifier.bySelector(s,p.appComponent,p.view);if(!g){throw new Error("A flexibility change tries to change a non existing control");}this._checkTargetAndApplyChange(o,g,p);}catch(E){this._logApplyChangeError(E,o);}}.bind(this));if(p.cleanMergedChangesAfterwards){this._oChangePersistence.setMergedChanges([]);}return p.view;};e.prototype._getSelectorOfChange=function(o){if(!o||!o.getSelector){return undefined;}return o.getSelector();};e.prototype._logApplyChangeError=function(E,o){var D=o.getDefinition();var s=D.changeType;var t=D.selector.id;var f=D.namespace+D.fileName+"."+D.fileType;var w="A flexiblity change could not be applied.";w+="\nThe displayed UI might not be displayed as intedend.";if(E.message){w+="\n   occurred error message: '"+E.message+"'";}w+="\n   type of change: '"+s+"'";w+="\n   LRep location of the change: "+f;w+="\n   id of targeted control: '"+t+"'";U.log.warning(w,undefined,"sap.ui.fl.FlexController");};e.prototype._checkTargetAndApplyChange=function(o,f,p){var s=p.modifier.getControlType(f);var g=this._getChangeHandler(o,s);if(!g){throw(new Error("A change handler for the given change type does not exist."));}var w=g.applyChange(o,f,p);if(w){this._oChangePersistence.addMergedChange(o.getFullFileIdentifier());}};e.prototype._handlePromiseChainError=function(v,E){U.log.error('Error processing view '+E);return v;};e.prototype._getTargetControlIdOfChange=function(o){if(!o){return undefined;}var s=o.getSelector();if(s){return s.id;}return undefined;};e.prototype.applyChange=function(o,f){var s=U.getControlType(f);var g=this._getChangeHandler(o,s);if(!g){if(o&&f){U.log.warning("Change handler implementation for change not found - Change ignored");}return;}try{g.applyChange(o,f);}catch(h){this._setMergeError(true);U.log.error("Change could not be applied. Merge error detected.");throw h;}};e.prototype._getChangeHandler=function(o,s){var f,g;f=this._getChangeTypeMetadata(o,s);if(!f){return undefined;}g=f.getChangeHandler();return g;};e.prototype._getChangeTypeMetadata=function(o,s){var f,g;f=this._getChangeRegistryItem(o,s);if(!f||!f.getChangeTypeMetadata){return undefined;}g=f.getChangeTypeMetadata();return g;};e.prototype._getChangeRegistryItem=function(o,s){var f,g,l;if(!o||!s){return undefined;}f=o.getChangeType();if(!f||!s){return undefined;}l=o.getLayer();g=this._getChangeRegistry().getRegistryItems({"changeTypeName":f,"controlType":s,"layer":l});if(g&&g[s]&&g[s][f]){return g[s][f];}else if(g&&g[s]){return g[s];}else{return g;}};e.prototype._getChangeRegistry=function(){var i=C.getInstance();i.initSettings(this.getComponentName());return i;};e.prototype.getComponentChanges=function(p){return this._oChangePersistence.getChangesForComponent(p);};e.prototype._createChangePersistence=function(){this._oChangePersistence=c.getChangePersistenceForComponent(this.getComponentName());return this._oChangePersistence;};e.prototype.discardChanges=function(f){var A=U.getCurrentLayer(false);f.forEach(function(o){if(o&&o.getLayer&&o.getLayer()===A){this._oChangePersistence.deleteChange(o);}}.bind(this));return this._oChangePersistence.saveDirtyChanges();};e.prototype.deleteChangesForControlDeeply=function(o){return Promise.resolve();};e.prototype._setMergeError=function(){return F.getInstance(this.getComponentName()).then(function(s){s.setMergeErrorOccured(true);});};return e;},true);
