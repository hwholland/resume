<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta charset="UTF-8">

<title>GanttChartWithTable ODATA</title>

<script id="sap-ui-bootstrap"
	data-sap-ui-libs="sap.gantt, sap.m"
	data-sap-ui-theme="sap_bluecrystal"
	src="../../../resources/sap-ui-core-dbg.js">
</script>

<script src="./test.js"></script>

<script>
	loadRequires();
	defineShapes();
	createPage("Test Page for sap.gantt.GanttChartWithTable ODATA");
	addContentToPage();
	
	function loadRequires() {
		jQuery.sap.require("sap.ui.core.util.MockServer");
		
		jQuery.sap.require("sap.gantt.shape.Group");
		jQuery.sap.declare("sap.gantt.shape.RectangleGroup");
	};

	function defineShapes() {
		sap.ui.define(["sap/gantt/shape/Group" ,"sap/gantt/shape/Rectangle"], function (Group, Rectangle) {
			var RectangleGroup = Group.extend("sap.gantt.shape.RectangleGroup",{});
		  	
			RectangleGroup.prototype.getRLSAnchors = function(oRawData, oProperty, oXAxis, oYAxis, oObjectInfo){
					var shapes = this.getShapes();
					var rectangleShapeClass;
					for(var i in shapes){
						if(shapes[i] instanceof Rectangle){
							rectangleShapeClass = shapes[i];
						}
					}
			
					var _x = rectangleShapeClass.getX(oRawData, oProperty, oXAxis, oYAxis, oObjectInfo);
					var _y = rectangleShapeClass.getY(oRawData, oProperty, oXAxis, oYAxis, oObjectInfo) + rectangleShapeClass.getHeight()/2;
					return {
						startPoint: {
							x: _x,
							y: _y,
							height:rectangleShapeClass.getHeight(oRawData, oProperty, oXAxis, oYAxis, oObjectInfo),
						},
						endPoint: {
							x: _x + rectangleShapeClass.getWidth(oRawData, oProperty, oXAxis, oYAxis, oObjectInfo),
							y: _y,
							height:rectangleShapeClass.getHeight(oRawData, oProperty, oXAxis, oYAxis, oObjectInfo),
						}
					};
			};
			return RectangleGroup;
		}, true);
		
		sap.ui.define(["sap/m/ComboBox", "sap/m/ComboBoxRenderer"], function (ComboBox, ComboBoxRenderer) {
			var GanttComboBox = ComboBox.extend("sap.gantt.ComboBox", {
				updateState: function(sKey) {
					var aItems = this.getItems();
					var sSelectedKey = this.getSelectedKey();
					
					for (var i = aItems.length - 1; i > -1; i--) {
						if (aItems[i].getKey() != sSelectedKey) {
							this.removeItem(aItems[i]);
						}
					}
					
					if (sKey == "created") {
						this.addItem(new sap.ui.core.Item({
							key: "released",
							text: "released"
						}), true);
					} else if (sKey == "released") {
						this.addItem(new sap.ui.core.Item({
							key: "canceled",
							text: "canceled"
						}), true);
						this.addItem(new sap.ui.core.Item({
							key: "completed",
							text: "completed"
						}), true);
					} else if (sKey == "canceled") {
						this.addItem(new sap.ui.core.Item({
							key: "released",
							text: "released"
						}), true);
					} else if (sKey == "completed") {
					} else {
						this.addItem(new sap.ui.core.Item({
							key: "created",
							text: "created"
						}), true);
					}
					
					this.setEnabled(sKey != "completed");
				},
				
				createItem: function(sKey) {
					if (sKey) {
						this.addItem(new sap.ui.core.Item({
							key: sKey,
							text: sKey
						}), true);				
					}
				},
				
				setSelectedKey: function(sKey) {
					this.updateState(sKey);
					this.createItem(sKey);
					
					ComboBox.prototype.setSelectedKey.apply(this, arguments);
				},
				
				renderer: function(oRm, oControl) {
					ComboBoxRenderer.render.apply(this, arguments);
				}
			});
			return GanttComboBox;
		}, true);
	};
 
	function addContentToPage() {
		var sServiceUrl = "http://my.test.service.com/";
		var oMockServer = new sap.ui.core.util.MockServer({
			rootUri : sServiceUrl
		});
		oMockServer.simulate("../../sap/gantt/qunit/data/odata/metadata.xml", {
			sMockdataBaseUrl : "../../sap/gantt/qunit/data/odata/",
			bGenerateMissingMockData : true
		});
		
		oMockServer.start();
		// create data model
		var oDataModel = new sap.ui.model.odata.v2.ODataModel(sServiceUrl);
		
		// create configuration model
		var sPath = window.location.pathname.substr(0, window.location.pathname.lastIndexOf("/")) + "/qunit/data/";
		
		var oDateType = new sap.ui.model.type.Date({pattern: "dd.MM.yyyy"});
		var aShapeConfig = [new sap.gantt.config.Shape({
			key: "task",
			shapeDataName: "Task",
			modeKeys: ["D"],
			level: 10,
			shapeClassName: "sap.gantt.shape.RectangleGroup",
			shapeProperties: {
				time: "{StartDate}",
				endTime: "{EndDate}",
				isDuration: true
			},
			groupAggregation: [new sap.gantt.config.Shape({
				shapeClassName: "sap.gantt.shape.Rectangle",
				shapeProperties: {
					time: "{StartDate}",
					endTime: "{EndDate}",
					fill: "orange",
					isDuration: true
				}
			}), new sap.gantt.config.Shape({
				shapeClassName: "sap.gantt.shape.Text",
				shapeProperties: {
					time: "{StartDate}",
					text: "{Explanation}",
					yBias: 0,				
					xBias: -15,
					textAnchor: "end",		
					fill:"black",
					isDuration: false
				}
			})]
		}), new sap.gantt.config.Shape({
			key: "relationship",
			level: 30,
			shapeDataName: "relationship",
			shapeClassName: "sap.gantt.shape.ext.rls.Relationship",
			shapeProperties: {
				isDuration: false,
				lShapeforTypeFS: true,
				showStart: false,
				showEnd: true,
				stroke: "#000000",
				strokeWidth: 1,
				type: "{RelationType}",
				fromObjectPath:"{PredecRowGuid}",
				toObjectPath:"{SuccRowGuid}",
				fromDataId:"{PredecTaskGuid}",
				toDataId:"{SuccTaskGuid}",
				fromShapeId:"{FromShape}",
				toShapeId:"{ToShape}",	
				title: "{Tooltip}",
				id: "{Guid}"
			}
		})
		];
		
		var oComboBox = new sap.gantt.ComboBox({
			selectedKey: {
				path: "Status",
				model: "data"
			},
			
			selectionChange: function(oEvent) {
				var sKey = oEvent.getParameters().selectedItem.getKey();
				
				this.updateState(sKey);
			}
		});
	
		var oNumberInput = new sap.m.Input({
			type: "Number",
			width: "30px",
			value: "0",
			tooltip: "Row index"
		});
	
		var oStartDateColumn = new sap.ui.table.Column({
			label: "Start Date",
			sortProperty: "StartDate",
			filterProperty: "StartDate",
			filterType: oDateType,
			template: new sap.m.Label({
				text: {
					path: "StartDate",
					model: "data",
					type: oDateType
				},
			})
		});
		
		var bShowColumn = true;
		
		var oShowColumnBtn = new sap.m.Button({
			text: "Hide Start Date column",
			press: function() {
				bShowColumn = !bShowColumn;
				oStartDateColumn.setVisible(bShowColumn);
				if (bShowColumn) {
					oShowColumnBtn.setText("Hide Start Date column");
				} else {
					oShowColumnBtn.setText("Show Start Date column");
				}
			}
		});
		
		var oSelectBtn = new sap.m.Button({
			text: "Select",
			tooltip: "Select",
			press: function() {
				var iSelectedIndex = parseInt(oNumberInput.getValue());
				oGanttChartWithTable.setSelectedIndex(iSelectedIndex);
				
				var iFirstVisibleRow = oGanttChartWithTable.getFirstVisibleRow();
				var iLastVisibleRow = iFirstVisibleRow + oGanttChartWithTable.getVisibleRowCount();
				
				if (iSelectedIndex < iFirstVisibleRow || iSelectedIndex > iLastVisibleRow) {
					oGanttChartWithTable.setFirstVisibleRow(iSelectedIndex);
					oGanttChartWithTable.getRows()[0].getCells()[2].focus();
				} else {
					oGanttChartWithTable.getRows()[iSelectedIndex].getCells()[2].focus();
				}
			}
		});
		
		var oExpandBtn = new sap.m.Button({
			text: "Expand",
			tooltip: "Expand",
			press: function() {
				oGanttChartWithTable.expand(parseInt(oNumberInput.getValue()));
			}
		});
		
		var oCollapseBtn = new sap.m.Button({
			text: "Collapse",
			tooltip: "Collapse",
			press: function() {
				oGanttChartWithTable.collapse(parseInt(oNumberInput.getValue()));
			}
		});
		
		// create control
		var oGanttChartWithTable = new sap.gantt.GanttChartWithTable({
			customToolbarItems: [oNumberInput, oSelectBtn, oExpandBtn, oCollapseBtn, oShowColumnBtn],
			columns: [new sap.ui.table.Column({
				label: "Explanation",
				sortProperty: "Explanation",
				filterProperty: "Explanation",
				template: new sap.m.Label({
					text: {
						path: "Explanation",
						model: "data"
					}
				})
			}), oStartDateColumn
			, new sap.ui.table.Column({
				label: "Status",
				sortProperty: "Status",
				filterProperty: "Status",
				template: oComboBox
			})],
			timeAxis: new sap.gantt.config.TimeAxis({
				planHorizon: new sap.gantt.config.TimeHorizon({
					startTime: "20140628000000",
					endTime: "20170101000000"
				}),
				initHorizon: new sap.gantt.config.TimeHorizon({
					startTime: "20150101000000",
					endTime: "20150615000000"
				})
			}),
			shapes: aShapeConfig,
			shapeDataNames:["Task"],
			rows: {
				path: "data>/ProjectElmSet",
				parameters: {
					/*navigation: {
						"ProjectElmSet": "Children"
					},*/
					treeAnnotationProperties: {
	            		hierarchyLevelFor: "Level",
	    				hierarchyParentNodeFor: "SuperiorGuid",
	    				hierarchyNodeFor: "Guid",
						hierarchyDrillStateFor: "DrillDownState"//this option doesn't work
	            	},
	            	expand: "Task"
				}
			},
			relationships:{
				path: "data>/RelationshipSet"
			}
		});
		var oModeSegmentedButton = sap.ui.jsfragment("sap.gantt.test.CSSModeButton", oGanttChartWithTable);
		oGanttChartWithTable.setModel(oDataModel, "data");
		addFooterContentsToPage(oModeSegmentedButton);
		window.oPage.addContent(oGanttChartWithTable);
	}
</script>
</head>
<body id="body" class="sapUiBody sapUiSizeCompact">
	<div id="content" style="width: 100%; height: 100vh;"></div>
</body>
</html>