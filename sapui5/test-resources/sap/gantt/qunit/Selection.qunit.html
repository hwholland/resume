<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta charset="UTF-8">
		<title>QUnit: Selection Behavior for sap.gantt.GanttChart</title>
		<script id="sap-ui-bootstrap"
			src="../../../../resources/sap-ui-core.js"
			data-sap-ui-theme="sap_bluecrystal"
			data-sap-ui-libs="sap.gantt">
		</script>
		<link rel="stylesheet" type="text/css" href="../../../../resources/sap/ui/thirdparty/qunit.css"/>
		<script src="../../../../resources/sap/ui/thirdparty/qunit.js"></script>
		<script src="../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
		<script src="../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
		<script type="text/javascript">
		// Define group
		sap.ui.define([ "sap/gantt/shape/Group" ], function(Group) {
			var RectangleGroup = Group.extend("sap.test.gantt.RectangleGroup", {
				metadata: {
					properties: {
						enableDnD: {type: "boolean", defaultValue: "true"} 
					}
				}
			});

			RectangleGroup.prototype.getRLSAnchors = function(oRawData, oXAxis,
					oYAxis, oObjectInfo) {
				var shapes = this.getShapes();
				var rectangleShapeClass;
				for ( var i in shapes) {
					if (shapes[i] instanceof sap.gantt.shape.Rectangle) {
						rectangleShapeClass = shapes[i];
					}
				}

				var _x = rectangleShapeClass.getX(oRawData, oXAxis, oYAxis,
						oObjectInfo);
				var _y = rectangleShapeClass.getY(oRawData, oXAxis, oYAxis,
						oObjectInfo)
						+ rectangleShapeClass.getHeight() / 2;
				return {
					startPoint : {
						x : _x,
						y : _y,
						height : rectangleShapeClass.getHeight(oRawData, oXAxis,
								oYAxis, oObjectInfo),
					},
					endPoint : {
						x : _x
								+ rectangleShapeClass.getWidth(oRawData, oXAxis,
										oYAxis, oObjectInfo),
						y : _y,
						height : rectangleShapeClass.getHeight(oRawData, oXAxis,
								oYAxis, oObjectInfo),
					}
				};
			};

			return RectangleGroup;
		}, true);
		</script>
		<script>
		var oData = {
			"root": {
				"id": "root",
				"type": "root",
				"children": [{
					"text": "truck00",
					"id": "0000",
					"activity": [{
						"id": "truck00_01",
						"startTime": "20160329000000",
						"endTime": "20160331000000"
					}]
				},{
					"text": "truck01",
					"id": "0001",
					"activity": [{
						"id": "truck01_01",
						"startTime": "20160331000000",
						"endTime": "20160409000000"
					}]
				},{
					"text": "truck02",
					"id": "0002",
					"activity": [{
						"id": "truck02_01",
						"startTime": "20160409000000",
						"endTime": "20160412000000"
					}]
				},{
					"text": "truck03",
					"id": "0003",
					"activity": [{
						"id": "truck03_01",
						"startTime": "20160411000000",
						"endTime": "20160412000000"
					}]
				},{
					"text": "truck04",
					"id": "0004",
					"activity": [{
						"id": "truck04_01",
						"startTime": "20160412000000",
						"endTime": "20160416000000"
					}]
				},{
					"text": "truck05",
					"id": "0005",
					"activity": [{
						"id": "truck05_01",
						"startTime": "20160416000000",
						"endTime": "20160418000000"
					}]
				},{
					"text": "truck06",
					"id": "0006",
					"activity": [{
						"id": "truck06_01",
						"startTime": "20160412000000",
						"endTime": "20160416000000"
					}]
				},{
					"text": "truck07",
					"id": "0007",
					"activity": [{
						"id": "truck07_01",
						"startTime": "20160412000000",
						"endTime": "20160416000000"
					}]
				}],
				"relationships": [{
					"fromDataId": "0000", 
					"fromObjectPath": "0000", 
					"toDataId": "0001", 
					"toObjectPath": "0001", 
					"relation_type": 1, 
					"fromShapeId": "activity", 
					"toShapeId": "activity", 
					"style": 0, 
					"stroke": "#000000",
					"tooltip": "Finish-to-Start",
					"id": "rls001"
				},
				{
					"fromDataId": "0000", 
					"fromObjectPath": "0000", 
					"toDataId": "0002", 
					"toObjectPath": "0002", 
					"relation_type": 1, 
					"fromShapeId": "activity", 
					"toShapeId": "activity", 
					"style": 0, 
					"stroke": "#000000",
					"tooltip": "Finish-to-Start",
					"id": "rls002"
				}]
			},
			"hierarchyKey": "TRUCK_TRAILER"
		};
		var oModel = new sap.ui.model.json.JSONModel();
		oModel.setData(oData);

		var oShapeConfig = new sap.gantt.config.Shape({
			key: "activity",
			shapeDataName: "activity",
			level: 10,
			shapeClassName: "sap.test.gantt.RectangleGroup",
			shapeProperties: {
				time: "{startTime}",
				endTime: "{endTime}",
				rx: 0,
				ry: 0,
				isDuration: true
			},
			selectedClassName: "sap.gantt.shape.SelectedShape",
			groupAggregation: [new sap.gantt.config.Shape({
				shapeClassName: "sap.gantt.shape.Rectangle",
				shapeProperties: {
					time: "{startTime}",
					endTime: "{endTime}",
					fill: "#A52A2A",
					isDuration: true,
					enableDnD: true
				}
			})]
		});
		
		var oRelationshipConfig = new sap.gantt.config.Shape({
			key: "relationship",
			shapeDataName: "relationship",
			level: 30,
			shapeClassName: "sap.gantt.shape.ext.rls.Relationship",
			shapeProperties: {
				isDuration: false,
				lShapeforTypeFS: true,
				showStart: false,
				showEnd: true,
				strokeWidth: 1,
				type: "{relation_type}",
				fromObjectPath:"{fromObjectPath}",
				toObjectPath:"{toObjectPath}",
				fromDataId:"{fromDataId}",
				toDataId:"{toDataId}",
				fromShapeId:"{fromShapeId}",
				toShapeId:"{toShapeId}"
			}
		});

		var oTimeAxis = new sap.gantt.config.TimeAxis({
			planHorizon: new sap.gantt.config.TimeHorizon({
				startTime: "20160327000000",
				endTime: "20160417060610"
			}),
			initHorizon: new sap.gantt.config.TimeHorizon({
				startTime: "20160327000000",
				endTime: "20160417060610"
			})
		});
		
		var oGanttChartWithTable;
		
		function createGanttChartWithTable () {
			var aColumns = [new sap.ui.table.Column({
				label: "Truck ID",
				sortProperty: "text",
				filterProperty: "text",
				template: new sap.m.Label({
					text: {
						path: "text",
						model: "test"
					}
				})
			})];	
			
			oGanttChartWithTable = new sap.gantt.GanttChartWithTable({
				timeAxis: oTimeAxis,
				//Set the height of Gantt Chart to 200px, It's aimed at not let all rows shown in visible area.
				//Then we can test selection behavior in invisible area.
				height: "200px",
				columns: aColumns,
				shapeDataNames: ["activity"],
				shapes: [oShapeConfig, oRelationshipConfig],
				rows: {
					path: "test>/root",
					parameters: {
						arrayNames: ["children"]
					}
				},
				relationships:{
					path: "test>/root/relationships"
				}
			});
			oGanttChartWithTable.setModel(oModel, "test");
			oGanttChartWithTable.placeAt('content');
			sap.ui.getCore().applyChanges();
		};
		
		function destroyGanttChartWithTable () {
			oGanttChartWithTable.destroy();
			sap.ui.getCore().applyChanges();
		};
		
		////////////////// test start///////////////////////
		//qutils.delayTestStart();
		module("Test selection methods", {
			setup: createGanttChartWithTable,
			teardown: destroyGanttChartWithTable
		});

		test("Test method getSelectedRows()" , function () {
			oGanttChartWithTable._oTT.clearSelection()
			deepEqual(oGanttChartWithTable._oTT.getSelectedIndices(), [], "No row is selected.");

			var oBinding = oGanttChartWithTable._oTT.getBinding("rows");
			oGanttChartWithTable._oTT.setSelectionInterval(0, oBinding.getLength() - 1);

			deepEqual(oGanttChartWithTable._oTT.getSelectedIndices(), [0,1,2,3,4,5,6,7], "All selected indexs are correct.");
			strictEqual(oGanttChartWithTable._oTT.getSelectedIndices().length, oGanttChartWithTable.getSelectedRows().length, "Gantt chart selection is equal to its tree table selection.");
			strictEqual(oGanttChartWithTable.getSelectedRows().length, 8, "All rows is selected.");

			oGanttChartWithTable._oTT.setSelectionInterval(6, 6);
			deepEqual(oGanttChartWithTable._oTT.getSelectedIndices(), [6], "The sixth row is selected.");
		});

		test("Test method deselectRows()", 3, function () { //3
			// select 4 rows by id
			oGanttChartWithTable.selectRows(["0000", "0002", "0004", "0006"]);
			deepEqual(oGanttChartWithTable.getSelectedRows().map(function (oItem) {
				return oItem.id;
			}), ["0000", "0002", "0004", "0006"]);
			
			// deselect 2 rows by id
			oGanttChartWithTable.deselectRows(["0000", "0004"]);
			deepEqual(oGanttChartWithTable.getSelectedRows().map(function(oItem) {
				return oItem.id;
			}), ["0002", "0006"]);
			
			// deselect all rows by calling deselectRows without param
			oGanttChartWithTable.deselectRows();
			deepEqual(oGanttChartWithTable.getSelectedRows(), []);
		});

		test("Test method deselectShapes()", 3, function () {
			// select 5 shapes by id
			oGanttChartWithTable.selectShapes(["truck00_01", "truck01_01", "truck02_01", "truck03_01", "truck07_01"]);
			deepEqual(oGanttChartWithTable.getSelectedShapes()["activity"].map(function(oItem) {
				return oItem.shapeData.id;
			}), ["truck00_01", "truck01_01", "truck02_01", "truck03_01", "truck07_01"]);
			
			// deselect 2 shapes by id
			oGanttChartWithTable.deselectShapes(["truck00_01", "truck02_01"]);
			deepEqual(oGanttChartWithTable.getSelectedShapes()["activity"].map(function(oItem) {
				return oItem.shapeData.id;
			}), ["truck01_01", "truck03_01", "truck07_01"]);
			
			// deselect all shape by calling deselectShapes without param
			oGanttChartWithTable.deselectShapes();
			deepEqual(oGanttChartWithTable.getSelectedShapes(), {});
		});
		
		test("Test method selectRowsAndShapes()", 4, function () {
			// select 2 rows and shape within them
			oGanttChartWithTable.selectRowsAndShapes(["0000", "0002", "0004", "0006"]);
			deepEqual(oGanttChartWithTable.getSelectedRows().map(function (oItem) {
				return oItem.id;
			}), ["0000", "0002", "0004", "0006"]);
			deepEqual(oGanttChartWithTable.getSelectedShapes()["activity"].map(function(oItem) {
				return oItem.shapeData.id;
			}), ["truck00_01", "truck02_01", "truck04_01", "truck06_01"]);

			//deselect all rows by passing empty array of ids
			oGanttChartWithTable.selectRowsAndShapes();
			deepEqual(oGanttChartWithTable.getSelectedRows(), []);
			deepEqual(oGanttChartWithTable.getSelectedShapes(), {});
		});
		
		test("Test method selectRelationships()", 4, function () {
			// select 2 relationships
			oGanttChartWithTable.selectRelationships(["rls001", "rls002"]);
			deepEqual(oGanttChartWithTable.getSelectedRelationships().map(function (oItem) {
				return oItem.id;
			}), ["rls001", "rls002"]);

			//deselect one of those two relationships
			oGanttChartWithTable.deselectRelationships(["rls001"]);
			deepEqual(oGanttChartWithTable.getSelectedRelationships().map(function (oItem) {
				return oItem.id;
			}), ["rls002"]);
			
			//deselect by passing empty array of ids in api selectRelationships
			oGanttChartWithTable.selectRelationships([], true);
			deepEqual(oGanttChartWithTable.getSelectedRelationships(), []);

			//deselect by passing empty array of ids in api deselectRelationships
			oGanttChartWithTable.selectRelationships(["rls001", "rls002"]);
			oGanttChartWithTable.deselectRelationships();
			deepEqual(oGanttChartWithTable.getSelectedRelationships(), []);
		});
		</script>
	</head>
	<body>
		<div id="qunit"></div>
		<div id="content" class="sapUiSizeCompact" style="width: 98vw; height: 200px; margin-bottom: 40px"></div>
		<div id="UIArea0"></div>
	</body>
</html>