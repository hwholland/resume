<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta charset="UTF-8">

		<title>QUnit: Example - sap.gantt</title>

		<script id="sap-ui-bootstrap"
			src="../../../../../resources/sap-ui-core.js"
			data-sap-ui-theme="sap_bluecrystal"
			data-sap-ui-noConflict="true"
			data-sap-ui-rtl="true"
			data-sap-ui-libs="sap.gantt">
		</script>

		<link rel="stylesheet" type="text/css" href="../../../../../resources/sap/ui/thirdparty/qunit.css"/>
		<script src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
		<script src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
		<script src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
		<script>
		jQuery.sap.require("sap.ui.core.format.DateFormat");
			sap.ui.require([
				"sap/gantt/misc/AxisTime",
				"sap/gantt/shape/Rectangle",
				"sap/gantt/config/Shape",
				"sap/gantt/GanttChart",
				"sap/ui/thirdparty/sinon",
				"sap/ui/thirdparty/sinon-qunit"
					], function (axistime, rectangle, shape, ganttChart) {
					"use strict";

					QUnit.module("Test sap.gantt.misc.AxisTime in RTL mode", {
						setup: function () {
							var config = sap.ui.getCore().getConfiguration();
							this.originalLanguage = config.getLanguage();
							config.setLanguage("en");
							// construct your input data and output data
							this.months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
							this.date = new Date(2013,11,30,12,0,0,0);
							this.startDate = d3.time.day.offset(this.date, -5);
							this.endDate = d3.time.day.offset(this.date, +5)
							this.axisX = new axistime([this.startDate, this.endDate], [100, 200], 2, 10, null, null);
							this.axisX2 = this.axisX.clone();
							this.axisX2.setZoomOrigin(0).setZoomRate(1);
						},
						teardown: function () {
							var config = sap.ui.getCore().getConfiguration();
							config.setLanguage(this.originalLanguage);
							this.originalLanguage = undefined;
							this.axisX = undefined;
							this.axisX2 = undefined;
						}
					});

					QUnit.test("test for AxisTime in RTL mode", function (assert) {
						// assertion for AxisTime with zoom
						assert.strictEqual(this.axisX.timeToView(this.date), 80, "Test AxisTime: timeToView with zoom");
						assert.strictEqual(this.axisX.viewToTime(80).valueOf(), this.date.valueOf(), "Test AxisTime: viewToTime with zoom");
						assert.strictEqual(this.axisX.timeToView(this.axisX.viewToTime(120)), 120, "Test AxisTime: timeToView(viewToTime) with zoom");
						assert.strictEqual(this.axisX.viewToTime(this.axisX.timeToView(this.date)).valueOf(), this.date.valueOf(), "Test AxisTime: viewToTime(timeToView) with zoom");
						assert.strictEqual(this.axisX.getViewRange()[0] === 180 && this.axisX.getViewRange()[1] === 380, true, "Test AxisTime: getViewRange with zoom");
						
						// assertion for AxisTime with start/end value
						assert.strictEqual(this.axisX2.viewToTime(100).valueOf(), this.startDate.valueOf(), "Test AxisTime: viewToTime with start value");
						assert.strictEqual(this.axisX2.viewToTime(0).valueOf(), this.endDate.valueOf(), "Test AxisTime: viewToTime with end value");
						assert.strictEqual(this.axisX2.timeToView(this.axisX2.viewToTime(100)), 100, "Test AxisTime: timeToView(viewToTime) with start value");
						assert.strictEqual(this.axisX2.timeToView(this.axisX2.viewToTime(200)), 200, "Test AxisTime: timeToView(viewToTime) with end value");
						assert.strictEqual(this.axisX2.getViewRange()[0] === 100 && this.axisX2.getViewRange()[1] === 200, true, "Test AxisTime: getViewRange");

						// assertion for Tick Time Interval
						var labelResult20 = JSON.stringify(this.axisX2.getTickTimeIntervalLabel(20));
						var labelTarget20 = '[[],[]]';
						assert.strictEqual(labelResult20, labelTarget20, "Test AxisTime: getTickTimeIntervalLabel with level 20");

						var labelResult19 = this.axisX2.getTickTimeIntervalLabel(19)[1][0];
						var targetdate19 = new Date(2014,0,1,0,0,0,0);
						var targetvalue19 = getValue(targetdate19, this.startDate, this.endDate, 100, 200);
						assert.strictEqual(labelResult19.date.toGMTString(), targetdate19.toGMTString(), "Test AxisTime: getTickTimeIntervalLabel with level 19 compare date");
						assert.strictEqual(labelResult19.value, targetvalue19, "Test AxisTime: getTickTimeIntervalLabel with level 19 compare value");
						assert.strictEqual(labelResult19.label, "January", "Test AxisTime: getTickTimeIntervalLabel with level 19 compare label");

						var labelResult18 = this.axisX2.getTickTimeIntervalLabel(18)[1][0];
						var targetdate18 = new Date(2014,0,1,0,0,0,0);
						var targetvalue18 = getValue(targetdate18, this.startDate, this.endDate, 100, 200);
						assert.strictEqual(labelResult18.date.toGMTString(), targetdate18.toGMTString(), "Test AxisTime: getTickTimeIntervalLabel with level 18 compare date");
						assert.strictEqual(labelResult18.value, targetvalue18, "Test AxisTime: getTickTimeIntervalLabel with level 18 compare value");
						assert.strictEqual(labelResult18.label, "January", "Test AxisTime: getTickTimeIntervalLabel with level 18 compare label");

						var labelResult17_0 = this.axisX2.getTickTimeIntervalLabel(17)[0][0];
						var targetdate17_0 = new Date(2014,0,1,0,0,0,0);
						var targetvalue17_0 = getValue(targetdate17_0, this.startDate, this.endDate, 100, 200);
						var targetlabel17_0 = new Date(2014,0,1,0,0,0,0).getFullYear().toString();
						assert.strictEqual(labelResult17_0.date.toGMTString(), targetdate17_0.toGMTString(), "Test AxisTime: getTickTimeIntervalLabel with level 17 compare date large");
						assert.strictEqual(labelResult17_0.value, targetvalue17_0, "Test AxisTime: getTickTimeIntervalLabel with level 17 compare value large");
						assert.strictEqual(labelResult17_0.label, targetlabel17_0, "Test AxisTime: getTickTimeIntervalLabel with level 17 compare label large");

						var labelResult17_1 = this.axisX2.getTickTimeIntervalLabel(17)[1][0];
						var targetdate17_1 = new Date(2014,0,1,0,0,0,0);
						var targetvalue17_1 = getValue(targetdate17_1, this.startDate, this.endDate, 100, 200);
						var targetlabel17_1 = this.months[new Date(2014,0,1,0,0,0,0).getMonth()];
						assert.strictEqual(labelResult17_1.date.toGMTString(), targetdate17_1.toGMTString(), "Test AxisTime: getTickTimeIntervalLabel with level 17 compare date small");
						assert.strictEqual(labelResult17_1.value, targetvalue17_1, "Test AxisTime: getTickTimeIntervalLabel with level 17 compare value small");
						assert.strictEqual(labelResult17_1.label, targetlabel17_1, "Test AxisTime: getTickTimeIntervalLabel with level 17 compare label small");

						var levelTarget = [20,20,20,20,19,18,17,16,15,14,13,12,11,10,9,8,6,5,4,3,2];
							for(var i = -10; i <= 10; i++) {
								var rate = Math.pow(2, i);
								this.axisX2.setZoomRate(rate);
								var levelResult = this.axisX2.getCurrentTickTimeIntervalLevel();
								assert.strictEqual(levelResult, levelTarget[i+10], "Test AxisTime: getCurrentTickTimeIntervalLevel with rate of " + rate);
						}
					});

					QUnit.module("Test sap.gantt.shape.Rectangle in RTL mode", {
						setup: function () {
							var config = sap.ui.getCore().getConfiguration();
							this.originalLanguage = config.getLanguage();
							config.setLanguage("en");
							this.date = new Date(2013,11,30,12,0,0,0);
							this.startDate = d3.time.day.offset(this.date, -5);
							this.endDate = d3.time.day.offset(this.date, +5);
							this.rectangle = new rectangle({endTime: new Date(2013,11,27,0,0,0,0)});
							this.rectangle.mShapeConfig = new shape();
							this.rectangle.mChartInstance = new sap.gantt.GanttChart({
								timeAxis: new sap.gantt.config.TimeAxis({
									planHorizon: new sap.gantt.config.TimeHorizon({
										startTime: this.startDate,
										endTime: this.endDate
									}),
									initHorizon: new sap.gantt.config.TimeHorizon({
										startTime: this.startDate,
										endTime: this.endDate
									})
								})
							});
						},
						teardown: function () {
							var config = sap.ui.getCore().getConfiguration();
							config.setLanguage(this.originalLanguage);
							this.originalLanguage = undefined;
						}
					});

					QUnit.test("test Rectangle in RTL mode", function (assert) {
						assert.strictEqual(this.rectangle.getX(), 191); //TODO: add more cases
					});
				});

			//to get the px of the ticks
			//startdate and enddate are the start and end of the time period
			//date is the expected result date
			//start and end are the start and end of the px
			function getValue (date, startdate, enddate, start, end) {
				var minus = Date.parse(date) - Date.parse(startdate);
				var total = Date.parse(enddate) - Date.parse(startdate);
				return 200 - ((end - start) / total * minus + start);
			}
		</script>

	</head>
	<body>
		<div id="qunit"></div>
	</body>
</html>
