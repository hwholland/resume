<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta charset="UTF-8">

		<title>QUnit: Example - sap.gantt</title>

		<script id="sap-ui-bootstrap"
			src="../../../../../resources/sap-ui-core.js"
			data-sap-ui-theme="sap_bluecrystal"
			data-sap-ui-noConflict="true"
			data-sap-ui-libs="sap.gantt">
		</script>

		<link rel="stylesheet" type="text/css" href="../../../../../resources/sap/ui/thirdparty/qunit.css"/>
		<script src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
		<script src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
		<script src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
		<script>
/*		if(!(sap.ui.Device.browser.internet_explorer && sap.ui.Device.browser.version <= 8)) {
            jQuery.sap.require("sap.ui.qunit.qunit-coverage");
      }		*/	
		jQuery.sap.require("sap.ui.core.format.DateFormat");
			sap.ui.require([
				"sap/gantt/misc/AxisTime",
				"sap/gantt/config/TimeHorizon",
				"sap/ui/thirdparty/sinon",				
				"sap/ui/thirdparty/sinon-qunit"
					], function (axistime, TimeHorizon) {
					"use strict";

					QUnit.module("Test sap.gantt.misc.AxisTime", {
						setup: function () {
							var config = sap.ui.getCore().getConfiguration();
							this.originalLanguage = config.getLanguage();
							config.setLanguage("en");
						},
						teardown: function () {
							var config = sap.ui.getCore().getConfiguration();
							config.setLanguage(this.originalLanguage);
							this.originalLanguage = undefined;
						}
					});

					QUnit.test("test for AxisTime", function (assert) {
						// construct your input data and output data
						var months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
						var date = new Date(2013,11,30,12,0,0,0);
						var startDate = d3.time.day.offset(date, -5);
						var endDate = d3.time.day.offset(date, +5);
						var oPlanHorizon = new TimeHorizon ({
							startTime: "20150101000000",
							endTime: "20170101000000"
						});
						var dstH = [oPlanHorizon, oPlanHorizon];
						sap.gantt.config.DEFAULT_LOCALE_CET.setDstHorizons(dstH);
						sap.gantt.config.DEFAULT_LOCALE_CET.setUtcdiff("010000");
						var axisX = new axistime([startDate, endDate], [100, 200], 2, 10, 0, sap.gantt.config.DEFAULT_LOCALE_CET);
						var axisX2 = axisX.clone();
						axisX2.setZoomOrigin(0).setZoomRate(1);
						var newDate = new Date(2016,11,30,12,0,0,0);
						var newStartDate = d3.time.day.offset(newDate, -5);
						var newEndDate = d3.time.day.offset(newDate, +5)
						var axisX3 = new axistime([newStartDate, newEndDate], [100, 200], 2, 10, 0, sap.gantt.config.DEFAULT_LOCALE_CET);		
						newStartDate = d3.time.day.offset(date, -5);
						newEndDate = d3.time.day.offset(date, +900);
						var axisX4 = new axistime([newStartDate, newEndDate], [100, 200], 2, 10, 0, sap.gantt.config.DEFAULT_LOCALE_CET);
						newDate = new Date(2016,1,30,12,0,0,0);
						var newStartDate = d3.time.day.offset(newDate, -5);
						var newEndDate = d3.time.day.offset(newDate, +5)
						var axisX5 = new axistime([newStartDate, newEndDate], [100, 200], 2, 10, 0, sap.gantt.config.DEFAULT_LOCALE_CET);	

						// assertion for AxisTime with zoom
						assert.strictEqual(axisX.timeToView(date), 280, "Test AxisTime: timeToView with zoom");
						assert.strictEqual(axisX.viewToTime(280).valueOf(), date.valueOf(), "Test AxisTime: viewToTime with zoom");
						assert.strictEqual(axisX.timeToView(axisX.viewToTime(280)), 280, "Test AxisTime: timeToView(viewToTime) with zoom");
						assert.strictEqual(axisX.viewToTime(axisX.timeToView(date)).valueOf(), date.valueOf(), "Test AxisTime: viewToTime(timeToView) with zoom");
						assert.strictEqual(axisX.getViewRange()[0] === 180 && axisX.getViewRange()[1] === 380, true, "Test AxisTime: getViewRange with zoom");

						// assertion for AxisTime with start/end value
						assert.strictEqual(axisX2.viewToTime(100).valueOf(), startDate.valueOf(), "Test AxisTime: viewToTime with start value");
						assert.strictEqual(axisX2.viewToTime(200).valueOf(), endDate.valueOf(), "Test AxisTime: viewToTime with end value");
						assert.strictEqual(axisX2.timeToView(axisX2.viewToTime(100)), 100, "Test AxisTime: timeToView(viewToTime) with start value");
						assert.strictEqual(axisX2.timeToView(axisX2.viewToTime(200)), 200, "Test AxisTime: timeToView(viewToTime) with end value");
						assert.strictEqual(axisX2.getViewRange()[0] === 100 && axisX2.getViewRange()[1] === 200, true, "Test AxisTime: getViewRange");
						assert.strictEqual(axisX2.getCurrentTickTimeIntervalKey(), "2week", "Test AxisTime: getCurrentTickTimeIntervalKey");
						//assert.strictEqual(axisX2.getNowLabel(), 200, "Test AxisTime: getNowLabel");

						// assertion for Tick Time Interval
						var labelResult20 = JSON.stringify(axisX2.getTickTimeIntervalLabel(20));
						var labelTarget20 = '[[],[]]';
						assert.strictEqual(labelResult20, labelTarget20, "Test AxisTime: getTickTimeIntervalLabel with level 20");

						labelResult20 = JSON.stringify(axisX2.getTickTimeIntervalLabel(20,[0,2042]));
						labelTarget20 = '[[],[]]';
						assert.strictEqual(labelResult20, labelTarget20, "Test AxisTime: getTickTimeIntervalLabel with level 20, time boundary");	

						var labelResult10 = axisX3.getTickTimeIntervalLabel(10,undefined,[0,2042])[0][0];
						var labelTarget10 = new Date(2017,0,1,0,0,0,0);;
						assert.strictEqual(labelResult10.date.toGMTString(), labelTarget10.toGMTString(), "Test AxisTime: getTickTimeIntervalLabel with level 10 compare date");
						assert.strictEqual(labelResult10.value, 309, "Test AxisTime: getTickTimeIntervalLabel with level 10 compare value");
						assert.strictEqual(labelResult10.label, "January 2017", "Test AxisTime: getTickTimeIntervalLabel with level 10 compare label");		

						var labelResult8 = axisX4.getTickTimeIntervalLabel(8,undefined,[0,2042])[0][0];
						var labelTarget8 = new Date(2011,9,4,0,0,0,0);

						assert.strictEqual(labelResult8.date.toGMTString(), labelTarget8.toGMTString(), "Test AxisTime: getTickTimeIntervalLabel with level 8 compare date");
						assert.strictEqual(labelResult8.value, 0, "Test AxisTime: getTickTimeIntervalLabel with level 8 compare value");
						assert.strictEqual(labelResult8.label, "Tuesday 4.10.2011", "Test AxisTime: getTickTimeIntervalLabel with level 8 compare label");	

						var labelResult12 = axisX5.getTickTimeIntervalLabel(12,undefined,[0,2042])[0][0];
						var labelTarget12 = new Date(2016,1,30,0,0,0,0);

						assert.strictEqual(labelResult12.date.toGMTString(), labelTarget12.toGMTString(), "Test AxisTime: getTickTimeIntervalLabel with level 12 compare date");
						assert.strictEqual(labelResult12.value, 268, "Test AxisTime: getTickTimeIntervalLabel with level 12 compare value");
						assert.strictEqual(labelResult12.label, "March 2016", "Test AxisTime: getTickTimeIntervalLabel with level 12 compare label");
						var labelResult19 = axisX2.getTickTimeIntervalLabel(19)[1][0];
						var targetdate19 = new Date(2014,0,1,0,0,0,0);
						var targetvalue19 = getValue(targetdate19, startDate, endDate, 100, 200);
						//var targetlabel19 = new Date(2014,0,1,0,0,0,0);
						assert.strictEqual(labelResult19.date.toGMTString(), targetdate19.toGMTString(), "Test AxisTime: getTickTimeIntervalLabel with level 19 compare date");
						assert.strictEqual(labelResult19.value, targetvalue19, "Test AxisTime: getTickTimeIntervalLabel with level 19 compare value");
						assert.strictEqual(labelResult19.label, "January", "Test AxisTime: getTickTimeIntervalLabel with level 19 compare label");

						var labelResult18 = axisX2.getTickTimeIntervalLabel(18)[1][0];
						var targetdate18 = new Date(2014,0,1,0,0,0,0);
						var targetvalue18 = getValue(targetdate18, startDate, endDate, 100, 200);
						//var targetlabel18 = new Date(2014,0,1,0,0,0,0);
						assert.strictEqual(labelResult18.date.toGMTString(), targetdate18.toGMTString(), "Test AxisTime: getTickTimeIntervalLabel with level 18 compare date");
						assert.strictEqual(labelResult18.value, targetvalue18, "Test AxisTime: getTickTimeIntervalLabel with level 18 compare value");
						assert.strictEqual(labelResult18.label, "January", "Test AxisTime: getTickTimeIntervalLabel with level 18 compare label");

						var labelResult17_0 = axisX2.getTickTimeIntervalLabel(17)[0][0];
						var targetdate17_0 = new Date(2014,0,1,0,0,0,0);
						var targetvalue17_0 = getValue(targetdate17_0, startDate, endDate, 100, 200);
						var targetlabel17_0 = new Date(2014,0,1,0,0,0,0).getFullYear().toString();
						assert.strictEqual(labelResult17_0.date.toGMTString(), targetdate17_0.toGMTString(), "Test AxisTime: getTickTimeIntervalLabel with level 17 compare date large");
						assert.strictEqual(labelResult17_0.value, targetvalue17_0, "Test AxisTime: getTickTimeIntervalLabel with level 17 compare value large");
						assert.strictEqual(labelResult17_0.label, targetlabel17_0, "Test AxisTime: getTickTimeIntervalLabel with level 17 compare label large");

						var labelResult17_1 = axisX2.getTickTimeIntervalLabel(17)[1][0];
						var targetdate17_1 = new Date(2014,0,1,0,0,0,0);
						var targetvalue17_1 = getValue(targetdate17_1, startDate, endDate, 100, 200);
						var targetlabel17_1 = months[new Date(2014,0,1,0,0,0,0).getMonth()];
						assert.strictEqual(labelResult17_1.date.toGMTString(), targetdate17_1.toGMTString(), "Test AxisTime: getTickTimeIntervalLabel with level 17 compare date small");
						assert.strictEqual(labelResult17_1.value, targetvalue17_1, "Test AxisTime: getTickTimeIntervalLabel with level 17 compare value small");
						assert.strictEqual(labelResult17_1.label, targetlabel17_1, "Test AxisTime: getTickTimeIntervalLabel with level 17 compare label small");

						var levelTarget = [20,20,20,20,19,18,17,16,15,14,13,12,11,10,9,8,6,5,4,3,2];
							for(var i = -10; i <= 10; i++) {
							var rate = Math.pow(2, i);
							axisX2.setZoomRate(rate);
							var levelResult = axisX2.getCurrentTickTimeIntervalLevel();
							// console.log(levelResult);
							assert.strictEqual(levelResult, levelTarget[i+10], "Test AxisTime: getCurrentTickTimeIntervalLevel with rate of " + rate);
						}
					});
				});

			//to get the px of the ticks
			//startdate and enddate are the start and end of the time period
			//date is the expected result date
			//start and end are the start and end of the px
			function getValue (date, startdate, enddate, start, end) {
				var minus = Date.parse(date) - Date.parse(startdate);
				var total = Date.parse(enddate) - Date.parse(startdate);
				return (end - start) / total * minus + start;
			}
		</script>

	</head>
	<body>
		<div id="qunit"></div>
	</body>
</html>
