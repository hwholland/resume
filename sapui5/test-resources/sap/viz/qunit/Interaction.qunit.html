<!DOCTYPE HTML>
<!-- 
  Tested control/class: sap.viz.ui5.Bar
-->

<html lang='en'>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script id="sap-ui-bootstrap" type="text/javascript"
  src="../../../../resources/sap-ui-core.js"
  data-sap-ui-theme="sap_bluecrystal" data-sap-ui-libs="sap.ui.core,sap.ui.commons,sap.viz">
  
</script>
<link rel="stylesheet" href="../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen" />
<script type="text/javascript" src="../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script type="text/javascript" src="../../../../resources/sap/ui/qunit/qunit-junit.js"></script>

<script type="text/javascript" src="../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
<script type="text/javascript" src="./js/data.js"></script>

<!-- Control initialization -->
<script language="javascript">
module('selection');

asyncTest("Select One dimension", function(){
      var oChart = createChart( sap.viz.ui5.Bar, {
        dataset : getDataset('a1a2m1')
      });
      oChart.placeAt("content");
      oChart.attachInitialized(function(){
          var selected = [{
      	    data : {
      	    'Color' : 'Red',
      	    'Revenue' : '*'
      	    }
      	  }];
      	  oChart.selection(selected);
      	  var actual = oChart.selection();
      	  var expected = [ {
            data : {
              Color : "Red",
              Product : "Car",
              'Revenue': 46
            }
          }, {
            data : {
              Color : "Red",
              Product : "Truck",
              'Revenue': 72
            } 
          }];
          deepEqual(actual, expected, 'Selected Data as expected.');
          cleanChart(oChart);
          start();
      });	  
});

asyncTest("Select One Measure", function(){
    var oChart = createChart( sap.viz.ui5.Bar, {
        dataset : getDataset('a1a2m1')
      });
    oChart.placeAt("content");
    oChart.attachInitialized(function(){
        var selected = [{
            data : {
            'Revenue' : '*'
            }
          }];
          oChart.selection(selected);
          var actual = oChart.selection();
          deepEqual(actual.length, 4, 'Selected Data as expected.');
          cleanChart(oChart);
          start();
    });
    
});

var oChart, vizOptions;
module("Interaction Properties.", {
  setup : function() {
    oChart = createChart( sap.viz.ui5.Bar, {
      interaction : {
        selectability : {
          mode : 'single'
        }
      },
      xAxis: {
        lineSize: 42,
        gridline: {
          size:42
        }
      },
      dataset : getDataset('a1a2m1')
    });
  },
  teardown : function() {
    cleanChart(oChart);
  }
});

test("Check Interaction properties - single", function() { 
  oChart = createChart( sap.viz.ui5.Bar, {
    interaction : {
      selectability : {
        mode : 'single'
      }
    },
    dataset : getDataset('a1a2m1')
  });
  //Get Options from bar chart
  vizOptions = oChart._getOptions();

  //Viz chart should receive the following options.
  var orignOptions = {
     interaction : {
       selectability : {
         mode : 'single'
       }
     }
  };
  deepEqual(vizOptions.interaction, orignOptions.interaction, "Interaction properties should be the same.");
});

test("Check size settings", function() {
  equal(oChart.getXAxis().getLineSize(), 42, "XAxis lineSize should match value set in constructor");
  equal(oChart.getXAxis().getGridline().getSize(), 42, "XAxis gridline size should match value set in constructor");
  
  // set sizes as int via JS API
  oChart.getXAxis().setLineSize(21);
  oChart.getXAxis().getGridline().setSize(21);
  equal(oChart.getXAxis().getLineSize(), 21, "XAxis lineSize should match value set via API");
  equal(oChart.getXAxis().getGridline().getSize(), 21, "XAxis gridline size should match value set via API");

  // set sizes as string via JS API (old API)
  oChart.getXAxis().setLineSize("37");
  oChart.getXAxis().getGridline().setSize("37");
  equal(oChart.getXAxis().getLineSize(), 37, "XAxis lineSize should match value set via API");
  equal(oChart.getXAxis().getGridline().getSize(), 37, "XAxis gridline size should match value set via API");
  
  // set sizes as empty strings via JS API (old API)
  oChart.getXAxis().setLineSize("");
  oChart.getXAxis().getGridline().setSize("");
  equal(oChart.getXAxis().getLineSize(), 1, "XAxis lineSize should match value set via API");
  equal(oChart.getXAxis().getGridline().getSize(), 1, "XAxis gridline size should match value set via API");
  
  // set sizes as string via XMLView
  var xml = 
      '<mvc:View xmlns:viz="sap.viz.ui5" xmlns:mvc="sap.ui.core.mvc" xmlns="sap.viz.ui5.types">'
    + '  <viz:Bar>'
    + '    <viz:xAxis>'
    + '      <Axis lineSize="29" >'
    + '        <gridline>'
    + '          <Axis_gridline size="29" />'
    + '        </gridline>'
    + '      </Axis>'
    + '    </viz:xAxis>'
    + '  </viz:Bar>'
    + '</mvc:View>';
  oChart = sap.ui.xmlview({viewContent:xml}).getContent()[0];
  equal(oChart.getXAxis().getLineSize(), 29, "XAxis lineSize should match value set via API");
  equal(oChart.getXAxis().getGridline().getSize(), 29, "XAxis gridline size should match value set via API");
});

test("Set selection mode via controller.interaction_selectability - multiple (via JS API)", function() {
  oChart.getInteraction().setSelectability(new sap.viz.ui5.types.controller.Interaction_selectability({
    // node: old type didn't support 'inclusive', therefore we have to test wit hone of the old values
    mode : sap.viz.ui5.types.controller.Interaction_selectability_mode.multiple
  }));
  
  //Get Options from bar chart
  vizOptions =  oChart.getInteraction().getSelectability().getMode();

  //Viz chart should receive the following options.
  var orignOptions = 'multiple';
  deepEqual(vizOptions, orignOptions, "Interaction properties should be the same.");
});

test("Set selection mode via controller.interaction_selectability - multiple (via XMLView)", function() {
  // an XMLView that creates a Bar chart wit thhe old controller.Interaction type  
  var xml = 
    '<mvc:View xmlns:viz="sap.viz.ui5" xmlns:mvc="sap.ui.core.mvc" xmlns="sap.viz.ui5.types.controller">'
    + '  <viz:Bar>'
    + '    <viz:interaction>'
    + '      <Interaction>'
    + '        <selectability>'
    + '          <Interaction_selectability mode="multiple" />'
    + '        </selectability>'
    + '      </Interaction>'
    + '    </viz:interaction>'
    + '  </viz:Bar>'
    + '</mvc:View>';

  var oChart = sap.ui.xmlview({viewContent:xml}).getContent()[0];
    //Get Options from bar chart
  var vizOptions =  oChart.getInteraction().getSelectability().getMode();
  
  //Viz chart should receive the following options.
  var orignOptions = 'multiple';
  deepEqual(vizOptions, orignOptions, "Interaction properties should be the same.");
});

test("Set selection mode via controller.intercation - single", function() {
  oChart.setInteraction(new sap.viz.ui5.types.controller.Interaction({
    selectability : {
      mode : sap.viz.ui5.types.controller.Interaction_selectability_mode.single  
    }
  }));
  //Get Options from bar chart
  vizOptions = oChart._getOptions();

  //Viz chart should receive the following options.
  var orignOptions = {
     interaction : {
       selectability : {
         mode : 'single'
       }
     }
  };
  deepEqual(vizOptions.interaction, orignOptions.interaction, "Interaction properties should be the same.");
}); 

var cleanChart = function(oChart) {
  if (oChart) {
    oChart.destroy();
    oChart = undefined;
  }
};

var createChart = function(chartType, settings){
  if(settings === undefined) {
    settings = {};
  }
  if(settings.plotArea === undefined){
    settings.plotArea = {};
  }
  settings.plotArea.animation = {
    dataLoading : false,
    dataUpdating : false,
    resizing : false
  };
  return new chartType(settings);
};
  
</script>

<title>qunit Test for Selection/Interaction</title>

</head>
<body class="sapUiBody">
  <h1 id="qunit-header">QUnit tests: Selection/Interaction</h1>
  <h2 id="qunit-banner"></h2>
  <h2 id="qunit-userAgent"></h2>
  <div id='content'  style="width: 640px; height: 480px;" ></div>
  <div id="qunit-testrunner-toolbar"></div>
  <ol id="qunit-tests"></ol>

</body>
</html>
