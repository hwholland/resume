<!DOCTYPE HTML>
<!-- 
  Tested control/class: sap.viz.ui5.VizContainer
-->

<html lang='en'>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<script id="sap-ui-bootstrap" type="text/javascript"
  src="../../../../resources/sap-ui-core.js"
  data-sap-ui-libs="sap.ui.core,sap.m,sap.viz"
  data-sap-ui-theme="sap_bluecrystal">
  
</script>
<link rel="stylesheet" href="../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen" />
<link rel="stylesheet" type="text/css"
    href="../../../../resources/sap/viz/ui5/controls/css/controls.css"/>
<link rel="stylesheet" type="text/css"
    href="../../../../resources/sap/viz/ui5/controls/libs/resources/css/sap.viz.controls.css"/>
<script type="text/javascript" src="../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script type="text/javascript" src="../../../../resources/sap/ui/qunit/qunit-junit.js"></script>

<script type="text/javascript" src="../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
<script type="text/javascript" src="./js/vizFrameData.js"></script>

<script language="javascript">
	var EventTestUtil = {
    	selectData : function(index){
    		var element = d3.selectAll('#content').selectAll('.v-datapoint')[0][index],
    			o = element.getBoundingClientRect(),
    			position = {
    				x: (o.left + o.right) / 2,
    				y: (o.top + o.bottom) / 2
    			},
    			mouseInit = {
    				bubbles: true,
    			    cancelable: true,
    			    view: window,
    				clientX: o.x,
    				clientY: o.y,
    			}
        var mousedown = document.createEvent ("MouseEvent");
        mousedown.initMouseEvent('mousedown',  true, true, window, 0, 
            undefined, undefined, o.x, o.y,
            undefined, undefined, undefined, undefined, 
            0, null);
    		element.dispatchEvent(mousedown);
        var mouseup = document.createEvent ("MouseEvent");
        mouseup.initMouseEvent('mouseup',  true, true, window, 0, 
            undefined, undefined, o.x, o.y, 
            undefined, undefined, undefined, undefined, 
            0, null);
    		element.dispatchEvent(mouseup);
    	},
      destroy : function(oControls){
        oControls.chartPopover.destroy();
        oControls.vizFrame.destroy();
      }
    };

    var result;
    $(function() {
      $('#content').css('height', '800px');
    });

    QUnit.module('Check Bar Chart Popover', {
      beforeEach: function(){
        result = createXYChart('info/bar'); 
      },
      afterEach: function(){
        EventTestUtil.destroy(result);
      }
    });

    QUnit.test("Check small data point." , function( assert ) {
      assert.expect(7);

      result.vizFrame.attachEventOnce('renderComplete', function() {
        assert.ok(true, 'Bar chart is renderComplete.');
        EventTestUtil.selectData(2);
      });
      var resPop = result.chartPopover._Popover._oPopover;
      
      var checkSmallDataPoint = function(e){
        var data = e.getParameters(),
            rectPos = data.openBy.getBoundingClientRect(),
            popPos = this.$().position();
        assert.equal(this.getPlacement(), 'PreferredRightOrFlip', 'Popover should be opened with PreferredRightOrFlip.');
        assert.ok((rectPos.right < popPos.left) && (rectPos.top > popPos.top), 'Popover should be opend in the right side.');

        assert.equal($('.viz-controls-chartPopover-dimension-label').text(), "2009 - France", "Dimension label should be correct.");
        assert.equal($('.viz-controls-chartPopover-measure-name').text(), 'Cost', "Measure label should be correct.");
        assert.equal($('.viz-controls-chartPopover-measure-name').css('text-align'), 'left', "Measure label should align in the left side.");
        assert.equal($('span.viz-controls-chartPopover-measure-labels').text(), "80", "Measure value should be correct.");

        resPop.detachAfterOpen(checkSmallDataPoint);
        start();
      };
      resPop.attachAfterOpen(checkSmallDataPoint);
      stop();
    });

    QUnit.test("check Large DataPoint." , function( assert ) {
      assert.expect(4);
      result.vizFrame.attachEventOnce('renderComplete', function() {
        assert.ok(true, 'Bar chart is renderComplete.');
        EventTestUtil.selectData(8);
      });

      var resPop = result.chartPopover._Popover._oPopover;
      var checkLargeDataPoint = function(e){
        var data = e.getParameters(),
            rectPos = data.openBy.getBoundingClientRect(),
            popPos = this.$().position();
        assert.equal(this.getPlacement(), 'PreferredRightOrFlip', 'Popover should be opened with PreferredRightOrFlip.');
        assert.ok((rectPos.right > popPos.left), 'Popover should be opend in the right side.');
        assert.ok(rectPos.left < popPos.left, 'Popover should not over than rect.left');
        resPop.detachAfterOpen(checkLargeDataPoint);
        start();
      };

      resPop.attachAfterOpen(checkLargeDataPoint);
      stop();
    });

    QUnit.test("check Negative DataPoint." , function( assert ) {
      assert.expect(3);
      result.vizFrame.attachEventOnce('renderComplete', function() {
        assert.ok(true, 'Bar chart is renderComplete.');
        EventTestUtil.selectData(3);
      });

      var resPop = result.chartPopover._Popover._oPopover;
      var checkNegativeDataPoint = function(e){
        var data = e.getParameters(),
            rectPos = data.openBy.getBoundingClientRect(),
            popPos = this.$().position();
        assert.equal(this.getPlacement(), 'PreferredLeftOrFlip', 'Popover should be opened with PreferredLeftOrFlip.');
        assert.ok(rectPos.right < popPos.left + this.$().width(), 'Popover should be opend in the right side.');
        start();
        
      };
      resPop.attachAfterOpen(checkNegativeDataPoint);
      stop();
    });

    QUnit.module('Check Column Chart Popover', {
      beforeEach: function(){
        result = createXYChart('info/column'); 
      },
      afterEach: function(){
        EventTestUtil.destroy(result);
      }
    });

    QUnit.test("check samll data point." , function( assert ) {
      assert.expect(3);
      result.vizFrame.attachEventOnce('renderComplete', function() {
        assert.ok(true, 'Column chart is renderComplete.');
        EventTestUtil.selectData(0);
      });
      var resPop = result.chartPopover._Popover._oPopover;

      var checkSmallDataPoint = function(e){
        var data = e.getParameters(),
            rectPos = data.openBy.getBoundingClientRect(),
            popPos = this.$().position();
        assert.equal(this.getPlacement(), 'PreferredTopOrFlip', 'Popover should be opened with PreferredTopOrFlip.');
        assert.ok(this.$().height() + popPos.top < rectPos.top, 'Popover should be opend in the top side.');

        resPop.detachAfterOpen(checkSmallDataPoint);
        start(); 
      };
      resPop.attachAfterOpen(checkSmallDataPoint);
      stop();
    });

    QUnit.test("check Large DataPoint." , function( assert ) {
      assert.expect(3);
      result.vizFrame.attachEventOnce('renderComplete', function() {
        assert.ok(true, 'Column chart is renderComplete.');
        EventTestUtil.selectData(8);
      });
      var resPop = result.chartPopover._Popover._oPopover;

      var checkLargeDataPoint = function(e){
        var data = e.getParameters(),
            rectPos = data.openBy.getBoundingClientRect(),
            popPos = this.$().position();
        assert.equal(this.getPlacement(), 'PreferredTopOrFlip', 'Popover should be opened with PreferredTopOrFlip.');
        assert.ok(rectPos.top > popPos.top, 'Popover should be opend lower than rect.');
        resPop.detachAfterOpen(checkLargeDataPoint);
        start();
      };

      resPop.attachAfterOpen(checkLargeDataPoint); 
      stop();
    });

    QUnit.test("check Negative DataPoint." , function( assert ) {
      assert.expect(3);
      result.vizFrame.attachEventOnce('renderComplete', function() {
        assert.ok(true, 'Column chart is renderComplete.');
        EventTestUtil.selectData(3);
      });

      var checkNegativeDataPoint = function(e){
        var data = e.getParameters(),
            rectPos = data.openBy.getBoundingClientRect(),
            popPos = this.$().position();
        assert.equal(this.getPlacement(), 'PreferredBottomOrFlip', 'Popover should be opened with PreferredBottomOrFlip.');
        assert.ok(popPos.top > rectPos.bottom, 'Popover should near rect.');
        start();
      };

      var resPop = result.chartPopover._Popover._oPopover;
      resPop.attachAfterOpen(checkNegativeDataPoint);
      stop();
    }); 

    QUnit.module('Check Time Line Chart Popover', {
      beforeEach: function(){
        result = createTimeLineChart(); 
      },
      afterEach: function(){
        EventTestUtil.destroy(result);
      }
    });

    QUnit.test("check Time format." , function( assert ) {
      assert.expect(3);
      result.vizFrame.attachEventOnce('renderComplete', function() {
        assert.ok(true, 'Time line chart is renderComplete.');
        EventTestUtil.selectData(1);
      });

      var checkTimeFormat = function(e){
        var data = e.getParameters(),
            rectPos = data.openBy.getBoundingClientRect(),
            popPos = this.$().position();
        assert.equal(this.getPlacement(), 'VerticalPreferredTop', 'Popover should be opened with VerticalPreferredTop.');
        assert.equal($('span.viz-controls-chartPopover-measure-labels')[0].innerText, "Jan 2, 2015", "Follows chart's tooltip format");
        start();
      };

      var resPop = result.chartPopover._Popover._oPopover;
      resPop.attachAfterOpen(checkTimeFormat);
      stop();
    });

    QUnit.test("check Time format with Popover's formatString." , function( assert ) {
      assert.expect(3);
      result.chartPopover.setFormatString({'Date':'yyyy-mm-dd'});
      result.vizFrame.attachEventOnce('renderComplete', function() {
        assert.ok(true, 'Time line chart is renderComplete.');
        EventTestUtil.selectData(1);
      });

      var checkTimeFormat = function(e){
        var data = e.getParameters(),
            rectPos = data.openBy.getBoundingClientRect(),
            popPos = this.$().position();
        assert.equal(this.getPlacement(), 'VerticalPreferredTop', 'Popover should be opened with VerticalPreferredTop.');
        assert.equal($('span.viz-controls-chartPopover-measure-labels')[0].innerText, "2015-01-02", "Follows chart's tooltip format");
        start();
      };

      var resPop = result.chartPopover._Popover._oPopover;
      resPop.attachAfterOpen(checkTimeFormat);
      stop();
    });

</script>

<title>qunit Test for Chart Popover</title>

</head>
<body class="sapUiBody">
<div id='content' style="width: 100%;"></div>
  <h1 id="qunit-header">QUnit tests: Chart Popover</h1>
  <h2 id="qunit-banner"></h2>
  <h2 id="qunit-userAgent"></h2>
  <div id="qunit-testrunner-toolbar"></div>
  <ol id="qunit-tests"></ol>
</body>
</html>
