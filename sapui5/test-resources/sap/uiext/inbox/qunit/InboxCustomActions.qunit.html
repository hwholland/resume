<!DOCTYPE HTML>

<html>
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<script id="sap-ui-bootstrap" 
		type="text/javascript"
		src="../../../../../resources/sap-ui-core.js"
		data-sap-ui-theme="sap_bluecrystal"
		data-sap-ui-language="en-US"
		data-sap-ui-noConflict="true"
		data-sap-ui-libs="sap.ui.commons,sap.uiext.inbox">
	</script>
		<link rel="stylesheet" href="../../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen" />
		<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
		<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
	
		<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
		<script>
			// redirect any resource loading for "sap.uiext.inbox.qunit.mockServer" to the local folder "mockServer/" 
			jQuery.sap.registerModulePath("sap.uiext.inbox.qunit.mockServer", "mockServer/");
			
			// now load and activate the mock server
			jQuery.sap.require("sap.uiext.inbox.qunit.mockServer.InboxMockServerQUnit");

			module("Load");

			test("InboxCreationOk",function() {
				sap.ui.getCore().applyChanges(); 
				var $Inbox = jQuery.sap.byId("inbox");
				equals(false, ( $Inbox === undefined), "Checking if the Inbox Control is created and is not undefined.");
				equals(false, ( $Inbox === null), "Checking if the Inbox Control is created and is not null.");
				qutils.triggerMouseEvent("inbox" + "--tableViewSelectionButton", "click");
			});
			
			module("Inbox Custom Actions in table View");
			
			asyncTest("Loading tasks in the task table", function() {
				sap.ui.getCore().applyChanges();
				
				var delayedCall = function() {
					var oActionToolbar = sap.ui.getCore().getControl("inbox--actionButtonsToolbarContainer");
					equals(false, (oActionToolbar === null), "check if Action ToolBar is not null");
					
					var oActionToolbarItems = oActionToolbar.getItems();
					var initialNumberOfToolbarItems = oActionToolbarItems.length;
					equals(initialNumberOfToolbarItems, 5, "Checking Initial Number of Items in the Table View Toolbar");
					start();
				};
				setTimeout(delayedCall, 0); 
			});
			
			asyncTest("Custom Actions on single selection in Table View", function() {
				sap.ui.getCore().applyChanges();
				
				qutils.triggerMouseEvent("inbox--listViewTable-rowsel5", "click");
				sap.ui.getCore().applyChanges(); 

				var delayedCall = function() {
					var oActionToolbar = sap.ui.getCore().getControl("inbox--actionButtonsToolbarContainer");
					oActionToolbarItems = oActionToolbar.getItems();
					var currentNumberOfToolbarItems = oActionToolbarItems.length;
					equals(currentNumberOfToolbarItems, 9, "Checking Number of Items in Table View Toolbar if a task with custom actions is selected");
					equals(oActionToolbarItems[4].getText(), "Approve", "Checking if first custom action is Approve");
					equals(oActionToolbarItems[5].getText(), "Reject", "Checking if second custom action is Reject");
					equals(oActionToolbarItems[6].getText(), "Other Opinion", "Checking if third custom action is Other Opinion");
					
					start();
				};
				setTimeout(delayedCall, 500); 
			});
			
			asyncTest("Custom Actions on single selection in Table View", function() {
				sap.ui.getCore().applyChanges();
				sap.ui.getCore().byId("inbox--listViewTable").clearSelection(); //Ensure no row is currently selected

				qutils.triggerMouseEvent("inbox--listViewTable-rowsel6", "click");
				sap.ui.getCore().applyChanges(); 

				var delayedCall = function() {
					var oActionToolbar = sap.ui.getCore().getControl("inbox--actionButtonsToolbarContainer");
					oActionToolbarItems = oActionToolbar.getItems();
					var currentNumberOfToolbarItems = oActionToolbarItems.length;
					equals(currentNumberOfToolbarItems, 8, "Checking Number of Items in Table View Toolbar if a task with custom actions is selected");
					equals(oActionToolbarItems[4].getText(), "Approve", "Checking if first custom action is Approve");
					equals(oActionToolbarItems[5].getText(), "Rework", "Checking if second custom action is Rework");
					
					start();
				};
				setTimeout(delayedCall, 500); 
			});
			
			asyncTest("Custom Actions on multi selection in Table View", function() {
				sap.ui.getCore().applyChanges();
				var oTable = sap.ui.getCore().getControl("inbox--listViewTable");
				oTable.setSelectionInterval(5, 6); // selecting two tasks with same model ID but different Task Definition IDs and custom actions
				sap.ui.getCore().applyChanges();
				
				var delayedCall = function() {
					var oActionToolbar = sap.ui.getCore().getControl("inbox--actionButtonsToolbarContainer");
					equals(false, (oActionToolbar === null), "check if Action ToolBar is not null");
					oActionToolbarItems = oActionToolbar.getItems();
					var currentNumberOfToolbarItems = oActionToolbarItems.length;
					equals(currentNumberOfToolbarItems, 7, "Checking Number of Items in the Table View Toolbar if two tasks with same model ID but different Definition are selected");
					equals(oActionToolbarItems[4].getText(), "Approve", "Checking if the intersection of custom actions is correct");
					
					start();
				};
				setTimeout(delayedCall, 500); 
			});
			
			asyncTest("Custom Actions on multi selection in Table View", function() {
				sap.ui.getCore().applyChanges();
				var oTable = sap.ui.getCore().getControl("inbox--listViewTable");
				oTable.setSelectionInterval(6,7); // selecting two tasks with different model ID but same custom actions
				sap.ui.getCore().applyChanges();
				
				var delayedCall = function() {
					var oActionToolbar = sap.ui.getCore().getControl("inbox--actionButtonsToolbarContainer");
					equals(false, (oActionToolbar === null), "check if Action ToolBar is not null");
					oActionToolbarItems = oActionToolbar.getItems();
					var currentNumberOfToolbarItems = oActionToolbarItems.length;
					equals(currentNumberOfToolbarItems, 5, "Checking Number of Items in the Table View Toolbar if two tasks with different Model ID are selected");
					start();
				};
				setTimeout(delayedCall, 500); 
			});
			
			asyncTest("Selecting a task with custom actions to execute a custom action", function() {
				sap.ui.getCore().byId("inbox--listViewTable").clearSelection(); //Ensure no row is currently selected
				
				qutils.triggerMouseEvent("inbox--listViewTable-rowsel7", "click");
				sap.ui.getCore().applyChanges();
				
				var delayedCall = function() {
					var oActionToolbar = sap.ui.getCore().getControl("inbox--actionButtonsToolbarContainer");
					equals(false, (oActionToolbar === null), "check if Action ToolBar is not null");
					var oActionToolbarItems = oActionToolbar.getItems();
					var currentNumberOfToolbarItems = oActionToolbarItems.length;
					equals(currentNumberOfToolbarItems, 8, "Checking Number of Items in Table View Toolbar if a task with custom action is selected");
					equals(oActionToolbarItems[4].getText(), "Approve", "Checking if first custom action is Approve");
					equals(oActionToolbarItems[5].getText(), "Rework", "Checking if second custom action is Rework");
					
					start();
				};
				setTimeout(delayedCall, 500); 
			});
			
			asyncTest("Executing a Custom Action in Table View without Comments", function() {
				var _oBundle = sap.ui.getCore().getLibraryResourceBundle("sap.uiext.inbox");
				var sAction = "Approve";
				var sTaskTitle = "Review and Approve article";
				sap.ui.getCore().applyChanges();
				qutils.triggerMouseEvent("inbox--Approvebutton", "click");
				sap.ui.getCore().applyChanges();
				//check for toolpopup
				ok(jQuery.sap.byId("inbox--customActionToolPopup").get(0), "Comments ToolPopup visible");
				ok(jQuery.sap.byId("inbox--toolPopupButton").get(0), "Approve button on Conmments ToolPopup visible");
				equal(sap.ui.getCore().byId("inbox--toolPopupButton").data('key'), "Approve", "Approve button on Comments ToolPopup visible");
				
				qutils.triggerMouseEvent("inbox--toolPopupButton", "click");
				var delayedCall = function() {
					sap.ui.getCore().applyChanges();
					equal(jQuery.sap.byId("inbox--messageNotifier-counter").text(),"1", "Approve action is performed successfully");
					equal(jQuery.sap.byId("inbox--notificationBar-inplaceMessage").text(), _oBundle.getText("INBOX_MSG_ACTION_SUCCESS",[sAction,sTaskTitle]), "Approve action is performed successfully");
					start();
				};
				setTimeout(delayedCall, 1000);
			});
			
			
			asyncTest("Executing a Custom Action in Table View with Comments", function() {
				var _oBundle = sap.ui.getCore().getLibraryResourceBundle("sap.uiext.inbox");
				var sAction = "Rework";
				var sTaskTitle = "Review and Approve article";
				sap.ui.getCore().applyChanges();
				qutils.triggerMouseEvent("inbox--Reworkbutton", "click");
				sap.ui.getCore().applyChanges();
				//check for toolpopup
				ok(jQuery.sap.byId("inbox--customActionToolPopup").get(0), "Comments ToolPopup visible");
				ok(jQuery.sap.byId("inbox--toolPopupButton").get(0), "Rework button on Conmments ToolPopup visible");
				equal(sap.ui.getCore().byId("inbox--toolPopupButton").data('key'), "Rework", "Rework button on Comments ToolPopup visible");
				
				//add Comment into the textArea
				jQuery.sap.domById("inbox--addCommentsinCustomActionPopup").focus();
				jQuery.sap.byId("inbox--addCommentsinCustomActionPopup").text("Rework on this task");
				qutils.triggerKeyup("inbox--addCommentsinCustomActionPopup", jQuery.sap.KeyCodes.T, false, false, false);
				sap.ui.getCore().byId("inbox--addCommentsinCustomActionPopup").setValue(jQuery.sap.byId("inbox--addCommentsinCustomActionPopup").text());
				
				qutils.triggerMouseEvent("inbox--toolPopupButton", "click");
				var delayedCall = function() {
					sap.ui.getCore().applyChanges();
					equal(jQuery.sap.byId("inbox--messageNotifier-counter").text(),"1", "Rework action is performed successfully");
					equal(jQuery.sap.byId("inbox--notificationBar-inplaceMessage").text(), _oBundle.getText("INBOX_MSG_ACTION_SUCCESS",[sAction,sTaskTitle]), "Rework action is performed successfully");
					start();
				};
				setTimeout(delayedCall, 1000);
			});
			
			
			// TODO commenting the tests for now as they are failing. Move those tests to another file.
			
			/* module("Inbox Custom Actions in Row Repeater View");
			
			asyncTest("Check Custom Actions in Row Repeater View", function() {
				var oInbox = sap.ui.getCore().byId('inbox');
				qutils.triggerMouseEvent("inbox--rrViewSelectionButton", "click");
				sap.ui.getCore().applyChanges();
				setTimeout(function() {
					equals(oInbox.currentView, "sap_inbox_stream", "current view is row repeater view");
					qutils.triggerMouseEvent("inbox--10RowsSegBtn", "click");
					sap.ui.getCore().applyChanges();
				
					setTimeout(function() {
						var oTasksRrView = sap.ui.getCore().byId('inbox--tasksRowRepeater');
						equals(oTasksRrView.getRows().length, 8, "all tasks are present in the current view");
						
						var oHrLayout = sap.ui.getCore().byId('inbox--hrLayoutForCustomActions-inbox--tasksRowRepeater-5');
						equals(oHrLayout.getContent()[1].getText(), "Approve", "Approve Custom Action is displayed");
						equals(oHrLayout.getContent()[3].getText(), "Reject", "Reject Custom Action is displayed");
						equals(oHrLayout.getContent()[5].getText(), "Other Opinion", "Other Opinion Custom Action is displayed");
						qutils.triggerMouseEvent(oHrLayout.getContent()[1].getId(), "click");
						ok(jQuery.sap.byId("inbox--customActionToolPopup-CommentsMand").is(":visible")==true, "Comments Mandatory ToolPopup visible");
						ok(sap.ui.getCore().byId("inbox--toolPopupButton-CommentsMand").getEnabled()==false, "Custom Action button on Comments Mandatory ToolPopup disabled");
						jQuery.sap.domById("inbox--addCommentsinCustomActionPopup-CommentsMand").focus();
						sap.ui.getCore().byId("inbox--addCommentsinCustomActionPopup-CommentsMand").setValue("Rework on this Task");
						sap.ui.getCore().byId("inbox--addCommentsinCustomActionPopup-CommentsMand").fireLiveChange();
						ok(sap.ui.getCore().byId("inbox--toolPopupButton-CommentsMand").getEnabled()==true, "Custom Action button on Comments Mandatory ToolPopup enabled");
						oHrLayout = sap.ui.getCore().byId('inbox--hrLayoutForCustomActions-inbox--tasksRowRepeater-6');
						equals(oHrLayout.getContent()[1].getText(), "Approve", "Approve Custom Action is displayed");
						equals(oHrLayout.getContent()[3].getText(), "Rework", "Rework Custom Action is displayed");
						
						oHrLayout = sap.ui.getCore().byId('inbox--hrLayoutForCustomActions-inbox--tasksRowRepeater-7');
						equals(oHrLayout.getContent()[1].getText(), "Approve", "Approve Custom Action is displayed");
						equals(oHrLayout.getContent()[3].getText(), "Rework", "Rework Custom Action is displayed");
						
						start();
					}, 1000);
					
				}, 1000); 
			});
			
			asyncTest("Executing a Custom Action in Row Repeater View without comments", function() {
				var _oBundle = sap.ui.getCore().getLibraryResourceBundle("sap.uiext.inbox");
				var oHrLayout = sap.ui.getCore().byId('inbox--hrLayoutForCustomActions-inbox--tasksRowRepeater-7');
				var sCustomActionLinkId = oHrLayout.getContent()[1].getId();
				var sAction = "Approve";
				var sTaskTitle = "Review and Approve article";
				sap.ui.getCore().applyChanges();
				jQuery.sap.byId(sCustomActionLinkId).focus();
				qutils.triggerMouseEvent(sCustomActionLinkId, "click");
				sap.ui.getCore().applyChanges();
				//check for toolpopup
				ok(jQuery.sap.byId("inbox--customActionToolPopup").get(0), "Comments ToolPopup visible");
				ok(jQuery.sap.byId("inbox--toolPopupButton").get(0), "Custom Action button on Comments ToolPopup visible");
				equal(sap.ui.getCore().byId("inbox--toolPopupButton").data('key'), sAction, "Approve button on Comments ToolPopup visible");
				equal(sap.ui.getCore().byId("inbox--toolPopupButton").getText(), sAction, "Approve button on Comments ToolPopup visible");
				qutils.triggerMouseEvent("inbox--toolPopupButton", "click");
				
				var delayedCall = function() {
					sap.ui.getCore().applyChanges();
					equal(jQuery.sap.byId("inbox--messageNotifier-counter").text(),"1", "Approve action is performed successfully");
					equal(jQuery.sap.byId("inbox--notificationBar-inplaceMessage").text(), _oBundle.getText("INBOX_MSG_ACTION_SUCCESS",[sAction,sTaskTitle]), "Approve action is performed successfully");
					
					start();
				};
				setTimeout(delayedCall, 1000);
			});
			
			asyncTest("Executing a Custom Action in Row Repeater View with Comments", function() {
				var _oBundle = sap.ui.getCore().getLibraryResourceBundle("sap.uiext.inbox");
				var oHrLayout = sap.ui.getCore().byId('inbox--hrLayoutForCustomActions-inbox--tasksRowRepeater-7');
				var sCustomActionLinkId = oHrLayout.getContent()[3].getId();
				var sAction = "Rework";
				var sTaskTitle = "Review and Approve article";
				sap.ui.getCore().applyChanges();
				jQuery.sap.byId(sCustomActionLinkId).focus();
				qutils.triggerMouseEvent(sCustomActionLinkId, "click");
				sap.ui.getCore().applyChanges();
				//check for toolpopup
				ok(jQuery.sap.byId("inbox--customActionToolPopup").get(0), "Comments ToolPopup visible");
				ok(jQuery.sap.byId("inbox--toolPopupButton").get(0), "Rework button on Comments ToolPopup visible");
				equal(sap.ui.getCore().byId("inbox--toolPopupButton").data('key'), "Rework", "Rework button on Comments ToolPopup visible");
				equal(sap.ui.getCore().byId("inbox--toolPopupButton").getText(), "Rework", "Rework button on Comments ToolPopup visible");
				//add Comment into the textArea
				jQuery.sap.domById("inbox--addCommentsinCustomActionPopup").focus();
				jQuery.sap.byId("inbox--addCommentsinCustomActionPopup").text("Rework on this task");
				qutils.triggerKeyup("inbox--addCommentsinCustomActionPopup", jQuery.sap.KeyCodes.T, false, false, false);
				sap.ui.getCore().byId("inbox--addCommentsinCustomActionPopup").setValue(jQuery.sap.byId("inbox--addCommentsinCustomActionPopup").text());
				qutils.triggerMouseEvent("inbox--toolPopupButton", "click");
				
				var delayedCall = function() {
					sap.ui.getCore().applyChanges();
					equal(jQuery.sap.byId("inbox--messageNotifier-counter").text(),"1", "Rework action is performed successfully");
					equal(jQuery.sap.byId("inbox--notificationBar-inplaceMessage").text(), _oBundle.getText("INBOX_MSG_ACTION_SUCCESS",[sAction,sTaskTitle]), "Reject action is performed successfully");
					
					start();
				};
				setTimeout(delayedCall, 1000);
			}); */
			
			QUnit.done(function() {
				qutils.triggerMouseEvent("inbox" + "--tableViewSelectionButton", "click");
			});
			
			
		</script>
	</head>
	<body>
		<h1 id="qunit-header"><title>qUnit Page for Custom Actions in Table View</title></h1>
		<h2 id="qunit-banner"></h2>
		<h2 id="qunit-userAgent"></h2>
		<ol id="qunit-tests"></ol>
		<div id="qunit-fixture">test markup, will be hidden</div>
		<div id="canvas" style="height:300px; width:300px"></div>
		<br>
		<div id="uiArea1" style="width: 80%;"></div>
	</body>
</html>
