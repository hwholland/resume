<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>qUnit Page for sap.ui.comp.smartfield.ControlFactoryBase</title>

<script id="sap-ui-bootstrap" type="text/javascript"
	src="../../../../../resources/sap-ui-core.js"
	data-sap-ui-theme="sap_bluecrystal" data-sap-ui-noConflict="true"
	data-sap-ui-libs="sap.ui.comp">
	
</script>

<link rel="stylesheet"
	href="../../../../../resources/sap/ui/thirdparty/qunit.css"
	type="text/css" media="screen" />
<script type="text/javascript"
	src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script type="text/javascript"
	src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script type="text/javascript"
	src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
<script type="text/javascript"
	src="../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
<script type="text/javascript"
	src="../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>

<script type="text/javascript" src="data/TestModel.data.js"></script>
<script type="text/javascript" src="data/ValueHelpModel.data.js"></script>

<script type="text/javascript">
	if (!(sap.ui.Device.browser.internet_explorer && sap.ui.Device.browser.version <= 8)) {
		jQuery.sap.require("sap.ui.qunit.qunit-coverage");
	}	

	(function() {
		jQuery.sap.require("sap.ui.comp.smartfield.ControlFactoryBase");
		jQuery.sap.require("sap.ui.comp.smartfield.ODataControlFactory");
		jQuery.sap.require("sap.ui.model.odata.ODataModel");
		jQuery.sap.require("sap.ui.comp.smartfield.ODataHelper");

		QUnit.module("sap.ui.comp.smartfield.ControlFactoryBase", {
			beforeEach: function() {
				function findIndex(aArray, vExpectedPropertyValue, sPropertyName) {
					var iIndex = -1;

					sPropertyName = sPropertyName || "name";
					jQuery.each(aArray || [], function(i, oObject) {
						if (oObject[sPropertyName] === vExpectedPropertyValue) {
							iIndex = i;
							return false; // break
						}
					});

					return iIndex;
				}
				;
				function getObject1(oModel, sArrayName, sQualifiedName, bAsPath) {
					var vResult = bAsPath ? undefined : null, iSeparatorPos, sNamespace, sName;

					sQualifiedName = sQualifiedName || "";
					iSeparatorPos = sQualifiedName.lastIndexOf(".");
					sNamespace = sQualifiedName.slice(0, iSeparatorPos);
					sName = sQualifiedName.slice(iSeparatorPos + 1);
					jQuery.each(oModel.getObject("/dataServices/schema") || [], function(i, oSchema) {
						if (oSchema.namespace === sNamespace) {
							jQuery.each(oSchema[sArrayName] || [], function(j, oThing) {
								if (oThing.name === sName) {
									vResult = bAsPath ? oThing.$path : oThing;
									return false; // break
								}
							});
							return false; // break
						}
					});

					return vResult;
				}
				;
				this.oModel = sinon.createStubInstance(sap.ui.model.odata.ODataModel);
				this.oModel.getServiceMetadata = function() {
					return oTestModel;
				};
				this.oModel.getMetaModel = function() {
					var oStub = sinon.createStubInstance(sap.ui.model.odata.ODataMetaModel);
					oStub.oModel = new sap.ui.model.json.JSONModel(oTestModel);
					oStub.oData = oTestModel;
					oStub.getObject = function(sPath) {
						var oNode, aParts = sPath.split("/"), iIndex = 0;
						if (!aParts[0]) {
							// absolute path starting with slash
							oNode = this.oData;
							iIndex++;
						}
						while (oNode && aParts[iIndex]) {
							oNode = oNode[aParts[iIndex]];
							iIndex++;
						}
						return oNode;
					};
					oStub.getODataEntityContainer = function(bAsPath) {
						var vResult = bAsPath ? undefined : null;

						jQuery.each(this.oModel.getObject("/dataServices/schema") || [], function(i, oSchema) {
							var j = findIndex(oSchema.entityContainer, "true", "isDefaultEntityContainer");

							if (j >= 0) {
								vResult = bAsPath ? "/dataServices/schema/" + i + "/entityContainer/" + j : oSchema.entityContainer[j];
								return false; //break
							}
						});

						return vResult;
					};
					oStub.getODataEntitySet = function(sName, bAsPath) {
						var k, oEntityContainer = this.getODataEntityContainer(), vResult = bAsPath ? undefined : null;

						if (oEntityContainer) {
							k = findIndex(oEntityContainer.entitySet, sName);
							if (k >= 0) {
								vResult = bAsPath ? oEntityContainer.$path + "/entitySet/" + k : oEntityContainer.entitySet[k];
							}
						}

						return vResult;
					};
					oStub.getODataEntityType = function(sQualifiedName, bAsPath) {
						return getObject1(this.oModel, "entityType", sQualifiedName, bAsPath);
					};
					oStub.getODataProperty = function(oType, vName, bAsPath) {
						var i, aParts = jQuery.isArray(vName) ? vName : [
							vName
						], oProperty = null, sPropertyPath;

						while (oType && aParts.length) {
							i = findIndex(oType.property, aParts[0]);
							if (i < 0) {
								break;
							}

							aParts.shift();
							oProperty = oType.property[i];
							sPropertyPath = oType.$path + "/property/" + i;

							if (aParts.length) {
								// go to complex type in order to allow drill-down
								oType = this.getODataComplexType(oProperty.type);
							}
						}

						return bAsPath ? sPropertyPath : oProperty;
					};
					oStub.getODataComplexType = function(sQualifiedName, bAsPath) {
						return getObject1(this.oModel, "complexType", sQualifiedName, bAsPath);
					};
					return oStub;
				};

				this.oVHModel = sinon.createStubInstance(sap.ui.model.odata.ODataModel);
				this.oVHModel.getServiceMetadata = function() {
					return oValueHelpModel;
				};
				this.oVHModel.getMetaModel = function() {
					var oStub = sinon.createStubInstance(sap.ui.model.odata.ODataMetaModel);
					oStub.oModel = new sap.ui.model.json.JSONModel(oValueHelpModel);
					oStub.oData = oValueHelpModel;
					oStub.getObject = function(sPath) {
						var oNode, aParts = sPath.split("/"), iIndex = 0;
						if (!aParts[0]) {
							// absolute path starting with slash
							oNode = this.oData;
							iIndex++;
						}
						while (oNode && aParts[iIndex]) {
							oNode = oNode[aParts[iIndex]];
							iIndex++;
						}
						return oNode;
					};
					oStub.getODataEntityContainer = function(bAsPath) {
						var vResult = bAsPath ? undefined : null;

						jQuery.each(this.oModel.getObject("/dataServices/schema") || [], function(i, oSchema) {
							var j = findIndex(oSchema.entityContainer, "true", "isDefaultEntityContainer");

							if (j >= 0) {
								vResult = bAsPath ? "/dataServices/schema/" + i + "/entityContainer/" + j : oSchema.entityContainer[j];
								return false; //break
							}
						});

						return vResult;
					};
					oStub.getODataEntitySet = function(sName, bAsPath) {
						var k, oEntityContainer = this.getODataEntityContainer(), vResult = bAsPath ? undefined : null;

						if (oEntityContainer) {
							k = findIndex(oEntityContainer.entitySet, sName);
							if (k >= 0) {
								vResult = bAsPath ? oEntityContainer.$path + "/entitySet/" + k : oEntityContainer.entitySet[k];
							}
						}

						return vResult;
					};
					oStub.getODataEntityType = function(sQualifiedName, bAsPath) {
						return getObject1(this.oModel, "entityType", sQualifiedName, bAsPath);
					};
					oStub.getODataProperty = function(oType, vName, bAsPath) {
						var i, aParts = jQuery.isArray(vName) ? vName : [
							vName
						], oProperty = null, sPropertyPath;

						while (oType && aParts.length) {
							i = findIndex(oType.property, aParts[0]);
							if (i < 0) {
								break;
							}

							aParts.shift();
							oProperty = oType.property[i];
							sPropertyPath = oType.$path + "/property/" + i;

							if (aParts.length) {
								// go to complex type in order to allow drill-down
								oType = this.getODataComplexType(oProperty.type);
							}
						}

						return bAsPath ? sPropertyPath : oProperty;
					};
					oStub.getODataComplexType = function(sQualifiedName, bAsPath) {
						return getObject1(this.oModel, "complexType", sQualifiedName, bAsPath);
					};
					return oStub;
				};
			},
			afterEach: function() {

			}
		});

		QUnit.test("Shall be instantiable", function() {
			var oFactory, oParent;
			oParent = {
				getBindingContext: function() {
					return {
						sPath: "/Project(id1='71' id2='abcd')"
					};
				},
				getModel: function() {
					return this.oModel;
				},
				getBindingInfo: function() {
					return {
						"parts": [
							{
								model: undefined,
								path: "ID"
							}
						]
					};
				},
				bindProperty: function() {

				},
				getEditable: function() {
					return false;
				},
				getWidth: function() {
					return "100%";
				},
				getTextAlign: function() {
					return null;
				},
				getPlaceholder: function() {
					return null;
				},
				getName: function() {
					return null;
				}
			};

			oFactory = new sap.ui.comp.smartfield.ControlFactoryBase(this.oModel, oParent, {
				entitySet: "Project",
				path: "Description"
			});
			assert.ok(oFactory);

			oFactory.destroy();
		});

		QUnit.test("Create Control", function() {
			var oFactory, oParent, oControl, bOnCreate = false;

			oParent = {
				getBindingContext: function() {
					return {
						sPath: "/Project(id1='71' id2='abcd')"
					};
				},
				getModel: function() {
					return this.oModel;
				},
				getBindingInfo: function() {
					return {
						"parts": [
							{
								model: undefined,
								path: "ID"
							}
						]
					};
				},
				bindProperty: function() {

				},
				getEditable: function() {
					return false;
				},
				getWidth: function() {
					return "100%";
				},
				getTextAlign: function() {
					return null;
				},
				getPlaceholder: function() {
					return null;
				},
				getName: function() {
					return null;
				},
				getControlContext: function () {
					return "form";
				},
				getAriaLabelledBy: function () {
					return [];
				}
			};

			oFactory = new sap.ui.comp.smartfield.ControlFactoryBase(this.oModel, oParent, {
				entitySet: "Project",
				path: "Description"
			});
			oFactory._getCreator = function() {
				return "_create";
			};
			oFactory._create = function() {
				return {
					control: {},
					onCreate: "_onCreate"
				};
			};
			oFactory._onCreate = function() {
				bOnCreate = true;
			};

			oControl = oFactory.createControl();
			assert.ok(oControl.control);
			assert.equal(oControl.onCreate, "_onCreate");
			assert.ok(bOnCreate);

			oFactory.destroy();
		});

		QUnit.test("_addAriaLabelledBy", function() {
			var oParent;
			var oAriaLabel = new sap.ui.core.InvisibleText({
				id: "_addAriaLabelledBy_DescriptionLabel",
				text: "Project Description (ariaLabelledBy)"
			});
			oParent = {
				getBindingContext: function() {
					return {
						sPath: "/Project(id1='71' id2='abcd')"
					};
				},
				getModel: function() {
					return this.oModel;
				},
				getBindingInfo: function() {
					return {
						"parts": [
							{
								model: undefined,
								path: "Description"
							}
						]
					};
				},
				bindProperty: function() {

				},
				getObjectBinding: function() {
					return {
						sPath: "Description"
					};
				},
				addDependent: function() {
					
				},
				getEditable: function() {
					return false;
				},
				getWidth: function() {
					return "100%";
				},
				getTextAlign: function() {
					return null;
				},
				getPlaceholder: function() {
					return null;
				},
				getName: function() {
					return null;
				},
				getAriaLabelledBy: function() {
					return [
						oAriaLabel
					];
				},
				getControlContext: function() {
					return "form";
				}
			};

			oFactory = new sap.ui.comp.smartfield.ControlFactoryBase(this.oModel, oParent, {
				entitySet: "Project",
				path: "Description"
			});

			oControl = {
				control: new sap.m.Input()
			};

			oFactory._addAriaLabelledBy(oControl);
			assert.equal(sap.ui.getCore().byId(oControl.control.getAriaLabelledBy()[0]).getText(), "Project Description (ariaLabelledBy)", "ARIA label taken over from SmartField");
		});

		QUnit.test("addValidations- checkMandatory - null", function() {
			var bCallBack, oFactory, bShowValueState = true, iFormat = 0, iState = 0, iText = 0, oControl, oParent, fSuccess, fError, sMessage, fParentSucc, fParentError, iSource = 0;

			oControl = {
				getShowValueStateMessage: function() {
					return bShowValueState;
				},
				bindProperty: function(sName) {
					//assert.equal(sName, "enabled");
				},
				setFilterSuggests: function() {

				},
				setShowValueHelp: function() {

				},
				setShowSuggestion: function() {

				},
				attachFormatError: function(fErr) {
					iFormat++;
					fError = fErr;
				},
				attachParseError: function() {
					iFormat++;
				},
				attachValidationError: function() {
					iFormat++;
				},
				attachValidationSuccess: function(fSucc) {
					iFormat++;
					fSuccess = fSucc;
				},
				fireValidationSuccess: function(oParam) {
					fSuccess(oParam);
				},
				fireFormatError: function(oParam) {
					fError(oParam);
				},
				fireParseError: function(oParm) {
					fError(oParam);
				},
				fireValidationError: function(oParam) {
					fError(oParam);
				},
				setValueStateText: function(sText) {
					if (sText === "SuccessMessage") {
						iText++;
					} else if (sText === "ErrorMessage") {
						iText++;
					}

					sMessage = sText;
				},
				getValueStateText: function() {
					return sMessage;
				},
				setValueState: function() {
					iState++;
				},
				updateMessages: function(sName, aMessages) {
					if (aMessages && aMessages.length > 0) {
						this.setValueState(aMessages[0].type);
						this.setValueStateText(aMessages[0].message);
					} else {
						this.setValueState(sap.ui.core.ValueState.None);
					}
				},
				getParent: function() {
					return oParent;
				}
			};

			oParent = {
				getShowValueStateMessage: function() {
					return bShowValueState;
				},
				bindProperty: function(sName) {
					//assert.equal(sName, "enabled");
				},
				setFilterSuggests: function() {

				},
				setShowValueHelp: function() {

				},
				setShowSuggestion: function() {

				},
				attachFormatError: function(fErr) {
					fParentError = fErr;
				},
				attachParseError: function(fErr) {
					fParentError = fErr;
				},
				attachValidationError: function(fErr) {
					fParentError = fErr;
				},
				attachValidationSuccess: function(fSucc) {
					fParentSucc = fSucc;
				},
				fireValidationSuccess: function(oParam) {
					fParentSucc(oParam);
				},
				fireFormatError: function(oParam) {
					fParentError(oParam);
				},
				fireParseError: function(oParam) {
					fParentError(oParam);
				},
				fireValidationError: function(oParam) {
					fParentError(oParam);
				},
				setValueStateText: function(sText) {
					if (sText === "SuccessMessage") {
						iText++;
					} else if (sText === "ErrorMessage") {
						iText++;
					}

					sMessage = sText;
				},
				getValueStateText: function() {
					return sMessage;
				},
				setValueState: function() {
					iState++;
				},
				updateMessages: function(sName, aMessages) {
					if (aMessages && aMessages.length > 0) {
						this.setValueState(aMessages[0].type);
						this.setValueStateText(aMessages[0].message);
					} else {
						this.setValueState(sap.ui.core.ValueState.None);
					}
				},
				testCallBack: function(bParam) {
					bCallBack = true;
				}
			};

			oFactory = new sap.ui.comp.smartfield.ControlFactoryBase(this.oModel, oParent, {
				entitySet: "Project",
				path: "Description"
			});
			oFactory.checkMandatory = function() {
				return null;
			};

			oFactory.addValidations(oControl, "testCallBack");
			assert.equal(iFormat, 4);

			fSuccess({
				getParameter: function() {
					return {
						name: "SuccessMessage",
						message: "SuccessMessage"
					}
				},
				getSource: function() {
					return oControl;
				}
			});
			fError({
				getParameter: function() {
					return {
						name: "ErrorMessage",
						message: "ErrorMessage"
					}
				},
				getSource: function() {
					return oControl;
				}
			});
			assert.equal(iText, 2);
			assert.equal(iState, 2);
			assert.equal(bCallBack, true);

			bShowValueState = false;
			fSuccess({
				getParameter: function() {
					return {
						name: "SuccessMessage",
						message: "SuccessMessage"
					}
				},
				getSource: function() {
					return oControl;
				}
			});
			assert.equal(oControl.getValueStateText(), "SuccessMessage");
			oFactory.destroy();
		});

		QUnit.test("addValidations - checkMandatory - error", function() {
			var oFactory, bShowValueState = true, iFormat = 0, iState = 0, iText = 0, oControl, oParent, fSuccess, fError, sMessage, fParentSucc, fParentError, iSource = 0;

			oControl = {
				getShowValueStateMessage: function() {
					return bShowValueState;
				},
				bindProperty: function(sName) {
					//assert.equal(sName, "enabled");
				},
				setFilterSuggests: function() {

				},
				setShowValueHelp: function() {

				},
				setShowSuggestion: function() {

				},
				attachFormatError: function(fErr) {
					iFormat++;
					fError = fErr;
				},
				attachParseError: function() {
					iFormat++;
				},
				attachValidationError: function() {
					iFormat++;
				},
				attachValidationSuccess: function(fSucc) {
					iFormat++;
					fSuccess = fSucc;
				},
				fireValidationSuccess: function(oParam) {
					fSuccess(oParam);
				},
				fireFormatError: function(oParam) {
					fError(oParam);
				},
				fireParseError: function(oParm) {
					fError(oParam);
				},
				fireValidationError: function(oParam) {
					fError(oParam);
				},
				setValueStateText: function(sText) {
					if (sText === "SuccessMessage") {
						iText++;
					} else if (sText === "ErrorMessage") {
						iText++;
					}

					sMessage = sText;
				},
				getValueStateText: function() {
					return sMessage;
				},
				setValueState: function() {
					iState++;
				},
				updateMessages: function(sName, aMessages) {
					if (aMessages && aMessages.length > 0) {
						this.setValueState(aMessages[0].type);
						this.setValueStateText(aMessages[0].message);
					} else {
						this.setValueState(sap.ui.core.ValueState.None);
					}
				}
			};

			oParent = {
				getShowValueStateMessage: function() {
					return bShowValueState;
				},
				bindProperty: function(sName) {
					//assert.equal(sName, "enabled");
				},
				setFilterSuggests: function() {

				},
				setShowValueHelp: function() {

				},
				setShowSuggestion: function() {

				},
				attachFormatError: function(fErr) {
					fParentError = fErr;
				},
				attachParseError: function(fErr) {
					fParentError = fErr;
				},
				attachValidationError: function(fErr) {
					fParentError = fErr;
				},
				attachValidationSuccess: function(fSucc) {
					fParentSucc = fSucc;
				},
				fireValidationSuccess: function(oParam) {
					fParentSucc(oParam);
				},
				fireFormatError: function(oParam) {
					fParentError(oParam);
				},
				fireParseError: function(oParam) {
					fParentError(oParam);
				},
				fireValidationError: function(oParam) {
					fParentError(oParam);
				},
				setValueStateText: function(sText) {
					if (sText === "SuccessMessage") {
						iText++;
					} else if (sText === "ErrorMessage") {
						iText++;
					}

					sMessage = sText;
				},
				getValueStateText: function() {
					return sMessage;
				},
				setValueState: function() {
					iState++;
				},
				updateMessages: function(sName, aMessages) {
					if (aMessages && aMessages.length > 0) {
						this.setValueState(aMessages[0].type);
						this.setValueStateText(aMessages[0].message);
					} else {
						this.setValueState(sap.ui.core.ValueState.None);
					}
				}
			};

			oFactory = new sap.ui.comp.smartfield.ControlFactoryBase(this.oModel, oParent, {
				entitySet: "Project",
				path: "Description"
			});
			oFactory.checkMandatory = function() {
				return {
					getSource: function() {
						return oControl;
					},
					getParameter: function() {
						return {
							message: "checkMandatory"
						};
					}
				};
			};

			oFactory.addValidations(oControl);
			assert.equal(iFormat, 4);

			fSuccess({
				getParameter: function() {
					return {
						name: "SuccessMessage",
						message: "SuccessMessage"
					}
				},
				getSource: function() {
					return oControl;
				}
			});
			fError({
				getParameter: function() {
					return {
						name: "ErrorMessage",
						message: "ErrorMessage"
					}
				},
				getSource: function() {
					return oControl;
				}
			});
			assert.equal(iText, 2);
			assert.equal(iState, 2);

			bShowValueState = false;
			fSuccess({
				getParameter: function() {
					return {
						name: "SuccessMessage",
						message: "SuccessMessage"
					}
				},
				getSource: function() {
					return oControl;
				}
			});
			assert.equal(oControl.getValueStateText(), "SuccessMessage");
			oFactory.destroy();
		});

		/*			
		 QUnit.test("upate messages on child control: swap backend to client and back", function() {
		 var oFactory,oControl, oParent, aMessages, sMessage;		
		
		 oControl = {
		 getShowValueStateMessage : function() {
		 return bShowValueState;
		 },
		 bindProperty : function(sName) {
		 //assert.equal(sName, "enabled");
		 },
		 setFilterSuggests : function() {
		
		 },
		 setShowValueHelp : function() {
		
		 },
		 setShowSuggestion : function() {
		
		 },
		 attachFormatError : function(fErr) {

		 },
		 attachParseError : function() {

		 },
		 attachValidationError : function() {

		 },
		 attachValidationSuccess : function(fSucc) {

		 },
		 fireValidationSuccess: function(oParam) {
		
		 },
		 fireFormatError: function(oParam) {

		 },
		 fireParseError: function(oParm) {

		 },
		 fireValidationError: function(oParam) {

		 },
		 setValueStateText : function(sText) {
		 },
		 getValueStateText : function() {

		 },					
		 setValueState : function() {

		 },
		 updateMessages : function(sName, aMessages) {

		 },
		 getParent : function() {
		 return oParent;
		 }
		 };
		
		 oParent = {
		 getShowValueStateMessage : function() {

		 },
		 bindProperty : function(sName) {

		 },
		 setFilterSuggests : function() {
		
		 },
		 setShowValueHelp : function() {
		
		 },
		 setShowSuggestion : function() {
		
		 },
		 attachFormatError : function(fErr) {

		 },
		 attachParseError : function(fErr) {

		 },
		 attachValidationError : function(fErr) {

		 },
		 attachValidationSuccess : function(fSucc) {

		 },
		 fireValidationSuccess: function(oParam) {

		 },
		 fireFormatError: function(oParam) {

		 },
		 fireParseError: function(oParam) {

		 },
		 fireValidationError: function(oParam) {

		 },
		 setValueStateText : function(sText) {
		 sMessage = sText;
		 },
		 getValueStateText : function() {
		 return sMessage;
		 },					
		 setValueState : function() {

		 },
		 updateMessages : function(sName, aMessages) {
		 if (aMessages && aMessages.length > 0) {
		 this.setValueState(aMessages[0].type);
		 this.setValueStateText(aMessages[0].message);
		 } else {
		 this.setValueState(sap.ui.core.ValueState.None);
		 }
		 }
		 };		
		
		 oFactory = new sap.ui.comp.smartfield.ControlFactoryBase(this.oModel, oParent, {
		 entitySet : "Project",
		 path: "Description"
		 });
		 oFactory.checkMandatory = function() {
		 return null;
		 };
		 oFactory.addValidations(oControl);
		
		 // simuate a back-end message.
		 oControl.updateMessages(null, [{
		 type: "Error",
		 message: "backend message"
		 }]);
		 assert.equal(oParent.getValueStateText(), "backend message");
		
		 // simuate a client message.
		 oControl.updateMessages(null, [{
		 type: "Error",
		 message: "client message"
		 }], true);
		 assert.equal(oParent.getValueStateText(), "client message");
		
		 // simuate a client message resolved => show back-end message again.
		 oControl.updateMessages(null, null, true);
		 assert.equal(oParent.getValueStateText(), "backend message");
		 oFactory.destroy();
		 });
		 */
		QUnit.test("addValueHelp", function() {
			var oMeta, oMetaData, oSet, oType, oFactory, i, iCount = 0, fOnValueListChange, oAnnotation, oControl = {
				bindProperty: function(sName) {
					//assert.equal(sName, "enabled");
				},
				getBindingInfo: function() {
					//Consider using sinon.createStubInstance instead of this dummy object
				},
				setFilterSuggests: function() {

				},
				setShowValueHelp: function() {

				},
				setShowSuggestion: function() {

				},
				getConfiguration: function() {
					return {
						getDisplayBehaviour: function() {
							return null;
						},
						getPreventInitialDataFetchInValueHelpDialog: function() {
							return false;
						}
					};
				},
				data: function() {
					return "descriptionAndId";
				}
			};

			var oVHPStub = this.stub(sap.ui.comp.providers, "ValueHelpProvider");
			oVHPStub.returns(function() {
				return {
					destroy: function() {
						//iDestroy++;
					}
				};
			});
			

			var oVLPStub = this.stub(sap.ui.comp.providers, "ValueListProvider");
			oVLPStub.returns(function() {
				return {
					destroy: function() {
						//iDestroy++;
					}
				};
			});

			oFactory = new sap.ui.comp.smartfield.ControlFactoryBase(this.oVHModel, oControl);

			oMetaData = new sap.ui.comp.smartfield.ODataHelper(this.oVHModel);
			oSet = oMetaData.oMeta.getODataEntitySet("Headers");
			oType = oMetaData.oMeta.getODataEntityType(oSet.entityType);
			oMeta = {
				entityType: oType,
				entitySet: oSet,
				path: "AccountingDocumentCategory"
			};

			oMetaData.getProperty(oMeta);
			oAnnotation = "NameSpace.Entity/SomeProperty";
			oMeta.property["sap:value-list"] = "standard";

			fOnValueListChange = function(oEvent) {
				iCount++;
			};

			oFactory.addValueHelp(oControl, oMeta.property, {
				annotation: oAnnotation
			}, this.oVHModel, fOnValueListChange);
			assert.equal(oFactory._aProviders.length, 2);

			for (i = 0; i < 2; i++) {
				oFactory._aProviders[i].fireEvent("valueListChanged", {
					"changes": {}
				})
			}
			assert.equal(iCount, 2);

			oFactory._aProviders = [];

			oVHPStub.restore();
			oVLPStub.restore();
			oMetaData.destroy();
			oFactory.destroy();
		});

		 QUnit.test("addValueHelp - preventInitialDataFetch", function() {
				var oMeta, oMetaData, oSet, oType, oFactory, i, iCount = 0, fOnValueListChange, oAnnotation, oControl = {
					bindProperty: function(sName) {
						//assert.equal(sName, "enabled");
					},
					getBindingInfo: function() {
						//Consider using sinon.createStubInstance instead of this dummy object
					},
					setFilterSuggests: function() {

					},
					setShowValueHelp: function() {

					},
					setShowSuggestion: function() {

					},
					getConfiguration: function() {
						return {
							getDisplayBehaviour: function() {
								return null;
							},
							getPreventInitialDataFetchInValueHelpDialog: function() {
								return false;
							}
						};
					},
					data: function() {
						return "descriptionAndId";
					}
				};

				var oVHPStub = this.stub(sap.ui.comp.providers, "ValueHelpProvider");
				oVHPStub.returns(function() {
					return {
						destroy: function() {
							//iDestroy++;
						}
					};
				});
				

				var oVLPStub = this.stub(sap.ui.comp.providers, "ValueListProvider");
				oVLPStub.returns(function() {
					return {
						destroy: function() {
							//iDestroy++;
						}
					};
				});

				oFactory = new sap.ui.comp.smartfield.ControlFactoryBase(this.oVHModel, oControl);

				oMetaData = new sap.ui.comp.smartfield.ODataHelper(this.oVHModel);
				oSet = oMetaData.oMeta.getODataEntitySet("Headers");
				oType = oMetaData.oMeta.getODataEntityType(oSet.entityType);
				oMeta = {
					entityType: oType,
					entitySet: oSet,
					path: "AccountingDocumentCategory"
				};

				oMetaData.getProperty(oMeta);
				oAnnotation = "NameSpace.Entity/SomeProperty";
				oMeta.property["sap:value-list"] = "standard";

// 				fOnValueListChange = function(oEvent) {
// 					iCount++;
// 				};

				oFactory.addValueHelp(oControl, oMeta.property, {
					annotation: oAnnotation
				}, this.oVHModel, fOnValueListChange);
				
				assert.equal(oFactory._aProviders[0].preventInitialDataFetchInValueHelpDialog, false);

				oFactory._aProviders = [];

				oVHPStub.restore();
				oVLPStub.restore();
				oMetaData.destroy();
				oFactory.destroy();
			});
		 
		QUnit.test("addValueHelp - nothing created", function() {
			var oFactory, oAnnotation, oControl = {
				bindProperty: function(sName) {
					//assert.equal(sName, "enabled");
				},
				setFilterSuggests: function() {

				},
				setShowValueHelp: function() {

				},
				setShowSuggestion: function() {

				}
			};
			oAnnotation = "Project/foo" //irrelevant - this is now the path;
			oFactory = new sap.ui.comp.smartfield.ControlFactoryBase(this.oModel, oControl, {
				entitySet: "Project",
				path: "Description"
			});
			oFactory.addValueHelp(oControl, {}, {
				annotation: oAnnotation
			});
			assert.equal(oFactory._aProviders.length, 0);

			oFactory.destroy();
		});

		QUnit.test("getAttribute", function() {
			var oFactory, oParent, oResult;

			oParent = {
				getBindingContext: function() {
					return {
						sPath: "/Project(id1='71' id2='abcd')"
					};
				},
				getModel: function() {
					return this.oModel;
				},
				getBindingInfo: function(sProperty) {
					if (sProperty === "value") {
						return {
							parts: [
								{
									model: undefined,
									path: "StartDateTime"
								}
							]
						};
					}
				},
				getWidth: function() {
					return "100%";
				},
				getTextAlign: function() {
					return null;
				},
				getPlaceholder: function() {
					return null;
				},
				getName: function() {
					return null;
				}
			};
			oFactory = new sap.ui.comp.smartfield.ControlFactoryBase(this.oModel, oParent, {
				entitySet: "Project",
				path: "StartDateTime"
			});

			oResult = oFactory.getAttribute("value");
			assert.equal(oResult, "StartDateTime");

			oResult = oFactory.getAttribute("width");
			assert.equal(oResult, "100%");

			oResult = oFactory.getAttribute("textAlign");
			assert.equal(!oResult, true);

			oFactory.destroy();
		});

		QUnit.test("createAttributes", function() {
			var oFactory, oParent, oResult, bSelected, bExc, mNames;

			oParent = {
				getBindingContext: function() {
					return {
						sPath: "/Project(id1='71' id2='abcd')"
					};
				},
				getModel: function() {
					return this.oModel;
				},
				getBindingInfo: function(sProperty) {
					if (sProperty === "value") {
						return {
							parts: [
								{
									model: undefined,
									path: "StartDateTime"
								}
							]
						};
					}
				},
				getWidth: function() {
					return "100%";
				},
				getTextAlign: function() {
					return null;
				},
				getPlaceholder: function() {
					return null;
				},
				getName: function() {
					return null;
				},
				fireChange: function(oParam) {
					bSelected = oParam.newValue;
				},
				getObjectBinding: function() {
					return {
						sPath: "binding"
					};
				}
			};
			oFactory = new sap.ui.comp.smartfield.ControlFactoryBase(this.oModel, oParent);
			oFactory._oTypes = {
				getType: function() {
					return "test";
				}
			};
			oFactory._oMetaData = {
				model: "Project",
				path: "StartDateTime"
			};
			mNames = {
				width: true,
				textAlign: true,
				placeholder: true,
				name: true
			};
			oResult = oFactory.createAttributes("value", null, mNames, {
				event: "select",
				parameter: "selected"
			});
			oResult.select({
				mParameters: {
					selected: true
				}
			});
			assert.equal(bSelected, true);
			assert.equal(oResult.value.path, "StartDateTime");
			assert.equal(oResult.value.model, "Project");
			assert.equal(oResult.width, "100%");
			assert.equal(oResult.objectBindings.Project, "binding");

			//check exception handling
			oParent.fireChange = function() {
				bExc = true;
				throw "exc";
			};
			try {
				oResult.select({
					mParameters: {
						selected: true
					}
				});
			} catch (ex) {
				//should not happen
				bExc = false;
			}
			assert.equal(bExc, true);

			oFactory.destroy();
		});

		QUnit.test("mapBindings", function() {
			var oFactory, oParent, mNames, mAttributes = {};

			oParent = {
				getBindingContext: function() {
					return {
						sPath: "/Project(id1='71' id2='abcd')"
					};
				},
				getModel: function() {
					return this.oModel;
				},
				getBindingInfo: function(sProperty) {
					if (sProperty === "value") {
						return {
							parts: [
								{
									model: undefined,
									path: "StartDateTime"
								}
							]
						};
					}
				},
				getWidth: function() {
					return "100%";
				},
				getTextAlign: function() {
					return null;
				},
				getPlaceholder: function() {
					return null;
				},
				getName: function() {
					return null;
				},
				fireChange: function(oParam) {
					bSelected = oParam.newValue;
				},
				getObjectBinding: function() {
					return {
						sPath: "binding"
					};
				}
			};
			oFactory = new sap.ui.comp.smartfield.ControlFactoryBase(this.oModel, oParent);
			mNames = {
				"value": "value1",
				"width": "width1"
			};

			oFactory.mapBindings(mAttributes, mNames);
			assert.equal(typeof (mAttributes.value1), "object");
			assert.equal(mAttributes.width1, "100%");

			oFactory.destroy();
		});

		QUnit.test("addObjectBinding", function() {
			var oFactory, oParent, mAttributes = {};

			oParent = {
				getObjectBinding: function() {
					return {
						sPath: "binding"
					};
				}
			};
			oFactory = new sap.ui.comp.smartfield.ControlFactoryBase(this.oModel, oParent);
			oFactory._oMetaData = {
				model: "Project",
				path: "StartDateTime"
			};
			oFactory.addObjectBinding(mAttributes);
			assert.equal(mAttributes.objectBindings.Project, "binding");

			oFactory.destroy();
		});

		QUnit.test("getFormatSettings", function() {
			var oFactory, oParent, mAttributes;

			oParent = {
				data: function() {
					return '\{"style":"long"\}';
				}
			};

			oFactory = new sap.ui.comp.smartfield.ControlFactoryBase(this.oModel, oParent);
			mAttributes = oFactory.getFormatSettings("dateFormatSettings");
			mAttributes = assert.equal(mAttributes.style, "long");

			oFactory.destroy();
		});

		QUnit.test("getFormatSettingst - broken", function() {
			var oFactory, oParent, mAttributes = {};

			oParent = {
				data: function() {
					return '\{"style":long"\}';
				}
			};

			oFactory = new sap.ui.comp.smartfield.ControlFactoryBase(this.oModel, oParent);
			mAttributes = oFactory.getFormatSettings(mAttributes);
			assert.equal(!mAttributes, true);

			oFactory.destroy();
		});

		QUnit.test("getFormatSettingst - from config", function() {
			var oFactory, oParent, mAttributes = {};

			oParent = {
				data: function() {
					return null;
				},
				getCustomData: function() {
					return [
						{
							getKey: function() {
								return "dateFormatSettings";
							},
							getValue: function() {
								return '\{"style":"long"\}';
							}
						}
					];
				}
			};

			oFactory = new sap.ui.comp.smartfield.ControlFactoryBase(this.oModel, oParent);
			mAttributes = oFactory.getFormatSettings("dateFormatSettings");
			assert.equal(mAttributes.style, "long");

			oFactory.destroy();
		});

		QUnit.test("_formatDisplayBehaviour", function() {
			var oFactory, oParent, sReturn, mAttributes = {};

			oParent = {
				data: function() {
					return "idAndDescription";
				},
				getCustomData: function() {
					return [
						{
							getKey: function() {
								return "dateFormatSettings";
							},
							getValue: function() {
								return '\{"style":"long"\}';
							}
						}
					];
				},
				getConfiguration: function() {
					return null;
				}
			};

			oFactory = new sap.ui.comp.smartfield.ControlFactoryBase(this.oModel, oParent);
			sReturn = oFactory._formatDisplayBehaviour("defaultInputFieldDisplayBehaviour", "id", "descr");
			assert.equal(sReturn, "id (descr)");

			sReturn = oFactory._formatDisplayBehaviour("defaultCheckBoxDisplayBehaviour", "id");
			assert.ok(sReturn);

			oParent.data = function() {
				return "OnOff";
			};
			sReturn = oFactory._formatDisplayBehaviour("defaultCheckBoxDisplayBehaviour", "OnOff");
			assert.ok(sReturn);

			oParent.data = function() {
				return "TrueFalse";
			};
			sReturn = oFactory._formatDisplayBehaviour("defaultCheckBoxDisplayBehaviour", "TrueFalse");
			assert.ok(sReturn);

			oFactory.destroy();
		});

		QUnit.test("Shall be destructible", function() {
			var oFactory, oParent, oProvider, bDestroy = false;

			oParent = {
				getBindingContext: function() {
					return {
						sPath: "/Project(id1='71' id2='abcd')"
					};
				},
				getModel: function() {
					return this.oModel;
				},
				getBindingInfo: function(sProperty) {
					if (sProperty === "value") {
						return {
							parts: [
								{
									model: undefined,
									path: "StartDateTime"
								}
							]
						};
					}
				},
				getWidth: function() {
					return "100%";
				},
				getTextAlign: function() {
					return null;
				},
				getPlaceholder: function() {
					return null;
				},
				getName: function() {
					return null;
				}
			};
			oFactory = new sap.ui.comp.smartfield.ControlFactoryBase(this.oModel, oParent, {
				entitySet: "Project",
				path: "StartDateTime"
			});
			oProvider = {
				destroy: function() {
					bDestroy = true;
				}
			};
			oFactory._aProviders.push(oProvider);
			oFactory.destroy();
			assert.ok(oFactory);
			assert.equal(oFactory._oParent, null);
			assert.equal(bDestroy, true);
		});

	}());
</script>
</head>
<body id="body" class="sapUiBody">
	<h1 id="qunit-header">qUnit Page for qUnit Page for
		sap.ui.comp.smartfield.ControlFactoryBase</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>
</body>
</html>
