<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>qUnit Page for sap.ui.comp.smartform.GroupElement</title>

<script id="sap-ui-bootstrap" type="text/javascript"
	src="../../../../../resources/sap-ui-core.js"
	data-sap-ui-theme="sap_bluecrystal" data-sap-ui-noConflict="true"
	data-sap-ui-libs="sap.ui.comp">
	
</script>

<link rel="stylesheet"
	href="../../../../../resources/sap/ui/thirdparty/qunit.css"
	type="text/css" media="screen" />
<script type="text/javascript"
	src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script type="text/javascript"
	src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script type="text/javascript"
	src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
<script type="text/javascript"
	src="../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
<script type="text/javascript"
	src="../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>


<script type="text/javascript">
	/*globals QUnit, sinon*/

	if (!(sap.ui.Device.browser.internet_explorer && sap.ui.Device.browser.version <= 8)) {
		jQuery.sap.require("sap.ui.qunit.qunit-coverage");
	}
	(function(QUnit, sinon) {
		'use strict';

		jQuery.sap.require("sap.ui.comp.smartform.GroupElement");
		jQuery.sap.require("sap.ui.comp.smartfield.SmartField");
		jQuery.sap.require("sap.ui.comp.smartfield.SmartLabel");
		jQuery.sap.require("sap.ui.core.CustomData");
		jQuery.sap.require("sap.ui.core.TooltipBase");
		jQuery.sap.require("sap.m.VBox");
		jQuery.sap.require("sap.m.Label");

		QUnit.module("sap.ui.comp.smartform.GroupElement", {
			beforeEach: function() {
				this.oGroupElement = new sap.ui.comp.smartform.GroupElement();
			},
			afterEach: function() {
			}
		});

		QUnit.test("Shall be instantiable", function(assert) {
			assert.ok(this.oGroupElement);
		});

		QUnit.test("method setLabel as string", function(assert) {

			this.oGroupElement.setLabel("SOME TEXT");

			var oLabel = this.oGroupElement.getLabel();
			assert.ok(oLabel);
			assert.ok(oLabel instanceof sap.m.Label);
			assert.equal(oLabel.getText(), "SOME TEXT");

		});

		QUnit.test("method setLabel as object", function(assert) {

			var oLabel = new sap.m.Label({
				text: "SOME TEXT"
			});
			this.oGroupElement.setLabel(oLabel);

			var oLabelNew = this.oGroupElement.getLabel();
			assert.ok(oLabelNew);
			assert.ok(oLabel === oLabelNew);
			assert.equal(oLabelNew.getText(), "SOME TEXT");

		});

		QUnit.test("method getLabelText", function(assert) {

			this.oGroupElement.setLabel(new sap.m.Label({
				text: "SOME TEXT"
			}));

			var sLabelText = this.oGroupElement.getLabelText();
			assert.equal(sLabelText, "SOME TEXT");
		});

		QUnit.test("method setTooltip as string", function(assert) {

			this.oGroupElement.setTooltip("SOME TOOLTIP");

			var oTooltip = this.oGroupElement.getTooltip();
			assert.ok(oTooltip);
			assert.ok(oTooltip instanceof sap.ui.core.TooltipBase);
			assert.equal(oTooltip.getText(), "SOME TOOLTIP");
		});

		QUnit.test("method setTooltip as object", function(assert) {

			var oTooltip = new sap.ui.core.TooltipBase({
				text: "SOME TOOLTIP"
			});
			this.oGroupElement.setTooltip(oTooltip);

			var oTooltipNew = this.oGroupElement.getTooltip();
			assert.ok(oTooltipNew);
			assert.ok(oTooltip === oTooltipNew);
			assert.equal(oTooltipNew.getText(), "SOME TOOLTIP");
		});

		QUnit.test("method setElementForLabel", function(assert) {

			this.oGroupElement.setElementForLabel(2);
			assert.equal(this.oGroupElement.getElementForLabel(), 2);
		});

		QUnit.test("method setUseHorizontalLayout", function(assert) {

			this.oGroupElement.setUseHorizontalLayout(false);
			assert.ok(!this.oGroupElement.getUseHorizontalLayout());

			this.oGroupElement.setUseHorizontalLayout(true);
			assert.ok(this.oGroupElement.getUseHorizontalLayout());
		});

		QUnit.test("method _updateLayout", function(assert) {

			this.oGroupElement.setUseHorizontalLayout(true);

			this.oGroupElement.addElement(new sap.m.Label());
			this.oGroupElement.addElement(new sap.ui.comp.smartfield.SmartField());
			this.oGroupElement.addElement(new sap.ui.comp.smartfield.SmartField());
			this.oGroupElement._updateLayout();

			assert.equal(this.oGroupElement.getFields()[0].getItems()[1] instanceof sap.m.HBox, true, "HBox created");
		});

		QUnit.test("method _extractFields without label", function(assert) {

			var aElements = [];
			var oVBox = new sap.m.VBox();
			var oHBox = new sap.m.HBox();
			var oSF1 = new sap.ui.comp.smartfield.SmartField();
			var oSF2 = new sap.ui.comp.smartfield.SmartField();

			oHBox.addItem(oSF1);
			oHBox.addItem(oSF2);
			oVBox.addItem(new sap.m.Label());
			oVBox.addItem(oHBox);

			aElements = [
				oVBox
			];
			var aFields = this.oGroupElement._extractFields(aElements, true);

			assert.equal(aFields[0], oSF1, "Smartfield 1 found");
			assert.equal(aFields[1], oSF2, "Smartfield 2 found");
		});

		QUnit.test("method _extractFields with label", function(assert) {

			var aElements = [];

			var oLabel = new sap.m.Label();
			var oSF = new sap.ui.comp.smartfield.SmartField();

			aElements = [
				oLabel, oSF
			];
			var aFields = this.oGroupElement._extractFields(aElements, false);

			assert.deepEqual(aFields[0].getId(), oLabel.getId(), "Label found");
			assert.deepEqual(aFields[1].getId(), oSF.getId(), "Smartfield found");
		});

		QUnit.test("method setVisible", function(assert) {

			sinon.stub(this.oGroupElement, "_updateFormElementVisibility");

			this.oGroupElement.setVisible(false);
			assert.ok(!this.oGroupElement.getVisible());

			this.oGroupElement.setVisible(true);
			assert.ok(this.oGroupElement.getVisible());

			assert.ok(this.oGroupElement._updateFormElementVisibility.calledTwice);
		});

		QUnit.test("method setProperty", function(assert) {

			sinon.stub(this.oGroupElement, "_updateFormElementVisibility");

			this.oGroupElement.setProperty("visible", false);

			assert.ok(!this.oGroupElement.getVisible());
			assert.ok(this.oGroupElement._updateFormElementVisibility.calledOnce);
		});

		QUnit.test("method setHorizontalLayoutGroupElementMinWidth ", function(assert) {

			sinon.stub(this.oGroupElement, "_updateLayout");
			this.oGroupElement.setHorizontalLayoutGroupElementMinWidth(100);

			var nValue = this.oGroupElement.getHorizontalLayoutGroupElementMinWidth();
			assert.equal(nValue, 100);

			assert.ok(this.oGroupElement._updateLayout.called);
		});

		QUnit.test("method addCustomData", function(assert) {

			var oSmartField = new sap.ui.comp.smartfield.SmartField();
			var aFields = [
				oSmartField
			];
			sinon.stub(this.oGroupElement, "getFields").returns(aFields);

			var oCustomdata = new sap.ui.core.CustomData({
				key: "KEY",
				value: "VALUE"
			});
			this.oGroupElement.addCustomData(oCustomdata);

			var aCustomdata = oSmartField.getCustomData();
			assert.ok(aCustomdata);
			assert.equal(aCustomdata.length, 1);
			assert.equal(aCustomdata[0].key, oCustomdata.key);
			assert.equal(aCustomdata[0].value, oCustomdata.value);
		});

		QUnit.test("method getFormElement", function(assert) {

			var oFormElement = this.oGroupElement.getFormElement();

			assert.equal(oFormElement, this.oGroupElement);
		});

		QUnit.test("method getElements", function(assert) {

			sinon.spy(this.oGroupElement, "getFields");
			this.oGroupElement.getElements();

			assert.ok(this.oGroupElement.getFields.called);
		});

		QUnit.test("method insertElement", function(assert) {

			var oSmartField = new sap.ui.comp.smartfield.SmartField();

			sinon.spy(this.oGroupElement, "insertField");
			this.oGroupElement.insertElement(oSmartField, 0);

			assert.ok(this.oGroupElement.insertField.called);
		});

		QUnit.test("method addElement", function(assert) {
			var oSmartField = new sap.ui.comp.smartfield.SmartField();

			sinon.stub(this.oGroupElement, "_updateLayout");
			sinon.stub(this.oGroupElement, "updateLabelOfFormElement");

			sinon.stub(this.oGroupElement, "_updateFormElementVisibility");
			sinon.stub(this.oGroupElement, "_updateFormElementEditable");

			//CUT -> test that internal methods have been called  
			this.oGroupElement.addElement(oSmartField);
			assert.equal(this.oGroupElement._updateLayout.called, true, "method _updateLayout was not called");
			assert.equal(this.oGroupElement.updateLabelOfFormElement.called, true, "method updateLabelOfFormElement was not called");

			//CUT -> test that callback methods are called if inner elements are changed
			this.oGroupElement.setEditMode(true);
			assert.equal(this.oGroupElement._updateFormElementEditable.called, true, "method _updateFormElementEditable was not called");
			oSmartField.setVisible(true);
			assert.equal(this.oGroupElement._updateFormElementVisibility.called, true, "method _updateFormElementVisibility was not called");
		});

		QUnit.test("method getVisibleBasedOnElements", function(assert) {

			var oSmartField0 = new sap.ui.comp.smartfield.SmartField({
				visible: false
			});
			var oSmartField1 = new sap.ui.comp.smartfield.SmartField({
				visible: false
			});

			this.oGroupElement.addField(oSmartField0);
			this.oGroupElement.addField(oSmartField1);

			var bVisible = this.oGroupElement.getVisibleBasedOnElements();
			assert.ok(!bVisible);

			oSmartField1.setVisible(true);
			bVisible = this.oGroupElement.getVisibleBasedOnElements();
			assert.ok(bVisible);
		});

		QUnit.test("method _updateFormElementLabel", function(assert) {

			var oSmartField0 = new sap.ui.comp.smartfield.SmartField({
				visible: false
			});
			var oSmartField1 = new sap.ui.comp.smartfield.SmartField({
				visible: false
			});

			this.oGroupElement.addField(oSmartField0);
			this.oGroupElement.addField(oSmartField1);

			this.oGroupElement.setElementForLabel(1);

			sinon.stub(this.oGroupElement, "updateLabelOfFormElement");

			var oEvent = {
				oSource: oSmartField1,
				getParameters: function() {
					return [];
				}
			};

			this.oGroupElement._updateFormElementLabel(oEvent);
			assert.ok(this.oGroupElement.updateLabelOfFormElement.called);
		});

		QUnit.test("method _getFieldRelevantForLabel", function(assert) {

			var oSmartField0 = new sap.ui.comp.smartfield.SmartField({
				visible: false
			});
			var oSmartField1 = new sap.ui.comp.smartfield.SmartField({
				visible: false
			});

			this.oGroupElement.addField(oSmartField0);
			this.oGroupElement.addField(oSmartField1);

			this.oGroupElement.setElementForLabel(1);

			var oField = this.oGroupElement._getFieldRelevantForLabel();
			assert.ok(oField === oSmartField1);
		});

		QUnit.test("method _updateFormElementVisibility", function(assert) {

			var oSmartField0 = new sap.ui.comp.smartfield.SmartField({
				visible: false
			});
			var oSmartField1 = new sap.ui.comp.smartfield.SmartField({
				visible: true
			});

			this.oGroupElement.addField(oSmartField0);
			this.oGroupElement.addField(oSmartField1);

			this.oGroupElement._updateFormElementVisibility();
			assert.ok(this.oGroupElement.getVisible());

			oSmartField1.setVisible(false);
			this.oGroupElement._updateFormElementVisibility();
			assert.ok(!this.oGroupElement.getVisible());

		});

		QUnit.test("method _updateFormElementVisibility where a VBox is used (coming from useHorizontalLayout = true in SmartForm)", function(assert) {

			var oSmartField = new sap.ui.comp.smartfield.SmartField({
				showLabel: true,
				visible: true
			});

			this.oGroupElement.setLabel("TestLabel");
			this.oGroupElement.addElement(oSmartField);
			this.oGroupElement.updateLabelOfFormElement();
			this.oGroupElement.setUseHorizontalLayout(true);

			//Check oGroupElement has only one element which has to be a VBOX
			assert.ok(this.oGroupElement.getVisible(), "GroupElement shall be visible");
			assert.ok(this.oGroupElement.getElements(), "GroupElement shall have child elements");
			assert.equal(this.oGroupElement.getElements().length, 1, "Number of child elements in GroupElement shall only be ONE");
			assert.equal(this.oGroupElement.getElements()[0] instanceof sap.m.VBox, true, "child element in GroupElement shall be a VBox");

			//Check that methold sequence before did create/arrange VBox with two child objects 
			var oVBox = this.oGroupElement.getElements()[0];
			assert.ok(oVBox.getItems(), "VBox as GroupElement child shall have child objects");
			assert.equal(oVBox.getItems().length, 2, "VBox shall have to child objects");
			assert.equal(oVBox.getItems()[0] instanceof sap.ui.comp.smartfield.SmartLabel, true, "First child in VBox shall be a SmartLabel");
			assert.equal(oVBox.getItems()[1] instanceof sap.ui.comp.smartfield.SmartField, true, "Second child in VBox shall be the SmartField");

			//CUT -> change visibility of the SmartField and check that the whole GroupElement will switched off 
			oSmartField.setVisible(false);
			assert.ok(!this.oGroupElement.getVisible());
		});

		QUnit.test("method _getVisibilityOfFields)", function(assert) {
			var bVisibility = null;

			var oSmartLabel = new sap.ui.comp.smartfield.SmartLabel({
				text: "TestLabel",
				visible: false
			});
			var oSmartField = new sap.ui.comp.smartfield.SmartField({
				visible: true
			});
			var aFields = [
				oSmartLabel, oSmartField
			];

			//CUT -> one of two objects is visible 
			bVisibility = this.oGroupElement._getVisibilityOfFields(aFields);
			assert.ok(bVisibility, "Visibility shall be true as it exist at least one visible child object in the array");

			//CUT -> all included objects are invisible
			oSmartField.setVisible(false);
			bVisibility = this.oGroupElement._getVisibilityOfFields(aFields);
			assert.ok(!bVisibility, "Visibility shall be false as all included child object are invisble");

			//CUT -> SmartLabels shall be ignored and SmartField is invisible
			oSmartLabel.setVisible(true);
			oSmartField.setVisible(false);
			bVisibility = this.oGroupElement._getVisibilityOfFields(aFields, true);
			assert.ok(!bVisibility, "Visibility shall be false as included SmartFields shall be ignored");

			//CUT -> SmartLabels shall be ignored and SmartField is visible
			oSmartLabel.setVisible(false);
			oSmartField.setVisible(true);
			bVisibility = this.oGroupElement._getVisibilityOfFields(aFields, true);
			assert.ok(bVisibility, "Visibility shall be true as SmartLabel shall be ignored and the SmartField is visible");

			var oVBox = new sap.m.VBox({
				items: [
					oSmartLabel, oSmartField
				]
			});
			aFields = [
				oVBox
			];

			//CUT -> VBox with SmartLabel & SmartField
			oSmartField.setVisible(true);
			bVisibility = this.oGroupElement._getVisibilityOfFields(aFields);
			assert.ok(bVisibility, "Visibility shall be true as the SmartField in the VBox is visible");

			//CUT -> VBox with SmartLabel & SmartField
			oSmartLabel.setVisible(true);
			oSmartField.setVisible(false);
			bVisibility = this.oGroupElement._getVisibilityOfFields(aFields);
			assert.ok(!bVisibility, "Visibility shall be false as SmartLabels in a VBox shall be automatically ignored");
		});

		QUnit.test("method setEditMode", function(assert) {

			var oSmartField0 = new sap.ui.comp.smartfield.SmartField();
			var oSmartField1 = new sap.ui.comp.smartfield.SmartField();

			this.oGroupElement.addField(oSmartField0);
			this.oGroupElement.addField(oSmartField1);

			assert.ok(oSmartField0.getEditable());
			assert.ok(oSmartField1.getEditable());

			this.oGroupElement.setEditMode(false);

			assert.ok(!oSmartField0.getContextEditable());
			assert.ok(!oSmartField1.getContextEditable());
		});

		QUnit.test("method setEditMode with VBox", function(assert) {

			var oSmartField0 = new sap.ui.comp.smartfield.SmartField();
			var oSmartField1 = new sap.ui.comp.smartfield.SmartField();

			var oVBox = new sap.m.VBox();
			oVBox.addItem(oSmartField0);
			oVBox.addItem(oSmartField1);

			this.oGroupElement.addField(oVBox);

			assert.ok(oSmartField0.getEditable());
			assert.ok(oSmartField1.getEditable());

			this.oGroupElement.setEditMode(false);

			assert.ok(!oSmartField0.getContextEditable());
			assert.ok(!oSmartField1.getContextEditable());
		});

		QUnit.test("method _createLabel", function(assert) {

			var oSmartField0 = new sap.ui.comp.smartfield.SmartField();
			var oSmartField1 = new sap.ui.comp.smartfield.SmartField();

			this.oGroupElement.addField(oSmartField0);
			this.oGroupElement.addField(oSmartField1);

			this.oGroupElement.setElementForLabel(1);

			var oLabel = this.oGroupElement._createLabel("NEW LABEL");
			assert.ok(oLabel);
			assert.ok(oLabel instanceof sap.ui.comp.smartfield.SmartLabel);
			assert.equal(oLabel.getText(), "NEW LABEL");

			assert.equal(oSmartField1.getTextLabel(), "NEW LABEL");
		});

		QUnit.test("method setLabel with a smartField inside", function(assert) {

			var oGroupElement = new sap.ui.comp.smartform.GroupElement({
				label: "OLD LABEL"
			});
			var oSmartField0 = new sap.ui.comp.smartfield.SmartField();
			var oSmartField1 = new sap.ui.comp.smartfield.SmartField();

			oGroupElement.addField(oSmartField0);
			oGroupElement.addField(oSmartField1);

			assert.equal(oGroupElement.getLabelText(), "OLD LABEL");

			oGroupElement.setLabel("NEW LABEL");
			assert.equal(oGroupElement.getLabelText(), "NEW LABEL");

			oGroupElement.updateLabelOfFormElement();
			assert.equal(oGroupElement.getLabelText(), "NEW LABEL");
		});

		QUnit.test("method updateLabelOfFormElement with SmartLabel", function(assert) {

			this.oGroupElement.setLabel("LABEL");

			var oSmartField0 = new sap.ui.comp.smartfield.SmartField();
			var oSmartField1 = new sap.ui.comp.smartfield.SmartField();

			this.oGroupElement.addField(oSmartField0);
			this.oGroupElement.addField(oSmartField1);

			this.oGroupElement.setElementForLabel(1);
			this.oGroupElement.updateLabelOfFormElement();

			var oLabel = this.oGroupElement.getLabel();
			assert.ok(oLabel);
			assert.ok(oLabel instanceof sap.ui.comp.smartfield.SmartLabel);
		});

		QUnit.test("method updateLabelOfFormElement with Label", function(assert) {

			this.oGroupElement.setLabel("LABEL");

			this.oGroupElement.updateLabelOfFormElement();

			var oLabel = this.oGroupElement.getLabel();
			assert.ok(oLabel);
			assert.ok(oLabel instanceof sap.m.Label);
		});

		QUnit.test("method removeElement", function(assert) {

			var oSmartField0 = new sap.ui.comp.smartfield.SmartField();
			var oSmartField1 = new sap.ui.comp.smartfield.SmartField();

			this.oGroupElement.addElement(oSmartField0);
			this.oGroupElement.addElement(oSmartField1);

			var oRemovedElement0 = this.oGroupElement.removeElement(0);
			var oRemovedElement1 = this.oGroupElement.removeElement(oSmartField1);

			assert.equal(oSmartField0, oRemovedElement0, "Field0 removed");
			assert.equal(oSmartField1, oRemovedElement1, "Field1 removed");
			assert.equal(this.oGroupElement.getElements().length, 0, "All fields removed");
		});

		QUnit.test("method removeAllElements", function(assert) {

			var oSmartField0 = new sap.ui.comp.smartfield.SmartField();
			var oSmartField1 = new sap.ui.comp.smartfield.SmartField();

			this.oGroupElement.addElement(oSmartField0);
			this.oGroupElement.addElement(oSmartField1);

			var aControl = this.oGroupElement.removeAllElements();

			assert.deepEqual(aControl, [
				oSmartField0, oSmartField1
			], "All fields removed");
		});

		QUnit.test("_getLabel shall return SmartLabel used inside VBox", function(assert) {

			this.oGroupElement.setUseHorizontalLayout(true);

			var oSmartField = new sap.ui.comp.smartfield.SmartField();

			this.oGroupElement.addElement(oSmartField);
			this.oGroupElement.updateLabelOfFormElement();

			var oLabel = this.oGroupElement._getLabel();

			assert.equal(oLabel instanceof sap.ui.comp.smartfield.SmartLabel, true, "SmartLabel returned");
			assert.equal(oLabel.getLabelFor(), oSmartField.getId(), "Label assigned to SmartField");
		});

		QUnit.test("setLabel (string) shall reuse SmartLabel", function(assert) {

			var oSmartField = new sap.ui.comp.smartfield.SmartField();

			this.oGroupElement.addElement(oSmartField);
			this.oGroupElement.updateLabelOfFormElement();

			var oLabelBefore = this.oGroupElement.getLabel();

			this.oGroupElement.setLabel("Label");

			var oLabelAfter = this.oGroupElement.getLabel();

			assert.equal(oLabelAfter.getId(), oLabelBefore.getId(), "Label reused");
			assert.equal(oLabelAfter instanceof sap.ui.comp.smartfield.SmartLabel, true, "Label is SmartLabel");
		});

		QUnit.test("setLabel shall set label inside VBox", function(assert) {

			var oSmartField = new sap.ui.comp.smartfield.SmartField();

			this.oGroupElement.setUseHorizontalLayout(true);
			this.oGroupElement.addElement(oSmartField);
			this.oGroupElement.setLabel("LabelInsideVBox");

			var aElement = this.oGroupElement.getElements();
			var oVBox = aElement[0];

			assert.equal(oVBox instanceof sap.m.VBox, true, "VBox found");
			assert.equal(oVBox.getItems()[0].getText(), "LabelInsideVBox", "Label inside VBox found");
		});

		QUnit.test("Aggregation elements - check aggregation override", function(assert) {

			var oText = new sap.m.Text({
				text: "Text"
			});

			this.oGroupElement.addElement(oText);
			this.oGroupElement.removeAggregation("elements", oText);

			assert.equal(this.oGroupElement.getElements().length, 0, "Element removed (removeAggregation)");

			this.oGroupElement.addElement(oText);
			this.oGroupElement.removeAllAggregation("elements");

			assert.equal(this.oGroupElement.getElements().length, 0, "Element removed (removeAllAggregation)");
		});

	}(QUnit, sinon));
</script>
</head>

<body id="body" class="sapUiBody">
	<h1 id="qunit-header">qUnit Page for
		sap.ui.comp.smartform.GroupElement</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>

	<div id="content"></div>
</body>
</html>
