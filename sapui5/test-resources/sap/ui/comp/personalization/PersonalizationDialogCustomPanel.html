<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta charset="UTF-8">
<title>PersonalizationDialogCustom</title>
<script id="sap-ui-bootstrap" type="text/javascript"
	data-sap-ui-libs="sap.ui.comp,sap.m,sap.ui.commons,sap.ui.table"
	data-sap-ui-theme="sap_bluecrystal" data-sap-ui-preload="sync"
	data-sap-ui-compatVersion="edge"
	src="../../../../../resources/sap-ui-core.js"
	data-sap-ui-resourceroots='{
				"test.sap.ui.comp.personalization": "./"
			}'>
	
</script>
<script>
	jQuery.sap.require("test.sap.ui.comp.personalization.PersonalizationDialog");
	jQuery.sap.require("test.sap.ui.comp.personalization.Util");
	jQuery.sap.require("jquery.sap.xml");
	jQuery.sap.require("sap.ui.comp.personalization.Controller");
	jQuery.sap.require("sap.m.MessageToast");

	// P13nPanel extention
	sap.m.P13nPanel.extend("sap.m.CustomPanelColumns", {
		constructor: function(sId, mSettings) {
			sap.m.P13nPanel.apply(this, arguments);
		},
		metadata: {
			library: "sap.m",
			aggregations: {
				content: {
					type: "sap.m.MultiComboBox",
					multiple: false,
					singularName: "content"
				}
			}
		},
		renderer: function(oRm, oControl) {
			if (!oControl.getVisible()) {
				return;
			}
			oRm.renderControl(oControl.getContent());
		}
	});

	// P13nPanel extention
	sap.m.P13nPanel.extend("sap.m.CustomPanelSetting", {
		constructor: function(sId, mSettings) {
			sap.m.P13nPanel.apply(this, arguments);
		},
		metadata: {
			library: "sap.m",
			aggregations: {
				content: {
					type: "sap.m.RadioButtonGroup",
					multiple: false,
					singularName: "content"
				}
			}
		},
		renderer: function(oRm, oControl) {
			if (!oControl.getVisible()) {
				return;
			}
			oRm.renderControl(oControl.getContent());
		}
	});

	var aContent = [];
	jQuery.ajax({
		url: "../../../../../test-resources/sap/ui/comp/personalization/mockserver/ProductCollection.json",
		dataType: 'text',
		async: false,
		success: function(response, textStatus, xhr) {
			aContent = JSON.parse(response);
		},
		error: function(xhr, textStatus, error) {
		}
	});
	var aPathOfVisibleCols = [
		"Name", "Category", "Price", "Quantity"
	];
	var aPathOfSorter = [];
	var aPathOfFilterer = [];
	var aPathOfIgnoredColumns = [
		"GUID"
	];
	var enumTypes = {
		String: "String",
		Number: "Number",
		Date: "Date",
		Time: "Time",
		Boolean: "Boolean"
	};
	var oJSONData = {
		oDataItems: aContent,
		cols: [
			{
				text: "ProductId",
				path: "ProductId",
				type: enumTypes.String
			}, {
				text: "Category",
				path: "Category",
				type: enumTypes.String
			}, {
				text: "Name",
				path: "Name",
				type: enumTypes.String
			}, {
				text: "Description",
				path: "Description",
				type: enumTypes.String
			}, {
				text: "SupplierName",
				path: "SupplierName",
				type: enumTypes.String
			}, {
				text: "Quantity",
				path: "Quantity",
				type: enumTypes.Number
			}, {
				text: "WeightMeasure",
				path: "WeightMeasure",
				type: enumTypes.Number
			}, {
				text: "WeightUnit",
				path: "WeightUnit",
				type: enumTypes.String
			}, {
				text: "Price",
				path: "Price",
				path2: "CurrencyCode",
				control: "ObjectNumber",
				type: enumTypes.Number
			}, {
				text: "Status",
				path: "Status",
				type: enumTypes.String
			}, {
				text: "CurrencyCode",
				path: "CurrencyCode",
				tableType: "UITable",
				type: enumTypes.String
			}, {
				text: "Width",
				path: "Width",
				type: enumTypes.Number
			}, {
				text: "Depth",
				path: "Depth",
				type: enumTypes.Number
			}, {
				text: "Height",
				path: "Height",
				type: enumTypes.Number
			}, {
				text: "DimUnit",
				path: "DimUnit",
				type: enumTypes.String
			}, {
				text: "Date",
				path: "Date",
				type: enumTypes.Date
			}, {
				text: "Time",
				path: "Time",
				type: enumTypes.Time
			}, {
				text: "GUID",
				path: "GUID",
				type: enumTypes.String
			}, {
				text: "Boolean",
				path: "Bool",
				type: enumTypes.Boolean
			}
		],
		selectedItems: [],
		pathOfVisibleCols: aPathOfVisibleCols,
		pathOfSorter: aPathOfSorter,
		pathOfFilterer: aPathOfFilterer
	};

	// --------------------------------------------------------------------------------------------------------------
	// -------------------------- sap.m.Table with customer columns panel ------------------------------------
	// --------------------------------------------------------------------------------------------------------------	
	var fGetColumnData = function(sColumnKey, aColumnData) {
		var oColumnData = null;
		aColumnData.some(function(oColumnData_) {
			if (oColumnData_.columnKey === sColumnKey) {
				oColumnData = oColumnData_;
				return true;
			}
		});
		return oColumnData;
	};
	var 
	fUpdateTable = function(oTable, aColumnData) {
		if (!aColumnData.length) {
			return;
		}
		// Set Column Visibility and Column Order
		oTable.getColumns().forEach(function(oColumn) {
			var sColumnKey = sap.ui.comp.personalization.Util.getColumnKey(oColumn);
			var oColumnData = fGetColumnData(sColumnKey, aColumnData);
			if (oColumnData) {
				oColumn.setVisible(oColumnData.columnVisible);
				oColumn.setOrder(oColumnData.columnOrder);
			}
		});
		oTable.rerender();
	};

	var oPanelColumns = new sap.m.CustomPanelColumns({
		type: "customColumns",
		title: "Columns (Custom Panel)",
		titleLarge: "Define Column Properties",
		content: new sap.m.MultiComboBox({
			items: {
				path: "/cols",
				template: new sap.ui.core.Item({
					key: "{path}",
					text: "{text}"
				})
			},
			selectedKeys: {
				path: "/pathOfVisibleCols"
			},
			selectionFinish: function(oEvent) {
				var aColumnData = [];
				// Fill all selected columns
				oEvent.getParameter("selectedItems").forEach(function(oItem, iIndex) {
					aColumnData.push({
						columnKey: oItem.getKey(),
						columnOrder: iIndex,
						columnVisible: true
					});
				});
				// Add all other columns as invisible
				oMTable.getColumns().forEach(function(oColumn) {
					var sColumnKey = sap.ui.comp.personalization.Util.getColumnKey(oColumn);
					var oColumnData = fGetColumnData(sColumnKey, aColumnData);
					if (!oColumnData) {
						aColumnData.push({
							columnKey: sColumnKey,
							columnOrder: aColumnData.length,
							columnVisible: false
						});
					}
				});
				fUpdateTable(oMTable, aColumnData);
			}
		})
	});

	var oPanelColumnsSetting = new sap.m.CustomPanelSetting({
		type: "customColumnsSetting",
		title: "Columns Setting (Custom Panel)",
		titleLarge: "Define Column Setting",
		content: new sap.m.RadioButtonGroup({
			columns: 2,
			buttons: [
				new sap.m.RadioButton({
					text: "All Data"
				}), new sap.m.RadioButton({
					text: "Evaluated Data"
				})
			]
		})
	});

	var oDialog = new sap.m.P13nDialog({
		ok: function() {
			// Store Column Visibility and Order before opening of dialog
			aColumnOrderBeforeOpen = [];
			oMTable.getColumns().forEach(function(oColumn) {
				aColumnOrderBeforeOpen.push({
					columnKey: sap.ui.comp.personalization.Util.getColumnKey(oColumn),
					columnOrder: oColumn.getOrder(),
					columnVisible: oColumn.getVisible()
				});
			});
			this.close();
		},
		cancel: function() {
			fUpdateTable(oMTable, aColumnOrderBeforeOpen);
			this.close();
		},
		initialVisiblePanelType: oPanelColumnsSetting.getType(),
		panels: [
			oPanelColumnsSetting, oPanelColumns
		]
	});
	oDialog.setModel(new sap.ui.model.json.JSONModel(oJSONData));

	var aColumnOrderBeforeOpen = [];
	var oMTable = sap.ui.comp.personalization.PersonalizationDialog.createMTable("testMTableCustomController", oJSONData, false, false, function() {
		// Set compact style class if the table is compact too
		oDialog.toggleStyleClass("sapUiSizeCompact", !!jQuery(oMTable.getDomRef()).closest(".sapUiSizeCompact").length);
		oMTable.getColumns().forEach(function(oColumn) {
			aColumnOrderBeforeOpen.push({
				columnKey: sap.ui.comp.personalization.Util.getColumnKey(oColumn),
				columnOrder: oColumn.getOrder(),
				columnVisible: oColumn.getVisible()
			});
		});
		oDialog.open();
	}, null, null, null, null);

	var oApp = new sap.m.App("myApp", {
		pages: [
			new sap.m.Page({
				title: "Table Personalization Dialog with custom Panels (without Personalization Controller)",
				headerContent: [
					new sap.m.Toolbar({
						content: [
							new sap.m.CheckBox({
								text: "compact Mode",
								selected: true,
								select: function() {
									$("#myApp").toggleClass("sapUiSizeCompact");
								}
							})
						]
					})
				],
				content: [
					new sap.m.Carousel({
						pages: [
							new sap.m.Page({
								content: [
									new sap.m.Panel("IDMTablePanel", {
										headerText: "sap.m.Table",
										expandable: true,
										expanded: true,
										content: oMTable
									})
								]
							})
						]
					})
				]
			})
		]
	});

	var oShell = new sap.m.Shell();
	oShell.setApp(oApp);
	oShell.placeAt("body");

	$(document).ready(function() {
		$("#myApp").toggleClass("sapUiSizeCompact");
	});
</script>
</head>
<body id="body" class="sapUiBody"></body>
</html>
