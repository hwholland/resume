<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>qUnit Page for
	sap.ui.comp.personalization.FilterController</title>

<script id="sap-ui-bootstrap" type="text/javascript"
	src="../../../../../../resources/sap-ui-core.js"
	data-sap-ui-theme="sap_bluecrystal" data-sap-ui-noConflict="true"
	data-sap-ui-libs="sap.ui.comp, sap.ui.table, sap.ui.commons">
	
</script>

<link rel="stylesheet"
	href="../../../../../../resources/sap/ui/thirdparty/qunit.css"
	type="text/css" media="screen" />
<script type="text/javascript"
	src="../../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script type="text/javascript"
	src="../../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script type="text/javascript"
	src="../../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
<script type="text/javascript"
	src="../../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
<script type="text/javascript"
	src="../../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>
<script type="text/javascript">
	if (!(sap.ui.Device.browser.internet_explorer && sap.ui.Device.browser.version <= 8)) {
		jQuery.sap.require("sap.ui.qunit.qunit-coverage");
	}

	(function() {

		jQuery.sap.require("sap.ui.comp.personalization.FilterController");
		jQuery.sap.require("sap.ui.comp.personalization.Controller");
		jQuery.sap.require("sap.ui.comp.personalization.ColumnHelper");

		var oEmpty = {
			filter: {
				filterItems: []
			}
		};
		var oA = {
			filter: {
				filterItems: [
					{
						columnKey: "name",
						operation: "Contains",
						value1: "A"
					}
				]
			}
		};
		var oAx = {
			filter: {
				filterItems: [
					{
						columnKey: "name",
						operation: "Contains",
						value1: "B"
					}
				]
			}
		};
		var oB = {
			filter: {
				filterItems: [
					{
						columnKey: "country",
						operation: "Contains",
						value1: "A"
					}
				]
			}
		};
		var oBx = {
			filter: {
				filterItems: [
					{
						columnKey: "country",
						operation: "Contains",
						value1: "B"
					}
				]
			}
		};
		var oAB = {
			filter: {
				filterItems: [
					{
						columnKey: "name",
						operation: "Contains",
						value1: "A"
					}, {
						columnKey: "country",
						operation: "Contains",
						value1: "A"
					}
				]
			}
		};
		var oBA = {
			filter: {
				filterItems: [
					{
						columnKey: "country",
						operation: "Contains",
						value1: "A"
					}, {
						columnKey: "name",
						operation: "Contains",
						value1: "A"
					}
				]
			}
		};
		module("API", {
			setup: function() {
				var gData = {
					items: [
						{
							"date": "2/5/1982",
							"number": 103,
							"city": "McDermotttown",
							"country": "Svalbard and Jan Mayen",
							"name": "Mary"
						}
					],
					columns: [
						{
							id: "name",
							text: "Name",
							path: "name"
						}, {
							id: "country",
							text: "Country",
							path: "country"
						}, {
							id: "city",
							text: "City",
							path: "city"
						}
					]
				};
				gSetting = {
					columns: {
						visible: false
					},
					group: {
						visible: false
					},
					filter: {
						visible: false
					},
					sort: {
						visible: false
					}
				};
				getPath = function(sId) {
					var sPath = "";
					gData.columns.some(function(column) {
						if (column.id === sId) {
							sPath = column.path;
							return true;
						}
					});
					return sPath;
				};
				addFilterProperty = function(oTable, aColumns) {
					if (oTable instanceof sap.ui.table.Table) {
						var oBinding = oTable.getBinding("rows");
						var aFilters = [];
						aColumns.forEach(function(oColumn) {
							oColumn.setFilterProperty(getPath(oColumn.getId()));
							aFilters.push(new sap.ui.model.Filter(oColumn.getFilterProperty(), "BT", "A", "B"));
							oColumn.setFiltered(true);
						});
						oBinding.filter(aFilters);
					} else if (oTable instanceof sap.m.Table) {
						aColumns.forEach(function(oColumn) {
							var oP13nData = oColumn.data("p13nData");
							oP13nData.filterProperty = oP13nData.columnKey;
						});
					}
				};
				createTable = function(sTableType, oData) {
					oData = oData || gData;
					var oTable = null;
					if (sTableType === "UITable") {
						oTable = new sap.ui.table.Table('testUITable', {
							columns: jQuery.map(oData.columns, function(oModelColumn) {
								var oColumn = new sap.ui.table.Column(oModelColumn.id, {
									label: new sap.ui.commons.Label({
										text: oModelColumn.text
									}),
									template: new sap.ui.commons.Label({
										text: {
											path: oModelColumn.path
										}
									})
								});
								return oColumn;
							})
						});
						oTable.setModel(new sap.ui.model.json.JSONModel());
						oTable.bindRows("/items");
					} else if (sTableType === "MTable") {
						oTable = new sap.m.Table("testMTable", {
							columns: jQuery.map(oData.columns, function(oModelColumn) {
								var oColumn = new sap.m.Column(oModelColumn.id, {
									header: new sap.m.Label({
										text: oModelColumn.text
									})
								});
								oColumn.data("p13nData", {
									columnKey: oModelColumn.path
								});
								return oColumn;
							})
						});
						oTable.setModel(new sap.ui.model.json.JSONModel());
						oTable.bindAggregation("items", "/items", new sap.m.ColumnListItem({
							cells: jQuery.map(oData.columns, function(oModelColumn) {
								return new sap.m.Label({
									text: oModelColumn.text
								});
							})
						}));
					}
					return oTable;
				};
				getSettingFor = function(aTypes) {
					var oSetting = jQuery.extend(true, {}, gSetting);
					aTypes.forEach(function(sType) {
						oSetting[sType].visible = true;
					});
					return oSetting;
				};
			},
			teardown: function() {
				gData = null;
				gSetting = null;
				createTable = null;
				getSettingFor = null;
				addFilterProperty = null;
			}
		});

		test("getChangeData", function() {
			try {
				// system under test
				var oFilterController = new sap.ui.comp.personalization.FilterController();

				// arrange				

				// act			 

				// assertions

				deepEqual(oFilterController.getChangeData(oEmpty, oA), oEmpty, "delete: [] XOR A = []");
				deepEqual(oFilterController.getChangeData({}, oA), oEmpty, "");
				deepEqual(oFilterController.getChangeData(oA, oA), null, "no change: A XOR A = null");
				deepEqual(oFilterController.getChangeData(oA, {
					filter: {}
				}), oA, "change: A XOR {filter} = A");
				deepEqual(oFilterController.getChangeData(oA, {}), oA, "change: A XOR {} = A");
				deepEqual(oFilterController.getChangeData(oA, null), oA, "change: A XOR null = A");
				deepEqual(oFilterController.getChangeData(oA, oB), oA, "change: A XOR B = A");
				deepEqual(oFilterController.getChangeData(oA, oAx), oA, "change: A XOR A' = A");
				deepEqual(oFilterController.getChangeData(oA, oAB), oA, "change: A XOR (A, B) = A");
				deepEqual(oFilterController.getChangeData(oA, {
					filter: {
						filterItems: []
					}
				}), oA, "change: A XOR [] = A");
				deepEqual(oFilterController.getChangeData(oAx, oA), oAx, "change: A' XOR A = A'");
				deepEqual(oFilterController.getChangeData(oAB, oAB), null, "no change: (A, B) XOR (A, B) = null");
				deepEqual(oFilterController.getChangeData(oAB, oBA), oAB, "change: (A, B) XOR (B, A) = (A, B)");
			} finally {
				// cleanup				
				oFilterController.destroy();
			}
		});

		test("getChangeType", function() {
			// system under test
			var oFilterController = new sap.ui.comp.personalization.FilterController();

			// arrange				

			// act			 

			// assertions

			ok(oFilterController.getChangeType(oEmpty, oA));

			// cleanup				
			oFilterController.destroy();
		});

		test("getChangeType", function() {
			// system under test
			var oFilterController = new sap.ui.comp.personalization.FilterController();

			// arrange				

			// act			 

			// assertions

			ok(oFilterController.getChangeType(oEmpty, null));

			// cleanup				
			oFilterController.destroy();
		});

		test("_hasSemanticEqual", function() {
			// system under test
			var oFilterController = new sap.ui.comp.personalization.FilterController();

			// arrange				

			// act			 

			// assertions
			ok(!oFilterController._hasSemanticEqual(null, [
				{
					a: "a"
				}
			]));
			ok(oFilterController._hasSemanticEqual({
				a: "a"
			}, [
				{
					b: "a"
				}, {
					a: "a"
				}
			]));

			// cleanup				
			oFilterController.destroy();
		});

		test("getPanel - with filterable columns", function() {
			// system under test
			var oTable = createTable("UITable");
			addFilterProperty(oTable, [
				oTable.getColumns()[0]
			]);
			var oController = new sap.ui.comp.personalization.Controller({
				table: oTable,
				setting: getSettingFor([
					"filter"
				])
			});
			var oFilterController = oController._oSettingCurrent.filter.controller;

			// arrange				

			// act			 

			// assertions
			ok(oFilterController.getPanel());

			// cleanup
			oTable.destroy();
			oFilterController.destroy();
			oController.destroy();
		});

		test("getPanel - without filterable columns", function() {
			// system under test
			var oTable = createTable("UITable");
			var oController = new sap.ui.comp.personalization.Controller({
				table: oTable,
				setting: getSettingFor([
					"filter"
				])
			});
			var oFilterController = oController._oSettingCurrent.filter.controller;

			// arrange				

			// act			 

			// assertions
			ok(!oFilterController.getPanel());

			// cleanup
			oTable.destroy();
			oFilterController.destroy();
			oController.destroy();
		});

		test("syncJsonModel2Table - filter is set to first column", function() {
			// system under test
			var oTable = createTable("UITable");
			var oController = new sap.ui.comp.personalization.Controller({
				table: oTable,
				setting: getSettingFor([
					"filter"
				])
			});
			var oFilterController = oController._oSettingCurrent.filter.controller;

			// arrange				

			// act			 
			oFilterController.syncJsonModel2Table({
				filter: {
					filterItems: [
						{
							columnKey: "name"
						}
					]
				}
			});

			// assertions
			ok(oTable.getColumns()[0].getFiltered());

			// cleanup
			oTable.destroy();
			oFilterController.destroy();
			oController.destroy();
		});

		test("syncJsonModel2Table - table with 1. column as filterable -> filter is set to 3. column", function() {
			// system under test
			var oTable = createTable("UITable");
			addFilterProperty(oTable, [
				oTable.getColumns()[0]
			]);
			var oController = new sap.ui.comp.personalization.Controller({
				table: oTable,
				setting: getSettingFor([
					"filter"
				])
			});
			var oFilterController = oController._oSettingCurrent.filter.controller;

			// arrange				

			// act			 
			oFilterController.syncJsonModel2Table({
				filter: {
					filterItems: [
						{
							columnKey: "city"
						}
					]
				}
			});

			// assertions
			ok(!oTable.getColumns()[0].getFiltered());
			ok(oTable.getColumns()[2].getFiltered());

			// cleanup
			oTable.destroy();
			oFilterController.destroy();
			oController.destroy();
		});

		var fTest10 = function(sTableType) {
			// system under test
			var oTable = createTable(sTableType);
			addFilterProperty(oTable, [
				oTable.getColumns()[0]
			]);
			var oController = new sap.ui.comp.personalization.Controller({
				table: oTable,
				setting: getSettingFor([
					"filter"
				])
			});

			var oFilterController = oController._oSettingCurrent.filter.controller;

			// arrange				

			// act			 
			var oJson = oFilterController._getTable2Json();

			// assertions
			ok(oJson);

			// cleanup
			oTable.destroy();
			oFilterController.destroy();
			oController.destroy();
		};
		test("setTable (UITable)", function() {
			fTest10("UITable");
		});
		test("setTable (MTable)", function() {
			fTest10("MTable");
		});
	}());
</script>
</head>
<body id="body" class="sapUiBody">
	<h1 id="qunit-header">qUnit Page for
		sap.ui.comp.personalization.FilterController</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>

	<div id="content"></div>
</body>
</html>
