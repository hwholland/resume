<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>qUnit Page for sap.ui.comp.providers.ChartProvider</title>

<script id="sap-ui-bootstrap" type="text/javascript"
	src="../../../../../resources/sap-ui-core.js"
	data-sap-ui-theme="sap_bluecrystal" data-sap-ui-noConflict="true"
	data-sap-ui-libs="sap.ui.comp">
	
</script>

<link rel="stylesheet" href="../../../../../resources/sap/ui/thirdparty/qunit.css"	type="text/css" media="screen" />
<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>

<script type="text/javascript">

	if(!(sap.ui.Device.browser.internet_explorer && sap.ui.Device.browser.version <= 8)) {
		jQuery.sap.require("sap.ui.qunit.qunit-coverage");
	} 		
	
	(function() {

		jQuery.sap.require("sap.ui.comp.providers.ChartProvider");	
		module("sap.ui.comp.providers.ChartProvider", {
			setup: function() {
				this.oChartProvider = new sap.ui.comp.providers.ChartProvider({entitySet:"foo",model:undefined});
			},
			teardown: function() {
				this.oChartProvider.destroy();
			}
		});

		test("Shall be instantiable", function() {			
			ok(this.oChartProvider);
		});
		
		test("Shall contain an instance of metadata analyser", function() {			
			ok(this.oChartProvider._oMetadataAnalyser);
			strictEqual(this.oChartProvider._oMetadataAnalyser instanceof sap.ui.comp.odata.MetadataAnalyser, true);
		});
		
		
		test("_initialiseMetadata shall trigger getFieldsByEntitySetName on the Metadatanalyser _generateIgnoredFieldsArray ", function() {			
			this.oChartProvider._oMetadataAnalyser = {
				getFieldsByEntitySetName: sinon.stub(),
				getEntityTypeNameFromEntitySetName: sinon.stub(),
				getLineItemAnnotation: sinon.stub(),
				getChartAnnotation: sinon.stub(),
				getPresentationVariantAnnotation: sinon.stub(),
				getEntityContainerAttribute: sinon.stub(),
				getTextArrangementValue: sinon.stub()				
			};
			sinon.spy(this.oChartProvider,"_generateIgnoredFieldsArray");
			this.oChartProvider._intialiseMetadata();			
			ok(this.oChartProvider._oMetadataAnalyser.getFieldsByEntitySetName.calledOnce);
		});		
		
		test("_generateIgnoredFieldsArray shall create an array of hidden fields ", function() {						
			this.oChartProvider._generateIgnoredFieldsArray();						
			deepEqual(this.oChartProvider._aIgnoredFields,[]);			
			this.oChartProvider._sIgnoredFields = "ID,TechId,foo"
			this.oChartProvider._generateIgnoredFieldsArray();			
			strictEqual(this.oChartProvider._aIgnoredFields.length,3);
			deepEqual(this.oChartProvider._aIgnoredFields,["ID","TechId","foo"]);
		});	
		
		test("_initialiseMetadata shall create ChartViewMetadata(getChartViewMetadata()) by ignoring the fields in _aIgnoredFields", function() {
			var aBackendMetadata = [{name:"test", type:"Edm.String", visible:true},{name:"foo", type:"Edm.String", visible:true},{name:"ID",type:"Edm.String", visible:true},{name:"test1", type:"Edm.String",visible:true},{name:"test2", type:"Edm.String",visible:true},{name:"test3", type:"Edm.String",visible:true},{name:"test4", type:"Edm.String", visible:true}];
			var oResult = null;
			this.oChartProvider._oMetadataAnalyser = {
					getFieldsByEntitySetName: sinon.stub(),
					getEntityTypeNameFromEntitySetName: sinon.stub(),
					getLineItemAnnotation: sinon.stub(),
					getChartAnnotation: sinon.stub().returns({}),					
					getPresentationVariantAnnotation: sinon.stub(),
					getValueListAnnotation:sinon.stub(),
					getEntityContainerAttribute: sinon.stub(),
					getTextArrangementValue: sinon.stub()						
			};
			this.oChartProvider._oMetadataAnalyser.getFieldsByEntitySetName.returns(aBackendMetadata);
			//No fields to ignore
			this.oChartProvider._intialiseMetadata();			
			
			oResult = this.oChartProvider.getChartViewMetadata();
			ok(oResult);
			ok(oResult.fields);
			
			strictEqual(oResult.fields.length, aBackendMetadata.length);			
						
			this.oChartProvider._aChartViewMetadata = {};
			
			this.oChartProvider._sIgnoredFields = "ID,TechId,foo"			
			
			this.oChartProvider._intialiseMetadata();
			//ID and foo shall be ignored!
			oResult = this.oChartProvider.getChartViewMetadata();
			
			//Result shall not contain ignored fields!
			strictEqual(oResult.fields.length, aBackendMetadata.length - 2);			
		});
		
		test("_initialiseMetadata shall create ChartViewMetadata(getChartViewMetadata()) by ignoring visible=false fields", function() {
			var aBackendMetadata = [{name:"test", type:"Edm.String", visible:true},{name:"foo", type:"Edm.String", visible:true},{name:"ID", type:"Edm.String", visible:false},{name:"test1",type:"Edm.String", visible:false},{name:"test2", type:"Edm.String",visible:true},{name:"test3", type:"Edm.String",visible:true},{name:"test4", type:"Edm.String",visible:true}];
			var oResult = null;
			this.oChartProvider._oMetadataAnalyser = {
					getFieldsByEntitySetName: sinon.stub(),
					getEntityTypeNameFromEntitySetName: sinon.stub(),
					getLineItemAnnotation: sinon.stub(),
					getChartAnnotation: sinon.stub().returns({}),					
					getPresentationVariantAnnotation: sinon.stub(),
					getValueListAnnotation:sinon.stub(),
					getEntityContainerAttribute: sinon.stub(),
					getTextArrangementValue: sinon.stub()						
			};
			this.oChartProvider._oMetadataAnalyser.getFieldsByEntitySetName.returns(aBackendMetadata);
		
			
			this.oChartProvider._intialiseMetadata();
			//ID and test1 shall be ignored as they are visible=false!
			oResult = this.oChartProvider.getChartViewMetadata();
			
			//Result shall not contain visible=false fields!
			strictEqual(oResult.fields.length, aBackendMetadata.length - 2);	
			
			//visible=false along with ignord fields
			this.oChartProvider._aChartViewMetadata=[];
			
			this.oChartProvider._sIgnoredFields = "TechId,foo"			
				
			this.oChartProvider._intialiseMetadata();
			//ID and test1 shall be ignored as they are visible=false!
			//And foo shall be ignored as it is in the ignored list!
			oResult = this.oChartProvider.getChartViewMetadata();
			
			//Result shall not contain ignored fields!
			strictEqual(oResult.fields.length, aBackendMetadata.length - 3);
		});
		
		
		
		test("check _initialiseMetadata with dimension and measures", function() {
			var aBackendMetadata = [{name:"test", aggregationRole: "dimension", type:"Edm.String", visible:true},{name:"foo", aggregationRole: "dimension", type:"Edm.String", visible:true},
			                        {name:"ID", aggregationRole: "measure", type:"Edm.String", visible:true},
			                        {name:"test1", type:"Edm.String",visible:true},{name:"test2", type:"Edm.String", visible:true},{name:"test3", type:"Edm.String", visible:true},{name:"test4", type:"Edm.String", visible:true}];
			
			var oChartAnnotation = {semantics: "analytic", annotation: {},
			     				   chartType: "com.sap.vocabularies.UI.v1.ChartType/Column",
			    			       measureFields: [],
			    			       dimensionFields: [],
			     				   measureAttributes: {},
			    			       dimensionAttributes: {}
			     				   };			
			var oResult = null;
			
			this.oChartProvider._oMetadataAnalyser = {
					getFieldsByEntitySetName: sinon.stub(),
					getEntityTypeNameFromEntitySetName: sinon.stub(),
					getChartAnnotation: sinon.stub(),					
					getPresentationVariantAnnotation: sinon.stub(),
					getValueListAnnotation:sinon.stub(),
					getEntityContainerAttribute: sinon.stub(),
					getTextArrangementValue: sinon.stub()						
			};
			this.oChartProvider._oMetadataAnalyser.getFieldsByEntitySetName.returns(aBackendMetadata);		
			this.oChartProvider._oMetadataAnalyser.getChartAnnotation.returns(oChartAnnotation);
			
			//No fields to ignore
			this.oChartProvider._intialiseMetadata();			
			
			oResult = this.oChartProvider.getChartViewMetadata();
			ok(oResult);
			strictEqual(oResult.chartType, "column");			
			ok(oResult.fields);
			strictEqual(oResult.fields.length, 7);
			
			ok(oResult.fields[0].isDimension);
			ok(!oResult.fields[0].isMeasure);			
			ok(oResult.fields[1].isDimension);
			ok(!oResult.fields[1].isMeasure);
			ok(!oResult.fields[2].isDimension);
			ok(oResult.fields[2].isMeasure);
			ok(!oResult.fields[3].isDimension);
			ok(!oResult.fields[3].isMeasure);			

		});				
		
		test("Destroy", function() {
			equal(this.oChartProvider.bIsDestroyed, undefined);
			this.oChartProvider.destroy();
			equal(this.oChartProvider._oMetadataAnalyser, null);
			equal(this.oChartProvider._aChartViewMetadata,null);
			strictEqual(this.oChartProvider.bIsDestroyed, true);
		});
		
	}());
</script>
</head>
<body id="body" class="sapUiBody">
	<h1 id="qunit-header">qUnit Page for sap.ui.comp.providers.ChartProvider</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>
	<div id="content"></div>
</body>
</html>
