<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>qUnit Page for sap.ui.comp.providers.ValueListProvider</title>

<script id="sap-ui-bootstrap" type="text/javascript"
	src="../../../../../resources/sap-ui-core.js"
	data-sap-ui-theme="sap_bluecrystal" data-sap-ui-noConflict="true"
	data-sap-ui-libs="sap.ui.comp">
	
</script>

<link rel="stylesheet" href="../../../../../resources/sap/ui/thirdparty/qunit.css"	type="text/css" media="screen" />
<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>

<script type="text/javascript">

	if(!(sap.ui.Device.browser.internet_explorer && sap.ui.Device.browser.version <= 8)) {
		jQuery.sap.require("sap.ui.qunit.qunit-coverage");
	} 		
	
	(function() {

		jQuery.sap.require("sap.ui.comp.providers.ValueListProvider");
		jQuery.sap.require("sap.ui.comp.smartfilterbar.FilterProvider");
		jQuery.sap.require("sap.ui.model.odata.ODataModel");
		jQuery.sap.require("sap.m.MultiComboBox");	
		module("sap.ui.comp.providers.ValueListProvider", {
			setup: function() {
				this.oAnnotation={valueListEntitySetName:"Chuck",keyField:"TheKey",descriptionField:"Desc",keys:["TheKey"],valueListFields:[{name:"TheKey"},{name:"Desc"}]};
				this.oModel=sinon.createStubInstance(sap.ui.model.odata.ODataModel);
				this.oValueListProvider = new sap.ui.comp.providers.ValueListProvider({control: sinon.createStubInstance(sap.m.MultiComboBox), aggregation:"items",annotation:this.oAnnotation,model:this.oModel,typeAheadEnabled:false});
			},
			teardown: function() {
				this.oValueListProvider.destroy();
			}
		});

		test("Shall be instantiable", function() {			
			ok(this.oValueListProvider);
		});
		
		test("Shall have an instance of oDataModel", function() {	
			ok(this.oValueListProvider.oODataModel);
		});
		
		test("Shall call addEventDelegate onInitialise of drop downs", function() {
			strictEqual(this.oValueListProvider.oControl.addEventDelegate.calledOnce,true);
		});
		
		test("Shall call bindAggrgation/_fetchData once control is rendered", function() {
			var oDelegate;
			sinon.spy(this.oValueListProvider,"_fetchData");
			oDelegate = this.oValueListProvider.oControl.addEventDelegate.args[0][0];
			oDelegate.onAfterRendering.call(this.oValueListProvider);
			strictEqual(this.oValueListProvider.oControl.bindAggregation.calledOnce,true);
			strictEqual(this.oValueListProvider._fetchData.calledOnce,true);
			strictEqual(this.oValueListProvider.oControl.removeEventDelegate.calledOnce,true);
		});
		
		test("Shall create sorter for id based DDLBs", function() {
			ok(!this.oValueListProvider._oSorter);
			
			this.oValueListProvider.sDDLBDisplayBehaviour = sap.ui.comp.smartfilterbar.ControlConfiguration.DISPLAYBEHAVIOUR.idOnly;
			this.oValueListProvider._createDropDownTemplate();
			ok(this.oValueListProvider._oSorter);
			strictEqual(this.oValueListProvider._oSorter.sPath,this.oValueListProvider.sKey);
			
			this.oValueListProvider.sDDLBDisplayBehaviour = sap.ui.comp.smartfilterbar.ControlConfiguration.DISPLAYBEHAVIOUR.descriptionOnly;
			this.oValueListProvider._createDropDownTemplate();
			ok(this.oValueListProvider._oSorter);
			strictEqual(this.oValueListProvider._oSorter.sPath,this.oValueListProvider.sDescription);
		});
		
		test("Shall not create sorter for id based DDLBs but one for Description", function() {
			this.oValueListProvider.oPrimaryValueListAnnotation.valueListFields[0].sortable = false;
			this.oValueListProvider.oPrimaryValueListAnnotation.valueListFields[1].sortable = true;
			
			ok(!this.oValueListProvider._oSorter);
			
			this.oValueListProvider.sDDLBDisplayBehaviour = sap.ui.comp.smartfilterbar.ControlConfiguration.DISPLAYBEHAVIOUR.idOnly;
			this.oValueListProvider._createDropDownTemplate();
			ok(!this.oValueListProvider._oSorter);
			
			this.oValueListProvider.sDDLBDisplayBehaviour = sap.ui.comp.smartfilterbar.ControlConfiguration.DISPLAYBEHAVIOUR.descriptionOnly;
			this.oValueListProvider._createDropDownTemplate();
			ok(this.oValueListProvider._oSorter);
			strictEqual(this.oValueListProvider._oSorter.sPath,this.oValueListProvider.sDescription);			
		});		
		
		test("Shall not create sorter for id nor description based DDLBs", function() {
			this.oValueListProvider.oPrimaryValueListAnnotation.valueListFields[0].sortable = false;
			this.oValueListProvider.oPrimaryValueListAnnotation.valueListFields[1].sortable = false;
			
			ok(!this.oValueListProvider._oSorter);
			
			this.oValueListProvider.sDDLBDisplayBehaviour = sap.ui.comp.smartfilterbar.ControlConfiguration.DISPLAYBEHAVIOUR.idOnly;
			this.oValueListProvider._createDropDownTemplate();
			ok(!this.oValueListProvider._oSorter);
			
			this.oValueListProvider.sDDLBDisplayBehaviour = sap.ui.comp.smartfilterbar.ControlConfiguration.DISPLAYBEHAVIOUR.descriptionOnly;
			this.oValueListProvider._createDropDownTemplate();
			ok(!this.oValueListProvider._oSorter);		
		});		
		
		module("sap.ui.comp.providers.ValueListProvider (typeAhead)", {
			setup: function() {
				this.oAnnotation={valueListEntitySetName:"Chuck",keyField:"TheKey",descriptionField:"Desc",keys:["TheKey"],valueListFields:[{name:"TheKey"},{name:"Desc"}]};
				this.oModel=sinon.createStubInstance(sap.ui.model.odata.ODataModel);
				this.oValueListProvider = new sap.ui.comp.providers.ValueListProvider({control: sinon.createStubInstance(sap.m.MultiInput), aggregation:"suggestionItems", annotation:this.oAnnotation, model:this.oModel, typeAheadEnabled:true});
			},
			teardown: function() {
				this.oValueListProvider.destroy();
			}
		});
	
		test("Shall call attachSuggest once on initialise if type Ahead is enabled", function() {
			strictEqual(this.oValueListProvider.oControl.attachSuggest.calledOnce,true);
		});
		
		test("suggest shall trigger _fetchData", function() {
			var fSuggest = null,oEvent = {getParameter:sinon.stub(), getSource: sinon.stub()}, sInput = "test" ;
			oEvent.getParameter.returns(sInput);
			oEvent.getSource.returns(this.oValueListProvider.oControl);
			strictEqual(this.oValueListProvider.oControl.attachSuggest.calledOnce,true);
			sinon.spy(this.oValueListProvider,"_fetchData");
			fSuggest = this.oValueListProvider.oControl.attachSuggest.args[0][0];
			//Trigger Suggest
			fSuggest(oEvent)
			
			strictEqual(this.oValueListProvider._fetchData.calledOnce,true);
			strictEqual(this.oValueListProvider._fetchData.calledWith(sInput),true);
		});
		
		test("_fetchData shall use the Search Text and Search-focus if basic search and type ahead is enabled", function() {
			this.oValueListProvider.bSupportBasicSearch = true;
			this.oValueListProvider._fetchData("SomeSearchText");
			var args = this.oValueListProvider.oControl.bindAggregation.args[0];
			var custom = args[1].parameters["custom"];
			strictEqual(custom["search"],"SomeSearchText");
			strictEqual(custom["search-focus"],"TheKey");
		});
		
		test("Search Text shall be converted to UpperCase according to displayFormat", function() {
			this.oValueListProvider.bSupportBasicSearch = true;
			this.oValueListProvider.sDisplayFormat = "UpperCase";
			this.oValueListProvider._fetchData("UpperCase");
			var args = this.oValueListProvider.oControl.bindAggregation.args[0];
			var custom = args[1].parameters["custom"];
			strictEqual(custom["search"],"UPPERCASE");
			strictEqual(custom["search-focus"],"TheKey");
		});
		
		test("MultiInput - addValidator shall trigger select and create token via asyncCallback with the suggestionRow", function() {
			var fValidate = null, fAsyncCallback = sinon.stub(), oSuggestionRow = {getBindingContextPath:sinon.stub()}, sInput="foo";
			var oMockRow = {TheKey:"key",Desc:"description"};
			strictEqual(this.oValueListProvider.oControl.addValidator.calledOnce,true);
			fValidate  = this.oValueListProvider.oControl.addValidator.args[0][0];
			this.oValueListProvider.oODataModel.getData.returns(oMockRow);
			sinon.stub(this.oValueListProvider,"_calculateAndSetFilterOutputData");
			strictEqual(this.oValueListProvider.oODataModel.getData.calledOnce,false);
			
			//Trigger the validation
			fValidate({suggestionObject: oSuggestionRow, text: sInput, asyncCallback: fAsyncCallback});
			
			strictEqual(this.oValueListProvider.oODataModel.getData.calledOnce,true);
			strictEqual(this.oValueListProvider.oODataModel.read.calledOnce,false);
			strictEqual(this.oValueListProvider._calculateAndSetFilterOutputData.calledOnce,true);
			strictEqual(this.oValueListProvider._calculateAndSetFilterOutputData.calledWith([oMockRow]),true);
			strictEqual(fAsyncCallback.calledOnce,true);
			//strictEqual(this.oValueListProvider.oControl.setValue.calledOnce,true);
			//strictEqual(this.oValueListProvider.oControl.setValue.calledWith(""),true);
		});
		
		test("MultiInput - addValidator shall trigger backend validation and create token (via asyncCallback) with typed in text if no suggestionRow is present", function() {
			var fValidate = null, fAsyncCallback = sinon.stub(), oSuggestionRow = null, sInput="foo";
			var oMockRow = {TheKey:"key",Desc:"description"};
			var oBackendRequest = null;
			strictEqual(this.oValueListProvider.oControl.addValidator.calledOnce,true);		
			fValidate  = this.oValueListProvider.oControl.addValidator.args[0][0];			
			sinon.stub(this.oValueListProvider,"_calculateAndSetFilterOutputData");
			sinon.stub(this.oValueListProvider,"_calculateFilterInputData");
			//Trigger the validation
			fValidate({suggestionObject: oSuggestionRow, text: sInput, asyncCallback: fAsyncCallback});
			strictEqual(this.oValueListProvider.oODataModel.getData.calledOnce,false);
			strictEqual(this.oValueListProvider.oODataModel.read.calledOnce,true);
			strictEqual(this.oValueListProvider.oControl.__bValidatingToken,true);
			
			oBackendRequest = this.oValueListProvider.oODataModel.read.args[0][1];
			
			//Tigger success call
			oBackendRequest.success({results:[oMockRow]},{});			
			
			strictEqual(this.oValueListProvider._calculateAndSetFilterOutputData.calledWith([oMockRow]),true);
			strictEqual(fAsyncCallback.calledOnce,true);
			//strictEqual(this.oValueListProvider.oControl.setValue.calledOnce,true);
			//strictEqual(this.oValueListProvider.oControl.setValue.calledWith(""),true);
			strictEqual(this.oValueListProvider.oControl.__bValidatingToken,undefined);
		});
		
		module("sap.ui.comp.providers.ValueListProvider (typeAhead - single Input)", {
			setup: function() {
				this.oAnnotation={valueListEntitySetName:"Chuck",keyField:"TheKey",descriptionField:"Desc",keys:["TheKey"],valueListFields:[{name:"TheKey"},{name:"Desc"}]};
				this.oModel=sinon.createStubInstance(sap.ui.model.odata.ODataModel);
				this.oValueListProvider = new sap.ui.comp.providers.ValueListProvider({control: sinon.createStubInstance(sap.m.Input), aggregation:"suggestionItems", annotation:this.oAnnotation, model:this.oModel, typeAheadEnabled:true});
			},
			teardown: function() {
				this.oValueListProvider.destroy();
			}
		});
		
		test("Input - attachSuggestionItemSelected shall trigger select and set Key as value of Input", function() {
			var fSuggestionItemSelected = null, oEvent = {getParameter:sinon.stub()}, sInput="foo";
			var oMockRow = {TheKey:"key",Desc:"description"};
			var oSelectedRow = {getModel:sinon.stub(),getBindingContextPath:sinon.stub()}
			var oModel = {getData:sinon.stub()};
			oModel.getData.returns(oMockRow);
			oSelectedRow.getModel.returns(oModel);
			oEvent.getParameter.returns(oSelectedRow);
			strictEqual(this.oValueListProvider.oControl.attachSuggestionItemSelected.calledOnce,true);
			fSuggestionItemSelected  = this.oValueListProvider.oControl.attachSuggestionItemSelected.args[0][0];
			sinon.stub(this.oValueListProvider,"_calculateAndSetFilterOutputData");
			
			//Trigger the selection
			fSuggestionItemSelected(oEvent);
			
			strictEqual(oSelectedRow.getModel.calledOnce,true);
			strictEqual(oModel.getData.calledOnce,true);
			strictEqual(this.oValueListProvider._calculateAndSetFilterOutputData.calledOnce,true);
			strictEqual(this.oValueListProvider._calculateAndSetFilterOutputData.calledWith([oMockRow]),true);
			strictEqual(this.oValueListProvider.oControl.setValue.calledOnce,true);
			strictEqual(this.oValueListProvider.oControl.setValue.calledWith("key"),true);
			strictEqual(this.oValueListProvider.oControl.fireChange.calledOnce,true);
			strictEqual(this.oValueListProvider.oControl.fireChange.calledWith({value:"key", validated: true}),true);
		});
		
	}());
</script>
</head>
<body id="body" class="sapUiBody">
	<h1 id="qunit-header">qUnit Page for
		sap.ui.comp.providers.ValueListProvider</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>
	<div id="content"></div>
</body>
</html>
