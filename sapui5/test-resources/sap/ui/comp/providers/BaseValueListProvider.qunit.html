<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>qUnit Page for sap.ui.comp.providers.BaseValueListProvider</title>

<script id="sap-ui-bootstrap" type="text/javascript"
	src="../../../../../resources/sap-ui-core.js"
	data-sap-ui-theme="sap_bluecrystal" data-sap-ui-noConflict="true"
	data-sap-ui-libs="sap.ui.comp">
	
</script>

<link rel="stylesheet" href="../../../../../resources/sap/ui/thirdparty/qunit.css"	type="text/css" media="screen" />
<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>

<script type="text/javascript">

	if(!(sap.ui.Device.browser.internet_explorer && sap.ui.Device.browser.version <= 8)) {
		jQuery.sap.require("sap.ui.qunit.qunit-coverage");
	} 		
	
	(function() {

		jQuery.sap.require("sap.ui.comp.providers.BaseValueListProvider");	
		jQuery.sap.require("sap.m.MultiComboBox");	
		module("sap.ui.comp.providers.BaseValueListProvider", {
			setup: function() {
				this.sTitle ="foo";
				this.oAnnotation={valueListEntitySetName:"Chuck",keyField:"TheKey",descriptionField:"Desc",keys:["TheKey"],valueListFields:[{name:"TheKey",type:"Edm.String"},{name:"Desc",type:"Edm.String"},{name:"DoB",type:"Edm.DateTime",displayFormat:"Date"},{name:"employed",type:"Edm.Boolean"}]};
				this.oModel={read:sinon.stub()};
				this.oBaseValueListProvider = new sap.ui.comp.providers.BaseValueListProvider({title:this.sTitle,control: new sap.m.MultiComboBox(), aggregation:"items",annotation:this.oAnnotation,model:this.oModel});
			},
			teardown: function() {
				this.oBaseValueListProvider.destroy();
			}
		});

		test("Shall be instantiable", function() {			
			ok(this.oBaseValueListProvider);
		});
		
		test("Shall contain the necessary params", function() {			
			strictEqual(this.oBaseValueListProvider.sKey,this.oAnnotation.keyField);
			strictEqual(this.oBaseValueListProvider.sDescription,this.oAnnotation.descriptionField);
			strictEqual(this.oBaseValueListProvider.oODataModel,this.oModel);
			strictEqual(this.oBaseValueListProvider.oFilterModel,this.oAnnotation.filterModel);
			strictEqual(this.oBaseValueListProvider._aKeys,this.oAnnotation.keys);
			strictEqual(this.oBaseValueListProvider.sDDLBDisplayBehaviour,sap.ui.comp.smartfilterbar.ControlConfiguration.DISPLAYBEHAVIOUR.descriptionOnly);
			strictEqual(this.oBaseValueListProvider.sTokenDisplayBehaviour,sap.ui.comp.smartfilterbar.ControlConfiguration.DISPLAYBEHAVIOUR.descriptionAndId);
		});
		
		test("Shall contain the necessary columns", function() {	
			var aCols = this.oBaseValueListProvider._aCols; 
			strictEqual(aCols.length, 4);
		});		
		
		test("_calculateFilterInputData Shall set mFilterInputData & aFilterField", function() {	
			var oData = {"field":"value","field2":"value2","SomeField":"value3"};
			this.oBaseValueListProvider.oFilterModel = {getData:function(){return oData;}};
			this.oBaseValueListProvider.mInParams = {field:"field",SomeField:"field3"};
			this.oBaseValueListProvider._calculateFilterInputData();
			ok(this.oBaseValueListProvider.mFilterInputData);
			strictEqual(this.oBaseValueListProvider.mFilterInputData.field, "value");
			strictEqual(this.oBaseValueListProvider.mFilterInputData.field3, "value3");
			ok(this.oBaseValueListProvider.aFilterField);
			strictEqual(this.oBaseValueListProvider.aFilterField.length, 2);
			strictEqual(this.oBaseValueListProvider.aFilterField[0], "field");
			strictEqual(this.oBaseValueListProvider.aFilterField[1], "field3");
		});	
		
		test("_calculateFilterInputData Shall set mFilterInputData & aFilterField from FilterProvider/SmartFilter (visble fields)", function() {	
			var oVisibleFieldData = {"field":"value","field2":"value2","SomeField":"value3"};
			this.oBaseValueListProvider.oFilterProvider = {_oSmartFilter:{getFilterData:function(){return oVisibleFieldData;}}};
			this.oBaseValueListProvider.mInParams = {field:"field",SomeField:"field3"};
			this.oBaseValueListProvider._calculateFilterInputData();
			ok(this.oBaseValueListProvider.mFilterInputData);
			strictEqual(this.oBaseValueListProvider.mFilterInputData.field, "value");
			strictEqual(this.oBaseValueListProvider.mFilterInputData.field3, "value3");
			ok(this.oBaseValueListProvider.aFilterField);
			strictEqual(this.oBaseValueListProvider.aFilterField.length, 2);
			strictEqual(this.oBaseValueListProvider.aFilterField[0], "field");
			strictEqual(this.oBaseValueListProvider.aFilterField[1], "field3");
		});	
		
		test("_calculateAndSetFilterOutputData shall call setFilterData on the filterProvider", function() {
			//Single-Value
			var aData = [{"field":"value"},{"SomeField":"value3"}];			
			this.oBaseValueListProvider.oFilterProvider = {setFilterData:sinon.stub()};
			this.oBaseValueListProvider.mOutParams = {field1:"field",field2:"FieldTwo"};
			this.oBaseValueListProvider._calculateAndSetFilterOutputData(aData);
			strictEqual(this.oBaseValueListProvider.oFilterProvider.setFilterData.calledOnce, true);
			strictEqual(this.oBaseValueListProvider.oFilterProvider.setFilterData.calledWith({field1:{items:[{key:"value"}]}}), true);
			
			//Multi-value
			var oData = {"field1":{items:[{key:"value2"}]},"SomeField":"value3"};
			this.oBaseValueListProvider.oFilterModel = {getData:function(){return oData;}};
			aData = [{"field":"value"}, {"field":"value1"}, {"field":"value2"},{"SomeField":"value3"}];
			this.oBaseValueListProvider.oFilterProvider.setFilterData.reset()
			this.oBaseValueListProvider._calculateAndSetFilterOutputData(aData);
			strictEqual(this.oBaseValueListProvider.oFilterProvider.setFilterData.calledOnce, true);
			strictEqual(this.oBaseValueListProvider.oFilterProvider.setFilterData.calledWith({field1:{items:[{key:"value2"},{key:"value1"},{key:"value"}]}}), true);
		});	
		
		
		test("_calculateAndSetFilterOutputData shall call setData on the filterModel", function() {
			//Single-Value
			var aData = [{"field":"value"},{"SomeField":"value3"}];
			this.oBaseValueListProvider.oFilterModel = {getData:sinon.stub(), setData:sinon.stub()};
			this.oBaseValueListProvider.mOutParams = {field1:"field",field2:"FieldTwo"};
			this.oBaseValueListProvider._calculateAndSetFilterOutputData(aData);
			strictEqual(this.oBaseValueListProvider.oFilterModel.setData.calledOnce, true);
			strictEqual(this.oBaseValueListProvider.oFilterModel.setData.calledWith({field1:{items:[{key:"value"}]}}), true);
		});	
		
	}());
</script>
</head>
<body id="body" class="sapUiBody">
	<h1 id="qunit-header">qUnit Page for
		sap.ui.comp.providers.BaseValueListProvider</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>
	<div id="content"></div>
</body>
</html>
