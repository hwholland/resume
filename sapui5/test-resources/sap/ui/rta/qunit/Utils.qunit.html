<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<title>Test Page for sap.ui.rta.Utils</title>

		<style>
			html, body, #qunit-tests {
				height : 100%;
			}
			.sapUiView {
				height: 100%;
			}

			#test-view {
				border: 1px solid grey;
				position: fixed;
				bottom: 0;
				right: 0;
				width : 50%;
				height: 50%;
			}
		</style>

		<script id="sap-ui-bootstrap"
				data-sap-ui-theme="sap_bluecrystal"
				type="text/javascript"
				data-sap-ui-noConflict="true"
				data-sap-ui-resourceroots='{"sap.ui.rta.test": "../testdata/rta/"}'
				data-sap-ui-libs="sap.ui.rta,sap.ui.commons,sap.m,sap.ui.layout"
				src="../../../../../resources/sap-ui-core.js">
		</script>
		<link rel="stylesheet" href="../../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen" />
		<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
		<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
		<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
		<script type="text/javascript">

			var oCompCont = new sap.ui.core.ComponentContainer("CompCont1", {
				name: "sap.ui.rta.test",
				id: "Comp1",
				settings: {
					componentData: {
						"showAdaptButton" : true
					}
				}
			}).placeAt("test-view");
			sap.ui.getCore().applyChanges();
			//will render only if SAPUI5 core init is done.

			jQuery.sap.require("sap.ui.qunit.qunit-coverage");
			jQuery.sap.require("sap.ui.rta.Utils");
			jQuery.sap.require("sap.ui.fl.fieldExt.Access");
			jQuery.sap.require("sap.ui.thirdparty.sinon");
			jQuery.sap.require("sap.ui.thirdparty.sinon-ie");
			jQuery.sap.require("sap.ui.thirdparty.sinon-qunit");


			QUnit.module("Given that a SmartForm with OData Binding is given...", {
				beforeEach : function(assert) {
				},
				afterEach : function(assert) {
				}
			});

			QUnit.test("when hasGroupElementBoundFields is called with a given GroupElement", function(assert) {
				var oGroupElementWithBinding = sap.ui.getCore().byId("idMain1--GeneralLedgerDocument.BoundButton");
				var oGroupElementWithNoBinding = sap.ui.getCore().byId("idMain1--GeneralLedgerDocument.BoundButton34");

				assert.ok(sap.ui.rta.Utils.hasGroupElementBoundFields(oGroupElementWithBinding), "then it returns true for a GroupElement with OData Binding");
				assert.ok(!sap.ui.rta.Utils.hasGroupElementBoundFields(oGroupElementWithNoBinding), "then it returns false for a GroupelElement without OData Binding");
			});

			QUnit.test("when hasGroupUnElementUnBoundFields is called with a given GroupElement", function(assert) {
				var oGroupElementWithOneUnboundField = sap.ui.getCore().byId("idMain1--GeneralLedgerDocument.BoundButton");
				var oGroupElementWithNoBinding = sap.ui.getCore().byId("idMain1--GeneralLedgerDocument.BoundButton34");
				var oGroupElementWithBinding = sap.ui.getCore().byId("idMain1--GeneralLedgerDocument.ExpirationDate");

				assert.ok(sap.ui.rta.Utils.hasGroupElementUnBoundFields(oGroupElementWithOneUnboundField), "then it returns true for a GroupElement with 1 OData Binding");
				assert.ok(sap.ui.rta.Utils.hasGroupElementUnBoundFields(oGroupElementWithNoBinding), "then it returns false for a GroupelElement without OData Binding");
				assert.ok(!sap.ui.rta.Utils.hasGroupElementUnBoundFields(oGroupElementWithBinding), "then it returns false for a GroupelElement with OData Binding");
			});

			QUnit.test("when hasGroupUnBoundFields is called with a given Group", function(assert) {
				var oGroupWithBindingElements = sap.ui.getCore().byId("idMain1--Reversal");
				var oGroupWithNoBindingElements = sap.ui.getCore().byId("idMain1--GeneralLedgerDocument");

				assert.ok(!sap.ui.rta.Utils.hasGroupUnBoundFields(oGroupWithBindingElements), "then it returns false for a Group with GroupElements when all have OData Binding");
				assert.ok(sap.ui.rta.Utils.hasGroupUnBoundFields(oGroupWithNoBindingElements), "then it returns true for a Group with GroupElements when one of them has no OData Binding");
			});

			QUnit.test("when getPathFromBindingInfo is called with empty binding", function(assert) {
				var mBindingInfo = {};
				assert.ok(sap.ui.rta.Utils.getPathFromBindingInfo('test', mBindingInfo) === undefined, "then it returns undefined");
			});

			QUnit.test("when getPathFromBindingInfo is called with binding containing parts", function(assert) {
				var mBindingInfo = {test: {parts: ['path']}};
				assert.ok(sap.ui.rta.Utils.getPathFromBindingInfo('test', mBindingInfo) === "path", "then it returns the path");
			});

			QUnit.test("when getPathFromBindingInfo is called with binding containing a single part", function(assert) {
				var mBindingInfo = {test: {path: 'path'}};
				assert.ok(sap.ui.rta.Utils.getPathFromBindingInfo('test', mBindingInfo) === "path", "then it returns the path");
			});

			QUnit.test("when getLabelForElement is called with a component that does not behave like a label", function(assert) {
				var oPlainObject =  new Object();
				assert.ok(sap.ui.rta.Utils.getLabelForElement(oPlainObject) === undefined, "then it returns undefined");
			});

			QUnit.test("when getBoundEntityType is called for ", function(assert) {
				var oBindingReady = new Promise(function(resolve){
					//ensure core init with its first rendering is done
					sap.ui.getCore().attachInit(function(){
						var oView = sap.ui.getCore().byId("idMain1");
						oView.getModel().attachRequestCompleted(function(){
							resolve();
						});
						// force refresh, so that th above event will processed in any case
						oView.getModel().refresh(true);
					})
				});
				return oBindingReady.then(function(){
					var oGroupElementWithBinding = sap.ui.getCore().byId("idMain1--GeneralLedgerDocument.ExpirationDate");
					var oGroupElementWithOneUnboundField = sap.ui.getCore().byId("idMain1--GeneralLedgerDocument.BoundButton");
					var oGroupElementWithNoBinding = sap.ui.getCore().byId("idMain1--GeneralLedgerDocument.BoundButton34");

					var oGroupWithBindingElements = sap.ui.getCore().byId("idMain1--Reversal");
					var oGroupWithNoBindingElements = sap.ui.getCore().byId("idMain1--GeneralLedgerDocument");

					assert.equal(sap.ui.rta.Utils.getBoundEntityType(oGroupElementWithBinding), "Header", "a field with binding then finds the entity type");
					assert.equal(sap.ui.rta.Utils.getBoundEntityType(oGroupElementWithOneUnboundField), "Header", "a field with partial binding then finds the entity type");
					assert.equal(sap.ui.rta.Utils.getBoundEntityType(oGroupElementWithNoBinding), "Header", "a field no binding then finds the entity type");
					assert.equal(sap.ui.rta.Utils.getBoundEntityType(oGroupWithBindingElements), "Header", "a group with binding then finds the entity type");
					assert.equal(sap.ui.rta.Utils.getBoundEntityType(oGroupWithNoBindingElements), "Header", "a group no binding then finds the entity type");
				});
			});

			QUnit.module("Extensibility isServiceUpToDate", {
				beforeEach : function(assert) {
					this.sandbox = sinon.sandbox.create();
				},
				afterEach : function(assert) {
					this.sandbox.restore();
				}
			});

			QUnit.test("Given extensibility disabled in the system when isServiceUpToDate is called", function(assert) {
				this.sandbox.stub(sap.ui.rta.Utils, "isExtensibilityEnabledInSystem").returns(Promise.resolve(false));

				var isServiceOutdatedStub = this.sandbox.stub(sap.ui.fl.fieldExt.Access, "isServiceOutdated");
				var oAnything = {};

				return sap.ui.rta.Utils.isServiceUpToDate(oAnything).then(function(){
					assert.equal(isServiceOutdatedStub.callCount, 0, "then service is not asked to be invalid");
				});

			});

			QUnit.test("Given extensibility enabled and an unbound control when isServiceUpToDate is called", function(assert) {
				this.sandbox.stub(sap.ui.rta.Utils, "isExtensibilityEnabledInSystem").returns(Promise.resolve(true));
				var isServiceOutdatedStub = this.sandbox.stub(sap.ui.fl.fieldExt.Access, "isServiceOutdated");
				var oUnboundControl = new sap.m.Button({text: "unbound"});

				return sap.ui.rta.Utils.isServiceUpToDate(oUnboundControl).then(function(){
					assert.equal(isServiceOutdatedStub.callCount, 0, "then service is not asked to be invalid");
				});
			});

			QUnit.test("Given extensibility enabled and a bound control and a not outdated service when isServiceUpToDate is called", function(assert) {
				this.sandbox.stub(sap.ui.rta.Utils, "isExtensibilityEnabledInSystem").returns(Promise.resolve(true));
				var isServiceOutdatedStub = this.sandbox.stub(sap.ui.fl.fieldExt.Access, "isServiceOutdated").returns(false);
				var setServiceValidStub = this.sandbox.stub(sap.ui.fl.fieldExt.Access, "setServiceValid");

				var oBoundControl = sap.ui.getCore().byId("idMain1--GeneralLedgerDocument.ExpirationDate");

				return sap.ui.rta.Utils.isServiceUpToDate(oBoundControl).then(function(bUpToDate){
					assert.ok(bUpToDate, "then the service is recognized as up to date");
					assert.equal(isServiceOutdatedStub.callCount, 1, "then service is asked to be invalid");
					assert.equal(setServiceValidStub.callCount, 0, "then service is not unneccessarily set to be valid");
				});

			});

			QUnit.test("Given extensibility enabled and a bound control and an outdated service when isServiceUpToDate is called", function(assert) {
				var done = assert.async();

				this.sandbox.stub(sap.ui.rta.Utils, "isExtensibilityEnabledInSystem").returns(Promise.resolve(true));
				var isServiceOutdatedStub = this.sandbox.stub(sap.ui.fl.fieldExt.Access, "isServiceOutdated").returns(true);
				var setServiceValidStub = this.sandbox.stub(sap.ui.fl.fieldExt.Access, "setServiceValid");

				var oBoundControl = sap.ui.getCore().byId("idMain1--GeneralLedgerDocument.ExpirationDate");

				sap.ui.getCore().getEventBus().subscribe("sap.ui.core.UnrecoverableClientStateCorruption","RequestReload", function(){
					assert.ok("then the UI refresh is requested");
				});
				sap.ui.rta.Utils.isServiceUpToDate(oBoundControl).then(function(bUpToDate){
					assert.ok(!bUpToDate, "then the service is recognized as outdated date");
					assert.equal(setServiceValidStub.callCount, 1, "then service is set to be valid again");

					done();
				});
			});

			QUnit.done(function( details ) {
				// If coverage is reuqested, remove the view to not overlap the coverage result
				if(QUnit.config.coverage == true && details.failed === 0){
					jQuery("#test-view").hide();
					oCompCont.getComponentInstance().destroy();
				};
			});

			</script>
	</head>
	<body>
		<h1 id="qunit-header">QUnit page for sap.ui.rta.ToolsMenu</h1>
		<h2 id="qunit-banner"></h2>
	 	<h2 id="qunit-userAgent"></h2>
		<div id="qunit-testrunner-toolbar"></div>
		<ol id="qunit-tests"></ol>
		<div id="test-view"></div>
	</body>
</html>
