<html>
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<title>qUnit Page for sap.ui.generic.app.transaction.DraftContext</title>

		<script id="sap-ui-bootstrap" type="text/javascript"
			src="../../../../../../../resources/sap-ui-core.js"
			data-sap-ui-theme="sap_bluecrystal" data-sap-ui-noConflict="true"
			data-sap-ui-libs="sap.ui.generic.app">
		</script>

		<link rel="stylesheet"	href="../../../../../../../resources/sap/ui/thirdparty/qunit.css"	type="text/css" media="screen" />
		<script type="text/javascript"	src="../../../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
		<script type="text/javascript"	src="../../../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
		<script type="text/javascript"	src="../../../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
		<script type="text/javascript"	src="../../../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
		<script type="text/javascript"	src="../../../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>

		<script type="text/javascript">

		<!-- add the qunit-coverage.js to add client-side coverage to QUnit tests -->
		if (!(sap.ui.Device.browser.internet_explorer && sap.ui.Device.browser.version <= 8)) {
			jQuery.sap.require("sap.ui.qunit.qunit-coverage");
		}

		jQuery.sap.require("sap.ui.model.odata.ODataMetaModel");
		jQuery.sap.require("sap.ui.model.odata.ODataModel");
		jQuery.sap.require("sap.ui.generic.app.transaction.DraftContext");

		var succeed = function(text){
			assert.ok(true, text);
			start();
		};

		var fail = function(text) {
			assert.ok(false, text);
			start();
		};

		QUnit.module("sap.ui.generic.app.transaction.DraftContext", {
			beforeEach: function() {
				this.oModel = sinon.createStubInstance(sap.ui.model.odata.ODataModel);
				this.oContext = new sap.ui.generic.app.transaction.DraftContext(this.oModel);
			},
			afterEach: function() {
				this.oContext.destroy();
			}
		});

		QUnit.test("Shall be instantiable", function() {
			assert.ok(this.oContext);
		});

		QUnit.test("Model is a mandatory parameter", function() {
			var oContext, bException = false;

			try {
				oBaseController = new sap.ui.generic.app.transaction.DraftContext();
			} catch (ex) {
				bException = true;
			}

			assert.ok(bException);
		});

		QUnit.test("isDraftEnabled", function() {
			var oContext, oModel;

			oModel = sinon.createStubInstance(sap.ui.model.odata.ODataModel);
			oModel.getMetaModel = function() {
				return {
					getODataEntitySet: sinon.stub().returns({
						entityType : "namespace.EntityTypeName",
						"com.sap.vocabularies.Common.v1.DraftRoot": true
					})
				};
			};
			oContext = new sap.ui.generic.app.transaction.DraftContext(oModel);
			assert.ok(oContext.isDraftEnabled("mockEntitySet"), "should return true");

			oContext.destroy();
		});

		QUnit.test("_getODataDraftEntitySet: entity set is mandatory", function() {
			var bException = false;

			try {
				this.oContext.isDraftEnabled();
			} catch (ex) {
				bException = true;
			}

			assert.ok(bException);
		});

		QUnit.test("_getEntitySetFromContext: binding context is mandatory", function() {
			var bException = false;

			try {
				this.oContext.hasDraft();
			} catch (ex) {
				bException = true;
			}

			assert.ok(bException);
		});

		QUnit.test("hasDraft", function() {
			var oContext, oModel, oCtxt = {
				getPath: function() {
					return "/mockEntitySet(1)";
				}
			};

			oModel = sinon.createStubInstance(sap.ui.model.odata.ODataModel);
			oModel.getMetaModel = function() {
				return {
					getODataEntitySet: sinon.stub().returns({
						entityType : "namespace.EntityTypeName",
						"com.sap.vocabularies.Common.v1.DraftRoot": true
					})
				};
			};

			oContext = new sap.ui.generic.app.transaction.DraftContext(oModel);
			assert.ok(oContext.hasDraft(oCtxt), "should return true");	

			oContext.destroy();
		});

		QUnit.test("isDraftRoot", function() {
			var oContext, oModel;

			oModel = sinon.createStubInstance(sap.ui.model.odata.ODataModel);
			oModel.getMetaModel = function() {
				return {
					getODataEntitySet: sinon.stub().returns({
						entityType : "namespace.EntityTypeName",
						"com.sap.vocabularies.Common.v1.DraftRoot": true
					})
				};
			};
			oContext = new sap.ui.generic.app.transaction.DraftContext(oModel);
			assert.ok(oContext.isDraftRoot("mockEntitySet"), "should return true");	

			oContext.destroy();
		});

		QUnit.test("hasDraftRoot", function() {
			var oContext, oModel;

			oModel = sinon.createStubInstance(sap.ui.model.odata.ODataModel);
			oModel.getMetaModel = function() {
				return {
					getODataEntitySet: sinon.stub().returns({
						entityType : "namespace.EntityTypeName",
						"com.sap.vocabularies.Common.v1.DraftRoot": true
					})
				};
			};
			oContext = new sap.ui.generic.app.transaction.DraftContext(oModel);
			assert.ok(oContext.hasDraftRoot({
				getPath: function() {
					return "/dummyPath";
				}
			}), "should return true");

			oContext.destroy();
		});

		QUnit.test("hasDraftValidationFunction", function() {
			var oContext, oModel;

			oModel = sinon.createStubInstance(sap.ui.model.odata.ODataModel);
			oModel.getMetaModel = function() {
				return {
					getODataEntitySet: sinon.stub().returns({
						entityType : "namespace.EntityTypeName",
						"com.sap.vocabularies.Common.v1.DraftNode": {
							"ValidationFunction": {
								"String": true
							}
						}
					})
				};
			};
			oContext = new sap.ui.generic.app.transaction.DraftContext(oModel);

			assert.ok(oContext.hasDraftValidationFunction({
				getPath: function() {
					return "/dummyPath";
				}
			}), "should return true");

			oContext.destroy();
		});

		QUnit.test("hasDraftPreparationAction", function() {
			var oContext, oModel;

			oModel = sinon.createStubInstance(sap.ui.model.odata.ODataModel);
			oModel.getMetaModel = function() {
				return {
					getODataEntitySet: sinon.stub().returns({
						entityType : "namespace.EntityTypeName",
						"com.sap.vocabularies.Common.v1.DraftNode": {
							"PreparationAction": {
								"String": true
							}
						}
					})
				};
			};
			oContext = new sap.ui.generic.app.transaction.DraftContext(oModel);

			assert.ok(oContext.hasDraftPreparationAction({
				getPath: function() {
					return "/dummyPath";
				}
			}), "should return true");

			oContext.destroy();
		});

		QUnit.test("isSemanticKey", function() {
			var oContext, oModel, aSemanticKey, oEntity = {
				mock1: true,
				mock3: true
			};

			oModel = sinon.createStubInstance(sap.ui.model.odata.ODataModel);
			oModel.getMetaModel = function() {
				return {
					getODataEntitySet: sinon.stub().returns({
						name : "EntitySet",
						entityType: "namespace.EntityTypeName",
						"com.sap.vocabularies.Common.v1.DraftRoot": true
					}),
					getODataEntityType: sinon.stub().returns({
						name : "EntityTypeName",
						'com.sap.vocabularies.Common.v1.SemanticKey' : [{PropertyPath: "mock1"},{PropertyPath: "mock2"}]
					})
				};
			};

			oContext = new sap.ui.generic.app.transaction.DraftContext(oModel);
			assert.ok(oContext.isSemanticKey("EntityTypeName", {
				"mock1": true,
				"mock2": true
			}));


			oContext.destroy();
		});

		QUnit.test("isSemanticKey shall return false for unknown key property", function() {
			var oContext, oModel, aSemanticKey, oEntity = {
				mock1: true,
				mock3: true
			};

			oModel = sinon.createStubInstance(sap.ui.model.odata.ODataModel);
			oModel.getMetaModel = function() {
				return {
					getODataEntitySet: sinon.stub().returns({
						name : "EntitySet",
						entityType: "namespace.EntityTypeName",
						"com.sap.vocabularies.Common.v1.DraftRoot": true
					}),
					getODataEntityType: sinon.stub().returns({
						name : "EntityTypeName",
						'com.sap.vocabularies.Common.v1.SemanticKey' : [{PropertyPath: "mock1"},{PropertyPath: "mock3"}]
					})
				};
			};

			oContext = new sap.ui.generic.app.transaction.DraftContext(oModel);
			assert.ok(!oContext.isSemanticKey("EntityTypeName", {
				"mock1": true,
				"mock2": true
			}));


			oContext.destroy();
		});
		QUnit.test("isSemanticKey for non draft-enabled entity set", function() {
			var oContext, oModel, aSemanticKey, oEntity = {
				mock1: true,
				mock3: true
			};

			oModel = sinon.createStubInstance(sap.ui.model.odata.ODataModel);
			oModel.getMetaModel = function() {
				return {
					getODataEntitySet: sinon.stub().returns({
						name : "EntitySet",
						entityType: "namespace.EntityTypeName"
					}),
					getODataEntityType: sinon.stub().returns({
						name : "EntityTypeName",
						'com.sap.vocabularies.Common.v1.SemanticKey' : [{PropertyPath: "mock1"},{PropertyPath: "mock2"}]
					})
				};
			};

			oContext = new sap.ui.generic.app.transaction.DraftContext(oModel);
			assert.ok(!oContext.isSemanticKey("EntityTypeName", {
				"mock1": true,
				"mock2": true
			}));

			oContext.destroy();
		});

		QUnit.test("is technical key", function() {
			var oContext, oModel, oEntity = {
				mock1 : true,
			    mock2 : true
			};

			oModel = sinon.createStubInstance(sap.ui.model.odata.ODataModel);
			oModel.getMetaModel = function() {
				return {
					getODataEntitySet: sinon.stub().returns({entityType : "namespace.EntityTypeName"}),
					getODataEntityType: sinon.stub().returns({
						name : "EntityTypeName",
						key : {
							propertyRef : [{name: 'mock1'}, {name: 'mock2'}]
						}
					})
				};
			};
			oContext = new sap.ui.generic.app.transaction.DraftContext(oModel);
			assert.ok(oContext.isTechnicalKey("mock", oEntity), "is technical key");

			oContext.destroy();

		});

		QUnit.test("is not technical key", function() {
			var oContext, oModel, oEntity = {
				mock1 : true,
				mock3 : true
			};

			oModel = sinon.createStubInstance(sap.ui.model.odata.ODataModel);
			oModel.getMetaModel = function() {
				return {
					getODataEntitySet: sinon.stub().returns({entityType : "namespace.EntityTypeName"}),
					getODataEntityType: sinon.stub().returns({
						name : "EntityTypeName",
						key : {
							propertyRef : [{name: 'mock1'}, {name: 'mock2'}]
						}
					})
				};
			};

			oContext = new sap.ui.generic.app.transaction.DraftContext(oModel);
			assert.ok(!oContext.isTechnicalKey("mock", oEntity), "is not a technical key");

			oContext.destroy();
		});

		QUnit.test("is not technical key (invalid number of keys)", function() {
			var oContext, oModel, oEntity = {
				mock1 : true
			};

			oModel = sinon.createStubInstance(sap.ui.model.odata.ODataModel);
			oModel.getMetaModel = function() {
				return {
					getODataEntitySet: sinon.stub().returns({entityType : "namespace.EntityTypeName"}),
					getODataEntityType: sinon.stub().returns({
						name : "EntityTypeName",
						key : {
							propertyRef : [{name: 'mock1'}, {name: 'mock3'}]
						}
					})
				};
			};

			oContext = new sap.ui.generic.app.transaction.DraftContext(oModel);
			assert.ok(!oContext.isTechnicalKey("mock", oEntity), "is not a technical key");

			oContext.destroy();
		});

		QUnit.test("isTechnicalKey: enitity set is mandatory", function() {
			var bException = false;

			try {
				this.oContext.isTechnicalKey();
			} catch (ex) {
				bException = true;
			}

			assert.ok(bException);
		});

		QUnit.test("get semantic key", function() {
			var oContext, oModel, aSemanticKey, oEntity = {
				mock1: true,
				mock3: true
			};

			oModel = sinon.createStubInstance(sap.ui.model.odata.ODataModel);
			oModel.getMetaModel = function() {
				return {
					getODataEntitySet: sinon.stub().returns({
						name : "EntitySet",
						entityType: "namespace.EntityTypeName"
					}),
					getODataEntityType: sinon.stub().returns({
						name : "EntityTypeName",
						'com.sap.vocabularies.Common.v1.SemanticKey' : [{PropertyPath: "mock1"},{PropertyPath: "mock2"}]
					})
				};
			};

			oContext = new sap.ui.generic.app.transaction.DraftContext(oModel);
			aSemanticKey = oContext.getSemanticKey("EntityTypeName");
			assert.deepEqual(aSemanticKey, [ {name : "mock1"}, {name : "mock2"}], 'is semantic key');

			oContext.destroy();
		});

		QUnit.test("get empty semantic key", function() {
			var oContext, oModel, aSemanticKey, oEntity = {
				mock1: true,
				mock3: true
			};

			oModel = sinon.createStubInstance(sap.ui.model.odata.ODataModel);
			oModel.getMetaModel = function() {
				return {
					getODataEntitySet: sinon.stub().returns({
						name : "EntitySet",
						entityType: "namespace.EntityTypeName"
					}),
					getODataEntityType: sinon.stub().returns({
						name : "EntityTypeName"
					})
				};
			};
			oContext = new sap.ui.generic.app.transaction.DraftContext(oModel);
			aSemanticKey = oContext.getSemanticKey("EntityTypeName");
			assert.deepEqual(aSemanticKey, [], "initial semantic key");

			oContext.destroy();
		});

		QUnit.test("getSemanticKey: enitity set is mandatory", function() {
			var bException = false;

			try {
				this.oContext.getSemanticKey();
			} catch (ex) {
				bException = true;
			}

			assert.ok(bException);
		});

		QUnit.test("checkUpdateOnChange: enitity set is mandatory", function() {
			var bException = false;

			try {
				this.oContext.checkUpdateOnChange();
			} catch (ex) {
				bException = true;
			}

			assert.ok(bException);
		});

		QUnit.test("checkUpdateOnChange", function() {
			var oContext, oModel, aSemanticKey, oEntity = {
				mock1: true,
				mock3: true
			};

			oModel = sinon.createStubInstance(sap.ui.model.odata.ODataModel);
			oModel.getMetaModel = function() {
				return {
					getODataEntitySet: sinon.stub().returns({
						name : "EntitySet",
						entityType: "namespace.EntityTypeName",
						"com.sap.vocabularies.Common.v1.UpdateOnChange": [ { PropertyPath : "mockProp"}],
						"com.sap.vocabularies.Common.v1.SideEffects#" : {
							"SourceProperties" : [
								{
									"PropertyPath": "mockProp"
								}
							]
						}
					})
				};
			};

			oContext = new sap.ui.generic.app.transaction.DraftContext(oModel);
			assert.ok(oContext.checkUpdateOnChange("mockEntitySet", "mockProp"), "should return true");
			oContext.destroy();
		});

		QUnit.test("checkUpdateOnChange returns false", function() {
			var oContext, oModel, aSemanticKey, oEntity = {
				mock1: true,
				mock3: true
			};

			oModel = sinon.createStubInstance(sap.ui.model.odata.ODataModel);
			oModel.getMetaModel = function() {
				return {
					getODataEntitySet: sinon.stub().returns({
						name : "EntitySet",
						entityType: "namespace.EntityTypeName",
						"com.sap.vocabularies.Common.v1.UpdateOnChange": [ { PropertyPath : "mockProp"}],
						"com.sap.vocabularies.Common.v1.SideEffects#" : {
							"SourceProperties" : [
								{
									"PropertyPath": "mockProp"
								}
							]
						}
					})
				};
			};

			oContext = new sap.ui.generic.app.transaction.DraftContext(oModel);
			assert.ok(!oContext.checkUpdateOnChange("mockEntitySet", "mockProp1"), "should return false");
			oContext.destroy();
		});

		QUnit.test("hasDraftAdministrativeData", function() {
			var oContext, oModel, aSemanticKey, oEntity = {
				mock1: true,
				mock3: true
			};

			oModel = sinon.createStubInstance(sap.ui.model.odata.ODataModel);
			oModel.getMetaModel = function() {
				return {
					getODataEntitySet: sinon.stub().returns({
						name : "EntitySet",
						entityType: "namespace.EntityTypeName"
					}),
					getODataEntityType: sinon.stub().returns({
						name : "EntityTypeName",
						navigationProperty : [{name: "DraftAdministrativeData" }]
					})
				};
			};

			oContext = new sap.ui.generic.app.transaction.DraftContext(oModel);
			assert.ok(oContext.hasDraftAdministrativeData("mockEntitySet"), "should return true");
			oContext.destroy();
		});

		QUnit.test("hasDraftAdministrativeData shall return false", function() {
			var oContext, oModel, aSemanticKey, oEntity = {
				mock1: true,
				mock3: true
			};

			oModel = sinon.createStubInstance(sap.ui.model.odata.ODataModel);
			oModel.getMetaModel = function() {
				return {
					getODataEntitySet: sinon.stub().returns({
						name : "EntitySet",
						entityType: "namespace.EntityTypeName"
					}),
					getODataEntityType: sinon.stub().returns({
						name : "EntityTypeName",
						navigationProperty : [{name: "DraftAdministrativeData111" }]
					})
				};
			};

			oContext = new sap.ui.generic.app.transaction.DraftContext(oModel);
			assert.ok(!oContext.hasDraftAdministrativeData("mockEntitySet"), "should return true");
			oContext.destroy();
		});

		QUnit.test("getODataDraftFunctionImportName", function() {
			var oBinding, oContext, oModel, aSemanticKey, oEntity = {
				mock1: true,
				mock3: true
			};

			oModel = sinon.createStubInstance(sap.ui.model.odata.ODataModel);
			oModel.getMetaModel = function() {
				return {
					getODataEntitySet: sinon.stub().returns({
						name : "EntitySet",
						entityType: "namespace.EntityTypeName",
						"com.sap.vocabularies.Common.v1.DraftRoot" : {
							"mockFunction": {
								"String": "mockString"
							}
						}
					}),
					getODataEntityType: sinon.stub().returns({
						name : "EntityTypeName",
						navigationProperty : [{name: "DraftAdministrativeData" }]
					})
				};
			};

			oBinding = {
				getPath : function() {
					return "/MockSet(1)";
				}
			};
			oContext = new sap.ui.generic.app.transaction.DraftContext(oModel);
			assert.ok(oContext.getODataDraftFunctionImportName(oBinding, "mockFunction"), "should return true");
			oContext.destroy();
		});

		QUnit.test("getODataDraftFunctionImportName shall return null", function() {
			var oBinding, oContext, oModel, aSemanticKey, oEntity = {
				mock1: true,
				mock3: true
			};

			oModel = sinon.createStubInstance(sap.ui.model.odata.ODataModel);
			oModel.getMetaModel = function() {
				return {
					getODataEntitySet: sinon.stub().returns({
						name : "EntitySet",
						entityType: "namespace.EntityTypeName",
						"com.sap.vocabularies.Common.v1.DraftRoot" : {
							"mockFunction": {
								"String": "mockString"
							}
						}
					}),
					getODataEntityType: sinon.stub().returns({
						name : "EntityTypeName",
						navigationProperty : [{name: "DraftAdministrativeData" }]
					})
				};
			};

			oBinding = {
				getPath : function() {
					return "/MockSet(1)";
				}
			};
			oContext = new sap.ui.generic.app.transaction.DraftContext(oModel);
			assert.ok(!oContext.getODataDraftFunctionImportName(oBinding, "mockFunction1"), "should return null");
			oContext.destroy();
		});

		QUnit.test("hasPreserveChanges shall return true", function( assert ) {
			var done = assert.async();

			var  oModel;
			var oContext;
			var oUiContext = {};

			var sUri = "/mock/";
			jQuery.sap.require("sap/ui/core/util/MockServer");
			var oMockServer = new sap.ui.core.util.MockServer({
				rootUri : sUri
			});
			var sMetadataUrl = "../testdata/DraftService/metadata.xml";
			var sMockdataBaseUrl = "DraftProductData/";

			oMockServer.simulate(sMetadataUrl, sMockdataBaseUrl);
			oMockServer.start();

			oModel = new sap.ui.model.odata.v2.ODataModel(sUri, true);
			
			oContext = new sap.ui.generic.app.transaction.DraftContext(oModel);

			oUiContext.getPath = function(){
				return "/SEPMRA_C_SalesOrder";
			};

			oModel.getMetaModel().loaded().then(function(){
				assert.ok(oContext.hasPreserveChanges(oUiContext), "Flag 'PreserveChanges' correctly found with value 'true'");

				oContext.destroy();
				oMockServer.destroy();
				done();
			});
		});

		QUnit.test("hasPreserveChanges shall return false", function( assert ) {
			var done = assert.async();

			var  oModel;
			var oContext;
			var oUiContext = {};

			var sUri = "/mock/";
			jQuery.sap.require("sap/ui/core/util/MockServer");
			var oMockServer = new sap.ui.core.util.MockServer({
				rootUri : sUri
			});
			var sMetadataUrl = "../testdata/DraftService/metadata.xml";
			var sMockdataBaseUrl = "DraftProductData/";

			oMockServer.simulate(sMetadataUrl, sMockdataBaseUrl);
			oMockServer.start();

			oModel = new sap.ui.model.odata.v2.ODataModel(sUri, true);

			oContext = new sap.ui.generic.app.transaction.DraftContext(oModel);

			oUiContext.getPath = function(){
				return "/SEPM_I_BusinessPartner_E";
			};

			oModel.getMetaModel().loaded().then(function(){
				assert.ok(!oContext.hasPreserveChanges(oUiContext), "Flag 'PreserveChanges' found with value 'false'");

				oContext.destroy();
				oMockServer.destroy();
				done();
			});
		});

		QUnit.test("Shall be destructible", function() {
			this.oContext.destroy();
			assert.ok(this.oContext);
			assert.equal(this.oContext._oModel, null);
		});
		</script>
	</head>
	<body id="body" class="sapUiBody">
		<h1 id="qunit-header">qUnit Page for sap.ui.generic.app.transaction.DraftContext</h1>
		<h2 id="qunit-banner"></h2>
		<h2 id="qunit-userAgent"></h2>
		<ol id="qunit-tests"></ol>
	</body>
</html>