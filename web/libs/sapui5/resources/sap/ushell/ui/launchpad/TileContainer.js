/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
jQuery.sap.declare("sap.ushell.ui.launchpad.TileContainer");jQuery.sap.require("sap.ushell.library");jQuery.sap.require("sap.ui.core.Control");sap.ui.core.Control.extend("sap.ushell.ui.launchpad.TileContainer",{metadata:{library:"sap.ushell",properties:{"scrollType":{type:"string",group:"Misc",defaultValue:'item'},"animationSpeed":{type:"int",group:"Misc",defaultValue:500},"groupId":{type:"string",group:"Misc",defaultValue:null},"showHeader":{type:"boolean",group:"Misc",defaultValue:true},"showPlaceholder":{type:"boolean",group:"Misc",defaultValue:true},"defaultGroup":{type:"boolean",group:"Misc",defaultValue:false},"isLastGroup":{type:"boolean",group:"Misc",defaultValue:false},"headerText":{type:"string",group:"Misc",defaultValue:null},"headerLevel":{type:"sap.m.HeaderLevel",group:"Misc",defaultValue:sap.m.HeaderLevel.H2},"groupHeaderLevel":{type:"sap.m.HeaderLevel",group:"Misc",defaultValue:sap.m.HeaderLevel.H4},"showGroupHeader":{type:"boolean",group:"Misc",defaultValue:true},"visible":{type:"boolean",group:"Misc",defaultValue:true},"sortable":{type:"boolean",group:"Misc",defaultValue:true},"showNoData":{type:"boolean",group:"Misc",defaultValue:false},"noDataText":{type:"string",group:"Misc",defaultValue:null},"isGroupLocked":{type:"boolean",group:"Misc",defaultValue:null},"editMode":{type:"boolean",group:"Misc",defaultValue:false},"showBackground":{type:"boolean",group:"Misc",defaultValue:false},"icon":{type:"string",group:"Misc",defaultValue:'sap-icon://locked'},"showIcon":{type:"boolean",group:"Misc",defaultValue:false},"deluminate":{type:"boolean",group:"Misc",defaultValue:false},"showMobileActions":{type:"boolean",group:"Misc",defaultValue:false},"enableHelp":{type:"boolean",group:"Misc",defaultValue:false},"tileActionModeActive":{type:"boolean",group:"Misc",defaultValue:false},"ieHtml5DnD":{type:"boolean",group:"Misc",defaultValue:false},"showDragIndicator":{type:"boolean",group:"Misc",defaultValue:false}},aggregations:{"tiles":{type:"sap.ushell.ui.launchpad.Tile",multiple:true,singularName:"tile"},"links":{type:"sap.ushell.ui.launchpad.LinkTileWrapper",multiple:true,singularName:"link"},"beforeContent":{type:"sap.ui.core.Control",multiple:true,singularName:"beforeContent"},"afterContent":{type:"sap.ui.core.Control",multiple:true,singularName:"afterContent"},"footerContent":{type:"sap.ui.core.Control",multiple:true,singularName:"footerContent"},"headerActions":{type:"sap.ui.core.Control",multiple:true,singularName:"headerAction"}},events:{"afterRendering":{},"add":{},"titleChange":{}}}});sap.ushell.ui.launchpad.TileContainer.M_EVENTS={'afterRendering':'afterRendering','add':'add','titleChange':'titleChange'};(function(){"use strict";jQuery.sap.require("sap.ushell.override");sap.ushell.ui.launchpad.TileContainer.prototype.init=function(){jQuery.sap.require("sap.ushell.ui.launchpad.PlusTile");this.bIsFirstTitleChange=true;this._sDefaultValue=sap.ushell.resources.i18n.getText("new_group_name");this._sOldTitle="";this.oIcon=new sap.ui.core.Icon({src:this.getIcon()});this.oIcon.addStyleClass('sapUshellContainerIcon');this.oPlusTile=new sap.ushell.ui.launchpad.PlusTile({groupId:this.getGroupId(),press:[this.fireAdd,this]});this.oPlusTile.setParent(this);};sap.ushell.ui.launchpad.TileContainer.prototype.exit=function(){if(this.oPlusTile){this.oPlusTile.destroy();}};sap.ushell.ui.launchpad.TileContainer.prototype.onAfterRendering=function(){var t=this,j;if(this.getEnableHelp()){this.oPlusTile.addStyleClass("help-id-plusTile");}this.handleNoItemsToDisplayMessage();var E=this.getModel()&&this.getModel().getProperty("/enableRenameLockedGroup")||false;jQuery("#"+this.getId()+"-title").find(this.getHeaderLevel()).click(function(){var e=E||!t.getIsGroupLocked()&&!t.getDefaultGroup()&&t.getTileActionModeActive();t.setEditMode(e);});if((document.documentMode)&&(navigator.maxTouchPoints||navigator.msMaxTouchPoints)){j=jQuery(this.getDomRef());j.on("MSHoldVisual contextmenu",".sapUshellTile",function(e){e.preventDefault();});}this.fireAfterRendering();};sap.ushell.ui.launchpad.TileContainer.prototype.updateAggregation=sap.ushell.override.updateAggregation;sap.ushell.ui.launchpad.TileContainer.prototype.updateTiles=function(r){var n="tiles";if(this.isTreeBinding(n)){sap.ui.base.ManagedObject.prototype.updateAggregation.apply(this,arguments);}else{jQuery.sap.log.debug("Updating TileContainer. Reason: ",r);switch(r){case"filter":try{this.filterTiles();}catch(e){this.updateAggregation(n);}break;default:this.updateAggregation(n);}}};sap.ushell.ui.launchpad.TileContainer.prototype.handleNoItemsToDisplayMessage=function(){var t=this.getBinding('tiles'),i=t&&t.getContexts().length;if(i){this.$().find(".sapUshellNoFilteredItems").hide();}else{if(this.getShowNoData()){if(this.getNoDataText()){this.setNoDataText(this.getNoDataText());}else{this.setNoDataText(sap.ushell.resources.i18n.getText("noFilteredItems"));}this.$().find(".sapUshellNoFilteredItems").show();}}};sap.ushell.ui.launchpad.TileContainer.prototype.createMissingElementsInOnScreenElements=function(i,e,a,g,s,b,f,A){var p,n=null,G=null,j=a,S=this.getShowGroupHeader(),c=e.length,o;for(j=a;j<c;j++){p=e[j].getPath();if(!i.onScreenPathIndexMap[p]){if(g&&s.length>0){n=s[0].fnGroup(e[j]);if(typeof n==="string"){n={key:n};}if(G===null&&j>0){G=s[0].fnGroup(e[j-1]);}if(n.key!==G){if(b.groupHeaderFactory){o=b.groupHeaderFactory(n);}if(!i.onScreenHeaders[n.key]){A(n,o);i.onScreenHeaders[n.key]={aItemsRefrenceIndex:this.getTiles().length-1,isVisible:S};}G=n.key;}}f(e[j]);i.onScreenPathIndexMap[p]={aItemsRefrenceIndex:this.getTiles().length-1,isVisible:true};}else{throw true;}}};sap.ushell.ui.launchpad.TileContainer.prototype.addNewItem=function(e){var n="tiles",a=this.getMetadata().getJSONKeys()[n],b=this.mBindingInfos[n],f=b.factory,c=jQuery.proxy(function(C){var i=this.getId()+"-"+jQuery.sap.uid(),o=f(i,C);o.setBindingContext(C,b.model);this[a._sMutator](o);},this);c(e);};sap.ushell.ui.launchpad.TileContainer.prototype.markVisibleOnScreenElements=function(e,i){var a=0,p,b=e.length;for(a=0;a<b;a++){p=e[a].getPath();if(i.onScreenPathIndexMap[p]){i.onScreenPathIndexMap[p].isVisible=true;}else{return a;}}return a;};sap.ushell.ui.launchpad.TileContainer.prototype.indexOnScreenElements=function(o){var p,i,a={onScreenHeaders:{},onScreenPathIndexMap:{}},b=o.length,c;for(i=0;i<b;i++){c=o[i];if(c.getHeaderText){a.onScreenHeaders[c.getHeaderText()]={aItemsRefrenceIndex:i,isVisible:false};}else if(c.getBindingContext()){p=c.getBindingContext().getPath();a.onScreenPathIndexMap[p]={aItemsRefrenceIndex:i,isVisible:false};}}return a;};sap.ushell.ui.launchpad.TileContainer.prototype.showHideTilesAndHeaders=function(i,o){var s,n="tiles",S=this.getShowGroupHeader(),b=this.mBindingInfos[n].binding,g,r,e;for(s in i.onScreenPathIndexMap){if(i.onScreenPathIndexMap.hasOwnProperty(s)){e=i.onScreenPathIndexMap[s];r=o[e.aItemsRefrenceIndex];r.setVisible(e.isVisible);if(e.isVisible){g=b.aSorters[0].fnGroup(r.getBindingContext());i.onScreenHeaders[g].isVisible=S;}}}for(s in i.onScreenHeaders){if(i.onScreenHeaders.hasOwnProperty(s)){e=i.onScreenHeaders[s];o[e.aItemsRefrenceIndex].setVisible(e.isVisible);}}};sap.ushell.ui.launchpad.TileContainer.prototype.filterTiles=function(){var n="tiles",b=this.mBindingInfos[n],B=this.mBindingInfos[n].binding,a=B.getContexts(),i=this.getTiles(),c,d,l,f,s,e,g,h;d=this.indexOnScreenElements(i);c=this.markVisibleOnScreenElements(a,d);if(a[c]&&this.getTiles().length>0){l=this.getTiles()[this.getTiles().length-1].getBindingContext().getPath();f=a[c].getPath();s=l.split('/');e=f.split('/');h=s[s.length-1];g=e[e.length-1];if(parseInt(h,10)>parseInt(g,10)){throw true;}}this.createMissingElementsInOnScreenElements(d,a,c,B.isGrouped(),B.aSorters,b,this.addNewItem.bind(this),this.addTileGroup.bind(this));i=this.getTiles();this.showHideTilesAndHeaders(d,i);this.handleNoItemsToDisplayMessage();};sap.ushell.ui.launchpad.TileContainer.prototype.addTileGroup=function(g,h){this.addAggregation("tiles",h||new sap.ushell.ui.launchpad.HeaderTile({headerText:g.text||g.key,headerLevel:g.headerLevel||this.getGroupHeaderLevel(),visible:this.getShowGroupHeader()}));};sap.ushell.ui.launchpad.TileContainer.prototype.setNoDataText=function(n){this.setProperty("noDataText",n,true);if(this.getShowNoData()){this.$().find(".sapUshellNoFilteredItems").text(n);}return this;};sap.ushell.ui.launchpad.TileContainer.prototype.setGroupId=function(v){this.setProperty("groupId",v,true);if(this.oPlusTile){this.oPlusTile.setGroupId(v);}return this;};sap.ushell.ui.launchpad.TileContainer.prototype.setHeaderText=function(h){this.setProperty("headerText",h,true);this.$().find(".sapUshellContainerTitle").text(h);return this;};sap.ushell.ui.launchpad.TileContainer.prototype.setVisible=function(v){this.setProperty("visible",v,true);this.toggleStyleClass("sapUshellHidden",!v);return this;};sap.ushell.ui.launchpad.TileContainer.prototype.setShowMobileActions=function(s){var S=true;if(this.oHeaderButton){this.oHeaderButton.setVisible(s);}else if(s){S=false;}this.setProperty('showMobileActions',s,S);};sap.ushell.ui.launchpad.TileContainer.prototype.setShowIcon=function(s){this.setProperty('showIcon',s,true);jQuery('#'+this.getId()).find('.'+'sapUshellContainerIcon').toggleClass('sapUshellContainerIconHidden',!s);};sap.ushell.ui.launchpad.TileContainer.prototype.setDeluminate=function(d){this.setProperty('deluminate',d,true);this.toggleStyleClass('sapUshellDisableLockedGroupDuringDrag',d);return this;};sap.ushell.ui.launchpad.TileContainer.prototype.groupHasTiles=function(){var p='',t=this.getTiles(),l=[];if(this.getBindingContext()){p=this.getBindingContext().sPath;t=this.getModel().getProperty(p).tiles;}return sap.ushell.utils.groupHasVisibleTiles(t,l);};sap.ushell.ui.launchpad.TileContainer.prototype.getInnerContainerDomRef=function(){var c=this.getDomRef(),i;if(!c){return null;}i=jQuery(c).find('.sapUshellTilesContainer-sortable');return i[0];};sap.ushell.ui.launchpad.TileContainer.prototype.setEditMode=function(v){this.setProperty('editMode',v,false);if(v){this.addStyleClass('sapUshellEditing');this._startEdit();}else{this.removeStyleClass('sapUshellEditing');}};sap.ushell.ui.launchpad.TileContainer.prototype._startEdit=function(){if(this.getModel()&&!this.getModel().getProperty("/editTitle")){this.getModel().setProperty("/editTitle",true,false);}if(!this.oEditInputField){jQuery.sap.require("sap.m.Input");var t=this;this.oEditInputField=new sap.m.Input({placeholder:this._sDefaultValue,value:this.getHeaderText()}).addStyleClass('sapUshellTileContainerTitleInput');this.oEditInputField.addEventDelegate({onfocusout:function(e){t._stopEdit();jQuery.proxy(t.setEditMode,t,false)();},onsapenter:function(e){t._stopEdit();jQuery.proxy(t.setEditMode,t,false)();setTimeout(function(){var T=e.srcControl,j=jQuery(T.getDomRef()).prev();j.focus();},0);}});}this._sOldTitle=this._sDefaultValue;this.oEditInputField.setValue(this.getHeaderText());var t=this;setTimeout(function(){if(sap.ui.Device.system.phone){var e=sap.ui.getCore().getEventBus();e.publish("launchpad","scrollToGroup",{group:t,groupChanged:false,focus:false});}jQuery(t.oEditInputField.getDomRef()).find('input').focus();t.oEditInputField.selectText(0,t.oEditInputField.getValue().length);},100);};sap.ushell.ui.launchpad.TileContainer.prototype._stopEdit=function(){var c=this.getHeaderText();var n=this.oEditInputField.getValue(),h;n=n.substring(0,256).trim()||this._sDefaultValue;h=n!==c;if(this.bIsFirstTitleChange&&n===this.oEditInputField.getPlaceholder()){h=true;}this.bIsFirstTitleChange=false;if(this.getModel()&&this.getModel().getProperty("/editTitle")){this.getModel().setProperty("/editTitle",false,false);}if(!this._sOldTitle){this._sOldTitle=c;this.setHeaderText(c);}else if(h){this.fireTitleChange({newTitle:n});this.setHeaderText(n);}};sap.ushell.ui.launchpad.TileContainer.prototype.exit=function(){if(this.oHeaderButton){this.oHeaderButton.destroy();}if(this.oActionSheet){this.oActionSheet.destroy();}if(sap.ui.core.Control.prototype.exit){sap.ui.core.Control.prototype.exit.apply(this,arguments);}};}());
