// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";var p="sap.ushell.components.container.",c=p+"ApplicationContainer",d="sap.ushell.Container.dirtyState.",l,r,f=true;jQuery.sap.declare("sap.ushell.components.container.ApplicationContainer");jQuery.sap.require("sap.ushell.utils");jQuery.sap.require("sap.ushell.library");jQuery.sap.require("sap.ui.core.UIComponent");jQuery.sap.require("sap.m.MessagePopover");function a(T){var C=sap.ushell.Container.getService("CrossApplicationNavigation");C.isUrlSupported(T.url).done(function(){T.promise.resolve({"allowed":true,"id":T.id});}).fail(function(){T.promise.resolve({"allowed":false,"id":T.id});});}l=new sap.ushell.utils.Map();sap.ushell.components.container.ApplicationType={URL:"URL",WDA:"WDA",NWBC:"NWBC",TR:"TR"};function g(C){return l.get(C.getId());}function b(U){var P=jQuery.sap.getUriParameters(U).mParams,e=P["sap-xapp-state"],R;delete P["sap-xapp-state"];R={startupParameters:P};if(e){R["sap-xapp-state"]=e;}return R;}function h(K,e){if(!r){r=jQuery.sap.resources({url:jQuery.sap.getModulePath(p)+"/resources/resources.properties",language:sap.ui.getCore().getConfiguration().getLanguage()});}return r.getText(K,e);}function i(){return new sap.ui.core.Icon({size:"2rem",src:"sap-icon://error",tooltip:sap.ushell.components.container.ApplicationContainer.prototype._getTranslatedText("an_error_has_occured")});}function j(C){var e=C.getAggregation("child"),B;if(e instanceof sap.ui.core.ComponentContainer){B=e.getComponentInstance().getMetadata().getName().replace(/\.Component$/,"");jQuery.sap.log.debug("unloading component "+B,null,c);}C.destroyAggregation("child");}function k(C,U,e){var B,D,I,L,M,E,N,V={},F,G;I=U.indexOf("?");if(I>=0){E=sap.ushell.components.container.ApplicationContainer.prototype._getParameterMap(U);V=E.startupParameters;U=U.slice(0,I);}if(U.slice(-1)!=='/'){U+='/';}if(/\.view\.(\w+)$/i.test(e)){M=/^SAPUI5=(?:([^\/]+)\/)?([^\/]+)\.view\.(\w+)$/i.exec(e);if(!M){jQuery.sap.log.error("Invalid SAPUI5 URL",e,c);return sap.ushell.components.container.ApplicationContainer.prototype._createErrorControl();}N=M[1];F=M[2];G=M[3].toUpperCase();if(N){F=N+"."+F;}else{L=F.lastIndexOf(".");if(L<1){jQuery.sap.log.error("Missing namespace",e,c);return sap.ushell.components.container.ApplicationContainer.prototype._createErrorControl();}N=F.slice(0,L);}}else{N=e.replace(/^SAPUI5=/,"");}jQuery.sap.registerModulePath(N,U+N.replace(/\./g,'/'));sap.ushell.components.container.ApplicationContainer.prototype._destroyChild(C);if(F){if(C.getApplicationConfiguration()){V.config=C.getApplicationConfiguration();}D=sap.ui.view({id:C.getId()+"-content",type:G,viewData:V||{},viewName:F});C.fireEvent("applicationConfiguration");}else{jQuery.sap.log.debug("loading component "+N,null,c);var H=E?{startupParameters:E.startupParameters}:{startupParameters:{}};if(E&&E["sap-xapp-state"]){H["sap-xapp-state"]=E["sap-xapp-state"];}if(C.getApplicationConfiguration()){H.config=C.getApplicationConfiguration();}B=sap.ui.component({id:C.getId()+"-component",componentData:H,name:N});C.fireEvent("applicationConfiguration",{"configuration":B.getMetadata().getConfig()});D=new sap.ui.core.ComponentContainer({id:C.getId()+"-content",component:B});}D.setWidth(C.getWidth());D.setHeight(C.getHeight());D.addStyleClass("sapUShellApplicationContainer");C.setAggregation("child",D,true);return D;}function m(e,D){setTimeout(function(){sap.ui.getCore().getEventBus().publish("sap.ushell.components.container.ApplicationContainer",e,D);},0);}function n(C,U,e){var I,B,D,E,F={startupParameters:{}},G,H=C.getComponentHandle(),P=sap.ushell.Container.getService("PluginManager"),J,K;sap.ushell.utils.addTime("createUi5Component");I=U.indexOf("?");if(I>=0){E=sap.ushell.components.container.ApplicationContainer.prototype._getParameterMap(U);F={startupParameters:E.startupParameters};if(E["sap-xapp-state"]){F["sap-xapp-state"]=E["sap-xapp-state"];}U=U.slice(0,I);}if(C.getApplicationConfiguration()){F.config=C.getApplicationConfiguration();}if(U.slice(-1)!=='/'){U+='/';}jQuery.sap.registerModulePath(e,U);jQuery.sap.require("sap.ushell.services.CrossApplicationNavigation");sap.ushell.components.container.ApplicationContainer.prototype._destroyChild(C);G={id:C.getId()+"-component",name:e,componentData:F};jQuery.sap.log.debug("Creating component instance for "+e,JSON.stringify(G),c);sap.ui.getCore().getEventBus().publish("sap.ushell.components.container.ApplicationContainer","_prior.newUI5ComponentInstantion",{name:e});if(H){B=H.getInstance(G);}else{jQuery.sap.log.error("No component handle available for '"+e+"'; fallback to component.load()",null,c);B=sap.ui.component({id:C.getId()+"-component",name:e,componentData:F});}C.fireEvent("applicationConfiguration",{"configuration":B.getMetadata().getConfig()});D=new sap.ui.core.ComponentContainer({id:C.getId()+"-content",component:B});if(B.navigationRedirect){var N=B.navigationRedirect();if(N){D.setVisible(false);N.done(function(L){sap.ushell.Container.getService("ShellNavigation").toExternal({target:{shellHash:L}},undefined,false);}).fail(function(){D.setVisible(true);});}}D.setHeight(C.getHeight());D.setWidth(C.getWidth());D.addStyleClass("sapUShellApplicationContainer");C._disableRouterEventHandler=sap.ushell.components.container.ApplicationContainer.prototype._disableRouter.bind(this,B);sap.ui.getCore().getEventBus().subscribe("sap.ushell.components.container.ApplicationContainer","_prior.newUI5ComponentInstantion",C._disableRouterEventHandler);C.setAggregation("child",D,true);if(P){J=P.getPluginLoadingPromise("RendererExtensions");K=J&&J.state();if(K==="pending"){J.done(function(){sap.ushell.components.container.ApplicationContainer.prototype._publishExternalEvent("componentCreated",{component:B});}).fail(function(){sap.ushell.components.container.ApplicationContainer.prototype._publishExternalEvent("componentCreated",{component:B});});}if(K==="resolved"||K==="rejected"){sap.ushell.components.container.ApplicationContainer.prototype._publishExternalEvent("componentCreated",{component:B});}}sap.ushell.components.container.ApplicationContainer.prototype._publishExternalEvent("componentCreated",{component:B});return D;}function o(C){var e;if((C instanceof sap.ui.core.Component)&&(typeof C.getRouter==="function")){e=C.getRouter();if(e&&(typeof e.stop==="function")){jQuery.sap.log.info("router stopped for instance "+C.getId());e.stop();}}}function q(U){var e=document.createElement("a"),C=jQuery.sap.getUriParameters(U).get("sap-client"),B;e.href=U;B=e.protocol+"//"+e.host;return new sap.ushell.System({alias:C?B+"?sap-client="+C:B,baseUrl:B,client:C||undefined,platform:"abap"});}function s(C,M){var T=false,D=C.getDomRef(),e=C.getApplicationType(),U,O;if(D){if(sap.ushell.utils.isApplicationTypeNWBCRelated(e)){U=URI(D.src);O=U.protocol()+"://"+U.host();T=(M.source===D.contentWindow)||(M.origin===O);}else if(e===sap.ushell.components.container.ApplicationType.URL){U=URI();O=U.protocol()+"://"+U.host();T=(M.origin===O);}}return T;}function t(C,M,e){var P=jQuery.sap.getObject("sap-ushell-config.services.PostMessage.config",0),S=e&&e.service,B;if(e.type!=="request"||!S||(S.indexOf("sap.ushell.services.CrossApplicationNavigation")!==0&&S.indexOf("sap.ushell.ui5service.ShellUIService")!==0&&S.indexOf("sap.ushell.services.ShellUIService")!==0)){return;}B=S.split(".")[3];if(P&&P.enabled===false){jQuery.sap.log.warning("Received message for "+B+", but this "+"feature is disabled. It can be enabled via launchpad configuration "+"property 'services.PostMessage.config.enabled: true'",undefined,"sap.ushell.components.container.ApplicationContainer");return;}if(!sap.ushell.components.container.ApplicationContainer.prototype._isTrustedPostMessageSource(C,M)){jQuery.sap.log.warning("Received message from untrusted origin: "+M.origin,M.data,"sap.ushell.components.container.ApplicationContainer");return;}function D(G,H){M.source.postMessage(JSON.stringify({type:"response",service:e.service,request_id:e.request_id,status:G,body:H}),M.origin);}function E(B){switch(B){case"sap.ushell.services.CrossApplicationNavigation.hrefForExternal":return new jQuery.Deferred().resolve(sap.ushell.Container.getService("CrossApplicationNavigation").hrefForExternal(e.body.oArgs)).promise();case"sap.ushell.services.CrossApplicationNavigation.getSemanticObjectLinks":return sap.ushell.Container.getService("CrossApplicationNavigation").getSemanticObjectLinks(e.body.sSemanticObject,e.body.mParameters,e.body.bIgnoreFormFactors,undefined,undefined,e.body.bCompactIntents);case"sap.ushell.services.CrossApplicationNavigation.isIntentSupported":return sap.ushell.Container.getService("CrossApplicationNavigation").isIntentSupported(e.body.aIntents);case"sap.ushell.services.CrossApplicationNavigation.isNavigationSupported":return sap.ushell.Container.getService("CrossApplicationNavigation").isNavigationSupported(e.body.aIntents);case"sap.ushell.services.CrossApplicationNavigation.toExternal":return new jQuery.Deferred().resolve(sap.ushell.Container.getService("CrossApplicationNavigation").toExternal(e.body.oArgs)).promise();case"sap.ushell.services.CrossApplicationNavigation.getAppStateData":return sap.ushell.Container.getService("CrossApplicationNavigation").getAppStateData(e.body.sAppStateKey);case"sap.ushell.ui5service.ShellUIService.setTitle":return new jQuery.Deferred().resolve(C.getShellUIService().setTitle(e.body.sTitle)).promise();case"sap.ushell.services.ShellUIService.setTitle":return new jQuery.Deferred().resolve(C.getShellUIService().setTitle(e.body.sTitle)).promise();default:return undefined;}}try{E(e.service).done(function(R){D("success",{result:R});}).fail(function(G){D("error",{message:G});});}catch(F){D("error",{message:F.message});}}function u(C,M){var B=M.data;if(typeof B==="string"){try{B=JSON.parse(M.data);}catch(e){jQuery.sap.log.debug("Message received from origin '"+M.origin+"' cannot be parsed: "+e,B,"sap.ushell.components.container.ApplicationContainer");return;}}if(B.action==="pro54_setGlobalDirty"&&localStorage.getItem(C.globalDirtyStorageKey)===sap.ushell.Container.DirtyState.PENDING){if(!sap.ushell.components.container.ApplicationContainer.prototype._isTrustedPostMessageSource(C,M)){jQuery.sap.log.warning("Received message from untrusted origin: "+M.origin,B,"sap.ushell.components.container.ApplicationContainer");return;}jQuery.sap.log.debug("getGlobalDirty() pro54_setGlobalDirty SetItem key:"+C.globalDirtyStorageKey+" value: "+B.parameters.globalDirty,null,"sap.ushell.components.container.ApplicationContainer");sap.ushell.utils.localStorageSetItem(C.globalDirtyStorageKey,B.parameters.globalDirty,true);}else{sap.ushell.components.container.ApplicationContainer.prototype._handleServiceMessageEvent(C,M,B);}}function v(C,e){var I=C.getDomRef(),B=C.getApplicationType();if(sap.ushell.utils.isApplicationTypeNWBCRelated(C.getApplicationType(B))&&I&&I.tagName==="IFRAME"){I.contentWindow.postMessage(JSON.stringify({action:"pro54_disableDirtyHandler"}),'*');e.preventDefault();}}function w(R,C,e){R.write("<div").writeControlData(C).writeAccessibilityState(C).addClass("sapUShellApplicationContainer").writeClasses(C).addStyle("height",C.getHeight()).addStyle("width",C.getWidth()).writeStyles().write(">").renderControl(e);R.write("</div>");}function x(U,B){var T,C=function(){var e=sap.ushell.utils.getParameterValueBoolean("sap-accessibility");if(e!==undefined){return e;}return sap.ushell.Container.getUser().getAccessibilityMode();},V,D=function(){try{var V=sap.ui.getVersionInfo().version,M=/\d+\.\d+\.\d+/.exec(V);if(M&&M[0]){V=M[0];}}catch(e){jQuery.sap.log.error("sap ui version could not be determined "+e);V="";}return V;};U+=U.indexOf("?")>=0?"&":"?";U+="sap-ie=edge";T=sap.ushell.Container.getUser().getTheme(sap.ushell.User.prototype.constants.themeFormat.NWBC);if(T){U+=U.indexOf("?")>=0?"&":"?";U+="sap-theme="+encodeURIComponent(T);}if(C()){U+=U.indexOf("?")>=0?"&":"?";U+="sap-accessibility=X";}if(B==="TR"){return U;}V=D();if(V){U+=U.indexOf("?")>=0?"&":"?";U+="sap-shell="+encodeURIComponent("FLP"+V+"-NWBC");}return U;}function y(R,C,U,e){var B=C.getAggregation("child");if(!B||C._bRecreateChild){B=sap.ushell.components.container.ApplicationContainer.prototype._createUi5Component(C,U,e);C._bRecreateChild=false;}sap.ushell.components.container.ApplicationContainer.prototype._renderControlInDiv(R,C,B);}function z(C,K,V){var O=C.getProperty(K);if(jQuery.sap.equal(O,V)){return;}C.setProperty(K,V);C._bRecreateChild=true;}function A(R,C,e,U,B){var L;localStorage.removeItem(C.globalDirtyStorageKey);if(B&&B.indexOf("SAPUI5.Component=")===0&&e===sap.ushell.components.container.ApplicationType.URL){y(R,C,U,B.replace(/^SAPUI5\.Component=/,""));return;}if(B&&B.indexOf("SAPUI5=")===0&&e===sap.ushell.components.container.ApplicationType.URL){sap.ushell.components.container.ApplicationContainer.prototype._renderControlInDiv(R,C,sap.ushell.components.container.ApplicationContainer.prototype._createUi5View(C,U,B));return;}jQuery.sap.log.debug("Not resolved as \"SAPUI5.Component=\" or \"SAPUI5=\" , "+"will attempt to load into iframe "+B);try{U=C.getFrameSource(e,U,B);}catch(D){jQuery.sap.log.error(D.message||D,null,c);C.fireEvent("applicationConfiguration");R.renderControl(sap.ushell.components.container.ApplicationContainer.prototype._createErrorControl());return;}if(sap.ushell.Container){L=sap.ushell.components.container.ApplicationContainer.prototype._getLogoutHandler(C);if(!L){if(sap.ushell.utils.isApplicationTypeNWBCRelated(e)){L=sap.ushell.components.container.ApplicationContainer.prototype._logout.bind(null,C);l.put(C.getId(),L);sap.ushell.Container.attachLogoutEvent(L);sap.ushell.Container.addRemoteSystem(sap.ushell.components.container.ApplicationContainer.prototype._createSystemForUrl(U));}}else{if(!sap.ushell.utils.isApplicationTypeNWBCRelated(e)){sap.ushell.Container.detachLogoutEvent(L);l.remove(C.getId());}}}if(sap.ushell.utils.isApplicationTypeNWBCRelated(e)){U=sap.ushell.components.container.ApplicationContainer.prototype._adjustNwbcUrl(U,e);sap.ushell.utils.localStorageSetItem(C.globalDirtyStorageKey,sap.ushell.Container.DirtyState.INITIAL);}C.fireEvent("applicationConfiguration");R.write("<iframe").writeControlData(C).writeAccessibilityState(C).writeAttributeEscaped("src",U).addClass("sapUShellApplicationContainer").writeClasses(C).addStyle("height",C.getHeight()).addStyle("width",C.getWidth()).writeStyles().write("></iframe>");}sap.ui.core.Control.extend(c,{metadata:{properties:{additionalInformation:{defaultValue:"",type:"string"},application:{type:"object"},applicationConfiguration:{type:"object"},applicationType:{defaultValue:"URL",type:p+"ApplicationType"},height:{defaultValue:"100%",type:"sap.ui.core.CSSSize"},navigationMode:{defaultValue:"",type:"string"},text:{defaultValue:"",type:"string"},url:{defaultValue:"",type:"string"},visible:{defaultValue:true,type:"boolean"},"sap-system":{defaultValue:undefined,type:"string"},applicationDependencies:{type:"object"},componentHandle:{type:"object"},ui5ComponentName:{type:"string"},width:{defaultValue:"100%",type:"sap.ui.core.CSSSize"},shellUIService:{type:"object"}},events:{"applicationConfiguration":{}},aggregations:{child:{multiple:false,type:"sap.ui.core.Control",visibility:"hidden"}},library:"sap.ushell"},exit:function(){var L,e=this;if(sap.ushell.Container){L=sap.ushell.components.container.ApplicationContainer.prototype._getLogoutHandler(e);if(L){sap.ushell.Container.detachLogoutEvent(L);l.remove(e.getId());}}localStorage.removeItem(e.globalDirtyStorageKey);if(e._unloadEventListener){removeEventListener("unload",e._unloadEventListener);}if(e._disableRouterEventHandler){sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.components.container.ApplicationContainer","_prior.newUI5ComponentInstantion",e._disableRouterEventHandler);}if(e._storageEventListener){removeEventListener("storage",e._storageEventListener);}if(e._messageEventListener){removeEventListener("message",e._messageEventListener);}sap.ushell.components.container.ApplicationContainer.prototype._destroyChild(e);if(sap.ui.core.Control.exit){sap.ui.core.Control.exit.apply(e);}},init:function(){var e=this;e.globalDirtyStorageKey=d+jQuery.sap.uid();e._unloadEventListener=e.exit.bind(e);addEventListener("unload",e._unloadEventListener);e._storageEventListener=function(S){var B=e.getApplicationType();if(S.key===e.globalDirtyStorageKey&&S.newValue===sap.ushell.Container.DirtyState.PENDING&&sap.ushell.utils.isApplicationTypeNWBCRelated(B)){var I=e.getDomRef();if(I&&I.tagName==="IFRAME"){jQuery.sap.log.debug("getGlobalDirty() send pro54_getGlobalDirty ",null,"sap.ushell.components.container.ApplicationContainer");I.contentWindow.postMessage(JSON.stringify({action:"pro54_getGlobalDirty"}),'*');}}};addEventListener('storage',e._storageEventListener);e._messageEventListener=sap.ushell.components.container.ApplicationContainer.prototype._handleMessageEvent.bind(null,e);addEventListener('message',e._messageEventListener);if(f){var M={"asyncURLHandler":sap.ushell.components.container.ApplicationContainer.prototype._adaptIsUrlSupportedResultForMessagePopover};if(sap.m.MessagePopover&&sap.m.MessagePopover.setDefaultHandlers){sap.m.MessagePopover.setDefaultHandlers(M);}f=false;}},renderer:function(R,C){var e=C.getApplication(),L=C.launchpadData,B;if(!C.getVisible()){sap.ushell.components.container.ApplicationContainer.prototype._renderControlInDiv(R,C);return;}if(C.error){delete C.error;sap.ushell.components.container.ApplicationContainer.prototype._renderControlInDiv(R,C,sap.ushell.components.container.ApplicationContainer.prototype._createErrorControl());}else if(!e){sap.ushell.components.container.ApplicationContainer.prototype._render(R,C,C.getApplicationType(),C.getUrl(),C.getAdditionalInformation());}else if(!e.isResolvable()){sap.ushell.components.container.ApplicationContainer.prototype._render(R,C,e.getType(),e.getUrl(),"");}else if(L){sap.ushell.components.container.ApplicationContainer.prototype._render(R,C,L.applicationType,L.Absolute.url.replace(/\?$/,""),L.applicationData);}else{jQuery.sap.log.debug("Resolving "+e.getUrl(),null,c);e.resolve(function(D){jQuery.sap.log.debug("Resolved "+e.getUrl(),JSON.stringify(D),c);C.launchpadData=D;sap.ushell.components.container.ApplicationContainer.prototype._destroyChild(C);},function(E){var D=e.getMenu().getDefaultErrorHandler();if(D){D(E);}sap.ushell.components.container.ApplicationContainer.prototype._destroyChild(C);C.error=E;});B=new sap.m.Text({text:sap.ushell.components.container.ApplicationContainer.prototype._getTranslatedText("loading",[e.getText()])});sap.ushell.components.container.ApplicationContainer.prototype._destroyChild(C);C.setAggregation("child",B);sap.ushell.components.container.ApplicationContainer.prototype._renderControlInDiv(R,C,B);}}});sap.ushell.components.container.ApplicationContainer.prototype.getFrameSource=function(e,U,B){if(!Object.prototype.hasOwnProperty.call(sap.ushell.components.container.ApplicationType,e)){throw new Error("Illegal application type: "+e);}return U;};sap.ushell.components.container.ApplicationContainer.prototype.setUrl=function(V){z(this,"url",V);};sap.ushell.components.container.ApplicationContainer.prototype.setAdditionalInformation=function(V){z(this,"additionalInformation",V);};sap.ushell.components.container.ApplicationContainer.prototype.setApplicationType=function(V){z(this,"applicationType",V);};sap.ushell.components.container.ApplicationContainer.prototype._adaptIsUrlSupportedResultForMessagePopover=a;sap.ushell.components.container.ApplicationContainer.prototype._getLogoutHandler=g;sap.ushell.components.container.ApplicationContainer.prototype._getParameterMap=b;sap.ushell.components.container.ApplicationContainer.prototype._getTranslatedText=h;sap.ushell.components.container.ApplicationContainer.prototype._createErrorControl=i;sap.ushell.components.container.ApplicationContainer.prototype._destroyChild=j;sap.ushell.components.container.ApplicationContainer.prototype._createUi5View=k;sap.ushell.components.container.ApplicationContainer.prototype._publishExternalEvent=m;sap.ushell.components.container.ApplicationContainer.prototype._createUi5Component=n;sap.ushell.components.container.ApplicationContainer.prototype._disableRouter=o;sap.ushell.components.container.ApplicationContainer.prototype._createSystemForUrl=q;sap.ushell.components.container.ApplicationContainer.prototype._isTrustedPostMessageSource=s;sap.ushell.components.container.ApplicationContainer.prototype._handleServiceMessageEvent=t;sap.ushell.components.container.ApplicationContainer.prototype._handleMessageEvent=u;sap.ushell.components.container.ApplicationContainer.prototype._logout=v;sap.ushell.components.container.ApplicationContainer.prototype._renderControlInDiv=w;sap.ushell.components.container.ApplicationContainer.prototype._adjustNwbcUrl=x;sap.ushell.components.container.ApplicationContainer.prototype._render=A;}());
