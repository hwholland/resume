// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";var S="sap.ushell.services.Container",a="sap.ushell.Container.dirtyState.",c,p,f;jQuery.sap.declare(S);jQuery.sap.require("sap.ushell.utils");jQuery.sap.require("sap.ushell.System");function b(){close();}function r(){document.location="about:blank";}function g(P){if(p&&p[P]){return p[P];}return"sap.ushell.adapters."+P;}function d(s){return(c.services&&c.services[s])||{};}function h(n,s,P){var A=d(n).adapter||{},e=A.module||g(s.getPlatform())+"."+n+"Adapter";jQuery.sap.require(e);return new(jQuery.sap.getObject(e))(s,P,{config:A.config||{}});}function C(A){var E=new sap.ui.base.EventProvider(),j=false,R=[],o={},s="sap.ushell.Container."+A.getSystem().getPlatform()+".remoteSystem.",m={},G,k,l=sap.ushell.utils.getLocalStorage(),n=new sap.ushell.utils.Map(),q="sap.ushell.Container."+A.getSystem().getPlatform()+".sessionTermination",t=this;this.cancelLogon=function(){if(this.oFrameLogonManager){this.oFrameLogonManager.cancelXHRLogon();}};this.createRenderer=function(e){var i,w,x,y,z;e=e||c.defaultRenderer;if(!e){throw new Error("Missing renderer name");}z=(c.renderers&&c.renderers[e])||{};w=z.module||(e.indexOf(".")<0?"sap.ushell.renderers."+e+".Renderer":e);jQuery.sap.require(w);if(z.componentData&&z.componentData.config){i={config:z.componentData.config};}x=new(jQuery.sap.getObject(w))({componentData:i});if(x instanceof sap.ui.core.UIComponent){y=new sap.ui.core.ComponentContainer({component:x,height:"100%",width:"100%"});}else{y=x;}if(!(y instanceof sap.ui.core.Control)){throw new Error("Unsupported renderer type for name "+e);}o[e]=y;E.fireEvent("rendererCreated",{renderer:x});return y;};this.getRenderer=function(e){var i,w;e=e||c.defaultRenderer;if(e){i=o[e];}else{w=Object.keys(o);if(w.length===1){i=o[w[0]];}else{jQuery.sap.log.warning("getRenderer() - cannot determine renderer, because no default renderer is configured and multiple instances exist.",undefined,S);}}if(i instanceof sap.ui.core.ComponentContainer){return i.getComponentInstance();}return i;};this.DirtyState={CLEAN:"CLEAN",DIRTY:"DIRTY",MAYBE_DIRTY:"MAYBE_DIRTY",PENDING:"PENDING",INITIAL:"INITIAL"};this.getGlobalDirty=function(){var i,D=new jQuery.Deferred(),U=jQuery.sap.uid(),w,P=0,x=this.DirtyState.CLEAN;function y(){if(P===0||x===t.DirtyState.DIRTY){D.resolve(x);jQuery.sap.log.debug("getGlobalDirty() Resolving: "+x,null,"sap.ushell.Container");}}function z(B){if(B.key.indexOf(a)===0&&B.newValue!==t.DirtyState.INITIAL&&B.newValue!==t.DirtyState.PENDING){jQuery.sap.log.debug("getGlobalDirty() Receiving event key: "+B.key+" value: "+B.newValue,null,"sap.ushell.Container");if(B.newValue===t.DirtyState.DIRTY||B.newValue===t.DirtyState.MAYBE_DIRTY){x=B.newValue;}P-=1;y();}}try{l.setItem(U,"CHECK");l.removeItem(U);}catch(e){jQuery.sap.log.warning("Error calling localStorage.setItem(): "+e,null,"sap.ushell.Container");return D.resolve(this.DirtyState.MAYBE_DIRTY).promise();}if(G){throw new Error("getGlobalDirty already called!");}G=D;window.addEventListener('storage',z);D.always(function(){window.removeEventListener('storage',z);G=undefined;});for(i=l.length-1;i>=0;i-=1){w=l.key(i);if(w.indexOf(a)===0){if(l.getItem(w)==='PENDING'){l.removeItem(w);jQuery.sap.log.debug("getGlobalDirty() Cleanup of unresolved 'PENDINGS':"+w,null,"sap.ushell.Container");}else{P+=1;sap.ushell.utils.localStorageSetItem(w,this.DirtyState.PENDING,true);jQuery.sap.log.debug("getGlobalDirty() Requesting status for: "+w,null,"sap.ushell.Container");}}}y();setTimeout(function(){if(D.state()!=="resolved"){D.resolve('MAYBE_DIRTY');jQuery.sap.log.debug("getGlobalDirty() Timeout reached, - resolved 'MAYBE_DIRTY'",null,"sap.ushell.Container");}},P*2000);return D.promise();};this.getLogonSystem=function(){return A.getSystem();};this.getUser=function(){return A.getUser();};this.getDirtyFlag=function(){for(var i=0;i<R.length;i++){j=j||R[i].call();}return j;};this.setDirtyFlag=function(i){j=i;};this.registerDirtyStateProvider=function(D){if(typeof D!=="function"){throw new Error("fnDirty must be a function");}R.push(D);};this.getService=function(e,P){var i={},M,K,w,x,y,z,B;function D(F){var H=new jQuery.Deferred();if(!F){throw new Error("Missing system");}H.resolve(h(e,F,P));sap.ushell.Container.addRemoteSystem(F);return H.promise();}if(!e){throw new Error("Missing service name");}if(e.indexOf(".")>=0){throw new Error("Unsupported service name");}z=d(e);M=z.module||"sap.ushell.services."+e;K=M+"/"+(P||"");B={config:z.config||{}};if(!n.containsKey(K)){jQuery.sap.require(M);w=jQuery.sap.getObject(M);if(w.hasNoAdapter===true){x=new w(i,P,B);}else{y=h(e,A.getSystem(),P);i.createAdapter=D;x=new w(y,i,P,B);}n.put(K,x);return x;}return n.get(K);};function u(){var w,x,i,K;for(i=l.length-1;i>=0;i-=1){K=l.key(i);if(K.indexOf(s)===0){try{w=K.substring(s.length);x=JSON.parse(l.getItem(K));m[w]=new sap.ushell.System(x);}catch(e){l.removeItem(K);}}}return m;}function v(){function e(i,w,F){jQuery.sap.log.warning(i,null,"sap.ushell.Container");if(F){setTimeout(F.bind(null,i),5000);}return{abort:function(){return;}};}OData.read=function(i,w,F){return e("OData.read('"+(i&&i.Uri?i.requestUri:i)+"') disabled during logout processing",w,F);};OData.request=function(i,w,F){return e("OData.request('"+(i?i.requestUri:"")+"') disabled during logout processing",w,F);};}this.addRemoteSystem=function(e){var i=e.getAlias(),O=m[i];if(O){if(O.toString()===e.toString()){return;}jQuery.sap.log.warning("Replacing "+O+" by "+e,null,"sap.ushell.Container");}else{jQuery.sap.log.debug("Added "+e,null,"sap.ushell.Container");}m[i]=e;sap.ushell.utils.localStorageSetItem(s+i,e);};this.addRemoteSystemForServiceUrl=function(e){var M,i={baseUrl:";o="};if(!e||e.charAt(0)!=='/'||e.indexOf('//')===0){return;}M=/^[^?]*;o=([^\/;?]*)/.exec(e);if(M&&M.length>=2){i.alias=M[1];}e=e.replace(/;[^\/?]*/g,"");if(/^\/sap\/(bi|hana|hba)\//.test(e)){i.platform="hana";i.alias=i.alias||"hana";}else if(/^\/sap\/opu\//.test(e)){i.platform="abap";}if(i.alias&&i.platform){this.addRemoteSystem(new sap.ushell.System(i));}};this.attachLogoutEvent=function(F){E.attachEvent("Logout",F);};this.detachLogoutEvent=function(F){E.detachEvent("Logout",F);};this.attachRendererCreatedEvent=function(F){E.attachEvent("rendererCreated",F);};this.detachRendererCreatedEvent=function(F){E.detachEvent("rendererCreated",F);};this.logout=function(){var D=new jQuery.Deferred();function i(){A.logout(true).always(function(){l.removeItem(q);D.resolve();});}function w(){if(E.fireEvent("Logout",true)){i();}else{setTimeout(i,1000);}}function x(){var m,y=[];if(k){window.removeEventListener('storage',k);}sap.ushell.utils.localStorageSetItem(q,"pending");t._suppressOData();m=t._getRemoteSystems();Object.keys(m).forEach(function(z){try{y.push(h("Container",m[z]).logout(false));}catch(e){jQuery.sap.log.warning("Could not create adapter for "+z,e.toString(),"sap.ushell.Container");}l.removeItem(s+z);});jQuery.when.apply(jQuery,y).done(w);}if(typeof A.addFurtherRemoteSystems==='function'){A.addFurtherRemoteSystems().always(x);}else{x();}return D.promise();};this.setLogonFrameProvider=function(L){if(this.oFrameLogonManager){this.oFrameLogonManager.setLogonFrameProvider(L);}};this._closeWindow=b;this._redirectWindow=r;this._getRemoteSystems=u;this._suppressOData=v;sap.ui.getCore().getEventBus().subscribe("sap.ushell.Container","addRemoteSystemForServiceUrl",function(e,i,D){t.addRemoteSystemForServiceUrl(D);});if(typeof A.logoutRedirect==='function'){k=function(e){function i(){t._closeWindow();t._redirectWindow();}if(sap.ushell.Container!==t){return;}if(e.key.indexOf(s)===0&&e.newValue&&e.newValue!==l.getItem(e.key)){sap.ushell.utils.localStorageSetItem(e.key,e.newValue);}if(e.key===q){if(e.newValue==="pending"){t._suppressOData();if(E.fireEvent("Logout",true)){i();}else{setTimeout(i,1000);}}}};window.addEventListener('storage',k);}}sap.ushell.bootstrap=function(P,A){var o,e;if(sap.ushell.Container!==undefined){e=new Error("Unified shell container is already initialized - cannot initialize twice.\nStacktrace of first initialization:"+f);jQuery.sap.log.error(e,e.stack,S);throw e;}sap.ushell.Container=null;f=(new Error()).stack;c=jQuery.extend({},true,window["sap-ushell-config"]||{});p=A;if(typeof window["sap.ushell.bootstrap.callback"]==="function"){setTimeout(window["sap.ushell.bootstrap.callback"]);}if(c.modulePaths){Object.keys(c.modulePaths).forEach(function(m){jQuery.sap.registerModulePath(m,c.modulePaths[m]);});}o=h("Container",new sap.ushell.System({alias:"",platform:c.platform||P}));return o.load().done(function(){sap.ushell.Container=new C(o);sap.ushell.Container.getService("PluginManager").registerPlugins(c.bootstrapPlugins);});};}());
