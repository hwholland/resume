// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.services.ClientSideTargetResolution");jQuery.sap.require("sap.ui.generic.app.navigation.service.SelectionVariant");sap.ushell.services.ClientSideTargetResolution=function(A,c,p,S){var h,H,u;var t=[undefined,"GUI","WDA","UI5"];this._ensureInbounds=function(s){var G=A.getInbounds;if(s){var d=new jQuery.Deferred();A.getInbounds(s).done(function(i){d.resolve(i);}).fail(d.reject.bind(d));return d.promise();}if(!h){if(typeof G!=="function"){jQuery.sap.log.error("Cannot get Inbounds","ClientSideTargetResolutionAdapter should implement getInbounds method","sap.ushell.services.ClientSideTargetResolution");return new jQuery.Deferred().reject().promise();}h=new jQuery.Deferred();G.call(A).done(function(i){h.resolve(i);}).fail(h.reject.bind(h));}return h.promise();};this._getURLParsing=function(){if(!u){u=sap.ushell.Container.getService("URLParsing");}return u;};this._addDefaultParameterValues=function(i,s,k,m,d){var I={},D={};Object.keys(i).forEach(function(P){if(P!=="sap-ushell-defaultedParameterNames"){I[P]=i[P];}});if(!s){return I;}Object.keys(s).forEach(function(P){var T=s[P],a,v=false;if(!I[P]&&T.hasOwnProperty("defaultValue")){if(T.defaultValue.format&&T.defaultValue.format==="reference"){a=T.defaultValue.value;if(k.hasOwnProperty(a)){if(typeof k[a]==="string"){I[P]=[k[a]];v=true;}else if(typeof k[a]==="object"){I[P]=k[a];v=true;}}else{I[P]=[T.defaultValue];m.push(T.defaultValue.value);}}else{I[P]=[T.defaultValue.value];v=true;}if(v){D[P]=true;}}});Object.keys(D).sort().forEach(function(P){d.push(P);});return I;};this._matchesFilter=function(v,f,k,m){var F;if(!f){return true;}if(!v&&v!==""){return false;}F=f.value;if(f.format==="reference"){if(/UserDefault\.extended\./.test(F)){jQuery.sap.log.error("Illegal inbound: extended user default '"+F+"' used as filter");return false;}if(k.hasOwnProperty(F)){return v===k[F];}m[F]=true;return true;}if(f.format==="value"||f.format==="plain"||f.format===undefined){return v===f.value;}else if(f.format==="regexp"){return!!v.match("^"+f.value+"$");}else{jQuery.sap.log.error("Illegal oFilter format");return false;}};function g(m){return m.inbound&&m.inbound.resolutionResult&&m.inbound.resolutionResult["sap.ui"]&&m.inbound.resolutionResult["sap.ui"].technology;}this._calculateTechnologyMatch=function(m){var T=m.intentParamsPlusAllDefaults["sap-ui-tech-hint"]&&m.intentParamsPlusAllDefaults["sap-ui-tech-hint"][0];var i=m.defaultedParamNames&&(m.defaultedParamNames.indexOf("sap-ui-tech-hint")>=0);if(T&&g(m)===T){return i?1:2;}return 0;};this._getTechnologyPriority=function(m){var T=g(m);var P=t.indexOf(T);return Math.max(0,P);};this._addSortString=function(m){function a(n){var s="000"+n;return s.substr(s.length-3);}m.priorityString=[m.genericSO?"g":"x","TECM="+this._calculateTechnologyMatch(m),"MTCH="+a(m.countMatchingParams),"MREQ="+a(m.countMatchingRequiredParams),"NFIL="+a(m.countMatchingFilterParams),"NDEF="+a(m.countDefaultedParams),"POT="+a(m.countPotentiallyMatchingParams),"RFRE="+a(999-m.countFreeInboundParams),"TECP="+this._getTechnologyPriority(m)].join(" ");};this._checkAdditionalParameters=function(i,I){var a=false;if(i.signature.additionalParameters==="allowed"||i.signature.additionalParameters==="ignored"){return true;}if(i.signature.additionalParameters==="notallowed"||i.signature.additionalParameters===undefined){a=Object.keys(I).every(function(P){return(!i.signature.parameters[P]&&P.indexOf("sap-")!==0)?false:true;});}else{jQuery.sap.log.error("Unexpected value of inbound for signature.additionalParameters");}return a;};this._addFoundParametersToUserDefaultRefs=function(U,m){U.forEach(function(r){m[r]=true;});};this._extractSapPriority=function(i,m){var s;if(i&&i["sap-priority"]&&i["sap-priority"][0]){s=parseInt(i["sap-priority"][0],10);if(!isNaN(s)){m["sap-priority"]=s;}}return;};this._constructParameterDominatorMap=function(P){var d={},r={};Object.keys(P).forEach(function(k){var R=P[k].renameTo||k;r[R]=r[R]||{"renameTo":R,"dominatedBy":[]};r[R].dominatedBy.push(k);r[R].dominatedBy=r[R].dominatedBy.sort();d[k]=r[R];});return d;};this._removeSpuriousDefaultedValues=function(i,d,P){var o=d.slice(0);o.forEach(function(s,I){var a;var n=P[s].dominatedBy.some(function(k){if(i[k]&&(k!==s)&&d.indexOf(k)===-1){a=k;return true;}return false;});if(n&&(a!==s)){d.splice(I,1);delete i[s];}});return{intentParamsPlusAllDefaults:i,defaultedParamNames:d};};this._matchToInbound=function(i,I,k,m){function n(R,v,D){R.matches=false;R.noMatchReason=v;R.noMatchDebug=D;return R;}function M(R){R.matches=true;return R;}var a=this,o={inbound:I};o.genericSO=(I.semanticObject==="*");if(!(i.semanticObject===undefined||i.semanticObject===I.semanticObject||I.semanticObject==='*')){return n(o,"Semantic object \""+i.semanticObject+"\" did not match");}if(!(i.action===undefined||i.action===I.action)){return n(o,"Action \""+i.action+"\" did not match");}if(I.deviceTypes&&!(i.formFactor===undefined||I.deviceTypes[i.formFactor])){return n(o,"Form factor \""+i.formFactor+"\" did not match","Inbound: ["+Object.keys(I.deviceTypes).filter(function(K){return!!I.deviceTypes[K];}).join(", ")+"]");}var T=i.params&&i.params["sap-ui-tech-hint"]&&i.params["sap-ui-tech-hint"][0];if(i.treatTechHintAsFilter&&T){var s=g({inbound:I});if(s!==T){return n(o,"Tech Hint as filter \""+T+"\" did not match","Inbound: ["+s+"]");}}var U=[],d=[],b=i.params;var e=this._addDefaultParameterValues(b,I.signature&&I.signature.parameters,k,U,d);o.intentParamsPlusAllDefaults=e;o.defaultedParamNames=d;this._extractSapPriority(e,o);var f=0,j=0,l=0,q=0;var r=Object.keys(I.signature.parameters).every(function(P){var v=e[P],V=v&&v[0],w=I.signature.parameters[P],x=b.hasOwnProperty(P);if(w.required&&(V===null||V===undefined)){return false;}if(w.filter){if(!a._matchesFilter(V,w.filter,k,m)){return false;}if(x){++l;}}if(x&&w.required){++j;}if(x){++f;}if(!x&&(V===null||V===undefined)){++q;}var y=a._constructParameterDominatorMap(I.signature.parameters);var R=a._removeSpuriousDefaultedValues(o.intentParamsPlusAllDefaults,o.defaultedParamNames,y);o.intentParmsPlusAllDefaults=R.intentParmsPlusAllDefaults;o.defaultedParamNames=R.defaultedParamNames;return true;});o.countMatchingParams=f;o.countMatchingRequiredParams=j;o.countMatchingFilterParams=l;o.countDefaultedParams=d.length;o.countPotentiallyMatchingParams=Object.keys(i.params).length;o.countFreeInboundParams=q;if(!r){return n(o,"Inbound parameter signature did not match",this._compactSignatureNotation(I.signature));}if(!this._checkAdditionalParameters(I,e)){return n(o,"Additional parameters not allowed",this._compactSignatureNotation(I.signature));}if(I.signature.additionalParameters==="ignored"){this._filterObjectKeys(e,function(K){if(K.indexOf("sap-")===0){return true;}if(I.signature.parameters.hasOwnProperty(K)){return true;}return false;},true);o.countPotentiallyMatchingParams=Object.keys(i.params).filter(function(v){return I.signature.parameters.hasOwnProperty(v);}).length;}this._constructEarlyResolutionResult(o,I);this._addSortString(o);this._addFoundParametersToUserDefaultRefs(U,m);return M(o);};this._filterObjectKeys=function(o,f,i){var O=i?o:jQuery.extend(true,{},o);Object.keys(O).forEach(function(k){if(f(k)===false){delete O[k];}});return O;};this._isFullLocalWDAResolution=function(m){var i=m.inbound,r=i&&i.resolutionResult;if(S&&S.config&&S.config["enableWdaLocalResolution"]===false){return false;}return!(!i||!r||!(r["sap.wda"])||!(r.applicationType==="WDA"));};this._isLocalWDAResolution=function(m){var i=m.inbound,r=i&&i.resolutionResult;if(S&&S.config&&S.config["enableWdaLocalResolution"]===false){return false;}return!(!i||!r||!(r.applicationType==="WDA"));};this._isFullLocalWebguiResolution=function(m){var i=m.inbound,r=i&&i.resolutionResult;if(S&&S.config&&S.config["enableWebguiLocalResolution"]===false){return false;}return!(!i||!r||!(r["sap.gui"])||!(r.applicationType==="TR"));};this._isLocalWebguiNowrapResolution=function(m){var i=m.inbound,r=i&&i.resolutionResult;if(S&&S.config&&S.config["enableWebguiLocalResolution"]===false){return false;}return!(!i||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/~canvas;")>=0)||!(r.url.indexOf("app/transaction/APB_LPD_CALL_")===-1));};this._isLocalWebguiWrapResolution=function(m){var i=m.inbound,r=i&&i.resolutionResult;if(S&&S.config&&S.config["enableWebguiLocalResolution"]===false){return false;}return!(!i||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/~canvas;")>=0)||!(r.url.indexOf("app/transaction/APB_LPD_CALL_")>=0));};this._isLocalNativeWebguiWrapResolution=function(m){var i=m.inbound,r=i&&i.resolutionResult;if(S&&S.config&&S.config["enableNativeWebguiLocalResolution"]===false){return false;}return!(!i||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/its/webgui")>=0)||!(r.url.indexOf("APB_LPD_CALL_")!==-1));};this._isLocalNativeWebguiNowrapResolution=function(m){var i=m.inbound,r=i&&i.resolutionResult;if(S&&S.config&&S.config["enableNativeWebguiLocalResolution"]===false){return false;}return!(!i||!r||!(r.applicationType==="TR")||!(r.url.indexOf("/its/webgui")>=0)||!(r.url.indexOf("APB_LPD_CALL_")===-1));};this._constructEarlyResolutionResult=function(m,i){m.resolutionResult={};if(i&&i.resolutionResult&&i.resolutionResult.hasOwnProperty("sap.platform.runtime")){m.resolutionResult["sap.platform.runtime"]=i.resolutionResult["sap.platform.runtime"];}Object.keys(m.intentParamsPlusAllDefaults).slice(0).forEach(function(n){if(!jQuery.isArray(m.intentParamsPlusAllDefaults[n])){if(!m.resolutionResult.oNewAppStateMembers){m.resolutionResult.oNewAppStateMembers={};}m.resolutionResult.oNewAppStateMembers[n]=m.intentParamsPlusAllDefaults[n];}});};this._hasRenameTo=function(m){return m.inbound&&m.inbound.signature&&m.inbound.signature.parameters&&Object.keys(m.inbound.signature.parameters).some(function(k){return!!(m.inbound.signature.parameters[k].renameTo);});};this._removeUnusedComplexParameterValuesFromDefaultList=function(m){m.defaultedParamNames=m.defaultedParamNames.filter(function(n){if(m.intentParamsPlusAllDefaults[n]&&!jQuery.isArray(m.intentParamsPlusAllDefaults[n])){if(!(m.resolutionResult.oNewAppStateMembers&&m.resolutionResult.oNewAppStateMembers[n])){return false;}}return true;});};this._computeNavigationMode=function(m){var a=["newWindow","embedded","replace"];if(m.intentParamsPlusAllDefaults["sap-ushell-next-navmode"]&&a.indexOf(m.intentParamsPlusAllDefaults["sap-ushell-next-navmode"][0])>=0){m.resolutionResult["sap-ushell-next-navmode"]=m.intentParamsPlusAllDefaults["sap-ushell-next-navmode"][0];}if(m.intentParamsPlusAllDefaults["sap-ushell-navmode"]&&a.indexOf(m.intentParamsPlusAllDefaults["sap-ushell-navmode"][0])>=0){m.resolutionResult.navigationMode=m.intentParamsPlusAllDefaults["sap-ushell-navmode"][0];m.resolutionResult.explicitNavMode=true;}};this._mapDefaultParameterNames=function(m){var P=jQuery.sap.getObject("inbound.signature.parameters",undefined,m)||{},M={};m.defaultedParamNames.forEach(function(n){var N=(P[n]&&P[n].renameTo)||n;if(M[N]){jQuery.sap.log.error("renaming of defaultedParamNames creates duplicates"+n+"->"+N);}else{M[N]=true;}});m.mappedDefaultedParamNames=Object.keys(M).sort();};this._mixAppStateIntoResolutionResultAndRename=function(m,a){var d=new jQuery.Deferred(),b=this,n,s,o;function e(T){b._removeUnusedComplexParameterValuesFromDefaultList(T);b._mapDefaultParameterNames(T);b._computeNavigationMode(T);delete T.resolutionResult.oNewAppStateMembers;d.resolve(T);}function f(m){return(m.resolutionResult.oNewAppStateMembers&&!jQuery.isEmptyObject(m.resolutionResult.oNewAppStateMembers));}function i(l,P){return jQuery.isArray(l)&&l.some(function(q){return(P.indexOf(q)!==-1);});}function j(l,P){var q,v,w;if(l&&l.selectionVariant){q=new sap.ui.generic.app.navigation.service.SelectionVariant(JSON.stringify(l.selectionVariant));w=q.getSelectOptionsPropertyNames()||[];v=q.getParameterNames()||[];if(i(w,P)||i(v,P)){return true;}}return false;}function r(l,q,P){var v=new sap.ui.generic.app.navigation.service.SelectionVariant(),w=l.getParameterNames()||[],x=l.getSelectOptionsPropertyNames()||[],y,z;w.forEach(function(B){y=l.getParameter(B);if(P[B]&&P[B].renameTo){if((v.getParameter(P[B].renameTo)===undefined)&&(v.getSelectOption(P[B].renameTo)===undefined)){v.addParameter(P[B].renameTo,y);q.changed=true;}else{jQuery.sap.log.error("renaming of appstate creates duplicates "+B+"->"+P[B].renameTo);}}else{if((v.getParameter(B)===undefined)&&(v.getSelectOption(B)===undefined)){v.addParameter(B,y);}}});x.forEach(function(B){z=l.getSelectOption(B);if(P[B]&&P[B].renameTo){if((v.getSelectOption(P[B].renameTo)===undefined)&&(v.getParameter(P[B].renameTo)===undefined)){v.massAddSelectOption(P[B].renameTo,z);q.changed=true;}else{jQuery.sap.log.error("renaming of appstate creates duplicates "+B+"->"+P[B].renameTo);}}else{if((v.getSelectOption(B)===undefined)&&(v.getParameter(B)===undefined)){v.massAddSelectOption(B,z);}}});w.forEach(function(B){l.removeParameter(B);});x.forEach(function(B){l.removeSelectOption(B);});v.getParameterNames().forEach(function(B){l.addParameter(B,v.getParameter(B));});v.getSelectOptionsPropertyNames().forEach(function(B){l.massAddSelectOption(B,v.getSelectOption(B));});return l;}function R(l,q,P){return r(l,q,P);}function k(D){if(D===undefined||jQuery.isPlainObject(D)){return false;}return true;}function M(N){var l=N.getData()||{},q,C={};if(l.selectionVariant){q=new sap.ui.generic.app.navigation.service.SelectionVariant(JSON.stringify(l.selectionVariant));}else{q=new sap.ui.generic.app.navigation.service.SelectionVariant();}if(f(m)){Object.keys(m.resolutionResult.oNewAppStateMembers).forEach(function(v){q.massAddSelectOption(v,m.resolutionResult.oNewAppStateMembers[v].Ranges);});}q=R(q,C,m.inbound.signature.parameters);if(q.getParameterNames().length!==0||q.getSelectOptionsPropertyNames().length!==0){l.selectionVariant=q.toJSONObject();}if(!C.changed&&!f(m)){e(m);return;}N.setData(l);N.save().done(function(){m.intentParamsPlusAllDefaults["sap-xapp-state"]=[N.getKey()];m.mappedIntentParamsPlusSimpleDefaults["sap-xapp-state"]=[N.getKey()];e(m);});}if(!f(m)&&!b._hasRenameTo(m)){e(m);}else{s=m.intentParamsPlusAllDefaults["sap-xapp-state"]&&m.intentParamsPlusAllDefaults["sap-xapp-state"][0];if(s){a.getAppState(s).done(function(l){var P=b._constructParameterDominatorMap(m.inbound.signature.parameters);o=l.getData();if(k(o)){delete m.resolutionResult.oNewAppStateMembers;e(m);}if(m.resolutionResult.oNewAppStateMembers){Object.keys(m.resolutionResult.oNewAppStateMembers).forEach(function(q){var D=P[q].dominatedBy;if(j(o,D)){delete m.resolutionResult.oNewAppStateMembers[q];}});}if(!f(m)&&!b._hasRenameTo(m)){e(m);}else{n=a.createEmptyAppState(undefined,true);if(n){n.setData(l.getData());M(n);}}});}else if(f(m)){M(a.createEmptyAppState(undefined,true));}else{e(m);}}return d.promise();};this._extractInboundFilter=function(o){if(!A.hasSegmentedAccess){return undefined;}if(typeof o!=="string"){return undefined;}var f=o.indexOf("#")===0?o:"#"+o;var s=this._getURLParsing().parseShellHash(f);if(!s||!s.semanticObject||!s.action){return undefined;}return[{semanticObject:s.semanticObject,action:s.action}];};this.resolveHashFragment=function(s){var a=this,d=new jQuery.Deferred(),b=A.resolveHashFragmentFallback&&A.resolveHashFragmentFallback.bind(A),e=this._extractInboundFilter(s);this._ensureInbounds(e).done(function(i){a._resolveHashFragment(s,b,i).done(d.resolve.bind(d)).fail(d.reject.bind(d));}).fail(d.reject.bind(d));return d.promise();};this.resolveTileIntent=function(s){var a=this,d=new jQuery.Deferred(),b=this._extractInboundFilter(s);this._ensureInbounds(b).done(function(i){a._resolveTileIntent(s,undefined,i).done(d.resolve.bind(d)).fail(d.reject.bind(d));}).fail(d.reject.bind(d));return d.promise();};this._resolveHashFragment=function(s,b,i){var U=this._getURLParsing(),a=this,d=new jQuery.Deferred(),f=s.indexOf("#")===0?s:"#"+s,o=U.parseShellHash(f);if(o===undefined){jQuery.sap.log.error("Could not parse shell hash '"+s+"'","please specify a valid shell hash","sap.ushell.services.ClientSideTargetResolution");return d.reject().promise();}o.formFactor=sap.ushell.utils.getFormFactor();this._getMatchingInbounds(o,i).fail(function(e){jQuery.sap.log.error("Could not resolve "+s,"_getMatchingInbounds promise rejected with: "+e,"sap.ushell.services.ClientSideTargetResolution");d.reject(e);}).done(function(m){var M;if(m.length===0){jQuery.sap.log.warning("Could not resolve "+s,"rejecting promise","sap.ushell.services.ClientSideTargetResolution");d.reject("Could not resolve navigation target");return;}M=m[0];a._resolveSingleMatchingTarget(M,b,f).done(d.resolve.bind(d)).fail(d.reject.bind(d));});return d.promise();};this._resolveEasyAccessMenuIntent=function(i,m){var e="Intent must be either #Shell-startGUI or #Shell-startWDA";if(i.action==="startGUI"){return this._resolveEasyAccessMenuIntentWebgui(i,m);}if(i.action==="startWDA"){return this._resolveEasyAccessMenuIntentWDA(i,m);}return new jQuery.Deferred().reject("The easy access menu intent "+i.semanticObject+"-"+i.action+" could not be resolved: "+e).promise();};this._resolveEasyAccessMenuIntentWDA=function(i,m){var d=new jQuery.Deferred(),U,o,a=this,b={};U="/ui2/nwbc/~canvas;window=app/wda/"+i.params["sap-ui2-wd-app-id"][0]+"/";jQuery.each(i.params,function(e,v){if(e==="sap-ui2-wd-app-id"||e==="sap-system"){return;}if(e==="sap-ui2-wd-conf-id"){b["sap-wd-configId"]=v;return;}b[e]=v;});if(b){U=U+"?"+a._getURLParsing().paramsToString(b);}o=new URI(U);this._spliceSapSystemIntoURI(o,"",i.params["sap-system"][0],"WDA").done(function(o){var r={url:o.toString(),applicationType:"NWBC",text:i.params["sap-ui2-wd-app-id"][0],additionalInformation:"","sap-system":i.params["sap-system"][0]};if(m&&m.inbound&&m.inbound.resolutionResult&&m.inbound.resolutionResult["sap.platform.runtime"]){r["sap.platform.runtime"]=m.inbound.resolutionResult["sap.platform.runtime"];}d.resolve(r);}).fail(d.reject.bind(d));return d.promise();};this._resolveEasyAccessMenuIntentWebgui=function(i,m){var d=new jQuery.Deferred(),U,o;U="/sap/bc/gui/sap/its/webgui?%7etransaction="+i.params["sap-ui2-tcode"][0]+"&%7enosplash=1";o=new URI(U);this._spliceSapSystemIntoURI(o,"",i.params["sap-system"][0],"NATIVEWEBGUI").done(function(o){var r={url:o.toString(),applicationType:"TR",text:i.params["sap-ui2-tcode"][0],additionalInformation:"","sap-system":i.params["sap-system"][0]};if(m&&m.inbound&&m.inbound.resolutionResult&&m.inbound.resolutionResult["sap.platform.runtime"]){r["sap.platform.runtime"]=m.inbound.resolutionResult["sap.platform.runtime"];}d.resolve(r);}).fail(d.reject.bind(d));return d.promise();};this._resolveSingleMatchingTarget=function(m,b,f){var a=this,d=new jQuery.Deferred(),U=this._getURLParsing(),i=U.parseShellHash(f);if(i.semanticObject==="Shell"&&(i.action==="startWDA"||i.action==="startGUI")){return this._resolveEasyAccessMenuIntent(i,m);}this._mapParameterNamesAndRemoveObjects(m);this._mixAppStateIntoResolutionResultAndRename(m,sap.ushell.Container.getService("AppState")).done(function(m){var B=a._determineResultProcessor(m);B(m,b,f).done(function(m){d.resolve(m.resolutionResult);}).fail(function(M){if(M.indexOf("fallback:")>=0){a._constructFallbackResolutionResult.call(this,m,b,f).fail(d.reject.bind(d)).done(function(m){d.resolve(m.resolutionResult);});}else{d.reject(M);}});});return d.promise();};this._resolveTileIntent=function(s,b,i){var U=this._getURLParsing(),a=this,d=new jQuery.Deferred(),f=s.indexOf("#")===0?s:"#"+s,o=U.parseShellHash(f);if(o===undefined){jQuery.sap.log.error("Could not parse shell hash '"+s+"'","please specify a valid shell hash","sap.ushell.services.ClientSideTargetResolution");return d.reject("Cannot parse shell hash").promise();}o.formFactor=sap.ushell.utils.getFormFactor();this._getMatchingInbounds(o,i).fail(function(e){jQuery.sap.log.error("Could not resolve "+s,"_getMatchingInbounds promise rejected with: "+e,"sap.ushell.services.ClientSideTargetResolution");d.reject(e);}).done(function(m){var M;if(m.length===0){jQuery.sap.log.warning("Could not resolve "+s,"no matching targets were found","sap.ushell.services.ClientSideTargetResolution");d.reject("No matching targets found");return;}M=m[0];a._resolveSingleMatchingTileIntent(M,b,f).done(d.resolve.bind(d)).fail(d.reject.bind(d));});return d.promise();};this._resolveSingleMatchingTileIntent=function(m,b,f){var d=new jQuery.Deferred();d.resolve(m.inbound.tileResolutionResult);return d.promise();};this._determineResultProcessor=function(m){var i=m.inbound,r=i&&i.resolutionResult;function l(P,R){jQuery.sap.log.debug("Resolution result will be constructed via "+P+" processor",R,"sap.ushell.services.ClientSideTargetResolution");}if(!i||!r){l("FALLBACK","the inbound or the inbound resolutionResult member was not available");return this._constructFallbackResolutionResult.bind(this);}if(r.applicationType==="SAPUI5"){l("SAPUI5","inbound resolutionResult had SAPUI5 applicationType");return this._constructSAPUI5ResolutionResult.bind(this);}var a=this._isFullLocalWDAResolution(m);if(a){l("WDA full url construction");return this._constructFullWDAResolutionResult.bind(this);}var b=this._isLocalWDAResolution(m);if(b){l("WDA");return this._constructWDAResolutionResult.bind(this);}var d=this._isFullLocalWebguiResolution(m);if(d){l("NON-WRAPPED WEBGUI full url construction");return this._constructFullWebguiResolutionResult.bind(this);}var e=this._isLocalWebguiNowrapResolution(m);if(e){l("NON-WRAPPED WEBGUI");return this._constructWebguiNowrapResult.bind(this);}var f=this._isLocalWebguiWrapResolution(m);if(f){l("WRAPPED WEBGUI");return this._constructWebguiWrapResult.bind(this);}var j=this._isLocalNativeWebguiNowrapResolution(m);if(j){l("NATIVE NON-WRAPPED WEBGUI");return this._constructNativeWebguiNowrapResult.bind(this);}var k=this._isLocalNativeWebguiWrapResolution(m);if(k){l("NATIVE WRAPPED WEBGUI");return this._constructNativeWebguiWrapResult.bind(this);}if(r.applicationType==="URL"){l("URL","inbound resolutionResult had URL applicationType");return this._constructURLResolutionResult.bind(this);}l("FALLBACK","could not apply any result processor to inbound resolutionResult: "+JSON.stringify(r,null,"   "));return this._constructFallbackResolutionResult.bind(this);};this._stripURI=function(U,s,a){var d=new jQuery.Deferred(),b=this;if(typeof s==="undefined"){this._stripURIWithSystemAlias(U,s,a,undefined).fail(function(e){d.reject(e);}).done(function(n){d.resolve(n);});return d.promise();}A.resolveSystemAlias(s).fail(function(e){d.reject(e);}).done(function(r){b._stripURIWithSystemAlias(U,s,a,r).fail(function(e){d.reject(e);}).done(function(n){d.resolve(n);});});return d.promise();};this._stripURIWithSystemAlias=function(U,s,a,r){var b=this,o,d,T,e,D=new jQuery.Deferred(),P=new jQuery.Deferred();U.protocol("");U.hostname("");U.port("");b._removeParametersFromURI(U,["sap-client","sap-language"]);if(!jQuery.isPlainObject(r)||typeof s!=="string"){return D.resolve(U).promise();}d=b._selectSystemAliasDataName(r,new URI(window.location.toString()).protocol());o=r[d];e=(typeof o.pathPrefix==="string")&&o.pathPrefix;if(e!==""){P.resolve(e);}else{A.resolveSystemAlias("").fail(function(E){D.reject(E);}).done(function(R){var f=R[d];P.resolve(f.pathPrefix);});}P.fail(function(E){D.reject(E);}).done(function(e){if(e&&e.length>0){T=U.path();T=T.replace(e,"");if(T.indexOf("/")!==0){T="/"+T;}U.path(T);}if(a==="NATIVEWEBGUI"&&r.hasOwnProperty("rfc")){T=U.path();T=T.split(";").filter(function(f){return f.indexOf("~sysid=")!==0&&f.indexOf("~service=")!==0&&f.indexOf("~loginGroup=")!==0&&f.indexOf("~messageServer=")!==0&&f.indexOf("~sncNameR3=")!==0&&f.indexOf("~sncQoPR3=")!==0;}).join(";");U.path(T);}D.resolve(U);});return D.promise();};this._removeParametersFromURI=function(U,P){var b={},T;P.forEach(function(s){b[s]=true;});T=U.query();T=T.split("&").filter(function(s){var a=(s.split("=")[0]||"").toLowerCase();return!b.hasOwnProperty(a);}).join("&");U.query(T);};this._spliceSapSystemIntoUrlURI=function(U,s,a){var b=this,d=new jQuery.Deferred();if(typeof a==="undefined"||s===a){return d.resolve(U).promise();}if(s===""||typeof s==="undefined"){if(this._isAbsoluteURI(U)){return d.resolve(U);}b._applyAliasToURI(a,U,"URL").fail(function(e){d.reject(e);}).done(function(o){d.resolve(o);});return d.promise();}if(typeof A.resolveSystemAlias!=="function"){return d.reject("fallback: the adapter does not implement resolveSystemAlias").promise();}A.resolveSystemAlias(s).fail(function(e){d.reject(e);}).done(function(r){var e=b._selectSystemAliasDataName(r,new URI(window.location.toString()).protocol()),o=r[e],D;if((U.protocol()||"").toLowerCase()===e&&(U.hostname()||"")===o.host&&(U.path().indexOf(o.pathPrefix)===0)){U.protocol("");U.hostname("");D=U.path().replace(o.pathPrefix,"");U.path(D);b._removeParametersFromURI(U,["sap-language","sap-client"]);b._applyAliasToURI(a,U,"URL").fail(function(E){d.reject(E);}).done(function(f){d.resolve(f);});}else{d.resolve(U);}});return d.promise();};this._spliceSapSystemIntoURI=function(U,s,a,b){var d=new jQuery.Deferred(),e=this;if(b==="URL"){return this._spliceSapSystemIntoUrlURI(U,s,a);}if(typeof a==="undefined"||s===a){return d.resolve(U).promise();}if(typeof A.resolveSystemAlias!=="function"){return d.reject("fallback: the adapter does not implement resolveSystemAlias").promise();}this._stripURI(U,s,b).fail(function(E){d.reject(E);}).done(function(o){e._applyAliasToURI(a,o,b).fail(function(E){d.reject(E);}).done(function(i){d.resolve(i);});});return d.promise();};this._applyAliasToURI=function(s,U,a){var b=this,n=U,d=new jQuery.Deferred();A.resolveSystemAlias(s).fail(function(e){d.reject(e);}).done(function(r){var e=b._selectSystemAliasDataName(r,new URI(window.location.toString()).protocol()),o=r[e],q,l,f;n.protocol(e);n.hostname(o.host);n.port(o.port);b._interpolatePathPrefixIntoURI(n,a,o.pathPrefix).fail(function(E){d.reject(E);}).done(function(n){q=n.query();if(typeof r.client==="string"&&r.client!==""){q=q+(q.length>0?"&":"")+"sap-client="+r.client;}if(typeof r.language==="string"&&r.language!==""){l=r.language;}else{f=sap.ushell.Container.getUser();if(!f){jQuery.sap.log.error("Cannot retieve the User object via sap.ushell.Container while determining sap-language","will default to 'en' language","sap.ushell.services.ClientSideTargetResolution");l="en";}else{l=f.getLanguage();}}q=q+(q.length>0?"&":"")+"sap-language="+l;n.query(q);n=b._interpolateNativeWebguiDataIntoURI(r,n,a);d.resolve(n);});});return d.promise();};this._interpolateNativeWebguiDataIntoURI=function(s,U,a){var i,T,b,P;if(s.hasOwnProperty("rfc")&&a==="NATIVEWEBGUI"){b=s.rfc;i=!!b.systemId;if(i){T=[b.systemId&&("~sysid="+b.systemId),b.loginGroup&&("~loginGroup="+b.loginGroup),b.sncNameR3&&("~messageServer="+encodeURIComponent(b.sncNameR3)),b.sncNameR3&&("~sncNameR3="+encodeURIComponent(b.sncNameR3)),b.sncQoPR3&&("~sncQoPR3="+b.sncQoPR3)].filter(function(o){return(typeof o==="string")&&(o!=="");});}else{T=[b.service&&("~service="+b.service),b.sncNameR3&&("~sncNameR3="+encodeURIComponent(b.sncNameR3)),b.sncQoPR3&&("~sncQoPR3="+b.sncQoPR3)].filter(function(o){return(typeof o==="string")&&(o!=="");});}P=U.path()+";"+T.join(";").replace(/(%[A-F0-9]{2})/g,function(e){return e.toLowerCase();});U.path(P);U._parts.path=P;}return U;};this._interpolatePathPrefixIntoURI=function(U,s,P){var a=this,d=new jQuery.Deferred(),T;if(s==="URL"&&P.length===0){return d.resolve(U).promise();}function b(e){var r=e+U.path();U.path(r.replace(/\/+/g,"/"));d.resolve(U);}if(P.length>0){if((s==="WDA"||s==="WEBGUI")&&U.path().indexOf("~canvas")>=0){T=U.path();T="/~canvas"+T.split("~canvas")[1];U.path(T);}b(P);}else{A.resolveSystemAlias("").fail(function(e){d.reject(e);}).done(function(r){var e=a._selectSystemAliasDataName(r,new URI(window.location.toString()).protocol()),f=r[e].pathPrefix;b(f);});}return d.promise();};this._selectSystemAliasDataName=function(s,b){if(s.hasOwnProperty("https")){return"https";}if(s.hasOwnProperty("http")){return"http";}jQuery.sap.log.error("Cannot select which system alias to pick between http/https","make sure they are provided in the given system alias collection","sap.ushell.services.ClientSideTargetResolution");return undefined;};this._getRenameParameterName=function(P,s,a){if(!a||!jQuery.isArray(a)){return P;}if(s&&s.parameters&&s.parameters[P]&&s.parameters[P].renameTo){return s.parameters[P].renameTo;}return P;};this._mapParameterNamesAndRemoveObjects=function(m){var a=this,n={},o=m.intentParamsPlusAllDefaults;Object.keys(o).sort().forEach(function(P){var r=a._getRenameParameterName(P,m.inbound.signature,o[P]);if(jQuery.isArray(m.intentParamsPlusAllDefaults[P])){if(n[r]){jQuery.sap.log.error("collision of values during parameter mapping : \""+P+"\" -> \""+r+"\"");}else{n[r]=m.intentParamsPlusAllDefaults[P];}}});m.mappedIntentParamsPlusSimpleDefaults=n;};this._constructFullWDAResolutionResult=function(m,b,f){var d=this,i=m.inbound,r=i&&i.resolutionResult,D=new jQuery.Deferred();var I={target:{"semanticObject":"Shell","action":"startWDA"},"params":{"sap-ui2-wd-app-id":[i.resolutionResult["sap.wda"].applicationId],"sap-system":[r.systemAlias]}};if(i.resolutionResult["sap.wda"].configId){I.params["sap-ui2-wd-conf-id"]=[i.resolutionResult["sap.wda"].configId];}this._resolveEasyAccessMenuIntentWDA(I,m).done(function(C){r.url=C.url;return d._constructWDAResolutionResult(m,b,f).done(function(a){D.resolve(a);}).fail(function(M){D.reject(M);});});return D.promise();};this._constructFullWebguiResolutionResult=function(m,b,f){var d=this,i=m.inbound,r=i&&i.resolutionResult,D=new jQuery.Deferred();var I={target:{"semanticObject":"Shell","action":"startGUI"},"params":{"sap-ui2-tcode":[i.resolutionResult["sap.gui"].transaction],"sap-system":[r.systemAlias]}};this._resolveEasyAccessMenuIntentWebgui(I,m).done(function(C){r.url=C.url;return d._constructWebguiNowrapResult(m,b,f).done(function(a){D.resolve(a);}).fail(function(M){D.reject(M);});});return D.promise();};this._constructWDAResolutionResult=function(m,b,f){var a=this,i=m.inbound,r=i&&i.resolutionResult,d=new jQuery.Deferred();var w=new URI(r.url);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);if(m.mappedDefaultedParamNames.length>0){e["sap-ushell-defaultedParameterNames"]=[JSON.stringify(m.mappedDefaultedParamNames)];}var s=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=s;delete e["sap-system"];a._spliceSapSystemIntoURI(w,r.systemAlias,s,"WDA").fail(d.reject.bind(d)).done(function(w){sap.ushell.Container.getService("ShellNavigation").compactParams(e,["sap-xapp-state","sap-ushell-defaultedParameterNames","sap-intent-params"],undefined,true).fail(d.reject.bind(d)).done(function(E){var j=a._getURLParsing().paramsToString(E);var P=w.search();if(j){P=P+((P.indexOf("?")<0)?"?":"&")+j;}w.search(P);["additionalInformation","applicationDependencies"].forEach(function(k){if(i.resolutionResult.hasOwnProperty(k)){m.resolutionResult[k]=i.resolutionResult[k];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=i.title;m.resolutionResult.applicationType="NWBC";d.resolve(m);});});return d.promise();};this._constructWebguiNowrapResult=function(m,b,f){var a=this,i=m.inbound,r=i&&i.resolutionResult,d=new jQuery.Deferred();var w=new URI(r.url);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var s=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=s;delete e["sap-system"];a._spliceSapSystemIntoURI(w,r.systemAlias,s,"WEBGUI").fail(d.reject.bind(d)).done(function(w){var E=a._getURLParsing().paramsToString(e);var P=w.search();if(E){P=P+((P.indexOf("?")<0)?"?":"&")+E;}w.search(P);["additionalInformation","applicationDependencies"].forEach(function(j){if(i.resolutionResult.hasOwnProperty(j)){m.resolutionResult[j]=i.resolutionResult[j];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=i.title;m.resolutionResult.applicationType="NWBC";d.resolve(m);});return d.promise();};this._constructWebguiWrapResult=function(m,b,f){var a=this,i=m.inbound,r=i&&i.resolutionResult,d=new jQuery.Deferred();var w=new URI(r.url);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var s=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=s;delete e["sap-system"];a._spliceSapSystemIntoURI(w,r.systemAlias,s,"WEBGUI").fail(d.reject.bind(d)).done(function(w){var P=w.search();P=a._injectEffectiveParametersIntoWebguiPobjectParam(P,e,"&","=");w.search(P);["additionalInformation","applicationDependencies"].forEach(function(j){if(i.resolutionResult.hasOwnProperty(j)){m.resolutionResult[j]=i.resolutionResult[j];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=i.title;m.resolutionResult.applicationType="NWBC";d.resolve(m);});return d.promise();};this._injectEffectiveParametersIntoWebguiPobjectParam=function(q,P,Q,s){var i,a="P_OBJECT"+s,m=132;var b=this._getURLParsing().privparamsToString(P,"%25","%21");if(!b){return q;}var d="";this._amendGuiParam("P_OBJECT",q,Q,s,function(f){var j=f.replace(a,"");d=decodeURIComponent(j);if(d.length>0){d=d+"%25";}return a;});b=d+b;var o={pObjX:"",pObject:""};b.match(new RegExp(".{1,"+m+"}","g")).map(function(f){return encodeURIComponent(f);}).forEach(function(f,G){var j="P_OBJECT";var k="pObject";if(G>0){j="P_OBJ"+G;k="pObjX";}var l=o[k].length===0?"":Q;o[k]=o[k]+l+j+s+f;});i=[o.pObjX,o.pObject].filter(function(f){return f.length>0;}).join(Q);var e=this._amendGuiParam("P_OBJECT",q,Q,s,function(f){return i;});if(e.found){return e.query;}return q+(q.length===0?"":Q)+i;};this._amendGuiParam=function(T,q,Q,s,a){var f=false,P=T+s;var b=q.split(Q).map(function(d){if(d.indexOf(P)!==0){return d;}f=true;return a(d);}).filter(function(d){return typeof d!=="undefined";}).join(Q);return{found:f,query:b};};this._parseWebguiTransactionQueryParam=function(T){var s="^(.+?)(%20|(%20)(.+))?$",r=new RegExp(s,"i"),a,P={hasParameters:null,transactionParamName:"",transactionCode:"",parameters:[]};var b=T.split("=");if(b.length>2){return{"error":"Found more than one assignment ('=') in the transaction query parameter","details":"Only one '=' sign is expected in "+T};}if(b.length<2||typeof b[1]==="undefined"||b[1].length===0){return{"error":"The transaction query parameter must specify at least the transaction name","details":"Got "+T+" instead."};}P.transactionParamName=b[0];a=b[1];var m=a.match(r);if(!m){return{"error":"Cannot parse ~transaction query parameter value.","details":a+" should match /"+s+"/"};}P.transactionCode=m[1];if(m[2]&&m[2]!=="%20"){var d=m[4]||"";d.split("%3b").forEach(function(n){var N=n.split("%3d"),e=N[0];if(e&&typeof e==="string"&&e.length>0){P.parameters.push({name:e,value:N[1]});}});}P.hasParameters=false;if(P.parameters.length>0){P.hasParameters=true;P.transactionCode=P.transactionCode.replace(/^[*]/,"");}return P;};this._injectEffectiveParametersIntoWebguiQueryParam=function(T,P){var o=this._parseWebguiTransactionQueryParam(T);if(o.error){jQuery.sap.log.error(o.error,o.details,"sap.ushell.services.ClientSideTargetResolution");return T;}var a=o.parameters.map(function(e){return e.name.toUpperCase()+"%3d"+e.value;});var b={};Object.keys(P).forEach(function(k){b[k.toUpperCase()]=P[k];});var s=this._getURLParsing().privparamsToString(b,"%3b","%3d");if(s){a.push(s);}var d=a.length>0;return o.transactionParamName+"="+(d?"*":"")+o.transactionCode+(d?"%20":"")+a.join("%3b");};this._constructNativeWebguiWrapResult=function(m,b,f){var a=this,i=m.inbound,r=i&&i.resolutionResult,d=new jQuery.Deferred();var w=new URI(r.url);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var s=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=s;delete e["sap-system"];a._spliceSapSystemIntoURI(w,r.systemAlias,s,"NATIVEWEBGUI").fail(d.reject.bind(d)).done(function(w){var P=w.search();var j=P.split("&").map(function(q){var I;if(q.indexOf("?%7etransaction")===0||q.indexOf("%7etransaction")===0){I=a._injectEffectiveParametersIntoWebguiPobjectParam(q,e,"%3b","%3d");return I;}return q;}).join("&");w.search(j);["additionalInformation","applicationDependencies"].forEach(function(k){if(i.resolutionResult.hasOwnProperty(k)){m.resolutionResult[k]=i.resolutionResult[k];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=i.title;m.resolutionResult.applicationType="TR";d.resolve(m);});return d.promise();};this._isWebguiBusinessParameter=function(n,v){var N;if(arguments.length===1){N=n.split(/[=](.+)?/);if(N.length>1){return this._isWebguiBusinessParameter.apply(this,N);}}return!(n.indexOf("sap-")===0||n.charAt(0)==="~");};this._extractWebguiNonBusinessParameters=function(P){var a=this,n={};Object.keys(P).forEach(function(s){var b=P[s];if(!a._isWebguiBusinessParameter(s,b)){n[s]=b;delete P[s];}});return n;};this._constructNativeWebguiNowrapResult=function(m,b,f){var a=this,i=m.inbound,r=i&&i.resolutionResult,d=new jQuery.Deferred(),F={"sap-wd-run-sc":true,"sap-wd-auto-detect":true,"sap-ep-version":true,"sap-system":true};var w=new URI(r.url);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var s=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=s;Object.keys(e).forEach(function(P){if(F[P.toLowerCase()]){delete e[P];}});var E=this._extractWebguiNonBusinessParameters(e);a._spliceSapSystemIntoURI(w,r.systemAlias,s,"NATIVEWEBGUI").fail(d.reject.bind(d)).done(function(w){var P=w.search();var j=P.split("&").map(function(q){var n;if(!a._isWebguiBusinessParameter(q)){if(q.indexOf("=")>=0){n=q.split("=");if(!E.hasOwnProperty(n[0])){E[n[0]]=n[1];}}else{jQuery.sap.log.error("Found no '=' separator of Webgui non-business parameter. Parameter will be skipped.","'"+q+"'","sap.ushell.services.ClientSideTargetResolution");}return undefined;}var I;if(q.indexOf("?%7etransaction")===0||q.indexOf("%7etransaction")===0){I=a._injectEffectiveParametersIntoWebguiQueryParam(q,e,"%3b","%3d");return I;}return q;}).filter(function(l){return typeof l!=="undefined";}).join("&");var k=a._getURLParsing().paramsToString(E);j=[j,k.replace("~","%7e")].join("&");w.search(j);["additionalInformation","applicationDependencies","sap.platform.runtime"].forEach(function(l){if(i.resolutionResult.hasOwnProperty(l)){m.resolutionResult[l]=i.resolutionResult[l];}});m.resolutionResult.url=w.toString();m.resolutionResult.text=i.title;m.resolutionResult.applicationType="TR";d.resolve(m);});return d.promise();};this._constructSAPUI5ResolutionResult=function(m,b,f){var i=m.inbound,d=new jQuery.Deferred(),U,s,e;["applicationType","additionalInformation","url","applicationDependencies"].forEach(function(P){if(i.resolutionResult.hasOwnProperty(P)){m.resolutionResult[P]=i.resolutionResult[P];}});e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);if(m.mappedDefaultedParamNames.length>0){e["sap-ushell-defaultedParameterNames"]=[JSON.stringify(m.mappedDefaultedParamNames)];}s=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=s;U=this._getURLParsing().paramsToString(e);if(U){m.resolutionResult.url=i.resolutionResult.url+((i.resolutionResult.url.indexOf("?")<0)?"?":"&")+U;}if(typeof i.resolutionResult.ui5ComponentName!=="undefined"){m.resolutionResult.ui5ComponentName=i.resolutionResult.ui5ComponentName;}m.resolutionResult.text=i.title;d.resolve(m);return d.promise();};this._isAbsoluteURI=function(U){return(U.protocol()||"").length>0;};this._constructURLResolutionResult=function(m,b,f){var a=this,i=m.inbound,r=i&&i.resolutionResult,d=new jQuery.Deferred();var U=new URI(r.url);var e=jQuery.extend(true,{},m.mappedIntentParamsPlusSimpleDefaults);var s=e["sap-system"]&&e["sap-system"][0];m.resolutionResult["sap-system"]=s;delete e["sap-system"];a._spliceSapSystemIntoURI(U,r.systemAlias,s,"URL").fail(d.reject.bind(d)).done(function(o){var j=o.toString(),k,F,l;l=a._getURLParsing().paramsToString(e);if(l){if(o.fragment()){F="#"+o.fragment();k=j.replace(/#.*/,"");}else{k=j;F="";}j=k+((j.indexOf("?")<0)?"?":"&")+l+F;}["additionalInformation","applicationDependencies"].forEach(function(P){if(i.resolutionResult.hasOwnProperty(P)){m.resolutionResult[P]=i.resolutionResult[P];}});m.resolutionResult.url=j;m.resolutionResult.text=i.title;m.resolutionResult.applicationType="URL";d.resolve(m);});return d.promise();};this._constructFallbackResolutionResult=function(m,b,f){var d=new jQuery.Deferred(),e={},D;Object.keys(m.intentParamsPlusAllDefaults).forEach(function(P){if(jQuery.isArray(m.intentParamsPlusAllDefaults[P])){e[P]=m.intentParamsPlusAllDefaults[P];}});D=m.mappedDefaultedParamNames||m.defaultedParamNames;if(D.length>0){e["sap-ushell-defaultedParameterNames"]=[JSON.stringify(D)];}if(typeof b!=="function"){jQuery.sap.log.error("Cannot resolve hash fragment",f+" has matched an inbound that cannot be resolved client side"+" and no resolveHashFragmentFallback method was implemented in ClientSideTargetResolutionAdapter","sap.ushell.services.ClientSideTargetResolution");d.reject("Cannot resolve hash fragment: no fallback provided.");return d.promise();}jQuery.sap.log.warning("Cannot resolve hash fragment client side",f+" has matched an inbound that cannot be resolved client side. Using fallback logic","sap.ushell.services.ClientSideTargetResolution");b(f,jQuery.extend(true,{},m.inbound),e).done(function(r){["applicationType","additionalInformation","url","applicationDependencies","text"].forEach(function(P){if(r.hasOwnProperty(P)){m.resolutionResult[P]=r[P];}});d.resolve(m);}).fail(d.reject.bind(d));return d.promise();};this.getDistinctSemanticObjects=function(){var d=new jQuery.Deferred();this._ensureInbounds().done(function(i){var s={};i.forEach(function(I){if(typeof I.semanticObject==="string"&&I.semanticObject!=="*"&&I.semanticObject.length>0){s[I.semanticObject]=true;}});d.resolve(Object.keys(s).sort());}).fail(function(e){d.reject(e);});return d.promise();};this.getLinks=function(a){var b=this,s,P,i,d=new jQuery.Deferred(),C;if(arguments.length===1&&jQuery.isPlainObject(arguments[0])){var a=arguments[0];C=jQuery.extend(true,{},a);["action","semanticObject"].forEach(function(e){if(a.hasOwnProperty(e)){C[e]=a[e];}});if(C.appStateKey){C.params=C.params||{};C.params["sap-xapp-state"]=[C.appStateKey];delete C.appStateKey;}}else if(arguments.length<=3){jQuery.sap.log.warning("Passing positional arguments to getLinks is deprecated","Please use nominal arguments instead","sap.ushell.services.ClientSideTargetResolution");s=arguments[0];P=arguments[1];i=arguments[2];C={semanticObject:s,params:P,ignoreFormFactor:i};}else{return d.reject("invalid arguments for getLinks").promise();}this._ensureInbounds().done(function(I){b._getLinks(C,I).done(d.resolve.bind(d)).fail(d.reject.bind(d));}).fail(d.reject.bind(d));return d.promise();};this._validateGetSemanticObjectLinksArgs=function(a){var s=a.semanticObject,b=a.action,i=!a.hasOwnProperty("action");if(typeof s!=="undefined"||i){if(typeof s!=="string"){jQuery.sap.log.error("invalid input for _getLinks","the semantic object must be a string, got "+Object.prototype.toString.call(s)+" instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object";}if(i&&s.match(/^\s+$/)){jQuery.sap.log.error("invalid input for _getLinks","the semantic object must be a non-empty string, got '"+s+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object";}if(!i&&s.length===0){jQuery.sap.log.error("invalid input for _getLinks","the semantic object must not be an empty string, got '"+s+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid semantic object";}}if(typeof b!=="undefined"){if(typeof b!=="string"){jQuery.sap.log.error("invalid input for _getLinks","the action must be a string, got "+Object.prototype.toString.call(b)+" instead","sap.ushell.services.ClientSideTargetResolution");return"invalid action";}if(b.length===0){jQuery.sap.log.error("invalid input for _getLinks","the action must not be an empty string, got '"+b+"' instead","sap.ushell.services.ClientSideTargetResolution");return"invalid action";}}return undefined;};this._getLinks=function(a,i){var s=a.semanticObject,b=a.action,P=a.params,w=!!a.withAtLeastOneUsedParam,T=!!a.treatTechHintAsFilter,I=a.ignoreFormFactor;var e=this._validateGetSemanticObjectLinksArgs(a);if(e){return new jQuery.Deferred().reject(e).promise();}if(s==="*"){return new jQuery.Deferred().resolve([]).promise();}function C(U,P){var B=U.paramsToString(P);return B?"?"+B:"";}var d=this,U=this._getURLParsing(),D=new jQuery.Deferred(),f=sap.ushell.utils.getFormFactor(),o=U.parseParameters(C(U,P)),j={semanticObject:(s===""?undefined:s),action:b,formFactor:(I?undefined:f),params:o};if(T){j.treatTechHintAsFilter=true;}this._getMatchingInbounds(j,i).done(function(m){var k={},r=m.map(function(M){var l=s||M.inbound.semanticObject,n="#"+l+"-"+M.inbound.action,N;if(l==="*"){return undefined;}if(M.inbound.action==="*"){return undefined;}if(M.inbound&&M.inbound.hasOwnProperty("hideIntentLink")&&M.inbound.hideIntentLink===true){return undefined;}if(!k.hasOwnProperty(n)){k[n]=1;if(M.inbound.signature.additionalParameters==="ignored"){N=d._filterObjectKeys(o,function(v){return(v.indexOf("sap-")===0)||M.inbound.signature.parameters.hasOwnProperty(v);},false);}else{N=o;}if(w){var q=Object.keys(N).some(function(v){return v.indexOf("sap-")!==0;});if(!q){return undefined;}}return{"intent":n+C(U,N),"text":M.inbound.title};}else{k[n]++;}return undefined;}).filter(function(l){return typeof l==="object";}).sort(function(G,l){return G.intent<l.intent?-1:1;});if(r.length===0){jQuery.sap.log.debug("_getLinks returned no results");}else if(jQuery.sap.log.getLevel()>=jQuery.sap.log.Level.DEBUG){if(jQuery.sap.log.getLevel()>=jQuery.sap.log.Level.TRACE){var R=[];r.forEach(function(l){var n=l.intent.split("?")[0],L="- "+n+" ("+k[n]+") "+"text: "+l.text+" "+"intent: "+l.intent;R.push(L);});jQuery.sap.log.debug("_getLinks filtered to the following unique intents:",R.join("\n"),"sap.ushell.services.ClientSideTargetResolution");}else{jQuery.sap.log.debug("_getLinks filtered to unique intents.","Reporting histogram: "+Object.keys(k).join(", "),"sap.ushell.services.ClientSideTargetResolution");}}D.resolve(r);}).fail(D.reject.bind(D));return D.promise();};this._serializeMatchingResult=function(m,i){var r=m.inbound.resolutionResult;return["applicationType","ui5ComponentName","url","additionalInformation","text"].map(function(k){if(i){return r.hasOwnProperty(k)?k+":"+r[k]:"";}return r.hasOwnProperty(k)?r[k]:"";}).join("");};this._mergeSimpleAndExtended=function(v){var m=jQuery.extend(true,{},v.extendedValue);if(typeof v.value==="string"){if(!jQuery.isArray(m.Ranges)){m.Ranges=[];}m.Ranges.push({"Sign":"I","Option":"EQ","Low":v.value,"High":null});}return m;};this._resolveAllReferences=function(r){var a=this,d=new jQuery.Deferred(),U,R,b=true,D={},P,e=r.map(function(s){var f=a._extractAnyUserDefaultReferenceName(s);if(typeof f!=="string"){b=false;jQuery.sap.log.error("User default reference cannot be resolved","Cannot extract name of user default reference from '"+s+"'","sap.ushell.services.ClientSideTargetResolution");}D[f]=1;return{full:s,name:f};});if(!b){return d.reject("One or more user default references could not be resolved").promise();}U=sap.ushell.Container.getService("UserDefaultParameters");P=Object.keys(D);R=P.map(function(n){return U.getValue(n);});jQuery.when.apply(jQuery,R).done(function(){var k={},f=arguments,i=0;P.forEach(function(n,I){D[n]=f[I];});e.forEach(function(o){var m;if(o.full.indexOf("UserDefault.extended.")===0){m=a._mergeSimpleAndExtended(D[o.name]);if(!jQuery.isEmptyObject(m)){k[o.full]=m;}else{k[o.full]=undefined;}}else{k[o.full]=D[o.name].value;}++i;});d.resolve(k);});return d.promise();};this._getMatchingInbounds=function(s,i){var a=this,d=new jQuery.Deferred(),r=new jQuery.Deferred(),R=new jQuery.Deferred();function w(b){var C=jQuery.sap.log.getLevel();if(C>=jQuery.sap.log.Level.DEBUG){var I=C>=jQuery.sap.log.Level.TRACE;b(I);}}function U(k,v){return this[k]===undefined?"<undefined>":v;}var f=function(){var m=[],M={},P=[],n={};w(function(){jQuery.sap.log.debug("Matching intent \"#"+((s||{}).semanticObject||"")+"-"+((s||{}).action||"")+"\" with parameters"+"\n"+JSON.stringify(s.params,U,"   "),null,"sap.ushell.services.ClientSideTargetResolution");});i.forEach(function(I){var o=a._matchToInbound(s,I,{},M);if(o.matches){m.push(o);P.push(I);}else{w(function(){if(!n[o.noMatchReason]){n[o.noMatchReason]=[];}n[o.noMatchReason].push("#"+(o.inbound||{}).semanticObject+"-"+(o.inbound||{}).action+(o.noMatchDebug?"|"+o.noMatchDebug:""));});}});w(function(I){if(I){Object.keys(n).forEach(function(b){jQuery.sap.log.debug(b+": "+n[b].join("; "),null,"sap.ushell.services.ClientSideTargetResolution");});}});if(jQuery.isEmptyObject(M)){r.resolve(m);}else{w(function(I){jQuery.sap.log.debug(I?"A rematch is required because the following user defaults need to be determined:"+"\n"+Object.keys(M).join("\n"):"A rematch is required because one or more user defaults need to be determined.",null,"sap.ushell.services.ClientSideTargetResolution");});a._resolveAllReferences(Object.keys(M)).done(function(o){R.resolve(o,P);}).fail(function(e){jQuery.sap.log.error("Failed to resolve all references",e,"sap.ushell.services.ClientSideTargetResolution");r.resolve([]);});}};if(sap.ushell.utils.getParameterValueBoolean("sap-ushell-cstr-timeout")){setTimeout(f,0);}else{f();}R.done(function(k,P){w(function(I){jQuery.sap.log.debug(I?"Rematching with the following resolved user defaults:"+JSON.stringify(k,U,"   "):"Rematching with resolved user defaults.",null,"sap.ushell.services.ClientSideTargetResolution");});var b=[],m={};P.forEach(function(I){var M=a._matchToInbound(s,I,k,m);if(M.matches){b.push(M);}});if(jQuery.isEmptyObject(m)){r.resolve(b);}else{jQuery.sap.log.error("Still obtained unknown references during rematch",JSON.stringify(m,U,"   "),"sap.ushell.services.ClientSideTargetResolution");d.reject("Rematching returned unknown references!");}});r.done(function(P){a._sortMatchingResultsDeterministic(P);w(function(I){if(P.length===0){w(function(){jQuery.sap.log.debug("The intent did not match any inbounds",null,"sap.ushell.services.ClientSideTargetResolution");});return;}var T=0,b=function(k,v){return(k==="_original")?undefined:U.call(this,k,v);},e=P.map(function(m){var C="";T++;if(I){C=" "+(m["sap-priority"]||"")+" Priority: "+(m["sap-priority"]?"sap-priority : "+m["sap-priority"]:"")+m.priorityString+" Signature: "+a._compactSignatureNotation((m.inbound||{}).signature)+" Deterministic blob: "+a._serializeMatchingResult(m,true);}return T+". #"+(m.inbound||{}).semanticObject+"-"+(m.inbound||{}).action+C;}).join("\n"),j=I?JSON.stringify(P[0],U,"   "):JSON.stringify(P[0].resolutionResult||P[0],b,"   ");jQuery.sap.log.debug("Intent has matched the following inbounds (in priority): \n"+e,"\nTop matched inbound resolves to:"+j,"sap.ushell.services.ClientSideTargetResolution");});d.resolve(P);});return d.promise();};this._sortMatchingResultsDeterministic=function(m){var a=this;m.sort(function(M,o){if((M["sap-priority"]||0)-(o["sap-priority"]||0)!==0){return-((M["sap-priority"]||0)-(o["sap-priority"]||0));}if(M.priorityString<o.priorityString){return 1;}if(M.priorityString>o.priorityString){return-1;}return(a._serializeMatchingResult(M)<a._serializeMatchingResult(o))?1:-1;});};this._isIntentSupportedOne=function(i,I){var d=new jQuery.Deferred(),s=this._getURLParsing().parseShellHash(i);if(i==="#"){d.resolve(true);return d.promise();}if(s===undefined){jQuery.sap.log.error("Could not parse shell hash '"+i+"'","please specify a valid shell hash","sap.ushell.services.ClientSideTargetResolution");return d.reject().promise();}s.formFactor=sap.ushell.utils.getFormFactor();this._getMatchingInbounds(s,I).done(function(T){d.resolve(T.length>0);}).fail(function(){d.reject();});return d.promise();};this.isIntentSupported=function(i){var a=this,d=new jQuery.Deferred();this._ensureInbounds().done(function(I){a._isIntentSupported(i,I).done(d.resolve.bind(d)).fail(d.reject.bind(d));}).fail(d.reject.bind(d));return d.promise();};this._isIntentSupported=function(i,I){var a=this,d=new jQuery.Deferred(),s={};d.resolve();function b(e,f){s[e]={supported:f};}i.forEach(function(e){var n=a._isIntentSupportedOne(e,I);n.fail(function(E){b(e,false);});n.done(function(R){b(e,R);});d=jQuery.when(d,n);});var r=new jQuery.Deferred();d.done(function(){r.resolve(s);}).fail(function(){r.reject.bind(d);});return r.promise();};this._extractUserDefaultReferenceName=function(r){if(typeof r!=="string"||r.indexOf("UserDefault.")!==0||r.indexOf("UserDefault.extended.")===0){return undefined;}return r.replace(/^UserDefault[.]/,"");};this._extractAnyUserDefaultReferenceName=function(r){var P=this._extractExtendedUserDefaultReferenceName(r);if(typeof P==="string"){return P;}return this._extractUserDefaultReferenceName(r);};this._extractExtendedUserDefaultReferenceName=function(r){if(typeof r!=="string"||r.indexOf("UserDefault.extended.")!==0){return undefined;}return r.replace(/^UserDefault[.]extended[.]/,"");};this.getUserDefaultParameterNames=function(){var a=this,d=new jQuery.Deferred();this._ensureInbounds().done(function(i){var r;try{r=a._getUserDefaultParameterNames(i);d.resolve(r);}catch(e){d.reject("Cannot get user default parameters from inbounds: "+e);}}).fail(d.reject.bind(d));return d.promise();};this._getUserDefaultParameterNames=function(i){var r={simple:{},extended:{}},a=this;i.forEach(function(T){var s=T.signature&&T.signature.parameters||[];Object.keys(s).forEach(function(P){var o=s[P],R,e,U;if(o){if(o.filter&&o.filter.format==="reference"){U=o.filter.value;}else if(o.defaultValue&&o.defaultValue.format==="reference"){U=o.defaultValue.value;}if(typeof U==="string"){R=a._extractUserDefaultReferenceName(U);if(typeof R==="string"){r.simple[R]={};}e=a._extractExtendedUserDefaultReferenceName(U);if(typeof e==="string"){r.extended[e]={};}}}});});return r;};this._compactSignatureNotation=function(s){var f=s||{};var P=f.parameters||{},T={optional:"[FORMAT]",required:"FORMAT"},F={regexp:"/VALUE/",reference:"@VALUE",value:"VALUE",plain:"VALUE",_unknown:"?VALUE"},a={allowed:"<+>",notallowed:"<->",ignored:"<o>",_unknown:"<?>"};if(jQuery.isEmptyObject(P)){return"<no params>"+(a[f.additionalParameters||"_unknown"]);}var r=[];Object.keys(P).forEach(function(b){var o=P[b],d=o.required?"required":"optional",e=o.filter&&o.filter.value,i=o.defaultValue&&o.defaultValue.value,j=(o.filter&&o.filter.format)||"plain",k=(o.defaultValue&&o.defaultValue.format)||"plain";var v=[],l=F[j]||F._unknown,m=F[k]||F._unknown;if(e){v.push(T["required"].replace("FORMAT",l.replace("VALUE",e)));}if(i){v.push(T["optional"].replace("FORMAT",m.replace("VALUE",i)));}r.push(T[d].replace("FORMAT",b+":"+v.join("")));});return r.join(";")+(a[f.additionalParameters||"_unknown"]);};this.getEasyAccessSystems=function(){var e={},d;d=sap.ushell.utils.getFormFactor();if(!H){H=new jQuery.Deferred();this._ensureInbounds().done(function(i){i.forEach(function(I){var s;if(I&&I.semanticObject&&I.semanticObject==="Shell"&&I.action&&(I.action==="startGUI"||I.action==="startWDA")&&I.deviceTypes&&d!==undefined&&I.deviceTypes[d]){if(jQuery.isPlainObject(I.signature.parameters["sap-system"])&&I.signature.parameters["sap-system"].hasOwnProperty("filter")){s=jQuery.sap.getObject("signature.parameters.sap-system.filter.value",undefined,I);}if(typeof s==="string"){if(!e[s]){e[s]={text:I.title,appType:{}};}else if(I.action==="startGUI"){e[s].text=I.title;}if(I.action==="startGUI"){e[s].appType.TR=true;}else if(I.action==="startWDA"){e[s].appType.WDA=true;}}}});H.resolve(e);}).fail(H.reject.bind(H));}return H.promise();};};sap.ushell.services.ClientSideTargetResolution.hasNoAdapter=false;}());
