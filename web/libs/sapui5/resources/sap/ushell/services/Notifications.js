// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.services.Notifications");jQuery.sap.require("sap.ui.thirdparty.datajs");sap.ushell.services.Notifications=function(c,p,s){var m=new sap.ui.model.json.JSONModel(),t=new Date(),S=s&&s.config,r={getNotifications:{},getNotificationsByType:{},getBadgeNumber:{},resetBadgeNumber:{}},w,W=S.webSocketUrl||"/sap/bc/apc/iwngw/notification_push_apc",P=S.pollingIntervalInSeconds||60,u=[],U=[],i=false,C=[],I=false,o=false,E=true,h,d,a=5000,b=6000,f=false,g={NOTIFICATIONS:0,NOTIFICATIONS_BY_TYPE:1,GET_BADGE_NUMBER:2,RESET_BADGE_NUMBER:3},M={PACKAGED_APP:0,FIORI_CLIENT:1,WEB_SOCKET:2,POLLING:3},j,F=false;this.isEnabled=function(){if(!S.enabled||!S.serviceUrl){E=false;if(S.enabled&&!S.serviceUrl){jQuery.sap.log.warning("No serviceUrl was found in the service configuration");}}else{E=true;}return E;};this.init=function(){if((!I)&&(this.isEnabled())){this._setWorkingMode();I=true;}};this.getUnseenNotificationsCount=function(){var D=jQuery.Deferred();D.resolve(m.getProperty("/UnseenCount"));return D.promise();};this.getNotificationsByTypeWithGroupHeaders=function(){var H,R,D=new jQuery.Deferred(),e=this._getRequestURI(g.NOTIFICATIONS_BY_TYPE);R={requestUri:e};if(!this._getHeaderXcsrfToken()){H={};H["X-CSRF-Token"]="fetch";R.headers=H;}OData.request(R,function(k){D.resolve(k);},function(k){if(k.response&&k.response.statusCode===200&&k.response.body){D.resolve(k.response.body);}else{D.reject();jQuery.sap.log.error("Notification service - oData executeAction failed: ",k,"sap.ushell.services.Notifications");}});return D.promise();};this.getNotifications=function(){var R,D=jQuery.Deferred();if((j===M.FIORI_CLIENT)||(j===M.PACKAGED_APP)){R=this._readNotificationsData(false);R.done(function(){D.resolve(m.getProperty("/Notifications"));}).fail(function(e){D.reject();});}else{D.resolve(m.getProperty("/Notifications"));}return D.promise();};this.executeBulkAction=function(n,A){var D=new jQuery.Deferred(),e=[],k=[],R={succededNotifications:e,failedNotifications:k},l=[],q=this;n.forEach(function(N,v){var x=new jQuery.Deferred();l.push(x.promise());q.executeAction(N,A).done(function(){e.push(N);x.resolve();}).fail(function(){k.push(N);x.resolve();});});jQuery.when.apply(jQuery,l).always(function(){if(k.length){D.reject(R);}else{D.resolve(R);}});return D.promise();};this.dismissBulkNotifications=function(n){var D=new jQuery.Deferred(),e=[],k=[],R={succededNotifications:e,failedNotifications:k},l=[],q=this;n.forEach(function(N,v){var x=new jQuery.Deferred();l.push(x.promise());q.dismissNotification(N).done(function(){e.push(N);x.resolve();}).fail(function(){k.push(N);x.resolve();});});jQuery.when.apply(jQuery,l).always(function(){if(k.length){D.reject(R);}else{D.resolve(R);}});return D.promise();};this.executeAction=function(n,A){var e=S.serviceUrl+"/ExecuteAction",R={NotificationId:n,ActionId:A},k={requestUri:e,method:"POST",data:R,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","DataServiceVersion":d,"X-CSRF-Token":h}},D=jQuery.Deferred();OData.request(k,function(l){D.resolve();},function(l){if(l.response&&l.response.statusCode===200&&l.response.body){D.resolve();}else{D.reject();jQuery.sap.log.error("Notification service - oData executeAction failed: ",l,"sap.ushell.services.Notifications");}});return D.promise();};this.markRead=function(n){var A=S.serviceUrl+"/MarkRead",R={NotificationId:n},e={requestUri:A,method:"POST",data:R,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","DataServiceVersion":d,"X-CSRF-Token":h}},D=jQuery.Deferred();OData.request(e,function(k){D.resolve();},function(k){D.reject();jQuery.sap.log.error("Notification service - oData markRead failed: ",k,"sap.ushell.services.Notifications");});return D.promise();};this.dismissNotification=function(n){var A=S.serviceUrl+"/Dismiss",R={NotificationId:n},e={requestUri:A,method:"POST",data:R,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","DataServiceVersion":d,"X-CSRF-Token":h}},D=jQuery.Deferred();OData.request(e,function(k){D.resolve();},function(k){D.reject();jQuery.sap.log.error("Notification service - oData dismiss notification failed: ",k,"sap.ushell.services.Notifications");});return D.promise();};this.registerNotificationsUpdateCallback=function(e){u.push(e);};this.registerNotificationCountUpdateCallback=function(e){U.push(e);};this.notificationsSeen=function(){this._setNotificationsAsSeen();};this.isFirstDataLoaded=function(){return F;};this.destroy=function(){o=true;if((j===M.WEB_SOCKET)&&w){w.close();}};this._readNotificationsData=function(e){var k=this,H,R,l,n,D=new jQuery.Deferred(),q=this._getRequestURI(g.NOTIFICATIONS);R={requestUri:q};if(!this._getHeaderXcsrfToken()){H={};H["X-CSRF-Token"]="fetch";R.headers=H;}OData.read(R,function(v,x){n=v.results;k._notificationAlert(n);l=k._notificationsDescendingSortBy(n,"CreatedAt");m.setProperty("/Notifications",l);if(e){k._updateNotificationsConsumers();}if(!k._getHeaderXcsrfToken()){h=x.headers["x-csrf-token"];}if(!k._getDataServiceVersion()){d=x.headers.DataServiceVersion;}D.resolve();},function(v){if(v.response&&v.response.statusCode===200&&v.response.body){n=JSON.parse(v.response.body);k._notificationAlert(n.value);l=k._notificationsDescendingSortBy(n.value,"CreatedAt");m.setProperty("/Notifications",l);if(e){k._updateNotificationsConsumers();}if(!k._getHeaderXcsrfToken()){h=v.response.headers["x-csrf-token"];}if(!k._getDataServiceVersion()){d=v.response.headers.DataServiceVersion;}D.resolve();}else{jQuery.sap.log.error("Notification service - oData read notifications failed: ",v.message,"sap.ushell.services.Notifications");D.reject();}});return D.promise();};this._readUnseenNotificationsCount=function(e){var k=this,G=this._getRequestURI(g.GET_BADGE_NUMBER),R={requestUri:G};OData.read(R,function(l,n){m.setProperty("/UnseenCount",n.data.GetBadgeNumber.Number);if(e){k._updateNotificationsCountConsumers();}},function(l){if(l.response&&l.response.statusCode===200&&l.response.body){var n=JSON.parse(l.response.body);m.setProperty("/UnseenCount",n.value);if(e){k._updateNotificationsCountConsumers();}}else{jQuery.sap.log.error("Notification service - oData read unseen notifications count failed: ",l.message,"sap.ushell.services.Notifications");}});};this._setNotificationsAsSeen=function(){var R=this._getRequestURI(g.RESET_BADGE_NUMBER),e={requestUri:R,method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","DataServiceVersion":d,"X-CSRF-Token":h}};OData.request(e,function(k,l){},function(k){jQuery.sap.log.error("Notification service - oData reset badge number failed: ",k,"sap.ushell.services.Notifications");});};this._readAllNotificationsData=function(e){var R,D=new jQuery.Deferred();this._readUnseenNotificationsCount(e);R=this._readNotificationsData(e);R.done(function(){D.resolve();}).fail(function(k){D.reject();});return D.promise();};this._getHeaderXcsrfToken=function(){return h;};this._getDataServiceVersion=function(){return d;};this._getRequestURI=function(R){var e,k=encodeURI(this._getConsumedIntents(R));switch(R){case g.NOTIFICATIONS:if(r.getNotifications.basic===undefined){r.getNotifications.basic=S.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$filter=IsGroupHeader%20eq%20false";}if(this._isIntentBasedConsumption()){if(r.getNotifications.byIntents===undefined){r.getNotifications.byIntents=r.getNotifications.basic.concat("&intents%20eq%20"+k);}return r.getNotifications.byIntents;}return r.getNotifications.basic;case g.NOTIFICATIONS_BY_TYPE:if(r.getNotificationsByType.basic===undefined){r.getNotificationsByType.basic=S.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams";}if(this._isIntentBasedConsumption()){if(r.getNotificationsByType.byIntents===undefined){r.getNotificationsByType.byIntents=r.getNotificationsByType.basic.concat("&$filter=intents%20eq%20"+k);}return r.getNotificationsByType.byIntents;}return r.getNotificationsByType.basic;case g.GET_BADGE_NUMBER:if(r.getBadgeNumber.basic===undefined){r.getBadgeNumber.basic=S.serviceUrl+"/GetBadgeNumber()";}if(this._isIntentBasedConsumption()){if(r.getBadgeNumber.byIntents===undefined){r.getBadgeNumber.byIntents=S.serviceUrl+"/GetBadgeCountByIntent("+k+")";}return r.getBadgeNumber.byIntents;}return r.getBadgeNumber.basic;case g.RESET_BADGE_NUMBER:if(r.resetBadgeNumber.basic===undefined){r.resetBadgeNumber.basic=S.serviceUrl+"/ResetBadgeNumber";}return r.resetBadgeNumber.basic;default:e="";}return e;};this._updateNotificationsConsumers=function(){u.forEach(function(e){e();});};this._updateNotificationsCountConsumers=function(){U.forEach(function(e){e();});};this._getModel=function(){return m;};this._getMode=function(){return j;};this._setWorkingMode=function(){var e;if(S.intentBasedConsumption===true){C=this._getIntentsFromConfiguration(S.consumedIntents);if(C.length>0){i=true;}}if(this._isPackagedMode()){j=M.PACKAGED_APP;e=this._getIntentsFromConfiguration(window.fiori_client_appConfig.applications);if(e.length>0){C=e;}if(C.length>0){i=true;}this._registerForPush();this._readAllNotificationsData(true);return;}this._performFirstRead();};this._performFirstRead=function(){var e=this,k,R=this._readAllNotificationsData(true);R.done(function(){k=e._getFioriClientRemainingDelay();if(k<=0){e._fioriClientStep();}else{setTimeout(function(){e._fioriClientStep();},k);}F=true;}).fail(function(l){jQuery.sap.log.error("Notifications oData read failed. Error: "+l);return;});};this._fioriClientStep=function(){if(this._isFioriClientMode()){j=M.FIORI_CLIENT;this._addPushNotificationHandler();}else{this._webSocketStep();}};this._webSocketStep=function(){j=M.WEB_SOCKET;this._establishWebSocketConnection();};this._webSocketRecoveryStep=function(){if(f===false){f=true;setTimeout(function(){this._webSocketStep();}.bind(this),a);}else{this._activatePolling();}};this._activatePolling=function(){var e=this;j=M.POLLING;this._readAllNotificationsData(true);this.timer=setTimeout(e._activatePolling.bind(e,P,false),(P*1000));};this._formatAsDate=function(e){return new Date(e);};this._notificationAlert=function(e){var n,N=[],k=0;for(n in e){if(this.lastNotificationDate&&this._formatAsDate(e[n].CreatedAt)>this.lastNotificationDate){if(e[n].Priority==="HIGH"){N.push(e[n]);}}if(k<this._formatAsDate(e[n].CreatedAt)){k=this._formatAsDate(e[n].CreatedAt);}}if(this.lastNotificationDate&&N&&N.length>0){sap.ui.getCore().getEventBus().publish("sap.ushell.services.Notifications","onNewNotifications",N);}this.lastNotificationDate=k;};this._getFioriClientRemainingDelay=function(){return b-(new Date()-t);};this._establishWebSocketConnection=function(){var k=this,l;jQuery.sap.require("sap.ui.core.ws.SapPcpWebSocket");try{w=new sap.ui.core.ws.SapPcpWebSocket(W,[sap.ui.core.ws.SapPcpWebSocket.SUPPORTED_PROTOCOLS.v10]);w.attachMessage(this,function(n,D){l=n.getParameter("pcpFields");if((l)&&(l.Command)&&(l.Command==="Notification")){k._readAllNotificationsData(true);}});w.attachClose(this,function(n,D){jQuery.sap.log.error("Notifications UShell service WebSocket: attachClose called with code: "+n.mParameters.code+" and reason: "+n.mParameters.reason);if(!o){k._webSocketRecoveryStep();}});w.attachError(this,function(n,D){jQuery.sap.log.error("Notifications UShell service WebSocket: attachError called!");});}catch(e){jQuery.sap.log.error("Exception occurred while creating new sap.ui.core.ws.SapPcpWebSocket. Message: "+e.message);}};this._isFioriClientMode=function(){return!(sap.FioriClient===undefined);};this._isPackagedMode=function(){return(window.fiori_client_appConfig&&window.fiori_client_appConfig.prepackaged===true);};this._getIntentsFromConfiguration=function(e){var T=[],k,l;if(e&&e.length>0){for(l=0;l<e.length;l++){k=e[l].intent;T.push(k);}}return T;};this._handlePushedNotification=function(D){if(!(D===undefined)&&!(D.additionalData===undefined)){if(D.additionalData.foreground){this._readAllNotificationsData(true);}else{this._readAllNotificationsData(true);}}};this._registerForPush=function(){sap.Push.initPush(this._handlePushedNotification.bind(this));};this._addPushNotificationHandler=function(){document.addEventListener("deviceready",this._registerForPush.bind(this),false);};this._isIntentBasedConsumption=function(){return i;};this._getConsumedIntents=function(R){var e="",k;if(!this._isIntentBasedConsumption()){return e;}if(C.length>0){if(R!==g.GET_BADGE_NUMBER){e="&";}for(k=0;k<C.length;k++){if(R===g.GET_BADGE_NUMBER){if(k===0){e=C[k];}else{e=e+","+C[k];}}else{e=e+"NavigationIntent%20eq%20%27"+C[k]+"%27";}}}return e;};this._notificationsAscendingSortBy=function(n,e){n.sort(function(x,y){var v=x[e],k=y[e];if(v===k){v=x.id;k=y.id;}return k>v?-1:1;});return n;};this._notificationsDescendingSortBy=function(n,e){n.sort(function(x,y){var v=x[e],k=y[e];if(v===k){v=x.id;k=y.id;return v>k?-1:1;}if(e==="Priority"){if(v==="HIGH"){return-1;}if(k==="HIGH"){return 1;}if(v==="MEDIUM"){return-1;}return 1;}return v>k?-1:1;});return n;};};sap.ushell.services.Notifications.hasNoAdapter=true;}());
