// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.services.CrossApplicationNavigation");jQuery.sap.require("sap.ushell.services.Personalization");jQuery.sap.require("jquery.sap.storage");sap.ushell.services.CrossApplicationNavigation=function(c,p,s){var a,S;if(s&&s.config){S=s.config;}function g(t,C){var r,d,e,o,f,h;if(typeof t!=="string"&&!jQuery.isPlainObject(t)&&t!==undefined){jQuery.sap.log.error("Unexpected input type",null,"sap.ushell.services.CrossApplicationNavigation");return undefined;}if(t===undefined){return undefined;}var n;if(C){if(typeof C.getComponentData!=="function"||!jQuery.isPlainObject(C.getComponentData())||!C.getComponentData().startupParameters||!jQuery.isPlainObject(C.getComponentData().startupParameters)){jQuery.sap.log.error("Cannot call getComponentData on component","the component should be an application root component","sap.ushell.services.CrossApplicationNavigation");}else{h=C.getComponentData().startupParameters;if(h.hasOwnProperty("sap-system")){e=h["sap-system"][0];}if(h.hasOwnProperty("sap-ushell-next-navmode")){n=h["sap-ushell-next-navmode"][0];}}}else{r=sap.ushell.Container.getService("NavTargetResolution").getCurrentResolution();if(r&&r["sap-system"]){e=r["sap-system"];}else if(r&&r.url){e=jQuery.sap.getUriParameters(r.url).get("sap-system");}if(r&&r["sap-ushell-next-navmode"]){n=r["sap-ushell-next-navmode"];}else if(r&&r.url){n=jQuery.sap.getUriParameters(r.url).get("sap-ushell-next-navmode");}}if(jQuery.isPlainObject(t)){o=jQuery.extend(true,{},t);if(!e&&!n){return o;}if(o.target&&o.target.shellHash){if(typeof o.target.shellHash==="string"){o.target.shellHash=g(o.target.shellHash,C);}return o;}o.params=o.params||{};if(e&&!Object.prototype.hasOwnProperty.call(o.params,"sap-system")){o.params["sap-system"]=e;}if(n&&!Object.prototype.hasOwnProperty.call(o.params,"sap-ushell-navmode")){o.params["sap-ushell-navmode"]=[n];}return o;}else{f=t;if(!(e||n)){return f;}if(e&&!/[?&]sap-system=/.test(f)){d=(f.indexOf("?")>-1)?"&":"?";f+=d+"sap-system="+e;}if(n&&!/[?&]sap-ushell-navmode=/.test(f)){d=(f.indexOf("?")>-1)?"&":"?";f+=d+"sap-ushell-navmode="+n;}return f;}}function b(t){var d,C,e;if(localStorage&&localStorage["sap-ushell-enc-test"]==="false"){return t;}if(!S||!S["sap-ushell-enc-test"]){if(localStorage&&localStorage["sap-ushell-enc-test"]!=="true"){return t;}}if(typeof t!=="string"&&!jQuery.isPlainObject(t)&&t!==undefined){jQuery.sap.log.error("Unexpected input type",null,"sap.ushell.services.CrossApplicationNavigation");return undefined;}if(t===undefined){return undefined;}if(jQuery.isPlainObject(t)){C=jQuery.extend(true,{},t);if(C.target&&C.target.shellHash){if(typeof C.target.shellHash==="string"){if(C.target.shellHash!=="#"&&C.target.shellHash!==""){C.target.shellHash=b(C.target.shellHash);}}return C;}C.params=C.params||{};C.params["sap-ushell-enc-test"]=["A B%20C"];return C;}else{e=t;if(!/[?&]sap-system=/.test(e)){d=(e.indexOf("?")>-1)?"&":"?";e+=d+"sap-ushell-enc-test="+encodeURIComponent("A B%20C");}return e;}}this.hrefForExternal=function(A,C,d){var o;if(sap.ushell&&sap.ushell.services&&sap.ushell.Container&&typeof sap.ushell.Container.getService==="function"&&sap.ushell.Container.getService("ShellNavigation")){o=g(A,C);o=b(o);return sap.ushell.Container.getService("ShellNavigation").hrefForExternal(o,undefined,C,d);}jQuery.sap.log.debug("Shell not available, no Cross App Navigation");if(d){return(new jQuery.Deferred()).resolve("").promise();}return"";};this.expandCompactHash=function(h){return sap.ushell.Container.getService("NavTargetResolution").expandCompactHash(h);};this.backToPreviousApp=function(){this.historyBack();};this.historyBack=function(){window.history.back();};this.isInitialNavigation=function(){var o=sap.ushell&&sap.ushell.Container&&typeof sap.ushell.Container.getService==="function"&&sap.ushell.Container.getService("ShellNavigation");if(!o){jQuery.sap.log.debug("ShellNavigation service not available","This will be treated as the initial navigation","sap.ushell.services.CrossApplicationNavigation");return true;}var i=o.isInitialNavigation();if(typeof i==="undefined"){return true;}return i;};this.toExternal=function(A,C){var o;if(sap.ushell&&sap.ushell.services&&sap.ushell.Container&&typeof sap.ushell.Container.getService==="function"&&sap.ushell.Container.getService("ShellNavigation")){o=g(A,C);o=b(o);sap.ushell.Container.getService("ShellNavigation").toExternal(o,C);return;}jQuery.sap.log.debug("Shell not avialable, no Cross App Navigation");return;};this.hrefForAppSpecificHash=function(A){if(sap.ushell&&sap.ushell.services&&sap.ushell.Container&&typeof sap.ushell.Container.getService==="function"&&sap.ushell.Container.getService("ShellNavigation")){return sap.ushell.Container.getService("ShellNavigation").hrefForAppSpecificHash(A);}jQuery.sap.log.debug("Shell not available, no Cross App Navigation; fallback to app-specific part only");return"#"+encodeURI(A);};this.getSemanticObjectLinks=function(d,P,i,C,A,e){var m,o,E;m=g({params:P},C).params;m=b({params:m}).params;o=sap.ushell.Container.getService("NavTargetResolution");var v;if(jQuery.isArray(d)){v=[];d.forEach(function(f){v.push([{semanticObject:f[0],params:f[1],ignoreFormFactor:!!f[2],ui5Component:f[3],appStateKey:f[4],compactIntents:!!(f[5])}]);});}else{v={semanticObject:d,params:m,ignoreFormFactor:i,ui5Component:C,appStateKey:A,compactIntents:!!e};}E=sap.ushell.utils.invokeUnfoldingArrayArguments(o.getLinks.bind(o),[v]);return E;};this.getLinks=function(A){var e;e=sap.ushell.utils.invokeUnfoldingArrayArguments(this._getLinks.bind(this),[A]);return e;};this._getLinks=function(n){var N,P,o=sap.ushell.Container.getService("NavTargetResolution");if(typeof n==="undefined"){n={};}N=jQuery.extend(true,{},n);N.compactIntents=!!N.compactIntents;N.action=N.action||undefined;P=g({params:N.params},N.ui5Component).params;P=b({params:P}).params;if(N.appStateKey){P["sap-xapp-state"]=[N.appStateKey];delete N.appStateKey;}N.params=P;return o.getLinks(N);};this.getDistinctSemanticObjects=function(){var o=sap.ushell.Container.getService("NavTargetResolution");return o.getDistinctSemanticObjects();};this.isIntentSupported=function(i,C){var d=new jQuery.Deferred(),o={},e=i.map(function(I){var f=g(I,C);o[f]=I;return f;});sap.ushell.Container.getService("NavTargetResolution").isIntentSupported(e).done(function(I){var m={};Object.keys(I).forEach(function(k){m[o[k]]=I[k];});d.resolve(m);}).fail(d.reject.bind(d));return d.promise();};this.isNavigationSupported=function(i,C){var d=i.map(function(I){return g(I,C);});return sap.ushell.Container.getService("NavTargetResolution").isNavigationSupported(d);};this.isUrlSupported=function(u){var d=new jQuery.Deferred(),U,h;if(typeof u!=="string"){d.reject();return d.promise();}U=sap.ushell.Container.getService("URLParsing");if(U.isIntentUrl(u)){h=U.getHash(u);this.isIntentSupported(["#"+h]).done(function(r){if(r["#"+h]&&r["#"+h].supported){d.resolve();}else{d.reject();}}).fail(function(){d.reject();});}else{d.resolve();}return d.promise();};this.createComponentInstance=function(i,C,o){var d,u,e,f;if(!C){C={};}else{f=Object.keys(C).length;if(f>1||(f===1&&!C.componentData)){throw"`oConfig` argument should either be an empty object or contain only the `componentData` property.";}}if(C.componentData){delete C.componentData.startupParameters;delete C.componentData.config;delete C.componentData["sap-xapp-state"];}d=sap.ushell.Container;u=d.getService("URLParsing");e=u.constructShellHash(u.parseShellHash(i));if(!e){return new jQuery.Deferred(function(D){D.reject("Navigation intent invalid!");}).promise();}return d.getService("NavTargetResolution").resolveHashFragment("#"+e).then(function(r){if(r.applicationType!==sap.ushell.components.container.ApplicationType.URL&&!(/^SAPUI5\.Component=/.test(r.additionalInformation))){return new jQuery.Deferred(function(D){D.reject("The resolved target mapping is not of type UI5 component.");}).promise();}r=jQuery.extend(true,{},r,C);if(!r.ui5ComponentName&&r.additionalInformation){r.ui5ComponentName=r.additionalInformation.replace(/^SAPUI5\.Component=/,"");}return new jQuery.Deferred(function(D){var h=d.getService("Ui5ComponentLoader");if(o){o.runAsOwner(function(){j(r);});}else{j(r);}function j(A){A.loadDefaultDependencies=false;h.createComponent(A).then(function(k){D.resolve(k.componentHandle.getInstance());},function(E){E=E||"";jQuery.sap.log.error("Cannot create UI5 component: "+E,E.stack,"sap.ushell.services.CrossApplicationNavigation");D.reject(E);});}}).promise();});};this.createEmptyAppState=function(A){if(!a){a=sap.ushell.Container.getService("AppState");}if(!(A instanceof sap.ui.core.UIComponent)){throw new Error("oAppComponent passed must be a UI5 Component");}return a.createEmptyAppState(A);};this.getStartupAppState=function(A){this._checkComponent(A);var C=A.getComponentData()&&A.getComponentData()["sap-xapp-state"]&&A.getComponentData()["sap-xapp-state"][0];return this.getAppState(A,C);};this._checkComponent=function(A){if(!(A instanceof sap.ui.core.UIComponent)){throw new Error("oComponent passed must be a UI5 Component");}};this.getAppState=function(A,d){var C,D=new jQuery.Deferred();this._checkComponent(A);if(!a){a=sap.ushell.Container.getService("AppState");}if(typeof d!=="string"){if(d!==undefined){jQuery.sap.log.error("Illegal Argument sAppStateKey ");}setTimeout(function(){C=a.createEmptyUnmodifiableAppState(A);D.resolve(C);},0);return D.promise();}return a.getAppState(d);};this.getAppStateData=function(A){return sap.ushell.utils.invokeUnfoldingArrayArguments(this._getAppStateData.bind(this),[A]);};this._getAppStateData=function(A){var d=new jQuery.Deferred();if(!a){a=sap.ushell.Container.getService("AppState");}if(typeof A!=="string"){if(A!==undefined){jQuery.sap.log.error("Illegal Argument sAppStateKey ");}setTimeout(function(){d.resolve(undefined);},0);}else{a.getAppState(A).done(function(o){d.resolve(o.getData());}).fail(d.resolve.bind(d,undefined));}return d.promise();};this.saveMultipleAppStates=function(A){var r=[],d=new jQuery.Deferred();A.forEach(function(o){r.push(o.save());});jQuery.when.apply(this,r).done(function(){d.resolve(r);}).fail(function(){d.reject("save failed");});return d.promise();};};sap.ushell.services.CrossApplicationNavigation.hasNoAdapter=true;}());
