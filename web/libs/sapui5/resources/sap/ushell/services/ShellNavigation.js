// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.require("sap.ui.thirdparty.signals");jQuery.sap.require("sap.ui.thirdparty.hasher");jQuery.sap.require("sap.ui.core.routing.HashChanger");jQuery.sap.declare("sap.ushell.services.ShellNavigation");function c(){var h=window.history.length;var m={onHashChanged:function(){if(window.history.length!==h){m.onHashChanged=function(){};m.isInitialNavigation=function(){return false;};}},isInitialNavigation:function(){return true;}};return m;}sap.ui.core.routing.HashChanger.extend("sap.ushell.services.ShellNavigationHashChanger",{constructor:function(C){var u;this.oServiceConfig=C;if(jQuery.sap.getUriParameters().get("sap-ushell-reload")){if(jQuery.sap.getUriParameters().get("sap-ushell-reload")==="X"||jQuery.sap.getUriParameters().get("sap-ushell-reload")==="true"){u=true;}else{u=false;}}if(u!==undefined){if(typeof this.oServiceConfig!=="object"){this.oServiceConfig={};}this.oServiceConfig.reload=u;}sap.ui.core.routing.HashChanger.apply(this);this._initializedByShellNav=false;this.oURLShortening=sap.ushell.Container.getService("URLShortening");this.privfnShellCallback=null;this.privappHashPrefix="&/";this.privhashPrefix="#";this.aNavigationFilters=[];this.NavigationFilterStatus={Continue:"Continue",Custom:"Custom",Abandon:"Abandon"};this.privgetCurrentShellHash=function(){var r=this.privsplitHash(hasher.getHash());return{hash:"#"+((r&&r.shellPart)?r.shellPart:"")};};this.privconstructHash=function(A){var o=this.privgetCurrentShellHash();o.hash=o.hash+A;return o;};this.privconstructShellHash=function(s){return sap.ushell.Container.getService("URLParsing").constructShellHash(s);};this.privsplitHash=function(h){var s,o,A;if(h===undefined||h===null||h===""){return{shellPart:null,appSpecificRoute:null,intent:null,params:null};}s=sap.ushell.Container.getService("URLParsing").parseShellHash(h);if(s===undefined||s===null){return null;}o=(s.params&&!jQuery.isEmptyObject(s.params))?s.params:null;A=s.appSpecificRoute;s.appSpecificRoute=undefined;return{shellPart:this.privstripLeadingHash(this.privconstructShellHash(s))||null,appSpecificRoute:A||null,intent:(s.semanticObject&&s.action&&(s.semanticObject+"-"+s.action+(s.contextRaw||"")))||null,params:o};};this.privsetHash=function(f,A,w){hasher.prependHash="";f=this.privstripLeadingHash(f);A=A||"";if(w===undefined){w=true;}if(w){this.fireEvent("hashSet",{sHash:A});hasher.setHash(f);}else{this.fireEvent("hashReplaced",{sHash:A});hasher.replaceHash(f);}};this.privstripLeadingHash=function(h){if(h[0]==='#'){return h.substring(1);}return h;};this.registerNavigationFilter=function(f){if(typeof f!=="function"){throw new Error("fnFilter must be a function");}this.aNavigationFilters.push(f);};function b(o,t){this.oAppState=undefined;this.oPromise=(new jQuery.Deferred()).resolve();this.getNextKey=function(){this.oAppState=sap.ushell.Container.getService("AppState").createEmptyAppState(o,t);return this.oAppState.getKey();};this.store=function(v){var n;this.oAppState.setData(v);n=this.oAppState.save();this.oPromise=jQuery.when(this.oPromise,n);};this.getPromise=function(){return this.oPromise;};}this.compactParams=function(p,r,o,t){var U=sap.ushell.Container.getService("URLParsing"),s,d,R,P,D=new jQuery.Deferred(),h=U.constructShellHash({"target":{"semanticObject":"SO","action":"action"},"params":p},s);if(p===undefined||Object.keys(p).length===0){return D.resolve(p).promise();}s=new b(o,t);R=this.oURLShortening.compactHash(h,r,s);d=U.parseParameters(R.hash.match(/\?.*/)[0]);P=s.getPromise();P.done(function(){D.resolve(d);}).fail(function(m){D.reject(m);});return D;};this.hrefForExternal=function(A,v,o,d){var r=this.hrefForExternalNoEnc(A,v,o,d);function e(R,v){if(v===true){R.hash=encodeURI(R.hash);}else{R=encodeURI(R);}return R;}if(!d){return e(r,v);}var D=new jQuery.Deferred();r.done(function(R){D.resolve(e(R,v));}).fail(D.reject.bind(D));return D;};this.hrefForExternalNoEnc=function(A,v,o,d){var t,p,D,s=new b(o),r;t=this.privhrefForExternalNoEnc(A,s);if(v===true){r={hash:t.hash,params:t.params,skippedParams:t.skippedParams};}else{r=t.hash;}if(!d){return r;}p=s.getPromise();D=new jQuery.Deferred();p.done(function(){D.resolve(r);}).fail(function(m){D.reject(m);});return D;};this.privhrefForExternalNoEnc=function(A,s){var r;if(A===undefined){return this.privgetCurrentShellHash();}if(A&&A.target&&(typeof A.target.semanticObject==="string"||typeof A.target.shellHash==="string")){r="#"+this.privconstructShellHash(A);return this.oURLShortening.compactHash(r,undefined,s);}return this.privgetCurrentShellHash();};this.privgetAppHash=function(A){var s,o;if(A&&A.target&&(typeof A.target.shellHash==="string")){o=sap.ushell.Container.getService("URLParsing").parseShellHash(A.target.shellHash);s=o&&o.appSpecificRoute;s=s&&s.substring(2);}return s;};this.hrefForAppSpecificHash=function(A){return encodeURI(this.privconstructHash(this.privappHashPrefix+A).hash);};this.toExternal=function(A,o,w){var h,s=new b(o),d;h=this.privhrefForExternalNoEnc(A,s).hash;d=this.privgetAppHash(A);this.privsetHash(h,d,w);};this.toAppHash=function(A,w){var h=this.privconstructHash(this.privappHashPrefix+A).hash;this.privsetHash(h,A,w);};}});sap.ushell.services.ShellNavigationHashChanger.prototype.initShellNavigation=function(s){this._oInitialNavigationManager=c();if(this._initializedByShellNav){jQuery.sap.log.info("initShellNavigation already called on this ShellNavigationHashChanger instance.");return false;}this.privfnShellCallback=s;hasher.changed.add(this.treatHashChanged,this);if(!hasher.isActive()){hasher.initialized.addOnce(this.treatHashChanged,this);hasher.init();}else{this.treatHashChanged(hasher.getHash());}this._initializedByShellNav=true;return true;};sap.ushell.services.ShellNavigationHashChanger.prototype.init=function(){if(this._initialized){jQuery.sap.log.info("init already called on this ShellNavigationHashChanger instance.");return false;}var n=this.privsplitHash(hasher.getHash()),A=n&&(n.appSpecificRoute||"  ").substring(2);this.fireEvent("hashChanged",{newHash:A});this._initialized=true;return true;};sap.ushell.services.ShellNavigationHashChanger.prototype.treatHashChanged=function(n,o){if(this.inAbandonFlow){return;}this._oInitialNavigationManager.onHashChanged();var A,O,N,b,s,d,f,g,E,i,F;n=this.oURLShortening.expandHash(n);o=this.oURLShortening.expandHash(o);N=this.privsplitHash(n);b=this.privsplitHash(o);if(!N){E=new Error("Illegal new hash - cannot be parsed: '"+n+"'");this.fireEvent("shellHashChanged",{newShellHash:n,newAppSpecificRoute:null,oldShellHash:(b?b.shellPart:o),error:E});this.privfnShellCallback(n,null,(b?b.shellPart:o),(b?b.appSpecificRoute:null),E);return;}else{s=N.intent;}if(!b){b={shellPart:o,appSpecificRoute:null};}else{d=b.intent;}for(i=0;i<this.aNavigationFilters.length;i=i+1){try{F=this.aNavigationFilters[i].call(undefined,n,o);if(F===this.NavigationFilterStatus.Custom){return;}if(F===this.NavigationFilterStatus.Abandon){this.inAbandonFlow=true;hasher.replaceHash(o);this.inAbandonFlow=false;return;}}catch(e){jQuery.sap.log.error("Error while calling Navigation filter! ignoring filter...",e.message,"sap.ushell.services.ShellNavigation");}}if(s===d&&(o!==undefined)){if(!this._parametersChanged(N.params,b.params)){A=(N.appSpecificRoute||"  ").substring(2);O=(b.appSpecificRoute||"  ").substring(2);jQuery.sap.log.info("Inner App Hash changed from '"+O+"' to '"+A+"'",null,"sap.ushell.services.ShellNavigation");this.fireEvent("hashChanged",{newHash:A,oldHash:O});return;}if(this.hasListeners("shellHashParameterChanged")){f=sap.ushell.Container.getService("URLParsing").paramsToString(N.params);g=sap.ushell.Container.getService("URLParsing").paramsToString(b.params);jQuery.sap.log.info("Shell hash parameters changed from '"+g+"' to '"+f+"'",null,"sap.ushell.services.ShellNavigation");this.fireEvent("shellHashParameterChanged",{oNewParameters:N.params,oOldParameters:b.params});return;}}function r(h){window.location.hash='#'+encodeURI(h);window.location.reload();}if(o!==undefined){if(this.oServiceConfig&&this.oServiceConfig.reload){r(n);}}jQuery.sap.log.info("Outer shell hash changed from '"+o+"' to '"+n+"'",null,"sap.ushell.services.ShellNavigation");this.fireEvent("shellHashChanged",{newShellHash:N.shellPart,newAppSpecificRoute:N.appSpecificRoute,oldShellHash:b.shellPart,oldAppSpecificRoute:b.appSpecificRoute});this.privfnShellCallback(N.shellPart,N.appSpecificRoute,b.shellPart,b.appSpecificRoute);};function a(){jQuery.sap.require('sap.m.MessageBox');sap.m.MessageBox.show("Due to a configuration change on the server,\nclient and server are out of sync.\n We strongly recommend to reload the page soon.\nReload page now?",{icon:sap.m.MessageBox.Icon.ERROR,title:"Client out of sync with server.",actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(A){if(A===sap.m.MessageBox.Action.YES){window.setTimeout(function(){window.location.reload();},0);}}});}sap.ushell.services.ShellNavigationHashChanger.prototype.isInitialNavigation=function(){return this._oInitialNavigationManager&&this._oInitialNavigationManager.isInitialNavigation();};sap.ushell.services.ShellNavigationHashChanger.prototype._parametersChanged=function(n,o){return!jQuery.sap.equal(n,o);};sap.ushell.services.ShellNavigationHashChanger.prototype.setHash=function(h){this.toAppHash(h,true);};sap.ushell.services.ShellNavigationHashChanger.prototype.replaceHash=function(h){this.toAppHash(h,false);};sap.ushell.services.ShellNavigationHashChanger.prototype.getHash=function(){return this.getAppHash();};sap.ushell.services.ShellNavigationHashChanger.prototype.getAppHash=function(){var n=this.privsplitHash(hasher.getHash()),A=n&&(n.appSpecificRoute||"  ").substring(2);return A;};sap.ushell.services.ShellNavigationHashChanger.prototype.destroy=function(){hasher.changed.remove(this.treatHashChanged,this);sap.ui.core.routing.HashChanger.prototype.destroy.apply(this,arguments);};function S(C,p,s){var o=s&&s.config;this.hashChanger=new sap.ushell.services.ShellNavigationHashChanger(o);this.isInitialNavigation=function(){return this.hashChanger.isInitialNavigation();};this.hrefForExternal=function(A,v,b,d){return this.hashChanger.hrefForExternal(A,v,b,d);};this.hrefForAppSpecificHash=function(A){return this.hashChanger.hrefForAppSpecificHash(A);};this.compactParams=function(P,r,b,t){return this.hashChanger.compactParams(P,r,b,t);};this.toExternal=function(A,b,w){this.hashChanger.toExternal(A,b,w);};this.toAppHash=function(A,w){this.hashChanger.toAppHash(A,w);};this.init=function(f){hasher.prependHash="";sap.ui.core.routing.HashChanger.replaceHashChanger(this.hashChanger);var b=sap.ui.getCore().getEventBus();b.subscribe("sap.ui.core.UnrecoverableClientStateCorruption","RequestReload",a);this.hashChanger.initShellNavigation(f);return this;};this.NavigationFilterStatus=this.hashChanger.NavigationFilterStatus;this.registerNavigationFilter=function(f){this.hashChanger.registerNavigationFilter(f);};}sap.ushell.services.ShellNavigation=S;sap.ushell.services.ShellNavigation.hasNoAdapter=true;}());
