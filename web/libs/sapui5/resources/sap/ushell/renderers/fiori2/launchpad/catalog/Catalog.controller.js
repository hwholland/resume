// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";sap.ui.controller("sap.ushell.renderers.fiori2.launchpad.catalog.Catalog",{oPopover:null,onInit:function(){sap.ui.getCore().getEventBus().subscribe("showCatalogEvent",this.onShow,this);sap.ui.getCore().byId("catalogSelect").addEventDelegate({onBeforeRendering:this.onBeforeSelectRendering},this);},onExit:function(){sap.ui.getCore().getEventBus().unsubscribe("showCatalogEvent",this.onShow);this.getView().aDanglingControls.forEach(function(c){c.destroy();});},onAfterRendering:function(){var m=sap.ui.getCore().byId("navContainer").getModel(),t=sap.ui.getCore().byId("catalogTiles"),c=m.getProperty('/catalogs'),a=this;if(!c.length){m.setProperty('/catalogs',[{title:sap.ushell.resources.i18n.getText('catalogsLoading'),"static":true,tiles:[],numIntentSupportedTiles:-1}]);t.setNoDataText(sap.ushell.resources.i18n.getText('loadingTiles'));}else if(c[0].title!=sap.ushell.resources.i18n.getText('catalogsLoading')){t.setNoDataText(sap.ushell.resources.i18n.getText('noFilteredItems'));}if(!this.PagingManager){this.lastCatalogId=0;jQuery.sap.require("sap.ushell.renderers.fiori2.launchpad.PagingManager");this.PagingManager=new sap.ushell.renderers.fiori2.launchpad.PagingManager('catalogPaging',{elementClassName:'sapUshellTile',containerHeight:window.innerHeight,containerWidth:window.innerWidth});}if(this.PagingManager.currentPageIndex===0){a.allocateNextPage();}jQuery("#catalogTilesPage-cont").scroll(function(){var p=sap.ui.getCore().byId('catalogTilesPage'),s=p.getScrollDelegate(),b=s.getScrollTop(),d=s.getMaxScrollTop();if(d-b<=30+a.PagingManager.getTileHeight()){a.allocateNextPage();}});jQuery(window).resize(function(){var w=$(window).width(),b=$(window).height();a.PagingManager.setContainerSize(w,b);a.resetPageFilter();a.applyTileFilters();});},onShow:function(c,E,d){var l=sap.ui.getCore().byId('loadingDialog'),h;l.close();var m=sap.ui.getCore().byId("navContainer").getModel(),C=m.getProperty("/catalogTiles")||[],D=d.params,i;$.extend(this.getView().getViewData(),d);if(this.PagingManager){this.resetPageFilter();}this.categoryFilter=(D&&D.catalogSelector&&D.catalogSelector.length&&D.catalogSelector[0])||null;this.searchFilter=(D&&D.tileFilter&&D.tileFilter.length&&D.tileFilter[0])||"";h=(D&&D.tagFilter&&D.tagFilter.length&&D.tagFilter[0])||"";if(h){try{this.tagFilter=JSON.parse(h);}catch(e){this.tagFilter=[];}}else{this.tagFilter=[];}if(this.tagFilter){m.setProperty("/selectedTags",this.tagFilter);}m.setProperty("/showCatalogHeaders",true);m.setProperty("/catalogSearchFilter",this.searchFilter);for(i=0;i<C.length;i=i+1){C[i].active=false;}if(this.categoryFilter||this.searchFilter){sap.ui.getCore().byId("catalogSelect").rerender();}else{sap.ui.getCore().byId("catalogSelect").setSelectedItemId("");}this.oRenderingFilter=new sap.ui.model.Filter('','EQ','a');this.oRenderingFilter.fnTest=function(v){if(v.catalogIndex<=this.lastCatalogId){return true;}if(this.allocateTiles>0){this.lastCatalogId=v.catalogIndex;this.allocateTiles--;return true;}return false;}.bind(this);if(this.PagingManager){this.applyTileFilters();}},resetPageFilter:function(){this.lastCatalogId=0;this.allocateTiles=this.PagingManager.getNumberOfAllocatedElements();},allocateNextPage:function(){if(!this.allocateTiles||this.allocateTiles===0){this.PagingManager.moveToNextPage();this.allocateTiles=this.PagingManager._calcElementsPerPage();this.applyTileFilters();}},onBeforeSelectRendering:function(){var s=sap.ui.getCore().byId("catalogSelect"),i=jQuery.grep(s.getItems(),jQuery.proxy(function(I){return I.getBindingContext().getObject().id===this.categoryFilter;},this));if(!i.length){i.push(s.getItemAt(0));}if(i[0]&&s.getSelectedItemId()!==i[0].getId()){window.setTimeout($.proxy(s.setSelectedItem,s,i[0].getId()),500);}},setTagsFilter:function(f){sap.ushell.renderers.fiori2.Navigation.openCatalogByHash({categoryFilter:this.categoryFilter,searchFilter:this.searchFilter,tagFilter:f},false);},setCategoryFilter:function(f){sap.ushell.renderers.fiori2.Navigation.openCatalogByHash({categoryFilter:f,searchFilter:this.searchFilter,tagFilter:JSON.stringify(this.tagFilter)},false);},setSearchFilter:function(f){sap.ushell.renderers.fiori2.Navigation.openCatalogByHash({categoryFilter:this.categoryFilter,searchFilter:f,tagFilter:JSON.stringify(this.tagFilter)},false);},applyTileFilters:function(){var f=[],o,s,c,C;if(this.tagFilter){o=new sap.ui.model.Filter('tags','EQ','v');o.fnTest=function(t){var i,a;if(this.tagFilter.length===0){return true;}for(i=0;i<this.tagFilter.length;i++){a=this.tagFilter[i];if(t.indexOf(a)===-1){return false;}}return true;}.bind(this);f.push(o);}if(this.searchFilter){s=new sap.ui.model.Filter($.map(this.searchFilter.split(/[\s,]+/),function(v){return(v&&new sap.ui.model.Filter("keywords",sap.ui.model.FilterOperator.Contains,v))||(v&&new sap.ui.model.Filter("title",sap.ui.model.FilterOperator.Contains,v))||undefined;}),true);f.push(s);}if(this.categoryFilter){C=this.getCatalogTitleById(this.categoryFilter);c=new sap.ui.model.Filter("catalog",sap.ui.model.FilterOperator.EQ,C);f.push(c);}f.push(new sap.ui.model.Filter("isTileIntentSupported",sap.ui.model.FilterOperator.EQ,true));if(this.oRenderingFilter){f.push(this.oRenderingFilter);}sap.ui.getCore().byId("catalogTiles").getBinding("tiles").filter(f);},getCatalogTitleById:function(c){var a=sap.ui.getCore().byId("shell").getModel().getProperty('/catalogs'),b;$.each(a,function(i,t){if(c==t.id){b=t.title;return false;}});return b;},onLiveFilter:function(e){var q=e.getParameter("newValue");if(q){this.setSearchFilter(q);}else{this.setSearchFilter();}},onTagsFilter:function(e){var s=e.getParameters("selectedItem").changedItem,a=e.getParameter("selected"),b=[],c=s.getText();if(this.tagFilter){b=this.tagFilter;}if(a){b.push(c);}else{b=b.filter(function(d){return d!==c;});}this.setTagsFilter(b.length>0?JSON.stringify(b):"");},onCategoryFilter:function(e){var s=e.getParameter("selectedItem"),S=s.getBindingContext(),m=S.getModel();if(m.getProperty("static",S)){m.setProperty("/showCatalogHeaders",true);this.setCategoryFilter();this.selectedCategory=undefined;}else{m.setProperty("/showCatalogHeaders",false);this.setCategoryFilter(s.getBindingContext().getObject().id);this.selectedCategory=s.getId();}},onTileAfterRendering:function(e){var f=e.getSource().getFootItems()[0];if(f!==undefined){if(f.getIcon()==="sap-icon://add"){f.addStyleClass("sapUshellCatalogPlusIcon");}else{f.addStyleClass("sapUshellCatalogVIcon");}}},onTileFooterClick:function(E){var s=E.getSource(),S=s.getBindingContext(),t=this,o,m=sap.ui.getCore().byId("navContainer").getModel(),O,c,p,a=E.oSource,b=a.getDomRef(),d=this.createPopoverData(E),u=[],l=new sap.m.List({mode:sap.m.ListMode.MultiSelect}),L=new sap.m.DisplayListItem({label:"{title}",selected:"{selected}",tooltip:"{title}",type:sap.m.ListType.Active});this.popoverDataSectionHeight=192;L.attachPress(function(E){var e=E.mParameters.id,f=sap.ui.getCore().byId(e);if(f.isSelected()){f.setSelected(false);}else{f.setSelected(true);}});u.push(new sap.ui.model.Filter("isGroupLocked",sap.ui.model.FilterOperator.EQ,false));if(this.getView().getModel().getProperty('/enableHideGroups')){u.push(new sap.ui.model.Filter("isGroupVisible",sap.ui.model.FilterOperator.EQ,true));}l.bindItems("/",L,null,u);o=new sap.ui.model.json.JSONModel(d.userGroupList);l.setModel(o);l.addEventDelegate({onsapup:function(E){try{E.preventDefault();if(sap.ui.getCore().byId('shell').getModel().getData().groups.length){var f=jQuery(document.activeElement);if(f.index()==0){var j=jQuery("#newGroupItem");j.focus();E._bIsStopHandlers=true;}}}catch(e){}}});var C=this._createNewGroupNameControl(m,t);this.oPopoverContainer=this._setPopoverContainer(C,l,this.popoverDataSectionHeight);if(document.body.clientHeight-b.getBoundingClientRect().bottom>=310){p="Bottom";}else{p="Auto";}t.oPopover=new sap.m.ResponsivePopover({id:"groupsPopover",placement:p,content:[this.oPopoverContainer],enableScrolling:true,title:sap.ushell.resources.i18n.getText("addTileToGroups_popoverTitle"),contentWidth:'20rem',afterClose:function(){C.destroy();O.destroy();c.destroy();t.oPopoverContainer.destroy();t.oPopover.destroy();t.oPopover=null;}});if(!sap.ui.Device.system.phone){t.oPopover.setContentHeight(this.popoverDataSectionHeight+"px");}else{t.oPopover.setContentHeight("100%");}O=this.createOkButton(S,o,d,t,t.oPopover,C);O.addEventDelegate({onsaptabprevious:function(E){try{E.preventDefault();E._bIsStopHandlers=true;var j=jQuery("#newGroupItem");if(!j.length){j=jQuery("#newGroupNameInput input");}j.focus();}catch(e){}}});c=new sap.m.Button({id:"cancelButton",press:function(E){E.preventDefault();E._bIsStopHandlers=true;t.oPopover.close();},text:sap.ushell.resources.i18n.getText("cancelBtn")});t.oPopover.setBeginButton(O);t.oPopover.setEndButton(c);t.oPopover.setInitialFocus('newGroupItem');t.oPopover.openBy(a);},_navigateToCreateNewGroupPanel:function(p,n,h){p.removeAllContent();p.addContent(n.addStyleClass("catalogNewGroupInput"));p.setCustomHeader(h);p.setContentHeight("");n.setValueState(sap.ui.core.ValueState.None);n.setPlaceholder(sap.ushell.resources.i18n.getText("new_group_name"));n.enabled=true;setTimeout(function(){n.focus();},0);},_createNewGroupNameControl:function(m,c){var r={created:false,destroy:function(){if(this.created==true){this.newGroupItemList.destroy();this.newGroupNameInput.destroy();}}};if(this.getView().getModel().getProperty('/enableCreateGroupInCatalog')==true){var n=new sap.m.Input({id:"newGroupNameInput",type:"Text",placeholder:sap.ushell.resources.i18n.getText("new_group_name")}),N,b=new sap.m.Button({icon:sap.ui.core.IconPool.getIconURI("nav-back"),press:function(e){c.oPopover.removeAllContent();if(!sap.ui.Device.system.phone){c.oPopover.setContentHeight(c.popoverDataSectionHeight+"px");}else{c.oPopover.setContentHeight("100%");}c.oPopover.setVerticalScrolling(true);c.oPopover.addContent(c.oPopoverContainer);c.oPopover.setTitle(sap.ushell.resources.i18n.getText("addTileToGroups_popoverTitle"));c.oPopover.setCustomHeader();n.enabled=false;n.setValue('');},tooltip:sap.ushell.resources.i18n.getText("newGroupGoBackBtn_tooltip")});b.addStyleClass("catalogNewGroupBackButton");N=new sap.m.List({});var o=new sap.m.Label({text:sap.ushell.resources.i18n.getText("newGroup_popoverTitle")}),h=new sap.m.Bar({contentLeft:[b],contentMiddle:[o]}),a=new sap.m.StandardListItem({id:"newGroupItem",title:sap.ushell.resources.i18n.getText("newGroup_listItemText"),type:"Navigation",press:function(){c._navigateToCreateNewGroupPanel(c.oPopover,n,h);}});if(m.getProperty("/enableHelp")){a.addStyleClass('help-id-newGroupItem');}N.addItem(a);N.addEventDelegate({onsapdown:function(E){try{E.preventDefault();E._bIsStopHandlers=true;if(sap.ui.getCore().byId('shell').getModel().getData().groups.length){var j=jQuery("#popoverContainer .sapMListModeMultiSelect li").first();j.focus();}}catch(e){}},onsaptabnext:function(E){try{E.preventDefault();E._bIsStopHandlers=true;var j=jQuery("#okButton");j.focus();}catch(e){}}});r.created=true;r.newGroupItemList=N;r.newGroupNameInput=n;r.newGroupItem=a;}return r;},createOkButton:function(s,o,p,g,P,c){var O=new sap.m.Button({id:"okButton",press:function(e){e.preventDefault();e._bIsStopHandlers=true;var a=[],b={},d=sap.ushell.Container.getService("LaunchPage"),f,i,t,h,r,n=0,j=0,k,l,m=s.getModel().getProperty(s.getPath()).id,q,u,v=sap.ushell.resources.i18n.getText("new_group_name"),w=[],x=this;for(i=0;i<p.userGroupList.length;i=i+1){t=this.oData[i];r=d.getGroupId(t.object);b[r]=t.title;if(t.selected){a.push(r);h=new sap.ui.model.Context(s.getModel(),"/groups/"+i);if(!o.oData[i].initiallySelected){w.push(g._addTile(s,h));o.oData[i].initiallySelected=true;n=n+1;if(n==1){k=t.title;}}}else if((!t.selected)&&(o.oData[i].initiallySelected)){w.push(g._removeTile(m,i));o.oData[i].initiallySelected=false;j=j+1;if(j==1){l=t.title;}}}if(c.created==true){u=c.newGroupNameInput.getValue().trim();if(c.newGroupNameInput.enabled){if(u.length>0){q=u;}else{q=v;}w.push(g._createGroupAndSaveTile(s,q));n++;k=q;}}jQuery.when.apply(jQuery,w).then(function(){if(!(n==0&&j==0)){var y=false,z=false,E=[];for(i=0;i<arguments.length&&(!y||!z);i++){if(arguments[i].action=="addTileToNewGroup"&&arguments[i].status==1){var t=x.oData[x.oData.length-1],d=sap.ushell.Container.getService("LaunchPage"),r=d.getGroupId(t.object);a.push(r);z=true;}if(!arguments[i].status){y=true;E.push(arguments[i]);}}if(y){var A=sap.ui.getCore().byId("mainShell"),B=g.prepareErrorMessage(E,p.tileTitle),C=A.oDashboardManager;C._resetGroupsOnFailure(B.messageId,B.parameters);}else{s.getModel().setProperty("/catalogTiles/"+p.tileIndex+"/associatedGroups",a);f=g.prepareDetailedMessage(p.tileTitle,n,j,k,l);sap.m.MessageToast.show(f,{duration:3000,width:"15em",my:"center bottom",at:"center bottom",of:window,offset:"0 -50",collision:"fit fit"});}}});P.close();}.bind(o),text:sap.ushell.resources.i18n.getText("okBtn")});return O;},prepareErrorMessage:function(e,t){var g,a,f,F,n=0,N=0,c=false,m;for(var i in e){g=e[i].group;a=e[i].action;if(a=='add'){n++;if(n==1){f=g.title;}}else if(a=='remove'){N++;if(N==1){F=g.title;}}else if(a=='addTileToNewGroup'){n++;if(n==1){f=g.title;}}else{c=true;}}if(c){if(e.length==1){m=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_create_new_group"});}else{m=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_some_actions"});}}else if(e.length==1){if(n){m=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_add_to_group",parameters:[t,f]});}else{m=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_remove_from_group",parameters:[t,F]});}}else{if(N==0){m=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_add_to_several_groups",parameters:[t]});}else if(n==0){m=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_remove_from_several_groups",parameters:[t]});}else{m=sap.ushell.resources.i18n.getText({messageId:"fail_tile_operation_some_actions"});}}return m;},prepareDetailedMessage:function(t,n,a,f,b){var m;if(n==0){if(a==1){m=sap.ushell.resources.i18n.getText("tileRemovedFromSingleGroup",[t,b]);}else if(a>1){m=sap.ushell.resources.i18n.getText("tileRemovedFromSeveralGroups",[t,a]);}}else if(n==1){if(a==0){m=sap.ushell.resources.i18n.getText("tileAddedToSingleGroup",[t,f]);}else if(a==1){m=sap.ushell.resources.i18n.getText("tileAddedToSingleGroupAndRemovedFromSingleGroup",[t,f,b]);}else if(a>1){m=sap.ushell.resources.i18n.getText("tileAddedToSingleGroupAndRemovedFromSeveralGroups",[t,f,a]);}}else if(n>1){if(a==0){m=sap.ushell.resources.i18n.getText("tileAddedToSeveralGroups",[t,n]);}else if(a==1){m=sap.ushell.resources.i18n.getText("tileAddedToSeveralGroupsAndRemovedFromSingleGroup",[t,n,b]);}else if(a>1){m=sap.ushell.resources.i18n.getText("tileAddedToSeveralGroupsAndRemovedFromSeveralGroups",[t,n,a]);}}return m;},createPopoverData:function(e){var s=e.getSource(),S=s.getBindingContext(),a=sap.ushell.Container.getService("LaunchPage"),i,m,p,t,r,u=S.getModel().getProperty("/groups"),c=this.getCatalogTileDataFromModel(S),b=c.tileData.associatedGroups,d=c.tileIndex;for(i=0;i<u.length;i=i+1){r=a.getGroupId(u[i].object);u[i].selected=!($.inArray(r,b)==-1);u[i].initiallySelected=u[i].selected;}p=S.getPath(0);m=S.getModel();t=m.getProperty(p).title;return{userGroupList:u,catalogTile:c,tileTitle:t,tileIndex:d};},getCatalogTileDataFromModel:function(s){var t=s.sPath,a=t.split("/"),b=a[a.length-1];return{tileData:s.getModel().getProperty("/catalogTiles/"+b),tileIndex:b};},onAddTile:function(e){var s=e.getParameter("control").getBindingContext();if(!s.getProperty("active")){this._addTile(s,e.getSource().getBindingContext());}},onNavButtonPress:function(e){var n=sap.ui.getCore().byId("navContainer");if(location.hash===''||location.hash==='#'){n.to("dashboardPage");}else{location.hash='';}},_addTile:function(t,g){var s=sap.ui.getCore().byId("mainShell"),d=s.oDashboardManager,a=jQuery.Deferred(),p=d._createTile({catalogTileContext:t,groupContext:g});p.done(function(b){a.resolve(b);});return a;},_removeTile:function(t,i){var s=sap.ui.getCore().byId("mainShell"),d=s.oDashboardManager,a=jQuery.Deferred(),p=d._deleteCatalogTileFromGroup({tileId:t,groupIndex:i});p.done(function(b){a.resolve(b);});return a;},_createGroupAndSaveTile:function(t,n){var s=sap.ui.getCore().byId("mainShell"),d=s.oDashboardManager,a=jQuery.Deferred(),p=d._createGroupAndSaveTile({catalogTileContext:t,newGroupName:n});p.done(function(b){a.resolve(b);});return a;},_setPopoverContainer:function(c,l,p){var P="popoverContainer",o=new sap.m.ScrollContainer({id:P,horizontal:false,vertical:true});if(!sap.ui.Device.system.phone){o.setHeight((p-2)+"px");}else{o.setHeight("100%");}if(c.created==true){o.addContent(c.newGroupItemList);}o.addContent(l);return o;}});}());
