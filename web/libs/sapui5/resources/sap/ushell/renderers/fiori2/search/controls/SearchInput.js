(function(){"use strict";jQuery.sap.require('sap.m.Input');jQuery.sap.require('sap.ushell.renderers.fiori2.search.SearchHelper');var s=sap.ushell.renderers.fiori2.search.SearchHelper;sap.ushell.Container.getService("Search").getSina();var a=window.sap.bc.ina.api.sina.base;sap.m.Input.extend('sap.ushell.renderers.fiori2.search.controls.SearchInput',{constructor:function(i,o){var t=this;o=jQuery.extend({},{showValueStateMessage:false,showTableSuggestionValueHelp:false,showSuggestion:true,filterSuggests:false,suggestionColumns:[new sap.m.Column({})],placeholder:{path:'/searchTermPlaceholder',mode:sap.ui.model.BindingMode.OneWay},enabled:{parts:[{path:"/initializingObjSearch"}],formatter:function(b){return!b;}}},o);sap.m.Input.prototype.constructor.apply(this,[i,o]);this.addEventDelegate({onsapenter:function(e){if(e.originalEvent&&e.originalEvent.suggestionItemSelected){return;}e.srcControl.getModel().invalidateQuery();t.triggerSearch(e);}});this.bindAggregation("suggestionRows","/suggestions",function(i,c){return t.suggestionItemFactory(i,c);});this.addStyleClass('searchInput');this._bUseDialog=false;this._bFullScreen=false;},renderer:'sap.m.InputRenderer',fireChange:function(e){sap.m.Input.prototype.fireChange.apply(this,arguments);if(sap.ui.Device.system.phone){this.triggerSearch(e);}},onsapenter:function(e){if(this._oSuggestionPopup&&this._oSuggestionPopup.isOpen()){if(this._iPopupListSelectedIndex>=0){e.originalEvent.suggestionItemSelected=true;}}sap.m.Input.prototype.onsapenter.apply(this,arguments);},triggerSearch:function(e){var t=this;this.changeTimer=window.setTimeout(function(){t.changeTimer=null;s.subscribeOnlyOnce('triggerSearch','allSearchFinished',function(){t.getModel().autoStartApp();},t);var b=t.getValue();if(b.trim()===''){b='*';}t.getModel().setSearchBoxTerm(b,false);t.navigateToSearchApp();t.destroySuggestionRows();t.getModel().abortSuggestions();},100);},fireLiveChange:function(){sap.m.Input.prototype.fireLiveChange.apply(this,arguments);var b=this.getValue();var m=this.getModel();m.setSearchBoxTerm(b,false);if(m.getSearchBoxTerm().length>0&&!sap.ui.Device.system.phone){m.doSuggestion();}else{this.destroySuggestionRows();m.abortSuggestions();}},fireSuggestionItemSelected:function(e){sap.m.Input.prototype.fireSuggestionItemSelected.apply(this,arguments);if(this.changeTimer){window.clearTimeout(this.changeTimer);this.changeTimer=null;}this.doHandleSuggestionItemSelected(e);},doHandleSuggestionItemSelected:function(e){var m=this.getModel();var b=m.getSearchBoxTerm();var c=e.selectedRow.getBindingContext().getObject();var d=c.labelRaw;var f=c.dataSource;var t=c.url;var g=c.type;switch(g){case a.SuggestionType.APPS:m.analytics.logCustomEvent('FLP: Search','Suggestion Select App',[c.title,t,b]);m.analytics.logCustomEvent('FLP: Application Launch point','Search Suggestions',[c.title,t,b]);if(t[0]==='#'){window.location.href=t;}else{window.open(t,'_blank');m.setSearchBoxTerm('',false);this.setValue('');this.focus();}break;case a.SuggestionType.DATASOURCE:m.analytics.logCustomEvent('FLP: Search','Suggestion Select Datasource',[f.key,b]);m.setDataSource(f,false);m.setSearchBoxTerm('',false);this.setValue('');this.focus();break;case a.SuggestionType.OBJECTDATA:m.analytics.logCustomEvent('FLP: Search','Suggestion Select Object Data',[d,f.key,b]);m.setDataSource(f,false);m.setSearchBoxTerm(d,false);this.navigateToSearchApp();this.setValue(d);break;case a.SuggestionType.HISTORY:m.analytics.logCustomEvent('FLP: Search','Suggestion Select History',[d,f.key,b]);m.setDataSource(f,false);m.setSearchBoxTerm(d,false);this.navigateToSearchApp();this.setValue(d);break;default:break;}},suggestionItemFactory:function(i,c){var t=this;var b=new sap.m.Label({text:{path:"icon",formatter:function(v){if(v){return"<i>"+sap.ushell.resources.i18n.getText("label_app")+"</i>";}return"";}}}).addStyleClass('suggestText').addStyleClass('suggestNavItem').addStyleClass('suggestListItemCell');b.addEventDelegate({onAfterRendering:function(){s.boldTagUnescaper(this.getDomRef());}},b);var d=new sap.ui.core.Icon({src:"{icon}"}).addStyleClass('suggestIcon').addStyleClass('sapUshellSearchSuggestAppIcon').addStyleClass('suggestListItemCell');var l=new sap.m.Label({text:"{label}"}).addStyleClass('suggestText').addStyleClass('suggestNavItem').addStyleClass('suggestListItemCell');l.addEventDelegate({onAfterRendering:function(){s.boldTagUnescaper(this.getDomRef());}},l);var f=new sap.m.CustomListItem({type:sap.m.ListType.Active,content:[b,d,l]});var g=c.oModel.getProperty(c.sPath);f.getText=function(){return(typeof g.labelRaw)==='string'?g.labelRaw:t.getValue();};var h=new sap.m.ColumnListItem({cells:[f],type:"Active"});if(g.type===a.SuggestionType.APPS){h.addStyleClass('searchAppSuggestion');}if(g.type===a.SuggestionType.DATASOURCE){h.addStyleClass('searchDataSourceSuggestion');}if(g.type===a.SuggestionType.OBJECTDATA){h.addStyleClass('searchBOSuggestion');}if(g.type===a.SuggestionType.HISTORY){h.addStyleClass('searchHistorySuggestion');}h.addStyleClass('searchSuggestion');h.addEventDelegate({onAfterRendering:function(e){var j=h.$().find('.suggestListItemCell');var k=0;j.each(function(m){k+=$(this).outerWidth(true);});if(k>h.$().find('li').get(0).scrollWidth){h.setTooltip($(j[0]).text()+" "+$(j[2]).text());}}});return h;},navigateToSearchApp:function(){if(s.isSearchAppActive()){this.getModel()._firePerspectiveQuery();}else{var h=this.getModel().createSearchURL();window.location.hash=h;}}});})();
