// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(g){"use strict";jQuery.sap.require("sap.ushell.renderers.fiori2.search.controls.SearchLayout");jQuery.sap.require("sap.m.BusyDialog");jQuery.sap.require("sap.ushell.renderers.fiori2.search.controls.SearchResultListContainer");jQuery.sap.require("sap.ushell.renderers.fiori2.search.controls.SearchNoResultScreen");jQuery.sap.require("sap.ushell.renderers.fiori2.search.controls.SearchFacetFilter");jQuery.sap.require("sap.ushell.renderers.fiori2.search.controls.DivContainer");jQuery.sap.require("sap.ushell.renderers.fiori2.search.controls.SearchTilesContainer");jQuery.sap.require("sap.ushell.renderers.fiori2.search.controls.SearchResultList");jQuery.sap.require("sap.ushell.renderers.fiori2.search.controls.SearchResultTable");jQuery.sap.require('sap.ushell.renderers.fiori2.search.SearchHelper');jQuery.sap.require('sap.ushell.renderers.fiori2.search.controls.SearchFilterBar');jQuery.sap.require('sap.ushell.renderers.fiori2.search.controls.SearchLabel');jQuery.sap.require('sap.ushell.renderers.fiori2.search.controls.SearchLink');jQuery.sap.require("sap.ushell.services.Personalization");jQuery.sap.require("sap.m.TablePersoController");jQuery.sap.require('sap.ushell.renderers.fiori2.search.SearchLogger');var S=sap.ushell.renderers.fiori2.search.controls.SearchLayout;var a=sap.ushell.renderers.fiori2.search.controls.SearchResultListContainer;var b=sap.ushell.renderers.fiori2.search.controls.SearchResultList;var c=sap.ushell.renderers.fiori2.search.controls.SearchResultTable;var d=sap.ushell.renderers.fiori2.search.controls.SearchNoResultScreen;var s=sap.ushell.renderers.fiori2.search.SearchHelper;var f=sap.ushell.renderers.fiori2.search.controls.SearchLabel;var h=sap.ushell.renderers.fiori2.search.controls.SearchLink;var j=sap.ushell.renderers.fiori2.search.SearchLogger;sap.ui.jsview("sap.ushell.renderers.fiori2.search.container.Search",{createContent:function(C){var t=this;t.centerAreaHeader=t.assembleCenterAreaHeader();t.centerArea=t.assembleCenterArea();var e=new sap.ushell.renderers.fiori2.search.controls.SearchFilterBar({visible:{parts:[{path:'/facetVisibility'},{path:'/uiFilter/defaultConditionGroup'}],formatter:function(k,l){if(!k&&l&&l.conditions&&l.conditions.length>0){return true;}else{return false;}}}});var i=new sap.m.MessageStrip({text:sap.ushell.resources.i18n.getText('did_you_mean').replace('&1','{/queryFilter/searchTerms}'),showIcon:true,class:'sapUiMediumMarginBottom',visible:{parts:[{path:'/fuzzy'},{path:'/boCount'}],formatter:function(k,l){if(k==true&&l>0){return true;}else{return false;}}}});var r=new a({filterBar:e,centerAreaHeader:t.centerAreaHeader,centerArea:t.centerArea,didYouMeanBar:i,noResultScreen:new d({searchBoxTerm:{parts:[{path:'/queryFilter/searchTerms'}],formatter:function(k){return k;}},visible:{parts:[{path:'/count'},{path:'/isBusy'}],formatter:function(k,l){return k===0&&!l;}}})});t.searchLayout=new S({resultListContainer:r,busyIndicator:new sap.m.BusyDialog(),isBusy:'{/isBusy}',showFacets:'{/facetVisibility}',vertical:false,facets:new sap.ushell.renderers.fiori2.search.controls.SearchFacetFilter()});t.searchContainer=new sap.ushell.renderers.fiori2.search.controls.DivContainer({content:t.searchLayout,cssClass:'sapUshellSearchContainer'});t.oFocusHandler=new s.SearchFocusHandler(t);return t.searchContainer;},assembleCenterAreaHeader:function(){var t=this;var e=t.assembleDataSourceTapStrips();var i=t.assembleDisplaySwitchTapStrips();var k=new sap.m.Button("tablePersonalizeButton",{icon:"sap-icon://action-settings",tooltip:"{i18n>personalizeTable}",type:sap.m.ButtonType.Transparent,visible:{parts:[{path:'/resultToDisplay'}],formatter:function(r){return r==="searchResultTable";}},press:function(m){t.oTablePersoController.openDialog();}});var l=new sap.m.Toolbar({visible:{parts:[{path:'/count'}],formatter:function(m){return m!==0&&!sap.ui.Device.system.phone;}},content:[e,new sap.m.ToolbarSpacer({}),i,k]});l.addStyleClass("ushellSearchCenterAreaHeader");return l;},assembleDataSourceTapStrips:function(){var t=this;var e=new sap.m.OverflowToolbar({design:sap.m.ToolbarDesign.Transparent,visible:{parts:[{path:'/facetVisibility'},{path:'/count'},{path:'/businessObjSearchEnabled'}],formatter:function(i,k,l){return!i&&k>0&&l;}}});e.data("sap-ui-fastnavgroup","false",true);e.addStyleClass('searchTabStrips');t.tabBar=e;e.bindAggregation('content','/tabStrips/strips',function(I,C){return new sap.m.ToggleButton({text:'{labelPlural}',type:{parts:[{path:'/tabStrips/selected'}],formatter:function(i){var m=this.getBindingContext().getObject();if(m.equals(i)===true){return sap.m.ButtonType.Default;}else{return sap.m.ButtonType.Transparent;}}},pressed:{parts:[{path:'/tabStrips/selected'}],formatter:function(i){var m=this.getBindingContext().getObject();return m.equals(i);}},press:function(k){this.setType(sap.m.ButtonType.Default);if(this.getBindingContext().getObject().equals(t.getModel().getProperty('/tabStrips/selected'))){this.setPressed(true);return;}var B=t.tabBar.getContent();for(var i=0;i<B.length;i++){if(B[i].getId()!==this.getId()){B[i].setType(sap.m.ButtonType.Transparent);if(B[i].getPressed()===true){B[i].setPressed(false);}}}t.getModel().setDataSource(this.getBindingContext().getObject());}});});return e;},reorgTabBarSequence:function(){var e=new sap.m.OverflowToolbarLayoutData({priority:sap.m.OverflowToolbarPriority.High});var n=new sap.m.OverflowToolbarLayoutData({priority:sap.m.OverflowToolbarPriority.NeverOverflow});var B=this.tabBar.getContent();for(var i=0;i<B.length;i++){if(this.getModel().getProperty('/tabStrips/selected').equals(B[i].getBindingContext().getObject())){B[i].setLayoutData(n);}else{B[i].setLayoutData(e);}}},assembleDisplaySwitchTapStrips:function(){var t=this;return new sap.m.SegmentedButton('ResultViewType',{selectedKey:{parts:[{path:'/resultToDisplay'}],formatter:function(r){if(r==="searchResultTable"){return"table";}else{return"list";}}},items:[new sap.m.SegmentedButtonItem({icon:"sap-icon://list",tooltip:"{i18n>listView}",key:"list"}),new sap.m.SegmentedButtonItem({icon:"sap-icon://table-view",tooltip:"{i18n>tableView}",key:"table"})],visible:{parts:[{path:'/displaySwitchVisibility'},{path:'/count'}],formatter:function(e,i){return e&&i!==0;}},select:function(e){var k=e.mParameters.key;var m=t.getModel();if(k==="table"){m.setProperty('/resultToDisplay',"searchResultTable");m.resetAndDisableMultiSelection();}else{m.setProperty('/resultToDisplay',"searchResultList");m.enableOrDisableMultiSelection();}}.bind(this)});},assembleCenterArea:function(){var t=this;var e=t.assembleSearchResultList();t.searchResultTable=t.assembleSearchResultTable();t.appSearchResult=t.assembleAppSearch();t.showMoreFooter=t.assembleShowMoreFooter();t.oTablePersoController=new sap.m.TablePersoController({table:sap.ui.getCore().byId("ushell-search-result-table")});return[t.tableSortDialog,e,t.searchResultTable,t.appSearchResult,t.showMoreFooter];},assembleSearchResultSortDialog:function(){var t=this;var e=new sap.m.ViewSettingsDialog({sortDescending:{parts:[{path:"/orderBy"}],formatter:function(o){return jQuery.isEmptyObject(o)||o.sortOrder==="DESC";}},confirm:function(i){var p=[];p=i.getParameters();if(p.sortItem){var C=t.getModel();if(p.sortItem.getKey()==="ushellSearchDefaultSortItem"){C.resetOrderBy();e.setSortDescending(true);}else{C.setOrderBy({orderBy:p.sortItem.getKey(),sortOrder:p.sortDescending===true?"DESC":"ASC"});}}}});e.bindAggregation("sortItems","/tableSortItems",function(p,D){return new sap.m.ViewSettingsItem({key:"{key}",text:"{name}",selected:"{selected}"});});return e;},assembleSearchResultTable:function(){var t=this;var r=new c("ushell-search-result-table",{visible:{parts:[{path:'/resultToDisplay'},{path:'/count'}],formatter:function(e,i){return e==="searchResultTable"&&i!==0;}}});r.bindAggregation("columns","/tableColumns",function(p,D){var e=D.getObject();var i=new sap.m.Column(e.key,{header:new sap.m.Label({text:"{name}",tooltip:"{name}"}),visible:{parts:[{path:'index'}],formatter:function(k){return k<4;}}});return i;});r.bindAggregation("items","/results",function(p,D){return t.assembleTableItems(D);});return r;},assembleTableItems:function(D){var t=this;var o=D.getObject();if(o.type==='footer'){t.showMoreFooter.setVisible(true);return new sap.m.CustomListItem();}else{return t.assembleTableMainItems(o,D.getPath());}},assembleTableMainItems:function(D,p){var e=p+"/itemattributes";var i=new sap.m.ColumnListItem();i.bindAggregation("cells",e,function(e,k){if(k.getObject().isTitle){return new h({text:"{value}",href:"{uri}",enabled:{parts:[{path:'uri'}],formatter:function(u){return u?true:false;}},press:function(){var t=k.getObject().uri?k.getObject().uri:"";var n=new j.NavigationEvent();n.addUserHistoryEntry(t);var m=sap.ushell.renderers.fiori2.search.getModelSingleton();m.analytics.logCustomEvent('FLP: Search','Launch Object',[t]);}}).addStyleClass("sapUshellSearchResultListItem-MightOverflow");}else{return new f({text:"{value}"}).addStyleClass("sapUshellSearchResultListItem-MightOverflow");}});return i;},assembleShowMoreFooter:function(){var t=this;var e=new sap.m.Button({text:"{i18n>showMore}",type:sap.m.ButtonType.Transparent,press:function(){var C=t.getModel();C.setProperty('/focusIndex',C.getTop());var n=C.getTop()+C.pageSize;C.setTop(n);}});e.addStyleClass('sapUshellResultListMoreFooter');var i=new sap.m.FlexBox({visible:false,justifyContent:sap.m.FlexJustifyContent.Center});i.addStyleClass('sapUshellResultListMoreFooterContainer');i.addItem(e);return i;},assembleSearchResultList:function(){var t=this;t.resultList=new b({mode:sap.m.ListMode.None,width:"auto",showNoData:false,visible:{parts:[{path:'/resultToDisplay'},{path:'/count'}],formatter:function(r,e){return r==="searchResultList"&&e!==0;}}});t.resultList.bindAggregation("items","/results",function(p,C){return t.assembleListItem(C);});return t.resultList;},assembleAppSearch:function(){var t=this;var e=new sap.ushell.renderers.fiori2.search.controls.SearchTilesContainer({maxRows:99999,totalLength:'{/appCount}',visible:{parts:[{path:'/resultToDisplay'},{path:'/count'}],formatter:function(r,i){return r==="appSearchResult"&&i!==0;}},highlightTerms:'{/uiFilter/searchTerms}',showMore:function(){var m=t.getModel();m.setProperty('/focusIndex',e.getNumberDisplayedTiles()-1);var n=m.getTop()+m.pageSize*e.getTilesPerRow();m.setTop(n);}});e.bindAggregation('tiles','/appResults',function(i,C){return t.getTileView(C.getObject().tile);});e.addStyleClass('sapUshellSearchTileResultList');sap.ui.getCore().getEventBus().subscribe('searchLayoutChanged',function(){e.delayedRerender();},this);return e;},assembleTitleItem:function(D){var i=new sap.m.CustomListItem();var t=new sap.m.Label({text:"{title}"});t.addStyleClass('bucketTitle');i.addStyleClass('bucketTitleContainer');i.addContent(new sap.m.HBox({items:[t]}));return i;},assembleAppContainerResultListItem:function(D,p){var t=this;var e=new sap.ushell.renderers.fiori2.search.controls.SearchTilesContainer({maxRows:sap.ui.Device.system.phone?2:1,totalLength:'{/appCount}',highlightTerms:'{/uiFilter/searchTerms}',enableKeyHandler:false,resultList:t.resultList,showMore:function(){var m=t.getModel();m.setDataSource(m.appDataSource);}});e.bindAggregation('tiles','tiles',function(i,C){return t.getTileView(C.getObject().tile);});var l=new sap.m.CustomListItem({content:e});l.addStyleClass('sapUshellSearchResultListItem');l.addStyleClass('sapUshellSearchResultListItemApps');l.addEventDelegate({onAfterRendering:function(E){var i=$(l.getDomRef());i.removeAttr("tabindex");i.removeAttr("role");}},l);sap.ui.getCore().getEventBus().subscribe('searchLayoutChanged',function(){e.delayedRerender();},this);return l;},assembleResultListItem:function(D,p){var e=this.getModel().config.getDataSourceConfig(D.dataSource);var i=new e.searchResultListItemControl({title:"{$$Name$$}",titleUrl:"{uri}",titleUrlIsIntent:"{titleUriIsIntent}",type:"{dataSource/label}",imageUrl:"{imageUrl}",data:D,path:p,selected:"{selected}",expanded:"{expanded}"});var l=new sap.m.CustomListItem({content:i});l.addStyleClass('sapUshellSearchResultListItem');return l;},assembleListItem:function(C){var t=this;var D=C.getObject();if(D.type==='title'){return t.assembleTitleItem(D);}else if(D.type==='footer'){t.showMoreFooter.setVisible(true);return new sap.m.CustomListItem();}else if(D.type==='appcontainer'){return t.assembleAppContainerResultListItem(D,C.getPath());}else{return t.assembleResultListItem(D,C.getPath());}},getTileView:function(t){try{var i=t.getContract('types');i.setType('tile');}catch(e){}var v=sap.ushell.Container.getService('LaunchPage').getCatalogTileView(t);if(t.getTitle){v.usageAnalyticsTitle=t.getTitle();}else{v.usageAnalyticsTitle='app';}return v;},onAllSearchStarted:function(){this.showMoreFooter.setVisible(false);},onAllSearchFinished:function(){var t=this;t.reorgTabBarSequence();t.oFocusHandler.setFocus();var m=t.getModel();var e=m.getDataSource().key;var n=m.getPersoServiceProvider(e);if(n===undefined){n=m.buildPersoServiceProvider(e);m.pushPersoServiceProvider(n);}if(t.oldPersoServiceProvider===undefined||t.oldPersoServiceProvider.key!==n.key){t.oTablePersoController.destroy();t.oTablePersoController=new sap.m.TablePersoController({table:sap.ui.getCore().byId("ushell-search-result-table"),persoService:n.provider}).activate();t.oldPersoServiceProvider=n;}},setAppView:function(A){var t=this;t.oAppView=A;if(t.oTilesContainer){t.oTilesContainer.setAppView(A);}},getControllerName:function(){return"sap.ushell.renderers.fiori2.search.container.Search";}});}(window));
