// Copyright (c) 2009-2014 SAP SE, All Rights Reserved
(function(){"use strict";jQuery.sap.require("sap.ushell.ui.launchpad.TileContainer");sap.ui.controller("sap.ushell.renderers.fiori2.launchpad.dashboard.DashboardContent",{onInit:function(){var e=sap.ui.getCore().getEventBus();e.subscribe('launchpad','actionModeInactive',this._handleExitActionMode,this);e.subscribe('launchpad','actionModeActive',this._enableGroupsUIActions,this.oView);window.document.addEventListener("visibilitychange",sap.ushell.utils.handleTilesVisibility,false);this.sViewId="#"+this.oView.getId();if(sap.ui.Device.browser.mobile){e.subscribe("launchpad","contentRefresh",this._webkitMobileRenderFix,this);}this.isDesktop=(sap.ui.Device.system.desktop&&(navigator.userAgent.toLowerCase().indexOf('tablet')<0));},onExit:function(){sap.ui.getCore().getEventBus().unsubscribe("launchpad","contentRefresh",this._webkitMobileRenderFix,this);window.document.removeEventListener("visibilitychange",sap.ushell.utils.handleTilesVisibility,false);},onAfterRendering:function(){var e=sap.ui.getCore().getEventBus();e.unsubscribe("launchpad","scrollToGroup",this._scrollToGroup,this);e.subscribe("launchpad","scrollToGroup",this._scrollToGroup,this);e.unsubscribe("launchpad","scrollToFirstVisibleGroup",this._scrollToFirstVisibleGroup,this);e.subscribe("launchpad","scrollToFirstVisibleGroup",this._scrollToFirstVisibleGroup,this);if(sap.ui.Device.os.android){e.unsubscribe("launchpad","changeGroupTitle",this._changeGroupTitleHandler,this);e.subscribe("launchpad","changeGroupTitle",this._changeGroupTitleHandler,this);}jQuery("#__area0").appendTo("#shellPage");var t;jQuery(window).bind("resize",function(){clearTimeout(t);t=setTimeout(this._resizeHandler.bind(this),300);}.bind(this));jQuery("#dashboard").scroll(sap.ushell.utils.handleTilesVisibility);},_changeGroupTitleHandler:function(){this._forceBrowserRerenderElement(document.getElementById('groupList'));},_handleClick:function(){if(sap.ui.Device.system.desktop){jQuery('body').removeClass("sapUshellDisableUserSelect");}},_handleActionModeStartDrag:function(e,u){this.uiActions.disable();var t=jQuery(".sapUshellDashboardGroupsContainerItem-clone .sapUshellContainerTitle").height();if(!sap.ui.Device.system.phone){var a=jQuery(".sapUshellDashboardGroupsContainerItem-clone .sapUshellContainerTitle").width();jQuery(".sapUshellDashboardGroupsContainerItem.sapUshellDashboardGroupsContainerItem-clone .tileContainerEditMode").offset({top:this.uiEditModeActions.startY-t,left:this.uiEditModeActions.startX-(a/2)-16});jQuery(".sapUshellTileContainerBeforeContent").addClass("sapUshellTileContainerHidden");jQuery(".sapUshellDashboardGroupsContainerItem.sapUshellDashboardGroupsContainerItem-clone .sapUshellContainerTitle").css("width",a+"px");}else{jQuery(".sapUshellTilesContainer-sortable").addClass("sapUshellTileContainerRemoveContent");jQuery(".sapUshellTileContainerBeforeContent").addClass("sapUshellTileContainerRemoveContent");jQuery(".sapUshellContainerHeaderActions").addClass("sapUshellTileContainerHidden");}jQuery(u).find(".sapUshellContainerHeaderActions").addClass("sapUshellTileContainerHidden");sap.ui.getCore().byId("shell").getModel().setProperty('/isInDrag',true);jQuery(u).attr('startPos',jQuery(u).index());window.console.log('startPos - '+jQuery(u).index());setTimeout(function(){sap.ui.getCore().getEventBus().publish("launchpad","sortableStart");},0);var g=jQuery("#dashboardGroups").offset().top,b=jQuery(".sapUshellDashboardGroupsContainerItem-placeholder").offset().top,c=jQuery(".sapUshellDashboardGroupsContainerItem-clone").offset().top,s=b-g-c;jQuery('#dashboard').animate({scrollTop:s},0);},_handleActionModeUIStart:function(e,u){jQuery(u).find(".sapUshellTileContainerContent").css("outline-color","transparent");jQuery('body').addClass("sapUshellDisableUserSelect");},_handleActionModeDrop:function(e,u){if(sap.ui.Device.system.desktop){jQuery('body').removeClass("sapUshellDisableUserSelect");}var b=sap.ui.getCore().getEventBus(),q=jQuery(u),f=jQuery(q.children()[0]).attr("id"),g=sap.ui.getCore().byId(f),d=sap.ui.getCore().byId("dashboardGroups"),D={group:g,groupChanged:false,focus:false},n=q.index();q.startPos=window.parseInt(q.attr('startPos'),10);d.removeAggregation('groups',g,true);d.insertAggregation('groups',g,n,true);this.oController._handleActionModeGroupMove(e,{item:q});q.removeAttr('startPos');sap.ui.getCore().getEventBus().publish("launchpad","sortableStop");setTimeout(function(){jQuery(".sapUshellContainerHeaderActions").removeClass("sapUshellTileContainerHidden");jQuery(".sapUshellTileContainerBeforeContent").removeClass("sapUshellTileContainerHidden");jQuery(".sapUshellTileContainerBeforeContent").removeClass("sapUshellTileContainerRemoveContent");jQuery(".sapUshellTilesContainer-sortable").removeClass("sapUshellTileContainerRemoveContent");},0);window.setTimeout(jQuery.proxy(b.publish,b,"launchpad","scrollToGroup",D),1);this.uiActions.enable();},_handleActionModeGroupMove:function(e,u){var f=u.item.startPos,t=u.item.index();if(t!==-1){this._publishAsync("launchpad","moveGroup",{fromIndex:f,toIndex:t});setTimeout(function(){sap.ui.getCore().byId("shell").getModel().setProperty('/isInDrag',false);},100);}},_handleGroupDeletion:function(g){jQuery.sap.require('sap.m.MessageBox');var e=sap.ui.getCore().getEventBus(),G=g.getObject(),i=G.removable,s=G.title,a=G.groupId,r=sap.ushell.resources.i18n,m=sap.ushell.Container.getService("Message"),A=sap.m.MessageBox.Action,c=(i?A.DELETE:r.getText('ResetGroupBtn'));m.confirm(r.getText(i?'delete_group_msg':'reset_group_msg',s),function(o){if(o===c){e.publish("launchpad",i?'deleteGroup':'resetGroup',{groupId:a});}},r.getText(i?'delete_group':'reset_group'),[c,A.CANCEL]);},_enableGroupsUIActions:function(){this.uiEditModeActions.enable();},_handleExitActionMode:function(c){this.oView.uiEditModeActions.disable();},_forceBrowserRerenderElement:function(e){var a=window.requestAnimationFrame||window.webkitRequestAnimationFrame;if(a){a(function(){var d=e.style.display;e.style.display='none';e.offsetHeight;e.style.display=d;});}else{window.console.log('unsupported browser for animation frame');}},_webkitMobileRenderFix:function(){if(sap.ui.Device.browser.chrome||sap.ui.Device.os.android){this._forceBrowserRerenderElement(document.body);}},_resizeHandler:function(){var c=this.getView().getModel().getProperty("/currentState");this._addBottomSpace();sap.ushell.utils.handleTilesVisibility();if(sap.ushell.Layout&&c.stateName==="home"){sap.ushell.Layout.reRenderGroupsLayout(null,true);}},_addBottomSpace:function(){sap.ushell.utils.addBottomSpace();},_scrollToFirstVisibleGroup:function(c,e,d){var g,f=0,t=this;if(d.group){g=d.group.getGroupId();}else{g=d.groupId;}if(d.fromTop){f=d.fromTop-50;}jQuery.each(this.oView.oDashboardGroupsBox.getGroups(),function(n,G){if(G.getGroupId()===g){var y;y=-1*(document.getElementById('dashboardGroups').getBoundingClientRect().top)+document.getElementById(G.sId).getBoundingClientRect().top;jQuery('#dashboard').animate({scrollTop:y-f},0,t.fHandleScrollEnd);if(d.group&&d.focus){jQuery.sap.byId(G.sId).focus();}return false;}});sap.ushell.utils.addBottomSpace();},_scrollToGroup:function(c,e,d){var g,t=this;if(d.group){g=d.group.getGroupId();}else{g=d.groupId;}jQuery.each(this.oView.oDashboardGroupsBox.getGroups(),function(n,G){if(G.getGroupId()===g){var y;y=-1*(document.getElementById('dashboardGroups').getBoundingClientRect().top)+document.getElementById(G.sId).getBoundingClientRect().top;jQuery('#dashboard').animate({scrollTop:y},500,t.fHandleScrollEnd);if(d.group&&d.focus){jQuery.sap.byId(G.sId).focus();}if(d.groupId||d.groupChanged){t._addBottomSpace();}jQuery('#groupList li').removeClass('sapUshellSelected').eq(n).addClass('sapUshellSelected');sap.ushell.utils.handleTilesVisibility();return false;}});},fHandleScrollEnd:function(){var e=sap.ui.getCore().getEventBus();e.publish("grouplist","ScrollAnimationEnd");},_handleDrop:function(e,u){if(sap.ui.Device.system.desktop){jQuery('body').removeClass("sapUshellDisableUserSelect");}var t=sap.ushell.Layout.getLayoutEngine().layoutEndCallback();var E=sap.ui.getCore().getEventBus();if(!t.tileMovedFlag){return;}var n=true,a=true;if((t.srcGroup!==t.dstGroup)){n=a=false;}else if(t.tile!==t.dstGroup.getTiles()[t.dstTileIndex]){a=false;}t.srcGroup.removeAggregation('tiles',t.tile,n);t.dstGroup.insertAggregation('tiles',t.tile,t.dstTileIndex,a);E.publish("launchpad","moveTile",{sTileId:t.tile.getUuid(),toGroupId:t.dstGroup.getGroupId(),toIndex:t.dstTileIndex});E.publish("launchpad","sortableStop");},_publishAsync:function(c,e,d){var b=sap.ui.getCore().getEventBus();window.setTimeout(jQuery.proxy(b.publish,b,c,e,d),1);}});}());
