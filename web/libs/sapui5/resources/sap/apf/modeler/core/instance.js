/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
jQuery.sap.declare("sap.apf.modeler.core.instance");(function(){'use strict';jQuery.sap.require("sap.ui.thirdparty.datajs");jQuery.sap.require("sap.apf.utils.hashtable");jQuery.sap.require('sap.apf.core.constants');jQuery.sap.require('sap.apf.core.messageHandler');jQuery.sap.require('sap.apf.core.sessionHandler');jQuery.sap.require('sap.apf.core.representationTypes');jQuery.sap.require("sap.apf.core.entityTypeMetadata");jQuery.sap.require("sap.apf.core.configurationFactory");jQuery.sap.require("sap.apf.core.utils.uriGenerator");jQuery.sap.require("sap.apf.core.metadata");jQuery.sap.require("sap.apf.core.metadataFacade");jQuery.sap.require("sap.apf.core.metadataProperty");jQuery.sap.require('sap.apf.core.messageDefinition');jQuery.sap.require("sap.apf.core.metadataFactory");jQuery.sap.require('sap.apf.core.odataProxy');jQuery.sap.require('sap.apf.core.ajax');jQuery.sap.require('sap.apf.core.odataRequest');jQuery.sap.require('sap.apf.modeler.core.messageDefinition');jQuery.sap.require('sap.apf.modeler.core.textHandler');jQuery.sap.require('sap.apf.modeler.core.textPool');jQuery.sap.require('sap.apf.modeler.core.applicationHandler');jQuery.sap.require('sap.apf.modeler.core.configurationHandler');jQuery.sap.require('sap.apf.modeler.core.configurationEditor');jQuery.sap.require("sap.apf.modeler.core.step");jQuery.sap.require("sap.apf.modeler.core.smartFilterBar");jQuery.sap.require("sap.apf.modeler.core.facetFilter");jQuery.sap.require("sap.apf.modeler.core.navigationTarget");jQuery.sap.require("sap.apf.modeler.core.elementContainer");jQuery.sap.require("sap.apf.modeler.core.representation");jQuery.sap.require("sap.apf.modeler.core.configurationObjects");jQuery.sap.require("sap.apf.modeler.core.elementContainer");jQuery.sap.require("sap.apf.utils.parseTextPropertyFile");jQuery.sap.require("sap.apf.modeler.core.lazyLoader");jQuery.sap.require("sap.apf.modeler.core.registryWrapper");jQuery.sap.require("sap.apf.utils.startParameter");jQuery.sap.require("sap.apf.core.utils.fileExists");jQuery.sap.require("sap.apf.core.utils.annotationHandler");sap.apf.modeler.core.Instance=function(p,a){var t=this;var A,C,b,c,d,S,e,F,N,R,E,H,f,M,g,h,j,k,L,l,m,n,o,s,q,r,u,v,w,x,O,y,z,B,D,G,I;var J=[];var K;var P;A=(a&&a.constructors&&a.constructors.ApplicationHandler)||sap.apf.modeler.core.ApplicationHandler;C=(a&&a.constructors&&a.constructors.ConfigurationHandler)||sap.apf.modeler.core.ConfigurationHandler;b=(a&&a.constructors&&a.constructors.ConfigurationEditor)||sap.apf.modeler.core.ConfigurationEditor;c=(a&&a.constructors&&a.constructors.ConfigurationObjects)||sap.apf.modeler.core.ConfigurationObjects;d=(a&&a.constructors&&a.constructors.ConfigurationFactory)||sap.apf.core.ConfigurationFactory;E=(a&&a.constructors&&a.constructors.ElementContainer)||sap.apf.modeler.core.ElementContainer;S=(a&&a.constructors&&a.constructors.Step)||sap.apf.modeler.core.Step;e=(a&&a.constructors&&a.constructors.SmartFilterBar)||sap.apf.modeler.core.SmartFilterBar;F=(a&&a.constructors&&a.constructors.FacetFilter)||sap.apf.modeler.core.FacetFilter;N=(a&&a.constructors&&a.constructors.NavigationTarget)||sap.apf.modeler.core.NavigationTarget;R=(a&&a.constructors&&a.constructors.Representation)||sap.apf.modeler.core.Representation;H=(a&&a.constructors&&a.constructors.Hashtable)||sap.apf.utils.Hashtable;f=(a&&a.constructors&&a.constructors.RegistryProbe)||sap.apf.modeler.core.RegistryWrapper;L=(a&&a.constructors&&a.constructors.LazyLoader)||sap.apf.modeler.core.LazyLoader;M=(a&&a.constructors&&a.constructors.Metadata)||sap.apf.core.Metadata;g=(a&&a.constructors&&a.constructors.EntityTypeMetadata)||sap.apf.core.EntityTypeMetadata;h=(a&&a.constructors&&a.constructors.MetadataFacade)||sap.apf.core.MetadataFacade;j=(a&&a.constructors&&a.constructors.MetadataProperty)||sap.apf.core.MetadataProperty;k=(a&&a.constructors&&a.constructors.MetadataFactory)||sap.apf.core.MetadataFactory;l=(a&&a.constructors&&a.constructors.StartParameter)||sap.apf.utils.StartParameter;m=(a&&a.constructors&&a.constructors.AnnotationHandler)||sap.apf.core.utils.AnnotationHandler;P=(a&&a.instances&&a.instances.datajs)||OData;if(a&&a.constructors&&a.constructors.TextHandler){n=new a.constructors.TextHandler();}else{n=new sap.apf.modeler.core.TextHandler();}if(a&&a.constructors&&a.constructors.MessageHandler){o=new a.constructors.MessageHandler(true);}else{o=new sap.apf.core.MessageHandler(true);}o.setTextResourceHandler(n);o.loadConfig(sap.apf.core.messageDefinition);o.loadConfig(sap.apf.modeler.core.messageDefinition);o.activateOnErrorHandling(true);if(a&&a.instances&&a.instances.component){I={};I.baseManifest=sap.apf.modeler.Component.prototype.getMetadata().getManifest();I.manifest=jQuery.extend({},true,a.instances.component.getMetadata().getManifest());}q=new l(a&&a.instances&&a.instances.component,I);this.getStartParameterFacade=function(){return q;};v={instances:{messageHandler:o,coreApi:this}};if(a&&a.constructors&&a.constructors.PersistenceProxy){r=new a.constructors.PersistenceProxy(p,v);}else{r=new sap.apf.core.OdataProxy(p,v);}if(a&&a.constructors&&a.constructors.SessionHandler){s=new a.constructors.SessionHandler(v);}else{s=new sap.apf.core.SessionHandler(v);}this.ajax=function(i){var W=jQuery.extend(true,{},i);if(a&&a.functions&&a.functions.ajax){W.functions={ajax:a.functions.ajax};}W.instances={messageHandler:o};return sap.apf.core.ajax(W);};var Q={functions:{getComponentNameFromManifest:sap.apf.utils.getComponentNameFromManifest,getODataPath:sap.apf.core.utils.uriGenerator.getODataPath,getBaseURLOfComponent:sap.apf.core.utils.uriGenerator.getBaseURLOfComponent,addRelativeToAbsoluteURL:sap.apf.core.utils.uriGenerator.addRelativeToAbsoluteURL},instances:{fileExists:new sap.apf.core.utils.FileExists({functions:{ajax:this.ajax}})}};var T=new m(Q);w={constructors:{EntityTypeMetadata:g,Hashtable:H,Metadata:M,MetadataFacade:h,MetadataProperty:j},instances:{messageHandler:o,coreApi:t,configurationFactory:{getServiceDocuments:function(){return[p.serviceRoot];}},annotationHandler:T},datajs:OData,deactivateFatalError:true};u=new sap.apf.core.MetadataFactory(w);x={constructors:{Hashtable:H},instances:{messageHandler:o}};this.getCatalogServiceUri=a&&a.functions&&a.functions.getCatalogServiceUri;O=(a&&a.functions&&a.functions.odataRequestWrapper)||sap.apf.core.odataRequestWrapper;this.odataRequest=function(i,W,X,Y){var Z={instances:{datajs:P}};O(Z,i,W,X,Y);};this.checkForTimeout=function(i){var W=sap.apf.core.utils.checkForTimeout(i);if(W){o.putMessage(W);}return W;};this.getEntityTypeMetadata=function(i,W){return u.getEntityTypeMetadata(i,W);};this.getXsrfToken=function(i){return s.getXsrfToken(i);};this.getUriGenerator=function(){return sap.apf.core.utils.uriGenerator;};this.getText=function(i,W){return n.getText(i,W);};this.putMessage=function(i){return o.putMessage(i);};this.check=function(i,W,X){return o.check(i,W,X);};this.createMessageObject=function(i){return o.createMessageObject(i);};this.setCallbackForMessageHandling=function(i){o.setMessageCallback(i);};this.importConfigurationFromLrep=function(W,X,Y,Z){var $;r.readAllConfigurationsFromVendorLayer().then(function(f1){var g1=W+'.'+X;var i;for(i=0;i<f1.length;i++){if(f1[i].value===g1){$=f1[i].applicationText;break;}}t.getApplicationHandler(_);});function _(i,f1){if(f1){Z(undefined,undefined,f1);return;}var g1=false;var h1=i.getApplication(W);if(!h1){g1=true;}var i1={ApplicationName:$};i.setAndSave(i1,a1,W,g1);}function a1(i,f1,g1){if(g1){Z(X,undefined,g1);return;}b1();}function b1(){var i=new sap.apf.core.utils.Filter(o,'Language','eq',sap.apf.core.constants.developmentLanguage);var f1=new sap.apf.core.utils.Filter(o,'Application','eq',W);f1.addAnd(i);r.readCollection("texts",c1,undefined,undefined,f1,true,{layer:"VENDOR"});}function c1(i,f1,g1){if(g1){Z(X,undefined,g1);return;}U(i,W,d1);}function d1(i){if(i){Z(X,undefined,i);return;}r.readEntity("configuration",e1,[{value:X}],undefined,true,W,{layer:"VENDOR"});}function e1(i,f1,g1){if(g1){Z(undefined,f1,g1);return;}var h1=JSON.parse(i.SerializedAnalyticalConfiguration);V(h1,Y,Z);}};function U(i,W,X){t.getApplicationHandler(Z);function Y($,_,a1){var b1;var c1;if(a1){X(a1);}else{b1={instances:{messageHandler:o,persistenceProxy:r},constructors:{Hashtable:H}};c1=new sap.apf.modeler.core.TextPool(b1,W,$);c1.addTextsAndSave(i,X,W);}}function Z($,_){if(_){X(_);return;}var a1;var b1=$.getApplication(W);if(!b1){a1=o.createMessageObject({code:11021});X(a1);return;}if(B&&B.getId()===W){B.getInstance().getTextPool().addTextsAndSave(i,X,W);}else{var c1=new sap.apf.core.utils.Filter(o,'Application','eq',W);var d1=new sap.apf.core.utils.Filter(o,'Language','eq',sap.apf.core.constants.developmentLanguage);d1.addAnd(c1);r.readCollection("texts",Y,undefined,undefined,d1,true);}}}this.importTexts=function(W,X){var Y;var Z;var i;var $=sap.apf.utils.parseTextPropertyFile(W,{instances:{messageHandler:o}});if($.Messages.length>0){Y=o.createMessageObject({code:11020});Z=$.Messages.length;for(i=0;i<Z-1;i++){$.Messages[i+1].setPrevious($.Messages[i]);}Y.setPrevious($.Messages[Z-1]);X(Y);}else{U($.TextElements,$.Application,X);}};function V(i,W,X){var Y=i.configHeader;t.getApplicationHandler(Z);function Z(b1,c1){if(c1){X(undefined,undefined,c1);return;}var d1=false;var e1=b1.getList();e1.forEach(function(g1){if(g1.Application===Y.Application){d1=true;}});if(d1){t.getConfigurationHandler(Y.Application,_);}else{var f1={ApplicationName:Y.ApplicationName,SemanticObject:Y.SemanticObject};b1.setAndSave(f1,$,Y.Application,true);}}function $(b1,c1,d1){if(d1){X(undefined,undefined,d1);return;}t.getConfigurationHandler(Y.Application,_);}function _(b1,c1){if(c1){X(undefined,undefined,c1);return;}var d1=jQuery.extend({},i,true);delete d1.configHeader;var e1=false;var f1=b1.getList();f1.forEach(function(j1){if(j1.AnalyticalConfiguration===Y.AnalyticalConfiguration){e1=true;}});if(e1){W(h1,i1,Y.AnalyticalConfigurationName);}else{b1.setConfiguration({AnalyticalConfigurationName:Y.AnalyticalConfigurationName},Y.AnalyticalConfiguration);var g1={id:Y.AnalyticalConfiguration,creationDate:Y.CreationUTCDateTime,lastChangeDate:Y.LastChangeUTCDateTime,content:d1};b1.loadConfiguration(g1,a1);}function h1(){b1.setConfiguration({AnalyticalConfigurationName:Y.AnalyticalConfigurationName},Y.AnalyticalConfiguration);var g1={updateExisting:true,id:Y.AnalyticalConfiguration,creationDate:Y.CreationUTCDateTime,lastChangeDate:Y.LastChangeUTCDateTime,content:d1};b1.loadConfiguration(g1,a1);}function i1(j1){if(j1&&j1!==""){Y.AnalyticalConfigurationName=j1;}var k1=b1.setConfiguration({AnalyticalConfigurationName:Y.AnalyticalConfigurationName});var l1={id:k1,content:d1};b1.loadConfiguration(l1,a1);}}function a1(b1,c1){if(c1){X(undefined,undefined,c1);return;}b1.save(X);}}this.importConfiguration=function(i,W,X){var Y=JSON.parse(i);if(!Z(Y,X)){return;}V(Y,W,X);function Z(Y,X){var $=[],_=true,a1;if(!sap.apf.utils.isValidGuid(Y.configHeader.Application)){$.push(o.createMessageObject({code:11037,aParameters:[Y.configHeader.Application]}));_=false;}if(!sap.apf.utils.isValidGuid(Y.configHeader.AnalyticalConfiguration)){$.push(o.createMessageObject({code:11038,aParameters:[Y.configHeader.AnalyticalConfiguration]}));_=false;}a1=sap.apf.modeler.core.ConfigurationObjects.getTextKeysFromConfiguration(Y);a1.forEach(function(b1){var c1=new H(o);if(!c1.hasItem(b1)){c1.setItem(b1,b1);if(!sap.apf.utils.isValidGuid(b1)){$.push(o.createMessageObject({code:11039,aParameters:[b1]}));_=false;}}});if(_){return _;}$.forEach(function(b1,c1,$){if(c1){b1.setPrevious($[c1-1]);}});X(i,undefined,$[$.length-1]);return _;}};this.getApplicationHandler=function(i){if(!z){var W=(a&&a.functions&&a.functions.loadApplicationHandler)||X;z=new L(x,W);}z.asyncGetInstance("ApplicationHandlerId",i);function X(Y,Z){new A({instances:{messageHandler:o,persistenceProxy:r},constructors:{Hashtable:H},functions:{resetConfigurationHandler:_}},$);function $(a1,b1){Z(Y,a1,b1);}function _(a1){if(B&&B.getId()===a1){B.getInstance().removeAllConfigurations();B.reset();}}}};this.getConfigurationHandler=function(i,W){if(!B){y=(a&&a.functions&&a.functions.loadConfigurationHandler)||X;B=new L(x,y);}B.asyncGetInstance(i,W);function X(i,Y,Z){var $=new sap.apf.core.utils.Filter(o,'Application','eq',i);var _=new sap.apf.core.utils.Filter(o,'Language','eq',sap.apf.core.constants.developmentLanguage);_.addAnd($);var a1=[];var b1=["AnalyticalConfiguration","AnalyticalConfigurationName","Application","CreatedByUser","CreationUTCDateTime","LastChangeUTCDateTime","LastChangedByUser"];a1.push({entitySetName:"configuration",filter:$,selectList:b1});a1.push({entitySetName:'texts',filter:_});r.readCollectionsInBatch(a1,c1,true);function c1(d1,e1){var f1,g1;var h1;var i1;var j1=Z;if(e1){Y(i,undefined,e1);}else{h1=d1[0];i1=d1[1];g1={instances:{messageHandler:o,persistenceProxy:r},constructors:{Hashtable:H}};f1=new sap.apf.modeler.core.TextPool(g1,i,i1);if(!j1){j1=new C({instances:{messageHandler:o,persistenceProxy:r,datajs:OData,coreApi:t,metadataFactory:u},constructors:{ConfigurationEditor:b,ConfigurationFactory:d,ConfigurationObjects:c,ElementContainer:E,EntityTypeMetadata:g,SmartFilterBar:e,FacetFilter:F,NavigationTarget:N,Hashtable:H,Representation:R,RegistryProbe:f,Step:S,LazyLoader:L},functions:{getApplication:z.getInstance().getApplication}});}j1.setApplicationIdAndContext(i,h1,f1);Y(i,j1,e1);}}}};this.getUnusedTextKeys=function(i,W){var X={instances:{messageHandler:o,persistenceProxy:r},constructors:{Hashtable:H}};var Y=new c(X);var Z=null,$=null,_=null;Y.getTextKeysFromAllConfigurations(i,function(b1,c1){if($){return;}Z=b1;$=c1;if(c1||_){a1();}});this.getConfigurationHandler(i,function(b1,c1){if($){return;}_=b1;$=c1;if(c1||Z){a1();}});function a1(){var b1=[];if($){W(undefined,$);return;}_.getTextPool().getTextKeys().forEach(function(c1){if(!Z.hasItem(c1)){b1.push(c1);}});W(b1,undefined);}};this.resetConfigurationHandler=function(){if(B){B.reset();}};this.getRepresentationTypes=function(){var i=sap.apf.core.representationTypes();var W=[];jQuery.extend(true,W,i);return W;};this.getAllAvailableSemanticObjects=function(i){if(G){i(G,K);return;}if(K){i([],K);return;}J.push(i);if(J.length===1){var W={requestUri:"/sap/opu/odata/UI2/INTEROP/SemanticObjects?$format=json&$select=id,text",method:"GET"};t.odataRequest(W,X,Y);}function X(Z,$){G=Z.results;J.forEach(function(_){_(Z.results,undefined);});}function Y(Z){var $;if(Z&&Z.messageObject){$=Z.messageObject;}else{$=o.createMessageObject({code:"11041"});}K=$;J.forEach(function(_){_([],$);});}};this.getSemanticActions=function(W){var X;var Y=jQuery.Deferred();if(!D){D=new H(o);}X=D.getItem(W);if(X){Y.resolve(X);return Y.promise();}t.getAllAvailableSemanticObjects(Z);return Y.promise();function Z($,_){if(_){Y.reject(_);return;}var a1=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");var b1;var i;if(!a1){Y.reject(o.createMessageObject({code:"5038"}));return;}for(i=0;i<$.length;i++){if($[i].id===W){b1=$[i];break;}}a1.getSemanticObjectLinks(W,undefined,true,a.instances.component,undefined).done(function(c1){var d1=[];c1.forEach(function(e1){var f1=e1.intent.split("-");var g1=f1[1].split("?");g1=g1[0].split("~");d1.push({id:g1[0],text:e1.text});});D.setItem(W,{semanticObject:b1,semanticActions:d1});Y.resolve({semanticObject:b1,semanticActions:d1});}).fail(function(){Y.reject(o.createMessageObject({code:"11042"}));});}};this.navigateToGenericRuntime=function(i,W,X){var Y=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");var Z={};if(t.getStartParameterFacade().isLrepActive()){Z['sap-apf-configuration-id']=i+'.'+W;}else{Z['sap-apf-configuration-id']=W;}var $=Y.hrefForExternal({target:a.functions.getNavigationTargetForGenericRuntime(),params:Z});var _=jQuery(location).attr('href');var a1=_.split('#')[0];X(a1+$);};this.readAllConfigurationsFromVendorLayer=function(){return r.readAllConfigurationsFromVendorLayer();};if(a&&a.probe&&typeof a.probe==='function'){a.probe({constructors:{ApplicationHandler:A,ConfigurationHandler:C,ConfigurationEditor:b,ConfigurationObjects:c,ConfigurationFactory:d,MetadataFactory:k,Metadata:M,EntityTypeMetadata:g,MetadataFacade:h,MetadataProperty:j,Step:S,SmartFilterBar:e,FacetFilter:F,NavigationTarget:N,Representation:R,ElementContainer:E,Hashtable:H,LazyLoader:L,AnnotationHandler:m,RegistryProbe:f},textHandler:n,messageHandler:o,sessionHandler:s,persistenceProxy:r,metadataFactory:u,injectForFollowUp:v,injectMetadataFactory:w,fnOdataRequestWrapper:O,ajax:this.ajax,odataRequestWrapper:O,annotationHandler:T});}};}());
