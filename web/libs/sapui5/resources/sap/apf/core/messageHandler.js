/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
(function(){'use strict';jQuery.sap.declare("sap.apf.core.messageHandler");jQuery.sap.require("sap.apf.core.messageObject");jQuery.sap.require("sap.apf.core.messageDefinition");jQuery.sap.require("sap.apf.utils.hashtable");jQuery.sap.require("sap.apf.core.constants");sap.apf.core.MessageHandler=function(l){var a={initial:0,startup:1,running:2,shutdown:3};var t=this;var T;var L=[];var n=0;var b;var m;var A=function(){};var o=false;var d=false;var D=false;var h=false;var u="";var c={code:sap.apf.core.constants.message.code.errorUnknown,severity:sap.apf.core.constants.message.severity.error,rawText:"Unknown Error occurred"};var e=a.initial;var C=[];this.setLifeTimePhaseStartup=function(i){e=a.startup;};this.setLifeTimePhaseRunning=function(){e=a.running;};this.setLifeTimePhaseShutdown=function(){e=a.shutdown;};this.fatalErrorOccurredAtStartup=function(){var i;if(e!==a.startup){return false;}for(i=0;i<C.length;i++){if(C[i].getSeverity()===sap.apf.core.constants.message.severity.fatal){return true;}}return false;};this.createMessageObject=function(i){if(l){var M=new sap.apf.core.MessageObject(i);if(M.getCode()===undefined){M.setCode(sap.apf.core.constants.message.code.errorUnknown);}r.bind(this)(M);s(M,1);}return new sap.apf.core.MessageObject(i);};this.activateOnErrorHandling=function(O){o=O;if(o===true){jQuery(window).on("error",x);}else{jQuery(window).off("error");}};this.setTextResourceHandler=function(i){T=i;};this.loadConfig=function(M,R){if(b===undefined||R){b=new sap.apf.utils.Hashtable(t);}for(var i=0;i<M.length;i++){w(M[i]);}};this.setMessageCallback=function(i){if(i!==undefined&&typeof i==="function"){m=i;}else{m=undefined;}};this.setApplicationMessageCallback=function(i){if(i!==undefined&&typeof i==="function"){A=i;}else{A=function(){};this.putMessage(this.createMessageObject({code:"5031"}));}};this.putMessage=function(M){var P;var i=0;var z;if(M.getCode()===undefined){M.setCode(sap.apf.core.constants.message.code.errorUnknown);}r.bind(this)(M);if(M.getSeverity()===sap.apf.core.constants.message.severity.fatal){z=t.createMessageObject({code:sap.apf.core.constants.message.code.errorExitTriggered});r.bind(this)(z);z.setSeverity(sap.apf.core.constants.message.severity.fatal);if(z.getMessage()===""){z.setMessage("You must log out of the application due to a critical error");}}P=M.getPrevious();while(P!==undefined&&P.type&&P.type==="messageObject"&&i<10){if(P.getCode()===undefined){P.setCode(sap.apf.core.constants.message.code.errorUnknown);}r.bind(this)(P);P=P.getPrevious();i++;}if(z!==undefined){z.setPrevious(M);M=z;}if(!l){s(M,10);}C.push(M);if(d){return;}if(M.getSeverity()===sap.apf.core.constants.message.severity.technError){return;}if(m!==undefined){if(e===a.shutdown||(e===a.startup&&M.getSeverity()!==sap.apf.core.constants.message.severity.fatal)){return;}d=true;m(M,A);d=false;}if(M.getSeverity()===sap.apf.core.constants.message.severity.fatal&&e!==a.shutdown){if(sap.ui.Device.browser.firefox){h=true;}throw new Error(u);}};this.check=function(i,M,z){var E=z||sap.apf.core.constants.message.code.errorCheck;if(!i){var B=this.createMessageObject({code:E,aParameters:[M]});t.putMessage(B);}};this.getConfigurationByCode=function(E){if(b===undefined){return undefined;}return b.getItem(E);};this.getLogMessages=function(){return jQuery.extend(true,[],L);};this.reset=function(){b=undefined;m=undefined;A=undefined;L=[];C=[];};this.isOwnException=function(i){return(i&&i.message&&i.message.search(u)>-1);};function f(E){if(sap.ui.Device.browser.firefox){return h;}return(E.originalEvent&&E.originalEvent.message&&E.originalEvent.message.search(u)>-1);}function g(E){return(E.originalEvent&&E.originalEvent.message&&E.originalEvent.message.search(u)===-1&&E.originalEvent.message.search(sap.apf.core.constants.message.code.suppressFurtherException)>-1);}function j(){var i=new Date();var z=Math.random()*i.getTime();return sap.apf.core.constants.message.code.suppressFurtherException+z;}function k(i){var N=parseInt(i,10);if(N==sap.apf.core.constants.message.code.errorExitTriggered){return true;}else if(N>=sap.apf.core.constants.message.code.errorUnknown&&N<=sap.apf.core.constants.message.code.warningAnalyticalConfig){return true;}return false;}function p(i){var N=parseInt(i,10);if(N>sap.apf.core.constants.message.code.errorUnknown&&N<=sap.apf.core.constants.message.code.errorInAnalyticalConfig){return true;}return false;}function q(i){var N=parseInt(i,10);if(N===sap.apf.core.constants.message.code.warningAnalyticalConfig){return true;}return false;}function r(M){function i(G,H){var I=0;while(G.indexOf("{"+I+"}")>-1){if(typeof H[I]==="string"){G=G.replace("{"+I+"}",H[I]);}else{G=G.replace("{"+I+"}","undefined");}I++;}return G;}var z=M.getCode();var B=t.getConfigurationByCode(z);if(B===undefined){B=jQuery.extend(true,{},c);if(k(z)){if(M.hasRawText()){B.rawText=M.getRawText();}B.rawText+=' '+M.getParameters();if(p(z)){B.severity=sap.apf.core.constants.message.severity.fatal;}else if(q(z)){B.severity=sap.apf.core.constants.message.severity.warning;}}else{B.rawText="Message "+z+"  "+M.getParameters()+" (Message Code has no Configuration)";}if(!k(z)){M.setCode(B.code);}}if(B.severity!==undefined){M.setSeverity(B.severity);}else{M.setSeverity(sap.apf.core.constants.message.severity.technError);}if(B.rawText){M.setMessage(B.rawText);}else{var P=M.getParameters();if(M.getSeverity()===sap.apf.core.constants.message.severity.technError){var E=t.getConfigurationByCode(B.code).text;if(!E){E=t.getConfigurationByCode(B.code).description;}M.setMessage(i(E,P));}else{try{if(T){M.setMessage(T.getMessageText(B.key,M.getParameters()));}else if(B.description){M.setMessage(i(B.description,P));}else{M.setMessage("Message Code: "+z+" "+P.toString());}}catch(F){if(B.description){M.setMessage(i(B.description,P));}else{M.setMessage("Message Code: "+z+" "+P.toString());}}}}}function s(M,i){var z="APF message ";var P="";var B=i-1;if(i===0){return;}var E=M.getPrevious();if(E!==undefined){s(E,B);P=" - (see previous message for more information)";}n++;var F=z+'('+n+'): '+M.getCode()+" - "+M.getMessage()+P;if(D){alert("Fatal Error during Log Writing "+F);return;}D=true;if(M.getSeverity()===sap.apf.core.constants.message.severity.fatal){if(L.length<2){L.unshift(F);}}switch(M.getSeverity()){case sap.apf.core.constants.message.severity.warning:jQuery.sap.log.warning(F);break;case sap.apf.core.constants.message.severity.error:jQuery.sap.log.error(F);break;case sap.apf.core.constants.message.severity.fatal:jQuery.sap.log.error(F);break;case sap.apf.core.constants.message.severity.technError:jQuery.sap.log.error(F);break;default:jQuery.sap.log.info(F);}D=false;}function v(i){t.check(i!==undefined&&i.hasOwnProperty("code")!==false,"MessageHandler setItem: oItem is undefined or property 'code' is missing",sap.apf.core.constants.message.code.errorStartUp);var z=b.setItem(i.code,i);t.check((z===undefined),"MessageHandler setItem: Configuration includes duplicated codes",sap.apf.core.constants.message.code.errorStartUp);}function w(M){if(M.type===undefined){M.type="message";}v(M);}function x(E){var M;var i="";var z="";var U="";var B="";var F=true;if(sap.ui.Device.browser.firefox){F=false;}if(F&&E&&E.originalEvent){i=E.originalEvent.message;U=E.originalEvent.filename;z=E.originalEvent.lineno;}if(f(E)){E.stopImmediatePropagation();E.preventDefault();}else if(g(E)){return;}else if(d){M=new sap.apf.core.MessageObject({code:sap.apf.core.constants.message.code.errorStopProcessing});M.setSeverity(sap.apf.core.constants.message.severity.error);B="Unknown exception happened during processing of error by callback function ";if(F){B=B+i+" (source: "+U+":"+z+")";}M.setMessage(B);s(M,1);}else{M=new sap.apf.core.MessageObject({code:sap.apf.core.constants.message.code.errorUnknown});M.setSeverity(sap.apf.core.constants.message.severity.error);B="Unknown exception ";if(F){B=B+i+" (source: "+U+":"+z+")";}M.setMessage(B);s(M,1);}}function y(){u=j();}y();};}());
