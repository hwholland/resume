/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
(function(){'use strict';jQuery.sap.declare("sap.apf.utils.navigationHandler");jQuery.sap.require("sap.apf.core.utils.filterSimplify");jQuery.sap.require("sap.ui.core.routing.HashChanger");sap.apf.utils.NavigationHandler=function(I){var c;var e;var m=I.instances.messageHandler;var n=this;var f;this.getNavigationTargets=function(){var d;var h=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");var s=[];if(e){d=jQuery.Deferred();d.resolve(b(e));return d.promise();}if(!c){a();}c.forEach(function(k){if(jQuery.inArray(k.semanticObject,s)===-1){s.push(k.semanticObject);}});e=jQuery.extend(true,[],c);e.forEach(function(k){k.text="";});d=jQuery.Deferred();j(0).done(function(){d.resolve(b(e));}).fail(function(){d.resolve(b(e));});return d.promise();function i(k,l,t){e.forEach(function(o){if(k===o.semanticObject&&l===o.action){o.text=t;}});}function j(k){var d=jQuery.Deferred();var l=[];if(k===s.length){d=jQuery.Deferred();e.forEach(function(p){if(p.text!==""){l.push(p);}});e=l;d.resolve(e);return d.promise();}var o=s[k];h.getSemanticObjectLinks(o,undefined,false,I.instances.component,undefined).done(function(p){p.forEach(function(q){var r=q.intent.split("-");var t=r[1].split("?");t=t[0].split("~");i(o,t[0],q.text);});j(k+1).done(function(){d.resolve(e);});}).fail(function(){return j(k+1);});return d.promise();}};this.navigateToApp=function(d){if(!c){a();}var N=g(d);if(!N){return;}var h=sap.ui.core.routing.HashChanger&&sap.ui.core.routing.HashChanger.getInstance();I.functions.getCumulativeFilterUpToActiveStep().done(function(C){if(I.functions.isFilterReductionActive&&I.functions.isFilterReductionActive()){f=new sap.apf.core.utils.FilterReduction();C=f.filterReduction(m,C);}if(!N.filterMapping||!N.filterMapping.requestForMappedFilter){i(null,null);}else{var M=I.functions.createRequest(N.filterMapping.requestForMappedFilter);sap.apf.utils.executeFilterMapping(C,M,N.filterMapping.target,i,m);}function i(F,o){var j;if(o){return;}if(F){C=C.addAnd(F);}var k=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");if(k){var s={sapApfState:I.functions.serialize()};I.instances.startFilterHandler.serialize(true).done(function(l){n.generateSelectionVariant(C).done(function(p){s.sapApfState.filterIdHandler=I.functions.serializeFilterIds();s.sapApfState.startFilterHandler=l;s.sapApfCumulativeFilter=C.mapToSapUI5FilterExpression();s.sapApfState.dirtyState=I.functions.isDirty();s.sapApfState.pathName=I.functions.getPathName();s.selectionVariant=p;j=k.createEmptyAppState(I.instances.component);j.setData(s);j.save();if(h){h.replaceHash("sap-iapp-state="+j.getKey());}k.toExternal({target:{semanticObject:N.semanticObject,action:N.action},appStateKey:j.getKey()});});});}}});};this.checkMode=function(){var d=jQuery.Deferred();var h=sap.ui.core.routing.HashChanger&&sap.ui.core.routing.HashChanger.getInstance&&sap.ui.core.routing.HashChanger.getInstance();var i=/(?:sap-iapp-state=)([^&=]+)/;var j,k,l,o;if(h){l=i.exec(h.getHash());if(l){j=l[1];}}k=I.functions.getXappStateId();if(j){sap.ushell.Container.getService("CrossApplicationNavigation").getAppState(I.instances.component,j).done(function(p){o=p.getData();if(o.sapApfState){I.functions.deserializeFilterIds(o.sapApfState.filterIdHandler);I.functions.deserialize(o.sapApfState);I.functions.setDirtyState(o.sapApfState.dirtyState);I.functions.setPathName(o.sapApfState.pathName);I.instances.startFilterHandler.getStartFilters().done(function(){I.instances.startFilterHandler.deserialize(o.sapApfState.startFilterHandler);d.resolve({navigationMode:"backward"});});}});}else if(k){sap.ushell.Container.getService("CrossApplicationNavigation").getAppState(I.instances.component,k).done(function(p){o=p.getData();if(o&&o.sapApfCumulativeFilter){d.resolve({navigationMode:"forward",sapApfCumulativeFilter:o.sapApfCumulativeFilter});}else{d.resolve({navigationMode:"forward"});}});}else{d.resolve({navigationMode:"forward"});}if(h){h.replaceHash("");}return d.promise();};this.generateSelectionVariant=function(d){var h=jQuery.Deferred();if(!I.functions.isFilterReductionActive||!I.functions.isFilterReductionActive()){f=new sap.apf.core.utils.FilterReduction();d=f.filterReduction(m,d);}if(!f||!f.isContradicted()){var s=d.mapToSelectOptions(I.functions.getAllParameterEntitySetKeyProperties);s.done(function(i){i.SelectionVariantID=jQuery.sap.uid();h.resolve(i);});}else{var i={};i={SelectionVariantID:jQuery.sap.uid(),Text:'Filter could not be converted to a selectionVariant'};h.resolve(i);}return h.promise();};function a(){c=I.functions.getNavigationTargets();}function g(d){for(var i=0,l=c.length;i<l;i++){if(c[i].id===d){return c[i];}}}function b(t){var d=jQuery.extend(true,[],t);var r={global:[],stepSpecific:[]};d.forEach(function(h){if(h.isStepSpecific&&i(h.id)){delete h.isStepSpecific;r.stepSpecific.push(h);}else if(!h.isStepSpecific){delete h.isStepSpecific;r.global.push(h);}});return r;function i(h){var j=false;var k;var l=I.functions.getActiveStep();if(l&&l.getAssignedNavigationTargets){k=l.getAssignedNavigationTargets();if(k&&jQuery.isArray(k)){k.forEach(function(o){if(h===o.id){j=true;}});}}return j;}}};}());
