/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/base/ManagedObject','sap/m/Link','sap/m/LinkRenderer','sap/ui/comp/navpopover/LinkData','sap/ui/core/Control','./SemanticObjectController','sap/ui/comp/personalization/Util'],function(q,M,L,a,b,C,S,P){"use strict";var c=L.extend("sap.ui.comp.navpopover.SmartLink",{metadata:{library:"sap.ui.comp",designTime:true,properties:{semanticObject:{type:"string",defaultValue:null},semanticObjectController:{type:"any",defaultValue:null},fieldName:{type:"string",defaultValue:null},semanticObjectLabel:{type:"string",defaultValue:null},createControlCallback:{type:"object",defaultValue:null},mapFieldToSemanticObject:{type:"boolean",defaultValue:true},ignoreLinkRendering:{type:"boolean",defaultValue:false}},aggregations:{innerControl:{type:"sap.ui.core.Control",multiple:false}},events:{beforePopoverOpens:{parameters:{semanticObject:{type:"string"},semanticAttributes:{type:"object"},setSemanticAttributes:{type:"function"},setAppStateKey:{type:"function"},originalId:{type:"string"},open:{type:"function"}}},navigationTargetsObtained:{parameters:{mainNavigation:{type:"sap.ui.comp.navpopover.LinkData"},actions:{type:"sap.ui.comp.navpopover.LinkData[]"},ownNavigation:{type:"sap.ui.comp.navpopover.LinkData"},semanticObject:{type:"string"},originalId:{type:"string"},show:{type:"function"}}},innerNavigate:{parameters:{text:{type:"string"},href:{type:"string"},semanticObject:{type:"string"},semanticAttributes:{type:"object"},originalId:{type:"string"}}}}},renderer:function(r,o){var R=true;if(o.getIgnoreLinkRendering()){var d=o._getInnerControl();if(d){r.write("<div ");r.writeControlData(o);r.writeClasses();r.write(">");r.renderControl(d);r.write("</div>");R=false;}}if(R){a.render.call(a,r,o);}}});c.prototype.init=function(){this.attachPress(this._linkPressed);this.addStyleClass("sapUiCompSmartLink");this._oSemanticAttributes=null;};c.prototype.applySettings=function(s){M.prototype.applySettings.apply(this,arguments);this._updateEnabled();};c.prototype.updateBindingContext=function(s,d,m,u){this.setHref(null);this.setTarget(null);if(this._oPopover){this._oPopover.destroy();this._oPopover=null;}C.prototype.updateBindingContext.apply(this,arguments);};c.prototype._linkPressed=function(e){if(this._processingLinkPressed){window.console.warn("SmartLink is still processing last press event. This press event is omitted.");return;}if(this.getIgnoreLinkRendering()){window.console.warn("SmartLink should ignore link rendering. Press event is omitted.");return;}this._processingLinkPressed=true;var A;this._oSemanticAttributes=this._calculateSemanticAttributes();var t=this;var o=function(){t._createPopover();if(t._oSemanticAttributes){t._oPopover.setSemanticAttributes(t._oSemanticAttributes);}if(A){t._oPopover.setAppStateKey(A);}t._oPopover.retrieveNavTargets();};if(this.hasListeners("beforePopoverOpens")){this._bAsynchOpen=false;this.fireBeforePopoverOpens({semanticObject:this.getSemanticObject(),semanticAttributes:t._oSemanticAttributes,setSemanticAttributes:function(m){t._oSemanticAttributes=m;},setAppStateKey:function(k){A=k;},originalId:this.getId(),open:o});}else{o();}this._bAsynchOpen=true;};c.prototype._onTargetsObtainedOpenDialog=function(){var t=this;if(!this._oPopover.getMainNavigation()){this._oPopover.setMainNavigation(new b({text:this.getText()}));}this.fireNavigationTargetsObtained({actions:this._oPopover.getAvailableActions(),mainNavigation:this._oPopover.getMainNavigation(),ownNavigation:this._oPopover.getOwnNavigation(),semanticObject:this.getSemanticObject(),semanticAttributes:this.getSemanticAttributes(),originalId:this.getId(),show:function(m,o,A,e){if(m!=null&&typeof m==="string"){t._oPopover.setMainNavigationId(m);}else{e=A;A=o;o=m;}if(o){t._oPopover.setMainNavigation(o);}if(A){t._oPopover.removeAllAvailableActions();if(A&&A.length){var i,d=A.length;for(i=0;i<d;i++){t._oPopover.addAvailableAction(A[i]);}}}if(e){t._oPopover.setExtraContent(e);}var l=t._oPopover.getDirectLink();if(l){t.setHref(l.getHref());t.setTarget(l.getTarget());t._fireInnerNavigate({text:l.getText(),href:l.getHref()});t._processingLinkPressed=false;if(t._bAsynchOpen){t._processingLinkPressed=true;t.getDomRef().click();}}else{t._oPopover.show();t._processingLinkPressed=false;}}});if(!this.hasListeners("navigationTargetsObtained")){var l=this._oPopover.getDirectLink();if(l){this.setHref(l.getHref());this.setTarget(l.getTarget());this._fireInnerNavigate({text:l.getText(),href:l.getHref()});this._processingLinkPressed=false;if(this._bAsynchOpen){this._processingLinkPressed=true;this.getDomRef().click();}}else{this._oPopover.show();this._processingLinkPressed=false;}}};c.prototype._onInnerNavigate=function(e){var p=e.getParameters();this._fireInnerNavigate({text:p.text,href:p.href});};c.prototype._fireInnerNavigate=function(p){this.fireInnerNavigate({text:p.text,href:p.href,originalId:this.getId(),semanticObject:this.getSemanticObject(),semanticAttributes:this.getSemanticAttributes()});};c.prototype._createPopover=function(){if(!this._oPopover){var o=this._getComponent();q.sap.require("sap.ui.comp.navpopover.NavigationPopover");var N=sap.ui.require("sap/ui/comp/navpopover/NavigationPopover");this._oPopover=new N({title:this.getSemanticObjectLabel(),mainNavigationId:this.getSemanticObjectValue(),semanticObjectName:this.getSemanticObject(),targetsObtained:q.proxy(this._onTargetsObtainedOpenDialog,this),navigate:q.proxy(this._onInnerNavigate,this),component:o});this._oPopover.setSource(this);}};c.prototype._getComponent=function(){var p=this.getParent();while(p){if(p instanceof sap.ui.core.Component){return p;}p=p.getParent();}return null;};c.prototype._calculateSemanticAttributes=function(){var o=this.getBindingContext();if(!o){return null;}var B=this.getBinding("text");var s=B.getPath();if(!s&&B.getBindings){s=B.getBindings()[0].getPath();}var r={};var o=o.getObject(o.getPath());for(var A in o){if(A==="__metadata"){continue;}if(!o[A]){continue;}var d=this._mapFieldToSemanticObject(A);if(A===s&&this.getSemanticObject()){d=this.getSemanticObject();}if(d===this.getSemanticObject()&&!this.getMapFieldToSemanticObject()){d=A;}var e=o[A];if(r[d]){if(o[s]){e=o[s];}}r[d]=e;}return r;};c.prototype.getSemanticAttributes=function(){if(this._oSemanticAttributes===null){this._oSemanticAttributes=this._calculateSemanticAttributes();}return this._oSemanticAttributes;};c.prototype._mapFieldToSemanticObject=function(f){var s=this.getSemanticObjectController();if(!s){return f;}var m=s.getFieldSemanticObjectMap();if(!m){return f;}return m[f]||f;};c.prototype.setFieldName=function(f){this.setProperty("fieldName",f);this._updateEnabled();};c.prototype.setIgnoreLinkRendering=function(i){this.setProperty("ignoreLinkRendering",i,true);this._updateEnabled();};c.prototype.setSemanticObject=function(s){this.setProperty("semanticObject",s,true);this._updateEnabled();};c.prototype.setSemanticObjectController=function(o){var O=this.getProperty("semanticObjectController");if(O){O.unregisterControl(this);}this.setProperty("semanticObjectController",o,true);if(o){o.registerControl(this);}this._oSemanticAttributes=null;this._updateEnabled();};c.prototype.getSemanticObjectController=function(){var o=this.getProperty("semanticObjectController");if(!o){var p=this.getParent();while(p){if(p.getSemanticObjectController){o=p.getSemanticObjectController();if(o){this.setSemanticObjectController(o);break;}}p=p.getParent();}}return o;};c.prototype.getSemanticObjectValue=function(){var s=this.getSemanticAttributes();if(s){var d=this.getSemanticObject();return s[d];}return null;};c.prototype.setText=function(t){if(this._isRenderingInnerControl()){this.setProperty("text",t,true);}else{L.prototype.setText.call(this,t);}};c.prototype._isRenderingInnerControl=function(){return this.getIgnoreLinkRendering()&&this._getInnerControl()!=null;};c.prototype._getInnerControl=function(){var i=this.getAggregation("innerControl");if(i){return i;}var f=this.getCreateControlCallback();if(f){i=f();this.setAggregation("innerControl",i,true);return i;}return null;};c.prototype.getInnerControlValue=function(){if(this._isRenderingInnerControl()){var i=this._getInnerControl();if(i){if(i.getText){return i.getText();}if(i.getValue){return i.getValue();}}}return this.getText();};c.prototype.onBeforeRendering=function(){this.getSemanticObjectController();if(this.getIgnoreLinkRendering()&&this._getInnerControl()==null){this.setEnabled(false);}else{this.setEnabled(true);}};c.prototype.exit=function(){this.setSemanticObjectController(null);};c.prototype._updateEnabled=function(){var t=this;S.getDistinctSemanticObjects().then(function(s){var i=false;if(t.getSemanticObjectController()){var I=P.createArrayFromString(t.getSemanticObjectController().getIgnoredFields());i=I.indexOf(t.getFieldName())>-1;}var d=(t.getIgnoreLinkRendering()===false||t.getIgnoreLinkRendering()===true)?t.getIgnoreLinkRendering():false;t.setEnabled(!i&&!d&&S.hasDistinctSemanticObject(t.getSemanticObject(),s));});};return c;},true);
