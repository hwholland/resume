/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/m/CustomListItem','sap/m/Link','sap/m/Popover','sap/ui/core/Title','sap/ui/layout/form/SimpleForm','sap/m/VBox','sap/m/PopoverRenderer','./Factory','./LinkData'],function(q,C,L,P,T,S,V,a,F,b){"use strict";var N=P.extend("sap.ui.comp.navpopover.NavigationPopover",{metadata:{library:"sap.ui.comp",properties:{title:{type:"string",group:"Misc",defaultValue:null},semanticObjectName:{type:"string",group:"Misc",defaultValue:null},semanticAttributes:{type:"object",group:"Misc",defaultValue:null},appStateKey:{type:"string",group:"Misc",defaultValue:null},mainNavigationId:{type:"string",group:"Misc",defaultValue:null}},aggregations:{availableActions:{type:"sap.ui.comp.navpopover.LinkData",multiple:true,singularName:"availableAction"},mainNavigation:{type:"sap.ui.comp.navpopover.LinkData",multiple:false},ownNavigation:{type:"sap.ui.comp.navpopover.LinkData",multiple:false}},associations:{source:{type:"sap.ui.core.Control",multiple:false},extraContent:{type:"sap.ui.core.Control",multiple:false},component:{type:"sap.ui.core.Element",multiple:false}},events:{targetsObtained:{},navigate:{}}},renderer:a.render});N.prototype.init=function(){P.prototype.init.call(this);this.addStyleClass("navigationPopover");this.setContentWidth("380px");this.setHorizontalScrolling(false);this.setPlacement(sap.m.PlacementType.Auto);this._oMainNavigationText=new T();this._oMainNavigationLink=new L({press:q.proxy(this._onLinkPress,this)});this._oHeaderForm=new S({maxContainerCols:1,visible:true,content:[this._oMainNavigationText,this._oMainNavigationLink]});this._oNavigationLinkContainer=new V();this._oForm=new S({maxContainerCols:1,visible:false,content:[new T({text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("POPOVER_LINKLIST_TEXT")}),this._oNavigationLinkContainer]});this.addContent(this._oHeaderForm);this.addContent(this._oForm);};N.prototype.addAvailableAction=function(l){this.addAggregation("availableActions",l);};N.prototype._setMainNavigationText=function(){var v=this.getMainNavigationId();if(v){this._oMainNavigationText.setText(v);}var s=this._getSourceControl();if(s){if(s.getSemanticObjectValue){this._oMainNavigationText.setText(s.getSemanticObjectValue());}else{var o=this.getSemanticAttributes();if(o){var c=this.getSemanticObjectName();this._oMainNavigationText.setText(o[c]);}}}};N.prototype.setMainNavigationId=function(m){this.setProperty("mainNavigationId",m,true);this._oMainNavigationText.setText(m);return this;};N.prototype._createLinks=function(){var h;var c=this._getComponent();var x=F.getService("CrossApplicationNavigation");var m=this.getMainNavigation();if(m){h=m.getHref();if(h){this._oHeaderForm.removeStyleClass("navpopoversmallheader");this._oMainNavigationLink.setText(m.getText());if(x){h=x.hrefForExternal({target:{shellHash:h}},c);}this._oMainNavigationLink.setHref(h);this._oMainNavigationLink.setTarget(m.getTarget());this._oMainNavigationLink.setVisible(true);}else{this._oHeaderForm.addStyleClass("navpopoversmallheader");this._oMainNavigationLink.setText("");this._oMainNavigationLink.setVisible(false);}}this._oNavigationLinkContainer.removeAllItems();var A=this.getAvailableActions();if(A){for(var i=0;i<A.length;i++){var l=new L();var o=A[i];if(o){l.setText(o.getText());l.attachPress(q.proxy(this._onLinkPress,this));h=o.getHref();if(x&&h){h=x.hrefForExternal({target:{shellHash:h}},c);}l.setHref(h);l.setTarget(o.getTarget());}this._oNavigationLinkContainer.addItem(l);}}this._setListVisibility();};N.prototype.insertAvailableAction=function(l,i){this.insertAggregation("availableActions",l,i);};N.prototype.removeAvailableAction=function(l){var i;if(typeof(l)==="number"){i=l;}else{i=this.getAvailableActions().indexOf(l);}if(i>=0){this._oNavigationLinkContainer.removeItem(i);}var r=this.removeAggregation("availableActions",l);this._setListVisibility();return r;};N.prototype.removeAllAvailableActions=function(){this._oNavigationLinkContainer.removeAllItems();this.removeAllAggregation("availableActions");this._setListVisibility();};N.prototype._setListVisibility=function(){var A=this.getAvailableActions().length;this._oForm.setVisible(A>0);};N.prototype._onLinkPress=function(e){var s=e.getSource();this.fireNavigate({text:s.getText(),href:s.getHref()});};N.prototype.setSemanticObjectName=function(s){this.setProperty("semanticObjectName",s);this.removeAllAvailableActions();this.setMainNavigation(null);};N.prototype.retrieveNavigationTargets=function(){var t=this;var c=this._getComponent();return new Promise(function(r){var x=F.getService("CrossApplicationNavigation");var u=F.getService("URLParsing");if(!x||!u){q.sap.log.error("Service 'CrossApplicationNavigation' or 'URLParsing' could not be obtained");return r({mainNavigation:null,availableActions:[],ownNavigation:null});}var p=x.getSemanticObjectLinks(t.getSemanticObjectName(),t.getSemanticAttributes(),false,c,t.getAppStateKey());p.done(function(l){if(!l||!l.length){return r({mainNavigation:null,availableActions:[],ownNavigation:null});}var s=x.hrefForExternal();if(s&&s.indexOf("?")!==-1){s=s.split("?")[0];}l.forEach(function(o){if(o.intent.indexOf(s)===0){t.setOwnNavigation(new b({href:o.intent,text:o.text}));return;}var d=u.parseShellHash(o.intent);if(d.action&&(d.action==='displayFactSheet')){t.setMainNavigation(new b({href:o.intent,text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("POPOVER_FACTSHEET")}));return;}t.addAvailableAction(new b({href:o.intent,text:o.text}));});if(!t.getMainNavigation()){t.setMainNavigation(new b({text:t.getTitle()}));}return r({mainNavigation:t.getMainNavigation(),availableActions:t.getAvailableActions(),ownNavigation:t.getOwnNavigation()});});p.fail(function(e){q.sap.log.error("'getSemanticObjectLinks' failed");return r({mainNavigation:null,availableActions:[],ownNavigation:null});});});};N.prototype.retrieveNavTargets=function(){var s=this.getSemanticObjectName();var m=this.getSemanticAttributes();var A=this.getAppStateKey();this._retrieveNavTargets(s,m,A);};N.prototype._retrieveNavTargets=function(s,m,A){var t=this;this.setMainNavigation(null);this.removeAllAvailableActions();var x=F.getService("CrossApplicationNavigation");var u=F.getService("URLParsing");if(!x){q.sap.log.error("Service 'CrossApplicationNavigation' could not be obtained");this.fireTargetsObtained();return;}var I=false;var c=this._getComponent();var t=this;var p=x.getSemanticObjectLinks(s,m,I,c,A);p.done(function(l){var i,d,e;var o;var f;var h=false;if(l&&l.length){var g=x.hrefForExternal();if(g&&g.indexOf("?")!==-1){g=g.split("?")[0];}for(i=0;i<l.length;i++){d=l[i].intent;e=l[i].text;f=new b({text:e,href:d});if(d.indexOf(g)===0){t.setOwnNavigation(f);continue;}o=u.parseShellHash(d);if(o.action&&(o.action==='displayFactSheet')&&!h){f.setText(sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("POPOVER_FACTSHEET"));t.setMainNavigation(f);h=true;}else{t.addAvailableAction(f);}}}t.fireTargetsObtained();});p.fail(function(e){q.sap.log.error("'getSemanticObjectLinks' failed");});};N.prototype._getComponent=function(){var c=this.getComponent();if(typeof c==="string"){c=sap.ui.getCore().getComponent(c);}return c;};N.prototype._hasNavigationTargets=function(){var m=this.getMainNavigation();var A=this.getAvailableActions();if(!(m&&(m.getHref()))&&!(A&&(A.length>0))){q.sap.log.error("no navigation targets found");if(!this.getExtraContent()){q.sap.log.error("NavigationPopover is empty");q.sap.require("sap.m.MessageBox");var M=sap.ui.require("sap/m/MessageBox");M.show(sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("POPOVER_DETAILS_NAV_NOT_POSSIBLE"),{icon:M.Icon.ERROR,title:sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("POPOVER_MSG_NAV_NOT_POSSIBLE"),styleClass:(this.$()&&this.$().closest(".sapUiSizeCompact").length)?"sapUiSizeCompact":""});return false;}}return true;};N.prototype.getDirectLink=function(){this._createLinks();if(this._oMainNavigationLink.getHref()&&!this._oNavigationLinkContainer.getItems().length&&!this.getExtraContent()){return this._oMainNavigationLink;}if(this._oNavigationLinkContainer.getItems().length===1&&!this._oMainNavigationLink.getHref()&&!this.getExtraContent()){return this._oNavigationLinkContainer.getItems()[0];}return null;};N.prototype.show=function(){if(!this._hasNavigationTargets()){return;}var s=this._getSourceControl();if(!s){q.sap.log.error("no source assigned");return;}this._createLinks();this.openBy(s);};N.prototype._getSourceControl=function(){var s=null;var c=this.getSource();if(c){s=sap.ui.getCore().byId(c);}return s;};N.prototype.setExtraContent=function(c){var o=this.getExtraContent();if(o&&c&&o===c.getId()){return;}if(o){var O=sap.ui.getCore().byId(o);this.removeContent(O);}this.setAssociation("extraContent",c);if(c){this.insertContent(c,1);}};return N;},true);
