/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2013 SAP SE. All rights reserved
 * @deprecated since SAPUI 5 version 1.28.0
 */
jQuery.sap.require("sap.ca.scfld.md.controller.BaseFullscreenController");sap.ca.scfld.md.controller.BaseFullscreenController.extend("sap.suite.ui.smartbusiness.designtime.authorization.view.S4",{onInit:function(){var t=this;this.utilsRef=sap.suite.ui.smartbusiness.lib.Util.utils;this.userSearch=false;this.roleSearch=false;this.previousAuthorizations=[];this.previousSelectedIds={};this.previousSelectedIds["USER"]={};this.previousSelectedIds["ROLE"]={};this.selectedIds={};this.selectedIds["USER"]={};this.selectedIds["ROLE"]={};var f=['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];this.filterByAlphabetModel=new sap.ui.model.json.JSONModel();this.filterByAlphabetModel.setData(f);this.selectedItemsModel=new sap.ui.model.json.JSONModel();this.selectedItemsModel.setData([]);this.byId("selectedItemsList").setModel(this.selectedItemsModel,"selectedItems");this.alphabetFilterDialog={};this.deletedItems=[];this.oRouter.attachRouteMatched(function(e){if(e.getParameter("name")!="subDetail")return;t.byId('userSearchField').setValue('');t.byId('roleSearchField').setValue('');var c=new sap.ui.model.Context(t.getView().getModel(),'/'+(e.getParameter("arguments").contextPath));t.getView().setBindingContext(c);t.itemId=t.getView().getBindingContext().getProperty("ID");if(!t.itemId){t.itemId=(/ID=\'.*\'/).exec(e.getParameter("arguments").contextPath)[0];t.itemId=t.itemId.slice(t.itemId.indexOf("'")+1,t.itemId.lastIndexOf("'"));}t.getView().getModel().read("/AUTHORIZED_USERS",null,"$filter=ID eq '"+t.itemId+"'",false,function(d){t.selectedIds["USER"]={};t.selectedIds["ROLE"]={};t.deletedItems=[];t.previousAuthorizations=jQuery.extend(true,[],d.results);t.selectedItemsModel.setData(d.results);t.initialSelectedItems=jQuery.extend(true,[],d.results);t.byId("selectedItemsTab").setCount(d.results.length);for(var k in d.results)t.selectedIds[d.results[k].TYPE][d.results[k].NAME]=d.results[k].NAME;t.previousSelectedIds=jQuery.extend(true,{},t.selectedIds);},function(a){sap.suite.ui.smartbusiness.lib.Util.utils.showErrorMessage(t.oApplicationFacade.getResourceBundle().getText("ERROR_LOADING_AUTH"));});t.byId("userList").bindItems("/HANA_USERS",new sap.m.CustomListItem({selected:{path:"NAME",formatter:function(n){return((t.selectedIds["USER"][n])?true:false);}},content:[new sap.ui.layout.Grid({defaultSpan:"L12 M12",width:"60%",vSpacing:0,content:[new sap.ui.core.Icon({src:"sap-icon://person-placeholder",size:"40px",color:{path:"NAME",formatter:function(n){return(t.selectedIds["USER"][n]?"#009de0":"#e6e6e6");}},layoutData:new sap.ui.layout.GridData({span:"L1 M1"})}),new sap.m.Label({text:"{NAME}",layoutData:new sap.ui.layout.GridData({span:"L8 M8"})})]})]}));t.byId("roleList").bindItems("/HANA_ROLES",new sap.m.CustomListItem({selected:{path:"NAME",formatter:function(n){return(t.selectedIds["ROLE"][n]?true:false);}},content:[new sap.ui.layout.Grid({defaultSpan:"L12 M12",width:"60%",vSpacing:0,content:[new sap.ui.core.Icon({src:"sap-icon://group",size:"40px",color:{path:"NAME",formatter:function(n){return(t.selectedIds["ROLE"][n]?"#009de0":"#e6e6e6");}},layoutData:new sap.ui.layout.GridData({span:"L1 M1"})}),new sap.m.Label({text:"{NAME}",layoutData:new sap.ui.layout.GridData({span:"L7 M7"})}),new sap.m.Link({text:{path:'NO_OF_USERS',formatter:jQuery.proxy(t.formatNoOfUsers,t)},press:jQuery.proxy(t.onAllRolesLinkSelect,t),layoutData:new sap.ui.layout.GridData({span:"L2 M2"})})]})]}));});this.oHeaderFooterOptions={bSuppressBookmarkButton:{},sI18NFullscreenTitle:"S3_EDIT",oFilterOptions:{onFilterPressed:function(e){if(t.byId("idIconTabBarMulti").getSelectedKey()=="selected")sap.m.MessageToast.show(t.oApplicationFacade.getResourceBundle().getText("FILTER_NOT_APPLICABLE"));else t.openFilterDialog();}},onBack:function(e){t.handleBackAndCancel();},oEditBtn:{sI18nBtnTxt:"SAVE",onBtnPressed:function(e){t.saveAuthorizations();}},buttonList:[{sI18nBtnTxt:"RESET",onBtnPressed:function(e){t.resetAuthorizations();},},{sI18nBtnTxt:"CANCEL",onBtnPressed:function(e){t.handleBackAndCancel();}}]};this.setHeaderFooterOptions(this.oHeaderFooterOptions);},getHeaderFooterOptions:function(){return this.oHeaderFooterOptions;},onUserSearch:function(e){var p=this.userSearch;e.getSource().getValue()==""?this.userSearch=false:this.userSearch=true;var i=this.byId("userList").getBinding("items");var s=e.getSource().getValue().toLowerCase();s=escape(s);if(p)i.aFilters.pop();if(this.userSearch)i.aFilters.push(new sap.ui.model.Filter("tolower(NAME)","Contains","'"+s+"'"));i.filter(i.aFilters);},onRoleSearch:function(e){var p=this.roleSearch;e.getSource().getValue()==""?this.roleSearch=false:this.roleSearch=true;var s=e.getSource().getValue().toLowerCase();s=escape(s);var i=this.byId("roleList").getBinding("items");if(p)i.aFilters.pop();if(this.roleSearch)i.aFilters.push(new sap.ui.model.Filter("tolower(NAME)","Contains","'"+s+"'"));i.filter(i.aFilters);},refreshFilter:function(){var e=this.byId("idIconTabBarMulti").getSelectedKey();var i=this.byId((e==="users")?"userList":"roleList").getBinding("items");i.filter([],false);this.byId((e==="users")?"userInfoToolbar":"roleInfoToolbar").setVisible(false);this.alphabetFilterDialog[e]=null;},onUserItemSelectionChange:function(e){this.onItemSelectionChange(e,"USER");},onRoleItemSelectionChange:function(e){this.onItemSelectionChange(e,"ROLE");},onItemSelectionChange:function(e,t){var s=this.selectedItemsModel.getData();var a=e.getParameter("listItem");var b=a.getBindingContext().getObject();if(a.getSelected()){for(var k in this.deletedItems){if(this.deletedItems[k].NAME===b.NAME&&this.deletedItems[k].TYPE===t)this.deletedItems.splice(k,1);}b.TYPE=t;s.push(b);var c=a.getContent()[0].getContent()[0];c.setColor("#009de0");this.selectedIds[t][b.NAME]=b.NAME;}else{for(var k in this.previousAuthorizations){if(this.previousAuthorizations[k].NAME===b.NAME&&this.previousAuthorizations[k].TYPE===t){b.TYPE=t;this.deletedItems.push(b);}}for(var k in s)if((s[k].NAME==b.NAME)&&(s[k].TYPE==t))s.splice(k,1);var c=a.getContent()[0].getContent()[0];c.setColor("#e6e6e6");this.selectedIds[t][b.NAME]=null;}this.selectedItemsModel.setData(s);this.byId("selectedItemsTab").setCount(s.length);},onSelectedItemDelete:function(e){var d=e.getParameter("listItem").getBindingContext("selectedItems").getObject();var i=this.byId(d.TYPE=="USER"?"userList":"roleList");for(var k in this.previousAuthorizations){if(this.previousAuthorizations[k].NAME===d.NAME&&this.previousAuthorizations[k].TYPE===d.TYPE)this.deletedItems.push(d);}this.selectedIds[d.TYPE][d.NAME]=null;i.getModel().refresh(true);var s=this.selectedItemsModel.getData();var a=e.getParameter("listItem").getBindingContext("selectedItems").getPath().substr(1);s.splice(a,1);this.selectedItemsModel.setData(s);this.byId("selectedItemsList").rerender();this.byId("selectedItemsTab").setCount(s.length);},onAllRolesLinkSelect:function(e){var r=e.getSource().getBindingContext().getProperty("NAME");var n=e.getSource().getBindingContext().getProperty("NO_OF_USERS");this.onRolesLinkSelect(e,r,n);},onSelectedRolesLinkSelect:function(e){var r=e.getSource().getBindingContext("selectedItems").getProperty("NAME");var n=e.getSource().getBindingContext("selectedItems").getProperty("NO_OF_USERS");this.onRolesLinkSelect(e,r,n);},onRolesLinkSelect:function(e,r,n){n=n+" "+(n==1?this.oApplicationFacade.getResourceBundle().getText("USER"):this.oApplicationFacade.getResourceBundle().getText("USERS"));if(!this._rolesPopover){this.roleNameLabel=new sap.m.Label({text:r,design:"Bold",layoutData:new sap.ui.layout.GridData({span:"L10 M10"})});this.noOfUsersLabel=new sap.m.Label({text:n,design:"Bold",layoutData:new sap.ui.layout.GridData({span:"L12 M12"})});var a=new sap.ui.layout.Grid({defaultSpan:"L12 M12",content:[new sap.ui.core.Icon({src:"sap-icon://group",size:"40px",color:"#e6e6e6",layoutData:new sap.ui.layout.GridData({span:"L2 M2"})}),this.roleNameLabel,this.noOfUsersLabel]});this.usersForRole=new sap.ui.layout.Grid({span:"L12 M12"});var b=new sap.m.VBox({items:[a,this.usersForRole],});var c=new sap.m.Bar({contentMiddle:[new sap.m.Label({text:"{i18n>ROLE_DETAILS}"})],contentRight:(jQuery.device.is.phone)?[]:[new sap.m.Button({icon:"sap-icon://decline",width:"2.375rem",press:jQuery.proxy(function(){this._rolesPopover.close();},this)})]});this._rolesPopover=new sap.m.Popover({customHeader:c,content:b});this.getView().addDependent(this._rolesPopover);}this.roleNameLabel.setText(r);this.noOfUsersLabel.setText(n);this.usersForRole.bindAggregation("content","/USERS_GRANTED_ROLE(P_ROLE_NAME='"+r+"')/Results",new sap.m.Label({text:"{NAME}",layoutData:new sap.ui.layout.GridData({span:"L12 M12"})}));var i=e.getSource();jQuery.sap.delayedCall(0,this,function(){this._rolesPopover.openBy(i);});},formatSelectedItemsIcon:function(t){if(t==="ROLE")return"sap-icon://group";else return"sap-icon://person-placeholder";},formatNoOfUsers:function(n){if(n)return n+" "+(n==1?this.oApplicationFacade.getResourceBundle().getText("USER"):this.oApplicationFacade.getResourceBundle().getText("USERS"));else return"";},saveAuthorizations:function(){var t=this;var s=this.selectedItemsModel.getData();var d=[];var c=[];var i=true;var p={ID:this.itemId,REVOKE:[],GRANT:[]};var b=new sap.m.BusyDialog();b.open();for(var k in this.deletedItems){p.REVOKE.push(this.deletedItems[k].NAME);}for(var k in s){p.GRANT.push(s[k].NAME);}sap.suite.ui.smartbusiness.lib.Util.utils.create(sap.suite.ui.smartbusiness.lib.Util.utils.serviceUrl("AUTHORIZATION_SERVICE_URI"),p,null,function(a){sap.m.MessageToast.show(t.oApplicationFacade.getResourceBundle().getText("AUTH_SAVE_SUCCESS"));t.onNavBack();sap.suite.ui.smartbusiness.lib.Util.utils.replaceHash({action:"authorizeSBEvaluation",route:"detail",context:t.getView().getBindingContext().getPath().split("/")[1]});b.close();},function(e){sap.suite.ui.smartbusiness.lib.Util.utils.showErrorMessage(t.oApplicationFacade.getResourceBundle().getText("AUTH_SAVE_ERROR"),e.responseText);b.close();});},resetAuthorizations:function(){this.selectedIds=jQuery.extend(true,{},this.previousSelectedIds);this.selectedItemsModel.setData(jQuery.extend(true,[],this.previousAuthorizations));this.byId("selectedItemsTab").setCount(this.previousAuthorizations.length);this.byId("selectedItemsList").rerender();this.byId("userList").getModel().refresh(true);this.byId("roleList").getModel().refresh(true);this.deletedItems=[];},onNavBack:function(){this.selectedIds["USER"]={};this.selectedIds["ROLE"]={};this.deletedItems=[];},openFilterDialog:function(){var t=this;var e=this.byId("idIconTabBarMulti").getSelectedKey();if(!this.alphabetFilterDialog[e]){this.alphabetFilterDialog[e]=new sap.m.SelectDialog({title:t.oApplicationFacade.getResourceBundle().getText("FILTER")+" : "+(e=="users"?t.oApplicationFacade.getResourceBundle().getText("USERS"):t.oApplicationFacade.getResourceBundle().getText("ROLES")),growingScrollToLoad:true,rememberSelections:true,multiSelect:true,search:function(E){t.alphabetFilterDialog[e].getBinding("items").filter(new sap.ui.model.Filter("","Contains",E.getParameters().value));},confirm:function(E){var f=[];var i=t.byId((e==="users")?"userList":"roleList").getBinding("items");var s=null;if(e==="users")s=t.userSearch?i.aFilters.pop():null;else s=t.roleSearch?i.aFilters.pop():null;var a=[];var b=E.getParameter("selectedContexts");for(var k in b){f.push(new sap.ui.model.Filter("NAME","StartsWith",b[k].getObject()));a.push(b[k].getObject());}if(s)f.push(s);i.filter(f,false);if(a.length>0){t.byId((e==="users")?"userInfoToolbar":"roleInfoToolbar").setVisible(true);t.byId((e==="users")?"userInfoToolbarLabel":"roleInfoToolbarLabel").setText(t.oApplicationFacade.getResourceBundle().getText("FILTERED_BY")+"("+a.join(", ")+")");}else t.byId((e==="users")?"userInfoToolbar":"roleInfoToolbar").setVisible(false);},items:{path:"/",template:new sap.m.StandardListItem({title:"{}"})}});this.alphabetFilterDialog[e].setModel(this.filterByAlphabetModel);}this.alphabetFilterDialog[e].open();},onSelectIconTab:function(e){if(e.getParameter("selectedKey")=="selected"){this.oHeaderFooterOptions.oFilterOptions.bDisabled=true;this.setHeaderFooterOptions(this.oHeaderFooterOptions);}else{this.oHeaderFooterOptions.oFilterOptions.bDisabled=false;this.setHeaderFooterOptions(this.oHeaderFooterOptions);}},handleBackAndCancel:function(){var t=this;var d=sap.suite.ui.smartbusiness.lib.Util.utils.dirtyBitCheck({oldPayload:t.initialSelectedItems,newPayload:t.selectedItemsModel.getData(),objectType:"AUTHORIZATION"});if(d.updates.length||d.deletes.length){var b=new sap.m.Dialog({icon:"sap-icon://warning2",title:t.oApplicationFacade.getResourceBundle().getText("WARNING"),state:"Error",type:"Message",content:[new sap.m.Text({text:t.oApplicationFacade.getResourceBundle().getText("ON_BACK_WARNING")})],beginButton:new sap.m.Button({text:t.oApplicationFacade.getResourceBundle().getText("CONTINUE"),press:function(){sap.suite.ui.smartbusiness.lib.Util.utils.replaceHash({action:"authorizeSBEvaluation",route:"detail",context:t.getView().getBindingContext().getPath().split("/")[1]});}}),endButton:new sap.m.Button({text:t.oApplicationFacade.getResourceBundle().getText("CANCEL"),press:function(){b.close();}})});b.open();}else{sap.suite.ui.smartbusiness.lib.Util.utils.replaceHash({action:"authorizeSBEvaluation",route:"detail",context:t.getView().getBindingContext().getPath().split("/")[1]});}},refreshMasterList:function(){var t=this;t.utilsRef.refreshMasterList(t,false);}});
