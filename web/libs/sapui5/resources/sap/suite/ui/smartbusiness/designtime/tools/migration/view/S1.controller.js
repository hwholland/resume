/*!
* SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2013 SAP SE. All rights reserved
* @deprecated since SAPUI 5 version 1.28.0
*/
jQuery.sap.require("sap.ca.scfld.md.controller.BaseFullscreenController");sap.ca.scfld.md.controller.BaseFullscreenController.extend("sap.suite.ui.smartbusiness.designtime.tools.migration.view.S1",{onInit:function(){jQuery.sap.require("sap.m.MessageBox");var r=jQuery.sap.getModulePath("sap.suite.ui.smartbusiness.designtime.tools.migration");var m=this;var t=this;this.oI18nModel=new sap.ui.model.resource.ResourceModel({bundleName:"sap/suite/ui/smartbusiness/designtime/tools/migration/i18n/i18n"});this.getView().setModel(m.oI18nModel,"i18n");var o={bSuppressBookmarkButton:{},oEditBtn:{sI18nBtnTxt:m.oI18nModel.getResourceBundle().getText("BTN_MIGRATE"),onBtnPressed:function(e){m.migrateData();}},buttonList:[{sI18nBtnTxt:m.oI18nModel.getResourceBundle().getText("BTN_RESET"),onBtnPressed:function(e){m.clearData();}},{sI18nBtnTxt:m.oI18nModel.getResourceBundle().getText("BTN_CANCEL"),onBtnPressed:function(e){m.cancel();}}]};this.setHeaderFooterOptions(o);this.newEvaluationsModel=new sap.ui.model.json.JSONModel();var n={EVALUATIONS:[{ID:"",INDICATOR:"",TITLE:"",OLD_ID:"",VALID_ID:""}]};this.newEvaluationsModel.setData((n));this._dialog=new sap.m.BusyDialog({});this.getView().byId("kpiInput").setValueHelpOnly(true);},showBusy:function(o){var m=this;var t=this;if(o=="L")this._dialog.setText(m.oI18nModel.getResourceBundle().getText("LOADING_DIALOG_TEXT"));if(o=="M")this._dialog.setText(m.oI18nModel.getResourceBundle().getText("MIGRATING_DIALOG_TEXT"));this._dialog.open();},hideBusy:function(){var t=this;this._dialog.close();},handleKpiValueHelp:function(){var m=this;var t=this;this.selectedKPIs=[];this.oldModel=new sap.ui.model.odata.ODataModel("/sap/hba/apps/kpi/s/odata/modeler_services.xsodata",true);this.oldModelDDA=new sap.ui.model.odata.ODataModel("/sap/hba/apps/kpi/s/odata/query_view_annotation_services.xsodata",true);this.oldModelVariants=new sap.ui.model.odata.ODataModel("/sap/hba/apps/kpi/s/odata/variant_services.xsodata",true);this.newModel=new sap.ui.model.odata.ODataModel("/sap/hba/r/sb/core/odata/modeler/SMART_BUSINESS.xsodata",true);this.kpiList=new sap.m.ObjectListItem({title:"{id}",number:"{evalCount}",numberUnit:"Evaluations",attributes:new sap.m.ObjectAttribute({text:"{text}"}),});var k=new sap.m.SelectDialog({title:m.oI18nModel.getResourceBundle().getText("SELECT_KPI_DIALOG"),multiSelect:true,noDataText:"No data found",items:{path:"/ActiveKPIs",sorter:new sap.ui.model.Sorter({path:'id',descending:false}),template:m.kpiList},confirm:function(e){var c=e.mParameters.selectedContexts;m.selectedKPIs=[];for(var i=0;i<c.length;i++){m.selectedKPIs.push(c[i].sPath.split('\'')[1]);}if(m.selectedKPIs.length>0){var a;var b=0;var p="";var j=0;for(var i=j;i<m.selectedKPIs.length;i++){p="ID eq '"+m.selectedKPIs[i]+"' and IS_ACTIVE eq 1";a=m.serviceCallDataValidation("/INDICATORS",["$format=json","$filter="+p],m.newModel);if(a.success){b++;}}}if(m.selectedKPIs.length>0){if(b>0&&b!=m.selectedKPIs.length){sap.m.MessageBox.show(m.oI18nModel.getResourceBundle().getText("MSG_FEW_KPIs_MIGRATED"),sap.m.MessageBox.Icon.INFORMATION,m.oI18nModel.getResourceBundle().getText("INFORMATION_MSG_TITLE"),[sap.m.MessageBox.Action.OK],function(){m.showBusy("L");setTimeout(function(){m.bindEvaluations();},2500);});}if(b==0){m.showBusy("L");setTimeout(function(){m.bindEvaluations();},2500);}if(b>0&&b==m.selectedKPIs.length){sap.m.MessageBox.show(m.oI18nModel.getResourceBundle().getText("MSG_ALL_KPIs_MIGRATED"),sap.m.MessageBox.Icon.INFORMATION,m.oI18nModel.getResourceBundle().getText("INFORMATION_MSG_TITLE"),[sap.m.MessageBox.Action.OK],function(){m.showBusy("L");setTimeout(function(){m.bindEvaluations();},2500);});}}},liveChange:function(e){var s="'"+e.getParameter("value").toLowerCase()+"'";var f=new sap.ui.model.Filter("tolower(id)",sap.ui.model.FilterOperator.Contains,s);var b=e.getSource().getBinding("items");b.filter([f]);}});k.setModel(m.oldModel);k.open();},bindEvaluations:function(){var m=this;m.testVal=[];var t=this;var v=[];var a={};var b="";var o=this.getView().byId("oldList");var n=this.getView().byId("newList");var p={};p.VIEWS=[];var d={};d.CONFIGURATIONS=[];var f=new sap.m.List({});var g=new sap.m.List({});var h=new sap.ui.model.json.JSONModel();this.dialogModel=new sap.ui.model.json.JSONModel();this.newConfigurationObject=[];m.newConfigurationObject.CONFIGURATIONS=[];var k=new sap.m.ObjectListItem({title:"{viewName}",});var l=new sap.ui.layout.Grid({hSpacing:1,vSpacing:1,content:[new sap.m.Label({text:"{CONFIGURATION_NAME}",design:sap.m.LabelDesign.Bold,layoutData:new sap.ui.layout.GridData({span:"L12 M12 S12"})}),new sap.m.Label({text:"*View ID: ",layoutData:new sap.ui.layout.GridData({span:"L3 M3 S3",linebreakL:true,linebreakM:true,linebreakS:true})}),new sap.m.Input({type:"Text",value:"{VALID_CONFIGURATION_ID}",layoutData:new sap.ui.layout.GridData({span:"L8 M8 S8",}),}),]});f.bindItems({path:"/VIEWS",sorter:new sap.ui.model.Sorter({path:'viewName',descending:false,}),template:k});var q=new sap.m.ResponsivePopover({});var r=new sap.m.CustomListItem({content:l,});var s=new sap.m.Dialog({endButton:new sap.m.Button({text:m.oI18nModel.getResourceBundle().getText("BTN_SAVE_CLOSE"),press:function(){var x=this.getModel().getData().CONFIGURATIONS;for(var i=0;i<x.length;i++){for(var j=0;j<m.newConfigurationObject.CONFIGURATIONS.length;j++){if(x[i].CONFIGURATION_NAME==m.newConfigurationObject.CONFIGURATIONS[j].CONFIGURATION_NAME){m.newConfigurationObject.CONFIGURATIONS[j].CONFIGURATION_ID=x[i].VALID_CONFIGURATION_ID;}}}s.close();}}),});s.addContent(g);s.setModel(m.dialogModel);g.bindItems({path:"/CONFIGURATIONS",sorter:new sap.ui.model.Sorter({path:'CONFIGURATION_NAME',descending:false,}),template:r});q.addContent(f);q.setModel(h);o.attachUpdateStarted(function(e){this.setBusy(true);this.setNoDataText(m.oI18nModel.getResourceBundle().getText("LIST_LOADING"));});o.attachUpdateFinished(function(e){this.setBusy(false);this.setNoDataText("");});n.attachUpdateStarted(function(e){this.setBusy(true);this.setNoDataText(m.oI18nModel.getResourceBundle().getText("LIST_LOADING"));});n.attachUpdateFinished(function(e){this.setBusy(false);this.setNoDataText("");});for(var i=0;i<m.selectedKPIs.length;i++){a={};a.operator="EQ";a.value1=m.selectedKPIs[i];v.push(a);}var F=new sap.ui.model.odata.Filter("objectId",v,false);var u=new sap.ui.layout.Grid({hSpacing:1,vSpacing:1,content:[new sap.m.Label({text:"{evaluationText}",design:sap.m.LabelDesign.Bold,layoutData:new sap.ui.layout.GridData({span:"L9 M9 S9"})}).addStyleClass("listContentTop"),new sap.m.Label({text:this.oI18nModel.getResourceBundle().getText("VAR_ID"),layoutData:new sap.ui.layout.GridData({span:"L2 M2 S3",linebreakL:true,linebreakM:true,linebreakS:true})}),new sap.m.Input({type:"Text",value:"{variantId}",layoutData:new sap.ui.layout.GridData({span:"L8 M8 S8",}),editable:false}),new sap.m.Link({text:{path:"/variantId",formatter:function(){var b;var c=this.getBindingContext().getProperty("objectId");var e=this.getBindingContext().getProperty("variantId");var a=m.serviceCallDataValidation("/DDA_CONFIG_PROPERTIES",["$format=json","$filter=(objectId eq '"+c+"' and variantId eq '"+e+"' and property eq 'queryAnnotationDocURIs')"],m.oldModel);if(a.success){b=a.data[0].value.split(",").length;return(t.oI18nModel.getResourceBundle().getText("CONFIGURED_DD",b));}else{b=0;return(t.oI18nModel.getResourceBundle().getText("CONFIGURED_DD",b));}}},press:function(e){b="";p.VIEWS=[];var c=this.getBindingContext().getProperty("objectId");var j=this.getBindingContext().getProperty("variantId");var a=m.serviceCallDataValidation("/DDA_CONFIG_PROPERTIES",["$format=json","$filter=(objectId eq '"+c+"' and variantId eq '"+j+"' and property eq 'queryAnnotationDocURIs')"],m.oldModel);if(a.success){b=a.data[0].value.split(",").length;q.setTitle(t.oI18nModel.getResourceBundle().getText("CONFIGURED_DD",b));for(var i=0;i<b;i++){var x={};x.viewName=a.data[0].value.split(",")[i];p.VIEWS.push(x);}h.setData(p);q.openBy(e.getSource());}else{h.setData(p);b=0;q.setTitle(t.oI18nModel.getResourceBundle().getText("CONFIGURED_DD",b));q.openBy(e.getSource());}},layoutData:new sap.ui.layout.GridData({span:"L8 M8 S8",indent:"L2 M2 S2",linebreakL:true,linebreakM:true,linebreakS:true}),}),]});var w=new sap.ui.layout.Grid({hSpacing:1,vSpacing:1,content:[new sap.m.Label({text:"{TITLE}",design:sap.m.LabelDesign.Bold,layoutData:new sap.ui.layout.GridData({span:"L9 M9 S9"})}).addStyleClass("listContentTop"),new sap.m.Label({text:"*"+this.oI18nModel.getResourceBundle().getText("EVAL_ID"),layoutData:new sap.ui.layout.GridData({span:"L3 M3 S3",linebreakL:true,linebreakM:true,linebreakS:true})}),new sap.m.Input({type:"Text",value:"{ID}",layoutData:new sap.ui.layout.GridData({span:"L8 M8 S8",liveChange:function(e){},change:function(e){}}),}),new sap.m.Link({text:{path:"/variantId",formatter:function(){var b;var c=this.getBindingContext().getProperty("OLD_ID").split("~")[0];var e=this.getBindingContext().getProperty("OLD_ID").split("~")[1];var a=m.serviceCallDataValidation("/DDA_CONFIG_PROPERTIES",["$format=json","$filter=(objectId eq '"+c+"' and variantId eq '"+e+"' and property eq 'queryAnnotationDocURIs')"],m.oldModel);if(a.success){b=a.data[0].value.split(",").length;return(t.oI18nModel.getResourceBundle().getText("CONFIGURED_DD",b));}else{b=0;return(t.oI18nModel.getResourceBundle().getText("CONFIGURED_DD",b));}}},press:function(e){b="";d.CONFIGURATIONS=[];var x=this.getBindingContext().getProperty("OLD_ID").split("~")[0];var A=this.getBindingContext().getProperty("OLD_ID").split("~")[1];var a=m.serviceCallDataValidation("/DDA_CONFIG_PROPERTIES",["$format=json","$filter=(objectId eq '"+x+"' and variantId eq '"+A+"' and property eq 'queryAnnotationDocURIs')"],m.oldModel);if(a.success){b=a.data[0].value.split(",").length;s.setTitle(this.oI18nModel.getResourceBundle().getText("CONFIGURED_DD",b));var B=0;for(var i=0;i<b;i++){B=0;for(var j=0;j<m.newConfigurationObject.CONFIGURATIONS.length;j++){if(m.newConfigurationObject.CONFIGURATIONS[j].CONFIGURATION_NAME==a.data[0].value.split(",")[i]){B++;var c=m.newConfigurationObject.CONFIGURATIONS[j].VALID_CONFIGURATION_ID;m.newConfigurationObject.CONFIGURATIONS[j].VALID_CONFIGURATION_ID=m.newConfigurationObject.CONFIGURATIONS[j].CONFIGURATION_ID;m.newConfigurationObject.CONFIGURATIONS[j].CONFIGURATION_ID=c;d.CONFIGURATIONS.push(jQuery.extend({},m.newConfigurationObject.CONFIGURATIONS[j]));break;}}if(B==0){var C={};C.CONFIGURATION_NAME=a.data[0].value.split(",")[i];C.CONFIGURATION_ID=a.data[0].objectId+"~"+a.data[0].variantId+"_"+a.data[0].value.split(",")[i];C.VALID_CONFIGURATION_ID=this.getBindingContext().getProperty("VALID_ID")+"."+a.data[0].value.split(",")[i];C.EVALUATION_ID=this.getBindingContext().getProperty("OLD_ID");d.CONFIGURATIONS.push(C);m.newConfigurationObject.CONFIGURATIONS.push(jQuery.extend({},C));}}m.dialogModel.setData(d);s.open();}else{m.dialogModel.setData(d);b=0;s.setTitle(t.oI18nModel.getResourceBundle().getText("CONFIGURED_DD",b));s.open();}},layoutData:new sap.ui.layout.GridData({span:"L8 M8 S8",indent:"L3 M3 S3",linebreakL:true,linebreakM:true,linebreakS:true}),})]});var y=new sap.m.CustomListItem({content:w,});var z=new sap.m.CustomListItem({content:u,});n.setModel(this.newEvaluationsModel);n.bindItems({path:"/EVALUATIONS",sorter:new sap.ui.model.Sorter({path:'INDICATOR',descending:false,group:true}),template:y});o.setModel(m.oldModel);o.bindItems({path:"/ActiveEvaluations",filters:[F],sorter:new sap.ui.model.Sorter({path:'objectId',descending:false,group:true}),template:z});this.prepareTempDataForNewList();},prepareTempDataForNewList:function(){var n={};n.EVALUATIONS=[];var t=this;var m=this;m.objectToPush={};m.objectToPush.INDICATORS=[];m.objectToPush.INDICATOR_TEXTS=[];m.objectToPush.EVALUATIONS=[];m.objectToPush.EVALUATION_TEXTS=[];m.objectToPush.EVALUATION_FILTERS=[];m.objectToPush.EVALUATION_VALUES=[];m.objectToPush.TAGS=[];var K=[];var a=[];var b=0;var E=[];var V=[];var c={};var d={};var e={};var f="";var g="";var h="";for(var i=0;i<m.selectedKPIs.length;i++){if(i<(m.selectedKPIs.length-1)){f+="id eq '"+m.selectedKPIs[i]+"' or ";g+="objectId eq '"+m.selectedKPIs[i]+"' or ";}else{f+="id eq '"+m.selectedKPIs[i]+"'";g+="objectId eq '"+m.selectedKPIs[i]+"'";}}c=m.serviceCallDataValidation("/ActiveKPIs",["$format=json","$filter=("+f+")"],m.oldModel);d=m.serviceCallDataValidation("/ActiveEvaluations",["$format=json","$filter=("+g+")"],m.oldModel);e=m.serviceCallDataValidation("/ActiveKPIsTexts",["$format=json","$filter=("+f+")"],m.oldModel);if(c.success){K=c.data;}if(d.success){E=d.data;}if(e.success){a=e.data;}if(K.length>0&&a.length>0){for(var i=0;i<a.length;i++){m.objectToPush.INDICATOR_TEXTS.push(m.migrateIndicatorTexts(a[i]));}}if(K.length>0){for(var i=0;i<K.length;i++){var l=[];m.objectToPush.INDICATORS.push(m.migrateIndicator(K[i]));l=m.migrateTags(K[i]);if(l.length>0){for(var k=0;k<l.length;k++){m.objectToPush.TAGS.push(l[k]);}}if(E.length>0){for(var j=0;j<E.length;j++){if(K[i].id==E[j].objectId){n.EVALUATIONS.push(m.migrateTempEvaluation(K[i],E[j]));}}}}}this.newEvaluationsModel.setData(n);m.hideBusy();if(n.EVALUATIONS.length==0){sap.m.MessageBox.show(m.oI18nModel.getResourceBundle().getText("MSG_NO_EVALUATIONS"),sap.m.MessageBox.Icon.INFORMATION,m.oI18nModel.getResourceBundle().getText("INFORMATION_MSG_TITLE"),[sap.m.MessageBox.Action.OK]);}},prepareMigrationData:function(){var m=this;var t=this;var n=this.newEvaluationsModel.getData();var a=m.newConfigurationObject.CONFIGURATIONS;if(m.objectToPush.EVALUATIONS.length>0)m.objectToPush.EVALUATIONS=[];m.objectToPush.EVALUATION_TEXTS=[];m.objectToPush.EVALUATION_FILTERS=[];m.objectToPush.EVALUATION_VALUES=[];m.objectToPush.DDA_MASTER=[];m.objectToPush.DDA_CONFIG=[];m.objectToPush.DDA_FILTERS=[];m.objectToPush.DDA_HEADER=[];m.objectToPush.DDA_CHART=[];m.objectToPush.DDA_COLUMNS=[];m.objectToPush.DDA_MASTER_TEXT=[];var K=[];var b=0;var E=[];var c;var V=[];var d={};var e={};var f={};var g={};var D={};var v={};var h={};var l="";var o="";var p="";var r="";var u="";var w="";var x="";for(var i=0;i<m.selectedKPIs.length;i++){if(i<(m.selectedKPIs.length-1)){l+="id eq '"+m.selectedKPIs[i]+"' or ";o+="objectId eq '"+m.selectedKPIs[i]+"' or ";}else{l+="id eq '"+m.selectedKPIs[i]+"'";o+="objectId eq '"+m.selectedKPIs[i]+"'";}}d=m.serviceCallDataValidation("/ActiveKPIs",["$format=json","$filter=("+l+")"],m.oldModel);e=m.serviceCallDataValidation("/ActiveEvaluations",["$format=json","$filter=("+o+")"],m.oldModel);f=m.serviceCallDataValidation("/ActiveEvaluationsTexts",["$format=json","$filter=("+o+")"],m.oldModel);if(d.success){K=d.data;}if(e.success){E=e.data;}if(f.success){c=f.data;}if(c&&E){if(c.length>0&&E.length>0){for(var i=0;i<c.length;i++){m.objectToPush.EVALUATION_TEXTS.push(m.migrateEvaluationTexts(c[i],n.EVALUATIONS));}}}if(K.length>0&&E.length>0){for(var i=0;i<K.length;i++){for(var j=0;j<E.length;j++){if(K[i].id==E[j].objectId){var y=[];m.objectToPush.EVALUATIONS.push(m.migrateEvaluation(K[i],E[j],n.EVALUATIONS));y=m.migrateEvaluationValues(K[i],E[j],n.EVALUATIONS);for(var k=0;k<y.length;k++){m.objectToPush.EVALUATION_VALUES.push(y[k]);}}}}for(var j=0;j<E.length;j++){r="id eq '"+E[j].variantId+"'";g=m.serviceCallDataValidation("/VARIANT_VALUES",["$format=json","$filter=("+r+")"],m.oldModelVariants);if(g.success){var A=[];A=m.migrateEvaluationFilters(E[j],g.data,n.EVALUATIONS);for(var k=0;k<A.length;k++){m.objectToPush.EVALUATION_FILTERS.push(A[k]);}}}var B="";for(var j=0;j<E.length;j++){var C=m.serviceCallDataValidation("/DDA_CONFIG_PROPERTIES",["$format=json","$filter=(objectId eq '"+E[j].objectId+"' and variantId eq '"+E[j].variantId+"' and property eq 'queryAnnotationDocURIs')"],m.oldModel);u="objectId eq '"+E[j].objectId+"' and variantId eq '"+E[j].variantId+"'";D=m.serviceCallDataValidation("/DDA_CONFIG_PROPERTIES",["$format=json","$filter=("+u+")"],m.oldModel);if(C.success&&D.success){var F={};var G=0;var H=0;var I="";var J;var L=C.data[0].variantId.split(' ').join('');var M="";if(L.indexOf('.')>-1){M=L.split('.');I=J||(C.data[0].objectId+"."+M[M.length-1]);}else{I=J||(C.data[0].objectId+"."+L);}B=C.data[0].value.split(",").length;for(var s=0;s<B;s++){H=0;G=0;for(var z=0;z<a.length;z++){if(a[z].CONFIGURATION_NAME==C.data[0].value.split(",")[s]){G++;break;}}if(G==0){F={};F.CONFIGURATION_ID=I+"."+C.data[0].value.split(",")[s];F.CONFIGURATION_NAME=C.data[0].value.split(",")[s];for(var q=0;q<n.EVALUATIONS.length;q++){if((E[j].objectId+"~"+E[j].variantId)==n.EVALUATIONS[q].OLD_ID){H++;F.EVALUATION_ID=n.EVALUATIONS[q].OLD_ID;break;}}if(H==0){F.EVALUATION_ID=E[j].objectId+"~"+E[j].variantId;break}a.push(jQuery.extend({},F));}}w="";for(var k=0;k<B;k++){if(k<(B-1)){w+="queryViewAnnotationDocumentURI eq '"+C.data[0].value.split(",")[k]+"' or ";}else{w+="queryViewAnnotationDocumentURI eq '"+C.data[0].value.split(",")[k]+"'";}}if(j==0||x=="")x=w;else x+=" or "+w;if(w.length>0){v=m.serviceCallDataValidation("/QUERYVIEWANNOTATION",["$format=json","$expand=QUERY_VIEW_PROPERTIES&$filter=("+w+")"],m.oldModelDDA);if(v.success)m.migrateDDA(D.data,v.data,n.EVALUATIONS,a);}}}if(x.length>0){h=m.serviceCallDataValidation("/QUERYVIEWANNOTATIONTEXTS",["$format=json","$filter=("+x+")"],m.oldModelDDA);var N=[];if(h.success){N=m.migrateDDAText(h.data,a,n.EVALUATIONS);for(var k=0;k<N.length;k++){m.objectToPush.DDA_MASTER_TEXT.push(N[k]);}}}}},migrateIndicator:function(K,m){m=m||1;var I={};I.ID=K.id;I.IS_ACTIVE=m;I.TYPE="KPI";I.TITLE=K.text;I.DESCRIPTION=K.description||"";if(Number(K.improvementDirection)==0){I.GOAL_TYPE="RA";}else if(Number(K.improvementDirection)==1){I.GOAL_TYPE="MA";}else{I.GOAL_TYPE="MI";}I.DATA_SPECIFICATION="";I.ODATA_URL=K.queryServiceURI;I.ODATA_ENTITYSET=K.queryQualifiedResultEntitySetName;I.VIEW_NAME="";I.COLUMN_NAME=K.queryResultMeasurePropertyName;I.OWNER_NAME=K.owner||"";I.OWNER_ID="";I.ENTITY_TYPE="";I.OWNER_E_MAIL="";I.ODATA_PROPERTY="";I.SEMANTIC_OBJECT=K.semanticObject;I.ACTION=K.semanticObjectAlias;return I;},migrateIndicatorTexts:function(K){var I={};I.ID=K.id;I.IS_ACTIVE=1;I.LANGUAGE=K.sapLanguageKey;I.TITLE=K.text;I.DESCRIPTION=K.description||"";return I;},migrateTags:function(K,m,t){m=m||1;t=t||"IN";var T=[];var a={};if(K.tags){if(K.tags.length>0){var b=K.tags.split(",");for(var i=0,l=b.length;i<l;i++){a.ID=K.id;a.IS_ACTIVE=m;a.TYPE=t;a.TAG=b[i];T.push(a);a={};}return T;}}return T;},migrateEvaluation:function(K,E,a,m){m=m||1;var b={};var c;for(var i=0;i<a.length;i++){if((E.objectId+"~"+E.variantId)==a[i].OLD_ID)c=a[i].ID;}var v="";var d=E.variantId.split(' ').join('');if(d.indexOf('.')>-1){v=d.split('.');b.ID=c||(E.objectId+"."+v[v.length-1]);}else{b.ID=c||(E.objectId+"."+d);}b.IS_ACTIVE=m;b.INDICATOR=E.objectId;b.INDICATOR_TYPE="KPI";b.TITLE=E.evaluationText;b.DESCRIPTION="";b.VIEW_NAME="";b.SCALING=E.scaleFactor;b.ODATA_URL=K.queryServiceURI;b.ODATA_ENTITYSET=K.queryQualifiedResultEntitySetName;b.COLUMN_NAME=K.queryResultMeasurePropertyName;b.OWNER_NAME=K.owner||"";b.OWNER_ID="";b.OWNER_E_MAIL="";b.ENTITY_TYPE="";if(Number(K.improvementDirection)==0){b.GOAL_TYPE="RA";}else if(Number(K.improvementDirection)==1){b.GOAL_TYPE="MA";}else{b.GOAL_TYPE="MI";}b.DATA_SPECIFICATION="";b.ODATA_PROPERTY="";b.SEMANTIC_OBJECT=K.semanticObject;b.ACTION=K.semanticObjectAlias;b.VALUES_SOURCE="FIXED";return b;},migrateEvaluationTexts:function(E,a){var b;var c={};for(var i=0;i<a.length;i++){if((E.objectId+"~"+E.variantId)==a[i].OLD_ID){b=a[i].ID;break;}}var v="";var d=E.variantId.split(' ').join('');if(d.indexOf('.')>-1){v=d.split('.');c.ID=b||(E.objectId+"."+v[v.length-1]);}else{c.ID=b||(E.objectId+"."+d);}c.IS_ACTIVE=1;c.LANGUAGE=E.sapLanguageKey;c.TITLE=E.evaluationText;c.DESCRIPTION="";return c;},migrateTempEvaluation:function(K,E,m){m=m||1;var a={};var v="";var b=E.variantId.split(' ').join('');if(b.indexOf('.')>-1){v=b.split('.');a.ID=E.objectId+"."+v[v.length-1];a.VALID_ID=E.objectId+"."+v[v.length-1];}else{a.ID=E.objectId+"."+b;a.VALID_ID=E.objectId+"."+b;}a.OLD_ID=E.objectId+"~"+E.variantId;a.VARIANT_ID=b;a.INDICATOR=E.objectId;a.TITLE=E.evaluationText;return a;},migrateEvaluationValues:function(K,E,a,m){m=m||1;var b=[];var e={};var c;for(var i=0;i<a.length;i++){if((E.objectId+"~"+E.variantId)==a[i].OLD_ID)c=a[i].ID;}var d="";var v="";var f=E.variantId.split(' ').join('');if(f.indexOf('.')>-1){v=f.split('.');d=c||(E.objectId+"."+v[v.length-1]);}else{d=c||(E.objectId+"."+f);}var g=0;if((E.toleranceRangeHighValue==0)||E.toleranceRangeHighValue){e.ID=d;e.IS_ACTIVE=m;e.TYPE="WH";e.FIXED=E.toleranceRangeHighValue;e.COLUMN_NAME="";e.ODATA_PROPERTY="";b.push(e);e={};}if((E.deviationRangeHighValue==0)||E.deviationRangeHighValue){e.ID=d;e.IS_ACTIVE=m;e.TYPE="CH";e.FIXED=E.deviationRangeHighValue;e.COLUMN_NAME="";e.ODATA_PROPERTY="";b.push(e);e={};}if((E.toleranceRangeLowValue==0)||E.toleranceRangeLowValue){e.ID=d;e.IS_ACTIVE=m;e.TYPE="WL";e.FIXED=E.toleranceRangeLowValue;e.COLUMN_NAME="";e.ODATA_PROPERTY="";b.push(e);e={};}if((E.deviationRangeLowValue==0)||E.deviationRangeLowValue){e.ID=d;e.IS_ACTIVE=m;e.TYPE="CL";e.FIXED=E.deviationRangeLowValue;e.COLUMN_NAME="";e.ODATA_PROPERTY="";b.push(e);e={};}if((E.target==0)||E.target){e.ID=d;e.IS_ACTIVE=m;e.TYPE="TA";e.FIXED=E.target;e.COLUMN_NAME="";e.ODATA_PROPERTY="";b.push(e);e={};}return b;},migrateEvaluationFilters:function(E,V,a,m){m=m||1;var b=[];var c;for(var i=0;i<a.length;i++){if((E.objectId+"~"+E.variantId)==a[i].OLD_ID)c=a[i].ID;}var d="";var v="";var e=E.variantId.split(' ').join('');if(e.indexOf('.')>-1){v=e.split('.');d=c||(E.objectId+"."+v[v.length-1]);}else{d=c||(E.objectId+"."+e);}var f={};for(var i=0,l=V.length;i<l;i++){f.ID=d;f.IS_ACTIVE=m;f.NAME=V[i].filterPropertyName;f.VALUE_1=V[i].value;f.VALUE_2=V[i].valueTo||"";f.OPERATOR=V[i].comparator;if(V[i].type=="F")f.TYPE="FI";if(V[i].type=="I")f.TYPE="PA";b.push(f);f={};}return b;},migrateDDAText:function(C,a,E){var m=this;var D=[];var b={};var c=[];var d=[];for(var j=0;j<C.length;j++){for(var i=0;i<a.length;i++){if(C[j].queryViewAnnotationDocumentURI==a[i].CONFIGURATION_NAME){c[j]=a[i].CONFIGURATION_ID;for(var k=0;k<E.length;k++){if(a[i].EVALUATION_ID==E[k].OLD_ID){d[j]=E[k].ID;break;}}}}}for(var i=0;i<C.length;i++){b={};b.CONFIGURATION_ID=c[i];b.EVALUATION_ID=d[i];b.SAP_LANGUAGE_KEY=C[i].sapLanguageKey;b.TEXT=C[i].title;b.IS_ACTIVE=1;D.push(b);}return D;},migrateDDAText:function(C,a,E){var m=this;var D=[];var b={};var c=[];var d=[];for(var j=0;j<C.length;j++){for(var i=0;i<a.length;i++){if(C[j].queryViewAnnotationDocumentURI==a[i].CONFIGURATION_NAME){c[j]=a[i].CONFIGURATION_ID;for(var k=0;k<E.length;k++){if(a[i].EVALUATION_ID==E[k].OLD_ID){d[j]=E[k].ID;break;}}}}}for(var i=0;i<C.length;i++){b={};b.CONFIGURATION_ID=c[i];b.EVALUATION_ID=d[i];b.SAP_LANGUAGE_KEY=C[i].sapLanguageKey;b.TEXT=C[i].title;b.IS_ACTIVE=1;D.push(b);}return D;},migrateDDA:function(D,Q,E,C){var a=this;var d={};var q=[];var b={};var c;for(var i=0;i<E.length;i++){if((D[0].objectId+"~"+D[0].variantId)==E[i].OLD_ID)c=E[i].ID;}var e="";var v="";var f=D[0].variantId.split(' ').join('');if(f.indexOf('.')>-1){v=f.split('.');e=c||(D[0].objectId+"."+v[v.length-1]);}else{e=c||(D[0].objectId+"."+f);}for(var i=0,l=Q.length;i<l;i++){b=Q[i];var g=0;for(var j=0,m=Q[i].QUERY_VIEW_PROPERTIES.length;j<m;j++){b[Q[i].QUERY_VIEW_PROPERTIES[j]["property"]]=Q[i].QUERY_VIEW_PROPERTIES[j]["value"];}if(q.length==0)q.push(jQuery.extend({},b));else{for(var k=0;k<q.length;k++){if(b.queryViewAnnotationDocumentURI==q[k].queryViewAnnotationDocumentURI)g++;}if(g==0)q.push(jQuery.extend({},b));}delete b.QUERY_VIEW_PROPERTIES;}for(var i=0,l=D.length;i<l;i++){if(D[i].property=='queryAnnotationDocURIs'){d.queryAnnotationDocURIs=D[i].value.split(",");}else if(D[i].property=='filters'){d.filters=D[i].value.split(",");}else{d[D[i].property]=D[i].value;}}h={};h.EVALUATION_ID=e;h.CONFIGURATION_ID="NIL";if(d.filters){for(j=0,m=d.filters.length;j<m;j++){h.DIMENSION=d.filters[j];h.VISIBILITY=1;h.IS_ACTIVE=1;a.objectToPush.DDA_FILTERS.push(jQuery.extend({},h));}}h={};h.EVALUATION_ID=e;h.CONFIGURATION_ID="NIL";h.REFERENCE_EVALUATION_ID=h.EVALUATION_ID;h.VISUALIZATION_TYPE='NT';h.VISUALIZATION_ORDER=1;h.VISIBILITY=1;h.DIMENSION=null;h.IS_ACTIVE=1;a.objectToPush.DDA_HEADER.push(jQuery.extend({},h));h.VISUALIZATION_TYPE='AT';h.VISUALIZATION_ORDER=2;h.VISIBILITY=1;h.DIMENSION=null;h.IS_ACTIVE=1;a.objectToPush.DDA_HEADER.push(jQuery.extend({},h));h.VISUALIZATION_TYPE='TT';h.VISUALIZATION_ORDER=3;h.VISIBILITY=1;h.DIMENSION=null;h.IS_ACTIVE=1;a.objectToPush.DDA_HEADER.push(jQuery.extend({},h));h={};h.EVALUATION_ID=e;h.CONFIGURATION_ID="NIL";h.PROPERTY_TYPE='SAP_FILTER';h.PROPERTY_VALUE='';h.VISIBILITY=d.isFilter||0;h.IS_ACTIVE=1;a.objectToPush.DDA_CONFIG.push(jQuery.extend({},h));h.PROPERTY_TYPE='SAP_AGGREGATE_VALUE';h.PROPERTY_VALUE='';h.VISIBILITY=d.aggregateNumberEnabled||0;h.IS_ACTIVE=1;a.objectToPush.DDA_CONFIG.push(jQuery.extend({},h));h.PROPERTY_TYPE='SAP_HEADER';h.PROPERTY_VALUE='';h.VISIBILITY=d.isTarget||0;h.IS_ACTIVE=1;a.objectToPush.DDA_CONFIG.push(jQuery.extend({},h));h.PROPERTY_TYPE='QUERY_SERVICE_URI';h.PROPERTY_VALUE=Q[0].queryServiceURI;h.VISIBILITY=1;h.IS_ACTIVE=1;a.objectToPush.DDA_CONFIG.push(jQuery.extend({},h));h.PROPERTY_TYPE='QUERY_ENTITY_SET';h.PROPERTY_VALUE=Q[0].queryQualifiedResultEntitySetName;h.VISIBILITY=1;h.IS_ACTIVE=1;a.objectToPush.DDA_CONFIG.push(jQuery.extend({},h));for(var i=0,l=d.queryAnnotationDocURIs.length;i<l;i++){var h={};var n;for(var k=0;k<C.length;k++){if(d.queryAnnotationDocURIs[i]==C[k].CONFIGURATION_NAME)n=C[k].CONFIGURATION_ID;}h.EVALUATION_ID=e;h.CONFIGURATION_ID=n||(e+"."+d.queryAnnotationDocURIs[i]);h.TEXT=q[i].title;h.CONFIG_ORDER=i+1;h.IS_ACTIVE=1;a.objectToPush.DDA_MASTER.push(jQuery.extend({},h));h={};var o=1;h.EVALUATION_ID=e;h.CONFIGURATION_ID=n||(e+"."+d.queryAnnotationDocURIs[i]);var p=q[i].measurePropertyNames.split(",");var r=q[i].dimensionPropertyNames.split(",");var s=q[i].QUERY_VIEW_PROPERTIES.results.filter(function(x){return x["property"]=="dimensionPropertySortNames"});var t=s.length?s[0].value:null;var u=t?t.split(","):null;s=q[i].QUERY_VIEW_PROPERTIES.results.filter(function(x){return x["property"]=="measurePropertySortNames"});var w=s.length?s[0].value:null;var y=w?w.split(","):null;s=q[i].QUERY_VIEW_PROPERTIES.results.filter(function(x){return x["property"]=="colorNames"});var z=s.length?s[0].value:null;var A=z?z.split(","):null;s=q[i].QUERY_VIEW_PROPERTIES.results.filter(function(x){return x["property"]=="colorType"});var B=s.length?s[0].value:null;s=q[i].QUERY_VIEW_PROPERTIES.results.filter(function(x){return x["property"]=="semanticColorMeasure"});var F=s.length?s[0].value:null;s=q[i].QUERY_VIEW_PROPERTIES.results.filter(function(x){return x["property"]=="hiddenMeasureNames"});var G=s.length?s[0].value:null;var H=G?G.split(","):null;for(var j=0,m=r.length;j<m;j++){h.NAME=r[j];h.TYPE='DIMENSION';if(u!=null){if(u.length){h.SORT_BY=(u&&u[j])?u[j]:r[j];}else h.SORT_BY=r[j];}else h.SORT_BY=r[j];h.AXIS=1;h.STACKING=0;h.VISIBILITY="BOTH";h.COLOR=null;switch(Number(q[i].orderBy)){case 1:h.SORT_ORDER=null;break;case 2:h.SORT_ORDER=null;break;case 3:h.SORT_ORDER='asc';break;case 4:h.SORT_ORDER='desc';break;case 0:h.SORT_ORDER=null;break;}h.COLUMNS_ORDER=o++;h.IS_ACTIVE=1;a.objectToPush.DDA_COLUMNS.push(jQuery.extend({},h));}for(var j=0,m=p.length;j<m;j++){h.NAME=p[j];h.TYPE='MEASURE';h.VISIBILITY="BOTH";if(y!=null){if(y.length){h.SORT_BY=(y&&y[j])?y[j]:p[j];}else h.SORT_BY=p[j];}else h.SORT_BY=p[j];if(q[i].chartType&&(jQuery.sap.startsWithIgnoreCase(q[i].chartType,"dual"))&&(j<2)){h.AXIS=j+1;}else{h.AXIS=1;}h.STACKING=0;h.COLOR=null;switch(Number(q[i].orderBy)){case 1:h.SORT_ORDER='asc';break;case 2:h.SORT_ORDER='desc';break;case 3:h.SORT_ORDER=null;break;case 4:h.SORT_ORDER=null;break;case 0:h.SORT_ORDER=null;break;}h.COLUMNS_ORDER=o++;h.IS_ACTIVE=1;if(q[i].chartType&&(q[i].chartType.indexOf("Stacked")>-1)){h.STACKING=1;}if(H!=null){if(H&&(H.indexOf(p[j])>-1)){h.VISIBILITY="CHART";}}if(B==0||B==2){if(A!=null)h.COLOR=(A&&A[j])?A[j]:"";else h.COLOR="";}else if(q[i].colorType==1){}a.objectToPush.DDA_COLUMNS.push(jQuery.extend({},h));}h={};h.EVALUATION_ID=e;h.CONFIGURATION_ID=n||(e+"."+d.queryAnnotationDocURIs[i]);h.VALUE_TYPE='ABSOLUTE';h.AXIS_TYPE='SINGLE';h.DATA_LIMIT=q[i].top||null;switch(q[i].chartType){case null:h.CHART_TYPE='Table';break;case'Select Type':h.CHART_TYPE='Table';break;case'StackedColumn':h.CHART_TYPE='Column';break;case'Stacked Column':h.CHART_TYPE='Column';break;case'Transposed':h.CHART_TYPE='Column';break;case'DualStackedBar':h.CHART_TYPE='Bar';h.AXIS_TYPE='DUAL';break;case'StackedBar':h.CHART_TYPE='Bar';break;case'StackedColumn100':h.CHART_TYPE='Column';h.VALUE_TYPE='PERCENTAGE';break;case'DualStackedColumn':h.CHART_TYPE='Column';h.AXIS_TYPE='DUAL';break;case'DualStackedBar100':h.CHART_TYPE='Bar';h.VALUE_TYPE='PERCENTAGE';h.AXIS_TYPE='DUAL';break;case'DualStackedColumn100':h.CHART_TYPE='Column';h.VALUE_TYPE='PERCENTAGE';h.AXIS_TYPE='DUAL';break;default:h.CHART_TYPE=q[i].chartType;}switch(B){case undefined:h.COLOR_SCHEME='NONE';break;case null:h.COLOR_SCHEME='NONE';break;case 0:h.COLOR_SCHEME='MANUAL_NON_SEMANTIC';break;case 1:h.COLOR_SCHEME='AUTO_SEMANTIC';break;case 2:h.COLOR_SCHEME='MANUAL_SEMANTIC';break;default:h.COLOR_SCHEME='NONE';}h.THRESHOLD_MEASURE=F;h.IS_ACTIVE=1;a.objectToPush.DDA_CHART.push(jQuery.extend({},h));}},clearData:function(){this.getView().byId("oldList").removeAllItems();this.getView().byId("newList").removeAllItems();this.objectToPush.INDICATORS=[];this.objectToPush.INDICATOR_TEXTS=[];this.objectToPush.EVALUATIONS=[];this.objectToPush.EVALUATION_TEXTS=[];this.objectToPush.EVALUATION_FILTERS=[];this.objectToPush.EVALUATION_VALUES=[];this.objectToPush.TAGS=[];this.objectToPush.DDA_MASTER=[];this.objectToPush.DDA_CONFIG=[];this.objectToPush.DDA_FILTERS=[];this.objectToPush.DDA_HEADER=[];this.objectToPush.DDA_CHART=[];this.objectToPush.DDA_COLUMNS=[];this.objectToPush.DDA_MASTER_TEXT=[];},migrateData:function(){var m=this;if((this.objectToPush!=undefined)&&(this.objectToPush.INDICATORS.length>0)){sap.m.MessageBox.show(m.oI18nModel.getResourceBundle().getText("MSG_MIGRATION_BEGIN"),sap.m.MessageBox.Icon.INFORMATION,m.oI18nModel.getResourceBundle().getText("INFORMATION_MSG_TITLE"),[sap.m.MessageBox.Action.OK],function(){m.showBusy("M");setTimeout(function(){m.writeData();},2500);});}else{sap.m.MessageBox.show(m.oI18nModel.getResourceBundle().getText("MSG_NO_KPI"),sap.m.MessageBox.Icon.INFORMATION,m.oI18nModel.getResourceBundle().getText("INFORMATION_MSG_TITLE"),[sap.m.MessageBox.Action.OK]);}},cancel:function(){window.history.back();},writeData:function(){var m=this;this.errorMessage="";this.prepareMigrationData();var d=m.objectToPush;if(d){m.initiateRequests();}},initiateRequests:function(){var m=this;var u="/sap/hba/r/sb/core/logic/MIGRATION.xsjs";jQuery.ajax({url:"/sap/hba/r/sb/core/logic/__token.xsjs",async:false,type:"HEAD",headers:{"X-CSRF-Token":"Fetch"},success:function(d,s,x){jQuery.ajax({type:"POST",url:u,cache:false,data:encodeURIComponent(JSON.stringify(m.objectToPush)),headers:{"X-CSRF-Token":x.getResponseHeader("X-CSRF-Token")},success:function(a){if(JSON.parse(a).success){sap.m.MessageBox.show(m.oI18nModel.getResourceBundle().getText("MSG_MIGRATION_SUCCESS"),sap.m.MessageBox.Icon.INFORMATION,m.oI18nModel.getResourceBundle().getText("INFORMATION_MSG_TITLE"),[sap.m.MessageBox.Action.OK],function(){m.cancel()});}else{sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:m.oI18nModel.getResourceBundle().getText("MSG_MIGRATION_ERROR"),details:JSON.parse(a).errorMessage});}m.hideBusy();},async:true,error:function(X,t,e){sap.ca.ui.message.showMessageBox({type:sap.ca.ui.message.Type.ERROR,message:m.oI18nModel.getResourceBundle().getText("MSG_MIGRATION_ERROR"),details:e+"\n"+JSON.parse(X.responseText).errorMessage});m.hideBusy();}});},error:function(){sap.suite.ui.smartbusiness.lib.Util.utils.showErrorMessage(that.oApplicationFacade.getResourceBundle().getText("ERR_FETCH_AUTH_TOKEN"));$.sap.log.error("ERR_FETCH_AUTH_TOKEN");}});},serviceCreate:function(e,p,O){var r={success:false,text:""};O.create(e,p,null,function(d){r.success=true;},function(a){var b=JSON.parse(a.response.body);r.success=false;r.text=a.response.statusText+" - "+b.error.message.value;});return r;},serviceDelete:function(e,i,O){var r={success:false,text:""};O.remove(e+"("+i+")",null,function(d){r.success=true;},function(a){r.success=false;r.text=a.response.statusText;},false,"",true);return r;},serviceCallDataValidation:function(e,p,d){var r={success:false,text:""};d.read(e,null,p,false,function(a,b){if(a.results[0]){r.success=true;r.data=a.results;}else{r.success=false;r.text="Record not found";}},function(a){r.success=false;r.text=a.response.statusText;});return r;},});
