<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>Test Page for RTA ContextMenu</title>

<style>
html, body, #qunit-tests {
	height: 100%;
}

.sapUiView {
	height: 100%;
}

#test-view {
	border: 1px solid grey;
	position: fixed;
	bottom: 0;
	right: 0;
	width: 50%;
	height: 50%;
}
</style>

<script id="sap-ui-bootstrap" data-sap-ui-theme="sap_bluecrystal"
	type="text/javascript" data-sap-ui-noConflict="true"
	data-sap-ui-resourceroots='{"sap.ui.rta.test": "../testdata/rta/"}'
	data-sap-ui-libs="sap.ui.rta,sap.ui.commons,sap.m,sap.ui.layout,sap.ui.dt"
	src="../../../../../resources/sap-ui-core.js">
		</script>
<link rel="stylesheet"
	href="../../../../../resources/sap/ui/thirdparty/qunit.css"
	type="text/css" media="screen" />
<script type="text/javascript"
	src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script type="text/javascript"
	src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script type="text/javascript"
	src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
<script type="text/javascript">
			jQuery.sap.require("sap.ui.qunit.qunit-coverage");

			if (window.blanket){
				window.blanket.options("sap-ui-cover-only", "[sap/ui/rta,sap/ui/dt]");
			}

			jQuery.sap.require("sap.uxap.ObjectPageSection");
			jQuery.sap.require("sap.uxap.ObjectPageLayout");

			jQuery.sap.require("sap.ui.comp.smartform.GroupElement");
			jQuery.sap.require("sap.ui.comp.smartform.Group");
			jQuery.sap.require("sap.ui.comp.smartform.SmartForm");
			jQuery.sap.require("sap.ui.comp.smartfield.SmartField");
			jQuery.sap.require("sap.ui.rta.RuntimeAuthoring");
			jQuery.sap.require("sap.ui.dt.OverlayRegistry");

			var oCompCont = new sap.ui.core.ComponentContainer("CompCont1", {
				name: "sap.ui.rta.test",
				id: "Comp1",
				settings: {
					componentData: {
						"showAdaptButton" : true
					}
				}
			}).placeAt("test-view");
			sap.ui.getCore().applyChanges();

			QUnit.module("Given RTA is started...", {
				beforeEach : function(assert) {
					this.oSmartForm = sap.ui.getCore().byId("idMain1--MainForm");
					this.oGroup = sap.ui.getCore().byId("idMain1--GeneralLedgerDocument");
					this.oBoundGroupElement = sap.ui.getCore().byId("idMain1--GeneralLedgerDocument.Name");
					this.oMandatoryGroupElement = sap.ui.getCore().byId("idMain1--GeneralLedgerDocument.Mandatory");
					this.oUnBoundGroupElement = sap.ui.getCore().byId("idMain1--GeneralLedgerDocument.UnboundButton");
					this.oMultipleFieldOneBoundGroupElement = sap.ui.getCore().byId("idMain1--GeneralLedgerDocument.BoundButton");
					this.oMultipleBoundFieldGroupElement = sap.ui.getCore().byId("idMain1--GeneralLedgerDocument.BoundButton35");
					this.oFieldInGroupWithoutStableId = sap.ui.getCore().byId("idMain1--FieldInGroupWithoutStableId");

					var done = assert.async();

					this.oRta = new sap.ui.rta.RuntimeAuthoring({
						rootControl : oCompCont.getComponentInstance().getAggregation("rootControl")
					});
					this.oRta.attachStart(function() {
						done();
					});
					this.oRta.start();
				},
				afterEach : function(assert) {
					this.oRta.destroy();
				}
			});

			QUnit.test("when context menu is opend (via keyboard) for a sap.ui.comp.smartform.GroupElement,", function(assert) {
				var oGroupElementOverlay = sap.ui.dt.OverlayRegistry.getOverlay(this.oBoundGroupElement);
				oGroupElementOverlay.focus();
				sap.ui.test.qunit.triggerKeydown(oGroupElementOverlay.getDomRef(), jQuery.sap.KeyCodes.F10, true, false, false);

				var oContextMenu = this.oRta._oContextMenuPlugin._oContextMenuControl;
				assert.ok(oContextMenu.bOpen, "then Menu gets opened");
				assert.equal(oContextMenu.getItems().length, 6, " and 6 Menu Items are available");
				assert.equal(oContextMenu.getItems()[0].data("id"), "CTX_RENAME_LABEL", "we can rename a label");
				assert.equal(oContextMenu.getItems()[1].data("id"), "CTX_ADD_FIELD", "we can add field");
				assert.equal(oContextMenu.getItems()[2].data("id"), "CTX_HIDE_FIELD", "we can hide field");
				assert.equal(oContextMenu.getItems()[3].data("id"), "CTX_CUT", "we can cut field");
				assert.equal(oContextMenu.getItems()[4].data("id"), "CTX_PASTE", "we can paste field");
				assert.equal(oContextMenu.getItems()[5].data("id"), "CTX_ADAPT", "we can adapt");
			});

			QUnit.test("when context menu is opend (via mouse) for a sap.ui.comp.smartform.Group,", function(assert) {
				var oGroupOverlay = sap.ui.dt.OverlayRegistry.getOverlay(this.oGroup);

				sap.ui.test.qunit.triggerMouseEvent(oGroupOverlay.getDomRef(), "contextmenu");

				var oContextMenu = this.oRta._oContextMenuPlugin._oContextMenuControl;
				assert.ok(oContextMenu.bOpen, "then Menu gets opened");
				assert.equal(oContextMenu.getItems().length, 7, " and 7 Menu Items are available");
				assert.equal(oContextMenu.getItems()[0].data("id"), "CTX_RENAME_GROUP", "we can rename a group");
				assert.equal(oContextMenu.getItems()[1].data("id"), "CTX_ADD_FIELD", "we can add field");
				assert.equal(oContextMenu.getItems()[2].data("id"), "CTX_ADD_GROUP", "we can add group");
				assert.equal(oContextMenu.getItems()[3].data("id"), "CTX_HIDE_GROUP", "we can remove group");
				assert.equal(oContextMenu.getItems()[4].data("id"), "CTX_CUT", "we can cut group");
				assert.equal(oContextMenu.getItems()[5].data("id"), "CTX_PASTE", "we can paste group");
				assert.equal(oContextMenu.getItems()[6].data("id"), "CTX_ADAPT", "we can adapt");
			});

			QUnit.test("when context menu is opend (via keyboard) for a sap.ui.comp.smartform.SmartForm,", function(assert) {
				var oFormOverlay = sap.ui.dt.OverlayRegistry.getOverlay(this.oSmartForm);
				oFormOverlay.focus();
				sap.ui.test.qunit.triggerKeydown(oFormOverlay.getDomRef(), jQuery.sap.KeyCodes.F10, true, false, false);

				var oContextMenu = this.oRta._oContextMenuPlugin._oContextMenuControl;
				assert.ok(oContextMenu.bOpen, "then Menu gets opened");
				assert.equal(oContextMenu.getItems().length, 2, " and 2 Menu Items are available");
				assert.equal(oContextMenu.getItems()[0].data("id"), "CTX_ADD_GROUP", "we can add group");
				assert.equal(oContextMenu.getItems()[1].data("id"), "CTX_ADAPT", "we can adapt");
			});

			QUnit.test("when context menu is opend (via mouse) for a mandatory selected GroupElement,", function(assert) {
				var oGroupElementOverlay = sap.ui.dt.OverlayRegistry.getOverlay(this.oMandatoryGroupElement);

				sap.ui.test.qunit.triggerMouseEvent(oGroupElementOverlay.getDomRef(), "contextmenu");

				var oContextMenu = this.oRta._oContextMenuPlugin._oContextMenuControl;
				assert.ok(oContextMenu.bOpen, "then Menu gets opened");
				assert.equal(oContextMenu.getItems().length, 6, " and 6 Menu Items are available");
				assert.equal(oContextMenu.getItems()[0].data("id"), "CTX_RENAME_LABEL", "we can rename a label");
				assert.equal(oContextMenu.getItems()[1].data("id"), "CTX_ADD_FIELD", "we can add field");
				assert.equal(oContextMenu.getItems()[2].data("id"), "CTX_HIDE_FIELD", "we can hide field");
				assert.equal(oContextMenu.getItems()[3].data("id"), "CTX_CUT", "we can cut field");
				assert.equal(oContextMenu.getItems()[4].data("id"), "CTX_PASTE", "we can paste field");
				assert.equal(oContextMenu.getItems()[5].data("id"), "CTX_ADAPT", "we can adapt");
			});

			QUnit.test("when context menu is opend on two selected GroupElements and both have bound fields,", function(assert) {
				var oGroupElementOverlay1 = sap.ui.dt.OverlayRegistry.getOverlay(this.oMandatoryGroupElement);
				var oGroupElementOverlay2 = sap.ui.dt.OverlayRegistry.getOverlay(this.oBoundGroupElement);

				this.oRta._oDesignTime.setSelectionMode(sap.ui.dt.SelectionMode.Multi);
				oGroupElementOverlay1.setSelected(true);
				oGroupElementOverlay2.setSelected(true);

				sap.ui.test.qunit.triggerMouseEvent(oGroupElementOverlay1.getDomRef(), "contextmenu");

				var oContextMenu = this.oRta._oContextMenuPlugin._oContextMenuControl;
				assert.ok(oContextMenu.bOpen, "then Menu gets opened");
				assert.equal(oContextMenu.getItems().length, 7, " and 7 Menu Items are available");
				assert.equal(oContextMenu.getItems()[0].data("id"), "CTX_RENAME_LABEL", "we can rename a label");
				assert.equal(oContextMenu.getItems()[1].data("id"), "CTX_ADD_FIELD", "we can add field");
				assert.equal(oContextMenu.getItems()[2].data("id"), "CTX_HIDE_FIELD", "we can hide field");
				assert.equal(oContextMenu.getItems()[3].data("id"), "CTX_CUT", "we can cut groups");
				assert.equal(oContextMenu.getItems()[4].data("id"), "CTX_PASTE", "we can paste groups");
				assert.equal(oContextMenu.getItems()[5].data("id"), "CTX_GROUP_FIELDS", "we can group fields");
				assert.equal(oContextMenu.getItems()[6].data("id"), "CTX_ADAPT", "we can adapt");
			});

			QUnit.test("when context menu is opend on two selected GroupElement when one field has no binding,", function(assert) {
				var oGroupElementOverlay1 = sap.ui.dt.OverlayRegistry.getOverlay(this.oUnBoundGroupElement);
				var oGroupElementOverlay2 = sap.ui.dt.OverlayRegistry.getOverlay(this.oBoundGroupElement);

				this.oRta._oDesignTime.setSelectionMode(sap.ui.dt.SelectionMode.Multi);
				oGroupElementOverlay1.setSelected(true);
				oGroupElementOverlay2.setSelected(true);

				sap.ui.test.qunit.triggerMouseEvent(oGroupElementOverlay1.getDomRef(), "contextmenu");

				var oContextMenu = this.oRta._oContextMenuPlugin._oContextMenuControl;
				assert.ok(oContextMenu.bOpen, "then Menu gets opened");
				assert.equal(oContextMenu.getItems().length, 7, " and 7 Menu Items are available");
				assert.equal(oContextMenu.getItems()[0].data("id") , "CTX_RENAME_LABEL", "we can rename a label");
				assert.equal(oContextMenu.getItems()[1].data("id") , "CTX_ADD_FIELD", "we can add field");
				assert.equal(oContextMenu.getItems()[2].data("id"), "CTX_HIDE_FIELD", "we can hide field");
				assert.equal(oContextMenu.getItems()[3].data("id"), "CTX_CUT", "we can cut groups");
				assert.equal(oContextMenu.getItems()[4].data("id"), "CTX_PASTE", "we can paste groups");
				assert.equal(oContextMenu.getItems()[5].data("id"), "CTX_GROUP_FIELDS" , "group fields is there ");
				assert.equal(oContextMenu.getItems()[5].getEnabled(), false, "we can not group fields");
				assert.equal(oContextMenu.getItems()[6].data("id"), "CTX_ADAPT", "we can adapt");
			});

			QUnit.test("when context menu is opend on GroupElement when two fields, one field has no binding,", function(assert) {
				var oGroupElementOverlay = sap.ui.dt.OverlayRegistry.getOverlay(this.oMultipleFieldOneBoundGroupElement);

				sap.ui.test.qunit.triggerMouseEvent(oGroupElementOverlay.getDomRef(), "contextmenu");

				var oContextMenu = this.oRta._oContextMenuPlugin._oContextMenuControl;
				assert.ok(oContextMenu.bOpen, "then Menu gets opened");
				assert.equal(oContextMenu.getItems().length, 7, " and 7 Menu Items are available");
				assert.equal(oContextMenu.getItems()[0].data("id") , "CTX_RENAME_LABEL", "we can rename a label");
				assert.equal(oContextMenu.getItems()[1].data("id") , "CTX_ADD_FIELD", "we can add field");
				assert.equal(oContextMenu.getItems()[2].data("id") , "CTX_HIDE_FIELD", "we can hide field");
				assert.equal(oContextMenu.getItems()[3].data("id"), "CTX_CUT", "we can cut groups");
				assert.equal(oContextMenu.getItems()[4].data("id"), "CTX_PASTE", "we can paste groups");
				assert.equal(oContextMenu.getItems()[5].data("id") , "CTX_UNGROUP_FIELDS", "ungroup fields is there ");
				assert.equal(oContextMenu.getItems()[5].getEnabled(), false, "we can not ungroup fields");
				assert.equal(oContextMenu.getItems()[6].data("id") , "CTX_ADAPT", "we can adapt");

			});

			QUnit.test("when context menu is opend on GroupElement when two fields,", function(assert) {
				var oGroupElementOverlay = sap.ui.dt.OverlayRegistry.getOverlay(this.oMultipleBoundFieldGroupElement);

				sap.ui.test.qunit.triggerMouseEvent(oGroupElementOverlay.getDomRef(), "contextmenu");

				var oContextMenu = this.oRta._oContextMenuPlugin._oContextMenuControl;
				assert.ok(oContextMenu.bOpen, "then Menu gets opened");
				assert.equal(oContextMenu.getItems().length, 7, " and 7 Menu Items are available");
				assert.equal(oContextMenu.getItems()[0].data("id") , "CTX_RENAME_LABEL", "we can rename a label");
				assert.equal(oContextMenu.getItems()[1].data("id") , "CTX_ADD_FIELD", "we can add field");
				assert.equal(oContextMenu.getItems()[2].data("id") , "CTX_HIDE_FIELD", "we can hide field");
				assert.equal(oContextMenu.getItems()[3].data("id"), "CTX_CUT", "we can cut groups");
				assert.equal(oContextMenu.getItems()[4].data("id"), "CTX_PASTE", "we can paste groups");
				assert.equal(oContextMenu.getItems()[5].data("id") , "CTX_UNGROUP_FIELDS", "ungroup fields is there ");
				assert.equal(oContextMenu.getItems()[5].getEnabled(), true, "we can ungroup fields");
				assert.equal(oContextMenu.getItems()[6].data("id") , "CTX_ADAPT", "we can adapt");

			});

			QUnit.test("when context menu is opend on GroupElement with stable id, but the Group has no stable id,", function(assert) {
				var oGroupElementOverlay = sap.ui.dt.OverlayRegistry.getOverlay(this.oFieldInGroupWithoutStableId);

				sap.ui.test.qunit.triggerMouseEvent(oGroupElementOverlay.getDomRef(), "contextmenu");

				var oContextMenu = this.oRta._oContextMenuPlugin._oContextMenuControl;
				assert.ok(oContextMenu.bOpen, "then Menu gets opened");
				assert.equal(oContextMenu.getItems().length, 4, " and 4 Menu Items are available");
				assert.equal(oContextMenu.getItems()[0].data("id") , "CTX_RENAME_LABEL", "rename is available");
				assert.equal(oContextMenu.getItems()[0].getEnabled(), true, "we can rename the field");
				assert.equal(oContextMenu.getItems()[1].data("id") , "CTX_ADD_FIELD", "add field is available");
				assert.equal(oContextMenu.getItems()[1].getEnabled(), false, "we cannot add a field");
				assert.equal(oContextMenu.getItems()[2].data("id") , "CTX_HIDE_FIELD", "hide field is available");
				assert.equal(oContextMenu.getItems()[2].getEnabled(), true, "we can hide the field");
				assert.equal(oContextMenu.getItems()[3].data("id") , "CTX_ADAPT", "'More...' is available");

			});

			QUnit.test("when opening the more dialog for a group,", function(assert) {

				var done = assert.async();

				function moreDialogOpened() {
					assert.ok(this, "then the more dialog was opened");
					this.close();
					done();
				}
				var oGroupOverlay = sap.ui.dt.OverlayRegistry.getOverlay(this.oGroup);
				this.oRta._handleAdaptElement([oGroupOverlay], function(oFormP13Handler){
					oFormP13Handler._oDialog.oPopup.attachOpened(moreDialogOpened);
				});
			});

			QUnit.module("Given RTA is started for Object Page...", {
				beforeEach : function(assert) {
					this.oObjectPageSection1 = new sap.uxap.ObjectPageSection({
						id : "section1",
						title: "Section_1",
						visible : true
					});

					this.oObjectPageSection2 = new sap.uxap.ObjectPageSection({
						id : "section2",
						title: "Section_2",
						visible : false
					});

					this.oObjectPageLayout = new sap.uxap.ObjectPageLayout({
						id : "ObjectPageLayout",
						sections : [
							this.oObjectPageSection1,
							this.oObjectPageSection2,
						]
					});
					this.oObjectPageLayout.placeAt("test-view");
					sap.ui.getCore().applyChanges();

					var done = assert.async();

					this.oRta = new sap.ui.rta.RuntimeAuthoring({
						rootControl : this.oObjectPageLayout
					});
					this.oRta.attachStart(function() {
						done();
					});
					this.oRta.start();
				},
				afterEach : function(assert) {
					this.oRta.destroy();
				}
			});

			QUnit.test("when context menu is opend on ObjectPageSection", function(assert) {
				var oOverlay = sap.ui.dt.OverlayRegistry.getOverlay(this.oObjectPageSection1);

				this.oRta._oContextMenuPlugin.open({ pageX: 0, pageY: 0 }, oOverlay);

				var oContextMenu = this.oRta._oContextMenuPlugin._oContextMenuControl;
				assert.ok(oContextMenu.bOpen, "then Menu gets opened");
				assert.equal(oContextMenu.getItems().length, 4, " and 4 Menu Items are available");
				assert.equal(oContextMenu.getItems()[0].data("id") , "CTX_ADD_SECTION", "add section is available");
				assert.equal(oContextMenu.getItems()[0].getEnabled(), true, "add section is enabled");
				assert.equal(oContextMenu.getItems()[1].data("id") , "CTX_HIDE_SECTION", "remove section is available");
				assert.equal(oContextMenu.getItems()[1].getEnabled(), true, "we can remove a section");
				assert.equal(oContextMenu.getItems()[2].data("id") , "CTX_CUT", "cut sections available");
				assert.equal(oContextMenu.getItems()[2].getEnabled(), true, "cut is enabled");
				assert.equal(oContextMenu.getItems()[3].data("id") , "CTX_PASTE", "paste is available");
				assert.equal(oContextMenu.getItems()[3].getEnabled(), false, "we cannot paste a section");
			});

			QUnit.done(function( details ) {
				oCompCont.getComponentInstance().destroy();
				if(details.failed === 0){
					jQuery("#test-view").hide();
				};
			});
		</script>
</head>
<body>
	<h1 id="qunit-header">QUnit page for RTA ContextMenu</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<div id="qunit-testrunner-toolbar"></div>
	<ol id="qunit-tests"></ol>
	<div id="test-view"></div>
</body>
</html>
