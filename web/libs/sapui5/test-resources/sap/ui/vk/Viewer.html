<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta charset="UTF-8">

		<title>Testpage - sap.ui.vk.Viewer</title>
		<style>
			.sapVizKitViewer {
				width: 100% !important;
			}
		</style>
		<!--[if lte IE 9]><script type="text/javascript">
		(function() {
		var baseTag = document.getElementsByTagName('base')[0];
		baseTag.href = baseTag.href;
		})();
		</script><![endif]-->

		<script id="sap-ui-bootstrap"
				data-sap-ui-libs="sap.ui.vk, sap.ui.unified, sap.m, sap.ui.layout"
				data-sap-ui-theme="sap_bluecrystal"
				src="../../../../resources/sap-ui-core.js">
		</script>

		<script>
			function isDesktop() {
				return sap.ui.Device.os.windows || sap.ui.Device.os.macintosh || sap.ui.Device.os.linux;
			}

			function testSingleResource() {
				var data = {
					remoteFile: {
						url: "/models/998 Clutch.vds",//"/models/Super Sport 38.vds"
						fileType: "vds",
						id: "abc123"
					}
				};

				var model = new sap.ui.model.json.JSONModel();
				model.setData(data);
				sap.ui.getCore().setModel(model);

				jQuery.sap.require("sap.ui.vk.ContentResource");
				var viewer = new sap.ui.vk.Viewer({
					contentResources: new sap.ui.vk.ContentResource({
						source: "{/remoteFile/url}",
						sourceType: "{/remoteFile/fileType}",
						sourceId: "{/remoteFile/id}"
					}),
					runtimeSettings: {
						totalMemory: 64 * 1024 * 1024
					},
					webGLContextAttributes: {
						antialias: true
					}
				});

				return viewer;
			}

			function testMultipleResources() {
				var data = {
					remoteFiles: [
						{
							url: "/models/Pump Service Operation.vds",
							fileType: "vds",
							id: "abc123"
						},
						{
							url: "/models/998 Clutch.vds",
							fileType: "vds",
							id: "xyz789"
						}
					]
				};

				var model = new sap.ui.model.json.JSONModel();
				model.setData(data);
				sap.ui.getCore().setModel(model);

				jQuery.sap.require("sap.ui.vk.ContentResource");
				var itemTemplate = new sap.ui.vk.ContentResource({
					source: "{url}",
					sourceType: "{fileType}",
					sourceId: "{id}"
				});

				var viewer = new sap.ui.vk.Viewer({
					contentResources: {
						path: "/remoteFiles",
						template: itemTemplate
					}
				});

				return viewer;
			}

			function testNoResources() {
				var viewer = new sap.ui.vk.Viewer();
				return viewer;
			}

			function testWithNodes() {
				var data;
				if (false) {
					data = {
						resources:[
							{
								url: "https://en.wikipedia.org/static/images/project-logos/enwiki-2x.png",
								fileType: "png",
								id: "abc"
							}
						]
					};
				} else {
					data = {
						resources: [
						    {
								//url: "/models/empty.vds",
								//url: "/models/998 Clutch-screw.vds",
								url: "/models/998 Clutch-no screws.vds",
								fileType: "vds",
								id: "main",
								resources:[
									{
										id: "screws",
										name: "Screws",
										matrix: [1,0,0, 0,1,0, 0,0,1, 0,0,0],
										resources: [
											{
												url: "/models/998 Clutch-screw.vds",
												fileType: "vds",
												id: "s1",
												name: "Screw",
												matrix: [-1,0,0, 0,-0.866027,-0.5, 0,-0.5,0.866026, 12.5,-22.5,38.9712]
											},
											{
												url: "/models/998 Clutch-screw.vds",
												fileType: "vds",
												id: "s2",
												name: "Screw",
												matrix: [-1,0,0, 0,-0.866027,0.5, 0,0.5,0.866026, 12.5,22.5,38.9712]
											},
											{
												url: "/models/998 Clutch-screw.vds",
												fileType: "vds",
												id: "s3",
												name: "Screw",
												matrix: [-1,0,0, 0,0,1, 0,1,0, 12.5,45,0]
											},
											{
												url: "/models/998 Clutch-screw.vds",
												fileType: "vds",
												id: "s4",
												name: "Screw",
												matrix: [-1,0,0, 0,0.866027,0.5, 0,0.5,-0.866026, 12.5,22.5,-38.9712]
											},
											{
												url: "/models/998 Clutch-screw.vds",
												fileType: "vds",
												id: "s5",
												name: "Screw",
												matrix: [-1,0,0, 0,0.866027,-0.5, 0,-0.5,-0.866026, 12.5,-22.5,-38.9712]
											},
											{
												url: "/models/998 Clutch-screw.vds",
												fileType: "vds",
												id: "s6",
												name: "Screw",
												matrix: [-1,0,0, 0,0,-1, 0,-1,0, 12.5,-45,0]
											}
										]
									}
								]
							}
						]
					};
				}

				var model = new sap.ui.model.json.JSONModel();
				model.setData(data);
				sap.ui.getCore().setModel(model);

				jQuery.sap.require("sap.ui.vk.ContentResource");

				var viewer = new sap.ui.vk.Viewer({
					contentResources: {
						path: "/",
						parameters: {
							arrayNames: ["resources"]
						},
						factory: function(id, context) {
							var contentResource = new sap.ui.vk.ContentResource(id, {
								source: "{url}",
								sourceType: "{fileType}",
								sourceId: "{id}",
								localMatrix: "{matrix}",
								name: "{name}"
							});
							return contentResource;
						}
					}
				});
				return viewer;
			}

			var nodeData = {
				matrix: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0]
			};

			var nodeModel = new sap.ui.model.json.JSONModel();
			nodeModel.setData(nodeData);
			sap.ui.getCore().setModel(nodeModel, "node");

			//var viewer = testSingleResource();
			//var viewer = testMultipleResources();
			//var viewer = testWithNodes();
			var viewer = testNoResources();

			//VDS file load error handler
			viewer.attachSceneLoadingFailed(function(event) {
				//code raises error handler	
			});

			//VDS file load successfuly handler
			viewer.attachSceneLoadingSucceeded(function(event) {
				var scene = event.getParameter("scene");

				if (scene) {
					var nodeHierarchy = scene.getDefaultNodeHierarchy();
					var tree = "(Scene)\n";
					function indent(level) {
						var result = "";
						for (var i = 0; i < level * 8; ++i) {
							result += " ";
						}
						return result;
					}
					function buildTree(level, node) {
						var prefix = indent(level);
						tree += prefix;
						if (node.getHasChildren()) {
							tree += "[-] ";
						}
						tree += node.getName() + " - " + node.getNodeId() + "\n";
						nodeHierarchy.enumerateChildren(node.getNodeId(), buildTree.bind(undefined, level + 1));
					}
					scene.getDefaultNodeHierarchy().enumerateChildren(buildTree.bind(undefined, 1));
					jQuery.sap.log.info(tree);
				} else {
					jQuery.sap.log.info("Image file load successful")
				}
			});

			var sourceData = {
				localFile: undefined,
				remoteUrl: undefined
			};
			var model = new sap.ui.model.json.JSONModel();
			model.setData(sourceData);
			sap.ui.getCore().setModel(model, "source");

			var layout = new sap.ui.layout.form.GridLayout({
				singleColumn: true
			});

			var container1 = sap.ui.layout.form.FormElement({
				fields: [
					new sap.m.Input({
						layoutData: new sap.ui.layout.form.GridElementData({ hCells: "auto" }),
						placeholder: "Remote model URL",
						value: "{source>/remoteUrl}"
					}),
					new sap.m.Button({
						layoutData: new sap.ui.layout.form.GridElementData({ hCells: "1" }),
						text: "Load",
						press: function(event) {
							if (sourceData.remoteUrl) {
								viewer.destroyContentResources();
								var contentResource = new sap.ui.vk.ContentResource({
									source: sourceData.remoteUrl,
									sourceType: "vds",
									sourceId: "abc"
								});
								viewer.addContentResource(contentResource);
							}
						}
					}),
					new sap.m.Button({
						layoutData: new sap.ui.layout.form.GridElementData({ hCells: "1" }),
						text: "Load Image",
						press: function(event) {
							if (sourceData.remoteUrl) {
								viewer.destroyContentResources();
								var contentResource = new sap.ui.vk.ContentResource({
									source: sourceData.remoteUrl,
								 	sourceType: sourceData.remoteUrl.split(".").slice(-1)[0],
									sourceId: "abc"
								});
								viewer.addContentResource(contentResource);
							}
						}
					})
				]
			});

			var container2 = new sap.ui.layout.form.FormElement({
				fields: [
					new sap.ui.unified.FileUploader({
						layoutData: new sap.ui.layout.form.GridElementData({ hCells: "auto" }),
						width: "100%",
						placeholder: "Local filename",
						fileType: [ "vds", "png", "jpg", "jpeg", "gif","tiff","tif","svg","bmp" ],
						change: function(event) {
							sourceData.localFile = event.getParameter("files")[0];

							if (sourceData.localFile) {
								viewer.destroyContentResources();

								var filename = sourceData.localFile.name;
								var index = filename.lastIndexOf(".");
								var sourceType;
								if (index >= 0 && index < filename.length - 1) {
									sourceType = filename.substr(index + 1);
								}

								var contentResource = new sap.ui.vk.ContentResource({
									source: sourceData.localFile,
									sourceType: sourceType,
									sourceId: "abc"
								});

								viewer.addContentResource(contentResource);
							}
						}
					}),
					new sap.m.ToggleButton({
						layoutData: new sap.ui.layout.form.GridElementData({ hCells: "1" }),
						text: "Toggle Debug Info",
						tooltip: "Toggle Debug Info",
						pressed: false,
						press: function() {
							viewer.getGraphicsCore().showDebugInfo(this.getPressed());
						}
					})
				]
			});

			viewer.setWidth("100%");
			viewer.setHeight("525px");

			function handleSelectionChanged(event) {
				jQuery.sap.log.debug(
					"\nselected:\n" + event.getParameter("selected").join(", ") +
					"\nunselected:\n" + event.getParameter("unselected").join(", "));
			}
			viewer.attachSelectionChanged(handleSelectionChanged);
			viewer.setToolbarTitle("Toolbar title set by sample application");
			var page = new sap.m.Page({
				title: "Sample viewer",
				content: [
					viewer,
					new sap.ui.layout.form.Form({
						editable: true,
						layout: layout,
						formContainers: new sap.ui.layout.form.FormContainer({
							formElements: [ container1, container2 ]
						})
					})
				]
			});

			var app = new sap.m.App();
			app.addPage(page);
			app.placeAt("body");
		</script>
	</head>
	<body id="body" class="sapUiBody">
	<!--a href="javascript:void(0)" onClick="viewer.setEnableFullScreen(true);">Full Screen Toggle</a-->
	</body>
</html>
