<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>qUnit Page for
	sap.ui.comp.personalization.ColumnsController</title>

<script id="sap-ui-bootstrap" type="text/javascript"
	src="../../../../../../resources/sap-ui-core.js"
	data-sap-ui-theme="sap_bluecrystal" data-sap-ui-noConflict="true"
	data-sap-ui-libs="sap.ui.comp, sap.ui.table, sap.ui.commons">
	
</script>

<link rel="stylesheet"
	href="../../../../../../resources/sap/ui/thirdparty/qunit.css"
	type="text/css" media="screen" />
<script type="text/javascript"
	src="../../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script type="text/javascript"
	src="../../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script type="text/javascript"
	src="../../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
<script type="text/javascript"
	src="../../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
<script type="text/javascript"
	src="../../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>

<!-- use the sinon faketimers for this test -->
<script type="text/javascript">
	sinon.config.useFakeTimers = true;
</script>

<script type="text/javascript">
	/*globals QUnit, sinon*/

	if (!(sap.ui.Device.browser.internet_explorer && sap.ui.Device.browser.version <= 8)) {
		jQuery.sap.require("sap.ui.qunit.qunit-coverage");
	}
	
	(function(QUnit, sinon) {
		jQuery.sap.require("sap.ui.comp.personalization.Controller");
		jQuery.sap.require("sap.ui.comp.personalization.ColumnsController");
		jQuery.sap.require("sap.ui.comp.personalization.ColumnHelper");
		jQuery.sap.require("sap.m.ColumnListItem");
		jQuery.sap.require("sap.m.P13nColumnsItem");

		var oColumnsController_TestInstance = null;
		var oEmpty = {
			columns: {
				columnsItems: []
			}
		};
		var oA = {
			columns: {
				columnsItems: [
					{
						columnKey: "name",
						index: 0
					}
				]
			}
		};
		var oAx = {
			columns: {
				columnsItems: [
					{
						columnKey: "name",
						index: 10
					}
				]
			}
		};
		var oAy = {
			columns: {
				columnsItems: [
					{
						columnKey: "name",
						index: 0
					}, {
						columnKey: "country",
						index: 1
					}
				]
			}
		};
		var oB = {
			columns: {
				columnsItems: [
					{
						columnKey: "country",
						index: 1
					}
				]
			}
		};
		var oBx = {
			columns: {
				columnsItems: [
					{
						columnKey: "country",
						index: 0
					}
				]
			}
		};
		var oBy = {
			columns: {
				columnsItems: [
					{
						columnKey: "city",
						index: 0
					}, {
						columnKey: "name",
						index: 1,
						visible: true
					}, {
						columnKey: "country",
						index: 2,
						visible: false
					}
				]
			}
		};
		var oC = {
			columns: {
				columnsItems: [
					{
						columnKey: "name",
						index: 2,
						visible: true
					}
				]
			}
		};
		var oCx = {
			columns: {
				columnsItems: [
					{
						columnKey: "name",
						index: 2,
						visible: false
					}
				]
			}
		};
		var oCy = {
			columns: {
				columnsItems: [
					{
						columnKey: "name",
						index: 0,
						visible: true
					}, {
						columnKey: "country",
						index: 1,
						visible: false
					}
				]
			}
		};
		var oD = {
			columns: {
				columnsItems: [
					{
						columnKey: "name",
						index: 3,
						visible: true
					}
				]
			}
		};
		var oE = {
			columns: {
				columnsItems: [
					{
						columnKey: "name",
						index: 2
					}, {
						columnKey: "country",
						index: 1
					}
				]
			}
		};
		var oEx = {
			columns: {
				columnsItems: [
					{
						columnKey: "name",
						index: 0
					}, {
						columnKey: "country",
						index: 1
					}
				]
			}
		};
		var oAB = {
			columns: {
				columnsItems: [
					{
						columnKey: "name",
						index: 0
					}, {
						columnKey: "country",
						index: 1
					}
				]
			}
		};
		var oCD = {
			columns: {
				columnsItems: [
					{
						columnKey: "city",
						index: 2
					}, {
						columnKey: "number",
						index: 3
					}
				]
			}
		};
		var oBA = {
			columns: {
				columnsItems: [
					{
						columnKey: "country",
						index: 0
					}, {
						columnKey: "name",
						index: 1

					}
				]
			}
		};
		var oABC = {
			columns: {
				columnsItems: [
					{
						columnKey: "name",
						index: 0
					}, {
						columnKey: "country",
						index: 1
					}, {
						columnKey: "city",
						index: 2
					}
				]
			}
		};
		var oABCD = {
			columns: {
				columnsItems: [
					{
						columnKey: "name",
						index: 0
					}, {
						columnKey: "country",
						index: 1
					}, {
						columnKey: "city",
						index: 2
					}, {
						columnKey: "number",
						index: 3
					}
				]
			}
		};
		var oBAC = {
			columns: {
				columnsItems: [
					{
						columnKey: "country",
						index: 0
					}, {
						columnKey: "name",
						index: 1
					}, {
						columnKey: "city",
						index: 2
					}
				]
			}
		};
		var oAxB = {
			columns: {
				columnsItems: [
					{
						columnKey: "country",
						index: 1
					}, {
						columnKey: "name",
						index: 10
					}
				]
			}
		};
		var oBxAx = {
			columns: {
				columnsItems: [
					{
						columnKey: "name",
						index: 10
					}, {
						columnKey: "country",
						index: 11
					}
				]
			}
		};
		QUnit.module("Properties", {
			beforeEach: function() {
				oColumnsController_TestInstance = new sap.ui.comp.personalization.ColumnsController();
			},
			afterEach: function() {
				oColumnsController_TestInstance = null;
			}
		});

		QUnit.test("Shall be instantiable to check that columnscontroller exist", function(assert) {
			ok(oColumnsController_TestInstance, "Could not instantiate ColumnsController");
		});

		QUnit.test("getUnionData", function(assert) {
			// system under test

			// arrangeoBA

			// act			 

			// assertions
			assert.deepEqual(oColumnsController_TestInstance.getUnionData(oA, oA), oA, "no change: A UNION A = A");
			assert.deepEqual(oColumnsController_TestInstance.getUnionData(oA, null), oA, "no change: A UNION null = A");
			assert.deepEqual(oColumnsController_TestInstance.getUnionData(oA, {}), oA, "no change: A UNION {} = A");
			assert.deepEqual(oColumnsController_TestInstance.getUnionData(oA, {
				sort: {}
			}), oA, "no change: A UNION {sort} = A");
			assert.deepEqual(oColumnsController_TestInstance.getUnionData(oA, oAx), oA, "change: A UNION A' = A");
			// $ we ignore column keys which are not found in 'base' (oA) since we assume that in base we find all columns of the table
			assert.deepEqual(oColumnsController_TestInstance.getUnionData(oA, oB), oA, "change: A UNION B = A");
			// see ($) above
			assert.deepEqual(oColumnsController_TestInstance.getUnionData(oA, oAB), oA, "change: A UNION (A, B) = A");
			assert.deepEqual(oColumnsController_TestInstance.getUnionData(oAy, oBy), oCy, "change: Ay UNION By = Cy");
			assert.deepEqual(oColumnsController_TestInstance.getUnionData(oAB, oAB), oAB, "change: (A, B) UNION (A, B) = (A, B)");
			assert.deepEqual(oColumnsController_TestInstance.getUnionData(oAB, oBA), {
				columns: {
					columnsItems: [
						{
							columnKey: "country",
							index: 0
						}, {
							columnKey: "name",
							index: 1
						}
					]
				}
			}, "change: (A, B) UNION (B, A) = (B, A)");
			assert.deepEqual(oColumnsController_TestInstance.getUnionData(oA, oEmpty), oA, "change: A UNION [] = A");
			assert.deepEqual(oColumnsController_TestInstance.getUnionData(oEmpty, oA), oEmpty, "change: [] UNION A = []");
			assert.deepEqual(oColumnsController_TestInstance.getUnionData({}, oA), oA, "change: {} UNION A = A");
			assert.deepEqual(oColumnsController_TestInstance.getUnionData(oA, oAxB), oA, "change: A UNION (A', B) = A");
			assert.deepEqual(oColumnsController_TestInstance.getUnionData({}, {}), null, "change: {} UNION {} = null");
			assert.deepEqual(oColumnsController_TestInstance.getUnionData(oAB, oAx), oBA, "change: (A, B) UNION A' = (B', A')");
			assert.deepEqual(oColumnsController_TestInstance.getUnionData(oAB, oBxAx), oAB, "change: (A, B) UNION (B', A') = (A, B)");
			assert.deepEqual(oColumnsController_TestInstance.getUnionData(oAB, oCD), oAB, "change: (A, B) UNION (C, D) = (A, B)");
			assert.deepEqual(oColumnsController_TestInstance.getUnionData({
				columns: {
					columnsItems: [
						{
							columnKey: "name",
							index: 0
						}, {
							columnKey: "city",
							index: 1
						}
					]
				}
			}, {
				columns: {
					columnsItems: [
						{
							columnKey: "city",
							index: 0
						}
					]
				}
			}), {
				columns: {
					columnsItems: [
						{
							columnKey: "city",
							index: 0
						}, {
							columnKey: "name",
							index: 1
						}
					]
				}
			});

			assert.deepEqual(oColumnsController_TestInstance.getUnionData({
				columns: {
					columnsItems: [
						{
							columnKey: "X1",
							index: 0
						}, {
							columnKey: "B",
							index: 1
						}, {
							columnKey: "X2",
							index: 2
						}, {
							columnKey: "X3",
							index: 3
						}, {
							columnKey: "X4",
							index: 4
						}, {
							columnKey: "C",
							index: 5
						}, {
							columnKey: "X5",
							index: 6
						}, {
							columnKey: "X6",
							index: 7
						}
					]
				}
			}, {
				columns: {
					columnsItems: [
						{
							columnKey: "A",
							index: 0
						}, {
							columnKey: "B",
							index: 5
						}, {
							columnKey: "C",
							index: 8
						}
					]
				}
			}), {
				columns: {
					columnsItems: [
						{
							columnKey: "X1",
							index: 0
						}, {
							columnKey: "X2",
							index: 1
						}, {
							columnKey: "X3",
							index: 2
						}, {
							columnKey: "X4",
							index: 3
						}, {
							columnKey: "X5",
							index: 4
						}, {
							columnKey: "B",
							index: 5
						}, {
							columnKey: "X6",
							index: 6
						}, {
							columnKey: "C",
							index: 7
						}
					]
				}
			});

			assert.deepEqual(oColumnsController_TestInstance.getUnionData({
				columns: {
					columnsItems: [
						{
							columnKey: "country",
							index: 0
						}, {
							columnKey: "city",
							index: 1
						}
					]
				}
			}, {
				columns: {
					columnsItems: [
						{
							columnKey: "name",
							index: 0
						}, {
							columnKey: "country",
							index: 1
						}, {
							columnKey: "city",
							index: 2
						}
					]
				}
			}), {
				columns: {
					columnsItems: [
						{
							columnKey: "country",
							index: 0
						}, {
							columnKey: "city",
							index: 1
						}
					]
				}
			}, "#Restore < #NewData");

			assert.deepEqual(oColumnsController_TestInstance.getUnionData({
				columns: {
					columnsItems: [
						{
							columnKey: "name",
							index: 0
						}, {
							columnKey: "country",
							index: 1
						}, {
							columnKey: "city",
							index: 2
						}
					]
				}
			}, {
				columns: {
					columnsItems: [
						{
							columnKey: "country",
							index: 0
						}, {
							columnKey: "city",
							index: 1
						}
					]
				}
			}), {
				columns: {
					columnsItems: [
						{
							columnKey: "country",
							index: 0
						}, {
							columnKey: "city",
							index: 1
						}, {
							columnKey: "name",
							index: 2
						}
					]
				}
			}, "#Restore > #NewData");

		});

		QUnit.test("getChangeType", function(assert) {
			assert.deepEqual(oColumnsController_TestInstance.getChangeType(oA, oA), sap.ui.comp.personalization.ChangeType.Unchanged);
			assert.deepEqual(oColumnsController_TestInstance.getChangeType(oA, {}), sap.ui.comp.personalization.ChangeType.Unchanged);
			assert.deepEqual(oColumnsController_TestInstance.getChangeType(oA, oAx), sap.ui.comp.personalization.ChangeType.TableChanged);
			assert.deepEqual(oColumnsController_TestInstance.getChangeType(oC, oCx), sap.ui.comp.personalization.ChangeType.ModelChanged);
			assert.deepEqual(oColumnsController_TestInstance.getChangeType(oCx, oC), sap.ui.comp.personalization.ChangeType.TableChanged);
			assert.deepEqual(oColumnsController_TestInstance.getChangeType(oA, oC), sap.ui.comp.personalization.ChangeType.TableChanged);
			assert.deepEqual(oColumnsController_TestInstance.getChangeType(oC, oD), sap.ui.comp.personalization.ChangeType.TableChanged);
		});

		QUnit.test("getChangeData", function(assert) {
			// system under test

			// arrange

			// act			 

			// assertions
			// ------ no changes --------------------------------------------------------------
			assert.deepEqual(oColumnsController_TestInstance.getChangeData(oA, oA), null, "no change: A XOR A = null");
			assert.deepEqual(oColumnsController_TestInstance.getChangeData(oE, oEx), {
				columns: {
					columnsItems: [
						{
							columnKey: "name",
							index: 2
						}
					]
				}
			}, "no change: A XOR ~A -> eliminate identical array parts");
			assert.deepEqual(oColumnsController_TestInstance.getChangeData(oA, null), null, "no change: A XOR null = null");
			assert.deepEqual(oColumnsController_TestInstance.getChangeData(oA, {}), null, "no change: A XOR {} = null");
			assert.deepEqual(oColumnsController_TestInstance.getChangeData(oA, {
				columns: {}
			}), null, "no change: A XOR {columns} = null");
			assert.deepEqual(oColumnsController_TestInstance.getChangeData(oA, oAB), null, "no change: A XOR (A, B) = null");
			assert.deepEqual(oColumnsController_TestInstance.getChangeData(oAB, {
				columns: {
					columnsItems: [
						{
							columnKey: "country",
							index: 1
						}, {
							columnKey: "name",
							index: 0
						}
					]
				}
			}), null, "no change: [A, B] XOR [B, A] = null");
			assert.deepEqual(oColumnsController_TestInstance.getChangeData(oAB, oAB), null, "no change: (A, B) XOR (A, B) = null");
			assert.deepEqual(oColumnsController_TestInstance.getChangeData(oEmpty, oA), null, "change: [] XOR A = null");
			// ------ order changes --------------------------------------------------------------
			assert.deepEqual(oColumnsController_TestInstance.getChangeData(oA, oB), oA, "change: A XOR B = A");
			assert.deepEqual(oColumnsController_TestInstance.getChangeData(oA, oBA), oA, "change: A XOR (B, A) = A");
			assert.deepEqual(oColumnsController_TestInstance.getChangeData(oA, oBAC), oA, "change: A XOR (B, A, C) = A");
			assert.deepEqual(oColumnsController_TestInstance.getChangeData(oA, oEmpty), oA, "change: A XOR [] = A");
			assert.deepEqual(oColumnsController_TestInstance.getChangeData(oAB, oBx), oAB, "change: (A, B) XOR B' = (A, B)");
			assert.deepEqual(oColumnsController_TestInstance.getChangeData(oBAC, oABC), oBA, "change: (B, A, C) XOR (A, B, C) = (B, A)");
			// ------ property changes --------------------------------------------------------------
			assert.deepEqual(oColumnsController_TestInstance.getChangeData({
				columns: {
					columnsItems: [
						{
							columnKey: "name",
							index: 0,
							width: "100px",
							visual: false
						}
					]
				}
			}, {
				columns: {
					columnsItems: [
						{
							columnKey: "name",
							index: 0,
							visual: true,
							width: "100px"
						}
					]
				}
			}), {
				columns: {
					columnsItems: [
						{
							columnKey: "name",
							visual: false
						}
					]
				}
			}, "change: A' XOR A = A''");
			assert.deepEqual(oColumnsController_TestInstance.getChangeData({
				columns: {
					columnsItems: [
						{
							columnKey: "city",
							index: 0
						}
					]
				}
			}, {
				columns: {
					columnsItems: [
						{
							columnKey: "name",
							index: 0
						}, {
							columnKey: "city",
							index: 1
						}
					]
				}
			}), {
				columns: {
					columnsItems: [
						{
							columnKey: "city",
							index: 0
						}
					]
				}
			}, "change: B' XOR (A, B) = B'");
			assert.deepEqual(oColumnsController_TestInstance.getChangeData({
				columns: {
					columnsItems: [
						{
							columnKey: "name",
							visible: true
						}
					]
				}
			}, {
				columns: {
					columnsItems: [
						{
							columnKey: "name",
							index: 0,
							width: ""
						}
					]
				}
			}), {
				columns: {
					columnsItems: [
						{
							columnKey: "name",
							visible: true
						}
					]
				}
			}, "change: A' XOR A = A'");
		});

		QUnit.test("Shall check getUnionData", function(assert) {
			assert.ok(oColumnsController_TestInstance.getUnionData, "Method does not exist");

			//
			// First change to AlreadyKnown -> AlreadyKnown = Restore
			// country: visible = false; city: visible = false, index = 1 
			//
			var oAlreadyKnown = JSON.parse("{\"columns\": {\"columnsItems\": [{\"columnKey\": \"name\",\"index\": 0,\"visible\": true,\"width\": \"\"},{\"columnKey\": \"country\",\"index\": 1,\"visible\": true,\"width\": \"\"},{\"columnKey\": \"city\",\"index\": 2,\"visible\": true,\"width\": \"\"},{\"columnKey\": \"number\",\"index\": 3,\"visible\": true,\"width\": \"\"},{\"columnKey\": \"date\",\"index\": 4,\"visible\": true,\"width\": \"\"}]}}");
			var oDelta = JSON.parse("{\"columns\":{\"columnsItems\":[{\"columnKey\":\"country\",\"visible\":false},{\"columnKey\":\"city\",\"visible\":false,\"index\":1}]}}");
			var oUnionExpectedResult = JSON.parse("{\"columns\":{\"columnsItems\":[{\"columnKey\":\"name\",\"index\":0,\"visible\":true,\"width\":\"\"},{\"columnKey\":\"city\",\"index\":1,\"visible\":false,\"width\":\"\"},{\"columnKey\":\"country\",\"index\":2,\"visible\":false,\"width\":\"\"},{\"columnKey\":\"number\",\"index\":3,\"visible\":true,\"width\":\"\"},{\"columnKey\":\"date\",\"index\":4,\"visible\":true,\"width\":\"\"}]}}");

			// CUT -> method shall be executed for change step1
			var oUnionResult = oColumnsController_TestInstance.getUnionData(oAlreadyKnown, oDelta);
			assert.ok(oUnionResult, "A result shall be returned as both input parameter are filled with valid JSON objects");
			assert.deepEqual(oUnionResult, oUnionExpectedResult, "Result shall be equal -> UNION result is wrong");

			//
			// Second change to AlreadyKnown -> AlreadyKnown = AlreadyKnown + first Delta 
			// country: visible = true; number: visible = false, index = 0; city index = 2 
			//
			oAlreadyKnown = oUnionExpectedResult;
			oDelta = JSON.parse("{\"columns\":{\"columnsItems\":[{\"columnKey\":\"country\",\"visible\":true},{\"columnKey\":\"number\",\"visible\":false,\"index\":0},{\"columnKey\":\"city\",\"index\":2}]}}");
			oUnionExpectedResult = JSON.parse("{\"columns\":{\"columnsItems\":[{\"columnKey\":\"number\",\"index\":0,\"visible\":false,\"width\":\"\"},{\"columnKey\":\"name\",\"index\":1,\"visible\":true,\"width\":\"\"},{\"columnKey\":\"city\",\"index\":2,\"visible\":false,\"width\":\"\"},{\"columnKey\":\"country\",\"index\":3,\"visible\":true,\"width\":\"\"},{\"columnKey\":\"date\",\"index\":4,\"visible\":true,\"width\":\"\"}]}}");

			// CUT -> method shall be executed for change step2
			var oUnionResult = oColumnsController_TestInstance.getUnionData(oAlreadyKnown, oDelta);
			assert.ok(oUnionResult, "A result shall be returned as both input parameter are filled with valid JSON objects");
			assert.deepEqual(oUnionResult, oUnionExpectedResult, "Result shall be equal -> UNION result is wrong");
		});

		QUnit.test("Shall check _recalculateIndexes upwards", function(assert) {
			assert.ok(oColumnsController_TestInstance._recalculateIndexes, "Method does not exist");

			var aObjects = JSON.parse("[{\"columnsKey\" : \"A\",\"index\":0},{\"columnsKey\":\"B\",\"index\":1},{\"columnsKey\":\"C\",\"index\":2},{\"columnsKey\":\"D\",\"index\":3},{\"columnsKey\":\"E\",\"index\":4},{\"columnsKey\" : \"F\",\"index\":5}]");

			var aExpected = JSON.parse("[{\"columnsKey\" : \"E\",\"index\":0},{\"columnsKey\":\"A\",\"index\":1},{\"columnsKey\":\"B\",\"index\":2},{\"columnsKey\":\"C\",\"index\":3},{\"columnsKey\":\"D\",\"index\":4},{\"columnsKey\" : \"F\",\"index\":5}]");

			// CUT -> method shall be executed -> "E" shall move from index 4 to 0; Now adapted all index that are between 4 and 0  
			oColumnsController_TestInstance._recalculateIndexes(aObjects, 4, 0);

			// Now simulate the move of E down to index 0 
			var aRemovedItems = aObjects.splice(4, 1);
			assert.ok(aRemovedItems, "Removed objects shall not be empty");
			assert.strictEqual(aRemovedItems.length, 1, "Exactly one item needs to be removed");
			aRemovedItems[0].index = 0;
			aObjects.splice(aRemovedItems[0].index, 0, aRemovedItems[0]);

			//compare the changed array (objects)
			assert.deepEqual(aObjects, aExpected, "Result is not as expected");
		});

		QUnit.test("Shall check _recalculateIndexes downwards", function(assert) {
			assert.ok(oColumnsController_TestInstance._recalculateIndexes, "Method does not exist");

			var aObjects = JSON.parse("[{\"columnsKey\":\"A\",\"index\":0},{\"columnsKey\":\"B\",\"index\":1},{\"columnsKey\":\"C\",\"index\":2},{\"columnsKey\":\"D\",\"index\":3},{\"columnsKey\":\"E\",\"index\":4},{\"columnsKey\" : \"F\",\"index\":5}]");

			var aExpected = JSON.parse("[{\"columnsKey\":\"B\",\"index\":0},{\"columnsKey\":\"C\",\"index\":1},{\"columnsKey\":\"D\",\"index\":2},{\"columnsKey\":\"E\",\"index\":3},{\"columnsKey\" : \"A\",\"index\":4},{\"columnsKey\":\"F\",\"index\":5}]");

			// CUT -> method shall be executed -> "A" shall move from index 0 to 4; Now adapted all index that are between 0 and 4  
			oColumnsController_TestInstance._recalculateIndexes(aObjects, 0, 4);

			// Now simulate the move of A down to index 4 
			var aRemovedItems = aObjects.splice(0, 1);
			assert.ok(aRemovedItems, "Removed objects shall not be empty");
			assert.strictEqual(aRemovedItems.length, 1, "Exactly one item needs to be removed");
			aRemovedItems[0].index = 4;
			aObjects.splice(aRemovedItems[0].index, 0, aRemovedItems[0]);

			//compare the changed array (objects)
			assert.deepEqual(aObjects, aExpected, "Result is not as expected");
		});

		QUnit.test("Shall check _sortArrayByPropertyName", function(assert) {
			assert.ok(oColumnsController_TestInstance._sortArrayByPropertyName, "Method does not exist");

			// A,B,C,D,E,F
			var aObjects = JSON.parse("[{\"columnsKey\":\"A\",\"index\":2},{\"columnsKey\":\"B\",\"index\":1},{\"columnsKey\":\"C\",\"index\":0},{\"columnsKey\":\"D\",\"index\":3},{\"columnsKey\":\"E\"},{\"columnsKey\" : \"F\",\"index\":5}]");

			// C,B,A,F,E(index = undefined)
			var aExpected = JSON.parse("[{\"columnsKey\":\"C\",\"index\":0},{\"columnsKey\":\"B\",\"index\":1},{\"columnsKey\":\"A\",\"index\":2},{\"columnsKey\":\"D\",\"index\":3},{\"columnsKey\" : \"F\",\"index\":5},{\"columnsKey\":\"E\"}]");

			// CUT -> method shall be executed -> result shall be sorted by the index property (all objects that does not have the index property shall be arranged at the end)
			// Changes shall be done on a copy of the given array; the original shall not be changed 
			var aResult = oColumnsController_TestInstance._sortArrayByPropertyName(aObjects, "index", true);

			//compare the result
			assert.notDeepEqual(aObjects, aResult, "The original array shall not be changed; Work on a copy");
			assert.deepEqual(aResult, aExpected, "Result array shall be sorted");

			// CUT -> method shall be executed -> result shall be sorted by the index property (all objects that does not have the index property shall be arranged at the end)
			// Changes shall be done direct on the original array!!					
			aResult = oColumnsController_TestInstance._sortArrayByPropertyName(aObjects, "index", false);

			//compare the result with 
			assert.deepEqual(aObjects, aResult, "The original array shall be changed; no copy");
			assert.deepEqual(aResult, aExpected, "Result array shall be sorted");
		});

		QUnit.test("Shall check _onColumnMove -> columns F from index 5 to 2", function(assert) {
			assert.ok(oColumnsController_TestInstance._onColumnMove, "Method does not exist");

			var aColumns = JSON.parse("[{\"columnName\" : \"A\"}, {\"columnName\" : \"B\"	}, {\"columnName\" : \"C\"}, {\"columnName\" : \"D\"}, {\"columnName\" : \"E\"}, {\"columnName\" : \"F\"}, {\"columnName\" : \"G\"}]");
			var oColumnF = aColumns[5];

			var fGetParameter = function(sParamName) {
				var oResult = null;
				if (sParamName === "column") {
					oResult = oColumnF;
				} else if (sParamName === "newPos") {
					oResult = 2;
				}
				return oResult;
			};

			var oEvent = {
				"column": oColumnF,
				"newPos": 2,
				"getParameter": fGetParameter
			};

			var oTableStub = sinon.stub();

			oTableStub.indexOfColumn = sinon.stub().returns(aColumns.indexOf(oColumnF));
			oTableStub.getColumns = sinon.stub().returns(aColumns);

			var oModelStub = sinon.stub();
			var oModelJSON = JSON.parse("{\"transientData\": {\"columns\": {\"title\": \"Spalten\",\"items\": [{\"columnKey\": \"Gjahr\",\"text\": \"Geschäftsjahr\",\"tooltip\": \"Geschäftsjahr\",\"visible\": true,\"width\": \"4.75em\"},{\"columnKey\": \"Bukrs\",\"text\": \"my Bukrs\",\"tooltip\": \"my Bukrs\",\"visible\": true,\"width\": \"4.75em\"},{\"columnKey\": \"Kunnr\",\"text\": \"Debitor\",\"tooltip\": \"Debitorennummer\",\"visible\": false,\"width\": \"10.75em\"},{\"columnKey\": \"Name1\",\"text\": \"Name\",\"tooltip\": \"Name 1\",\"visible\": true,\"width\": \"35.75em\"},{\"columnKey\": \"Dmbtr\",\"text\": \"Dmbtr\",\"tooltip\": \"Dmbtr\",\"visible\": true,\"width\": \"25.75em\"},{\"columnKey\": \"Hwaer\",\"text\": \"Währung\",\"tooltip\": \"Währungsschlüssel\",\"visible\": true,\"width\": \"5.75em\"}]}},\"persistentData\": {\"columns\": {\"columnsItems\": [{\"columnKey\": \"Gjahr\",\"index\": 0},{\"columnKey\": \"Bukrs\",\"index\": 1},{\"columnKey\": \"Kunnr\",\"visible\": false}]}}}");
			oModelStub.getData = sinon.stub().returns(oModelJSON);
			oModelStub.setData = sinon.stub();
			oColumnsController_TestInstance.getModel = sinon.stub().returns(oModelStub);
			oColumnsController_TestInstance.getTable = sinon.stub().returns(oTableStub);
			oColumnsController_TestInstance._setNewColumnItemIndex = sinon.stub();
			oColumnsController_TestInstance.fireAfterColumnsModelDataChange = sinon.stub();
			sap.ui.comp.personalization.Controller = sinon.stub();
			sap.ui.comp.personalization.ChangeType = sinon.stub();

			// CUT -> method shall be executed
			oColumnsController_TestInstance._onColumnMove(oEvent);

			assert.strictEqual(oColumnsController_TestInstance._setNewColumnItemIndex.callCount, 4, "Method: _setNewColumnItemIndex shall be called 4 times (to move column F from index 5 and 2)");
			assert.strictEqual(oColumnsController_TestInstance._setNewColumnItemIndex.calledWith(oModelJSON, aColumns[2], 3), true, "Column C shall move to index 3");
			assert.strictEqual(oColumnsController_TestInstance._setNewColumnItemIndex.calledWith(oModelJSON, aColumns[3], 4), true, "Column D shall move to index 4");
			assert.strictEqual(oColumnsController_TestInstance._setNewColumnItemIndex.calledWith(oModelJSON, aColumns[4], 5), true, "Column E shall move to index 5");
			assert.strictEqual(oColumnsController_TestInstance._setNewColumnItemIndex.calledWith(oModelJSON, aColumns[5], 2), true, "Column F shall move to index 2");

			assert.strictEqual(oColumnsController_TestInstance._setNewColumnItemIndex.called, true, "Method: model.setData() shall be executed to set the changed data");
			assert.strictEqual(oColumnsController_TestInstance.fireAfterColumnsModelDataChange.called, true, "Method: fireAfterColumnsModelDataChange() shall be executed to signalize that model data have been changed");
		});

		QUnit.test("Shall check _onColumnMove -> columns B from index 1 to 5", function(assert) {
			assert.ok(oColumnsController_TestInstance._onColumnMove, "Method does not exist");

			var aColumns = JSON.parse("[{\"columnName\" : \"A\"}, {\"columnName\" : \"B\"	}, {\"columnName\" : \"C\"}, {\"columnName\" : \"D\"}, {\"columnName\" : \"E\"}, {\"columnName\" : \"F\"}, {\"columnName\" : \"G\"}]");
			var oColumnB = aColumns[1];

			var fGetParameter = function(sParamName) {
				var oResult = null;
				if (sParamName === "column") {
					oResult = oColumnB;
				} else if (sParamName === "newPos") {
					oResult = 5;
				}
				return oResult;
			};

			var oEvent = {
				"column": oColumnB,
				"newPos": 5,
				"getParameter": fGetParameter
			};

			var oTableStub = sinon.stub();

			oTableStub.indexOfColumn = sinon.stub().returns(aColumns.indexOf(oColumnB));
			oTableStub.getColumns = sinon.stub().returns(aColumns);

			var oModelStub = sinon.stub();
			var oModelJSON = JSON.parse("{\"transientData\": {\"columns\": {\"title\": \"Spalten\",\"items\": [{\"columnKey\": \"Gjahr\",\"text\": \"Geschäftsjahr\",\"tooltip\": \"Geschäftsjahr\",\"visible\": true,\"width\": \"4.75em\"},{\"columnKey\": \"Bukrs\",\"text\": \"my Bukrs\",\"tooltip\": \"my Bukrs\",\"visible\": true,\"width\": \"4.75em\"},{\"columnKey\": \"Kunnr\",\"text\": \"Debitor\",\"tooltip\": \"Debitorennummer\",\"visible\": false,\"width\": \"10.75em\"},{\"columnKey\": \"Name1\",\"text\": \"Name\",\"tooltip\": \"Name 1\",\"visible\": true,\"width\": \"35.75em\"},{\"columnKey\": \"Dmbtr\",\"text\": \"Dmbtr\",\"tooltip\": \"Dmbtr\",\"visible\": true,\"width\": \"25.75em\"},{\"columnKey\": \"Hwaer\",\"text\": \"Währung\",\"tooltip\": \"Währungsschlüssel\",\"visible\": true,\"width\": \"5.75em\"}]}},\"persistentData\": {\"columns\": {\"columnsItems\": [{\"columnKey\": \"Gjahr\",\"index\": 0},{\"columnKey\": \"Bukrs\",\"index\": 1},{\"columnKey\": \"Kunnr\",\"visible\": false}]}}}");
			oModelStub.getData = sinon.stub().returns(oModelJSON);
			oModelStub.setData = sinon.stub();
			oColumnsController_TestInstance.getModel = sinon.stub().returns(oModelStub);
			oColumnsController_TestInstance.getTable = sinon.stub().returns(oTableStub);
			oColumnsController_TestInstance._setNewColumnItemIndex = sinon.stub();
			oColumnsController_TestInstance.fireAfterColumnsModelDataChange = sinon.stub();
			sap.ui.comp.personalization.Controller = sinon.stub();
			sap.ui.comp.personalization.ChangeType = sinon.stub();

			// CUT -> method shall be executed
			oColumnsController_TestInstance._onColumnMove(oEvent);

			assert.strictEqual(oColumnsController_TestInstance._setNewColumnItemIndex.callCount, 5, "Method: _setNewColumnItemIndex shall be called 5 times (to move column B from index 1 and 5)");
			assert.strictEqual(oColumnsController_TestInstance._setNewColumnItemIndex.calledWith(oModelJSON, aColumns[1], 5), true, "Column B shall move to index 5");
			assert.strictEqual(oColumnsController_TestInstance._setNewColumnItemIndex.calledWith(oModelJSON, aColumns[2], 1), true, "Column C shall move to index 1");
			assert.strictEqual(oColumnsController_TestInstance._setNewColumnItemIndex.calledWith(oModelJSON, aColumns[3], 2), true, "Column D shall move to index 2");
			assert.strictEqual(oColumnsController_TestInstance._setNewColumnItemIndex.calledWith(oModelJSON, aColumns[4], 3), true, "Column E shall move to index 3");
			assert.strictEqual(oColumnsController_TestInstance._setNewColumnItemIndex.calledWith(oModelJSON, aColumns[5], 4), true, "Column F shall move to index 4");

			assert.strictEqual(oColumnsController_TestInstance._setNewColumnItemIndex.called, true, "Method: model.setData() shall be executed to set the changed data");
			assert.strictEqual(oColumnsController_TestInstance.fireAfterColumnsModelDataChange.called, true, "Method: fireAfterColumnsModelDataChange() shall be executed to signalize that model data have been changed");
		});

		QUnit.test("Shall check _onColumnVisibility  -> change column visibility from false to true", function(assert) {
			assert.ok(oColumnsController_TestInstance._onColumnVisibility, "Method does not exist");

			var oColumn = new sap.m.ColumnListItem();
			oColumn.data("p13nData", {
				"columnKey": "Kunnr"
			});

			var fGetParameter = function(sParamName) {
				var oResult = null;
				if (sParamName === "column") {
					oResult = oColumn;
				} else if (sParamName === "newVisible") {
					oResult = true;
				}
				return oResult;
			};

			var oEvent = {
				"column": oColumn,
				"newVisible": true,
				"getParameter": fGetParameter
			};

			var oModelStub = sinon.stub();
			var oModelData = JSON.parse("{\"transientData\": {\"columns\": {\"title\": \"Spalten\",\"items\": [{\"columnKey\": \"Gjahr\",\"text\": \"Geschäftsjahr\",\"tooltip\": \"Geschäftsjahr\",\"visible\": true,\"width\": \"4.75em\"},{\"columnKey\": \"Bukrs\",\"text\": \"my Bukrs\",\"tooltip\": \"my Bukrs\",\"visible\": true,\"width\": \"4.75em\"},{\"columnKey\": \"Kunnr\",\"text\": \"Debitor\",\"tooltip\": \"Debitorennummer\",\"visible\": false,\"width\": \"10.75em\"},{\"columnKey\": \"Name1\",\"text\": \"Name\",\"tooltip\": \"Name 1\",\"visible\": true,\"width\": \"35.75em\"},{\"columnKey\": \"Dmbtr\",\"text\": \"Dmbtr\",\"tooltip\": \"Dmbtr\",\"visible\": true,\"width\": \"25.75em\"},{\"columnKey\": \"Hwaer\",\"text\": \"Währung\",\"tooltip\": \"Währungsschlüssel\",\"visible\": true,\"width\": \"5.75em\"}]}},\"persistentData\": {\"columns\": {\"columnsItems\": [{\"columnKey\": \"Gjahr\",\"index\": 0},{\"columnKey\": \"Bukrs\",\"index\": 1},{\"columnKey\": \"Kunnr\",\"visible\": false}]}}}");
			oModelStub.getData = sinon.stub().returns(oModelData);
			oModelStub.setData = sinon.stub();
			oColumnsController_TestInstance.getModel = sinon.stub().returns(oModelStub);
			oColumnsController_TestInstance.fireAfterColumnsModelDataChange = sinon.stub();
			sap.ui.comp.personalization.Controller = sinon.stub();
			sap.ui.comp.personalization.ChangeType = sinon.stub();

			// CUT -> method shall be executed and shall change the visibility of an existing columnsItem
			oColumnsController_TestInstance._onColumnVisibility(oEvent);
			assert.strictEqual(oModelData.persistentData.columns.columnsItems.length, 3, "It shall exist 3 columnsItems");
			assert.strictEqual(oModelData.persistentData.columns.columnsItems[2].visible, true, "The new set index shall be 2");

			// CUT -> method shall be executed and create a new columnsItem entry with the new visibility
			oColumn = new sap.m.ColumnListItem();
			oColumn.data("p13nData", {
				"columnKey": "Bukrs_New"
			});

			oColumnsController_TestInstance._onColumnVisibility(oEvent);
			assert.strictEqual(oModelData.persistentData.columns.columnsItems.length, 4, "Now it shall exist 4 columnsItems");
			assert.strictEqual(oModelData.persistentData.columns.columnsItems[3].visible, true, "The new columnsItem shall get the visibility as true");
		});

		QUnit.test("Shall check _setNewColumnItemIndex", function(assert) {
			assert.ok(oColumnsController_TestInstance._setNewColumnItemIndex, "Method does not exist");

			var oModelData = JSON.parse("{\"transientData\": {\"columns\": {\"title\": \"Spalten\",\"items\": [{\"columnKey\": \"Gjahr\",\"text\": \"Geschäftsjahr\",\"tooltip\": \"Geschäftsjahr\",\"visible\": true,\"width\": \"4.75em\"},{\"columnKey\": \"Bukrs\",\"text\": \"my Bukrs\",\"tooltip\": \"my Bukrs\",\"visible\": true,\"width\": \"4.75em\"},{\"columnKey\": \"Kunnr\",\"text\": \"Debitor\",\"tooltip\": \"Debitorennummer\",\"visible\": false,\"width\": \"10.75em\"},{\"columnKey\": \"Name1\",\"text\": \"Name\",\"tooltip\": \"Name 1\",\"visible\": true,\"width\": \"35.75em\"},{\"columnKey\": \"Dmbtr\",\"text\": \"Dmbtr\",\"tooltip\": \"Dmbtr\",\"visible\": true,\"width\": \"25.75em\"},{\"columnKey\": \"Hwaer\",\"text\": \"Währung\",\"tooltip\": \"Währungsschlüssel\",\"visible\": true,\"width\": \"5.75em\"}]}},\"persistentData\": {\"columns\": {\"columnsItems\": [{\"columnKey\": \"Gjahr\",\"index\": 0},{\"columnKey\": \"Bukrs\",\"index\": 1},{\"columnKey\": \"Kunnr\",\"visible\": false}]}}}");

			var oColumn = new sap.m.ColumnListItem();
			oColumn.data("p13nData", {
				"columnKey": "Bukrs"
			});

			// CUT -> method shall be executed -> oColumn shall be found in columnsItems and change the index from 1 to 2
			oColumnsController_TestInstance._setNewColumnItemIndex(oModelData, oColumn, 2);
			assert.strictEqual(oModelData.persistentData.columns.columnsItems[1].index, 2, "The new set index shall be 2");

			oColumn = new sap.m.ColumnListItem();
			oColumn.data("p13nData", {
				"columnKey": "Bukrs_New"
			});

			// CUT -> method shall be executed -> oColumn shall NOT be found in columnsItems; new columnsItem will be created with new data
			oColumnsController_TestInstance._setNewColumnItemIndex(oModelData, oColumn, 3);
			assert.strictEqual(oModelData.persistentData.columns.columnsItems.length, 4, "A new columnsItem shall be added");
			assert.strictEqual(oModelData.persistentData.columns.columnsItems[3].index, 3, "The new columnsItem shall have index value 3");
		});

		QUnit.test("Shall check getPanel", function(assert) {
			assert.ok(oColumnsController_TestInstance.getPanel, "Method does not exist");

			var oModel = new sap.ui.model.json.JSONModel();
			var oModelData = JSON.parse("{\"transientData\": {\"columns\": {\"title\": \"Spalten\",\"items\": [{\"columnKey\": \"Gjahr\",\"text\": \"Geschäftsjahr\",\"tooltip\": \"Geschäftsjahr\",\"visible\": true,\"width\": \"4.75em\"},{\"columnKey\": \"Kunnr\",\"text\": \"Debitor\",\"tooltip\": \"Debitorennummer\",\"visible\": true,\"width\": \"4.75em\"}]}},\"persistentData\": {\"columns\": {\"columnsItems\": [{\"columnKey\": \"Gjahr\",\"index\": 0},{\"columnKey\": \"Kunnr\",\"visible\": false}]}}}");
			oModel.getData = sinon.stub().returns(oModelData);
			oModel.setData = sinon.stub();
			oColumnsController_TestInstance.getModel = sinon.stub().returns(oModel);

			// CUT -> method shall be executed and return a new created columnsPanel
			var oColumnsPanel = oColumnsController_TestInstance.getPanel();
			ok(oColumnsPanel, "Instance of P13nColumnPanel shall be created");

			var oNewColumnsItem = new sap.m.P13nColumnsItem({
				"columnKey": "NewColumn4711",
				"visible": true,
				"index": 2,
				"width": "100px"
			});

			//check number of columnsData in model 
			assert.strictEqual(oModelData.persistentData.columns.columnsItems.length, 2, "ColumnsItems shall have 2 entries");

			// CUT -> execute fireChangeColumnsItems -> which will change model data, as a new columnsItem will be added to persistentData 
			oModel.getData.reset();
			oModel.setData.reset();
			oColumnsController_TestInstance.getModel.reset();

			oColumnsPanel.fireChangeColumnsItems({
				"newItems": [
					oNewColumnsItem
				],
				"existingItems": null
			});

			// check changed model data and execution of getModel/getData/setData is not done!!
			assert.strictEqual(oModelData.persistentData.columns.columnsItems.length, 3, "After event was executed columnsItems shall have 3 entries");
			assert.strictEqual(oModelData.persistentData.columns.columnsItems[2].columnKey, "NewColumn4711", "3th columnsItem shall be NewColumn4711");
			assert.strictEqual(oColumnsController_TestInstance.getModel.called, true, "getModel shall be called");
			assert.strictEqual(oColumnsController_TestInstance.getModel.callCount, 1, "getModel of ColumnsController shall be called once while event execution");
			assert.strictEqual(oModel.getData.called, true, "getData shall be called");
			assert.strictEqual(oModel.setData.called, false, "setData shall NOT be called during this event execution -> will be done with event SetData");

			// CUT -> execute fireSetData -> which will push all model changes to bound target objects 
			oModel.getData.reset();
			oModel.setData.reset();
			oColumnsController_TestInstance.getModel.reset();

			oColumnsPanel.fireSetData();

			assert.strictEqual(oColumnsController_TestInstance.getModel.called, true, "getModel shall be called");
			assert.strictEqual(oColumnsController_TestInstance.getModel.callCount, 2, "getModel of ColumnsController shall be called twice while event execution");
			assert.strictEqual(oModel.getData.called, true, "getData shall be called");
			assert.strictEqual(oModel.setData.called, true, "setData shall be called to push model changes to bound target objects");
		});

		QUnit.test("Shall check _applyChangesToMTableType ", function(assert) {
			var oColumnsController = new sap.ui.comp.personalization.ColumnsController({
				columnHelper: new sap.ui.comp.personalization.ColumnHelper()
			});
			assert.ok(oColumnsController._applyChangesToMTableType, "Method does not exist");

			var oTable = sinon.stub();
			var oColumn_4711 = new sap.m.Column();
			var oColumn_4712 = new sap.m.Column();

			oColumn_4711.data("p13nData", {
				"columnKey": "4711"
			});

			oColumn_4712.data("p13nData", {
				"columnKey": "4712"
			});

			oTable.getColumns = sinon.stub().returns([
				oColumn_4711, oColumn_4712
			]);
			oTable.invalidate = sinon.stub();

			var aColumnsItems = [
				{
					"columnKey": "4712",
					"getColumnKey": sinon.stub().returns("4712"),
					"index": 2,
					"visible": true,
					"getVisible": sinon.stub().returns(true),
					"setVisible": sinon.stub()
				}, {
					"columnKey": "4711",
					"getColumnKey": sinon.stub().returns("4711"),
					"index": 1,
					"visible": true,
					"getVisible": sinon.stub().returns(true),
					"setVisible": sinon.stub()
				}
			];

			oColumnsController.getColumnHelper().addColumnsToMap([
				oColumn_4711, oColumn_4712
			]);

			// CUT -> method shall be executed and columns of oTable accordingly changed
			oColumnsController._applyChangesToMTableType(oTable, aColumnsItems);

			assert.strictEqual(oColumn_4711.getOrder(), 1, "SetOrder for first table column shall be called");
			assert.strictEqual(oColumn_4712.getOrder(), 2, "SetOrder for second table column shall be called");

			assert.strictEqual(oColumn_4711.getVisible(), true, "setVisible for first table column shall be called");
			assert.strictEqual(oColumn_4712.getVisible(), true, "setVisible for second table column shall be called");

			// check that _applyChangesToMTableType sorts aColumnsItems by index property, before it will be processed
			assert.strictEqual(aColumnsItems[0].columnKey, "4711", "First columnsItem that shall be processed in _applyChangesToMTableType shall be 4711");
			assert.strictEqual(aColumnsItems[1].columnKey, "4712", "Second columnsItem that shall be processed in _applyChangesToMTableType shall be 4712");

			assert.strictEqual(oTable.invalidate.called, true, "Table rerendering shall be started after all changes are taken over");
			assert.strictEqual(oTable.invalidate.callCount, 1, "Table rerendering shall only be started once");

			oColumnsController.destroy();
		});

		QUnit.test("Shall check _determineTooltipText", function(assert) {
			assert.ok(oColumnsController_TestInstance._determineTooltipText, "Method does not exist");

			var oColumn = null, sTooltip = null, getTooltip_AsStringSpy = null;

			oColumn = new sap.ui.table.Column();
			oColumn.setTooltip("SimpleTooltipText");

			// CUT -> check simple tooltip
			sTooltip = oColumnsController_TestInstance._determineTooltipText(oColumn);
			assert.strictEqual(sTooltip, "SimpleTooltipText", "SimpleTooltipText was not determined");

			oTooltipBase = new sap.ui.commons.RichTooltip();
			oTooltipBase.getTooltip_Text = sinon.stub().returns("RichTooltipText");
			oColumn.setTooltip(oTooltipBase);

			// CUT -> check RichTootipText
			sTooltip = oColumnsController_TestInstance._determineTooltipText(oColumn);
			assert.strictEqual(sTooltip, "RichTooltipText", "RichTooltipText was not determined");

			oColumn.setTooltip();
			oLabel = new sap.m.Label({
				text: "LabelText"
			});
			oLabel.setTooltip("ColumnLabelTooltipText");
			oColumn.setLabel(oLabel);

			// CUT -> check ColumnLabelTooltipText
			sTooltip = oColumnsController_TestInstance._determineTooltipText(oColumn);
			assert.strictEqual(sTooltip, "ColumnLabelTooltipText", "ColumnLabelTooltipText was not determined");

			oColumn = new sap.ui.table.AnalyticalColumn("LeadingProperty");
			sinon.stub(oColumn, "getTooltip_AsString").returns("AnalyticalToolTipText")

			// CUT -> check determination of TooltipText coming from AnalyticalColumn via binding
			sTooltip = oColumnsController_TestInstance._determineTooltipText(oColumn);
			assert.strictEqual(sTooltip, "AnalyticalToolTipText", "AnalyticalToolTipText was not determined");

		});

		QUnit.test("Shall check _correctColumnsItemsInPersistentData ", function(assert) {
			assert.ok(oColumnsController_TestInstance._correctColumnsItemsInPersistentData, "Method does not exist");

			var oModelStub = sinon.stub();
			var oModelData = JSON.parse("{\"transientData\":{\"columns\":{\"title\":\"Spalten\",\"items\":[{\"columnKey\":\"A\"},{\"columnKey\":\"B\"},{\"columnKey\":\"C\",\"visible\":false},{\"columnKey\":\"D\"},{\"columnKey\":\"E\"},{\"columnKey\":\"F\"}]}},\"persistentData\":{\"columns\":{\"columnsItems\":[{\"columnKey\": \"A\",\"index\": 4},{\"columnKey\": \"B\",\"index\": 1},{\"columnKey\": \"C\",\"index\" : 6},{\"columnKey\": \"D\"}]}}}");
			oModelStub.getData = sinon.stub().returns(oModelData);
			oModelStub.setData = sinon.stub();
			oColumnsController_TestInstance.getModel = sinon.stub().returns(oModelStub);

			// CUT -> method shall be executed without a payload and columnsItems shall be corrected/manipulated
			oColumnsController_TestInstance._correctColumnsItemsInPersistentData();

			assert.ok(oModelStub.getData().persistentData, "w/o Payload: PersistentData shall exist in the model");
			assert.ok(oModelStub.getData().persistentData.columns, "w/o Payload: Namespace columns shall exist in persistentData");
			assert.ok(oModelStub.getData().persistentData.columns.columnsItems, "w/o Payload: Array columnsItems shall exist in namespace columns of persistentData");
			assert.strictEqual(oModelStub.getData().persistentData.columns.columnsItems.length, 2, "w/o Payload: Two columnsItems entries shall still exist after method execution");

			assert.strictEqual(oModelStub.getData().persistentData.columns.columnsItems[0].index, 1, "w/o Payload: Sequence of columnsItems shall be sorted for column 1");
			assert.strictEqual(oModelStub.getData().persistentData.columns.columnsItems[1].index, 4, "w/o Payload: Sequence of columnsItems shall be sorted for column 2");

			// CUT -> method shall be executed with a given payload --> columnsItems shall be manipulated & indexes shall be rearranged, starting by 0
			oModelData = JSON.parse("{\"transientData\":{\"columns\":{\"title\":\"Spalten\",\"items\":[{\"columnKey\":\"A\"},{\"columnKey\":\"B\"},{\"columnKey\":\"C\",\"visible\":false},{\"columnKey\":\"D\"},{\"columnKey\":\"E\"},{\"columnKey\":\"F\"}]}},\"persistentData\":{\"columns\":{\"columnsItems\":[{\"columnKey\": \"A\",\"index\": 4},{\"columnKey\": \"B\",\"index\": 1},{\"columnKey\": \"C\",\"index\" : 6},{\"columnKey\": \"D\"}]}}}");
			oModelStub.getData = sinon.stub().returns(oModelData);
			var oPayload = {
				"columns": {
					"tableItemsChanged": true,
					"selectedItems": [
						{
							"columnKey": "B"
						}, {
							"columnKey": "A"
						}
					]
				}
			};

			oColumnsController_TestInstance._correctColumnsItemsInPersistentData(oPayload);

			assert.ok(oModelStub.getData().persistentData, "with Payload: PersistentData shall exist in the model");
			assert.ok(oModelStub.getData().persistentData.columns, "with Payload: Namespace columns shall exist in persistentData");
			assert.ok(oModelStub.getData().persistentData.columns.columnsItems, "with Payload: Array columnsItems shall exist in namespace columns of persistentData");
			assert.strictEqual(oModelStub.getData().persistentData.columns.columnsItems.length, 2, "with Payload: Two columnsItems entries shall still exist after method execution");

			assert.strictEqual(oModelStub.getData().persistentData.columns.columnsItems[0].index, 0, "with Payload: Sequence of columnsItems shall be sorted for column 1");
			assert.strictEqual(oModelStub.getData().persistentData.columns.columnsItems[1].index, 1, "with Payload: Sequence of columnsItems shall be sorted for column 2");
		});

		QUnit.test("Check FIX for column ordering after user interaction is executed on a column that did not have a columnsItem", function(assert) {
			/* Short descriptio of the problem:
			 	1.	Create Model
			 		a. Item aggregation = A, B, D, C -> (A and B are marked as visible)
			 		b. columnsItems aggregation = B gets moved to index 3
				2. Create ColumnsController
				3. Open ColumnsPanel
					a. Table items are shown in following sort order: A(x), B(x), C(), D()
				4. Now de-select visibility flag from A
				---------------------------------------------------------------------------
				As result the table has to keep the order of: A(), B(x), C(), D()
				Problem before was that column B was rearrange to index 3, which shall not B, as B was 
				not changed at all and not further columnsItems did reach the panel for column B!!!
			 */

			var oModel = new sap.ui.model.json.JSONModel();
			var _oData = {
				transientData: {
					columns: {
						title: "testModel",
						items: [
							{
								columnKey: 'A',
								visible: true,
								text: "Columns A",
								tooltip: "Columns A"
							}, {
								columnKey: 'B',
								visible: true,
								text: "Columns B",
								tooltip: "Columns B"
							}, {
								columnKey: 'D',
								visible: false,
								text: "Columns D",
								tooltip: "Columns D"
							}, {
								columnKey: 'C',
								visible: false,
								text: "Columns C",
								tooltip: "Columns C"
							}
						]
					}
				},
				persistentData: {
					columns: {
						columnsItems: [
							{
								columnKey: 'B',
								index: 3
							}
						]
					}
				}
			};

			oModel.setData(_oData);
			var oColumnsControllerFIX = new sap.ui.comp.personalization.ColumnsController();
			oColumnsControllerFIX.setModel(oModel, "$sapuicomppersonalizationBaseController");

			var oP13nColumnsPanel = oColumnsControllerFIX.getPanel();
			oP13nColumnsPanel.setModel(oModel, "$sapmP13nPanel");

			oP13nColumnsPanel.placeAt("content");
			sap.ui.getCore().applyChanges();

			//CUT -> now check important conerstones
			assert.strictEqual(oP13nColumnsPanel._oTable.getItems().length, 4, "Number of columns in the panel shall be 4");

			var oColumn1 = oP13nColumnsPanel._oTable.getItems()[0];
			assert.ok(oColumn1, "First column (A) does not exist");

			var sNameoColumn1 = oColumn1.data('P13nColumnKey');
			assert.strictEqual(sNameoColumn1, "A", "Name of first column shall be A");

			var oDomRefColumn1 = oColumn1.getDomRef();
			assert.ok(oDomRefColumn1, "DomRef object shall be exist of column A");

			var aDomRefChildObjects = oDomRefColumn1.getElementsByClassName("sapMCbActiveStateOff sapMCbMark sapMCbMarkChecked");
			assert.notEqual(aDomRefChildObjects.length, 0, "Columns A shall contain child DomRef which are identifiable by class names");

			var oDomRefCheckBoxColumnA = aDomRefChildObjects[0];
			assert.ok(oDomRefCheckBoxColumnA, "Columns A shall contain a CheckBox");

			//Simulate user action -> deselection of visible flag
			sap.ui.test.qunit.triggerTouchEvent("tap", oDomRefCheckBoxColumnA, {
				srcControl: oP13nColumnsPanel
			});
			this.clock.tick(500);

			assert.strictEqual(oP13nColumnsPanel._oTable.getItems().length, 4, "Number of columns in the panel shall still be 4");
			var oModelData = oP13nColumnsPanel.getModel("$sapmP13nPanel").getData();
			assert.ok(oModelData, "ColumnsPanel shall return valid model data");
			assert.strictEqual(oModelData.persistentData.columns.columnsItems.length, 2, "The model data shall contain to columnsItems");
			assert.strictEqual(oModelData.persistentData.columns.columnsItems[1].columnKey, "A", "The second columnsItem shall be for column A");
			assert.strictEqual(oModelData.persistentData.columns.columnsItems[1].visible, false, "The visibility of column A shall be false");
			assert.strictEqual(oModelData.persistentData.columns.columnsItems[1].index, undefined, "The index property of column A shall be undefined as the column was not moved");

			// now the most important test for the order of existing table items
			assert.strictEqual(oP13nColumnsPanel._oTable.getItems()[0].data('P13nColumnKey'), "A", "After user action column A shall be at the first position");
			assert.strictEqual(oP13nColumnsPanel._oTable.getItems()[1].data('P13nColumnKey'), "B", "After user action column B shall be at the second position");
			assert.strictEqual(oP13nColumnsPanel._oTable.getItems()[2].data('P13nColumnKey'), "C", "After user action column C shall be at the third position");
			assert.strictEqual(oP13nColumnsPanel._oTable.getItems()[3].data('P13nColumnKey'), "D", "After user action column D shall be at the fourth position");
		});

		QUnit.test("_sortByIndex", function(assert) {

			assert.deepEqual([
				{
					columnKey: "Col1",
					index: 2
				}, {
					columnKey: "Col2",
					index: 0
				}
			].sort(oColumnsController_TestInstance._sortByIndex), [
				{
					columnKey: "Col2",
					index: 0
				}, {
					columnKey: "Col1",
					index: 2
				}
			]);
			assert.deepEqual([
				{
					columnKey: "BalancedAmountInCompanyCodeCurrency",
					index: 5,
					visible: true
				}, {
					columnKey: "AmountInTransactionCurrency",
					index: 6,
					visible: true
				}, {
					columnKey: "DocumentDate",
					visible: false
				}, {
					columnKey: "SpecialGeneralLedgerCode",
					visible: false
				}, {
					columnKey: "AccountingDocumentItem",
					index: 0
				}, {
					columnKey: "CompanyCode",
					index: 1
				}, {
					columnKey: "Customer",
					index: 2
				}

			].sort(oColumnsController_TestInstance._sortByIndex), [
				{
					columnKey: "AccountingDocumentItem",
					index: 0
				}, {
					columnKey: "CompanyCode",
					index: 1
				}, {
					columnKey: "Customer",
					index: 2
				}, {
					columnKey: "BalancedAmountInCompanyCodeCurrency",
					index: 5,
					visible: true
				}, {
					columnKey: "AmountInTransactionCurrency",
					index: 6,
					visible: true
				}, {
					columnKey: "DocumentDate",
					visible: false
				}, {
					columnKey: "SpecialGeneralLedgerCode",
					visible: false
				}
			]);
		});

		QUnit.test("_onColumnTotal", function(assert) {
			assert.ok(oColumnsController_TestInstance._onColumnTotal);

			var oModelStub = sinon.stub();
			var oModelData = JSON.parse("{\"transientData\": {\"columns\": {\"title\": \"Spalten\",\"items\": [{\"columnKey\": \"Gjahr\",\"text\": \"Geschäftsjahr\",\"tooltip\": \"Geschäftsjahr\",\"visible\": true,\"width\": \"4.75em\"},{\"columnKey\": \"Bukrs\",\"text\": \"my Bukrs\",\"tooltip\": \"my Bukrs\",\"visible\": true,\"width\": \"4.75em\"},{\"columnKey\": \"Kunnr\",\"text\": \"Debitor\",\"tooltip\": \"Debitorennummer\",\"visible\": false,\"width\": \"10.75em\"},{\"columnKey\": \"Name1\",\"text\": \"Name\",\"tooltip\": \"Name 1\",\"visible\": true,\"width\": \"35.75em\"},{\"columnKey\": \"Dmbtr\",\"text\": \"Dmbtr\",\"tooltip\": \"Dmbtr\",\"visible\": true,\"width\": \"25.75em\"},{\"columnKey\": \"Hwaer\",\"text\": \"Währung\",\"tooltip\": \"Währungsschlüssel\",\"visible\": true,\"width\": \"5.75em\"}]}},\"persistentData\": {\"columns\": {\"columnsItems\": [{\"columnKey\": \"Gjahr\",\"index\": 0},{\"columnKey\": \"Bukrs\",\"index\": 1},{\"columnKey\": \"Kunnr\",\"visible\": false}]}}}");
			oModelStub.getData = sinon.stub().returns(oModelData);
			oModelStub.setData = sinon.stub();
			oColumnsController_TestInstance.getModel = sinon.stub().returns(oModelStub);
			var oColumn = new sap.m.ColumnListItem();
			oColumn.data("p13nData", {
				"columnKey": "Kunnr"
			});

			// CUT
			oColumnsController_TestInstance._onColumnTotal({
				column: oColumn,
				isSummed: true
			});

			assert.strictEqual(oModelStub.getData().persistentData.columns.columnsItems[0].total, undefined);
			assert.strictEqual(oModelStub.getData().persistentData.columns.columnsItems[1].total, undefined);
			assert.strictEqual(oModelStub.getData().persistentData.columns.columnsItems[2].total, true);
		});

	}(QUnit, sinon));
</script>
</head>
<body id="body" class="sapUiBody">
	<h1 id="qunit-header">qUnit Page for
		sap.ui.comp.personalization.ColumnsController</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>

	<div id="content"></div>
</body>
</html>
