<!DOCTYPE HTML>
<html>

<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<title>qUnit Page for sap.ui.comp.personalization.Controller</title>

	<script id="sap-ui-bootstrap" type="text/javascript" src="../../../../../../resources/sap-ui-core.js" data-sap-ui-theme="sap_bluecrystal" data-sap-ui-noConflict="true" data-sap-ui-libs="sap.ui.comp, sap.ui.table, sap.ui.commons">
	</script>

	<link rel="stylesheet" href="../../../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen" />
	<script type="text/javascript" src="../../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
	<script type="text/javascript" src="../../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
	<script type="text/javascript" src="../../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
	<script type="text/javascript" src="../../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
	<script type="text/javascript" src="../../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>

	<!-- use the sinon faketimers for this test -->
	<script type="text/javascript">
		sinon.config.useFakeTimers = true;
	</script>

	<script type="text/javascript">
		if (!(sap.ui.Device.browser.internet_explorer && sap.ui.Device.browser.version <= 8)) {
			jQuery.sap.require("sap.ui.qunit.qunit-coverage");
		}
		(function() {

			jQuery.sap.require("sap.ui.comp.personalization.Controller");
			jQuery.sap.require("sap.ui.comp.personalization.Util");

			module("API", {
				setup: function() {
					var gData = {
						items: [{
							"date": "2/5/1982",
							"number": 103,
							"city": "McDermotttown",
							"country": "Svalbard and Jan Mayen",
							"name": "Mary"
						}],
						columns: [{
							id: "name",
							text: "Name",
							path: "name"
						}, {
							id: "country",
							text: "Country",
							path: "country"
						}, {
							id: "city",
							text: "City",
							path: "city"
						}]
					};
					gRestoreColumns = {
						columns: {
							columnsItems: [{
								columnKey: "name",
								index: 0,
								visible: true,
								width: ""
							}, {
								columnKey: "country",
								index: 1,
								visible: true,
								width: ""
							}, {
								columnKey: "city",
								index: 2,
								visible: true,
								width: ""
							}]
						}
					};
					gRestoreColumnsAndEmptySort = {
						columns: {
							columnsItems: [{
								columnKey: "name",
								index: 0,
								visible: true,
								width: ""
							}, {
								columnKey: "country",
								index: 1,
								visible: true,
								width: ""
							}, {
								columnKey: "city",
								index: 2,
								visible: true,
								width: ""
							}]
						},
						sort: {
							sortItems: []
						}
					};
					gEmptyColumns = {
						columns: {
							columnsItems: []
						}
					};
					gVariantSort = {
						sort: {
							sortItems: [{
								columnKey: "name",
								operation: "Ascending"
							}]
						}
					};
					gVariantColumns = {
						columns: {
							columnsItems: [{
								columnKey: "country",
								index: 0
							}, {
								columnKey: "name",
								index: 1
							}]
						}
					};
					gVariantBigColumns = {
						columns: {
							columnsItems: [{
								columnKey: "country",
								index: 0
							}, {
								columnKey: "city",
								index: 1
							}, {
								columnKey: "name",
								index: 2
							}]
						}
					};
					gRestoreAndVariantColumns = {
						columns: {
							columnsItems: [{
								columnKey: "country",
								index: 0,
								visible: true,
								width: ""
							}, {
								columnKey: "name",
								index: 1,
								visible: true,
								width: ""
							}, {
								columnKey: "city",
								index: 2,
								visible: true,
								width: ""
							}]
						}
					};
					gRestoreAndVariantColumnsAndEmptySort = {
						columns: {
							columnsItems: [{
								columnKey: "country",
								index: 0,
								visible: true,
								width: ""
							}, {
								columnKey: "name",
								index: 1,
								visible: true,
								width: ""
							}, {
								columnKey: "city",
								index: 2,
								visible: true,
								width: ""
							}]
						},
						sort: {
							sortItems: []
						}
					};
					gRestoreAndVariantBigColumns = {
						columns: {
							columnsItems: [{
								columnKey: "country",
								index: 0,
								visible: true,
								width: ""
							}, {
								columnKey: "city",
								index: 1,
								visible: true,
								width: ""
							}, {
								columnKey: "name",
								index: 2,
								visible: true,
								width: ""
							}]
						}
					};
					gGetPath = function(sId) {
						var sPath = "";
						gData.columns.some(function(column) {
							if (column.id === sId) {
								sPath = column.path;
								return true;
							}
						});
						return sPath;
					};
					gSetting = {
						columns: {
							visible: false
						},
						group: {
							visible: false
						},
						filter: {
							visible: false
						},
						sort: {
							visible: false
						}
					};
					getSettingFor = function(aTypes) {
						var oSetting = jQuery.extend(true, {}, gSetting);
						aTypes.forEach(function(sType) {
							oSetting[sType].visible = true;
						});
						return oSetting;
					};
					getSettingWithIgnoredColumnFor = function(oColumn, aTypes) {
						var oSetting = getSettingFor(aTypes);
						aTypes.forEach(function(sType) {
							oSetting[sType].ignoreColumnKeys = [
								sap.ui.comp.personalization.Util.getColumnKey(oColumn)
							];
						});
						return oSetting;
					};
					getColumnIds = function(aColumns) {
						var aColumnKeys = [];
						aColumns.forEach(function(oColumn) {
							aColumnKeys.push(oColumn.getId());
						});
						return aColumnKeys;
					};
					createTable = function(sTableType, oData) {
						oData = oData || gData;
						var oTable = null;
						if (sTableType === "UITable") {
							oTable = new sap.ui.table.Table('testUITable', {
								columns: jQuery.map(oData.columns, function(oModelColumn) {
									var oColumn = new sap.ui.table.Column(oModelColumn.id, {
										label: new sap.ui.commons.Label({
											text: oModelColumn.text
										}),
										template: new sap.ui.commons.Label({
											text: {
												path: oModelColumn.path
											}
										})
									});
									oColumn.data("p13nData", {
										columnKey: oModelColumn.path,
										type: oModelColumn.path === "date" ? "date" : undefined
									});
									return oColumn;
								})
							});
							oTable.setModel(new sap.ui.model.json.JSONModel());
							oTable.bindRows("/items");
						} else if (sTableType === "MTable") {
							oTable = new sap.m.Table("testMTable", {
								columns: jQuery.map(oData.columns, function(oModelColumn) {
									var oColumn = new sap.m.Column(oModelColumn.id, {
										header: new sap.m.Label({
											text: oModelColumn.text
										})
									});
									oColumn.data("p13nData", {
										columnKey: oModelColumn.path
									});
									return oColumn;
								})
							});
							oTable.setModel(new sap.ui.model.json.JSONModel());
							oTable.bindAggregation("items", "/items", new sap.m.ColumnListItem({
								cells: jQuery.map(oData.columns, function(oModelColumn) {
									return new sap.m.Label({
										text: oModelColumn.text
									});
								})
							}));
						}
						return oTable;
					};
					addSortProperty = function(oTable, aColumns) {
						if (oTable instanceof sap.ui.table.Table) {
							var oBinding = oTable.getBinding("rows");
							var aSorters = [];
							aColumns.forEach(function(oColumn) {
								oColumn.setSortProperty(gGetPath(oColumn.getId()));
								aSorters.push(new sap.ui.model.Sorter(oColumn.getSortProperty(), oColumn.getSortOrder() === sap.ui.table.SortOrder.Descending));
								oColumn.setSorted(true);
							});
							oBinding.sort(aSorters);
						} else if (oTable instanceof sap.m.Table) {
							aColumns.forEach(function(oColumn) {
								var oP13nData = oColumn.data("p13nData");
								oP13nData.sortProperty = oP13nData.columnKey;
							});
						}
					};
					addFilterProperty = function(oTable, aColumns) {
						if (oTable instanceof sap.ui.table.Table) {
							var oBinding = oTable.getBinding("rows");
							var aFilters = [];
							aColumns.forEach(function(oColumn) {
								oColumn.setFilterProperty(gGetPath(oColumn.getId()));
								aFilters.push(new sap.ui.model.Filter(oColumn.getFilterProperty(), "BT", "A", "B"));
								oColumn.setFiltered(true);
							});
							oBinding.filter(aFilters);
						} else if (oTable instanceof sap.m.Table) {
							aColumns.forEach(function(oColumn) {
								var oP13nData = oColumn.data("p13nData");
								oP13nData.filterProperty = oP13nData.columnKey;
							});
						}
					};
					sortByIndex = function(aItems) {
						aItems.sort(function(a, b) {
							if (a.index < b.index) {
								return -1;
							}
							if (a.index > b.index) {
								return 1;
							}
							return 0;
						});
						return aItems;
					};
					sortColumnsByOrder = function(aColumns) {
						if (!(aColumns[0] instanceof sap.m.Column)) {
							return aColumns;
						}
						aColumns.sort(function(a, b) {
							if (a.getOrder() < b.getOrder()) {
								return -1;
							}
							if (a.getOrder() > b.getOrder()) {
								return 1;
							}
							return 0;
						});
						return aColumns;
					};
				},
				teardown: function() {
					gSetting = null;
					getSettingFor = null;
					getColumnIds = null;
					createTable = null;
					addSortProperty = null;
					addFilterProperty = null;
				}
			});

			var fTest12 = function(sTableType) {
				try {

					// system under test

					// arrange
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable
					});

					// act
					oController.destroy();

					// assertions
					deepEqual(sap.ui.base.EventProvider.getEventList(oTable), {});
					strictEqual(oController.getModel(), null);
					strictEqual(oController._oDialog, null);
					strictEqual(oController._oPersistentDataBeforeOpen, null);
					strictEqual(oController._oPersistentDataRestore, null);
					strictEqual(oController._oPersistentDataAlreadyKnown, null);
					strictEqual(oController._oPersistentDataCurrentVariant, null);
					strictEqual(oController._oSettingOriginalTable, null);
					strictEqual(oController._oSettingOriginalChart, null);
					strictEqual(oController._oSettingCurrent, null);
				} finally {
					// cleanup
					oTable.destroy();
				}
			};
			test("Controller (UITable): destroy", function() {
				fTest12("UITable");
			});

			test("Controller (MTable): destroy", function() {
				fTest12("MTable");
			});

			test("Controller: contructor - table mandatory", function() {
				// system under test
				var oController;

				// arrange

				// act
				var bException = false;
				try {
					oController = new sap.ui.comp.personalization.Controller({
						table: null
					});
				} catch (e) {
					bException = true;
				}

				// assertions
				ok(bException);
				ok(!oController);
			});

			var fTest64 = function(sTableType) {
				// system under test
				var oTable = createTable(sTableType);
				var oController = new sap.ui.comp.personalization.Controller({
					table: oTable
				});

				// arrange

				// act
				var bException = false;
				try {
					oController.setTable(oTable);
				} catch (e) {
					bException = true;
				}

				// assertions
				ok(bException);

				// cleanup
				oTable.destroy();
				oController.destroy();
			};
			test("Controller (UITable): contructor - setting columnKeys after constructor", function() {
				fTest64("UITable");
			});
			test("Controller (MTable): contructor - setting columnKeys after constructor", function() {
				fTest64("MTable");
			});

			var fTest65 = function(sTableType) {
				// system under test
				var oTable = createTable(sTableType);
				var oController = new sap.ui.comp.personalization.Controller({
					table: oTable
				});

				// arrange

				// act
				var bException = false;
				try {
					oController.setSetting({});
				} catch (e) {
					bException = true;
				}

				// assertions
				ok(bException);

				// cleanup
				oTable.destroy();
				oController.destroy();
			};
			test("Controller (UITable): contructor - setting 'setting' after constructor", function() {
				fTest65("UITable");
			});
			test("Controller (MTable): contructor - setting 'setting' after constructor", function() {
				fTest65("MTable");
			});

			var fTest66 = function(sTableType) {
				// system under test
				var oTable = createTable(sTableType);
				var oController = new sap.ui.comp.personalization.Controller({
					table: oTable
				});

				// arrange

				// act
				var bException = false;
				try {
					oController.setColumnKeys([]);
				} catch (e) {
					bException = true;
				}

				// assertions
				ok(bException);

				// cleanup
				oTable.destroy();
				oController.destroy();
			};
			test("Controller (UITable): contructor - setting columnKeys after constructor", function() {
				fTest66("UITable");
			});
			test("Controller (MTable): contructor - setting columnKeys after constructor", function() {
				fTest66("MTable");
			});

			var fTest67 = function(sTableType) {
				// system under test
				var oTable = createTable(sTableType);
				var oController = new sap.ui.comp.personalization.Controller({
					table: oTable
				});

				// arrange

				// act
				var bException = false;
				try {
					oController.setResetToInitialTableState(false);
				} catch (e) {
					bException = true;
				}

				// assertions
				ok(bException);

				// cleanup
				oTable.destroy();
				oController.destroy();
			};
			test("Controller (UITable): contructor - setting resetToInitialTableState after constructor", function() {
				fTest67("UITable");
			});
			test("Controller (MTable): contructor - setting resetToInitialTableState after constructor", function() {
				fTest67("MTable");
			});

			var fTest11 = function(sTableType) {
				try {
					// system under test

					// arrange
					var oTable = createTable(sTableType);

					// act
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"sort"
						])
					});

					// assertions
					ok(!!oController.getModel().getData().persistentData.sort);
					ok(!(!!oController.getModel().getData().persistentData.columns));
					ok(!(!!oController.getModel().getData().persistentData.filter));
					ok(!(!!oController.getModel().getData().persistentData.group));

					ok(!!oController._oPersistentDataRestore.sort);
					ok(!(!!oController._oPersistentDataRestore.columns));
					ok(!(!!oController._oPersistentDataRestore.filter));
					ok(!(!!oController._oPersistentDataRestore.group));

					ok(!!oController._oPersistentDataAlreadyKnown.sort);
					ok(!(!!oController._oPersistentDataAlreadyKnown.columns));
					ok(!(!!oController._oPersistentDataAlreadyKnown.filter));
					ok(!(!!oController._oPersistentDataAlreadyKnown.group));

					deepEqual(oController._oPersistentDataCurrentVariant, {});

					if (oTable instanceof sap.ui.table.Table) {
						strictEqual(sap.ui.base.EventProvider.getEventList(oTable)["sort"].length, 1);
					}
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("Controller (UITable): contructor - table, setting", function() {
				fTest11("UITable");
			});
			test("Controller (MTable): contructor - table, setting", function() {
				fTest11("MTable");
			});

			var fTest9 = function(sTableType) {
				try {
					// system under test

					// arrange
					var oTable = createTable(sTableType);

					// act
					var oController = new sap.ui.comp.personalization.Controller({
						setting: getSettingFor([
							"sort"
						]),
						table: oTable
					});

					// assertions
					ok(!!oController.getModel().getData().persistentData.sort);
					ok(!(!!oController.getModel().getData().persistentData.columns));
					ok(!(!!oController.getModel().getData().persistentData.filter));
					ok(!(!!oController.getModel().getData().persistentData.group));

					ok(!!oController._oPersistentDataRestore.sort);
					ok(!(!!oController._oPersistentDataRestore.columns));
					ok(!(!!oController._oPersistentDataRestore.filter));
					ok(!(!!oController._oPersistentDataRestore.group));

					ok(!!oController._oPersistentDataAlreadyKnown.sort);
					ok(!(!!oController._oPersistentDataAlreadyKnown.columns));
					ok(!(!!oController._oPersistentDataAlreadyKnown.filter));
					ok(!(!!oController._oPersistentDataAlreadyKnown.group));

					deepEqual(oController._oPersistentDataCurrentVariant, {});

					if (oTable instanceof sap.ui.table.Table) {
						strictEqual(sap.ui.base.EventProvider.getEventList(oTable)["sort"].length, 1);
					}
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("Controller (UITable): contructor - setting, table", function() {
				fTest9("UITable");
			});
			test("Controller (MTable): contructor - setting, table", function() {
				fTest9("MTable");
			});

			var fTest13 = function(sTableType) {
				try {
					// system under test

					// arrange
					var oTable = createTable(sTableType);

					// act
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// assertions
					deepEqual(oController.getModel().getData().persistentData, gEmptyColumns);
					deepEqual(oController._oPersistentDataRestore, gRestoreColumns);
					deepEqual(oController._oPersistentDataCurrentVariant, {});
					deepEqual(oController._oPersistentDataAlreadyKnown, gRestoreColumns);
					deepEqual(oController._oPersistentDataBeforeOpen, null);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("Controller (UITable): contructor - table, setting - check model data", function() {
				fTest13("UITable");
			});
			/*test("Controller (MTable): contructor - table, setting - check model data", function() {
				fTest13("MTable");
			});*/

			/*TODO
			var fTest54 = function(sTableType) {
				try {
					// system under test
					var oController = new sap.ui.comp.personalization.Controller();

					// arrange

					// act
					oController.setSetting({
						columns: {
							visible: false
						}
					});

					// assertions
					deepEqual(oController._oSettingCurrent.columns, undefined);
					deepEqual(oController._oSettingCurrent.sort.visible, true);
					deepEqual(oController._oSettingCurrent.filter.visible, true);
					deepEqual(oController._oSettingCurrent.group.visible, true);
				} finally {
					// cleanup
					oController.destroy();
				}
			};
			test("Settings (UITable): visible false", function() {
				fTest54("UITable");
			});
			test("Settings (MTable): visible false", function() {
				fTest54("MTable");
			});

			var fTest56 = function(sTableType) {
				try {
					// system under test
					var oController = new sap.ui.comp.personalization.Controller();

					// arrange

					// act
					oController.setSetting({
						columns: {
							visibleDummy: false
						}
					});

					// assertions
					deepEqual(oController._oSettingCurrent.columns.visible, true);
					deepEqual(oController._oSettingCurrent.sort.visible, true);
					deepEqual(oController._oSettingCurrent.filter.visible, true);
					deepEqual(oController._oSettingCurrent.group.visible, true);

				} finally {
					// cleanup
					oController.destroy();
				}
			};
			test("Settings (UITable): visible not defined", function() {
				fTest56("UITable");
			});
			test("Settings (MTable): visible not defined", function() {
				fTest56("MTable");
			});

			var fTest56 = function(sTableType) {
				try {
					// system under test
					var oController = new sap.ui.comp.personalization.Controller();

					// arrange

					// act
					oController.setSetting({
						columns: {
							visibleDummy: false
						}
					});

					// assertions
					deepEqual(oController._oSettingCurrent.columns.visible, true);
					deepEqual(oController._oSettingCurrent.sort.visible, true);
					deepEqual(oController._oSettingCurrent.filter.visible, true);
					deepEqual(oController._oSettingCurrent.group.visible, true);

				} finally {
					// cleanup
					oController.destroy();
				}
			};
			test("Settings (UITable): visible not defined", function() {
				fTest56("UITable");
			});
			test("Settings (MTable): visible not defined", function() {
				fTest56("MTable");
			});

			var fTest59 = function(sTableType) {
				try {
					// system under test
					var oController = new sap.ui.comp.personalization.Controller();

					// arrange

					// act
					oController.setSetting({
						columns: {
							visible: false
						}
					});

					oController.setSetting({
						columns: {
							visible: true
						}
					});

					// assertions
					deepEqual(oController._oSettingCurrent.columns.visible, true);
					deepEqual(oController._oSettingCurrent.sort.visible, true);
					deepEqual(oController._oSettingCurrent.filter.visible, true);
					deepEqual(oController._oSettingCurrent.group.visible, true);
				} finally {
					// cleanup
					oController.destroy();
				}
			};
			test("Settings (UITable): set settings one after another", function() {
				fTest59("UITable");
			});
			test("Settings (MTable): set settings one after another", function() {
				fTest59("MTable");
			});

			var fTest58 = function(sTableType) {
				try {
					// system under test
					var oController = new sap.ui.comp.personalization.Controller();

					// arrange

					// act
					oController.setSetting({
						columns: {
							visible: true
						},
						columns: {
							visible: false
						}
					});

					// assertions
					deepEqual(oController._oSettingCurrent.columns, undefined);
					deepEqual(oController._oSettingCurrent.sort.visible, true);
					deepEqual(oController._oSettingCurrent.filter.visible, true);
					deepEqual(oController._oSettingCurrent.group.visible, true);
				} finally {
					// cleanup
					oController.destroy();
				}
			};
			test("Settings (UITable): add same panel twice - last one wins", function() {
				fTest58("UITable");
			});
			test("Settings (MTable): add same panel twice - last one wins", function() {
				fTest58("MTable");
			});*/

			var fTest57 = function(sTableType) {
				try {
					var oVariant = {
						customColumns: {
							customColumnsItems: [
								"name", "company", "price"
							]
						}
					};
					var oJson = {
						customColumns: {
							customColumnsItems: [
								"name"
							]
						}
					};
					sap.ui.comp.personalization.BaseController.extend("CustomConrollerColumns",
						/** @lends CustomConrollerColumns*/
						{
							constructor: function(sId, mSettings) {
								sap.ui.comp.personalization.BaseController.apply(this, arguments);
								this.setType("customColumns");
							},
							metadata: {},
							getTitleText: function() {
								return "MyColumns";
							},
							_getTable2Json: function() {
								return oJson;
							},
							_getTable2JsonRestore: function() {
								return this._getTable2Json();
							}
						});
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: {
							customColumns: {
								visible: true,
								controller: new CustomConrollerColumns()
							},
							columns: {
								visible: false
							},
							group: {
								visible: false
							},
							filter: {
								visible: false
							},
							sort: {
								visible: false
							}
						}
					});

					// arrange

					// act
					oController.setPersonalizationData(oVariant);

					// assert
					deepEqual(oController.getModel().getData().persistentData, {
						customColumns: {
							customColumnsItems: []
						}
					});
					deepEqual(oController._oPersistentDataRestore, oJson);
					deepEqual(oController._oPersistentDataCurrentVariant, oVariant);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("setPersonalizationData (UITable) - custom controller", function() {
				fTest57("UITable");
			});
			test("setPersonalizationData (MTable) - custom controller", function() {
				fTest57("MTable");
			});

			var fTest60 = function(sTableType) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					addSortProperty(oTable, [
						oTable.getColumns()[0]
					]);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"sort"
						])
					});

					// arrange

					// act
					oController.setPersonalizationData(null);

					// assert
					deepEqual(oController.getModel().getData().persistentData, gVariantSort);
					deepEqual(oController._oPersistentDataRestore, gVariantSort);
					deepEqual(oController._oPersistentDataCurrentVariant, {});
					deepEqual(oController._oPersistentDataAlreadyKnown, gVariantSort);
					deepEqual(oController._oPersistentDataBeforeOpen, null);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("setPersonalizationData (UITable) with initial sorting - null", function() {
				fTest60("UITable");
			});
			/*test("setPersonalizationData (MTable) with initial sorting - null", function() {
				fTest60("MTable");
			});*/

			var fTest8 = function(sTableType) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange

					// act
					oController.setPersonalizationData(null);

					// assert
					deepEqual(oController.getModel().getData().persistentData, gEmptyColumns);
					deepEqual(oController._oPersistentDataRestore, gRestoreColumns);
					deepEqual(oController._oPersistentDataCurrentVariant, {});
					deepEqual(oController._oPersistentDataAlreadyKnown, gRestoreColumns);
					deepEqual(oController._oPersistentDataBeforeOpen, null);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("setPersonalizationData (UITable) - null", function() {
				fTest8("UITable");
			});
			test("setPersonalizationData (MTable) - null", function() {
				fTest8("MTable");
			});

			var fTest55 = function(sTableType) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange

					// act
					oController.setPersonalizationData({});

					// assert
					deepEqual(oController.getModel().getData().persistentData, gEmptyColumns);
					deepEqual(oController._oPersistentDataRestore, gRestoreColumns);
					deepEqual(oController._oPersistentDataCurrentVariant, {});
					deepEqual(oController._oPersistentDataAlreadyKnown, gRestoreColumns);
					deepEqual(oController._oPersistentDataBeforeOpen, null);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("setPersonalizationData (UITable) - {}", function() {
				fTest55("UITable");
			});
			test("setPersonalizationData (MTable) - {}", function() {
				fTest55("MTable");
			});

			var fTest7 = function(sTableType) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange
					var fnFireAfterP13nModelDataChangeSpy = sinon.spy(oController, "fireAfterP13nModelDataChange");

					// act
					oController.setPersonalizationData(gVariantColumns);

					sortByIndex(oController.getModel().getData().persistentData.columns.columnsItems);
					sortByIndex(oController._oPersistentDataCurrentVariant.columns.columnsItems);

					// assert
					strictEqual(fnFireAfterP13nModelDataChangeSpy.callCount, 1, "The after model data change event was fired once");
					deepEqual(oController.getModel().getData().persistentData, gVariantColumns);
					deepEqual(oController._oPersistentDataRestore, gRestoreColumns);
					deepEqual(oController._oPersistentDataCurrentVariant, gVariantColumns);
					deepEqual(oController._oPersistentDataAlreadyKnown, gRestoreAndVariantColumns);
					deepEqual(oController._oPersistentDataBeforeOpen, null);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("setPersonalizationData (UITable) - valid data", function() {
				fTest7("UITable");
			});
			test("setPersonalizationData (MTable) - valid data", function() {
				fTest7("MTable");
			});

			var fTest18 = function(sTableType) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange

					// act
					oController.setPersonalizationData(gVariantColumns);

					// assertions
					deepEqual(getColumnIds(sortColumnsByOrder(oTable.getColumns())), [
						"country", "name", "city"
					]);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("setPersonalizationData (UITable) : check table - v1", function() {
				fTest18("UITable");
			});
			test("setPersonalizationData (MTable) : check table - v1", function() {
				fTest18("MTable");
			});

			var fTest19 = function(sTableType) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange

					// act
					oController.setPersonalizationData(gVariantBigColumns);

					// assertions
					deepEqual(getColumnIds(sortColumnsByOrder(oTable.getColumns())), [
						"country", "city", "name"
					]);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("setPersonalizationData (UITable): check table - v2", function() {
				fTest19("UITable");
			});
			test("setPersonalizationData (MTable): check table - v2", function() {
				fTest19("MTable");
			});

			var fTest20 = function(sTableType) {
				try {
					// system under test
					var oTable = createTable(sTableType, {
						items: [{
							"date": "2/5/1982",
							"number": 103,
							"city": "McDermotttown",
							"country": "Svalbard and Jan Mayen"
						}],
						columns: [{
							id: "country",
							text: "Country",
							path: "country"
						}, {
							id: "city",
							text: "City",
							path: "city"
						}]
					});
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange

					// act
					oController.setPersonalizationData(gVariantBigColumns);

					// assertions
					deepEqual(getColumnIds(sortColumnsByOrder(oTable.getColumns())), [
						"country", "city"
					]);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("setPersonalizationData (UITable): check table - v3: table size < model size", function() {
				fTest20("UITable");
			});
			test("setPersonalizationData (MTable): check table - v3: table size < model size", function() {
				fTest20("MTable");
			});

			var fTest21 = function(sTableType) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange

					// act
					oController.setPersonalizationData(gVariantColumns);
					var aColumns = oTable.getColumns();
					if (oTable instanceof sap.m.Table) {
						sortColumnsByOrder(aColumns);
					}

					// assertions
					deepEqual(getColumnIds(sortColumnsByOrder(oTable.getColumns())), [
						"country", "name", "city"
					]);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("setPersonalizationData (UITable): check table - v4: table size > model size", function() {
				fTest21("UITable");
			});
			test("setPersonalizationData (MTable): check table - v4: table size > model size", function() {
				fTest21("MTable");
			});

			var fTest39 = function(sTableType) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable
					});

					// arrange

					// act
					//test 1
					oController.setPersonalizationData({
						sort: {
							sortItems: [{
								"columnKey": "country",
								"operation": "Ascending"
							}, {
								"columnKey": "name",
								"operation": "Descending"
							}]
						}
					});

					// assertions
					deepEqual(oController._oModel.getData().persistentData.sort.sortItems, [{
						"columnKey": "country",
						"operation": "Ascending"
					}, {
						"columnKey": "name",
						"operation": "Descending"
					}], "sortItems initially OK");

					//test 2
					oController.setPersonalizationData({
						sort: {
							sortItems: [{
								"columnKey": "nonExistingColumn",
								"operation": "Descending"
							}, {
								"columnKey": "name",
								"operation": "Ascending"
							}]
						}
					});
					deepEqual(oController._oModel.getData().persistentData.sort.sortItems, [{
						"columnKey": "name",
						"operation": "Ascending"
					}], "sortItems after setPersonalizationData with one non-existing column OK");

					//test 3
					oController.setPersonalizationData({
						sort: {
							sortItems: [{
								"columnKey": "nonExistingColumn0",
								"operation": "Descending"
							}, {
								"columnKey": "name",
								"operation": "Ascending"
							}, {
								"columnKey": "nonExistingColumn1",
								"operation": "Descending"
							}, {
								"columnKey": "country",
								"operation": "Ascending"
							}]
						}
					});
					deepEqual(oController._oModel.getData().persistentData.sort.sortItems, [{
						"columnKey": "name",
						"operation": "Ascending"
					}, {
						"columnKey": "country",
						"operation": "Ascending"
					}], "sortItems after setPersonalizationData with two non-existing columns OK");

					//test 4 - filter
					oController.setPersonalizationData({
						filter: {
							filterItems: [{
								columnKey: "nonExistingColumn0",
								operation: "BT",
								exclude: false,
								value1: "A",
								value2: "C"
							}, {
								columnKey: "name",
								operation: "BT",
								exclude: false,
								value1: "A",
								value2: "C"
							}, {
								columnKey: "nonExistingColumn1",
								operation: "BT",
								exclude: false,
								value1: "A",
								value2: "C"
							}, {
								columnKey: "country",
								operation: "EQ",
								exclude: false,
								value1: "A"
							}]
						}
					});
					deepEqual(oController._oModel.getData().persistentData.filter.filterItems, [{
						columnKey: "name",
						operation: "BT",
						exclude: false,
						value1: "A",
						value2: "C"
					}, {
						columnKey: "country",
						operation: "EQ",
						exclude: false,
						value1: "A"
					}], "filterItems after setPersonalizationData with two non-existing columns OK");

					// test 5 - group
					/*
					 * Special case for tables of type sap.ui.table.Table (with exception of AnalyticalTable) Currently sap.ui.table.Table does not support
					 * grouping feature as expected!
					 */
					if (sTableType !== "UITable") {
						oController.setPersonalizationData({
							group: {
								groupItems: [{
									columnKey: "nonExistingColumn0",
									operation: "Ascending",
									showIfGrouped: true
								}, {
									columnKey: "name",
									operation: "Descending",
									showIfGrouped: true
								}, {
									columnKey: "nonExistingColumn1",
									operation: "Ascending",
									showIfGrouped: false
								}, {
									columnKey: "country",
									operation: "Ascending",
									showIfGrouped: true
								}]
							}
						});
						if (oTable instanceof sap.ui.table.Table) {
							deepEqual(oController._oModel.getData().persistentData.group.groupItems, [{
								columnKey: "name",
								showIfGrouped: false
							}], "groupItems after setPersonalizationData with two non-existing columns OK");
						} else {
							deepEqual(oController._oModel.getData().persistentData.group.groupItems, [{
								columnKey: "name",
								operation: "Descending",
								showIfGrouped: true
							}, {
								columnKey: "country",
								operation: "Ascending",
								showIfGrouped: true
							}], "groupItems after setPersonalizationData with two non-existing columns OK");
						}
					}

				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("setPersonalizationData (UITable): stress testing", function() {
				fTest39("UITable");
			});
			test("setPersonalizationData (MTable): stress testing", function() {
				fTest39("MTable");
			});

			var fTest52 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();

					// act: set variant, open and simulate user interation, OK
					oController.setPersonalizationData(gVariantColumns);
					oController.openDialog();
					oTest.clock.tick(500);
					oController.getModel().setData({
						persistentData: jQuery.extend(true, {}, gVariantBigColumns),
						transientData: oController.getModel().getData().transientData
					});
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);

					sortByIndex(oController._oPersistentDataCurrentVariant.columns.columnsItems);

					// assertions
					deepEqual(oController.getModel().getData().persistentData, gVariantBigColumns);
					deepEqual(oController._oPersistentDataRestore, gRestoreColumns);
					deepEqual(oController._oPersistentDataCurrentVariant, gVariantColumns);
					deepEqual(oController._oPersistentDataAlreadyKnown, gRestoreAndVariantBigColumns);
					deepEqual(oController._oPersistentDataBeforeOpen, null);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("setPersonalization (UITable): set variant -> openDialog -> change -> OK", function() {
				fTest52("UITable", this);
			});
			test("setPersonalization (MTable): set variant -> openDialog -> change -> OK", function() {
				fTest52("MTable", this);
			});

			var fTest6 = function(sTableType) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange

					// act
					var oPersistentDataCopy = oController._getPersistentDataCopy();

					// assertions
					deepEqual(oPersistentDataCopy, gEmptyColumns);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("_getPersistentDataCopy (UITable) - after init", function() {
				fTest6("UITable");
			});
			test("_getPersistentDataCopy (MTable) - after init", function() {
				fTest6("MTable");
			});

			var fTest10 = function(sTableType) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange
					oController.setPersonalizationData(gVariantColumns);

					// act
					var oPersistentDataCopy = oController._getPersistentDataCopy();

					sortByIndex(oPersistentDataCopy.columns.columnsItems);

					// assertions
					deepEqual(oPersistentDataCopy, gVariantColumns);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("_getPersistentDataCopy (UITable) - after variant", function() {
				fTest10("UITable");
			});
			test("_getPersistentDataCopy (MTable) - after variant", function() {
				fTest10("MTable");
			});

			var fTest22 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();
					var fnFireAfterP13nModelDataChangeSpy = sinon.spy(oController, "fireAfterP13nModelDataChange");
					var fn_FireChangeEventSpy = sinon.spy(oController, "_fireChangeEvent");

					// act: open, wait, ok, wait
					oController.openDialog();
					oTest.clock.tick(500);
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);

					// assertions
					strictEqual(fn_FireChangeEventSpy.callCount, 1, "The _fireChangeEvent() was called");
					strictEqual(fnFireAfterP13nModelDataChangeSpy.callCount, 0, "The after model data change event was not fired because nothing was changed");
					deepEqual(oController.getModel().getData().persistentData, gEmptyColumns, "model data === empty");
					deepEqual(oController._oPersistentDataRestore, gRestoreColumns);
					//ER??		deepEqual(oController._oPersistentDataCurrentVariant, gRestoreColumns);
					deepEqual(oController._oPersistentDataAlreadyKnown, gRestoreColumns);
					deepEqual(oController._oPersistentDataBeforeOpen, null);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("Open and OK (UITable): openDialog -> click 'OK': not changed", function() {
				fTest22("UITable", this);
			});
			test("Open and OK (MTable): openDialog -> click 'OK': not changed", function() {
				fTest22("MTable", this);
			});

			var fTest23 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();

					// act: open, wait, user interaction, ok, wait
					oController.openDialog();
					oTest.clock.tick(500);
					oController.getModel().setData({
						persistentData: jQuery.extend(true, {}, gVariantColumns),
						transientData: oController.getModel().getData().transientData
					}, true);
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);

					// arrange
					var fnFireAfterP13nModelDataChangeSpy = sinon.spy(oController, "fireAfterP13nModelDataChange");
					var fn_FireChangeEventSpy = sinon.spy(oController, "_fireChangeEvent");

					// act: open, wait, revert user interaction, ok, wait
					oController.openDialog();
					oTest.clock.tick(500);
					oController.getModel().setData({
						persistentData: {
							columns: {
								columnsItems: [{
									columnKey: "name",
									index: 0
								}, {
									columnKey: "country",
									index: 1
								}]
							}
						},
						transientData: oController.getModel().getData().transientData
					}, true);
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);

					// assertions
					strictEqual(fn_FireChangeEventSpy.callCount, 1, "The _fireChangeEvent() was called");
					strictEqual(fnFireAfterP13nModelDataChangeSpy.callCount, 1, "The after model data change event was fired");
					deepEqual(fnFireAfterP13nModelDataChangeSpy.getCall(0).args[0].changeTypeRestore, {
						columns: sap.ui.comp.personalization.ChangeType.Unchanged
					}, "variant has not been changed");
					deepEqual(fnFireAfterP13nModelDataChangeSpy.getCall(0).args[0].persistentData, {}, "persistentData === {}");
					deepEqual(oController.getModel().getData().persistentData, {
						columns: {
							columnsItems: [{
								columnKey: "name",
								index: 0
							}, {
								columnKey: "country",
								index: 1
							}, {
								columnKey: "city",
								index: 2
							}]
						}
					});
					deepEqual(oController._oPersistentDataRestore, gRestoreColumns);
					deepEqual(oController._oPersistentDataCurrentVariant, {});
					deepEqual(oController._oPersistentDataAlreadyKnown, gRestoreColumns);
					deepEqual(oController._oPersistentDataBeforeOpen, null);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("Open and OK (UITable): openDialog -> change -> click 'OK' -> openDialog -> revert change -> click 'OK': not changed", function() {
				fTest23("UITable", this);
			});
			test("Open and OK (MTable): openDialog -> change -> click 'OK' -> openDialog -> revert change -> click 'OK': not changed", function() {
				fTest23("MTable", this);
			});

			var fTest24 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();
					var fnFireAfterP13nModelDataChangeSpy = sinon.spy(oController, "fireAfterP13nModelDataChange");
					var fn_FireChangeEventSpy = sinon.spy(oController, "_fireChangeEvent");

					// act: open, wait, user interaction, ok, wait
					oController.openDialog();
					oTest.clock.tick(500);
					oController.getModel().setData({
						persistentData: jQuery.extend(true, {}, gVariantColumns),
						transientData: oController.getModel().getData().transientData
					});
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);

					// assertions
					strictEqual(fn_FireChangeEventSpy.callCount, 1, "The _fireChangeEvent() was called");
					strictEqual(fnFireAfterP13nModelDataChangeSpy.callCount, 1, "The after model data change event was fired");
					deepEqual(fnFireAfterP13nModelDataChangeSpy.getCall(0).args[0].changeTypeRestore, {
						columns: sap.ui.comp.personalization.ChangeType.TableChanged
					}, "variant has been changed");
					deepEqual(fnFireAfterP13nModelDataChangeSpy.getCall(0).args[0].persistentData, gVariantColumns, "persistentData === user interaction");
					deepEqual(oController.getModel().getData().persistentData, {
						columns: {
							columnsItems: [{
								columnKey: "country",
								index: 0
							}, {
								columnKey: "name",
								index: 1
							}, {
								columnKey: "city",
								index: 2
							}]
						}
					});
					deepEqual(oController._oPersistentDataRestore, gRestoreColumns);
					deepEqual(oController._oPersistentDataCurrentVariant, {});
					deepEqual(oController._oPersistentDataAlreadyKnown, gRestoreAndVariantColumns);
					deepEqual(oController._oPersistentDataBeforeOpen, null);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("Open and OK (UITable): openDialog -> change -> click 'OK': is changed", function() {
				fTest24("UITable", this);
			});
			test("Open and OK  (MTable): openDialog -> change -> click 'OK': is changed", function() {
				fTest24("MTable", this);
			});

			var fTest29 = function(sTableType) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					addSortProperty(oTable, [
						oTable.getColumns()[0]
					]);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"sort", "filter", "columns"
						])
					});

					deepEqual(oController._oSettingCurrent.sort.controller.getChangeData(oController.getModel().getData().persistentData, {
						sort: {
							sortItems: [{
								columnKey: "name",
								operation: "Descending"
							}]
						}
					}), {
						sort: {
							sortItems: [{
								columnKey: "name",
								operation: "Ascending"
							}]
						}
					}, "only 'sort' should be returned");

				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("Multiple namespaces (UITable): getChangeData of SortController", function() {
				fTest29("UITable");
			});
			/*test("SortController (MTable): getChangeData with multiple namespaces", function() {
				fTest29("MTable");
			});*/

			var fTest30 = function(sTableType) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"sort", "filter", "columns"
						])
					});

					deepEqual(oController._oSettingCurrent.filter.controller.getChangeData(oController.getModel().getData().persistentData, {
						filter: {
							filterItems: [{
								columnKey: "name",
								operation: "BT",
								exclude: false,
								value1: "A",
								value2: "C"
							}]
						}
					}), {
						filter: {
							filterItems: []
						}
					}, "only 'filter' should be returned");

				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("Multiple namespaces (UITable): getChangeData of FilterController", function() {
				fTest30("UITable");
			});
			test("Multiple namespaces (MTable): getChangeData of FilterController", function() {
				fTest30("MTable");
			});

			var fTest31 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();
					var fnFireAfterP13nModelDataChangeSpy = sinon.spy(oController, "fireAfterP13nModelDataChange");
					var fn_FireChangeEventSpy = sinon.spy(oController, "_fireChangeEvent");

					// act: open, wait, user interaction, reset, ok, wait
					oController.openDialog();
					oController._oDialog.setShowResetEnabled(true);
					oTest.clock.tick(500);
					oController.getModel().setData({
						persistentData: jQuery.extend(true, {}, gVariantColumns),
						transientData: oController.getModel().getData().transientData
					});
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[2].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);

					// assertions
					strictEqual(fn_FireChangeEventSpy.callCount, 1);
					strictEqual(fnFireAfterP13nModelDataChangeSpy.callCount, 0);
					deepEqual(oController.getModel().getData().persistentData, gEmptyColumns);
					deepEqual(oController._oPersistentDataRestore, gRestoreColumns);
					deepEqual(oController._oPersistentDataCurrentVariant, {});
					deepEqual(oController._oPersistentDataAlreadyKnown, gRestoreColumns);
					deepEqual(oController._oPersistentDataBeforeOpen, null);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("Open and RESET without VariantManagement (UITable): openDialog -> change -> RESET -> OK: back to Restore", function() {
				fTest31("UITable", this);
			});
			test("Open and RESET without VariantManagement (MTable): openDialog -> change -> RESET -> OK: back to Restore", function() {
				fTest31("MTable", this);
			});

			var fTest32 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();

					// act: set variant
					oController.setPersonalizationData(gVariantColumns);

					var fnFireAfterP13nModelDataChangeSpy = sinon.spy(oController, "fireAfterP13nModelDataChange");
					var fn_FireChangeEventSpy = sinon.spy(oController, "_fireChangeEvent");

					// act: open, wait, user interaction, reset, ok, wait
					oController.openDialog();
					oController._oDialog.setShowResetEnabled(true);
					oTest.clock.tick(500);
					oController.getModel().setData({
						persistentData: jQuery.extend(true, {}, gVariantBigColumns),
						transientData: oController.getModel().getData().transientData
					});
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[2].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);

					// assertions
					strictEqual(fn_FireChangeEventSpy.callCount, 1);
					strictEqual(fnFireAfterP13nModelDataChangeSpy.callCount, 1);
					deepEqual(oController.getModel().getData().persistentData, gEmptyColumns);
					deepEqual(oController._oPersistentDataRestore, gRestoreColumns);
					deepEqual(oController._oPersistentDataCurrentVariant, gVariantColumns);
					deepEqual(oController._oPersistentDataAlreadyKnown, gRestoreColumns);
					deepEqual(oController._oPersistentDataBeforeOpen, null);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("Open and RESET without VariantManagement (UITable): set variant -> openDialog -> change -> RESET -> OK: back to Restore", function() {
				fTest32("UITable", this);
			});
			test("Open and RESET without VariantManagement (MTable): set variant -> openDialog -> change -> RESET -> OK: back to Restore", function() {
				fTest32("MTable", this);
			});

			var fTest33 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();

					// act: set variant
					oController.setPersonalizationData(gVariantColumns);

					var fnFireAfterP13nModelDataChangeSpy = sinon.spy(oController, "fireAfterP13nModelDataChange");
					var fn_FireChangeEventSpy = sinon.spy(oController, "_fireChangeEvent");

					// act: open, wait, user interaction, ok, wait, open, wait, reset, wait, ok, wait
					oController.openDialog();
					oTest.clock.tick(500);
					oController.getModel().setData({
						persistentData: jQuery.extend(true, {}, gVariantBigColumns),
						transientData: oController.getModel().getData().transientData
					});
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);
					oController.openDialog();
					oTest.clock.tick(500);
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[2].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);

					// assertions
					strictEqual(fn_FireChangeEventSpy.callCount, 2);
					strictEqual(fnFireAfterP13nModelDataChangeSpy.callCount, 2);
					deepEqual(oController.getModel().getData().persistentData, gEmptyColumns);
					deepEqual(oController._oPersistentDataRestore, gRestoreColumns);
					deepEqual(oController._oPersistentDataCurrentVariant, gVariantColumns);
					deepEqual(oController._oPersistentDataAlreadyKnown, gRestoreColumns);
					deepEqual(oController._oPersistentDataBeforeOpen, null);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("Open and RESET without VariantManagement (UITable): set variant -> openDialog -> change -> OK -> openDialog -> RESET -> OK: back to Restore", function() {
				fTest33("UITable", this);
			});
			test("Open and RESET without VariantManagement (MTable): set variant -> openDialog -> change -> OK -> openDialog -> RESET -> OK: back to Restore", function() {
				fTest33("MTable", this);
			});

			var fTest43 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();

					// act: set variant
					oController.setPersonalizationData(gVariantColumns);

					var fnFireAfterP13nModelDataChangeSpy = sinon.spy(oController, "fireAfterP13nModelDataChange");
					var fn_FireChangeEventSpy = sinon.spy(oController, "_fireChangeEvent");

					// act: open, wait, reset, wait, ok, wait
					oController.openDialog();
					oController._oDialog.setShowResetEnabled(true);
					oTest.clock.tick(500);
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[2].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);

					// assertions
					strictEqual(fn_FireChangeEventSpy.callCount, 1);
					strictEqual(fnFireAfterP13nModelDataChangeSpy.callCount, 1);
					deepEqual(oController.getModel().getData().persistentData, gEmptyColumns);
					deepEqual(oController._oPersistentDataRestore, gRestoreColumns);
					deepEqual(oController._oPersistentDataCurrentVariant, gVariantColumns);
					deepEqual(oController._oPersistentDataAlreadyKnown, gRestoreColumns);
					deepEqual(oController._oPersistentDataBeforeOpen, null);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("Open and RESET without VariantManagement (UITable): set variant -> openDialog -> RESET -> OK -> openDialog: back to Restore", function() {
				fTest43("UITable", this);
			});
			test("Open and RESET without VariantManagement (MTable): set variant -> openDialog -> RESET ->  OK -> openDialog: back to Restore", function() {
				fTest43("MTable", this);
			});

			var fTest51 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						resetToInitialTableState: false,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();
					var fnFireAfterP13nModelDataChangeSpy = sinon.spy(oController, "fireAfterP13nModelDataChange");
					var fn_FireChangeEventSpy = sinon.spy(oController, "_fireChangeEvent");

					// act: open, wait, user interaction, reset, ok, wait
					oController.openDialog();
					oController._oDialog.setShowResetEnabled(true);
					oTest.clock.tick(500);
					oController.getModel().setData({
						persistentData: jQuery.extend(true, {}, gVariantColumns),
						transientData: oController.getModel().getData().transientData
					});
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[2].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);

					// assertions
					strictEqual(fn_FireChangeEventSpy.callCount, 1);
					strictEqual(fnFireAfterP13nModelDataChangeSpy.callCount, 0);
					deepEqual(oController.getModel().getData().persistentData, gEmptyColumns);
					deepEqual(oController._oPersistentDataRestore, gRestoreColumns);
					deepEqual(oController._oPersistentDataCurrentVariant, {});
					deepEqual(oController._oPersistentDataAlreadyKnown, gRestoreColumns);
					deepEqual(oController._oPersistentDataBeforeOpen, null);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("Open and RESET with VariantManagement (UITable): openDialog -> change -> RESET -> OK: back to Variant", function() {
				fTest51("UITable", this);
			});
			test("Open and RESET with VariantManagement (MTable): openDialog -> change -> RESET -> OK: back to Variant", function() {
				fTest51("MTable", this);
			});

			var fTest14 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					// the first column can be sorted
					oTable.getColumns()[0].setSortProperty(gGetPath(oTable.getColumns()[0].getId()));
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						resetToInitialTableState: false,
						setting: getSettingFor([
							"columns", "sort"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();

					// act: set variant
					oController.setPersonalizationData(gVariantColumns);

					var fnFireAfterP13nModelDataChangeSpy = sinon.spy(oController, "fireAfterP13nModelDataChange");
					var fn_FireChangeEventSpy = sinon.spy(oController, "_fireChangeEvent");

					// act: open, wait, user interaction, reset, ok, wait
					oController.openDialog();
					oController._oDialog.setShowResetEnabled(true);
					oTest.clock.tick(500);
					oController.getModel().setData({
						persistentData: jQuery.extend(true, {}, gVariantSort),
						transientData: oController.getModel().getData().transientData
					});
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[2].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);

					sortByIndex(oController._oPersistentDataCurrentVariant.columns.columnsItems);

					// assertions
					strictEqual(fn_FireChangeEventSpy.callCount, 1);
					strictEqual(fnFireAfterP13nModelDataChangeSpy.callCount, 0);
					deepEqual(oController.getModel().getData().persistentData, {
						"columns": {
							"columnsItems": [{
								"columnKey": "country",
								"index": 0
							}, {
								"columnKey": "name",
								"index": 1
							}]
						},
						"sort": {
							"sortItems": []
						}
					});
					deepEqual(oController._oPersistentDataRestore, gRestoreColumnsAndEmptySort);
					deepEqual(oController._oPersistentDataCurrentVariant, gVariantColumns);
					deepEqual(oController._oPersistentDataAlreadyKnown, gRestoreAndVariantColumnsAndEmptySort);
					deepEqual(oController._oPersistentDataBeforeOpen, null);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("Open and RESET with VariantManagement (UITable): set variant -> openDialog -> change -> RESET -> OK: back to Variant", function() {
				fTest14("UITable", this);
			});
			/*test("Open and RESET with VariantManagement (MTable): set variant -> openDialog -> change -> RESET -> OK: back to Variant", function() {
				fTest14("MTable", this);
			});*/

			var fTest17 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();

					// arrange
					oController.setPersonalizationData(gVariantColumns);

					var fnFireAfterP13nModelDataChangeSpy = sinon.spy(oController, "fireAfterP13nModelDataChange");
					var fn_FireChangeEventSpy = sinon.spy(oController, "_fireChangeEvent");

					// act
					oController.resetPersonalization();

					// assertions

					// we do expect changeEvent fired although resetPersonalizationData is coming from consumer since the consumer does not know the
					// delta to what was there before and thus cannot trigger the right request
					strictEqual(fn_FireChangeEventSpy.callCount, 1);
					strictEqual(fnFireAfterP13nModelDataChangeSpy.callCount, 1);
					deepEqual(oController.getModel().getData().persistentData, gEmptyColumns);
					deepEqual(oController._oPersistentDataRestore, gRestoreColumns);
					deepEqual(oController._oPersistentDataCurrentVariant, gVariantColumns);
					deepEqual(oController._oPersistentDataAlreadyKnown, gRestoreColumns);
					deepEqual(oController._oPersistentDataBeforeOpen, null);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("resetPersonalization without VariantManagement (UITable): set variant -> resetPersonalization: back to Restore", function() {
				fTest17("UITable", this);
			});
			test("resetPersonalization without VariantManagement (MTable): set variant -> resetPersonalization: back to Restore", function() {
				fTest17("MTable", this);
			});

			var fTest16 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						resetToInitialTableState: false,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();

					// arrange
					oController.setPersonalizationData(gVariantColumns);

					var fnFireAfterP13nModelDataChangeSpy = sinon.spy(oController, "fireAfterP13nModelDataChange");
					var fn_FireChangeEventSpy = sinon.spy(oController, "_fireChangeEvent");

					// act
					oController.resetPersonalization();

					sortByIndex(oController._oPersistentDataCurrentVariant.columns.columnsItems);
					sortByIndex(oController.getModel().getData().persistentData.columns.columnsItems);

					// assertions
					strictEqual(fn_FireChangeEventSpy.callCount, 1);
					strictEqual(fnFireAfterP13nModelDataChangeSpy.callCount, 0);
					deepEqual(oController.getModel().getData().persistentData, gVariantColumns);
					deepEqual(oController._oPersistentDataRestore, gRestoreColumns);
					deepEqual(oController._oPersistentDataCurrentVariant, gVariantColumns);
					deepEqual(oController._oPersistentDataAlreadyKnown, gRestoreAndVariantColumns);
					deepEqual(oController._oPersistentDataBeforeOpen, null);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("resetPersonalization with VariantManagement (UITable): set variant -> resetPersonalization: back to variant", function() {
				fTest16("UITable", this);
			});
			test("resetPersonalization with VariantManagement (MTable): set variant -> resetPersonalization: back to variant", function() {
				fTest16("MTable", this);
			});

			var fTest27 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						resetToInitialTableState: false,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();

					// arrange
					oController.setPersonalizationData(gVariantColumns);

					var fnFireAfterP13nModelDataChangeSpy = sinon.spy(oController, "fireAfterP13nModelDataChange");
					var fn_FireChangeEventSpy = sinon.spy(oController, "_fireChangeEvent");

					// act
					oController.resetPersonalization(sap.ui.comp.personalization.ResetType.ResetFull);

					sortByIndex(oController.getModel().getData().persistentData.columns.columnsItems);

					// assertions
					strictEqual(fn_FireChangeEventSpy.callCount, 1);
					strictEqual(fnFireAfterP13nModelDataChangeSpy.callCount, 1);
					deepEqual(oController.getModel().getData().persistentData, gEmptyColumns);
					deepEqual(oController._oPersistentDataRestore, gRestoreColumns);
					deepEqual(oController._oPersistentDataCurrentVariant, gVariantColumns);
					deepEqual(oController._oPersistentDataAlreadyKnown, gRestoreColumns);
					deepEqual(oController._oPersistentDataBeforeOpen, null);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("resetPersonalization parameterized with VariantManagement (UITable): set variant -> resetPersonalization(ResetFull): back to Restore", function() {
				fTest27("UITable", this);
			});
			test("resetPersonalization parameterized with VariantManagement (MTable): set variant -> resetPersonalization(ResetFull): back to Restore", function() {
				fTest27("MTable", this);
			});

			var fTest34 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();

					// arrange: open, wait, user interaction, ok, wait
					oController.openDialog();
					oTest.clock.tick(500);
					oController.getModel().setData({
						persistentData: jQuery.extend(true, {}, gVariantColumns),
						transientData: oController.getModel().getData().transientData
					});
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);

					var fnFireAfterP13nModelDataChangeSpy = sinon.spy(oController, "fireAfterP13nModelDataChange");
					var fn_FireChangeEventSpy = sinon.spy(oController, "_fireChangeEvent");

					// act
					oController.resetPersonalization();

					// assertions
					strictEqual(fn_FireChangeEventSpy.callCount, 1);
					strictEqual(fnFireAfterP13nModelDataChangeSpy.callCount, 1);
					deepEqual(oController.getModel().getData().persistentData, gEmptyColumns);
					deepEqual(oController._oPersistentDataRestore, gRestoreColumns);
					deepEqual(oController._oPersistentDataCurrentVariant, {});
					deepEqual(oController._oPersistentDataAlreadyKnown, gRestoreColumns);
					deepEqual(oController._oPersistentDataBeforeOpen, null);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("resetPersonalization without VariantManagement (UITable): openDialog -> change -> OK -> resetPersonalization: back to Restore", function() {
				fTest34("UITable", this);
			});
			test("resetPersonalization without VariantManagement (MTable): openDialog -> change -> OK -> resetPersonalization: back to Restore", function() {
				fTest34("MTable", this);
			});

			var fTest53 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						resetToInitialTableState: false,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();

					// arrange: open, wait, user interaction, ok, wait
					oController.openDialog();
					oTest.clock.tick(500);
					oController.getModel().setData({
						persistentData: jQuery.extend(true, {}, gVariantColumns),
						transientData: oController.getModel().getData().transientData
					});

					// ok button
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);

					var fnFireAfterP13nModelDataChangeSpy = sinon.spy(oController, "fireAfterP13nModelDataChange");
					var fn_FireChangeEventSpy = sinon.spy(oController, "_fireChangeEvent");

					// act
					oController.resetPersonalization();

					// assertions
					strictEqual(fn_FireChangeEventSpy.callCount, 1);
					strictEqual(fnFireAfterP13nModelDataChangeSpy.callCount, 1);
					deepEqual(oController.getModel().getData().persistentData, gEmptyColumns);
					deepEqual(oController._oPersistentDataRestore, gRestoreColumns);
					deepEqual(oController._oPersistentDataCurrentVariant, {});
					deepEqual(oController._oPersistentDataAlreadyKnown, gRestoreColumns);
					deepEqual(oController._oPersistentDataBeforeOpen, null);

					//strictEqual(fnFireAfterP13nModelDataChangeSpy.getCall(0).args[0].changeReason, sap.ui.comp.personalization.ResetType.ResetPartial, "The after model data change event was fired with changeReason = 'ResetPartial'");
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("resetPersonalization with VariantManagement (UITable): openDialog -> change -> OK -> resetPersonalization: back to variant (= Restore)", function() {
				fTest53("UITable", this);
			});
			test("resetPersonalization with VariantManagement (MTable): openDialog -> change -> OK -> resetPersonalization: back to variant (= Restore", function() {
				fTest53("MTable", this);
			});

			var fTest35 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();

					// arrange: set variant, open, wait, user interaction, ok, wait
					oController.setPersonalizationData(gVariantColumns);
					oController.openDialog();
					oTest.clock.tick(500);
					oController.getModel().setData({
						persistentData: jQuery.extend(true, {}, gVariantBigColumns),
						transientData: oController.getModel().getData().transientData
					});
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);

					var fnFireAfterP13nModelDataChangeSpy = sinon.spy(oController, "fireAfterP13nModelDataChange");
					var fn_FireChangeEventSpy = sinon.spy(oController, "_fireChangeEvent");

					// act
					oController.resetPersonalization();

					// assertions
					strictEqual(fn_FireChangeEventSpy.callCount, 1);
					strictEqual(fnFireAfterP13nModelDataChangeSpy.callCount, 1);
					deepEqual(oController.getModel().getData().persistentData, gEmptyColumns);
					deepEqual(oController._oPersistentDataRestore, gRestoreColumns);
					deepEqual(oController._oPersistentDataCurrentVariant, gVariantColumns);
					deepEqual(oController._oPersistentDataAlreadyKnown, gRestoreColumns);
					deepEqual(oController._oPersistentDataBeforeOpen, null);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("resetPersonalization without VariantManagement (UITable): set variant -> openDialog -> change -> OK -> resetPersonalization: back to Restore", function() {
				fTest35("UITable", this);
			});
			test("resetPersonalization without VariantManagement (MTable): set variant -> openDialog -> change -> OK -> resetPersonalization: back to Restore", function() {
				fTest35("MTable", this);
			});

			var fTest36 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						resetToInitialTableState: false,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();

					// arrange: set variant, open, wait, user interaction, ok, wait
					oController.setPersonalizationData(gVariantColumns);
					oController.openDialog();
					oTest.clock.tick(500);
					oController.getModel().setData({
						persistentData: jQuery.extend(true, {}, gVariantBigColumns),
						transientData: oController.getModel().getData().transientData
					});
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);
					oController.openDialog();
					oTest.clock.tick(500);

					var fnFireAfterP13nModelDataChangeSpy = sinon.spy(oController, "fireAfterP13nModelDataChange");
					var fn_FireChangeEventSpy = sinon.spy(oController, "_fireChangeEvent");

					// act
					oController.resetPersonalization();

					sortByIndex(oController._oPersistentDataCurrentVariant.columns.columnsItems);
					sortByIndex(oController.getModel().getData().persistentData.columns.columnsItems);

					// assertions
					strictEqual(fn_FireChangeEventSpy.callCount, 1);
					strictEqual(fnFireAfterP13nModelDataChangeSpy.callCount, 1);
					deepEqual(oController.getModel().getData().persistentData, gVariantColumns);
					deepEqual(oController._oPersistentDataRestore, gRestoreColumns);
					deepEqual(oController._oPersistentDataCurrentVariant, gVariantColumns);
					deepEqual(oController._oPersistentDataAlreadyKnown, gRestoreAndVariantColumns);
					deepEqual(oController._oPersistentDataBeforeOpen, gVariantBigColumns);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("resetPersonalization with VariantManagement (UITable): set variant -> openDialog -> change -> OK -> openDialog -> resetPersonalization: back to variant", function() {
				fTest36("UITable", this);
			});
			test("resetPersonalization with VariantManagement (MTable): set variant -> openDialog -> change -> OK -> openDialog -> resetPersonalization: back to variant", function() {
				fTest36("MTable", this);
			});

			var fTest37 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();

					// act: open, wait, user interaction, ok, wait
					oController.openDialog();
					oTest.clock.tick(500);
					oController.getModel().setData({
						persistentData: jQuery.extend(true, {}, gVariantColumns),
						transientData: oController.getModel().getData().transientData
					});

					var fnFireBeforePotentialTableChangeSpy = sinon.spy(oController, "fireBeforePotentialTableChange");
					var fnFireAfterPotentialTableChangeSpy = sinon.spy(oController, "fireAfterPotentialTableChange");

					// act: OK
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);

					// assertions
					strictEqual(fnFireBeforePotentialTableChangeSpy.callCount, 1, "The beforePotentialTableChange event was fired");
					strictEqual(fnFireAfterPotentialTableChangeSpy.callCount, 1, "The afterPotentialTableChange event was fired");
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("BeforePotentialTableChange and AfterPotentialTableChange (UITable): is fired after OK", function() {
				fTest37("UITable", this);
			});
			test("BeforePotentialTableChange and AfterPotentialTableChange (MTable): is fired after OK", function() {
				fTest37("MTable", this);
			});

			var fTest38 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();

					// act: open, wait, user interaction, ok, wait
					oController.openDialog();
					oTest.clock.tick(500);
					oController.getModel().setData({
						persistentData: jQuery.extend(true, {}, gVariantColumns),
						transientData: oController.getModel().getData().transientData
					});

					var fnFireBeforePotentialTableChangeSpy = sinon.spy(oController, "fireBeforePotentialTableChange");
					var fnFireAfterPotentialTableChangeSpy = sinon.spy(oController, "fireAfterPotentialTableChange");

					// act: CANCEL
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[1].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);

					// assertions
					strictEqual(fnFireBeforePotentialTableChangeSpy.callCount, 1, "The beforePotentialTableChange event was fired (even when 'cancel' since we wish to ensure that potential changes to the table done panel or sub-controller is reverted)");
					strictEqual(fnFireAfterPotentialTableChangeSpy.callCount, 1, "The afterPotentialTableChange event was fired (even when 'cancel' since we wish to ensure that potential changes to the table done panel or sub-controller is reverted)");
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("BeforePotentialTableChange and AfterPotentialTableChange (UITable): is not fired after CANCEL", function() {
				fTest38("UITable", this);
			});
			test("BeforePotentialTableChange and AfterPotentialTableChange (MTable): is not fired after CANCEL", function() {
				fTest38("MTable", this);
			});

			var fTest40 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"sort"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();

					// act

					// open and wait
					oController.openDialog();
					oTest.clock.tick(500);

					// assertions
					equal(oController._oDialog.getPanels().length, 0);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("Show no sorting panel if no sortable column exists (UITable)", function() {
				fTest40("UITable", this);
			});
			test("Show no sorting panel if no sortable column exists (MTable)", function() {
				fTest40("MTable", this);
			});

			var fTest41 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					addSortProperty(oTable, [
						oTable.getColumns()[0]
					]);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"sort"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();

					// act

					// open and wait
					oController.openDialog();
					oTest.clock.tick(500);

					// assertions
					equal(oController._oDialog.getPanels().length, 1);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("Show sorting panel if sortable column exists (UITable)", function() {
				fTest41("UITable", this);
			});
			test("Show sorting panel if sortable column exists (MTable)", function() {
				fTest41("MTable", this);
			});

			var fTest15 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable("UITable");
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"filter"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();

					// act

					// open and wait
					oController.openDialog();
					oTest.clock.tick(500);

					// assertions
					equal(oController._oDialog.getPanels().length, 0);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("Show no filtering panel if no filterable column exists", function() {
				fTest15("UITable", this);
			});
			test("Show no filtering panel if no filterable column exists", function() {
				fTest15("MTable", this);
			});

			var fTest42 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					addFilterProperty(oTable, [
						oTable.getColumns()[0]
					]);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"filter"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();

					// act

					// open and wait
					oController.openDialog();
					oTest.clock.tick(500);

					// assertions
					equal(oController._oDialog.getPanels().length, 1);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("Show filtering panel if filterable column exists (UITable)", function() {
				fTest41("UITable", this);
			});
			test("Show filtering panel if filterable column exists (MTable)", function() {
				fTest41("MTable", this);
			});

			var fTest42 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					addSortProperty(oTable, oTable.getColumns());
					addFilterProperty(oTable, oTable.getColumns());
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"sort", "filter", "columns"
						])
					});

					// arrange

					// act

					// open and wait
					oController.openDialog();
					oTest.clock.tick(500);

					// assertions
					equal(oController._oDialog.getPanels().length, 3);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("openDialog (UITable): all panels are visible", function() {
				fTest42("UITable", this);
			});
			test("openDialog (MTable): all panels are visible", function() {
				fTest42("MTable", this);
			});

			var fTest44 = function(sTableType, oTest) {
				try {
					// system under test
					sap.ui.base.ManagedObject.extend("GroupControllerDummy",
						/** @lends GroupControllerDummy*/
						{
							metadata: {}
						});
					GroupControllerDummy.prototype.testMethod = function(oParam) {
						return {
							group: oParam.group.param
						};
					};
					sap.ui.base.ManagedObject.extend("ColumnsControllerDummy",
						/** @lends ColumnsControllerDummy*/
						{
							metadata: {}
						});
					ColumnsControllerDummy.prototype.testMethod = function(oParam) {
						return oParam.columns.param;
					};
					sap.ui.base.ManagedObject.extend("FilterControllerDummy",
						/** @lends FilterControllerDummy*/
						{
							metadata: {}
						});
					FilterControllerDummy.prototype.testMethod = function(oParam) {
						return null;
					};
					var oSetting = {
						group: {
							controller: new GroupControllerDummy(),
							visible: true
						},
						columns: {
							controller: new ColumnsControllerDummy(),
							visible: true
						},
						filter: {
							controller: new FilterControllerDummy(),
							visible: true
						}
					};

					// arrange
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: oSetting
					});
					var fnGroupMethodSpy = sinon.spy(oController.getSetting().group.controller, "testMethod");
					var fnColumnsMethodSpy = sinon.spy(oController.getSetting().columns.controller, "testMethod");
					var fnFilterMethodSpy = sinon.spy(oController.getSetting().filter.controller, "testMethod");

					// act
					var oResult = oController._callControllers(oSetting, "testMethod", {
						columns: {
							param: "A"
						},
						group: {
							param: "B"
						},
						filter: {
							param: "C"
						}
					});

					// assertions
					deepEqual(oResult.columns, "A");

					deepEqual(oResult.group, "B");

					ok(oResult.filter === null);

					deepEqual(fnColumnsMethodSpy.getCall(0).args, [{
						columns: {
							param: "A"
						}
					}]);

					deepEqual(fnGroupMethodSpy.getCall(0).args, [{
						group: {
							param: "B"
						}
					}]);

					deepEqual(fnFilterMethodSpy.getCall(0).args, [{
						filter: {
							param: "C"
						}
					}]);

				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("_callControllers (UITable)", function() {
				fTest44("UITable");
			});
			test("_callControllers (MTable)", function() {
				fTest44("MTable");
			});

			var fTest45 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						setting: getSettingFor([
							"columns"
						]),
						table: oTable
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();
					oTable.setFixedColumnCount(1);

					// act
					oController.openDialog();
					oTest.clock.tick(500);
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);

					// assertions
					strictEqual(oTable.getFixedColumnCount(), 1);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("Freeze (UITable): open dialog and OK - with columns panel", function() {
				fTest45("UITable", this);
			});

			var fTest46 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						setting: getSettingFor([
							"columns"
						]),
						table: oTable
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();
					oTable.setFixedColumnCount(1);

					// act
					oController.openDialog();
					oTest.clock.tick(500);
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[1].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);

					// assertions
					strictEqual(oTable.getFixedColumnCount(), 1);

				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("Freeze (UITable): open dialog and Cancel - with columns panel", function() {
				fTest46("UITable", this);
			});

			var fTest47 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						setting: getSettingFor([
							"columns"
						]),
						table: oTable
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();
					oTable.setFixedColumnCount(1);

					// act: open, wait, user interaction, ok, wait
					oController.openDialog();
					oTest.clock.tick(500);
					oController.getModel().setData({
						persistentData: jQuery.extend(true, {}, gVariantBigColumns),
						transientData: oController.getModel().getData().transientData
					});
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);

					// assertions
					strictEqual(oTable.getFixedColumnCount(), 0);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("Freeze (UITable): move selected item out of frozen zone", function() {
				fTest47("UITable", this);
			});

			var fTest48 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						setting: getSettingFor([
							"columns"
						]),
						table: oTable
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();
					oTable.setFixedColumnCount(1);

					// act: open, wait, user interaction, ok, wait
					oController.openDialog();
					oTest.clock.tick(500);
					oController.getModel().setData({
						persistentData: {
							columns: {
								columnsItems: [{
									"columnKey": "name",
									"index": 0
								}, {
									"columnKey": "city",
									"index": 1
								}, {
									"columnKey": "country",
									"index": 2
								}]
							}
						},
						transientData: oController.getModel().getData().transientData
					});
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);

					// assertions
					strictEqual(oTable.getFixedColumnCount(), 1);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("Freeze (UITable): move selected item outsite of frozen zone", function() {
				fTest48("UITable", this);
			});

			var fTest49 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					addSortProperty(oTable, [
						oTable.getColumns()[0]
					]);
					var oController = new sap.ui.comp.personalization.Controller({
						setting: getSettingFor([
							"sort"
						]),
						table: oTable
					});
					var oUserInteraction = {
						sort: {
							sortItems: [{
								"columnKey": "name",
								"operation": "Ascending"
							}, {
								"columnKey": "country",
								"operation": "Ascending"
							}]
						}
					};

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();

					// act
					oController.openDialog();
					oTest.clock.tick(500);

					// simulate user interaction
					oController.getModel().setData({
						persistentData: oUserInteraction,
						transientData: oController.getModel().getData().transientData
					});
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);
					var aSortedColumns = [];
					oTable.getColumns().forEach(function(oColumn) {
						if (oColumn.getSorted()) {
							aSortedColumns.push(oColumn);
						}
					});
					// assertions
					deepEqual(aSortedColumns.length, 2);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("SortController (UITable): add second new sort condition", function() {
				fTest49("UITable", this);
			});

			var fTest50 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					addFilterProperty(oTable, [
						oTable.getColumns()[0]
					]);
					var oController = new sap.ui.comp.personalization.Controller({
						setting: getSettingFor([
							"filter"
						]),
						table: oTable
					});
					var oUserInteraction = {
						filter: {
							filterItems: [{
								columnKey: "name",
								operation: "BT",
								exclude: false,
								value1: "A",
								value2: "C"
							}, {
								columnKey: "country",
								operation: "BT",
								exclude: false,
								value1: "A",
								value2: "C"
							}]
						}
					};

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();

					// act
					oController.openDialog();
					oTest.clock.tick(500);

					// simulate user interaction
					oController.getModel().setData({
						persistentData: oUserInteraction,
						transientData: oController.getModel().getData().transientData
					});
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);
					var aFilteredColumns = [];
					oTable.getColumns().forEach(function(oColumn) {
						if (oColumn.getFiltered()) {
							aFilteredColumns.push(oColumn);
						}
					});
					// assertions
					deepEqual(aFilteredColumns.length, 2);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("FilterController (UITable): add second new filter condition", function() {
				fTest50("UITable", this);
			});

			// Reset:
			// 2.5. Table mit sort1 -> setPersonalizationData mit sort2 -> sort1 lschen -> reset : sort2 === variant === model.data
			// 2.6. Table mit sort1 -> setPersonalizationData mit sort2 -> sort2 lschen -> reset : sort2 === variant === model.data
			// 3. fr sort und filter ebenfalls
			var fTest28 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();

					var fnFireAfterP13nModelDataChangeSpy = sinon.spy(oController, "fireAfterP13nModelDataChange");

					// Open and wait
					oController.openDialog();
					oTest.clock.tick(500);

					// Change
					oController.getModel().getData().persistentData.columns = {
						columnsItems: [{
							columnKey: "name",
							visible: false
						}]
					};

					// "ok" and wait
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);

					// act
					/* RestorePersistentData:
						{
							columnKey: "name"
							index: 0
							visible: true
							width: ""
						},{
							columnKey: "country"
							index: 1
							visible: true
							width: ""
						},{
							columnKey: "city"
							index: 2
							visible: true
							width: ""
						}*/
					deepEqual(oController._oPersistentDataAlreadyKnown, {
						columns: {
							columnsItems: [{
								columnKey: "name",
								index: 0,
								visible: false,
								width: ""
							}, {
								columnKey: "country",
								index: 1,
								visible: true,
								width: ""
							}, {
								columnKey: "city",
								index: 2,
								visible: true,
								width: ""
							}]
						}
					});

					oController.resetPersonalization();

					// assertions
					strictEqual(fnFireAfterP13nModelDataChangeSpy.callCount, 2, "The after model data reset event was fired");
					strictEqual(fnFireAfterP13nModelDataChangeSpy.getCall(1).args[0].changeReason, sap.ui.comp.personalization.ResetType.ResetFull, "The after model data change event was fired with changeReason = 'ResetFull'");
					deepEqual(oController._oPersistentDataAlreadyKnown, {
						columns: {
							columnsItems: [{
								columnKey: "name",
								index: 0,
								visible: true,
								width: ""
							}, {
								columnKey: "country",
								index: 1,
								visible: true,
								width: ""
							}, {
								columnKey: "city",
								index: 2,
								visible: true,
								width: ""
							}]
						}
					});
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("Controller (UITable): lifecycle of '_oPersistentDataAlreadyKnown' - after reset", function() {
				fTest28("UITable", this);
			});
			test("Controller (MTable): lifecycle of '_oPersistentDataAlreadyKnown' - after reset", function() {
				fTest28("MTable", this);
			});

			var fTest25 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					addSortProperty(oTable, oTable.getColumns());
					addFilterProperty(oTable, oTable.getColumns());
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"sort", "filter", "columns"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();
					var fn_getSettingOfPanelsSpy = sinon.spy(oController, "_getSettingOfPanels");
					var fnSortMethodSpy = sinon.spy(oController._oSettingCurrent.sort.controller, "onAfterSubmit");
					var fnFilterMethodSpy = sinon.spy(oController._oSettingCurrent.filter.controller, "onAfterSubmit");
					var fnColumnsMethodSpy = sinon.spy(oController._oSettingCurrent.columns.controller, "onAfterSubmit");

					// act: open, OK
					oController.openDialog();
					oTest.clock.tick(500);
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);

					// assertions
					//20150602				strictEqual(fn_getSettingOfPanelsSpy.callCount, 2);
					strictEqual(fnSortMethodSpy.callCount, 1);
					strictEqual(fnFilterMethodSpy.callCount, 1);
					strictEqual(fnColumnsMethodSpy.callCount, 1);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("_getSettingOfPanels (UITable): with 3 available of 3 existing panels", function() {
				fTest25("UITable", this);
			});
			test("_getSettingOfPanels (MTable): with 3 available of 3 existing panels", function() {
				fTest25("MTable", this);
			});

			var fTest26 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType);
					addSortProperty(oTable, oTable.getColumns());
					addFilterProperty(oTable, oTable.getColumns());
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"sort", "filter", "columns"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();
					var fn_getSettingOfPanelsSpy = sinon.spy(oController, "_getSettingOfPanels");
					var fnSortMethodSpy = sinon.spy(oController._oSettingCurrent.sort.controller, "onAfterSubmit");
					var fnFilterMethodSpy = sinon.spy(oController._oSettingCurrent.filter.controller, "onAfterSubmit");
					var fnColumnsMethodSpy = sinon.spy(oController._oSettingCurrent.columns.controller, "onAfterSubmit");

					// act: open, OK
					oController.openDialog({
						sort: {
							visible: true
						}
					});
					oTest.clock.tick(500);
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);

					// assertions
					//20150602				strictEqual(fn_getSettingOfPanelsSpy.callCount, 2);
					strictEqual(fnSortMethodSpy.callCount, 1);
					strictEqual(fnFilterMethodSpy.callCount, 0);
					strictEqual(fnColumnsMethodSpy.callCount, 0);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("_getSettingOfPanels (UITable): with 1 available of 3 existing panels", function() {
				fTest26("UITable", this);
			});
			test("_getSettingOfPanels (MTable): with 1 available of 3 existing panels", function() {
				fTest26("MTable", this);
			});

			var fTest61 = function(sTableType, oTest) {
				try {
					// system under test
					var oController;

					// arrange
					var oTable = createTable(sTableType);
					var oColumn = oTable.getColumns()[1];
					var oSetting = getSettingWithIgnoredColumnFor(oColumn, [
						"sort", "filter", "columns"
					]);

					// act: first table, then setting
					var bException = false;
					try {
						oColumn.setVisible(false);
						oController = new sap.ui.comp.personalization.Controller({
							table: oTable,
							setting: oSetting
						});
					} catch (e) {
						bException = true;
					}

					// assertions
					ok(!bException);
					ok(oController);

					// act: first setting, then table
					bException = false;
					try {
						oController = new sap.ui.comp.personalization.Controller({
							setting: oSetting,
							table: oTable
						});
					} catch (e) {
						bException = true;
					}

					// assertions
					ok(!bException);
					ok(oController);

				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("_checkIgnoredColumnKeys (UITable): positive test", function() {
				fTest61("UITable", this);
			});
			test("_checkIgnoredColumnKeys (MTable): positive test", function() {
				fTest61("MTable", this);
			});

			var fTest62 = function(sTableType, oTest) {
				try {
					// system under test
					var oController;

					// arrange
					var oTable = createTable(sTableType);
					var oColumn = oTable.getColumns()[1];
					var oSetting = getSettingWithIgnoredColumnFor(oColumn, [
						"sort", "filter", "columns"
					]);

					// act: first table, then setting
					var bException = false;
					try {
						oColumn.setVisible(true);
						oController = new sap.ui.comp.personalization.Controller({
							table: oTable,
							setting: oSetting
						});
					} catch (e) {
						bException = true;
					}

					// assertions
					ok(bException);
					ok(!oController);

					// act: first setting, then table
					bException = false;
					try {
						oController = new sap.ui.comp.personalization.Controller({
							setting: oSetting,
							table: oTable,
						});
					} catch (e) {
						bException = true;
					}

					// assertions
					ok(bException);
					ok(!oController);
				} finally {
					// cleanup
					oTable.destroy();
					//oController.destroy();
				}
			};
			test("_checkIgnoredColumnKeys (UITable): negative test", function() {
				fTest62("UITable", this);
			});
			test("_checkIgnoredColumnKeys (MTable): negative test", function() {
				fTest62("MTable", this);
			});

			var fTest63 = function(sTableType, oTest) {
				try {
					// system under test
					var oController;

					// arrange
					var oTable = createTable(sTableType);
					var oColumn = oTable.getColumns()[1];

					oColumn.setVisible(false);
					oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingWithIgnoredColumnFor(oColumn, [
							"sort", "filter", "columns"
						])
					});

					// act
					var bException = false;
					try {
						oColumn.setVisible(true);
					} catch (e) {
						bException = true;
					}

					// assertions
					ok(bException);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("_checkIgnoredColumnKeys (UITable): set column visible via API", function() {
				fTest63("UITable", this);
			});
			test("_checkIgnoredColumnKeys (MTable): set column visible via API", function() {
				fTest63("MTable", this);
			});

			test("_mergeSettingCurrentBy", function() {
				try {
					// system under test
					var oController;

					// arrange
					var oTable = createTable("MTable");

					// act
					oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: {
							sort: {
								visible: false
							}
						}
					});

					// assertions
					deepEqual(Object.keys(oController._oSettingCurrent), [
						"columns", "filter", "group"
					]);

					// act
					oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: {
							group: {
								visible: true
							},
							sort: {
								visible: false
							}
						}
					});

					// assertions
					deepEqual(Object.keys(oController._oSettingCurrent), [
						"columns", "filter", "group"
					]);

					// act
					oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: {
							custom: {
								visible: true
							},
							columns: {
								visible: false
							},
							group: {
								visible: true
							},
							filter: {
								visible: false
							}
						}
					});

					// assertions
					deepEqual(Object.keys(oController._oSettingCurrent), [
						"sort", "group", "custom"
					]);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			});

			test("_mergeSettingCurrentBy", function() {
				try {
					// system under test
					var oController;

					// arrange
					var oTable = createTable("UITable");

					// act
					oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: {
							sort: {
								visible: false
							}
						}
					});

					// assertions
					deepEqual(Object.keys(oController._oSettingCurrent), [
						"columns", "filter"
					]);

					// act
					oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: {
							group: {
								visible: true
							},
							sort: {
								visible: false
							}
						}
					});

					// assertions
					deepEqual(Object.keys(oController._oSettingCurrent), [
						"columns", "filter"
					]);

					// act
					oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: {
							custom: {
								visible: true
							},
							columns: {
								visible: false
							},
							group: {
								visible: true
							},
							filter: {
								visible: false
							}
						}
					});

					// assertions
					deepEqual(Object.keys(oController._oSettingCurrent), [
						"sort", "custom"
					]);
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			});

			var fTest68 = function(sTableType, oTest) {
				try {
					// system under test
					var oTable = createTable(sTableType, {
						items: [{
							"date": "2/5/1982",
							"number": 103,
							"city": "McDermotttown",
							"country": "Svalbard and Jan Mayen",
							"name": "Mary"
						}],
						columns: [{
							id: "name",
							text: "Name",
							path: "name"
						}, {
							id: "country",
							text: "Country",
							path: "country"
						}, {
							id: "city",
							text: "City",
							path: "city"
						}, {
							id: "date",
							text: "Date",
							path: "date"
						}]
					});
					var oController = new sap.ui.comp.personalization.Controller({
						table: oTable,
						setting: getSettingFor([
							"columns", "filter"
						])
					});

					// arrange
					oTable.placeAt("content");
					sap.ui.getCore().applyChanges();

					// open and simulate user interation, OK
					oController.openDialog();
					oTest.clock.tick(500);
					oController.getModel().setData({
						persistentData: jQuery.extend(true, {}, {
							columns: {
								columnsItems: [{
									columnKey: "country",
									index: 0
								}, {
									columnKey: "name",
									index: 1
								}]
							},
							filter: {
								filterItems: [{
									columnKey: "date",
									exclude: false,
									operation: "LT",
									value1: "Fri May 06 2016 00:00:00 GMT+0200 (W. Europe Daylight Time)",
									value2: ""
								}]
							}
						}),
						transientData: oController.getModel().getData().transientData
					});
					sap.ui.test.qunit.triggerTouchEvent("tap", oController._oDialog.getButtons()[0].getFocusDomRef(), {
						srcControl: oController._oDialog
					});
					oTest.clock.tick(500);
					var fnFireAfterP13nModelDataChangeSpy = sinon.spy(oController, "fireAfterP13nModelDataChange");
					var oEventStub = sinon.stub();
					oEventStub.getParameter = sinon.stub().withArgs("column").returns(oTable.getColumns()[3]);

					// act
					oController._oSettingCurrent.columns.controller._onColumnResize(oEventStub);

					// assertions
					ok(fnFireAfterP13nModelDataChangeSpy.calledOnce);
					strictEqual(fnFireAfterP13nModelDataChangeSpy.getCall(0).args[0].changeType.filter, "Unchanged");
				} finally {
					// cleanup
					oTable.destroy();
					oController.destroy();
				}
			};
			test("BCP 1670037841 _oPersistentDataAlreadyKnown (UITable): openDialog -> change -> OK -> resize column", function() {
				fTest68("UITable", this);
			});
		}());
	</script>
</head>

<body id="body" class="sapUiBody">
	<h1 id="qunit-header">qUnit Page for
		sap.ui.comp.personalization.Controller</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>

	<div id="content"></div>
</body>

</html>
