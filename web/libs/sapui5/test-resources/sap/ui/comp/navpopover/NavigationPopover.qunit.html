<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>qUnit Page for sap.ui.comp.navpopover.NavigationPopover</title>

<script id="sap-ui-bootstrap" type="text/javascript"
	src="../../../../../resources/sap-ui-core.js"
	data-sap-ui-theme="sap_bluecrystal" data-sap-ui-noConflict="true"
	data-sap-ui-libs="sap.ui.comp"
	data-sap-ui-resourceroots='{
				"test.sap.ui.comp.navpopover": "./"
			}'>
	
</script>

<link rel="stylesheet"
	href="../../../../../resources/sap/ui/thirdparty/qunit.css"
	type="text/css" media="screen" />
<script type="text/javascript"
	src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script type="text/javascript"
	src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script type="text/javascript"
	src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
<script type="text/javascript"
	src="../../../../../resources/sap/ui/thirdparty/sinon.js"></script>

<script language="javascript">

	if(!(sap.ui.Device.browser.internet_explorer && sap.ui.Device.browser.version <= 8)) {
		jQuery.sap.require("sap.ui.qunit.qunit-coverage");
	} 		
	
	(function() {
		jQuery.sap.require("test.sap.ui.comp.navpopover.Util");
		jQuery.sap.require("sap.ui.core.Control");
		jQuery.sap.require("sap.ui.comp.navpopover.LinkData");
		jQuery.sap.require("sap.ui.comp.navpopover.NavigationPopover");

		function fakeResolved(value) {
			return {
				done: function(callback) {
					callback(value);
				},
				fail: function(callback) {
					callback(value);
				}
			}
		}
		;

		function fakeUShell(aActions, sHrefForExternal, fParseShellHashCallback) {
			var stub = sinon.stub(sap.ui.comp.navpopover.Factory, "getService");
			stub.withArgs("CrossApplicationNavigation").returns({
				getSemanticObjectLinks: function() {
					return (fakeResolved(aActions));
				},
				hrefForExternal: function() {
					return sHrefForExternal;
				}
			});
			stub.withArgs("URLParsing").returns({
				parseShellHash: fParseShellHashCallback
			});
		}
		;

		module("sap.ui.comp.navpopover.NavigationPopover", {
			setup: function() {
			},
			teardown: function() {
			}
		});

		test("constructor", function() {
			ok(new sap.ui.comp.navpopover.NavigationPopover());
		});

		test("retrieveNavTargets", function() {
			// system under test
			var oPopover = new sap.ui.comp.navpopover.NavigationPopover({
				semanticObjectName: "HUGO"
			});

			// arrange
			fakeUShell([
				{
					intent: "HREF1",
					text: "Link1"
				}, {
					intent: "HREF2",
					text: "Link2"
				}
			], "#Customer-manageLineItems", function() {
				return {};
			});
			var fnFireTargetsObtainedSpy = sinon.spy(oPopover, "fireTargetsObtained");

			// act
			oPopover.retrieveNavTargets();

			// assertions
			strictEqual(fnFireTargetsObtainedSpy.callCount, 1);
			equal(oPopover.getAvailableActions().length, 2);

			equal(oPopover.getAvailableActions()[0].getText(), "Link1");
			equal(oPopover.getAvailableActions()[0].getHref(), "HREF1");

			equal(oPopover.getAvailableActions()[1].getText(), "Link2");
			equal(oPopover.getAvailableActions()[1].getHref(), "HREF2");

			// cleanup
			oPopover.destroy();
			sap.ui.comp.navpopover.Factory.getService.restore();
		});

		test("retrieveNavTargets - factsheet action", function() {
			// system under test
			var oPopover = new sap.ui.comp.navpopover.NavigationPopover({
				semanticObjectName: "HUGO",
				source: new sap.ui.comp.navpopover.SmartLink()
			});

			// arrange
			fakeUShell([
				{
					intent: "FACTSHEET",
					text: "MainLink1"
				}
			], "#Customer-manageLineItems?test=123", function(id) {
				return id === "FACTSHEET" ? {
					action: "displayFactSheet"
				} : {};
			});

			// act
			oPopover.retrieveNavTargets();

			// assertions
			equal(oPopover.getMainNavigation().getText(), sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("POPOVER_FACTSHEET"));
			equal(oPopover.getMainNavigation().getHref(), "FACTSHEET");

			// cleanup
			oPopover.destroy();
			sap.ui.comp.navpopover.Factory.getService.restore();
		});

		test("retrieveNavTargets - without factsheet", function() {
			// system under test
			var oPopover = new sap.ui.comp.navpopover.NavigationPopover({
				semanticObjectName: "HUGO",
				source: new sap.ui.comp.navpopover.SmartLink()
			});

			// arrange
			sinon.stub(oPopover, "openBy");
			fakeUShell([
				{
					intent: "HREF1",
					text: "Link1"
				}, {
					intent: "HREF2",
					text: "Link2"
				}
			], "#Customer-manageLineItems", function(id) {
				return {};
			});
			oPopover.attachTargetsObtained(function(oEvent) {
				var oPopoverSource = oEvent.getSource();
				oPopoverSource.setMainNavigation(new sap.ui.comp.navpopover.LinkData({
					text: "MainNav1",
					href: undefined
				}));
				oPopoverSource.show();
			});

			// act
			oPopover.retrieveNavTargets();

			// assertions
			ok(oPopover.openBy.called);
			equal(oPopover.getMainNavigation().getText(), "MainNav1");
			equal(oPopover._oMainNavigationLink.getVisible(), false, "MainNavigation Link should be invisible");

			// cleanup
			oPopover.destroy();
			sap.ui.comp.navpopover.Factory.getService.restore();
		});

		test("retrieveNavTargets - modified action", function() {
			// system under test
			var oPopover = new sap.ui.comp.navpopover.NavigationPopover({
				semanticObjectName: "HUGO",
				source: new sap.ui.comp.navpopover.SmartLink()
			});

			// arrange
			fakeUShell([
				{
					intent: "HREF1",
					text: "Link1"
				}, {
					intent: "HREF2",
					text: "Link2"
				}, {
					intent: "#Customer-manageLineItems?test=123&navigation=TOBEIGNORED",
					text: "This Link belongs to the same application and should not be displayed"
				}
			], "#Customer-manageLineItems?test=123", function(id) {
				return id === "FACTSHEET" ? {
					action: "displayFactSheet"
				} : {};
			});
			oPopover.attachTargetsObtained(function(oEvent) {
				var oPopoverSource = oEvent.getSource();
				var oAction = oPopoverSource.getAvailableActions()[0];
				oAction.setHref("MODIFIED_HREF");
			});

			// act
			oPopover.retrieveNavTargets();

			// assertions
			equal(oPopover.getAvailableActions().length, 2);
			equal(oPopover.getAvailableActions()[0].getHref(), "MODIFIED_HREF");
			equal(oPopover.getAvailableActions()[0].getText(), "Link1");
			equal(oPopover.getAvailableActions()[1].getHref(), "HREF2");
			equal(oPopover.getAvailableActions()[1].getText(), "Link2");

			// cleanup
			oPopover.destroy();
			sap.ui.comp.navpopover.Factory.getService.restore();
		});

		test("show", function() {
			// system under test
			var oPopover = new sap.ui.comp.navpopover.NavigationPopover({
				source: new sap.ui.comp.navpopover.SmartLink(),
				mainNavigation: new sap.ui.comp.navpopover.LinkData({
					text: "Main",
					href: "href1"
				})
			});

			// arrange
			sinon.stub(oPopover, "openBy");

			// act
			oPopover.show();

			// assertions
			ok(oPopover.openBy.called);

			// cleanup
			oPopover.destroy();
		});

		test("show - with actions", function() {
			// system under test
			var oPopover = new sap.ui.comp.navpopover.NavigationPopover({
				availableActions: [
					new sap.ui.comp.navpopover.LinkData({
						text: "Link1",
						href: "href1"
					}), new sap.ui.comp.navpopover.LinkData({
						text: "Link2",
						href: "href2"
					})
				],
				source: new sap.ui.comp.navpopover.SmartLink()
			});

			// arrange
			sinon.stub(oPopover, "openBy");

			// act
			oPopover.show();

			// assertions
			ok(oPopover.openBy.called);
			equal(oPopover._oNavigationLinkContainer.getItems().length, 2);
			equal(oPopover._oNavigationLinkContainer.getItems()[0].getText(), "Link1");
			equal(oPopover._oNavigationLinkContainer.getItems()[0].getHref(), "href1");
			equal(oPopover._oNavigationLinkContainer.getItems()[1].getText(), "Link2");
			equal(oPopover._oNavigationLinkContainer.getItems()[1].getHref(), "href2");

			// cleanup
			oPopover.destroy();
		});

		test("setExtraContent", function() {
			// system under test
			var oPopover = new sap.ui.comp.navpopover.NavigationPopover();

			// arrange

			// act
			var oText1 = new sap.m.Text();
			oPopover.setExtraContent(oText1);

			// assertions
			deepEqual(oPopover.getExtraContent(), oText1.getId());
			equal(oPopover.getContent().length, 3);
			equal(oPopover.getContent()[1], oText1);

			// act
			oPopover.setExtraContent(oText1);

			// assertions
			deepEqual(oPopover.getExtraContent(), oText1.getId());
			equal(oPopover.getContent().length, 3, "Content should not change if same control was added twice");
			equal(oPopover.getContent()[1], oText1);

			// act
			var oText2 = new sap.m.Text();
			oPopover.setExtraContent(oText2);

			// assertions
			equal(oPopover.getExtraContent(), oText2.getId(), "Association has to be filled correctly");
			equal(oPopover.getContent().length, 3);
			equal(oPopover.getContent()[1], oText2, "Control has to be in the content aggregation");
			ok(!oText1.getParent(), "Control should have been removed after new control has been set");
		});

		test("getDirectLink with main link", function(qUnit) {
			// system under test
			var oPopover = new sap.ui.comp.navpopover.NavigationPopover({
				mainNavigation: new sap.ui.comp.navpopover.LinkData({
					href: "href",
					text: "link"
				})
			});

			// arrange

			// act

			// assertions
			ok(oPopover.getDirectLink());

			// cleanup
			oPopover.destroy();
		});

		test("getDirectLink with action", function(qUnit) {
			// system under test
			var oPopover = new sap.ui.comp.navpopover.NavigationPopover({
				availableActions: [
					new sap.ui.comp.navpopover.LinkData({
						href: "href",
						text: "link"
					})
				]
			});

			// arrange

			// act

			// assertions
			ok(oPopover.getDirectLink());

			// cleanup
			test.sap.ui.comp.navpopover.Util.unMockUShellServices();
			oPopover.destroy();
		});

	}());
</script>
</head>
<body id="body" class="sapUiBody">
	<h1 id="qunit-header">qUnit Page for qUnit Page for
		sap.ui.comp.navpopover.NavigationPopover</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>

	<div id="content"></div>
</body>
</html>