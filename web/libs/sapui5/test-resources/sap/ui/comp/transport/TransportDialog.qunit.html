<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<title>qUnit Page for sap.ui.comp.transport.TransportDialog</title>

		<script id="sap-ui-bootstrap" 
			type="text/javascript"
			src="../../../../../resources/sap-ui-core.js"
			data-sap-ui-theme="sap_bluecrystal"
			data-sap-ui-noConflict="true"
			data-sap-ui-libs="sap.ui.comp">
		</script>

		<link rel="stylesheet" href="../../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen" />
		<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
		<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
		<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
		<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
		<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>

		<script type="text/javascript">
			
		(function() {

			jQuery.sap.require("sap.ui.comp.transport.TransportDialog");
			
			module("sap.ui.comp.transport.TransportDialog", {
				setup: function() {
					this.oDialog = new sap.ui.comp.transport.TransportDialog();					
				},
				teardown: function() {
				}
			});
							

			test("Shall be instantiable", function() {
				ok(this.oDialog);
			});
			
			test("setPackage", function() {
				this.oDialog.setPkg("$TMP");
				equal(this.oDialog.getProperty("pkg"), "$TMP");
			});
			
			test("setLrepObject", function() {
				this.oDialog.setLrepObject({ "type":"variant","name":"id_1414740501651_318","namespace":"" });
				equal(this.oDialog.getProperty("lrepObject").name, "id_1414740501651_318");
			});
			
			test("setHidePackage", function() {
				this.oDialog.setHidePackage(true);
				equal(this.oDialog.getProperty("hidePackage"), true);
			});
			
			test("setTransports", function() {
				var aTransports = [
					{
						transportId : "T1",
						description : "Transport 1"
					},				
					{
						transportId : "T2",
						description : "Transport 2"
					},
					{
						transportId : "T3",
						description : "Transport 3"
					},
					{
						transportId : "T4",
						description : "Transport 4"
					},
					{
						transportId : "T5",
						description : "Transport 5"
					}			
				];
			
				this.oDialog.setTransports(aTransports);
				equal(this.oDialog.getProperty("transports").length, 5);
				equal(this.oDialog._oTransport.getEnabled(), true);
			});
			
			test("_onPackageChangeError", function() {
				this.oDialog._onPackageChangeError({});
				equal(this.oDialog.getProperty("transports").length, 0);
			});
			
			test("_onPackageChangeSuccess - localonly flag", function() {
				this.oDialog._onPackageChangeSuccess({ localonly : true});
				equal(this.oDialog._oTransport.getEnabled(), false);
			});
			
			test("_onPackageChangeSuccess - locked flag", function() {
				var oTransports = {
					transports : [
						{
							locked : true
						}
					]
				};
				
				sinon.spy(this.oDialog, "_hasLock");
				this.oDialog._onPackageChangeSuccess(oTransports);
				equal(this.oDialog._oTransport.getEnabled(), true);
				ok(this.oDialog._hasLock.calledOnce);
			});
			
			test("_onPackageChangeSuccess - error code", function() {
				this.oDialog._onPackageChangeSuccess({ 
					errorCode : "INVALID_PACKAGE",
					transports : []
				});
				equal(this.oDialog.getButtons()[1].getEnabled(), false);
				equal(this.oDialog._oPackage.getValueState(), sap.ui.core.ValueState.Error);
			});
			
			test("okay callback not invoked", function() {
				//no package, no hide package, no transport.
				var bPressed = false;
				var fPressed = function() {
					bPressed = true;
				};
				var aButtons = this.oDialog.getButtons();
				this.oDialog.attachOk(fPressed);
				aButtons[1].firePress();
				equal(bPressed, false);
			});
			
			test("okay callback invoked", function() {
				//hide package set.
				var bPressed = false;
				var fPressed = function() {
					bPressed = true;
				};
				var aButtons = this.oDialog.getButtons();
				this.oDialog.attachOk(fPressed);
				aButtons[1].firePress();
				equal(bPressed, false);
			});

			test("_onOkay", function() {
				var bPressed = false;
				var fPressed = function() {
					bPressed = true;
				};
				//this.oDialog._oLocal.bLocal = true;
				this.oDialog.attachOk(fPressed);
				this.oDialog._onOkay();
				equal(bPressed, false);
			});
			
			test("cancel callback invoked", function() {
				var bPressed = false;
				var fPressed = function() {
					bPressed = true;
				};
				var aButtons = this.oDialog.getButtons();
				this.oDialog.attachCancel(fPressed);
				aButtons[2].firePress();
				equal(bPressed, true);
			});

			test("_createObjectInfo", function() {
				this.oDialog.setProperty("lrepObject", {
					"type" : "variant",
					"name" : "id_1414740501651_318",
					"namespace" : "test_name_space"
				});
				var oInfo = this.oDialog._createObjectInfo()
				
				equal(oInfo.name, "id_1414740501651_318");
				equal(oInfo.namespace, "test_name_space");
				equal(oInfo.type, "variant");
			});
			
			test("local object button-pressed event", function() {
				var sPackage, sTransport;
				this.oDialog.attachOk(function(oParam) {
					sPackage = oParam.mParameters.selectedPackage;
					sTransport = oParam.mParameters.selectedTransport;
				});
				this.oDialog.getButtons()[0].firePress();
				
				equal(sPackage, "$TMP");
				equal(sTransport, "");
			});
			
			test("_onLocal", function() {
				var sPackage, sTransport;
				this.oDialog.attachOk(function(oParam) {
					sPackage = oParam.mParameters.selectedPackage;
					sTransport = oParam.mParameters.selectedTransport;
				});
				this.oDialog._onLocal();
				
				equal(sPackage, "$TMP");
				equal(sTransport, "");
			});
		
			test("_checkOkay returns false", function() {
				this.oDialog._checkOkay();
				equal(this.oDialog._checkOkay(), false);
			});
			
			test("_checkOkay returns true", function() {
				this.oDialog._checkOkay();
				equal(this.oDialog._checkOkay("1234"), true);
			});
			
			test("_checkOkay returns false, if hidePackage is set", function() {
				this.oDialog.setHidePackage(true);
				equal(this.oDialog._checkOkay(), false);
			});
		
			test("_setTransports", function() {
				var aTransports = [
					{
						transportId : "T1",
						description : "Transport 1"
					},				
					{
						transportId : "T2",
						description : "Transport 2"
					},
					{
						transportId : "T3",
						description : "Transport 3"
					},
					{
						transportId : "T4",
						description : "Transport 4"
					},
					{
						transportId : "T5",
						description : "Transport 5"
					}			
				];
			
				this.oDialog._setTransports({
					transports :aTransports
				});
				equal(this.oDialog.getProperty("transports").length, 5);
				equal(this.oDialog._oTransport.getEnabled(), true);
				equal(!this.oDialog._oTransport.getSelectedKey(), true);
			});
			
			test("_setTransports - empty transports", function() {
				this.oDialog._setTransports({
					transports : []
				});
				equal(this.oDialog.getProperty("transports").length, 0);
				equal(this.oDialog._oTransport.getEnabled(), false);
				equal(!this.oDialog._oTransport.getSelectedKey(), true);
			});
			
			test("_setTransports - one transport", function() {
				var aTransports = [
					{
						transportId : "T1",
						description : "Transport 1"
					}			
				];
			
				this.oDialog._setTransports({
					transports :aTransports
				});
				equal(this.oDialog.getProperty("transports").length, 1);
				equal(this.oDialog._oTransport.getEnabled(), true);
				equal(this.oDialog._oTransport.getSelectedKey(), "T1");
			});
			
			test("_oTransport - selectionChange event - changing nothing", function() {
				this.oDialog._oTransport.fireSelectionChange();
				equal(this.oDialog.getButtons()[1].getEnabled(), false);
			});
			
			test("_oTransport - selectionChange event - enabling okay button", function() {
				this.oDialog._oPackage.setValue("abc123");
				this.oDialog._oTransport.fireSelectionChange();
				equal(this.oDialog.getButtons()[1].getEnabled(), true);
			});
			
			test("_oTransport - change event disabling okay button", function() {
				this.oDialog.getButtons()[1].setEnabled(true);
				this.oDialog._oTransport.fireChange({
					newValue : "T1"
				});
				equal(this.oDialog.getButtons()[1].getEnabled(), false);
			});
			
			test("_oTransport - change event disabling okay button", function() {
				var aTransports = [
					{
						transportId : "T1",
						description : "Transport 1"
					}			
				];
							
				this.oDialog._setTransports({
					transports :aTransports
				});
								
				this.oDialog.getButtons()[1].setEnabled(true);
				this.oDialog._oTransport.fireChange({
					newValue : "T1"
				});
				equal(this.oDialog.getButtons()[1].getEnabled(), false);
			});
			
			test("_oTransport - change event causing no change", function() {
				var aTransports = [
					{
						transportId : "T1",
						description : "Transport 1"
					}			
				];
							
				this.oDialog._setTransports({
					transports :aTransports
				});
								
				this.oDialog.getButtons()[1].setEnabled(true);
				this.oDialog._oTransport.fireChange({
					newValue : "Transport 1"
				});
				equal(this.oDialog.getButtons()[1].getEnabled(), true);
			});
			
			test("_oPackage - liveChange - changing transport button", function() {
				equal(this.oDialog._oTransport.getEnabled(), false);
				this.oDialog._oPackage.fireLiveChange({ liveValue : "live" });
				equal(this.oDialog._oTransport.getEnabled(), true);
			});
			
			test("_oPackage - liveChange - changing nothing", function() {
				equal(this.oDialog._oTransport.getEnabled(), false);
				this.oDialog._oPackage.fireLiveChange();
				equal(this.oDialog._oTransport.getEnabled(), false);
			});
			
			test("_oPackage - change event executing promise ", function() {
				sap.ui.fl.Transports = function() {
					return {
						getTransports : function() {
							return {
								then : function(fSuccess, fFailure) {
									ok("promise executed");
								}
							}
						}
					}
				};
				this.oDialog._oPackage.fireChange();
			});
			
		}());
		</script>
	</head>
	<body id="body" class="sapUiBody">
		<h1 id="qunit-header">qUnit Page for qUnit Page for sap.ui.comp.transport.TransportDialog</h1>
		<h2 id="qunit-banner"></h2>
		<h2 id="qunit-userAgent"></h2>
		<ol id="qunit-tests"></ol>
	</body>
</html>