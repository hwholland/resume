<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>qUnit Page for sap.ui.comp.smarttable.SmartTable</title>

<script id="sap-ui-bootstrap" type="text/javascript"
	src="../../../../../resources/sap-ui-core.js"
	data-sap-ui-theme="sap_bluecrystal" data-sap-ui-noConflict="true"
	data-sap-ui-libs="sap.ui.comp">	
</script>

<link rel="stylesheet" href="../../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen" />
<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
<script type="text/javascript">


	if(!(sap.ui.Device.browser.internet_explorer && sap.ui.Device.browser.version <= 8)) {
		jQuery.sap.require("sap.ui.qunit.qunit-coverage");
	} 		
	

	(function() {

		jQuery.sap.require("sap.ui.comp.smarttable.SmartTable");
		jQuery.sap.require("sap.ui.comp.smartfilterbar.SmartFilterBar");
		jQuery.sap.require("sap.ui.comp.smarttable.TableType");
		
		module("sap.ui.comp.smarttable.SmartTable", {
			setup: function() {
				this.oSmartTable = new sap.ui.comp.smarttable.SmartTable({
					useVariantManagemen: false,
					useTablePersonalisation: false
				});
			},
			teardown: function() {
				this.oSmartTable.destroy();
			}
		});

		test("Shall be instantiable", function() {
			ok(this.oSmartTable);
		});
		
		test("Shall have entitySet property", function() {
			this.oSmartTable.setEntitySet("foo");
			strictEqual(this.oSmartTable.getEntitySet(),"foo");
		});
		
		test("Shall have tableType property", function() {
			this.oSmartTable.setTableType(sap.ui.comp.smarttable.TableType.ResponsiveTable);
			strictEqual(this.oSmartTable.getTableType(),"ResponsiveTable");
		});
		
		test("Shall have useVariantManagement property", function() {
			this.oSmartTable._createVariantManagementControl = function(){ };
			this.oSmartTable.setUseVariantManagement(true);
			ok(this.oSmartTable.getUseVariantManagement());
			
			this.oSmartTable.setUseVariantManagement(false);
			ok(!this.oSmartTable.getUseVariantManagement());
		});
		
		test("Shall have useExportToExcel property", function() {
			this.oSmartTable.setUseExportToExcel(true);
			ok(this.oSmartTable.getUseExportToExcel());
			
			this.oSmartTable.setUseExportToExcel(false);
			ok(!this.oSmartTable.getUseExportToExcel());
		});
		
		test("Shall have showRowCount property", function() {
			this.oSmartTable.setShowRowCount(true);
			ok(this.oSmartTable.getShowRowCount());
			
			this.oSmartTable.setShowRowCount(false);
			ok(!this.oSmartTable.getShowRowCount());
		});
		
		test("Shall have custom toolbar aggregation", function() {
			var oToolbar1 = new sap.m.Toolbar();
			var oToolbar2 = new sap.m.Toolbar();
			this.oSmartTable.setCustomToolbar(oToolbar1);
			ok (this.oSmartTable.getCustomToolbar() === oToolbar1, "set toolbar has to be returned by getter");
			
			this.oSmartTable.setCustomToolbar(oToolbar2);
			ok (this.oSmartTable.getCustomToolbar() !== oToolbar1, "set toolbar has to be returned by getter");
			ok (this.oSmartTable.getCustomToolbar() === oToolbar2, "set toolbar has to be returned by getter");
		});

		test("Shall pass the entity set to the TableProvider", function() {
			var sEntitySet = "COMPANYSet";
			this.oSmartTable.setEntitySet(sEntitySet);
			sinon.stub(sap.ui.comp.providers, "TableProvider").returns({});	
			sinon.stub(this.oSmartTable, "getModel").returns({});
		
			this.oSmartTable._createTableProvider();
			
			ok(sap.ui.comp.providers.TableProvider.calledOnce);
			strictEqual(sap.ui.comp.providers.TableProvider.args[0][0].entitySet, sEntitySet);
			sap.ui.comp.providers.TableProvider.restore();
		});
		
		
		test("Shall trigger initialiseMetadata and call _createTableProvider when entitySet and model are both set", function() {
			var sEntitySet = "COMPANYSet", oModel = new sap.ui.model.Model(), oTableProvider;
			oTableProvider = {
				getTableViewMetadata: sinon.stub(),
				getRequestAtLeastFields: sinon.stub(),
				getSupportsExcelExport: sinon.stub()
			};
			oTableProvider.getTableViewMetadata.returns([]);
			sinon.stub(sap.ui.comp.providers, "TableProvider").returns(oTableProvider);
			
			sinon.spy(this.oSmartTable, "_initialiseMetadata");
			sinon.spy(this.oSmartTable, "_createTableProvider");
			sinon.spy(this.oSmartTable, "_listenToSmartFilter");
			sinon.spy(this.oSmartTable, "fireInitialise");
			
			this.oSmartTable.setEntitySet(sEntitySet);
			this.oSmartTable.setModel(oModel);
		
			strictEqual(sap.ui.comp.providers.TableProvider.args[0][0].entitySet, sEntitySet);
			strictEqual(sap.ui.comp.providers.TableProvider.args[0][0].model, oModel);
			ok(this.oSmartTable._initialiseMetadata.called);
			ok(this.oSmartTable._createTableProvider.called);
			ok(this.oSmartTable._listenToSmartFilter.calledOnce);
			ok(this.oSmartTable.fireInitialise.calledOnce);			
			strictEqual(this.oSmartTable.bIsInitialised,true);
			
			sap.ui.comp.providers.TableProvider.restore();
		});
		
		test("Shall pass the initiallyVisibleFields to TableProvider", function() {
			var sInitiallyVisbleFields, sEntitySet = "COMPANYSet", oModel = new sap.ui.model.Model(), oTableProvider;
			oTableProvider = {
				getTableViewMetadata: sinon.stub(),
				getRequestAtLeastFields: sinon.stub(),
				getSupportsExcelExport: sinon.stub()
			};
			oTableProvider.getTableViewMetadata.returns([]);
			sinon.stub(sap.ui.comp.providers, "TableProvider").returns(oTableProvider);
			sInitiallyVisbleFields = "foo,bar,col2";
			this.oSmartTable.setInitiallyVisibleFields(sInitiallyVisbleFields);
			this.oSmartTable.setEntitySet(sEntitySet);
			this.oSmartTable.setModel(oModel);
		
			strictEqual(sap.ui.comp.providers.TableProvider.args[0][0].entitySet, sEntitySet);
			strictEqual(sap.ui.comp.providers.TableProvider.args[0][0].model, oModel);
			strictEqual(sap.ui.comp.providers.TableProvider.args[0][0].initiallyVisibleFields, sInitiallyVisbleFields);
			sap.ui.comp.providers.TableProvider.restore();
		});
		
		test("_createToolbar and _createToolbarContent shall create toolbars", function() {	
			this.oSmartTable._createToolbar();
			this.oSmartTable.setUseExportToExcel(false);
			this.oSmartTable.setUseTablePersonalisation(false);
			this.oSmartTable.setUseOnlyOneSolidToolbar(false);
			this.oSmartTable.setUseVariantManagement(false);
			this.oSmartTable.bIsInitialised = true;
			this.oSmartTable._createToolbarContent();			
			ok(this.oSmartTable._oToolbar === null, "no toolbar should be created");
			
			this.oSmartTable._createToolbar();
			this.oSmartTable.setHeader("Test Table");			
			this.oSmartTable._createToolbarContent();			
			equal(this.oSmartTable._oToolbar.getContent().length, 2, "toolbar should contain 2 entries");			
		});
		
		test("_createToolbar and _createToolbarContent shall create toolbars - custom toolbar", function() {			
			var oCustomToolbar = new sap.m.Toolbar();
			//Destroy the current instance and create the toolbar inline
			this.oSmartTable.destroy();			
			this.oSmartTable =  new sap.ui.comp.smarttable.SmartTable({
				useVariantManagement: false,
				useTablePersonalisation: false,
				customToolbar: oCustomToolbar
			});
			this.oSmartTable.setHeader("Test Table");
			this.oSmartTable.bIsInitialised = true;
			this.oSmartTable._createToolbarContent();			
			ok(this.oSmartTable._oToolbar === this.oSmartTable._oCustomToolbar, "toolbar reuses the custom toolbar");
			equal(oCustomToolbar.getContent().length, 2, "custom toolbar should contain 2 entries");
		});
		
		test("_createToolbar and _createToolbarContent shall create toolbars - custom toolbar with own spacer", function() {	
			var oCustomToolbar = new sap.m.Toolbar();
			var oToolbarSpacer = new sap.m.ToolbarSpacer();
			oCustomToolbar.addContent(oToolbarSpacer);
			//Destroy the current instance and create the toolbar inline
			this.oSmartTable.destroy();			
			this.oSmartTable =  new sap.ui.comp.smarttable.SmartTable({
				useVariantManagement: false,
				useTablePersonalisation: false,
				customToolbar: oCustomToolbar
			});
			this.oSmartTable.setHeader("Test Table");
			this.oSmartTable.bIsInitialised = true;
			
			this.oSmartTable._createToolbarContent();		
			ok(this.oSmartTable._oToolbar === this.oSmartTable._oCustomToolbar, "toolbar reuses the custom toolbar");
			equal(oCustomToolbar.getContent().length, 2, "custom toolbar should contain 2 entries");
			equal(oCustomToolbar.getContent()[1], oToolbarSpacer,"custom toolbar should contain orginal spacer");
		});
		
		test("test header text features", function() {
			this.oSmartTable.setUseExportToExcel(false);
			this.oSmartTable.setUseTablePersonalisation(false);
			this.oSmartTable.setUseOnlyOneSolidToolbar(false);
			this.oSmartTable.setUseVariantManagement(false);	
			this.oSmartTable.bIsInitialised = true;
			
			var sHeaderText = "myTestHeader";
			this.oSmartTable.setHeader(sHeaderText);						
			equal(this.oSmartTable.getHeader(), sHeaderText, "header text has to be equal");
			
			this.oSmartTable.setShowRowCount(true);
			this.oSmartTable._createToolbar();
			this.oSmartTable._createToolbarContent();		
			equal(this.oSmartTable.getHeader(), sHeaderText, "header text has to be equal");
			equal(this.oSmartTable._headerText.getText(), sHeaderText + " (0)", "header text has to contain row count");
		});
		
		test("test excel export enabled state", function() {			
			this.oSmartTable.setUseTablePersonalisation(false);
			this.oSmartTable.setUseOnlyOneSolidToolbar(false);
			this.oSmartTable.setUseVariantManagement(false);	
			this.oSmartTable.setUseExportToExcel(true);
			this.oSmartTable.bIsInitialised = true;
			this.oSmartTable._bTableSupportsExcelExport = true;
			
			var iRowCount = 0;
			this.oSmartTable._getRowCount = function(){
				return iRowCount;
			};		
			this.oSmartTable._oTable = { getRows: function() { return null;  } };
			
			this.oSmartTable._createToolbar();
			this.oSmartTable._createToolbarContent();		
			
			this.oSmartTable.updateTableHeaderState();
			equal(this.oSmartTable._oUseExportToExcel.getEnabled(), false, "Export to Excel has to be disabled");
			
			this.oSmartTable._oTable = { getRows: function() { return  [{getBindingContext: function(){ return {} }}] } };
			
			this.oSmartTable.updateTableHeaderState();
			equal(this.oSmartTable._oUseExportToExcel.getEnabled(), true, "Export to Excel has to be enabled because first row has a binding context even so row count returned 0");
						
			iRowCount = 100;
			this.oSmartTable._oTable = null;
			this.oSmartTable.updateTableHeaderState();
			equal(this.oSmartTable._oUseExportToExcel.getEnabled(), true, "Export to Excel has to be enabled");			
		});		
		
		test("test excel export", function() {			
			var iRowCount = 1;
			this.oSmartTable._getRowCount = function(){
				return iRowCount;
			};			
			this.oSmartTable._getVisibleColumnPaths = function(){
				return null;
			};			
			
			
			this.oSmartTable.setUseTablePersonalisation(false);
			this.oSmartTable.setUseOnlyOneSolidToolbar(false);
			this.oSmartTable.setUseVariantManagement(false);	
			this.oSmartTable.setUseExportToExcel(true);
			this.oSmartTable.bIsInitialised = true;
			this.oSmartTable._bTableSupportsExcelExport = true;
			this.oSmartTable._createToolbar();
			this.oSmartTable._createToolbarContent();		
			
						
			var sDownloadUrlType;
			var sUrl = "testUrl";
			this.oSmartTable._getRowBinding = function(){
				return { getDownloadUrl: function(sType){
					sDownloadUrlType = sType;
					return sUrl;
				}};
			};
			
			sinon.stub(window, "open");
			
			this.oSmartTable._oUseExportToExcel.firePress();
			equal (sDownloadUrlType, "xlsx", "DownloadType has to be xlsx");
			ok (window.open.calledWith(sUrl), "window.open has to be called with correct url");
			
			jQuery.sap.require("sap.m.MessageBox");
			sinon.stub(sap.m.MessageBox, "confirm");
			iRowCount = 50000;
			sUrl = "testUrl2";
			this.oSmartTable._oUseExportToExcel.firePress();
			var oArgs = sap.m.MessageBox.confirm.getCall(0).args[1];
			equal (oArgs.actions[0], sap.m.MessageBox.Action.YES, "MessageBox should show YES");
			equal (oArgs.actions[1], sap.m.MessageBox.Action.NO, "MessageBox should show NO");
			oArgs.onClose(sap.m.MessageBox.Action.YES);
			ok (window.open.calledWith(sUrl), "window.open has to be called with correct url");
			
			sap.m.MessageBox.confirm.restore();
			window.open.restore();
		});
		
		test("test inner tables _rowsUpdated event", function() {
			var bFunctionWasCalled = false;
			this.oSmartTable.setTableType("AnalyticalTable");
			this.oSmartTable._createTable();			
			this.oSmartTable._setExcelExportEnableState = function() { bFunctionWasCalled = true; };
			this.oSmartTable._oTable.fireEvent("_rowsUpdated")
			ok(bFunctionWasCalled, "smartTable _setExcelExportEnableState was called by inner table _rowsUpdated event");
		});
		
		test("test apply and fetch variant", function() {			
			var oTestVariant = {};
			this.oSmartTable._oSmartFilter = sinon.createStubInstance(sap.ui.comp.smartfilterbar.SmartFilterBar);
			this.oSmartTable._oTable = { 
				setShowOverlay: function(){},
				getColumns: function(){return [];},
				removeAllColumns: function(){}
			};
			
			var bTableReseted = false;
			this.oSmartTable._oPersController= {
					resetPersonalization: function(){
						bTableReseted = true;
					},
					setPersonalizationData: function(){
						//foo
					}
			};
			
			this.oSmartTable.applyVariant(oTestVariant);
			var oResultVariant = this.oSmartTable.fetchVariant();
			equal(oResultVariant, oTestVariant, "applied variant has to equal fetched variant");			
			
			this.oSmartTable.applyVariant("STANDARD");
			var oResultVariant = this.oSmartTable.fetchVariant();
			deepEqual(oResultVariant, { }, "applied STANDARD variant should return empty variant");
			ok(bTableReseted, "applying STANDARD variant should reset table");			
		});
		
		test("test add Spacer", function() {			
			this.oSmartTable._createToolbar();
			this.oSmartTable._addSpacerToToolbar();
						
			equal(this.oSmartTable._oToolbar.getContent().length, 1, "one item has to be added to the toolbar");
			ok(this.oSmartTable._oToolbar.getContent()[0] instanceof sap.m.ToolbarSpacer, "ToolbarSpacer has to be added to toolbar");
			
			delete this.oSmartTable._oToolbar;
			this.oSmartTable.setCustomToolbar(new sap.m.Toolbar());
			this.oSmartTable._createToolbar();
			var oSpacer = new sap.m.ToolbarSpacer();
			this.oSmartTable._oCustomToolbar.addContent(oSpacer);
			this.oSmartTable._addSpacerToToolbar();
						
			equal(this.oSmartTable._oCustomToolbar.getContent().length, 1, "toolbar has to contain one item");
			equal(this.oSmartTable._oCustomToolbar.getContent()[0], oSpacer, "item has to be original toolbarSpacer");
						
		});
		
		test("test smartTable setToolbarStyleClass", function() {			
			var sTestStyleClass ="DummyStyleClass";
			
			//Destroy the current instance and create the toolbar inline
			this.oSmartTable.destroy();			
			this.oSmartTable =  new sap.ui.comp.smarttable.SmartTable({
				useVariantManagement: false,
				useTablePersonalisation: false,
				toolbarStyleClass: sTestStyleClass
			});
						
			equal(this.oSmartTable.getToolbarStyleClass(), sTestStyleClass, "style class has to be present in the table");
			ok(this.oSmartTable._oToolbar.aCustomStyleClasses.indexOf(sTestStyleClass) > -1,"style class has to be set correctly on toolbar");
		});
		
		test("test _getChangeStatus", function() {		
			jQuery.sap.require("sap.ui.comp.personalization.Controller");
			
			var returnedChangeStatus = this.oSmartTable._getChangeStatus();						
			equal(returnedChangeStatus, sap.ui.comp.personalization.ChangeType.ModelChanged, "change status has to be correct");	
			
			returnedChangeStatus = this.oSmartTable._getChangeStatus({ 
				sort: sap.ui.comp.personalization.ChangeType.Unchanged,
				filter: sap.ui.comp.personalization.ChangeType.Unchanged,
				columns: sap.ui.comp.personalization.ChangeType.Unchanged,
				group: sap.ui.comp.personalization.ChangeType.Unchanged });						
			equal(returnedChangeStatus, sap.ui.comp.personalization.ChangeType.Unchanged, "change status has to be correct");	
			
			returnedChangeStatus = this.oSmartTable._getChangeStatus({ 
				sort: sap.ui.comp.personalization.ChangeType.Unchanged,
				filter: sap.ui.comp.personalization.ChangeType.Unchanged,
				columns: sap.ui.comp.personalization.ChangeType.TableChanged,
				group: sap.ui.comp.personalization.ChangeType.Unchanged });						
			equal(returnedChangeStatus, sap.ui.comp.personalization.ChangeType.TableChanged, "change status has to be correct");	
			
			returnedChangeStatus = this.oSmartTable._getChangeStatus({ 
				sort: sap.ui.comp.personalization.ChangeType.Unchanged,
				filter: sap.ui.comp.personalization.ChangeType.Unchanged,
				columns: sap.ui.comp.personalization.ChangeType.TableChanged,
				group: sap.ui.comp.personalization.ChangeType.ModelChanged });						
			equal(returnedChangeStatus, sap.ui.comp.personalization.ChangeType.ModelChanged, "change status has to be correct");	
			
		});
		
		test("test _persistPersonalization", function() {
			var fCallBack;
			var oFinalParams;
			this.oSmartTable._oVariantManagement={
					getVariantsInfo: function(callBack){
						fCallBack = callBack;
					},
					fireSave: function(oParams){
						oFinalParams = oParams;
					},
					detachInitialise: function() {},
					detachAfterSave: function() {},
					detachSave: function() {},
					isPageVariant: function() {}
			};
			
			this.oSmartTable._persistPersonalisation();
			equal(typeof fCallBack, "function", "callback function has to be provided");
			
			fCallBack([]);
			deepEqual(oFinalParams, {name:"Personalisation", global: false, overwrite: false, key: null, def: true}, "fire save has to be called with correct parameters");
			
			fCallBack([{key: "123"}]);
			deepEqual(oFinalParams, {name:"Personalisation", global: false, overwrite: true, key: "123", def: true}, "fire save has to be called with correct parameters");
		});
		
		test("test _createVariantManagementControl", function() {			
			this.oSmartTable.setUseVariantManagement(true);			
			this.oSmartTable.setPersistencyKey("foo");
			
			sinon.spy(sap.ui.comp.smartvariants, "PersonalizableInfo");
			
			this.oSmartTable._createVariantManagementControl();			
			
			var oControl = sap.ui.comp.smartvariants.PersonalizableInfo.thisValues[0].getControl();			
			
			equal (this.oSmartTable._oVariantManagement.getPersonalizableControls()[0].getType(), "table", "PersonalizableInfo.type has to be set correctly");
			equal (this.oSmartTable._oVariantManagement.getPersonalizableControls()[0].getKeyName(), "persistencyKey", "PersonalizableInfo.keyName has to be set correctly");
			ok (oControl === this.oSmartTable.getId(), "PersonalizableInfo Control has to be set to smarttable");
			
			equal (this.oSmartTable._oVariantManagement.getShowShare(), true, "SmartVariantManagement has to be instantiated correctly - showShare");
			ok (this.oSmartTable._oVariantManagement.getPersonalizableControls()[0] === sap.ui.comp.smartvariants.PersonalizableInfo.thisValues[0], "SmartVariantManagement has to be instantiated correctly - personalizableControls");
			
			this.oSmartTable._oVariantManagement._initialize({}, this.oSmartTable._oVariantManagement._getControlWrapper(sap.ui.getCore().byId(oControl)));
			equal (this.oSmartTable._oCurrentVariant, "STANDARD", "current variant has to be initialized");			
		});
		
		test("test getRowCount function", function() {
			var currentLength = 10;
			var oRowBinding = {
					getLength: function() { return currentLength;}
			};
			this.oSmartTable._getRowBinding = function(){
			 return oRowBinding;
			};
						
			var oResult = this.oSmartTable._getRowCount();
			
			equal(oResult, 10, "row count has to be returned correctly");
			
			currentLength = -100;
			oResult = this.oSmartTable._getRowCount();
			equal(oResult, 0, "negative row count has to be defaulted to 0");
			
			currentLength = 10;
			oRowBinding = {
					getTotalSize: function() { return currentLength;}
			};
			
			oResult = this.oSmartTable._getRowCount();
			equal(oResult, 10, "total size has to be used if available");
			
			currentLength = "0";
			oResult = this.oSmartTable._getRowCount();
			equal(oResult, 0, "row count has to be returned correctly");
			equal(typeof oResult, "number", "row count has to be returned as number");			
		});
		
		test("test _getTablePersonalisationData function", function() {		
			this.oSmartTable._getPathFromColumnKeyAndProperty = function(sColumnKey){
				return sColumnKey;
			}
			this.oSmartTable._getColumnByKey = function(sColumnKey) {
				return { 
					getFilterProperty: function() {
						return sColumnKey
					},
					data: function(){
						return {};
					}
				};
			}
			jQuery.sap.require("sap/m/P13nConditionPanel");
			this.oSmartTable._oCurrentVariant = {
				columns: {
					columnsItems:[
					              { visible: true, columnKey: "Key1"},
					              { visible : false, columnKey: "Key2" },
					              { visible: true, columnKey: "Key3" }					              
					              ]
				},
				sort: {
					sortItems:[
								{ columnKey: "Key1"},
								{ columnKey: "Key2", operation : sap.m.P13nConditionOperation.Descending },
								{ columnKey: "Key3" }	
					         ]
				},
				filter: {
					filterItems:[
								{ columnKey: "Key1", operation: sap.ui.model.FilterOperator.BT, value1 : 10, value2 : 20},
								{ columnKey: "Key2", operation: sap.ui.model.FilterOperator.BT, value1 : 10, value2 : 20 },
								{ columnKey: "Key3", operation: sap.ui.model.FilterOperator.BT, value1 : 10, value2 : 20 }	
					         ]
				}
				
			};
						
			var oResult = this.oSmartTable._getTablePersonalisationData();	
			var oExpected = {
				filters:[],
				sorters:["Key1", "Key2", "Key3"]
			};
						
			equal(oResult.sorters.length, 3, "correct number of sorters");
			equal(oResult.sorters[0].sPath, "Key1", "correct path on sorter 1");
			equal(oResult.sorters[0].bDescending, false, "correct descending flag on sorter 1");
			equal(oResult.sorters[1].sPath, "Key2", "correct path on sorter 2");
			equal(oResult.sorters[1].bDescending, true, "correct descending flag on sorter 2");
			equal(oResult.sorters[2].sPath, "Key3", "correct path on sorter 3");
			equal(oResult.sorters[2].bDescending, false, "correct descending flag on sorter 3");
			

			var aFilters = oResult.filters;
			equal(aFilters.length, 3, "correct number of filters");
			equal(aFilters[0].sPath, "Key1", "correct key on filter 1");
			equal(aFilters[1].sPath, "Key2", "correct key on filter 2");
			equal(aFilters[2].sPath, "Key3", "correct key on filter 3");
			
			});
		
		test("test _getPathFromColumnKeyAndProperty function", function() {
			var aColumns = [
			                { data: function() { return null; } },
			                { data: function(sDataKey) { 
			                	if (sDataKey === "p13nData"){
			                		return {
			                			columnKey: "TestKey",
			                			customProperty: "CustomPropertyValue"
			                		}
			                	}
			                	return null; },
			                	getSortProperty: function(){return "SortPropertyValue"; },
	                			getFilterProperty: function(){return "FilterPropertyValue"; },
	                			getLeadingProperty: function(){return "LeadingPropertyValue"; }	                			
	                			}
			                ];
			this.oSmartTable._oTable = {
				getColumns : function() { return aColumns; }	
			};
			
			var sValue = this.oSmartTable._getPathFromColumnKeyAndProperty("TestKey", "sortProperty");
			equal (sValue, "SortPropertyValue", "Function has to return correct sort property value");
			
			sValue = this.oSmartTable._getPathFromColumnKeyAndProperty("TestKey", "filterProperty");
			equal (sValue, "FilterPropertyValue", "Function has to return correct filter property value");
			
			sValue = this.oSmartTable._getPathFromColumnKeyAndProperty("TestKey", "leadingProperty");
			equal (sValue, "LeadingPropertyValue", "Function has to return correct leading property value");
			
			sValue = this.oSmartTable._getPathFromColumnKeyAndProperty("TestKey", "customProperty");
			equal (sValue, "CustomPropertyValue", "Function has to return correct custom property value");
			
		});		
		
		test("test setUseVariantManagement function", function() {
			var bResetToInitialTableState = false;
			this.oSmartTable._oPersController = {
				setResetToInitialTableState : function(bAllow) { bResetToInitialTableState = bAllow; }	
			};
			
			this.oSmartTable.setUseVariantManagement(false);
			equal (this.oSmartTable.getUseVariantManagement(), false, "use Variant Management should be false");
			equal (bResetToInitialTableState, true, "persController allow reset should be true");
			
			this.oSmartTable.setUseVariantManagement(true);
			equal (this.oSmartTable.getUseVariantManagement(), true, "use Variant Management should be true");
			equal (bResetToInitialTableState, false, "persController allow reset should be false");			
		});		
		
		test("test getTable function", function() {
			var oDummyTable = { };
			this.oSmartTable._oTable = oDummyTable;
			
			equal (this.oSmartTable.getTable(), oDummyTable, "getTable should retrieve internal table");						
		});
		
		test("test _addSeparatorToToolbar function", function() {
			var oInsertedObject = null;
			var iInsertIndex = -1;
			var sExistingHeight, sClass;
			this.oSmartTable.setHeader("Dummy");
			this.oSmartTable.setUseVariantManagement(true);
			this.oSmartTable._oToolbar = {
				getHeight: function(){
					return sExistingHeight;
				},
				addStyleClass: function(sStyleClass){
					sClass = sStyleClass;
				},
				insertContent : function(oObject, iIndex){
					iInsertIndex = iIndex;
					oInsertedObject = oObject;
				}
			};
			
			this.oSmartTable._oVariantManagement = {			                          			 
			    isPageVariant: function() { return false; }                                      
            };			
			
			this.oSmartTable._addSeparatorToToolbar();
			ok (oInsertedObject instanceof sap.m.ToolbarSeparator, "object instanceof ToolbarSeparator should have been added");
			equal (iInsertIndex, 0, "separator should be inserted at index 0");	
			
			equal (sClass, "sapUiCompSmartTableToolbarHeight", "default height shall be set from 'sapUiCompSmartTableToolbarHeight', if nothing is set");			
			
			this.oSmartTable._oVariantManagement = null;			
		});
		
		test("test _addVariantManagementToToolbar  function", function() {
			var oDummyVariantManagement = { isPageVariant: function() { return false; },
			            					detachInitialise: function() {},
			            					detachAfterSave: function() {},
			            					detachSave: function() {},
			            					setVisible: function() {}
			};
			var oInsertedObject = null;
			var iInsertIndex = -1;
			this.oSmartTable._oVariantManagement = oDummyVariantManagement;
			
			this.oSmartTable.setUseVariantManagement(true);
			this.oSmartTable._oToolbar = {
					insertContent : function(oObject, iIndex){
							iInsertIndex = iIndex;
							oInsertedObject = oObject;
					}
			};
			
			this.oSmartTable._addVariantManagementToToolbar(true);
			equal (oInsertedObject, oDummyVariantManagement, "variant management object should have been inserted");
			equal (iInsertIndex, 0, "variant management should be inserted at index 0");						
		});
		
		test("test _addTablePersonalisationToToolbar   function", function() {
			var bDialogOpen = false;
			
			this.oSmartTable._oPersController = {
				openDialog: function(){
					bDialogOpen = true;
				}
			};
			
			var oAddedToToolbar = null;
			
			this.oSmartTable.setUseTablePersonalisation(true);
			this.oSmartTable._oToolbar = {
					addContent : function(oObject){							
						oAddedToToolbar = oObject;
					}
			};
			
			this.oSmartTable._addTablePersonalisationToToolbar();			
			ok (oAddedToToolbar instanceof sap.m.Button, "personalisation button should have been added to toolbar");
			
			oAddedToToolbar.firePress();
			ok (bDialogOpen, "persController openDialog should have been called");
		});
		
		test("test rebindTable function", function() {		
			var oBindingParameters = null;
			var bBeforeRebindCalled = false;
			var bPreventBinding;

		    this.oSmartTable._oTable = new sap.ui.table.Table();
		    var fBindStub = sinon.stub(this.oSmartTable._oTable, "bindRows");
			
			this.oSmartTable._getRowCount = function(){ return 0; };
			
			this.oSmartTable.attachBeforeRebindTable(function(oParams){
				bBeforeRebindCalled = true;
				oParams.getParameter("bindingParams").preventTableBind = bPreventBinding;
				oParams.getParameter("bindingParams").parameters["select"] = ["foo"];
			});
			
			bPreventBinding = true;
			this.oSmartTable.rebindTable();
			
			ok(bBeforeRebindCalled, "before rebind has to be called");			
			ok(!this.oSmartTable._bIsTableBound, "table has to be unbound because of prevent binding");
			ok(!this.oSmartTable._oTable.getBusy(), "internal table has to set busy flag to false because of prevent binding");
						
			bPreventBinding = false;
			this.oSmartTable.rebindTable();
			
			ok(this.oSmartTable._bIsTableBound, "table has to be bound");
			ok(this.oSmartTable._oTable.getBusy(), "internal table has to set busy flag");
			ok(fBindStub.calledOnce, "binding triggered on the internal table");
			
			oBindingParameters = fBindStub.args[0][0];
			
			ok(oBindingParameters, "binding parameters are set");					
			
			oBindingParameters.events.dataReceived();
			
			ok(!this.oSmartTable._oTable.getBusy(), "internal table busy flag reseted");
		});		
		
		test("test _isTableBound function", function() {
			ok(!this.oSmartTable._isTableBound(), "table has not yet been bound");
			// simulate that at least 1 column exists!
			this.oSmartTable.attachBeforeRebindTable(function(oParams) {
				oParams.getParameter("bindingParams").parameters["select"] = [
					"foo"
				];
			});
			//bind via SmartTable API
			this.oSmartTable.rebindTable();
			ok(this.oSmartTable._isTableBound(), "table has now been bound");
			//unbind the table
			this.oSmartTable._bIsTableBound = false;
			var oTable = this.oSmartTable.getTable();
			oTable.unbindRows();
			ok(!this.oSmartTable._isTableBound(), "table has not been bound");
			// bind directly to simulate external binding
			oTable.bindRows("/foo");
			ok(this.oSmartTable._isTableBound(), "table has been bound");
		});

		test("test CurrentVariantId property", function() {
			sinon.stub(jQuery.sap.log, "error");
			this.oSmartTable.setCurrentVariantId("dummy");
			
			ok(jQuery.sap.log.error.calledOnce, "variantManagement not in place, error should have been logged");
			
			var bGetterCalled = false;
			var bSetterCalled = false;
			var sSetVariantId = null;
			
			var sVariantId ="MyVariantId";
			
			this.oSmartTable._oVariantManagement = {
				getCurrentVariantId: function(){
					bGetterCalled = true;
					return sSetVariantId;
				},
				setCurrentVariantId: function(sId){
					bSetterCalled = true;
					sSetVariantId = sId;
				},
				detachInitialise: function() {},
				detachAfterSave: function() {},
				detachSave: function() {},
				isPageVariant: function() {}				
			};
			
			this.oSmartTable.setCurrentVariantId(sVariantId);
			
			ok(bSetterCalled, "setter has to be called on internal variantmanagement");
			equal(sSetVariantId, sVariantId, "set variant id has to be correct");
			
			var sReturnedId = this.oSmartTable.getCurrentVariantId();
			ok(bGetterCalled, "Getter has to be called on internal variantmanagement");
			equal(sReturnedId, sVariantId, "get variant id has to be correct");
		});
		
		test("test create column functions", function() {			
			var oColumn = this.oSmartTable._createColumn({},"a");
			ok(oColumn instanceof sap.ui.table.Column, "has to be table Column");
			oColumn.destroy();
			oColumn = this.oSmartTable._createAnalyticalColumn ({},"a");
			ok(oColumn instanceof sap.ui.table.AnalyticalColumn, "has to be Analytical Column");
			oColumn.destroy();
			oColumn = this.oSmartTable._createMobileColumn  ({},"a");
			ok(oColumn instanceof sap.m.Column, "has to be Mobile Column");
		});
		
		test("test _createTable function", function(){
			this.oSmartTable.removeAllItems();
			if(this.oSmartTable._oTable){
				this.oSmartTable._oTable.destroy();
			}
			this.oSmartTable._oTable = null;
			
			this.oSmartTable.setTableType("AnalyticalTable");
			this.oSmartTable.addItem(new sap.m.Table());
			this.oSmartTable._createTable();
			
			ok(this.oSmartTable._isMobileTable, "internal Mobile table has to be used");
			ok(this.oSmartTable._createColumn === this.oSmartTable._createMobileColumn, "create column function has to be adjusted to create mobile columns");
			
			this.oSmartTable.removeAllItems();
			if(this.oSmartTable._oTable){
				this.oSmartTable._oTable.destroy();
			}
			this.oSmartTable._oTable = null;
			
			this.oSmartTable.addItem(new sap.ui.table.AnalyticalTable());
			this.oSmartTable._createTable();
			
			ok(this.oSmartTable._isAnalyticalTable, "internal Analytical table has to be used");
			ok(this.oSmartTable._createColumn === this.oSmartTable._createAnalyticalColumn, "create column function has to be adjusted to create analytical columns");
					
			this.oSmartTable.removeAllItems();
			if(this.oSmartTable._oTable){
				this.oSmartTable._oTable.destroy();
			}
			this.oSmartTable._oTable = null;
			
			this.oSmartTable.addItem(new sap.ui.table.TreeTable());
			this.oSmartTable._createTable();
			
			ok(this.oSmartTable._isTreeTable, "internal Tree table has to be used");
			
			this.oSmartTable.removeAllItems();		
			if(this.oSmartTable._oTable){
				this.oSmartTable._oTable.destroy();
			}
			this.oSmartTable._oTable = null;			
			this.oSmartTable.setTableType("AnalyticalTable");
			this.oSmartTable._createTable();		
			ok(this.oSmartTable.getTable() instanceof sap.ui.table.AnalyticalTable, "table has to be created according to table type Analytical table");
			
			this.oSmartTable.removeAllItems();
			if(this.oSmartTable._oTable){
				this.oSmartTable._oTable.destroy();
			}
			this.oSmartTable._oTable = null;
			this.oSmartTable.setTableType("TreeTable");
			this.oSmartTable._createTable();		
			ok(this.oSmartTable.getTable() instanceof sap.ui.table.TreeTable, "table has to be created according to table type Tree table");
			
			this.oSmartTable.removeAllItems();
			if(this.oSmartTable._oTable){
				this.oSmartTable._oTable.destroy();
			}
			this.oSmartTable._oTable = null;
			this.oSmartTable.setTableType("ResponsiveTable");
			this.oSmartTable._createTable();		
			ok(this.oSmartTable.getTable() instanceof sap.m.Table, "table has to be created according to table type ResponsiveTable table");
			
			this.oSmartTable.removeAllItems();
			if(this.oSmartTable._oTable){
				this.oSmartTable._oTable.destroy();
			}
			this.oSmartTable._oTable = null;
			this.oSmartTable.setTableType("Table");
			this.oSmartTable._createTable();		
			ok(this.oSmartTable.getTable() instanceof sap.ui.table.Table, "table has to be created according to table type Table table");			
		});
		
		test("test _showTableFilterDialog function", function(){
			var bOpenDialogWasCalled = false;									
			this.oSmartTable._oPersController = {
					openDialog: function(){
						bOpenDialogWasCalled = true;
					}
			}
			this.oSmartTable._bIsFilterPanelEnabled = true;
			this.oSmartTable.setTableType("AnalyticalTable");
			this.oSmartTable._createTable();
			
			this.oSmartTable._oTable.fireCustomFilter();
			
			ok(bOpenDialogWasCalled, "attachCustomFilter has to be registered correctly");
		});
		
		test("test _updateInitialColumns function", function(){
			var oColumn1 = {
			        data:function(){
			        	return {
							columnKey: "LP1"
						};
			        }
			}
			var oColumn2 ={
					data:function(){
						return {
							columnKey: "LP2"
						}
					}
			}
			
			var oColumn3 ={
					data:function(){
						return JSON.stringify({
							columnKey: "LP3"
						});
					}
			}
			
			var aColumns = [oColumn1, oColumn2, oColumn3];
			
			this.oSmartTable._oTable = {
					getColumns: function(){
						return aColumns;
					}
			}
			
			this.oSmartTable._aExistingColumns =[];
			this.oSmartTable._updateInitialColumns();
						
			ok(this.oSmartTable._aExistingColumns.indexOf("LP1") !== -1, "columnKey has to be retrieved from columns correctly (LP1)");			
			ok(this.oSmartTable._aExistingColumns.indexOf("LP2") !== -1, "columnKey has to be retrieved from columns correctly (LP2)");
			ok(this.oSmartTable._aExistingColumns.indexOf("LP3") !== -1, "columnKey has to be retrieved from columns correctly (LP3)");
		});		
		
		test("test _updateColumnsPopinFeature function", function(){
			var oColumn0 = new sap.m.Column();
			oColumn0.setOrder(0);
			var oColumn1 = new sap.m.Column({visible: false});
			oColumn1.setOrder(1);
			var oColumn2 = new sap.m.Column();
			oColumn2.setOrder(2);
			var oColumn3 = new sap.m.Column();
			oColumn3.setOrder(3);
			var oColumn4 = new sap.m.Column();
			oColumn4.setOrder(4);
			
			var aColumns = [oColumn3, oColumn1, oColumn2, oColumn4, oColumn0];
			
			this.oSmartTable._isMobileTable = true;
			this.oSmartTable._oTable = {
					getColumns: function(){
						return aColumns;
					}
			}			
			
			this.oSmartTable.bIsInitialised = true;
			this.oSmartTable.setDemandPopin(true);
			this.oSmartTable._updateColumnsPopinFeature();
						
			equal(oColumn0.getDemandPopin(), false, "column 0 has to switch off demand popin (first two visible columns)");			
			equal(oColumn1.getDemandPopin(), false, "column 1 has to switch off demand popin (invisible column)");
			equal(oColumn2.getDemandPopin(), false, "column 2 has to switch off demand popin (first two visible columns)");
			equal(oColumn3.getDemandPopin(), true, "column 3 has to switch on demand popin");
			equal(oColumn4.getDemandPopin(), true, "column 4 has to switch on demand popin");			
			
			equal(oColumn3.getMinScreenWidth(), "30rem", "column 3 needs correct MinScreenWidth");
			equal(oColumn4.getMinScreenWidth(), "40rem", "column 4 needs correct MinScreenWidth");
			
			this.oSmartTable.setDemandPopin(false);						
			equal(oColumn0.getDemandPopin(), false, "column 0 has to switch off demand popin if SmartTable demandPopin is false");			
			equal(oColumn1.getDemandPopin(), false, "column 1 has to switch off demand popin if SmartTable demandPopin is false");
			equal(oColumn2.getDemandPopin(), false, "column 2 has to switch off demand popin if SmartTable demandPopin is false");
			equal(oColumn3.getDemandPopin(), false, "column 3 has to switch off demand popin if SmartTable demandPopin is false");
			equal(oColumn4.getDemandPopin(), false, "column 4 has to switch off demand popin if SmartTable demandPopin is false");
		});	
		
		test("test _parseIndexedColumns function", function(){
			var oColumn0 = new sap.m.Column({customData: new sap.ui.core.CustomData({ key: "p13nData", value: {columnIndex: 0}})});			
			var oColumn1 = new sap.m.Column({customData: new sap.ui.core.CustomData({ key: "p13nData", value: {columnIndex: 3}})});
			var oColumn2 = new sap.m.Column({customData: new sap.ui.core.CustomData({ key: "p13nData", value: {columnIndex: 5}})});			
			var oColumn3 = new sap.m.Column({customData: new sap.ui.core.CustomData({ key: "p13nData", value: {columnIndex: 6}})});			
			var oColumn4 = new sap.m.Column();
					
			var aColumns = [oColumn3, oColumn1, oColumn2, oColumn4, oColumn0];
			
			this.oSmartTable._isMobileTable = true;
			this.oSmartTable._oTable = {
					getColumns: function(){
						return aColumns;
					},
					removeColumn: function() { }
			}			
			
			var aIndexedColumns = this.oSmartTable._parseIndexedColumns();
						
			equal(aIndexedColumns.length, 4, "4 columns are indexed");			
			equal(aIndexedColumns[0].column.getId(), oColumn0.getId(), "column 0 has to be first in array");
			equal(aIndexedColumns[0].index, 0, "column 0 has index 0");
			equal(aIndexedColumns[1].column.getId(), oColumn1.getId(), "column 1 has to be second in array");
			equal(aIndexedColumns[1].index, 3, "column 1 has index 3");
			equal(aIndexedColumns[2].column.getId(), oColumn2.getId(), "column 2 has to be third in array");
			equal(aIndexedColumns[2].index, 5, "column 2 has index 5");
			equal(aIndexedColumns[3].column.getId(), oColumn3.getId(), "column 3 has to be fourth in array");		
			equal(aIndexedColumns[3].index, 6, "column 3 has index 6");
		});	
		
		test("test _parseIndexedColumns && _insertIndexedColumns via _createContent function", function(){
			var oColumn0 = new sap.m.Column({customData: new sap.ui.core.CustomData({ key: "p13nData", value: {columnIndex: 0}})});
			var oColumn1 = new sap.m.Column();			
			var oColumn2 = new sap.m.Column({customData: new sap.ui.core.CustomData({ key: "p13nData", value: {columnIndex: 2}})});
			var oColumn3 = new sap.m.Column();
			var oColumn4 = new sap.m.Column({customData: new sap.ui.core.CustomData({ key: "p13nData", value: {columnIndex: 5}})});			
			var oColumn5 = new sap.m.Column({customData: new sap.ui.core.CustomData({ key: "p13nData", value: {columnIndex: 6}})});			
			
			
			var oTemplate0 = new sap.m.Text({id: "oTemplate0"});
			var oTemplate1 = new sap.m.Text({id: "oTemplate1"});
			var oTemplate2 = new sap.m.Text({id: "oTemplate2"});
			var oTemplate3 = new sap.m.Text({id: "oTemplate3"});
			var oTemplate4 = new sap.m.Text({id: "oTemplate4"});
			var oTemplate5 = new sap.m.Text({id: "oTemplate5"});
					
			var aColumns = [oColumn1, oColumn2, oColumn4, oColumn3, oColumn0, oColumn5];
			var aCells = [oTemplate1, oTemplate2, oTemplate4, oTemplate3, oTemplate0, oTemplate5]
			
			this.oSmartTable._oTemplate = new sap.m.ColumnListItem({cells: aCells});						
			
			this.oSmartTable._isMobileTable = true;
			this.oSmartTable._oTable = {
					getColumns: function(){
						return aColumns;
					},
					removeColumn: function() { },
					insertColumn: function() { }
			}		
			this.oSmartTable._updateColumnsPopinFeature=function(){};
			this.oSmartTable._aTableViewMetadata = [];			
			
			this.oSmartTable._createContent();
			
			var aCells = this.oSmartTable._oTemplate.getCells();
			
			equal(aCells.length, 6, "there have to be 6 templates in the collection");
			equal(aCells[0].getId(), oTemplate0.getId(), "template have to be moved according to column index");
			equal(aCells[1].getId(), oTemplate1.getId(), "template have to be moved according to column index");
			equal(aCells[2].getId(), oTemplate2.getId(), "template have to be moved according to column index");
			equal(aCells[3].getId(), oTemplate3.getId(), "template have to be moved according to column index");
			equal(aCells[4].getId(), oTemplate4.getId(), "template have to be moved according to column index");
			equal(aCells[5].getId(), oTemplate5.getId(), "template have to be moved according to column index");
			
		});	
		
		test("test _setIgnoreFromPersonalisationToSettings function", function(){			
			
			this.oSmartTable.setIgnoreFromPersonalisation("a,b,c,d");
						
			var oResult = this.oSmartTable._setIgnoreFromPersonalisationToSettings(null);
			var oExpected = {
			                 filter: { ignoreColumnKeys: ["a", "b", "c", "d"]},
			                 sort: { ignoreColumnKeys: ["a", "b", "c", "d"]},
			                 columns: { ignoreColumnKeys: ["a", "b", "c", "d"]},
			                 group: { ignoreColumnKeys: ["a", "b", "c", "d"]}			                 
			} 
			
			deepEqual(oResult, oExpected, "settings have to be correct with empty settings");			
			
			oResult = this.oSmartTable._setIgnoreFromPersonalisationToSettings({filter: {dummy: "Test"}});
			oExpected = {
			                 filter: { dummy: "Test", ignoreColumnKeys: ["a", "b", "c", "d"]},
			                 sort: { ignoreColumnKeys: ["a", "b", "c", "d"]},
			                 columns: { ignoreColumnKeys: ["a", "b", "c", "d"]},
			                 group: { ignoreColumnKeys: ["a", "b", "c", "d"]}			                 
			} 
			
			deepEqual(oResult, oExpected, "settings have to be correct with prefilled settings");			
		});
		
		test("test _adjustUrlToVisibleColumns function", function(){			
			
			this.oSmartTable._getVisibleColumnPaths = function() {return {select:["a","b","c","d"]}};
			
			var sResult = this.oSmartTable._adjustUrlToVisibleColumns("/SmartTemplates.startApp/ProductCollection?$format=xlsx&$select=ProductId%2cName%2cIsActiveEntity%2cHasActiveEntity%2cDraftKeyProductId%2cHasDraftEntity");			
			equal(sResult, "/SmartTemplates.startApp/ProductCollection?$format=xlsx&$select=a%2cb%2cc%2cd", "Url shall only contain visible columns");			
			
			sResult = this.oSmartTable._adjustUrlToVisibleColumns("/SmartTemplates.startApp/ProductCollection?$format=xlsx&$select=ProductId&sap-ui-debug=X");			
			equal(sResult, "/SmartTemplates.startApp/ProductCollection?$format=xlsx&$select=a%2cb%2cc%2cd&sap-ui-debug=X", "Url shall only contain visible columns and sustain other parameters");
			
			sResult = this.oSmartTable._adjustUrlToVisibleColumns("/SmartTemplates.startApp/ProductCollection?$format=xlsx&$select=ProductId&sap-ui-debug=X&dummy=2");			
			equal(sResult, "/SmartTemplates.startApp/ProductCollection?$format=xlsx&$select=a%2cb%2cc%2cd&sap-ui-debug=X&dummy=2", "Url shall only contain visible columns and sustain other parameters (multiple)");
			
			sResult = this.oSmartTable._adjustUrlToVisibleColumns("/SmartTemplates.startApp/ProductCollection?$select=ProductId&sap-ui-debug=X&dummy=2&$format=xlsx");			
			equal(sResult, "/SmartTemplates.startApp/ProductCollection?$select=a%2cb%2cc%2cd&sap-ui-debug=X&dummy=2&$format=xlsx", "Url shall only contain visible columns and sustain other parameters (multiple, select at begin)");
			
			this.oSmartTable._getVisibleColumnPaths = function() {return []};
			sResult = this.oSmartTable._adjustUrlToVisibleColumns("/SmartTemplates.startApp/ProductCollection?$format=xlsx&$select=ProductId&sap-ui-debug=X&dummy=2");			
			equal(sResult, "/SmartTemplates.startApp/ProductCollection?$format=xlsx&sap-ui-debug=X&dummy=2", "Url shall only contain visible columns and sustain other parameters (multiple)");
		});	
		
		test("test _removeExpandParameter function", function(){
			var sResult = this.oSmartTable._removeExpandParameter("http://myTest?$expand=a,b,c");			
			equal(sResult, "http://myTest");
			
			sResult = this.oSmartTable._removeExpandParameter("http://myTest?$expand=a,b,c&parameterB=test");			
			equal(sResult, "http://myTest?parameterB=test");
			
			sResult = this.oSmartTable._removeExpandParameter("http://myTest?parameterB=test&$expand=a,b,c");			
			equal(sResult, "http://myTest?parameterB=test");			
			
			sResult = this.oSmartTable._removeExpandParameter("http://myTest?parameterB=test&$expand=a,b,c&parameterC=test");			
			equal(sResult, "http://myTest?parameterB=test&parameterC=test");			

			sResult = this.oSmartTable._removeExpandParameter("/sap/opu/odata/sap/Z_BS_HD_DRAFT_SRV/Zfarvd_Bs_Hd_Bo?$format=xlsx&$orderby=CompanyCode%20desc,HouseBank%20asc&$select=CompanyCode%2cHouseBank%2cHouseBankName%2chousebankaccount%2cbankstatementdate%2cbankstatement%2cbankstatementnumberofitems%2ccurrency%2copeningbalanceamtintranscrcy%2cclosingbalanceamtintranscrcy%2cbankstatementstatus%2cdraftkey%2cbankstatementshortid%2cbankstatementshortid%2cIsActiveEntity%2cHasDraftEntity%2cHasActiveEntity%2cDraftAdministrativeData&$expand=DraftAdministrativeData");			
			equal(sResult, 			"/sap/opu/odata/sap/Z_BS_HD_DRAFT_SRV/Zfarvd_Bs_Hd_Bo?$format=xlsx&$orderby=CompanyCode%20desc,HouseBank%20asc&$select=CompanyCode%2cHouseBank%2cHouseBankName%2chousebankaccount%2cbankstatementdate%2cbankstatement%2cbankstatementnumberofitems%2ccurrency%2copeningbalanceamtintranscrcy%2cclosingbalanceamtintranscrcy%2cbankstatementstatus%2cdraftkey%2cbankstatementshortid%2cbankstatementshortid%2cIsActiveEntity%2cHasDraftEntity%2cHasActiveEntity%2cDraftAdministrativeData");
		});
		
		test("Destroy for ResponsiveTable without binding", function() {
			var bTableTemplateDestroyed = false;
			this.oSmartTable._oTemplate = {
					destroy:function(){
						bTableTemplateDestroyed = true;
				}
			}			
			
			equal(this.oSmartTable.bIsDestroyed, undefined);
			ok (!bTableTemplateDestroyed, "table template exits");
			this.oSmartTable.destroy();
			equal(this.oSmartTable._oTemplate, null);
			strictEqual(this.oSmartTable.bIsDestroyed, true);
			ok (bTableTemplateDestroyed, "table template has to be destroyed");
		});		
			
		
		test("Destroy", function() {
			var bTableProviderDestroyed = false;
			var bPersControllerDestroyed = false;
			var bVariantManagementDestroyed = false;
			this.oSmartTable._oTableProvider = {
					destroy:function(){
					bTableProviderDestroyed = true;
				}
			}
			
			this.oSmartTable._oPersController  = {
					destroy:function(){
					bPersControllerDestroyed = true;
				}
			}
			
			this.oSmartTable._oVariantManagement  = {
					destroy:function(){
					bVariantManagementDestroyed = true;
				},
				isPageVariant: function() {
					return false;
				},
				detachInitialise: function() {},
				detachAfterSave: function() {},
				detachSave: function() {}				
			}
			
			equal(this.oSmartTable.bIsDestroyed, undefined);
			this.oSmartTable.destroy();
			equal(this.oSmartTable._oTableProvider, null);
			equal(this.oSmartTable._aTableViewMetadata,null);
			strictEqual(this.oSmartTable.bIsDestroyed, true);
			ok (bTableProviderDestroyed, "table provider has to be destroyed");
			ok (bPersControllerDestroyed, "pers controller has to be destroyed");
			ok (bVariantManagementDestroyed, "variant management has to be destroyed");
		});		
	}());
</script>
</head>
<body id="body" class="sapUiBody">
	<h1 id="qunit-header">qUnit Page for
		sap.ui.comp.smarttable.SmartTable</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>

	<div id="content"></div>
</body>
</html>