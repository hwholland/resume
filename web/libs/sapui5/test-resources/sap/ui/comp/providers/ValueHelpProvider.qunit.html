<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>qUnit Page for sap.ui.comp.providers.ValueHelpProvider</title>

<script id="sap-ui-bootstrap" type="text/javascript"
	src="../../../../../resources/sap-ui-core.js"
	data-sap-ui-theme="sap_bluecrystal" data-sap-ui-noConflict="true"
	data-sap-ui-libs="sap.ui.comp">
	
</script>

<link rel="stylesheet" href="../../../../../resources/sap/ui/thirdparty/qunit.css"	type="text/css" media="screen" />
<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>


<script type="text/javascript">

	if(!(sap.ui.Device.browser.internet_explorer && sap.ui.Device.browser.version <= 8)) {
		jQuery.sap.require("sap.ui.qunit.qunit-coverage");
	} 		
	
	(function() {
		jQuery.sap.require("sap.ui.comp.valuehelpdialog.ValueHelpDialog")
		jQuery.sap.require("sap.ui.comp.providers.ValueHelpProvider");	
		jQuery.sap.require("sap.m.MultiInput");	
		jQuery.sap.require("sap.ui.model.odata.ODataModel");
		jQuery.sap.require("sap.ui.table.Table");
		var oValueHelpDialog = sinon.createStubInstance(sap.ui.comp.valuehelpdialog.ValueHelpDialog);
		var o = sinon.stub();
		o.returns(oValueHelpDialog);
		module("sap.ui.comp.providers.ValueHelpProvider", {
			setup: function() {
				this.sTitle ="foo";
				this.oAnnotation={valueListEntitySetName:"Chuck",keyField:"TheKey",descriptionField:"Desc",keys:["TheKey"],valueListFields:[{name:"TheKey"},{name:"Desc"}]};
				this.oModel=sinon.createStubInstance(sap.ui.model.odata.ODataModel);
				this.oValueHelpProvider = new sap.ui.comp.providers.ValueHelpProvider({title:this.sTitle,control: sinon.createStubInstance(sap.m.MultiInput), aggregation:"suggestionItems",annotation:this.oAnnotation,model:this.oModel});
				this.oValueHelpProvider._oValueHelpDialogClass = o;
			},
			teardown: function() {
				this.oValueHelpProvider.destroy();
			}
		});

		test("Shall be instantiable", function() {			
			ok(this.oValueHelpProvider);
		});	
		
		test("Shall call attachValueHelpRequest once on instantiation", function() {			
			strictEqual(this.oValueHelpProvider.oControl.attachValueHelpRequest.calledOnce,true);
			strictEqual(this.oValueHelpProvider.sTitle,this.sTitle);
		});
		
		test("Shall create an instance of ValueHelpDialog and Open it on _createValueHelpDialog", function() {	
			this.oValueHelpProvider._createValueHelpDialog();
			ok(this.oValueHelpProvider.oValueHelpDialog);
			strictEqual(oValueHelpDialog.open.calledOnce,true);
		});
		
		test("Shall call setModel on the table on creation of VHDialog", function() {
			this.oValueHelpProvider._createValueHelpDialog();		
			strictEqual(oValueHelpDialog.setModel.called,true);
			strictEqual(oValueHelpDialog.setModel.calledWith(this.oModel),true);
		});
		
		test("Shall not fill the table initially, if preventInitialDataFetchInValueHelpDialog is true", function() {
			this.oValueHelpProvider.preventInitialDataFetchInValueHelpDialog = true;
			sinon.spy(this.oValueHelpProvider, "_rebindTable");
			oValueHelpDialog._oTable = sinon.createStubInstance(sap.ui.table.Table);
			oValueHelpDialog.getTable.returns(oValueHelpDialog._oTable);			
			this.oValueHelpProvider.bSupportBasicSearch = true;
			this.oValueHelpProvider._createValueHelpDialog();		
			
			this.oValueHelpProvider._onFilterBarInitialise();
			
			ok(this.oValueHelpProvider._rebindTable.notCalled);
		});
		
		test("Shall fill the table initially, if preventInitialDataFetchInValueHelpDialog is false", function() {
			this.oValueHelpProvider.preventInitialDataFetchInValueHelpDialog = false;
			sinon.spy(this.oValueHelpProvider, "_rebindTable");
			oValueHelpDialog._oTable = sinon.createStubInstance(sap.ui.table.Table);
			oValueHelpDialog.getTable.returns(oValueHelpDialog._oTable);			
		 	this.oValueHelpProvider._createValueHelpDialog();		
			
			this.oValueHelpProvider._onFilterBarInitialise();
			
			ok(this.oValueHelpProvider._rebindTable.calledOnce);
		});
		
		test("Shall fill the table initially, if bForceTriggerDataRetreival is true", function() {
			this.oValueHelpProvider.preventInitialDataFetchInValueHelpDialog = true;
			this.oValueHelpProvider.bForceTriggerDataRetreival = true;					
			sinon.stub(this.oValueHelpProvider, "_rebindTable");
			
			this.oValueHelpProvider._createValueHelpDialog();
			this.oValueHelpProvider._onFilterBarInitialise();
			
			ok(this.oValueHelpProvider._rebindTable.calledOnce);
		});
		
		test("Shall not fill the table initially, if bForceTriggerDataRetreival is false", function() {
			this.oValueHelpProvider.preventInitialDataFetchInValueHelpDialog = true;
			this.oValueHelpProvider.bForceTriggerDataRetreival = false;		
			sinon.stub(this.oValueHelpProvider, "_rebindTable");
			
			this.oValueHelpProvider._createValueHelpDialog();
			this.oValueHelpProvider._onFilterBarInitialise();
			
			ok(this.oValueHelpProvider._rebindTable.notCalled);
		});
		
		test("_createCollectiveSearchControls: Shall create collective search controls if additional annotations are present!", function() {
			this.oValueHelpProvider.additionalAnnotations = [{}];
			oValueHelpDialog.oSelectionTitle = sinon.createStubInstance(sap.m.Text);
			oValueHelpDialog.oSelectionButton = sinon.createStubInstance(sap.m.Button);
			this.oValueHelpProvider.oValueHelpDialog = oValueHelpDialog;
			
			this.oValueHelpProvider._createCollectiveSearchControls();
			
			strictEqual(oValueHelpDialog.oSelectionTitle.setText.calledOnce, true);
			strictEqual(oValueHelpDialog.oSelectionButton.setVisible.calledOnce, true);
			strictEqual(oValueHelpDialog.oSelectionButton.setVisible.calledWith(true), true);
		});
		
		test("_triggerAnnotationChange shall call _resolveAnnotationData & _createAdditionalValueHelpControls", function() {
			var oAnnotation = {};
			this.oValueHelpProvider.additionalAnnotations = [oAnnotation];
			oValueHelpDialog.oSelectionTitle = sinon.createStubInstance(sap.m.Text);
			this.oValueHelpProvider.oValueHelpDialog = oValueHelpDialog;
			
			sinon.spy(this.oValueHelpProvider,"_resolveAnnotationData");
			sinon.spy(this.oValueHelpProvider,"_createAdditionalValueHelpControls");
			
			this.oValueHelpProvider._triggerAnnotationChange(oAnnotation);
			
			strictEqual(oValueHelpDialog.oSelectionTitle.setText.calledOnce, true);
			strictEqual(this.oValueHelpProvider._resolveAnnotationData.calledOnce, true);
			strictEqual(this.oValueHelpProvider._resolveAnnotationData.calledWith(oAnnotation), true);
			strictEqual(this.oValueHelpProvider._createAdditionalValueHelpControls.calledOnce, true);			
		});
		
		
		module("sap.ui.comp.providers.ValueHelpProvider", {
			setup: function() {
				this.sTitle ="foo";
				this.oAnnotation={valueListEntitySetName:"Chuck",keyField:"TheKey",descriptionField:"Desc",keys:["TheKey"],valueListFields:[{name:"TheKey"},{name:"Desc"}]};
				this.oModel=sinon.createStubInstance(sap.ui.model.odata.ODataModel);
				//Set single interval
				this.isSingleIntervalRange = true;
				this.oValueHelpProvider = new sap.ui.comp.providers.ValueHelpProvider({title:this.sTitle,control: sinon.createStubInstance(sap.m.Input), aggregation:"suggestionItems",annotation:this.oAnnotation,model:this.oModel,fieldName:"foo",isSingleIntervalRange:this.isSingleIntervalRange});
				this.oValueHelpProvider._oValueHelpDialogClass = o;
			},
			teardown: function() {
				this.oValueHelpProvider.destroy();
			}
		});
		
		test("_updateInitialInterval shall be called for single Interval dialog", function() {
			var oToken = null, oData = null, sControlValue = "foo";
			
			ok(this.oValueHelpProvider.bIsSingleIntervalRange)
			
			sinon.spy(this.oValueHelpProvider,"_updateInitialInterval");
			this.oValueHelpProvider._createValueHelpDialog();			
			
			
			strictEqual(this.oValueHelpProvider._updateInitialInterval.calledOnce,true);
		});	

		test("_updateInitialInterval: Check for single Interval with equals token", function() {
			var oToken = null, oData = null, sControlValue = "foo";
			
			ok(this.oValueHelpProvider.bIsSingleIntervalRange)
			
			this.oValueHelpProvider._createValueHelpDialog();
			
			this.oValueHelpProvider.oControl.getValue.returns(sControlValue);
			this.oValueHelpProvider.oValueHelpDialog.setTokens = sinon.stub();
					
			
			this.oValueHelpProvider._updateInitialInterval();
			
			
			strictEqual(this.oValueHelpProvider.oValueHelpDialog.setTokens.calledOnce,true);
			
			oToken = this.oValueHelpProvider.oValueHelpDialog.setTokens.args[0][0][0];
			oData = oToken.data("range");
			strictEqual(oData.operation,"EQ");
			strictEqual(oData.value1,sControlValue);
		});	
		
		test("_updateInitialInterval: Check for single Interval with an interval token", function() {
			var oToken = null, oData = null, sControlValue1 = "1999", sControlValue2="2014";
			
			ok(this.oValueHelpProvider.bIsSingleIntervalRange)
			
			this.oValueHelpProvider._createValueHelpDialog();
			
			this.oValueHelpProvider.oControl.getValue.returns(sControlValue1+"-"+sControlValue2);
			this.oValueHelpProvider.oValueHelpDialog.setTokens = sinon.stub();
					
			
			this.oValueHelpProvider._updateInitialInterval();
			
			strictEqual(this.oValueHelpProvider.oValueHelpDialog.setTokens.calledOnce,true);
			
			oToken = this.oValueHelpProvider.oValueHelpDialog.setTokens.args[0][0][0];
			oData = oToken.data("range");
			strictEqual(oData.operation,"BT");
			strictEqual(oData.value1,sControlValue1);
			strictEqual(oData.value2,sControlValue2);
		});		
					
	}());
</script>
</head>
<body id="body" class="sapUiBody">
	<h1 id="qunit-header">qUnit Page for
		sap.ui.comp.providers.ValueHelpProvider</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>
	<div id="content"></div>
</body>
</html>
