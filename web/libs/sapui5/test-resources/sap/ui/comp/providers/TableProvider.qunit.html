<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>qUnit Page for sap.ui.comp.providers.TableProvider</title>

<script id="sap-ui-bootstrap" type="text/javascript"
	src="../../../../../resources/sap-ui-core.js"
	data-sap-ui-theme="sap_bluecrystal" data-sap-ui-noConflict="true"
	data-sap-ui-libs="sap.ui.comp">
	
</script>

<link rel="stylesheet" href="../../../../../resources/sap/ui/thirdparty/qunit.css"	type="text/css" media="screen" />
<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>

<script type="text/javascript">

	if(!(sap.ui.Device.browser.internet_explorer && sap.ui.Device.browser.version <= 8)) {
		jQuery.sap.require("sap.ui.qunit.qunit-coverage");
	} 		
	
	(function() {

		jQuery.sap.require("sap.ui.comp.providers.TableProvider");	
		module("sap.ui.comp.providers.TableProvider", {
			setup: function() {
				this.oTableProvider = new sap.ui.comp.providers.TableProvider({entitySet:"foo",model:undefined});
			},
			teardown: function() {
				this.oTableProvider.destroy();
			}
		});

		test("Shall be instantiable", function() {			
			ok(this.oTableProvider);
		});
		
		test("Shall contain an instance of metadata analyser", function() {			
			ok(this.oTableProvider._oMetadataAnalyser);
			strictEqual(this.oTableProvider._oMetadataAnalyser instanceof sap.ui.comp.odata.MetadataAnalyser, true);
		});
		
		test("Shall contain the Metadata for the smart table", function() {			
			ok(this.oTableProvider._aTableViewMetadata);
		});
		
		test("Shall return an array of view metadata", function() {			
			var aTableViewMetadata = this.oTableProvider.getTableViewMetadata();
			ok(aTableViewMetadata);
		});
		
		test("_initialiseMetadata shall trigger getFieldsByEntitySetName on the Metadatanalyser", function() {			
			this.oTableProvider._oMetadataAnalyser = {
				getFieldsByEntitySetName: sinon.stub(),
				getEntityTypeNameFromEntitySetName: sinon.stub(),
				getLineItemAnnotation: sinon.stub(),
				getPresentationVariantAnnotation: sinon.stub(),
				getEntityContainerAttribute: sinon.stub(),
				getTextArrangementValue: sinon.stub()
			};
			this.oTableProvider._intialiseMetadata();			
			ok(this.oTableProvider._oMetadataAnalyser.getFieldsByEntitySetName.calledOnce);
		});		
		
		test("_generateArrays shall create an array of hidden and initially visible fields ", function() {						
			this.oTableProvider._generateArrays();						
			deepEqual(this.oTableProvider._aIgnoredFields,[]);			
			deepEqual(this.oTableProvider._aInitiallyVisibleFields,[]);
			
			this.oTableProvider._sIgnoredFields = "ID,TechId,foo";
			this.oTableProvider._sInitiallyVisibleFields = "Desc,Code,bar,ColA";
			this.oTableProvider._generateArrays();			
			strictEqual(this.oTableProvider._aIgnoredFields.length,3);
			strictEqual(this.oTableProvider._aInitiallyVisibleFields.length,4);
			deepEqual(this.oTableProvider._aIgnoredFields,["ID","TechId","foo"]);
			deepEqual(this.oTableProvider._aInitiallyVisibleFields,["Desc","Code","bar","ColA"]);			
		});	
		
		test("_initialiseMetadata shall create TableViewMetadata(getTableViewMetadata()) by ignoring the fields in _aIgnoredFields", function() {
			var aBackendMetadata = [{name:"test", type:"Edm.String", visible:true},{name:"foo", type:"Edm.String", visible:true},{name:"ID", type:"Edm.String", visible:true},{name:"test1", type:"Edm.String", visible:true},{name:"test2", type:"Edm.String", visible:true},{name:"test3", type:"Edm.String", visible:true},{name:"test4", type:"Edm.String", visible:true}];
			var aResult = null;
			this.oTableProvider._oMetadataAnalyser = {
					getFieldsByEntitySetName: sinon.stub(),
					getEntityTypeNameFromEntitySetName: sinon.stub(),
					getLineItemAnnotation: sinon.stub(),
					getPresentationVariantAnnotation: sinon.stub(),
					getValueListAnnotation:sinon.stub(),
					getEntityContainerAttribute: sinon.stub(),
					getTextArrangementValue: sinon.stub()
			};
			this.oTableProvider._oMetadataAnalyser.getFieldsByEntitySetName.returns(aBackendMetadata);
			//No fields to ignore
			this.oTableProvider._intialiseMetadata();			
			
			aResult = this.oTableProvider.getTableViewMetadata();
			
			strictEqual(aResult.length, aBackendMetadata.length);			
						
			this.oTableProvider._aTableViewMetadata=[];
			
			this.oTableProvider._sIgnoredFields = "ID,TechId,foo"			
			
			this.oTableProvider._intialiseMetadata();
			//ID and foo shall be ignored!
			aResult = this.oTableProvider.getTableViewMetadata();
			
			//Result shall not contain ignored fields!
			strictEqual(aResult.length, aBackendMetadata.length - 2);			
		});
		
		test("_initialiseMetadata shall create TableViewMetadata(getTableViewMetadata()) by ignoring visible=false fields", function() {
			var aBackendMetadata = [{name:"test", type:"Edm.String", visible:true},{name:"foo", type:"Edm.String", visible:true},{name:"ID", type:"Edm.String", visible:false},{name:"test1", type:"Edm.String", visible:false},{name:"test2", type:"Edm.String", visible:true},{name:"test3", type:"Edm.String", visible:true},{name:"test4", type:"Edm.String", visible:true}];
			var aResult = null;
			this.oTableProvider._oMetadataAnalyser = {
					getFieldsByEntitySetName: sinon.stub(),
					getEntityTypeNameFromEntitySetName: sinon.stub(),
					getLineItemAnnotation: sinon.stub(),
					getPresentationVariantAnnotation: sinon.stub(),
					getValueListAnnotation:sinon.stub(),
					getEntityContainerAttribute: sinon.stub(),
					getTextArrangementValue: sinon.stub()
			};
			this.oTableProvider._oMetadataAnalyser.getFieldsByEntitySetName.returns(aBackendMetadata);
		
			
			this.oTableProvider._intialiseMetadata();
			//ID and test1 shall be ignored as they are visible=false!
			aResult = this.oTableProvider.getTableViewMetadata();
			
			//Result shall not contain visible=false fields!
			strictEqual(aResult.length, aBackendMetadata.length - 2);	
			
			//visible=false along with ignord fields
			this.oTableProvider._aTableViewMetadata=[];
			
			this.oTableProvider._sIgnoredFields = "TechId,foo"			
				
			this.oTableProvider._intialiseMetadata();
			//ID and test1 shall be ignored as they are visible=false!
			//And foo shall be ignored as it is in the ignored list!
			aResult = this.oTableProvider.getTableViewMetadata();
			
			//Result shall not contain ignored fields!
			strictEqual(aResult.length, aBackendMetadata.length - 3);
		});
		
		
		test("_initialiseMetadata shall consider LineItem annotation and mark some fields as initially visible", function() {
			var aBackendMetadata = [{name:"test", type:"Edm.String", visible:true},{name:"foo", type:"Edm.String", visible:true},{name:"ID", type:"Edm.String", visible:true},{name:"test1", type:"Edm.String", visible:true},{name:"test2", type:"Edm.String", visible:true},{name:"test3", type:"Edm.String", visible:true},{name:"test4", type:"Edm.String", visible:true}];
			var oLineItemAnnotation = {fields:["test","test2","test3","foo"], importance: {test: "High", test2: "Medium"}};			
			var aResult = null;
			
			this.oTableProvider._oMetadataAnalyser = {
					getFieldsByEntitySetName: sinon.stub(),
					getEntityTypeNameFromEntitySetName: sinon.stub(),
					getLineItemAnnotation: sinon.stub(),
					getPresentationVariantAnnotation: sinon.stub(),
					getValueListAnnotation:sinon.stub(),
					getEntityContainerAttribute: sinon.stub(),
					getTextArrangementValue: sinon.stub()
			};
			this.oTableProvider._oMetadataAnalyser.getFieldsByEntitySetName.returns(aBackendMetadata);
			this.oTableProvider._oMetadataAnalyser.getLineItemAnnotation.returns(oLineItemAnnotation);
			
			//No fields to ignore
			this.oTableProvider._intialiseMetadata();			
			
			aResult = this.oTableProvider.getTableViewMetadata();
			
			strictEqual(aResult.length, aBackendMetadata.length);
			strictEqual(aResult[0].name, "test");
			strictEqual(aResult[0].isInitiallyVisible, true);
			strictEqual(aResult[0].inResult, undefined, "inResult != true, since no PresentationVariant annotation exists");
			strictEqual(aResult[1].name, "test2");
			strictEqual(aResult[1].isInitiallyVisible, sap.ui.Device.system.desktop  || sap.ui.Device.system.tablet); // only true on desktop or tablet device
			strictEqual(aResult[1].inResult, undefined, "inResult != true, since no PresentationVariant annotation exists");
			strictEqual(aResult[2].name, "test3");
			strictEqual(aResult[2].isInitiallyVisible, true);
			strictEqual(aResult[3].name, "foo");
			strictEqual(aResult[3].isInitiallyVisible, true);
			strictEqual(aResult[4].name, "ID");
			strictEqual(aResult[4].isInitiallyVisible, false);
			strictEqual(aResult[5].name, "test1");
			strictEqual(aResult[5].isInitiallyVisible, false);		
			strictEqual(aResult[6].name, "test4");
			strictEqual(aResult[6].isInitiallyVisible, false);
			
			this.oTableProvider._aTableViewMetadata=[];			
			this.oTableProvider._sIgnoredFields = "ID,TechId,foo"			
			
			this.oTableProvider._intialiseMetadata();
			//ID and foo shall be ignored!
			aResult = this.oTableProvider.getTableViewMetadata();
			
			//Result shall not contain ignored fields!
			strictEqual(aResult.length, aBackendMetadata.length - 2);
			strictEqual(aResult[0].name, "test");
			strictEqual(aResult[0].isInitiallyVisible, true);
			strictEqual(aResult[0].inResult, undefined, "inResult != true, since no PresentationVariant annotation exists");
			strictEqual(aResult[1].name, "test2");
			strictEqual(aResult[1].isInitiallyVisible, sap.ui.Device.system.desktop || sap.ui.Device.system.tablet); // only true on desktop or tablet device
			strictEqual(aResult[2].name, "test3");
			strictEqual(aResult[2].isInitiallyVisible, true);
			strictEqual(aResult[3].name, "test1");
			strictEqual(aResult[3].isInitiallyVisible, false);			
			strictEqual(aResult[4].name, "test4");
			strictEqual(aResult[4].isInitiallyVisible, false);
			
			
			//simulating tablet, only importance high fields shall be visible			
			sap.ui.Device.system.desktop = false;			
			sap.ui.Device.system.tablet = true;
			sap.ui.Device.system.phone = false;
			this.oTableProvider._intialiseMetadata();			
			aResult = this.oTableProvider.getTableViewMetadata();			
			
			strictEqual(aResult[0].name, "test");
			strictEqual(aResult[0].isInitiallyVisible, true, "visible because of high importance");
			strictEqual(aResult[0].inResult, undefined, "inResult != true, since no PresentationVariant annotation exists");
			strictEqual(aResult[1].name, "test2");
			strictEqual(aResult[1].isInitiallyVisible, true, "visible because of medium importance");
			strictEqual(aResult[2].name, "test3");
			strictEqual(aResult[2].isInitiallyVisible, true, "visible because of default importance set to high");
			strictEqual(aResult[3].name, "test1");
			strictEqual(aResult[3].isInitiallyVisible, false);			
			strictEqual(aResult[4].name, "test4");
			strictEqual(aResult[4].isInitiallyVisible, false);
			
			//simulating phone, only importance high fields shall be visible			
			sap.ui.Device.system.desktop = false;			
			sap.ui.Device.system.tablet = false;
			sap.ui.Device.system.phone = true;
			this.oTableProvider._intialiseMetadata();			
			aResult = this.oTableProvider.getTableViewMetadata();			
			
			strictEqual(aResult[0].name, "test");
			strictEqual(aResult[0].isInitiallyVisible, true, "visible because of high importance");
			strictEqual(aResult[0].inResult, undefined, "inResult != true, since no PresentationVariant annotation exists");
			strictEqual(aResult[1].name, "test2");
			strictEqual(aResult[1].isInitiallyVisible, false, "not visible because of medium importance on phone not sufficient");
			strictEqual(aResult[2].name, "test3");
			strictEqual(aResult[2].isInitiallyVisible, true, "visible because of default importance set to high");
			strictEqual(aResult[3].name, "test1");
			strictEqual(aResult[3].isInitiallyVisible, false);			
			strictEqual(aResult[4].name, "test4");
			strictEqual(aResult[4].isInitiallyVisible, false);
			
			sap.ui.Device.system.desktop = true;
			sap.ui.Device.system.tablet = false;
			sap.ui.Device.system.phone = false;
		});		
		
		
		test("_initialiseMetadata shall first consider PresentationVariant annotation and it's LineItem annotation to mark some fields as initially visible (test for Analytical usecase)", function() {
			var aBackendMetadata = [{name:"test", type:"Edm.String", visible:true},{name:"foo", type:"Edm.String", visible:true},{name:"ID", type:"Edm.String", visible:true},{name:"test1", type:"Edm.String", visible:true},{name:"test2", type:"Edm.String", visible:true},{name:"test3", type:"Edm.String", visible:true},{name:"test4", type:"Edm.String", visible:true}];
			var oLineItemAnnotation = {fields:["test","test2","test3","foo"], importance: {test: "High", test2: "Medium"}};			
			var aResult = null;
			
			this.oTableProvider._oMetadataAnalyser = {
					getFieldsByEntitySetName: sinon.stub(),
					getEntityTypeNameFromEntitySetName: sinon.stub(),
					getLineItemAnnotation: sinon.stub(),
					getPresentationVariantAnnotation: sinon.stub(),
					getValueListAnnotation:sinon.stub(),
					getEntityContainerAttribute: sinon.stub(),
					getTextArrangementValue: sinon.stub()
			};
			this.oTableProvider._oMetadataAnalyser.getFieldsByEntitySetName.returns(aBackendMetadata);
			this.oTableProvider._oMetadataAnalyser.getPresentationVariantAnnotation.returns({lineItemAnnotation: oLineItemAnnotation, requestAtLeastFields:["ID", "foo"], sortOrderFields:[{"name": "ID", "descending": false},{"name": "foo", "descending": true}]});
			
			//Test assuming Analytical usecase
			this.oTableProvider._isAnalyticalTable = true;
			
			//No fields to ignore
			this.oTableProvider._intialiseMetadata();			
			
			aResult = this.oTableProvider.getTableViewMetadata();
			
			strictEqual(this.oTableProvider._oLineItemAnnotation, oLineItemAnnotation);
			
			strictEqual(aResult.length, aBackendMetadata.length);
			strictEqual(aResult[0].name, "test");
			strictEqual(aResult[0].isInitiallyVisible, true);
			strictEqual(aResult[1].name, "test2");
			strictEqual(aResult[1].isInitiallyVisible, true);
			strictEqual(aResult[1].inResult, undefined, "inResult != true, since not part of RequestAtLeastFields");
			strictEqual(aResult[2].name, "test3");
			strictEqual(aResult[2].isInitiallyVisible, true);
			strictEqual(aResult[3].name, "foo");
			strictEqual(aResult[3].isInitiallyVisible, true);
			strictEqual(aResult[3].sorted, true, "sorted as per SortOrder");
			strictEqual(aResult[3].sortOrder, "Descending");
			strictEqual(aResult[3].inResult, true, "inResult = true, since part of RequestAtLeastFields");
			strictEqual(aResult[4].name, "ID");
			strictEqual(aResult[4].isInitiallyVisible, false);
			strictEqual(aResult[4].sorted, true, "sorted as per SortOrder");
			strictEqual(aResult[4].sortOrder, "Ascending");
			strictEqual(aResult[4].inResult, true, "inResult = true, since part of RequestAtLeastFields");
			strictEqual(aResult[5].name, "test1");
			strictEqual(aResult[5].isInitiallyVisible, false);		
			strictEqual(aResult[6].name, "test4");
			strictEqual(aResult[6].isInitiallyVisible, false);
			
			this.oTableProvider._aTableViewMetadata=[];			
			this.oTableProvider._sIgnoredFields = "ID,TechId,foo"			
			
			this.oTableProvider._intialiseMetadata();
			//ID and foo shall be ignored!
			aResult = this.oTableProvider.getTableViewMetadata();
			
			//Result shall not contain ignored fields!
			strictEqual(aResult.length, aBackendMetadata.length - 2);
			strictEqual(aResult[0].name, "test");
			strictEqual(aResult[0].isInitiallyVisible, true);
			strictEqual(aResult[1].name, "test2");
			strictEqual(aResult[1].isInitiallyVisible, true);
			strictEqual(aResult[1].inResult, undefined, "inResult != true, since not part of RequestAtLeastFields");
			strictEqual(aResult[2].name, "test3");
			strictEqual(aResult[2].isInitiallyVisible, true);
			strictEqual(aResult[3].name, "test1");
			strictEqual(aResult[3].isInitiallyVisible, false);			
			strictEqual(aResult[4].name, "test4");
			strictEqual(aResult[4].isInitiallyVisible, false);
			
			
			//simulating tablet, only importance high fields shall be visible			
			sap.ui.Device.system.desktop = false;			
			sap.ui.Device.system.tablet = true;
			sap.ui.Device.system.phone = false;
			this.oTableProvider._intialiseMetadata();			
			aResult = this.oTableProvider.getTableViewMetadata();			
			
			strictEqual(aResult[0].name, "test");
			strictEqual(aResult[0].isInitiallyVisible, true, "visible because of high importance");
			strictEqual(aResult[1].name, "test2");
			strictEqual(aResult[1].isInitiallyVisible, true, "visible because of medium importance");
			strictEqual(aResult[1].inResult, undefined, "inResult != true, since not part of RequestAtLeastFields");
			strictEqual(aResult[2].name, "test3");
			strictEqual(aResult[2].isInitiallyVisible, true, "visible because of default importance set to high");
			strictEqual(aResult[3].name, "test1");
			strictEqual(aResult[3].isInitiallyVisible, false);			
			strictEqual(aResult[4].name, "test4");
			strictEqual(aResult[4].isInitiallyVisible, false);
			
			//simulating phone, only importance high fields shall be visible			
			sap.ui.Device.system.desktop = false;			
			sap.ui.Device.system.tablet = false;
			sap.ui.Device.system.phone = true;
			this.oTableProvider._intialiseMetadata();			
			aResult = this.oTableProvider.getTableViewMetadata();			
			
			strictEqual(aResult[0].name, "test");
			strictEqual(aResult[0].isInitiallyVisible, true, "visible because of high importance");
			strictEqual(aResult[1].name, "test2");
			strictEqual(aResult[1].isInitiallyVisible, false, "not visible because of medium importance on phone not sufficient");
			strictEqual(aResult[1].inResult, undefined, "inResult != true, since not part of RequestAtLeastFields");
			strictEqual(aResult[2].name, "test3");
			strictEqual(aResult[2].isInitiallyVisible, true, "visible because of default importance set to high");
			strictEqual(aResult[3].name, "test1");
			strictEqual(aResult[3].isInitiallyVisible, false);			
			strictEqual(aResult[4].name, "test4");
			strictEqual(aResult[4].isInitiallyVisible, false);
			
			sap.ui.Device.system.desktop = true;
			sap.ui.Device.system.tablet = false;
			sap.ui.Device.system.phone = false;
		});		
		
		test("Destroy", function() {
			equal(this.oTableProvider.bIsDestroyed, undefined);
			this.oTableProvider.destroy();
			equal(this.oTableProvider._oMetadataAnalyser, null);
			equal(this.oTableProvider._aTableViewMetadata,null);
			strictEqual(this.oTableProvider.bIsDestroyed, true);
		});
		
	}());
</script>
</head>
<body id="body" class="sapUiBody">
	<h1 id="qunit-header">qUnit Page for
		sap.ui.comp.providers.TableProvider</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>
	<div id="content"></div>
</body>
</html>
