<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<title>qUnit Page for sap.ui.comp.smartvariants.SmartVariantManagement</title>

		<script id="sap-ui-bootstrap"
			type="text/javascript"
			src="../../../../../resources/sap-ui-core.js"
			data-sap-ui-theme="sap_bluecrystal"
			data-sap-ui-noConflict="true"
			data-sap-ui-libs="sap.ui.comp">
		</script>

		<link rel="stylesheet" href="../../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen" />
		<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
		<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
		<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/qunit-coverage.js"></script>
		<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
		<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
		<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>



		<script type="text/javascript">

		/*globals QUnit, sinon*/

		(function(QUnit, sinon) {

			jQuery.sap.require("sap.ui.comp.variants.VariantItem");
			jQuery.sap.require("sap.ui.comp.smartvariants.SmartVariantManagement");
			jQuery.sap.require("sap.ui.comp.smartvariants.PersonalizableInfo");
			jQuery.sap.require("sap.ui.fl.Change");
			jQuery.sap.require("sap.ui.fl.Persistence");
			jQuery.sap.require("sap.ui.fl.Utils");
			jQuery.sap.require("sap.ui.fl.registry.Settings");
			jQuery.sap.require("sap.ui.core.Control");


			function createChangeStub(sName) {

				var oObj = {
						fileName: sName,
						fileType: "fileType",
						changeType: "changeType",
						layer: "USER",
						originalLanguage: "DE",
						texts: {
							variantName : {
								value : "",
								type : ""
							}
						},
						content: {}
				};

				var oChange = new sap.ui.fl.Change(oObj, function(){});
				sinon.stub(oChange, "isReadOnly").returns(false);
				sinon.stub(oChange, "isVariant").returns(true);

				return oChange;
			};

			function createChangeStubs() {
				var mChanges = {};
				var oChange1 = createChangeStub("1");
				sinon.stub(oChange1, "getText").returns("ONE");
				mChanges[oChange1.getId()] = oChange1;

				var oChange2 = createChangeStub("2");
				oChange2.setContent({data: "TEST", standardvariant: true});
				sinon.stub(oChange2, "getText").returns("TWO");
				mChanges[oChange2.getId()] = oChange2;

				var oChange3 = createChangeStub("3");
				oChange3.setContent({executeOnSelection: true});
				sinon.stub(oChange3, "getText").returns("THREE");
				mChanges[oChange3.getId()] = oChange3;

				return mChanges;
			};

			function fakeResolved(value) {
			    return {
			        then: function(callback, fail) {
			        	var oObj = value;
			            callback(oObj);
			        },
			        fail: function(callback) {
			            callback();
			        }
			    }
			};

			sap.ui.core.Control.extend("testing.Control", {
				metadata : {
					_sOwnerId : "testId",
						properties : {
							key: "string"
						},
						events: {
							beforeVariantSave : {},
						}
				},
				fetchVariant: function() {
					return {id: "ID", test: "TEST"};
				},
				applyVariant: function(oVariant) {
					this._applyedData = oVariant;
				},

				_getApplyedData: function() {
					return this._applyedData;
				},

				_initialized: function() {
				},

				fireBeforeVariantSave: function(s) {
					var oEvent = { context: s };
					this.fireEvent("beforeVariantSave", oEvent);
				}
			});

			function createControlInfo(oVariantManagement, sKey) {

				if (!sKey) {
					sKey = "4711";
					sinon.stub(oVariantManagement, "_handleGetChanges");
				}

				var oControl = new testing.Control( {key: sKey});
				var oPersControlInfo = new sap.ui.comp.smartvariants.PersonalizableInfo({
					type: "TYPE",
					dataSource: "DATA_SOURCE",
					keyName: "key"
				});
				oPersControlInfo.setControl(oControl);

				oVariantManagement.addPersonalizableControl(oPersControlInfo);

				return oPersControlInfo;
			};


			module("sap.ui.comp.smartvariants.SmartVariantManagement", {
				beforeEach: function() {
					this.oVariantManagement = new sap.ui.comp.smartvariants.SmartVariantManagement({showShare: true});
					sinon.stub(sap.ui.fl.Utils, "_getComponentName").returns("DUMMY");
				},
				afterEach: function() {
					this.oVariantManagement.destroy();
					sap.ui.fl.Utils._getComponentName.restore();
				}
			});


			QUnit.test("Shall be instantiable", function() {
				assert.ok(this.oVariantManagement);
			});

			QUnit.test("Exit shall be called", function() {
				var oVariantManagement = new sap.ui.comp.smartvariants.SmartVariantManagement();
				sinon.spy(oVariantManagement, "exit");
				oVariantManagement.destroy();
				assert.ok(oVariantManagement.exit.called, "expecting 'exit' to be called");
			});


			QUnit.test("check initialise", function() {

				var mChanges = createChangeStubs();
				var oPersControlInfo = createControlInfo(this.oVariantManagement);
				var oControl = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				var aArray = null;
				var fCallBack = function(oEvent) {
					aArray = oEvent.getParameters().variantKeys;
				};

				this.oVariantManagement.attachInitialise(fCallBack);

				var sContext = null;
				var fBeforeSave = function(oEvent) {
				   sContext = oEvent.getParameters().context;
				};
				oControl.attachBeforeVariantSave(fBeforeSave);

				this.oVariantManagement._oControlPromise = fakeResolved(mChanges);


				sinon.stub(this.oVariantManagement, "_getExecuteOnSelectOnStandardVariant").returns(null);
				sinon.spy(this.oVariantManagement, "getStandardVariant");
				sinon.spy(this.oVariantManagement, "_createVariantEntries");
				sinon.spy(this.oVariantManagement, "fireEvent");

				this.oVariantManagement.initialise();
				assert.equal(sContext, "STANDARD");

				assert.ok(this.oVariantManagement._createVariantEntries.called, "expecting '_createVariantEntries' to be called");
				assert.ok(this.oVariantManagement.getVariantItems());
				assert.equal(this.oVariantManagement.getVariantItems().length, 3, "expecting three entries");

				assert.ok(this.oVariantManagement.fireEvent.calledOnce, "the variant management is initialized");
				assert.ok(aArray);
				assert.equal(aArray.length,3);
				assert.equal(aArray[0], "1");
				assert.equal(aArray[1], "2");
				assert.equal(aArray[2], "3");

				assert.ok(this.oVariantManagement.getShowShare());

			});

			QUnit.test("check getVariantContent/_getExecuteOnSelection", function() {

				var mChanges = createChangeStubs();
				var oPersControlInfo = createControlInfo(this.oVariantManagement);
				var oControl = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				this.oVariantManagement._oControlPersistence._oChanges = mChanges;

				var oObj = this.oVariantManagement.getVariantContent(oControl, "2");

				assert.ok(oObj);
				assert.equal(oObj.data, "TEST");

				var v = this.oVariantManagement._getChange("2");
				equals(this.oVariantManagement._getExecuteOnSelection(v), false);

				v = this.oVariantManagement._getChange("3");
				equals(this.oVariantManagement._getExecuteOnSelection(v), true);

			});



			QUnit.test("check fetch/apply standard variant", function() {

				var oPersControlInfo = createControlInfo(this.oVariantManagement);
				var oControl = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				sinon.spy(oControl, "fetchVariant");
				sinon.spy(oControl, "applyVariant");


				sinon.stub(this.oVariantManagement, "_createVariantEntries");

				this.oVariantManagement._oControlPromise = fakeResolved({});

				sinon.stub(this.oVariantManagement, "_getExecuteOnSelectOnStandardVariant").returns(null);

				this.oVariantManagement.initialise(); //fetch


				this.oVariantManagement.fireSelect({key : this.oVariantManagement.STANDARDVARIANTKEY}); //apply

				assert.ok(oControl.fetchVariant.calledOnce);
				assert.ok(oControl.applyVariant.calledOnce);

				var oObj = oControl._getApplyedData();
				equals(oObj.id, "ID");
				equals(oObj.test, "TEST");


			});

			QUnit.test("check fireSave", function() {
				var oPersControlInfo = createControlInfo(this.oVariantManagement);
				var oControl = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				sinon.stub(this.oVariantManagement, "_newVariant");
				sinon.stub(this.oVariantManagement, "_updateVariant");
				sinon.stub(this.oVariantManagement, "_save");

				var bCalled = false;
				this.oVariantManagement.attachSave(function() {bCalled = true;});

				this.oVariantManagement.fireSave({overwrite: true, key: "1", name: "V1" });

				assert.ok(bCalled);
				assert.ok(this.oVariantManagement._updateVariant.calledOnce);
				assert.ok(!this.oVariantManagement._newVariant.called);
				assert.ok(this.oVariantManagement._save.calledOnce);

				this.oVariantManagement._newVariant.restore();
				this.oVariantManagement._updateVariant.restore();
				this.oVariantManagement._save.restore();


				sinon.stub(this.oVariantManagement, "_newVariant");
				sinon.stub(this.oVariantManagement, "_updateVariant");
				sinon.stub(this.oVariantManagement, "_save");

				var bCalled = false;
				this.oVariantManagement.fireSave({overwrite: false, key: "1", name: "V1" });
				assert.ok(bCalled);
				assert.ok(!this.oVariantManagement._updateVariant.called);
				assert.ok(this.oVariantManagement._newVariant.calledOnce);
				assert.ok(this.oVariantManagement._save.calledOnce);

			});


			QUnit.test("check fireSave with standard variant", function() {

				var oPersControlInfo = createControlInfo(this.oVariantManagement);
				var oControl = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				sinon.stub(this.oVariantManagement, "_newVariant");
				sinon.stub(this.oVariantManagement, "_updateVariant");
				sinon.stub(this.oVariantManagement, "_save");


				this.oVariantManagement.fireSave({overwrite: true, key: this.oVariantManagement.STANDARDVARIANTKEY, name: "V1" });

				assert.ok(!this.oVariantManagement._newVariant.called);
				assert.ok(!this.oVariantManagement._updateVariant.called);
				assert.ok(!this.oVariantManagement._save.called);
			});


			QUnit.test("check fireSelect", function() {

				var oPersControlInfo = createControlInfo(this.oVariantManagement);
				var oControl = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				var oVariant = {
						getContent: function() {return "CONTENT"}
				};

				sinon.stub(this.oVariantManagement, "_getChange").returns(oVariant);
				sinon.stub(this.oVariantManagement, "_applyVariant");
				sinon.stub(this.oVariantManagement, "getStandardVariant");

				this.oVariantManagement.fireSelect({key: "1" });

				assert.ok(this.oVariantManagement._applyVariant.calledOnce);
				assert.ok(!this.oVariantManagement.getStandardVariant.called);
			});


			QUnit.test("check fireSelect with standard variant", function() {
				var oPersControlInfo = createControlInfo(this.oVariantManagement);
				var oControl = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				sinon.stub(this.oVariantManagement, "_getChange");
				sinon.stub(this.oVariantManagement, "_applyVariant");
				sinon.stub(this.oVariantManagement, "getStandardVariant").returns({});

				this.oVariantManagement.fireSelect({key: this.oVariantManagement.STANDARDVARIANTKEY });

				assert.ok(this.oVariantManagement._applyVariant.calledOnce);
				assert.ok(this.oVariantManagement.getStandardVariant.calledOnce);
				assert.ok(!this.oVariantManagement._getChange.called);
			});


			QUnit.test("check fireManage", function() {

				var oPersControlInfo = createControlInfo(this.oVariantManagement);
				var oControl = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				var bManageFired = false;
				this.oVariantManagement.attachManage(function(oEvent) {
					bManageFired = true;
				});

				sinon.stub(this.oVariantManagement, "_renameVariant");
				sinon.stub(this.oVariantManagement, "_deleteVariants");
				sinon.stub(this.oVariantManagement, "_setDefaultVariantKey");
				sinon.stub(this.oVariantManagement, "_save");

				var oInfo = {
					deleted: [{key:"1"}],
					renamed: [{key: "2", name: "V1"}],
					def: [{key:"1"}]
				};

				var bCalled = false;
				this.oVariantManagement.attachSave(function() {bCalled = true;});

				this.oVariantManagement.fireManage(oInfo);

				assert.ok(!bCalled);
				assert.ok(this.oVariantManagement._renameVariant.calledOnce);
				assert.ok(this.oVariantManagement._deleteVariants.calledOnce);
				assert.ok(this.oVariantManagement._setDefaultVariantKey.calledOnce);

				assert.ok(bManageFired);
			});

			QUnit.test("check addPersonalizableControl ", function() {

				sinon.stub(this.oVariantManagement, "_handleGetChanges");

				var oControl = new testing.Control( {key: "4711"});
				var oPersControlInfo = new sap.ui.comp.smartvariants.PersonalizableInfo({
					type: "TYPE",
					dataSource: "DATA_SOURCE",
					keyName: "key"
				});
				oPersControlInfo.setControl(oControl);


				this.oVariantManagement.addPersonalizableControl(oPersControlInfo);

				assert.ok(this.oVariantManagement._oControlPersistence);
			});

			QUnit.test("check getVariantContent  ", function() {

				var mChanges = createChangeStubs();
				var oPersControlInfo = createControlInfo(this.oVariantManagement);
				var oControl = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				var oPersistence = this.oVariantManagement._oControlPersistence;
				oPersistence._oChanges = mChanges;

				var oContent = this.oVariantManagement.getVariantContent(oControl, "2");
				assert.ok(oContent);
				assert.ok(oContent.data);
				assert.equal(oContent.data,"TEST");

			});

			QUnit.test("check fireSave: _updateVariant", function() {

				var mChanges = createChangeStubs();
				var oPersControlInfo = createControlInfo(this.oVariantManagement);
				var oControl = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				var oPersistence = this.oVariantManagement._oControlPersistence;
				oPersistence._oChanges = mChanges;

				sinon.stub(oControl, "fetchVariant").returns({data: "MY TEST"});
				sinon.stub(this.oVariantManagement, "_save");

				var oItem = {
				  getExecuteOnSelection: function(sKey) { return true; }
				};

				sinon.stub(this.oVariantManagement, "getItemByKey").returns(oItem);

				var oInfo = {
						key: "2",
						overwrite: true
				};

				this.oVariantManagement.fireSave(oInfo);

				var oContent = this.oVariantManagement.getVariantContent(oControl, oInfo.key);
				assert.ok(oContent);
				assert.ok(oContent.data);
				assert.equal(oContent.data,"MY TEST");
				assert.equal(oContent.executeOnSelection, true);

				assert.ok(this.oVariantManagement._save.calledOnce);

			});

			QUnit.test("check fireSave: _newVariant ", function() {

				var mChanges = createChangeStubs();
				var oPersControlInfo = createControlInfo(this.oVariantManagement);
				var oControl = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				var oPersistence = this.oVariantManagement._oControlPersistence;
				oPersistence._oChanges = mChanges;

				sinon.stub(oControl, "fetchVariant").returns({data: "MY NEW TEST"});
				sinon.stub(this.oVariantManagement, "_save");

				sinon.stub(this.oVariantManagement, "_setDefaultVariantKey");

				var oInfo = {
						key: "oldId",
						lifecyclePackage: "PACKAGE",
						lifecycleTransportId: "TRANSPORT_ID",
						exe: true,
						def: true
				};


				var oVariantItem = new sap.ui.comp.variants.VariantItem({
						key: oInfo.key,
						lifecycleTransportId: oInfo.lifecycleTransportId,
						lifecyclePackage: oInfo.lifecyclePackage
					});
				this.oVariantManagement.addVariantItem(oVariantItem);


				this.oVariantManagement.fireSave(oInfo);

				assert.ok(oVariantItem.getKey() !== oInfo.key);

				var oContent = this.oVariantManagement.getVariantContent(oControl, oVariantItem.getKey());
				assert.ok(oContent);
				assert.ok(oContent.data);
				assert.equal(oContent.data,"MY NEW TEST");

				assert.ok(oContent.executeOnSelection);
				assert.equal(oContent.executeOnSelection, true);

				assert.ok(this.oVariantManagement._save.calledOnce);
				assert.ok(this.oVariantManagement._setDefaultVariantKey.calledOnce);

			});

			QUnit.test("check fireSave: _save", function() {

				var oPersControlInfo = createControlInfo(this.oVariantManagement);
				var oControl = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				var oPersistence = this.oVariantManagement._oControlPersistence;

				sinon.stub(oPersistence, "saveAll").returns(fakeResolved());

				this.oVariantManagement._save();

				assert.ok(oPersistence.saveAll.calledOnce);
			});

			QUnit.test("check fireManage: _deleteVariants", function() {

				var oPersControlInfo = createControlInfo(this.oVariantManagement);
				var oControl = sap.ui.getCore().getControl(oPersControlInfo.getControl());


				var sDefaultKey = null;
				this.oVariantManagement._setDefaultVariantKey = function(sKey) {
					sDefaultKey = sKey;
				}
				sinon.stub(this.oVariantManagement, "_getDefaultVariantKey").returns("2");

				var oChange = createChangeStub("1");
				var oChangeDefault = createChangeStub("2");
				var stub = sinon.stub(this.oVariantManagement, "_getChange");
				stub.withArgs("1").returns(oChange);
				stub.withArgs("2").returns(oChangeDefault);
				stub.withArgs("3").returns(oChange);

				sinon.stub(this.oVariantManagement, "_appendLifecycleInformation");

				var oInfo = {
					deleted: ["1", "2", "3"]
				};


				this.oVariantManagement.fireManage(oInfo);

				assert.ok(sDefaultKey === "");

				assert.ok(this.oVariantManagement._appendLifecycleInformation.calledThrice);
			});

			QUnit.test("check fireManage: _renameVariant", function() {

				var oPersControlInfo = createControlInfo(this.oVariantManagement);
				var oControl = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				var oChange1 = createChangeStub("1");
				var oChange2 = createChangeStub("2");
				var stub = sinon.stub(this.oVariantManagement, "_getChange");
				stub.withArgs("1").returns(oChange1);
				stub.withArgs("2").returns(oChange2);

				sinon.stub(this.oVariantManagement, "_appendLifecycleInformation");

				var oInfo = {
					renamed: [{key: "1", name:"ONE"}, {key:"2", name: "TWO"}]
				};


				this.oVariantManagement.fireManage(oInfo);

				assert.equal(oChange1.getText("variantName"), "ONE");
				assert.equal(oChange2.getText("variantName"), "TWO");
			});

			QUnit.test("check fireManage: _setExecuteOnSelections", function() {

				var oPersControlInfo = createControlInfo(this.oVariantManagement);
				var oControl = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				var oChange1 = createChangeStub("1");
				var oChange2 = createChangeStub("2");
				var stub = sinon.stub(this.oVariantManagement, "_getChange");
				stub.withArgs("1").returns(oChange1);
				stub.withArgs("2").returns(oChange2);

				sinon.stub(this.oVariantManagement, "_appendLifecycleInformation");

				var oInfo = {
					exe: [{key: "1", exe:true}, {key:"2", exe: false}]
				};


				this.oVariantManagement.fireManage(oInfo);

				assert.equal(oChange1.getContent().executeOnSelection, true);
				assert.equal(oChange2.getContent().executeOnSelection, false);
			});

			QUnit.test("check fireManage: _appendLifecycleInformation", function() {

				var oPersControlInfo = createControlInfo(this.oVariantManagement);
				var oControl = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				var oChange = createChangeStub("1");
				sinon.stub(this.oVariantManagement, "_getChange").returns(oChange);

				var oVariantItem = new sap.ui.comp.variants.VariantItem({
					key: oChange.getId(),
					lifecycleTransportId: "4711t",
					lifecyclePackage: "4711p"
				});
				this.oVariantManagement.addVariantItem(oVariantItem);
				//sap.ui.getCore().applyChanges();

				this.oVariantManagement._appendLifecycleInformation(oChange, "1");

				assert.equal(oChange.getRequest(), "4711t");

			});


			QUnit.test("check getVariantsInfo", function() {

				var mChanges = createChangeStubs();
				var oPersControlInfo = createControlInfo(this.oVariantManagement);
				var oControl = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				var oPersistence = this.oVariantManagement._oControlPersistence;
				oPersistence._oChanges = mChanges;
				oPersistence._bHasLoadedChangesFromBackend = true;

				oPersistence.getChanges = function() {
					  return(fakeResolved(mChanges));
				}

				var aVariantsInfo = null;
				var fCallBack = function(aArray) {
					aVariantsInfo = aArray;
				};

				this.oVariantManagement.getVariantsInfo(fCallBack);
				assert.ok(aVariantsInfo);
				assert.equal(aVariantsInfo.length, 3, "expecting three entries");

				assert.equal(aVariantsInfo[0].key, "1");
				assert.equal(aVariantsInfo[0].text, "ONE");

				assert.equal(aVariantsInfo[1].key, "2");
				assert.equal(aVariantsInfo[1].text, "TWO");

				assert.equal(aVariantsInfo[2].key, "3");
				assert.equal(aVariantsInfo[2].text, "THREE");

			});

			QUnit.test("check getCurrentVariantId STANDARD", function() {

				var sKey = this.oVariantManagement.getCurrentVariantId();
				assert.equal(sKey, "");
			});

			QUnit.test("check getCurrentVariantId not STANDARD", function() {

				var mChanges = createChangeStubs();
				var oPersControlInfo = createControlInfo(this.oVariantManagement);
				var oControl = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				sinon.stub(this.oVariantManagement, "_getDefaultVariantKey").returns("3");

				this.oVariantManagement._oControlPromise = fakeResolved(mChanges);

				this.oVariantManagement.initialise();


				var sKey = this.oVariantManagement.getCurrentVariantId();
				assert.equal(sKey, "3");
			});

			QUnit.test("check setCurrentVariantId STANDARD", function() {

				aArray = [];
				aArray.push({control: {}});
				sinon.stub(this.oVariantManagement, "_getAllPersonalizableControls").returns(aArray);

				this.oVariantManagement._oPersoControl = {};

				sinon.stub(this.oVariantManagement,"_applyVariant");
				sinon.stub(this.oVariantManagement,"getVariantContent").returns("STANDARD");
				var spy = sinon.spy(this.oVariantManagement, "_setSelectionByKey");
				spy.withArgs(this.oVariantManagement.STANDARDVARIANTKEY);

				this.oVariantManagement._oStandardVariant = {};
				this.oVariantManagement._bIsInitialized = true;

				this.oVariantManagement.setCurrentVariantId("");

				assert.ok(spy.withArgs(this.oVariantManagement.STANDARDVARIANTKEY).calledOnce);
				assert.ok(this.oVariantManagement._applyVariant.calledOnce);

			});

			QUnit.test("check setCurrentVariantId not STANDARD", function() {

				var mChanges = createChangeStubs();
				var oPersControlInfo = createControlInfo(this.oVariantManagement);
				var oControl = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				var that = this;
				var fCallBack = function(oEvent) {
					that.oVariantManagement.setCurrentVariantId("2");
				};
				this.oVariantManagement.attachInitialise(fCallBack);

				sinon.stub(this.oVariantManagement, "_getDefaultVariantKey").returns("3");
				sinon.stub(this.oVariantManagement, "_getChangeContent").withArgs("2").returns({});

				this.oVariantManagement._oControlPromise =  fakeResolved(mChanges);

				this.oVariantManagement.initialise();

				var sKey = this.oVariantManagement.getCurrentVariantId();
				assert.equal(sKey, "2");
			});


			QUnit.test("check _setErrorValueState", function() {

				assert.ok(this.oVariantManagement.getEnabled());

				this.oVariantManagement._setErrorValueState("TEXT");

				assert.ok(!this.oVariantManagement.getEnabled());

			});


			QUnit.test("check initialise with app variant", function() {

				var mChanges = createChangeStubs();
				var oPersControlInfo = createControlInfo(this.oVariantManagement);
				var oControl = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				var aArray = null;
				var fCallBack = function(oEvent) {
					aArray = oEvent.getParameters().variantKeys;
				};

				this.oVariantManagement.attachInitialise(fCallBack);


				var oSettings = { isKeyUser: function() {return true;} };

				this.oVariantManagement._oControlPromise = fakeResolved(mChanges);


				sinon.stub(this.oVariantManagement, "_isApplicationVariant").returns(true);
				sinon.stub(this.oVariantManagement, "_getChange").withArgs(oControl, "2").returns(mChanges["2"]);


				this.oVariantManagement.initialise();
				assert.ok(aArray);

				assert.ok(this.oVariantManagement.getStandardVariantKey(), "2");

			});

			QUnit.test("check initialise with app variant and merging", function() {

				var mChanges = createChangeStubs();
				var oPersControlInfo = createControlInfo(this.oVariantManagement);
				var oControl = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				var aArray = null;
				var fCallBack = function(oEvent) {
					aArray = oEvent.getParameters().variantKeys;
				};

				this.oVariantManagement.attachInitialise(fCallBack);

				var oSettings = { isKeyUser: function() {return true;} };

				this.oVariantManagement._oControlPromise = fakeResolved(mChanges);

				sinon.stub(this.oVariantManagement, "_isApplicationVariant").returns(true);
				sinon.stub(this.oVariantManagement, "_getChange").withArgs(oControl, "2").returns(mChanges["2"]);

				this.oVariantManagement.initialise();
				assert.ok(aArray);

				assert.ok(this.oVariantManagement.getStandardVariantKey(), "2");
			});

			QUnit.test("check _createVariantEntries without standard variant flag", function() {

				var bStdVariant, mChanges = createChangeStubs();

				sinon.stub(this.oVariantManagement, "_getExecuteOnSelection").returns(false);
				sinon.stub(this.oVariantManagement, "_isApplicationVariant").returns(false);


				var oCurrentControlInfo = {control: {}};
				var aVariants = this.oVariantManagement._createVariantEntries(mChanges, oCurrentControlInfo);
				ok(aVariants);
				equal(aVariants.length, 3);

				ok(!oCurrentControlInfo.standardvariantkey);
			});

			QUnit.test("check _createVariantEntries with standard variant flag in a non template app", function() {

				var bStdVariant, mChanges = createChangeStubs();

				sinon.stub(this.oVariantManagement, "_getExecuteOnSelection").returns(false);
				sinon.stub(this.oVariantManagement, "_isComponentTemplate").returns(false);


				var oCurrentControlInfo = {control: {}};
				var aVariants = this.oVariantManagement._createVariantEntries(mChanges, oCurrentControlInfo);
				ok(aVariants);
				equal(aVariants.length, 3);

				ok(!oCurrentControlInfo.standardvariantkey);
			});


			QUnit.test("check _createVariantEntries with standard variant flag in a template app", function() {

				var bStdVariant, mChanges = createChangeStubs();

				sinon.stub(this.oVariantManagement, "_getExecuteOnSelection").returns(false);
				sinon.stub(this.oVariantManagement, "_isComponentTemplate").returns(true);

				this.oVariantManagement._oPersoControl = {};

				var oCurrentControlInfo = {control: {}};
				var aVariants = this.oVariantManagement._createVariantEntries(mChanges, oCurrentControlInfo);
				ok(aVariants);
				equal(aVariants.length, 3);

				equal(this.oVariantManagement._sAppStandardVariantKey, "2");
			});



			QUnit.test("check isPageVariant", function() {

				ok(!this.oVariantManagement.isPageVariant());

				sinon.stub(this.oVariantManagement, "_handleGetChanges");
				this.oVariantManagement.setPersistencyKey("DUMMY");

				ok(this.oVariantManagement.isPageVariant());

			});

			QUnit.test("check initialise with page variant: count the callbacks", function() {

				sinon.stub(this.oVariantManagement, "_handleGetChanges");
				this.oVariantManagement.setPersistencyKey("DUMMY");

				sinon.stub(this.oVariantManagement, "_getExecuteOnSelectOnStandardVariant").returns(null);

				var mChanges = createChangeStubs();

				var nCount = 0;

				var oPersControlInfo = createControlInfo(this.oVariantManagement, "4711");
				var oControl1 = sap.ui.getCore().getControl(oPersControlInfo.getControl());
				oControl1.fCallback = function(oEvent) {++nCount; };

				oPersControlInfo = createControlInfo(this.oVariantManagement, "4712");
				var oControl2 = sap.ui.getCore().getControl(oPersControlInfo.getControl());
				oControl2.fCallback = function(oEvent) {++nCount;};

				this.oVariantManagement._oControlPromise = fakeResolved(mChanges);

				this.oVariantManagement.initialise(oControl1.fCallback, oControl1);
				this.oVariantManagement.initialise(oControl2.fCallback, oControl2);

				equal(nCount, 2);
			});


			QUnit.test("check initialise with page variant: later registry; early data retrieval", function() {

				sinon.stub(this.oVariantManagement, "_handleGetChanges");
				this.oVariantManagement.setPersistencyKey("DUMMY");
				sinon.stub(this.oVariantManagement, "_getExecuteOnSelectOnStandardVariant").returns(null);

				var nCount = 0;
				var mChanges = createChangeStubs();
				this.oVariantManagement._oControlPromise = fakeResolved(mChanges);

				var oPersControlInfo = createControlInfo(this.oVariantManagement, "4711");
				var oControl1 = sap.ui.getCore().getControl(oPersControlInfo.getControl());
				oControl1.fCallback = function(oEvent) {++nCount;};

				this.oVariantManagement.initialise(oControl1.fCallback, oControl1);
				equal(nCount, 1);

				oPersControlInfo = createControlInfo(this.oVariantManagement, "4712");
				var oControl2 = sap.ui.getCore().getControl(oPersControlInfo.getControl());
				oControl2.fCallback = function(oEvent) {++nCount };


				this.oVariantManagement.initialise(oControl2.fCallback, oControl2);

				equal(nCount, 2);
			});

			QUnit.test("check initialise with page variant: later registry; late data retrieval", function(assert) {

				sinon.stub(sap.ui.fl.Persistence.prototype,"_createLrepConnector");
				this.oVariantManagement.setPersistencyKey("DUMMY");

				sinon.stub(this.oVariantManagement, "_getExecuteOnSelectOnStandardVariant").returns(null);

				var nCount = 0;
				var mChanges = createChangeStubs();

				var oPersControlInfo = createControlInfo(this.oVariantManagement, "4711");
				var oControl1 = sap.ui.getCore().getControl(oPersControlInfo.getControl());
				oControl1.fCallback = function(oEvent) {++nCount;};

				this.oVariantManagement.initialise(oControl1.fCallback, oControl1);
				equal(nCount, 0);

				oPersControlInfo = createControlInfo(this.oVariantManagement, "4712");
				var oControl2 = sap.ui.getCore().getControl(oPersControlInfo.getControl());
				oControl2.fCallback = function(oEvent) {++nCount;};

				this.oVariantManagement.initialise(oControl2.fCallback, oControl2);
				equal(nCount, 0);

				var oStub = sinon.stub(this.oVariantManagement._oControlPersistence, "getChanges").returns(Promise.resolve(mChanges));
				this.oVariantManagement._oControlPromise.then(function() {
					equal(nCount, 2);
					assert.async();
				});

			});


			QUnit.test("check initialise with page variant: STANDARD", function() {

				sinon.stub(this.oVariantManagement, "_handleGetChanges");
				this.oVariantManagement.setPersistencyKey("DUMMY");

				sinon.stub(this.oVariantManagement, "_getExecuteOnSelectOnStandardVariant").returns(null);

				var mChanges = createChangeStubs();
				this.oVariantManagement._oControlPromise = fakeResolved(mChanges);

				var oStdCtr1 = {
								  a: "A",
								  b: "B",
								  c: "C"
								};

				var oStdCtr2 = {
								  y: "Y",
								  z: "Z"
								};

				var oPersControlInfo = createControlInfo(this.oVariantManagement, "4711");
				var oControl1 = sap.ui.getCore().getControl(oPersControlInfo.getControl());
				oControl1.fCallback = function() {};
				sinon.stub(oControl1, "fetchVariant").returns(oStdCtr1);


				oPersControlInfo = createControlInfo(this.oVariantManagement, "4712");
				var oControl2 = sap.ui.getCore().getControl(oPersControlInfo.getControl());
				oControl2.fCallback = function() {};
				sinon.stub(oControl2, "fetchVariant").returns(oStdCtr2);

				this.oVariantManagement.initialise(oControl1.fCallback, oControl1);
				this.oVariantManagement.initialise(oControl2.fCallback, oControl2);

				var oExpectResult = {};
				oExpectResult[this.oVariantManagement._getControlPersKey(oControl1)] = oStdCtr1;
				oExpectResult[this.oVariantManagement._getControlPersKey(oControl2)] = oStdCtr2;

				var oResult = this.oVariantManagement.getStandardVariant();
				strictEqual(JSON.stringify(oResult), JSON.stringify(oExpectResult));
				strictEqual(this.oVariantManagement.getStandardVariant(oControl1), oStdCtr1);
				strictEqual(this.oVariantManagement.getStandardVariant(oControl2), oStdCtr2);

			});

			QUnit.test("check initialise with page variant: APP STANDARD", function() {

				sinon.stub(this.oVariantManagement, "_handleGetChanges");
				this.oVariantManagement.setPersistencyKey("DUMMY");

				sinon.stub(this.oVariantManagement, "_getExecuteOnSelectOnStandardVariant").returns(null);

				var bStdVariant, mChanges = createChangeStubs();


				var oStdCtr1 = {
								  a: "A",
								  b: "B",
								  c: "C"
								};

				var oStdCtr2 = {
								  y: "Y",
								  z: "Z"
								};

				sinon.stub(this.oVariantManagement, "_getExecuteOnSelection").returns(false);
				sinon.stub(this.oVariantManagement, "_isComponentTemplate").returns(true);


				var oPersControlInfo = createControlInfo(this.oVariantManagement, "4711");
				var oControl1 = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				oPersControlInfo = createControlInfo(this.oVariantManagement, "4712");
				var oControl2 = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				var oAppStandard = {};
				oAppStandard[this.oVariantManagement._getControlPersKey(oControl1)] = oStdCtr1;
				oAppStandard[this.oVariantManagement._getControlPersKey(oControl2)] = oStdCtr2;

				sinon.stub(this.oVariantManagement, "_getChangeContent").returns(oAppStandard);

				this.oVariantManagement._oControlPromise = fakeResolved(mChanges);

				this.oVariantManagement.initialise(oControl1._initialized, oControl1);
				this.oVariantManagement.initialise(oControl2._initialized, oControl2);

				equal(this.oVariantManagement._sAppStandardVariantKey, "2");
				equal(this.oVariantManagement.getDefaultVariantKey(), "2");


				var oResult = this.oVariantManagement.getStandardVariant();
				strictEqual(JSON.stringify(oResult), JSON.stringify(oAppStandard));
				strictEqual(this.oVariantManagement.getStandardVariant(oControl1), oStdCtr1);
				strictEqual(this.oVariantManagement.getStandardVariant(oControl2), oStdCtr2);
			});

			QUnit.test("check initialise with page variant: apply", function() {

				sinon.stub(this.oVariantManagement, "_handleGetChanges");
				this.oVariantManagement.setPersistencyKey("DUMMY");

				var mChanges = createChangeStubs();
				this.oVariantManagement._oControlPromise = fakeResolved(mChanges);

				var oStdCtr1 = {
								  a: "A",
								  b: "B",
								  c: "C"
								};

				var oStdCtr2 = {
								  y: "Y",
								  z: "Z"
								};

				var oPersControlInfo = createControlInfo(this.oVariantManagement, "4711");
				var oControl1 = sap.ui.getCore().getControl(oPersControlInfo.getControl());
				sinon.spy(oControl1, "applyVariant");


				oPersControlInfo = createControlInfo(this.oVariantManagement, "4712");
				var oControl2 = sap.ui.getCore().getControl(oPersControlInfo.getControl());
				sinon.spy(oControl2, "applyVariant");

				this.oVariantManagement.initialise(oControl1._initialized, oControl1);
				this.oVariantManagement.initialise(oControl2._initialized, oControl2);

				var oApplyData = {};
				oApplyData[this.oVariantManagement._getControlPersKey(oControl1)] = oStdCtr1;
				oApplyData[this.oVariantManagement._getControlPersKey(oControl2)] = oStdCtr2;

				this.oVariantManagement._applyVariants(oApplyData);

				ok(oControl1.applyVariant.calledOnce);
				ok(oControl2.applyVariant.calledOnce);

				strictEqual(oControl1._getApplyedData(), oStdCtr1);
				strictEqual(oControl2._getApplyedData(), oStdCtr2);

			});

			QUnit.test("check initialise with page variant: fetch", function() {

				sinon.stub(this.oVariantManagement, "_handleGetChanges");
				this.oVariantManagement.setPersistencyKey("DUMMY");

				sinon.stub(this.oVariantManagement, "_getExecuteOnSelectOnStandardVariant").returns(null);

				var mChanges = createChangeStubs();
				this.oVariantManagement._oControlPromise = fakeResolved(mChanges);

				var oStdCtr1 = {
								  a: "A",
								  b: "B",
								  c: "C"
								};

				var oStdCtr2 = {
								  y: "Y",
								  z: "Z"
								};

				var oPersControlInfo = createControlInfo(this.oVariantManagement, "4711");
				var oControl1 = sap.ui.getCore().getControl(oPersControlInfo.getControl());
				sinon.stub(oControl1, "fetchVariant").returns(oStdCtr1);

				oPersControlInfo = createControlInfo(this.oVariantManagement, "4712");
				var oControl2 = sap.ui.getCore().getControl(oPersControlInfo.getControl());
				sinon.stub(oControl2, "fetchVariant").returns(oStdCtr2);

				this.oVariantManagement.initialise(oControl1._initialized, oControl1);
				this.oVariantManagement.initialise(oControl2._initialized, oControl2);


				var oResult = this.oVariantManagement._fetchContent();

				var oExpectResult = {};
				oExpectResult[this.oVariantManagement._getControlPersKey(oControl1)] = oStdCtr1;
				oExpectResult[this.oVariantManagement._getControlPersKey(oControl2)] = oStdCtr2;

				strictEqual(JSON.stringify(oResult), JSON.stringify(oExpectResult));

				ok(oControl1.fetchVariant.calledTwice);  // 2x because of Standard
				ok(oControl2.fetchVariant.calledTwice);

			});

			QUnit.test("check initialise with page variant: STANDARD - one perso; backward compatible", function() {

				sinon.stub(this.oVariantManagement, "_handleGetChanges");
				this.oVariantManagement.setPersistencyKey("DUMMY");

				sinon.stub(this.oVariantManagement, "_getExecuteOnSelectOnStandardVariant").returns(null);

				var mChanges = createChangeStubs();
				this.oVariantManagement._oControlPromise = fakeResolved(mChanges);

				var oStdCtr1 = {
								  a: "A",
								  b: "B",
								  c: "C"
								};

				var oPersControlInfo = createControlInfo(this.oVariantManagement, "DUMMY");
				var oControl1 = sap.ui.getCore().getControl(oPersControlInfo.getControl());
				oControl1.fCallback = function() {};
				sinon.stub(oControl1, "fetchVariant").returns(oStdCtr1);


				this.oVariantManagement.initialise(oControl1.fCallback, oControl1);

				var oExpectResult = oStdCtr1;

				var oResult = this.oVariantManagement.getStandardVariant();
				strictEqual(JSON.stringify(oResult), JSON.stringify(oExpectResult));
				strictEqual(this.oVariantManagement.getStandardVariant(oControl1), oStdCtr1);
			});

			QUnit.test("check initialise with page variant: APP STANDARD - one perso; backward compatible", function() {

				sinon.stub(this.oVariantManagement, "_handleGetChanges");
				this.oVariantManagement.setPersistencyKey("DUMMY");

				sinon.stub(this.oVariantManagement, "_getExecuteOnSelectOnStandardVariant").returns(null);

				var bStdVariant, mChanges = createChangeStubs();

				var oStdCtr1 = {
								  a: "A",
								  b: "B",
								  c: "C"
								};

				sinon.stub(this.oVariantManagement, "_getExecuteOnSelection").returns(false);
				sinon.stub(this.oVariantManagement, "_isComponentTemplate").returns(true);


				var oPersControlInfo = createControlInfo(this.oVariantManagement, "DUMMY");
				var oControl1 = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				var oAppStandard = oStdCtr1;


				sinon.stub(this.oVariantManagement, "_getChangeContent").returns(oAppStandard);

				this.oVariantManagement._oControlPromise = fakeResolved(mChanges);

				this.oVariantManagement.initialise(oControl1._initialized, oControl1);

				equal(this.oVariantManagement._sAppStandardVariantKey, "2");
				equal(this.oVariantManagement.getDefaultVariantKey(), "2");


				var oResult = this.oVariantManagement.getStandardVariant();
				strictEqual(JSON.stringify(oResult), JSON.stringify(oAppStandard));
				strictEqual(this.oVariantManagement.getStandardVariant(oControl1), oStdCtr1);
			});

			QUnit.test("check initialise with page variant: apply  - one perso; backward compatible", function() {

				sinon.stub(this.oVariantManagement, "_handleGetChanges");
				this.oVariantManagement.setPersistencyKey("DUMMY");

				var mChanges = createChangeStubs();
				this.oVariantManagement._oControlPromise = fakeResolved(mChanges);

				var oStdCtr1 = {
								  a: "A",
								  b: "B",
								  c: "C"
								};

				var oPersControlInfo = createControlInfo(this.oVariantManagement, "DUMMY");
				var oControl1 = sap.ui.getCore().getControl(oPersControlInfo.getControl());
				sinon.spy(oControl1, "applyVariant");

				this.oVariantManagement.initialise(oControl1._initialized, oControl1);

				var oApplyData = oStdCtr1;

				this.oVariantManagement._applyVariants(oApplyData);

				ok(oControl1.applyVariant.calledOnce);

				strictEqual(oControl1._getApplyedData(), oStdCtr1);
			});

			QUnit.test("check initialise with page variant: fetch  - one perso; backward compatible", function() {

				sinon.stub(this.oVariantManagement, "_handleGetChanges");
				this.oVariantManagement.setPersistencyKey("DUMMY");

				sinon.stub(this.oVariantManagement, "_getExecuteOnSelectOnStandardVariant").returns(null);

				var mChanges = createChangeStubs();
				this.oVariantManagement._oControlPromise = fakeResolved(mChanges);

				var oStdCtr1 = {
								  a: "A",
								  b: "B",
								  c: "C"
								};

				var oPersControlInfo = createControlInfo(this.oVariantManagement, "DUMMY");
				var oControl1 = sap.ui.getCore().getControl(oPersControlInfo.getControl());
				sinon.stub(oControl1, "fetchVariant").returns(oStdCtr1);

				this.oVariantManagement.initialise(oControl1._initialized, oControl1);

				var oResult = this.oVariantManagement._fetchContent();

				var oExpectResult = oStdCtr1;

				strictEqual(JSON.stringify(oResult), JSON.stringify(oExpectResult));

				ok(oControl1.fetchVariant.calledTwice);

			});

			QUnit.test("check fireInitialized ", function() {

				var mChanges = createChangeStubs();
				var oPersControlInfo = createControlInfo(this.oVariantManagement);
				var oControl = sap.ui.getCore().getControl(oPersControlInfo.getControl());
				oControl.fireInitialized = sinon.stub();

				this.oVariantManagement._oControlPromise = fakeResolved(mChanges);

				sinon.stub(this.oVariantManagement, "_getChange");

				this.oVariantManagement.initialise();
				assert.ok(aArray);

				assert.ok(oControl.fireInitialized.calledOnce);

			});

			QUnit.test("check _applyVariants", function() {

				sinon.stub(this.oVariantManagement, "_handleGetChanges");
				this.oVariantManagement.setPersistencyKey("DUMMY");

				sinon.stub(this.oVariantManagement, "_getExecuteOnSelectOnStandardVariant").returns(null);

				sinon.stub(this.oVariantManagement, "_applyControlVariant");

				var mChanges = createChangeStubs();

				var nCount = 0;

				var oPersControlInfo = createControlInfo(this.oVariantManagement, "4711");
				var oControl1 = sap.ui.getCore().getControl(oPersControlInfo.getControl());
				oControl1.fCallback = function(oEvent) {};

				oPersControlInfo = createControlInfo(this.oVariantManagement, "4712");
				var oControl2 = sap.ui.getCore().getControl(oPersControlInfo.getControl());
				oControl2.fCallback = function(oEvent) {};

				this.oVariantManagement._oControlPromise = fakeResolved(mChanges);

				//this.oVariantManagement.initialise(oControl1.fCallback, oControl1);
				this.oVariantManagement.initialise(oControl2.fCallback, oControl2);
				this.oVariantManagement._applyVariants({}, null);
				assert.ok(this.oVariantManagement._applyControlVariant.calledOnce);

				this.oVariantManagement.initialise(oControl1.fCallback, oControl1);
				assert.ok(this.oVariantManagement._applyControlVariant.calledTwice);


				this.oVariantManagement._applyControlVariant.reset();
				this.oVariantManagement._applyVariants({}, null);
				assert.ok(this.oVariantManagement._applyControlVariant.calledTwice);

			});

			QUnit.test("check _selectVariant", function() {
				sinon.spy(this.oVariantManagement, "fireSelect");
				sinon.stub(this.oVariantManagement, "_triggerSelectVariant");

				this.oVariantManagement._oPersoControl = {};
				this.oVariantManagement._selectVariant("4711");

				ok(this.oVariantManagement.fireSelect.calledOnce);
				ok(this.oVariantManagement._triggerSelectVariant.calledOnce);

			});

			QUnit.test("check _isVariantDownport", function() {

				var mChanges = createChangeStubs();
				var oPersControlInfo = createControlInfo(this.oVariantManagement);
				var oControl = sap.ui.getCore().getControl(oPersControlInfo.getControl());

				assert.ok(this.oVariantManagement._oControlPersistence);

				sinon.stub(this.oVariantManagement._oControlPersistence, "isVariantDownport").returns(true);

				assert.ok(this.oVariantManagement._isVariantDownport());


			});

			QUnit.test("check _isReadOnly", function() {

				var bReadOnly = false;
				var oChange = {
					isReadOnly: function() {
						return bReadOnly;
					},
					getOwnerId: function() {
						return "TEST";
					}
				};
				var sUser = "TEST";
				var oUser = {
					getId: function() {
						return sUser;
					}
				}

				assert.ok(!this.oVariantManagement._isReadOnly(oChange));

				bReadOnly = true;
				sinon.stub(this.oVariantManagement, "_getUser").returns(oUser);
				assert.ok(!this.oVariantManagement._isReadOnly(oChange));

				sUser = "HUGO";
				assert.ok(this.oVariantManagement._isReadOnly(oChange));

			});

		}(QUnit, sinon));

		</script>
	</head>
	<body id="body" class="sapUiBody">
		<h1 id="qunit-header">qUnit Page for qUnit Page for sap.ui.comp.smartvariants.SmartVariantManagement</h1>
		<h2 id="qunit-banner"></h2>
		<h2 id="qunit-userAgent"></h2>
		<ol id="qunit-tests"></ol>
	</body>
</html>
