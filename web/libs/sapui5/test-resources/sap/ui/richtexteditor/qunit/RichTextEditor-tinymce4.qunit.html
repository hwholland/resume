<!DOCTYPE HTML>
<html>

<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<title>RichTextEditor - sap.ui.richtexteditor</title>

	<!-- This unit test is tailored for TinyMCE -->


	<script id="sap-ui-bootstrap" type="text/javascript" src="../../../../../resources/sap-ui-core.js" data-sap-ui-theme="sap_bluecrystal" data-sap-ui-noConflict="true" data-sap-ui-libs="sap.ui.richtexteditor, sap.m">
	</script>

	<link rel="stylesheet" href="../../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen" />
	<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
	<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
	<script type="text/javascript" src="../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
	<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
	<!--[if IE]>
	<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon-ie.js"></script>
	<![endif]-->
	<script type="text/javascript" src="../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>
	<script>
		// Enable code coverage
		jQuery.sap.require("sap.ui.qunit.qunit-coverage");

		jQuery.sap.require("sap.ui.richtexteditor.RichTextEditor");

		QUnit.config.testTimeout = 6000;

		function setLanguage(sLang) {
			sap.ui.getCore().getConfiguration().setLanguage(sLang);
			sap.ui.getCore().applyChanges();
		}



		var fnTestInitialCheck = function() {
			expect(3);
			ok(!!sap.ui.richtexteditor.RichTextEditor, "RichTextEditor class should exist");

			ok(window.tinymce === undefined, "tinymce may not be definied initially.");
			ok(window.tinyMCE === undefined, "tinyMCE may not be definied initially.");

		};

		var fnTestControlLifecycle = function(sLang) {
			expect(9);

			setLanguage(sLang);

			var oRichTextEditor1 = new sap.ui.richtexteditor.RichTextEditor("myRTE1", {
				editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
				width: "400px",
				height: "300px"
			});
			oRichTextEditor1.placeAt("rteArea1");

			sap.ui.getCore().applyChanges();

			ok(!!sap.ui.richtexteditor.RichTextEditorRenderer, "RichTextEditorRenderer class should exist");

			oRichTextEditor1.attachReady(function() {
				ok(true, "This point should be reached, which means the editor is rendered and initialized correctly.");

				ok(!!window.tinymce, "tinymce global must be definied");
				ok(!!window.tinyMCE, "tinyMCE global must be definied");

				equals(tinymce.editors.length, 1, "There must be one tinymce editor now");
				ok(!!tinymce.editors["myRTE1-textarea"], "tinymce editor 'myRTE1-textarea' must be definied");
				equals(tinymce.editors["myRTE1-textarea"].id, "myRTE1-textarea", "tinymce id must be 'myRTE1-textarea'");

				oRichTextEditor1.destroy();

				equals(tinymce.editors.length, 0, "There must be no tinymce editor now");
				ok(!tinymce.editors["myRTE1-textarea"], "tinymce editor 'myRTE1-textarea' must not be definied after destruction");

				window.setTimeout(start, 0);
			});
		};

		var fnTestControlSize = function(sLang) {
			expect(6);

			setLanguage(sLang);

			var oRichTextEditor1 = new sap.ui.richtexteditor.RichTextEditor("myRTE1", {
				editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
				width: "400px",
				height: "300px",
			});

			sap.ui.getCore().getUIArea("rteArea1").removeAllContent();
			oRichTextEditor1.placeAt("rteArea1");

			oRichTextEditor1.attachReady(function() {
				ok(!!jQuery.sap.domById("myRTE1-textarea_ifr"), "Editor Iframe exists");

				equals(tinymce.editors.length, 1, "There must be again one tinymce editor now");
				equals(jQuery.sap.domById("myRTE1").offsetWidth, 400, "Editor width should be 400px");
				equals(jQuery.sap.domById("myRTE1").offsetHeight, 300, "Editor height should be 300px");

				oRichTextEditor1.destroy();

				equals(tinymce.editors.length, 0, "There must be no tinymce editor now");
				ok(!tinymce.editors["myRTE1-textarea"], "tinymce editor 'myRTE1-textarea' must not be definied after destruction");

				window.setTimeout(start, 0);
			});
		};

		var fnTestNativeApi = function() {
			expect(7);

			var oRichTextEditor1 = new sap.ui.richtexteditor.RichTextEditor("myRTE1", {
				editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
				width: "400px",
				height: "300px"
			});
			//Cleanup UIArea because placeAt only adds new control to UIArea
			sap.ui.getCore().getUIArea("rteArea1").removeAllContent();
			oRichTextEditor1.placeAt("rteArea1");

			oRichTextEditor1.attachReady(function() {
				equals(tinymce.editors.length, 1, "There must be again one tinymce editor now");
				var oEditor = oRichTextEditor1.getNativeApi();
				equals(oEditor.id, "myRTE1-textarea", "nativeApi id must be 'myRTE1-textarea'");
				ok(oEditor === tinymce.editors[0], "nativeApi must equal the existing editor"); // equals and deepEquals gives a "too much recursion" error

				ok(!!oEditor.getContainer(), "Editor container is rendered");
				ok(!!oEditor.getBody(), "Editor body is rendered");


				oRichTextEditor1.destroy();

				equals(tinymce.editors.length, 0, "There must be no tinymce editor now");
				ok(!tinymce.editors["myRTE1-textarea"], "tinymce editor 'myRTE1-textarea' must not be definied after destruction");

				window.setTimeout(start, 0);
			});
		};

		var fnTestInitialValue = function() {
			expect(6);

			var myValue = "<p>Hello <strong>World!</strong></p>".toUpperCase();

			var oRichTextEditor1 = new sap.ui.richtexteditor.RichTextEditor("myRTE1", {
				editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
				width: "400px",
				height: "300px",
				value: myValue
			});
			oRichTextEditor1.placeAt("rteArea1");

			oRichTextEditor1.attachReady(function() {
				equals(oRichTextEditor1.getValue().toUpperCase(), myValue, "Editor should have the correct value");

				var iframe = jQuery.sap.domById("myRTE1-textarea_ifr");
				var iframeHTML = iframe.contentWindow.document.body.innerHTML;
				var instHTML = oRichTextEditor1.getNativeApi().getBody().innerHTML;
				var contentHTML = oRichTextEditor1.getNativeApi().getContent();

				// check the actual content in two ways
				equals(iframeHTML.toUpperCase(), myValue, "Editor iframe should have the correct value");
				equals(instHTML.toUpperCase(), myValue, "Editor iframe should have the correct value");
				equals(contentHTML.toUpperCase(), myValue, "Editor iframe should have the correct value");

				oRichTextEditor1.destroy();

				equals(tinymce.editors.length, 0, "There must be no tinymce editor now");
				ok(!tinymce.editors["myRTE1-textarea"], "tinymce editor 'myRTE1-textarea' must not be definied after destruction");

				window.setTimeout(start, 0);
			});
		};

		var fnTestSetValue = function() {
			expect(6);

			var myValue = "<p>Hello <strong>World!</strong></p>".toUpperCase();

			var oRichTextEditor1 = new sap.ui.richtexteditor.RichTextEditor("myRTE1", {
				editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
				width: "400px",
				height: "300px"
			});
			oRichTextEditor1.placeAt("rteArea1");

			oRichTextEditor1.attachReady(function() {
				oRichTextEditor1.setValue(myValue);
				equals(oRichTextEditor1.getValue().toUpperCase(), myValue, "Editor should immediately have the correct value");

				setTimeout(function() {
					var iframe = jQuery.sap.domById("myRTE1-textarea_ifr");
					var iframeHTML = iframe.contentWindow.document.body.innerHTML;
					var instHTML = oRichTextEditor1.getNativeApi().getBody().innerHTML;
					var contentHTML = oRichTextEditor1.getNativeApi().getContent();

					// check the actual content in two ways
					equals(iframeHTML.toUpperCase(), myValue, "Editor iframe should have the correct value");
					equals(instHTML.toUpperCase(), myValue, "Editor iframe should have the correct value");
					equals(contentHTML.toUpperCase(), myValue, "Editor iframe should have the correct value");

					oRichTextEditor1.destroy();

					equals(tinymce.editors.length, 0, "There must be no tinymce editor now");
					ok(!tinymce.editors["myRTE1-textarea"], "tinymce editor 'myRTE1-textarea' must not be definied after destruction");

					window.setTimeout(start, 0);
				}, 0);
			});
		};

		var fnTestSanitization = function() {
			expect(6);

			var myValue = "<p><span>Hello <strong>World!</strong></span><script>alert('XSS')<\/script></p>".toUpperCase();
			var mySanitizedValue = "<p>Hello <strong>World!</strong></p>".toUpperCase();
			var mySanitizedImmediateValue = "<p><span>Hello <strong>World!</strong></span></p>".toUpperCase();

			var oRichTextEditor1 = new sap.ui.richtexteditor.RichTextEditor("myRTE1", {
				editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
				width: "400px",
				height: "300px"
			});
			oRichTextEditor1.placeAt("rteArea1");

			oRichTextEditor1.attachReady(function() {
				oRichTextEditor1.setValue(myValue);
				equals(oRichTextEditor1.getValue().toUpperCase(), mySanitizedImmediateValue, "Editor should immediately have the correct (but unoptimized) value");

				setTimeout(function() {
					var iframe = jQuery.sap.domById("myRTE1-textarea_ifr");
					var iframeHTML = iframe.contentWindow.document.body.innerHTML;
					var instHTML = oRichTextEditor1.getNativeApi().getBody().innerHTML;
					var contentHTML = oRichTextEditor1.getNativeApi().getContent();

					// check the actual content in two ways
					equals(iframeHTML.toUpperCase(), mySanitizedValue, "Editor iframe should have the correct value");
					equals(instHTML.toUpperCase(), mySanitizedValue, "Editor iframe should have the correct value");
					equals(contentHTML.toUpperCase(), mySanitizedValue, "Editor iframe should have the correct value");

					oRichTextEditor1.destroy();

					equals(tinymce.editors.length, 0, "There must be no tinymce editor now");
					ok(!tinymce.editors["myRTE1-textarea"], "tinymce editor 'myRTE1-textarea' must not be definied after destruction");

					window.setTimeout(start, 0);
				}, 0);
			});
		};

		var fnTestLinkTargets = function() {
			expect(4);

			var myValue = "<p><a id='l1' href='http://www.sap.com'>link1</a><a id='l2' target='_top' href='http://www.sap.com'>link2</a></p>";

			var oRichTextEditor1 = new sap.ui.richtexteditor.RichTextEditor("myRTE1", {
				editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
				width: "400px",
				height: "300px",
				editable: false
			});
			oRichTextEditor1.placeAt("rteArea1");

			oRichTextEditor1.attachReady(function() {
				oRichTextEditor1.setValue(myValue);

				setTimeout(function() {
					var oDoc = oRichTextEditor1.getNativeApi().getDoc();

					// check the actual content in two ways
					equals(oDoc.getElementById("l1").target, "_blank", "Target should be blank");
					equals(oDoc.getElementById("l2").target, "_blank", "Target should be blank");

					oRichTextEditor1.destroy();

					equals(tinymce.editors.length, 0, "There must be no tinymce editor now");
					ok(!tinymce.editors["myRTE1-textarea"], "tinymce editor 'myRTE1-textarea' must not be definied after destruction");

					window.setTimeout(start, 0);
				}, 0);
			});
		};

		var fnTestToolbarGroups = function() {
			expect(5);

			var oRichTextEditor1 = new sap.ui.richtexteditor.RichTextEditor("myRTE1", {
				editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
				width: "400px",
				height: "300px"
			});
			oRichTextEditor1.placeAt("rteArea1");

			oRichTextEditor1.attachReady(function() {
				equals(jQuery(".mce-btn > button > .mce-i-alignjustify").length, 1, "Text justify button should be there");
				equals(jQuery(".mce-btn > button > .mce-i-emoticons").length, 0, "The smiley button should not be there");
				oRichTextEditor1.setShowGroupInsert(true);

				setTimeout(function() {
					setTimeout(function() {
					equals(jQuery(".mce-btn > button > .mce-i-emoticons").length, 1, "The smiley button should now be there");

					oRichTextEditor1.destroy();

					equals(tinymce.editors.length, 0, "There must be no tinymce editor now");
					ok(!tinymce.editors["myRTE1-textarea"], "tinymce editor 'myRTE1-textarea' must not be definied after destruction");

					window.setTimeout(start, 0);
					}, 0);
				}, 0);
			});
		};

		var fnTestPluginsNonDefault = function() {
			expect(9);

			var oRichTextEditor1 = new sap.ui.richtexteditor.RichTextEditor("myRTE1", {
				editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
				width: "400px",
				height: "300px",
				useLegacyTheme: false
			});

			oRichTextEditor1.addPlugin({
				name: "searchreplace"
			});

			oRichTextEditor1.addPlugin({
				name: "contextmenu"
			});

			oRichTextEditor1.addPlugin("preview");
			oRichTextEditor1.addPlugin("media");
			oRichTextEditor1.addButtonGroup("media");
			oRichTextEditor1.addButtonGroup("table");

			oRichTextEditor1.placeAt("rteArea1");

			oRichTextEditor1.attachReady(function() {
				// Check for loaded plugins
				ok(tinymce.PluginManager.lookup.media, "Media plugin loaded");
				ok(tinymce.PluginManager.lookup.table, "Table plugin loaded");
				equals(jQuery("#myRTE1").find(".mce-btn > button > .mce-i-media").length, 1, "Media button shown");
				equals(jQuery("#myRTE1").find(".mce-btn > button > .mce-i-table").length, 1, "Table button shown");
				ok(tinymce.PluginManager.lookup.contextmenu, "Context menu plugin loaded");
				ok(tinymce.PluginManager.lookup.searchreplace !== undefined, "Search/Replace plugin loaded");
				ok(tinymce.PluginManager.lookup.preview, "Preview plugin loaded");


				setTimeout(function() {
					oRichTextEditor1.destroy();

					equals(tinymce.editors.length, 0, "There must be no tinymce editor now");
					ok(!tinymce.editors["myRTE1-textarea"], "tinymce editor 'myRTE1-textarea' must not be definied after destruction");

					window.setTimeout(start, 0);
				}, 0);
			});
		};


		var fnTestTinyMCEPopupsForEditorInPopup = function() {
			expect(1);

			var oRichTextEditor2 = new sap.ui.richtexteditor.RichTextEditor("myRTE2", {
				editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
				width: "100%",
				height: "99%",
			});
			oRichTextEditor2.addPlugin("media");
			oRichTextEditor2.addButtonGroup("media");


			oDialog = new sap.m.Dialog("myDialog", {
				content: [oRichTextEditor2]
			});

			oDialog.open();
			oDialog.attachAfterOpen(function() {

				setTimeout(function() {
					var oButton = jQuery(".mce-ico.mce-i-media").parent();
					oButton.click();
					setTimeout(function() {

						var oTextField = jQuery(".mce-container.mce-panel.mce-floatpanel.mce-window .mce-textbox")[0];
						oTextField.focus();
						setTimeout(function() {
							equals(document.activeElement, oTextField, "The Textfield is focussed");

							oRichTextEditor2.destroy(); // Needed for phantomjs tests, as implicit destroy with the Dialog leads to DOM-access-exceptions in tinymce4
							oDialog.close();
							oDialog.attachAfterClose(function() {
								oDialog.destroy();
								start();
							});

						}, 200); // Allow time for focus
					}, 500); // Allow time for opening TinyMCE Popup
				}, 1000); // Allow time for loading/rendering TinyMCE
			});

		};



		var iNumTestedLanguages = 5;

		var oCore = sap.ui.getCore();
		var oConfig = oCore.getConfiguration();

		var aLanguages = [
			// "ar", "ar_EG", "ar_SA", "bg", "br", "ca", "cs", "da", "de", "de_AT", "de_CH", "el", "el_CY",
			// "en", "en_AU", "en_GB", "en_HK", "en_IE", "en_IN", "en_NZ", "en_PG", "en_SG", "en_ZA", "es",
			// "es_AR", "es_BO", "es_CL", "es_CO", "es_MX", "es_PE", "es_UY", "es_VE", "et", "fa", "fi", "fr",
			// "fr_BE", "fr_CA", "fr_CH", "fr_LU", "he", "hi", "hr", "hu", "id", "it", "it_CH", "ja", "ko", "lt",
			// "lv", "nb", "nl", "nl_BE", "nn", "pl", "pt", "pt_PT", "ro", "ru", "ru_UA", "sk", "sl", "sr", "sv",
			// "th", "tr", "uk", "vi", "zh_CN", "zh_HK", "zh_SG", "zh_TW"
		];


		// Add all supported languages
		for (sLang in sap.ui.richtexteditor.RichTextEditor.SUPPORTED_LANGUAGES_TINYMCE4) {
			if (sLang == "ru@petr1708") {
				// Special case not supported by UI5 Core
				continue;
			}
			aLanguages.push(sLang);
		}


		test("Initial Check", fnTestInitialCheck);
		for (var i = 0; i < aLanguages.length; ++i) {
			var sLang = aLanguages[i];

			asyncTest("Language " + sLang + ": Control Creation and Destruction", fnTestControlLifecycle.bind(this, sLang));
			asyncTest("Language " + sLang + ": Control Creation and Size", fnTestControlSize.bind(this, sLang));
		}

		asyncTest("getNativeApi", fnTestNativeApi);
		asyncTest("Check InitialValue", fnTestInitialValue);
		asyncTest("setValue", fnTestSetValue);

		asyncTest("setValue with comments", function () {
			expect(6);

			var myValue = '<!-- my comment--><p>My text</p>';
			var oRichTextEditor = new sap.ui.richtexteditor.RichTextEditor("myRTE", {
				editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
				value: myValue
			});

			var initSpy = sinon.spy(oRichTextEditor, "_initializeTinyMCE4");
			var configCbSpy = sinon.spy(oRichTextEditor, "_createConfigTinyMCE4");
			oRichTextEditor.placeAt("rteArea1");


			oRichTextEditor.attachReady(function () {
				//Assert
				ok(initSpy.callCount, "_initializeTinyMCE4 should have been called.");
				ok(!initSpy.threw(), "_initializeTinyMCE4 should not have thrown exceptions");

				ok(configCbSpy.callCount, "_initializeTinyMCE4 should have been called.");
				ok(!configCbSpy.threw(), "_initializeTinyMCE4 should not have thrown exceptions");

				setTimeout(function () {
					// Act
					oRichTextEditor.destroy();

					// Assert
					equals(tinymce.editors.length, 0, "There must be no tinymce editor now");
					ok(!tinymce.editors["myRTE1-textarea"], "tinymce editor 'myRTE1-textarea' must not be definied after destruction");

					window.setTimeout(start, 0);
				}, 0);
			});
		});

		asyncTest("setValue sanitization", fnTestSanitization);
		asyncTest("readonly link target modification", fnTestLinkTargets);
		asyncTest("Check Toolbar groups", fnTestToolbarGroups);
		asyncTest("Non-default Plugins", fnTestPluginsNonDefault);
		asyncTest("Focus in Popups in Popups", fnTestTinyMCEPopupsForEditorInPopup);

		module("Improve Coverage",

			{
				beforeEach: function() {
					this.oRichTextEditor = new sap.ui.richtexteditor.RichTextEditor("myRTE3", {
						editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
						width: "100%",
						height: "100%",
						tooltip: "Tooltip1"
					});
				},
				afterEach: function() {
					this.oRichTextEditor.destroy();
				}
			}
		)

		test("SetValue 2 times", function() {
			expect(1);
			var spySetValue = sinon.spy(this.oRichTextEditor, "setValueTinyMCE4");
			this.oRichTextEditor.setValue("TEXT");
			this.oRichTextEditor.setValue("TEXT");
			equals(spySetValue.callCount, 1, "Same value only set once.");
		});

		asyncTest("Wrapping/Required setter", function() {
			expect(1);
			var spyReinitialize = sinon.spy(this.oRichTextEditor, "reinitializeTinyMCE4");
			this.oRichTextEditor.setWrapping(false);
			this.oRichTextEditor.setRequired(true);
			setTimeout(function() {
				equals(spyReinitialize.callCount, 1, "Editor is only reinitialized once.");
				start();
			}, 0);
		});

		asyncTest("Toolbar groups setter", function() {

			var checkForVisibility = function(sAriaLabel, bVisible) {
				equals(document.querySelectorAll("#myRTE3 .mce-toolbar .mce-btn[aria-label='" + sAriaLabel + "']").length, bVisible ? 1 : 0, sAriaLabel + " visible");
			};

			expect(50);

			this.oRichTextEditor.placeAt("rteArea1");
			var aAriaLabels = ['Font Family', 'Font Sizes', 'Text color', 'Background color', //  Group Font
				'Align left', 'Align right', 'Align center', 'Justify', // Group Text Align
				'Cut', 'Copy', 'Paste', //Group Clipboard
				'Bullet list', 'Numbered list', 'Decrease indent', 'Increase indent', // Group Structure
				'Undo', 'Redo', // Group Undo
				'Insert/edit image', 'Emoticons', // Group Insert
				'Insert/edit link', 'Remove link', // Group Link
				'Bold', 'Italic', 'Underline', 'Strikethrough' // Group Font Style
			];

			var fnShowGroups = function(bVisible) {
				this.oRichTextEditor.setShowGroupFontStyle(bVisible);
				this.oRichTextEditor.setShowGroupTextAlign(bVisible);
				this.oRichTextEditor.setShowGroupStructure(bVisible);
				this.oRichTextEditor.setShowGroupFont(bVisible);
				this.oRichTextEditor.setShowGroupClipboard(bVisible);
				this.oRichTextEditor.setShowGroupInsert(bVisible);
				this.oRichTextEditor.setShowGroupLink(bVisible);
				this.oRichTextEditor.setShowGroupUndo(bVisible);
			}.bind(this);

			this.oRichTextEditor.attachReady(function(oEvent) {
				for (var i = 0; i < aAriaLabels.length; i++) {
					checkForVisibility(aAriaLabels[i], true);
				}
				fnShowGroups(false);
				setTimeout(function() {
					setTimeout(function() {
						this.oRichTextEditor._pTinyMCE4Initialized.then(function() {
							for (var i = 0; i < aAriaLabels.length; i++) {
								checkForVisibility(aAriaLabels[i], false);
							}
							start();
						})
					}.bind(this), 0);
				}.bind(this), 0);
			}.bind(this));
			fnShowGroups(true);
		});



		asyncTest("Mixed usage of TinyMCE 3 and 4", function() {
			this.oRichTextEditor.placeAt("rteArea1");
			this.oRichTextEditor.attachReady(function() {
				equals(this.oRichTextEditor.getDomRef().querySelectorAll("iframe").length, 1, "RTE instance rendered");
				equals(window.tinyMCE.majorVersion, 4, "RTE version 4");
				this.oRichTextEditor.destroy();
				this.oRichTextEditor = new sap.ui.richtexteditor.RichTextEditor("myRTE3", {
					editorType: sap.ui.richtexteditor.EditorType.TinyMCE,
					width: "100%",
					height: "100%",
					tooltip: "Tooltip1"
				});
				this.oRichTextEditor.placeAt("rteArea1");
				this.oRichTextEditor.attachReady(function() {
					equals(this.oRichTextEditor.getDomRef().querySelectorAll("iframe").length, 1, "RTE instance rendered");
					equals(window.tinyMCE.majorVersion, 3, "RTE version 3");
					this.oRichTextEditor.destroy();
					this.oRichTextEditor = new sap.ui.richtexteditor.RichTextEditor("myRTE3", {
						editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
						width: "100%",
						height: "100%",
						tooltip: "Tooltip1"
					});
					this.oRichTextEditor.placeAt("rteArea1");
					this.oRichTextEditor.attachReady(function() {
						equals(this.oRichTextEditor.getDomRef().querySelectorAll("iframe").length, 1, "RTE instance rendered");
						equals(window.tinyMCE.majorVersion, 4, "RTE version 4");
						this.oRichTextEditor.destroy();
						this.oRichTextEditor = new sap.ui.richtexteditor.RichTextEditor("myRTE3", {
							editorType: sap.ui.richtexteditor.EditorType.TinyMCE,
							width: "100%",
							height: "100%",
							tooltip: "Tooltip1"
						});
						this.oRichTextEditor.placeAt("rteArea1");
						this.oRichTextEditor.attachReady(function() {
							equals(this.oRichTextEditor.getDomRef().querySelectorAll("iframe").length, 1, "RTE instance rendered");
							equals(window.tinyMCE.majorVersion, 3, "RTE version 3");
							start();
						}.bind(this));
					}.bind(this));
				}.bind(this));
			}.bind(this));
		});

	QUnit.module("'customToolbar' property");

	QUnit.test("Lifecycle", function(assert) {
		// arrange
		var done = assert.async(),
			oRichTextEditor1 = new sap.ui.richtexteditor.RichTextEditor("myRTE1", {
				editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
				customToolbar: true,
				width: "400px",
				height: "300px"
			});

		oRichTextEditor1.placeAt("rteArea1");
		sap.ui.getCore().applyChanges();

		// assert
		assert.ok(!!sap.ui.richtexteditor.RichTextEditorRenderer, "RichTextEditorRenderer class should exist");

		oRichTextEditor1.attachReady(function() {

			// assert
			assert.ok(true, "This point should be reached, which means the editor is rendered and initialized correctly.");
			assert.ok(!!window.tinymce, "tinymce global must be definied");
			assert.ok(!!window.tinyMCE, "tinyMCE global must be definied");
			assert.equal(tinymce.editors.length, 1, "There must be one tinymce editor now");
			assert.ok(!!tinymce.editors["myRTE1-textarea"], "tinymce editor 'myRTE1-textarea' must be definied");
			assert.equal(tinymce.editors["myRTE1-textarea"].id, "myRTE1-textarea", "tinymce id must be 'myRTE1-textarea'");

			// destroy
			oRichTextEditor1.destroy();

			// assert
			assert.equal(tinymce.editors.length, 0, "There must be no tinymce editor now");
			assert.ok(!tinymce.editors["myRTE1-textarea"], "tinymce editor 'myRTE1-textarea' must not be definied after destruction");

			done();
		});
	});

	QUnit.test("customToolbar setter", function (assert) {
		var done = assert.async(3),
				oRichTextEditor = new sap.ui.richtexteditor.RichTextEditor({
					editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
					width: "100%",
					height: "300px",
					customToolbar: true,
					showGroupFont : true,
					showGroupUndo : true
				}),
				oSetCustomToolbarSpy = sinon.spy(oRichTextEditor, "setCustomToolbar"),
				oLogSpy = sinon.spy(jQuery.sap.log, "error");

		oRichTextEditor.placeAt("rteArea1");
		sap.ui.getCore().applyChanges();

		oRichTextEditor.attachReady(function() {
			oRichTextEditor._pTinyMCE4Initialized.then(function() {
				// act
				oRichTextEditor.setCustomToolbar(false);

				// assert
				assert.ok(oSetCustomToolbarSpy.calledOnce, "The setter function was called once");
				assert.ok(oLogSpy.calledOnce, "There was one error logged in the console");
				assert.ok(oRichTextEditor.getAggregation("_toolbarWrapper"), "The custom toolbar still exists");

				// destroy
				oRichTextEditor.destroy();
				oLogSpy.restore();
				done();
			});
		});
	});

	QUnit.test("SetCustomToolbar(true)", function(assert) {
		// arrange
		var done = assert.async(),
			oRichTextEditor = new sap.ui.richtexteditor.RichTextEditor("myRTE2", {
				editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
				width: "100%",
				height: "300px",
				customToolbar: true,
				showGroupFont : true,
				showGroupUndo : true
			});

		oRichTextEditor.placeAt("rteArea1");
		sap.ui.getCore().applyChanges();

		oRichTextEditor.attachReady(function() {
			// assert
			assert.equal(document.querySelectorAll("#myRTE2 .mce-toolbar").length, 0, "There should not be a native TinyMCE toolbar");

			// destroy
			oRichTextEditor.destroy();
			done();
		});
	});

	QUnit.test("SetCustomToolbar(true) with no editor type set", function(assert) {
		// arrange
		var done = assert.async(),
			oRichTextEditor = new sap.ui.richtexteditor.RichTextEditor("myRTE3", {
				width: "100%",
				height: "300px",
				customToolbar: true,
				showGroupFont : true,
				showGroupUndo : true
			});

		oRichTextEditor.placeAt("rteArea1");
		sap.ui.getCore().applyChanges();

		oRichTextEditor.attachReady(function() {
			// assert
			assert.ok(document.querySelectorAll("#myRTE3 .mceToolbar").length, "There should be a native TinyMCE toolbar");

			// destroy
			oRichTextEditor.destroy();
			done();
		});
	});

	QUnit.test("SetCustomToolbar(false)", function(assert) {
		// arrange
		var done = assert.async(),
			oRichTextEditor = new sap.ui.richtexteditor.RichTextEditor("myRTE4", {
				editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
				width: "100%",
				height: "300px",
				customToolbar: false,
				showGroupFont : true,
				showGroupUndo : true
			});

		oRichTextEditor.placeAt("rteArea1");
		sap.ui.getCore().applyChanges();

		oRichTextEditor.attachReady(function() {
			// assert
			assert.ok(document.querySelectorAll("#myRTE4 .mce-toolbar").length, "There should be a native TinyMCE toolbar");

			// destroy
			oRichTextEditor.destroy();
			done();
		});
	});

	QUnit.test("SetCustomToolbar(false) after creating a RichTextEditor with a custom toolbar", function(assert) {
		// arrange
		var done = assert.async(),
			oRichTextEditor = new sap.ui.richtexteditor.RichTextEditor("myRTE5", {
				editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
				width: "100%",
				height: "300px",
				customToolbar: true,
				showGroupFont : true,
				showGroupUndo : true
			});

		oRichTextEditor.placeAt("rteArea1");
		sap.ui.getCore().applyChanges();

		// act
		oRichTextEditor.setCustomToolbar(false);
		oRichTextEditor.setShowGroupUndo(false);

		oRichTextEditor.attachReady(function(oEvent) {
			setTimeout(function(){
				// assert
				assert.equal(document.querySelectorAll("#myRTE5 .mce-toolbar").length, 0, "The toolbar should not be changed - no native toolbar shown");
				assert.equal(document.querySelectorAll("#myRTE5 .mce-toolbar .mce-btn[aria-label='Undo']").length, false, "The native undo button should not be visible");

				// destroy
				oRichTextEditor.destroy();
				done();
			},0);
		});
	});

	QUnit.test("SetCustomToolbar(true) after creating a RichTextEditor with no custom toolbar", function(assert) {
		// arrange
		var done = assert.async(2),
				oRichTextEditor = new sap.ui.richtexteditor.RichTextEditor("myRTE5_1", {
					editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
					width: "100%",
					height: "300px",
					customToolbar: false,
					showGroupFont : true,
					showGroupUndo : true
				});

		oRichTextEditor.placeAt("rteArea1");
		sap.ui.getCore().applyChanges();

		oRichTextEditor.attachReady(function(oEvent) {
			oRichTextEditor._pTinyMCE4Initialized.then(function() {
				// act
				oRichTextEditor.setCustomToolbar(true);

				// assert
				assert.strictEqual(document.querySelectorAll("#myRTE5_1 .sapMTB").length, 0, "The toolbar should not be changed - no native toolbar shown");
				assert.ok(document.querySelectorAll("#myRTE5_1 .mce-toolbar").length, "There should be a native TinyMCE toolbar");

				// destroy
				oRichTextEditor.destroy();
				done();
			});
		});
	});

	QUnit.test("Group Visibility", function(assert) {
		// arrange
		assert.expect(42);
		var done = assert.async(42),
			oRichTextEditor = new sap.ui.richtexteditor.RichTextEditor("myRTE6", {
				editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
				width: "100%",
				height: "300px",
				customToolbar: true,
				showGroupFont: true,
				showGroupUndo: true,
				showGroupLink: true,
				showGroupInsert: true
			});

		var aAriaLabels = ['FontFamily', 'FontSize', 'TextColor', 'BackgroundColor', //  Group Font
			'TextAlign', // Group Text Align
			'Cut', 'Copy', 'Paste', //Group Clipboard
			'UnorderedList', 'OrderedList', 'Indent', 'Outdent', // Group Structure
			'Undo', 'Redo', // Group Undo
			'Bold', 'Italic', 'Underline', 'Strikethrough', // Group Font Style
			'InsertLink', 'Unlink', // Group Link
			'InsertImage' // Group Insert
		];

		oRichTextEditor.placeAt("rteArea1");
		sap.ui.getCore().applyChanges();

		var fnShowGroups = function(bVisible) {
			oRichTextEditor.setShowGroupFontStyle(bVisible);
			oRichTextEditor.setShowGroupTextAlign(bVisible);
			oRichTextEditor.setShowGroupStructure(bVisible);
			oRichTextEditor.setShowGroupFont(bVisible);
			oRichTextEditor.setShowGroupClipboard(bVisible);
			oRichTextEditor.setShowGroupUndo(bVisible);
			oRichTextEditor.setShowGroupLink(bVisible);
			oRichTextEditor.setShowGroupInsert(bVisible);
		};

		oRichTextEditor.attachReady(function(oEvent) {
			for (var i = 0; i < aAriaLabels.length; i++) {
				// assert
				assert.ok(sap.ui.getCore().byId(oRichTextEditor.getAggregation("_toolbarWrapper").getAggregation("_toolbar").getId() + "-" + aAriaLabels[i]).getVisible(), aAriaLabels[i] + " visible");
			}
			// act
			fnShowGroups(false);
			setTimeout(function() {
				setTimeout(function() {
					oRichTextEditor._pTinyMCE4Initialized.then(function() {
						for (var i = 0; i < aAriaLabels.length; i++) {
							// assert
							assert.ok(!sap.ui.getCore().byId(oRichTextEditor.getAggregation("_toolbarWrapper").getAggregation("_toolbar").getId() + "-" + aAriaLabels[i]).getVisible(), aAriaLabels[i] + " invisible");
						}
						// destroy
						oRichTextEditor.destroy();
						done();
					})
				}, 0);
			}, 0);
		});
	});

	QUnit.test("'editable: false' + 'customToolbar: true'", function(assert) {
		// arrange
		var done = assert.async(),
			oRichTextEditor = new sap.ui.richtexteditor.RichTextEditor("myRTE5", {
				editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
				editable: false,
				customToolbar: true
			});

		oRichTextEditor.placeAt("rteArea1");
		sap.ui.getCore().applyChanges();

		oRichTextEditor.attachReady(function(oEvent) {
			setTimeout(function(){
				// assert
				assert.ok(!oRichTextEditor.getAggregation("_toolbarWrapper").getAggregation("_toolbar").getEnabled(), "The toolbar should be disabled.");

				// destroy
				oRichTextEditor.destroy();
				done();
			},0);
		});
	});

	QUnit.test("'customToolbar: true' + setEditable(false)", function(assert) {
		// arrange
		var done = assert.async(),
			oRichTextEditor = new sap.ui.richtexteditor.RichTextEditor("myRTE5", {
				editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
				customToolbar: true
			});

		oRichTextEditor.placeAt("rteArea1");
		sap.ui.getCore().applyChanges();

		// act
		oRichTextEditor.setEditable(false);

		oRichTextEditor.attachReady(function(oEvent) {
			setTimeout(function(){
				// assert
				assert.ok(!oRichTextEditor.getAggregation("_toolbarWrapper").getAggregation("_toolbar").getEnabled(), "The toolbar should be disabled.");

				// destroy
				oRichTextEditor.destroy();
				done();
			},0);
		});
	});

	QUnit.test("'editable: false' + 'customToolbar: true' + setEditable(true)", function(assert) {
		// arrange
		var done = assert.async(),
			oRichTextEditor = new sap.ui.richtexteditor.RichTextEditor("myRTE5", {
				editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
				customToolbar: true,
				editable: false,
			});

		oRichTextEditor.placeAt("rteArea1");
		sap.ui.getCore().applyChanges();

		// act
		oRichTextEditor.setEditable(true);

		oRichTextEditor.attachReady(function(oEvent) {
			setTimeout(function(){
				// assert
				assert.ok(oRichTextEditor.getAggregation("_toolbarWrapper").getAggregation("_toolbar").getEnabled(), "The toolbar should be enabled.");

				// destroy
				oRichTextEditor.destroy();
				done();
			},0);
		});
	});

	QUnit.module("RTE Integrations");

	QUnit.test("RTE + Custom toolbar- XML view", function (assert) {
		//Setup
		var done = assert.async();
		var sXMLView = '<mvc:View xmlns="sap.m" xmlns:mvc="sap.ui.core.mvc" xmlns:rte="sap.ui.richtexteditor"><rte:RichTextEditor id="myRTE" editorType="TinyMCE4" customToolbar="true" /></mvc:View>'
		var oXMLContent = sap.ui.xmlview({viewContent: sXMLView});
		var oRichTextEditor = oXMLContent.byId("myRTE");
		var oRTESpy = this.spy(oRichTextEditor, "onAfterRenderingTinyMCE4");

		oXMLContent.placeAt("rteArea1");
		sap.ui.getCore().applyChanges();

		assert.expect(3);

		oRichTextEditor.attachReady(function () {
			//Assert
			assert.ok(oRichTextEditor.$().parent().attr("data-sap-ui-preserve"), "RTE's direct parent has preserve flag.");
			assert.ok(!oRichTextEditor.$().attr("data-sap-ui-preserve"), "RTE's preserve flag is removed.");
			assert.ok(!oRTESpy.threw(), "There should not be any exceptions in 'onAfterRenderingTinyMCE4'");

			//Cleanup
			oXMLContent.destroy();
			oXMLContent = null;

			done();
		});
	});

	QUnit.test("RTE available buttons in Custom Toolbar", function (assert) {
		//Setup
		var aButtons = [];
		var aCustomButtons = [];
		var done = assert.async();
		var oRTE = new sap.ui.richtexteditor.RichTextEditor("customToolbarRTE", {
			editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
			customToolbar: true,
			customButtons: [
				new sap.m.Button({id: "CustBtn1"}),
				new sap.m.Button({id: "CustBtn2"})
			]
		});
		var aAvailableButtons = [
			"Bold",
			"Italic",
			"Underline",
			"Strikethrough",
			"TextAlign",
			"FontFamily",
			"FontSize",
			"TextColor",
			"BackgroundColor",
			"UnorderedList",
			"OrderedList",
			"Outdent",
			"Indent",
			"InsertLink",
			"Unlink",
			"InsertImage",
			"Undo",
			"Redo",
			"Cut",
			"Copy",
			"Paste",
			"CustBtn1",
			"CustBtn2"
		];

		oRTE.placeAt("rteArea1");
		sap.ui.getCore().applyChanges();

		assert.expect(25); //The number of visible buttons in the Custom toolbar

		setTimeout(function () {
			//Act
			aButtons = oRTE.getAggregation("_toolbarWrapper").getAggregation("_toolbar").getContent().filter(function(oControl){
				return oControl.getMetadata().getElementName() !== "sap.ui.core.InvisibleText";
			});

			aCustomButtons = oRTE.getCustomButtons();
			aButtons.forEach(function (oButton, index) {
				assert.ok(oButton.getId().indexOf(aAvailableButtons[index]) > -1, "Position #" + index + ": " + aAvailableButtons[index]);
			});

			assert.strictEqual(aCustomButtons[0].getId(), "CustBtn1", "Custom Buttons should be retrievable also by the aggregation");
			assert.strictEqual(aCustomButtons[1].getId(), "CustBtn2", "Custom Buttons should be retrievable also by the aggregation");

			//Cleanup
			oRTE.destroy();
			done();
		});
	});

	QUnit.module("CustomButtons aggregation overwritten methods", {
		beforeEach: function () {
			this.oRichTextEditor = new sap.ui.richtexteditor.RichTextEditor("customToolbarRTE", {
				editorType: sap.ui.richtexteditor.EditorType.TinyMCE4,
				customToolbar: true
			});
			this.oRichTextEditor.placeAt("rteArea1");

			sap.ui.getCore().applyChanges();
		},
		afterEach: function () {
			this.oRichTextEditor.destroy();
		}
	});

	QUnit.test("addCustomButton", function (assert) {
		//Setup
		var done = assert.async();
		var oButton = new sap.m.Button();
		var oToolbarWrapper = this.oRichTextEditor.getAggregation("_toolbarWrapper");
		var oRTEAggregationSpy = this.spy(oToolbarWrapper, "_proxyToolbarAdd");

		assert.expect(2);

		//Act
		this.oRichTextEditor.addCustomButton(oButton);

		setTimeout(function () {
			//Assert
			assert.ok(oRTEAggregationSpy.calledWithExactly(oButton), "RTE should proxy to the Toolbar");
			assert.ok(/Bold$/ig.test(this.oRichTextEditor.getAggregation("_toolbarWrapper").getAggregation("_toolbar").getContent()[0].getId()), "RTE should proxy to the Toolbar");

			//Clean
			oButton.destroy();
			done();
		}.bind(this));
	});

	QUnit.test("destroyCustomButtons", function (assert) {
		//Setup
		var oButton = new sap.m.Button();
		var oToolbarWrapper = this.oRichTextEditor.getAggregation("_toolbarWrapper");
		var oRTEAggregationSpy = this.spy(oToolbarWrapper, "_proxyToolbarDestroy");
		var oButtonDestroySpy = this.spy(oButton, "destroy");

		//Act
		this.oRichTextEditor.addCustomButton(oButton);
		sap.ui.getCore().applyChanges();

		this.oRichTextEditor.destroyCustomButtons();
		sap.ui.getCore().applyChanges();

		//Assert
		assert.ok(oRTEAggregationSpy.calledOnce, "RTE should proxy to the ToolbarWrapper.");
		assert.deepEqual(this.oRichTextEditor.getCustomButtons(), [], "RTE aggregation should be empty after that call.");
		assert.deepEqual(oToolbarWrapper.modifyToolbarContent("get"), [], "RTE's ToolbarWrapper aggregation should be also empty.");

		assert.ok(oButtonDestroySpy.called, "Control's destructor should have been invoked.");
		assert.ok(oButton._bIsBeingDestroyed, "Control should be destroyed.");

		//Clean
		//No need to cleanup. It's been destroyed
	});

	QUnit.test("getCustomButtons", function (assert) {
		//Setup
		var oButton = new sap.m.Button(),
			oButton2 = new sap.m.Button(),
			oButton3 = new sap.m.Button();

		//Act
		this.oRichTextEditor.addCustomButton(oButton);
		this.oRichTextEditor.addCustomButton(oButton2);
		this.oRichTextEditor.addCustomButton(oButton3);

		//Assert
		assert.deepEqual(this.oRichTextEditor.getCustomButtons(), [oButton, oButton2, oButton3], "As RTE is proxy to the ToolbarWrapper, it should return only the controls set through RTE's setter");

		//Clean
		oButton.destroy();
	});

	QUnit.test("indexOfCustomButton", function (assert) {
		//Setup
		var index = null;
		var oButton = new sap.m.Button();
		var oButton2 = new sap.m.Button();
		var oToolbarWrapper = this.oRichTextEditor.getAggregation("_toolbarWrapper");
		var oRTEAggregationSpy = this.spy(oToolbarWrapper, "_proxyToolbarIndexOf");

		//Act
		this.oRichTextEditor.addCustomButton(oButton);
		this.oRichTextEditor.addCustomButton(oButton2);


		// Assert
		index = this.oRichTextEditor.indexOfCustomButton(oButton);
		assert.ok(oRTEAggregationSpy.calledWithExactly(oButton), "RTE should proxy to the Toolbar");
		assert.strictEqual(index, 0, "RTE should return the proper index according to RTE, but not to the ToolbarWrapper");


		index = this.oRichTextEditor.indexOfCustomButton(oButton2);
		assert.ok(oRTEAggregationSpy.calledWithExactly(oButton2), "RTE should proxy to the Toolbar");
		assert.strictEqual(index, 1, "RTE should return the proper index according to RTE, but not to the ToolbarWrapper");

		//Clean
		oButton.destroy();
		oButton2.destroy();
	});

	QUnit.test("insertCustomButton", function (assert) {
		//Setup
		var oButton = new sap.m.Button();
		var oButton2 = new sap.m.Button();
		var oButton3 = new sap.m.Button();
		var oToolbarWrapper = this.oRichTextEditor.getAggregation("_toolbarWrapper");
		var oRTEAggregationSpy = this.spy(oToolbarWrapper, "_proxyToolbarInsert");

		//Act
		this.oRichTextEditor.insertCustomButton(oButton);
		this.oRichTextEditor.insertCustomButton(oButton2);
		this.oRichTextEditor.insertCustomButton(oButton3, 1);

		//Assert
		assert.ok(oRTEAggregationSpy.calledWithExactly(oButton), "RTE should proxy to the Toolbar");
		assert.ok(oRTEAggregationSpy.calledWithExactly(oButton2), "RTE should proxy to the Toolbar");
		assert.ok(oRTEAggregationSpy.calledWithExactly(oButton3, 1), "RTE should proxy to the Toolbar");

		assert.strictEqual(this.oRichTextEditor.indexOfCustomButton(oButton), 0, "Button1 should be positioned properly");
		assert.strictEqual(this.oRichTextEditor.indexOfCustomButton(oButton2), 2, "Button2 should be positioned properly");
		assert.strictEqual(this.oRichTextEditor.indexOfCustomButton(oButton3), 1, "Button3 should be positioned properly");

		//Clean
		oButton.destroy();
	});

	QUnit.test("removeAllCustomButtons", function (assert) {
		//Setup
		var aRemovedCustomButtons = null;
		var oButton = new sap.m.Button();
		var oToolbarWrapper = this.oRichTextEditor.getAggregation("_toolbarWrapper");
		var oRTEAggregationSpy = this.spy(oToolbarWrapper, "_proxyToolbarRemoveAll");

		//Act
		this.oRichTextEditor.addCustomButton(oButton);
		aRemovedCustomButtons = this.oRichTextEditor.removeAllCustomButtons();

		//Assert
		assert.ok(oRTEAggregationSpy.calledOnce, "RTE should proxy to the Toolbar");
		assert.deepEqual(aRemovedCustomButtons, [oButton], "RTE should remove only the controls that were proxied.");
		assert.deepEqual(this.oRichTextEditor.getCustomButtons(), [], "RTE aggregation should be empty after that call.");
		assert.deepEqual(oToolbarWrapper.modifyToolbarContent("get"), [], "RTE's ToolbarWrapper aggregation should be also empty.");

		//Clean
		oButton.destroy();
	});

	QUnit.test("removeCustomButton", function (assert) {
		//Setup
		var aRemovedCustomButtons = null;
		var oButton = new sap.m.Button();
		var oButton2 = new sap.m.Button();
		var oButton3 = new sap.m.Button();
		var oButton4 = new sap.m.Button({id: "removeMe"});
		var oToolbarWrapper = this.oRichTextEditor.getAggregation("_toolbarWrapper");
		var oRTEAggregationSpy = this.spy(oToolbarWrapper, "_proxyToolbarRemove");

		//Act
		this.oRichTextEditor.addCustomButton(oButton);
		this.oRichTextEditor.addCustomButton(oButton2);
		this.oRichTextEditor.addCustomButton(oButton3);
		this.oRichTextEditor.addCustomButton(oButton4);
		aRemovedCustomButtons = this.oRichTextEditor.removeCustomButton(oButton);

		//Assert
		assert.ok(oRTEAggregationSpy.calledOnce, "RTE should proxy to the Toolbar");
		assert.deepEqual(aRemovedCustomButtons, oButton, "RTE should remove only the controls that were proxied.");
		assert.deepEqual(this.oRichTextEditor.getCustomButtons(), [oButton2, oButton3, oButton4], "RTE aggregation should return only the aggregated controls.");
		assert.deepEqual(oToolbarWrapper.modifyToolbarContent("get"), [oButton2, oButton3, oButton4], "RTE's ToolbarWrapper aggregation should also return the same controls.");

		// Act / Remove by ID
		aRemovedCustomButtons = this.oRichTextEditor.removeCustomButton("removeMe");

		//Assert
		assert.deepEqual(aRemovedCustomButtons, oButton4, "RTE should remove only the controls that were proxied.");
		assert.deepEqual(this.oRichTextEditor.getCustomButtons(), [oButton2, oButton3], "RTE aggregation should return only the aggregated controls.");
		assert.deepEqual(oToolbarWrapper.modifyToolbarContent("get"), [oButton2, oButton3], "RTE's ToolbarWrapper aggregation should also return the same controls.");

		// Act / Remove by index
		aRemovedCustomButtons = this.oRichTextEditor.removeCustomButton(1);

		//Assert
		assert.deepEqual(aRemovedCustomButtons, oButton3, "RTE should remove only the controls that were proxied.");
		assert.deepEqual(this.oRichTextEditor.getCustomButtons(), [oButton2], "RTE aggregation should return only the aggregated controls.");
		assert.deepEqual(oToolbarWrapper.modifyToolbarContent("get"), [oButton2], "RTE's ToolbarWrapper aggregation should also return the same controls.");


		// Act / Remove by index
		aRemovedCustomButtons = this.oRichTextEditor.removeCustomButton(99);

		//Assert
		assert.strictEqual(aRemovedCustomButtons, null, "RTE should not have removed any buttons.");
		assert.deepEqual(this.oRichTextEditor.getCustomButtons(), [oButton2], "RTE aggregation should return only the aggregated controls.");
		assert.deepEqual(oToolbarWrapper.modifyToolbarContent("get"), [oButton2], "RTE's ToolbarWrapper aggregation should also return the same controls.");


		//Clean
		oButton.destroy();
		oButton2.destroy();
		oButton3.destroy();
		oButton4.destroy();
	});


	QUnit.module("CustomButtons aggregation overwritten methods in 'native' mode", {
		beforeEach: function () {
			this.oRichTextEditor = new sap.ui.richtexteditor.RichTextEditor("customToolbarRTE", {
				editorType: sap.ui.richtexteditor.EditorType.TinyMCE4
			});
			this.oRichTextEditor.placeAt("rteArea1");

			sap.ui.getCore().applyChanges();
		},
		afterEach: function () {
			this.oRichTextEditor.destroy();
		}
	});

	QUnit.test("addCustomButton", function (assert) {
		//Setup
		var oButton = new sap.m.Button();
		var oRTEAggregationSpy = this.spy(this.oRichTextEditor, "addAggregation");

		//Act
		this.oRichTextEditor.addCustomButton(oButton);

		//Assert
		assert.ok(oRTEAggregationSpy.calledWithExactly("customButtons", oButton), "RTE should store the aggregations");

		//Clean
		oButton.destroy();
	});

	QUnit.test("destroyCustomButtons", function (assert) {
		//Setup
		var oButton = new sap.m.Button();
		var oRTEAggregationSpy = this.spy(this.oRichTextEditor, "destroyAggregation");
		var oButtonDestroySpy = this.spy(oButton, "destroy");

		//Act
		this.oRichTextEditor.addCustomButton(oButton);
		sap.ui.getCore().applyChanges();

		this.oRichTextEditor.destroyCustomButtons();
		sap.ui.getCore().applyChanges();

		//Assert
		assert.ok(oRTEAggregationSpy.calledOnce, "RTE aggregation should be destroyed.");
		assert.deepEqual(this.oRichTextEditor.getCustomButtons(), null, "RTE aggregation should be empty after that call.");

		assert.ok(oButtonDestroySpy.called, "Control's destructor should have been invoked.");
		assert.ok(oButton._bIsBeingDestroyed, "Control should be destroyed.");

		//Clean
		//No need to cleanup. It's been destroyed
	});

	QUnit.test("getCustomButtons", function (assert) {
		//Setup
		var oButton = new sap.m.Button();

		//Act
		this.oRichTextEditor.addCustomButton(oButton);

		//Assert
		assert.deepEqual(this.oRichTextEditor.getCustomButtons(), [oButton], "RTE should return the controls stored in the aggregation");

		//Clean
		oButton.destroy();
	});

	QUnit.test("indexOfCustomButton", function (assert) {
		//Setup
		var index = null;
		var oButton = new sap.m.Button();
		var oButton2 = new sap.m.Button();
		var oRTEAggregationSpy = this.spy(this.oRichTextEditor, "indexOfAggregation");

		//Act
		this.oRichTextEditor.addCustomButton(oButton);
		this.oRichTextEditor.addCustomButton(oButton2);

		// Assert
		index = this.oRichTextEditor.indexOfCustomButton(oButton);
		assert.ok(oRTEAggregationSpy.calledWithExactly("customButtons", oButton), "RTE should call indexOfAggregation.");
		assert.strictEqual(index, 0, "RTE should return the proper index.");


		index = this.oRichTextEditor.indexOfCustomButton(oButton2);
		assert.ok(oRTEAggregationSpy.calledWithExactly("customButtons", oButton2), "RTE should call indexOfAggregation.");
		assert.strictEqual(index, 1, "RTE should return the proper index.");

		//Clean
		oButton.destroy();
		oButton2.destroy();
	});

	QUnit.test("insertCustomButton", function (assert) {
		//Setup
		var oButton = new sap.m.Button();
		var oRTEAggregationSpy = this.spy(this.oRichTextEditor, "insertAggregation");

		//Act
		this.oRichTextEditor.insertCustomButton(oButton);

		//Assert
		assert.ok(oRTEAggregationSpy.calledWithExactly("customButtons", oButton), "RTE should call insertAggregation.");

		//Clean
		oButton.destroy();
	});

	QUnit.test("removeAllCustomButtons", function (assert) {
		//Setup
		var aRemovedCustomButtons = null;
		var oButton = new sap.m.Button();
		var oRTEAggregationSpy = this.spy(this.oRichTextEditor, "removeAllAggregation");

		//Act
		this.oRichTextEditor.addCustomButton(oButton);
		aRemovedCustomButtons = this.oRichTextEditor.removeAllCustomButtons();

		//Assert
		assert.ok(oRTEAggregationSpy.calledWithExactly("customButtons"), "RTE should call removeAllAggregation");
		assert.deepEqual(aRemovedCustomButtons, [oButton], "RTE should remove all the controls in that aggregation.");
		assert.deepEqual(this.oRichTextEditor.getCustomButtons(), null, "RTE aggregation should be empty after that call.");

		//Clean
		oButton.destroy();
	});

	QUnit.test("removeCustomButton", function (assert) {
		//Setup
		var oRemovedCustomButton = null;
		var oButton = new sap.m.Button();
		var oButton2 = new sap.m.Button();
		var oButton3 = new sap.m.Button();
		var oButton4 = new sap.m.Button({id: "removeMe"});
		var oRTEAggregationSpy = this.spy(this.oRichTextEditor, "removeAggregation");

		//Act
		this.oRichTextEditor.addCustomButton(oButton);
		this.oRichTextEditor.addCustomButton(oButton2);
		this.oRichTextEditor.addCustomButton(oButton3);
		this.oRichTextEditor.addCustomButton(oButton4);
		oRemovedCustomButton = this.oRichTextEditor.removeCustomButton(oButton);

		//Assert
		assert.ok(oRTEAggregationSpy.calledWithExactly("customButtons", oButton), "RTE should call removeAggregation.");
		assert.deepEqual(oRemovedCustomButton, oButton, "RTE should remove only the control that was passed as argument.");
		assert.deepEqual(this.oRichTextEditor.getCustomButtons(), [oButton2, oButton3, oButton4], "RTE aggregation should return only the aggregated controls.");

		// Act / Remove by ID
		oRemovedCustomButton = this.oRichTextEditor.removeCustomButton("removeMe");

		//Assert
		assert.deepEqual(oRemovedCustomButton, oButton4, "RTE should remove only the controls that were proxied.");
		assert.deepEqual(this.oRichTextEditor.getCustomButtons(), [oButton2, oButton3], "RTE aggregation should return only the aggregated controls.");

		// Act / Remove by index
		oRemovedCustomButton = this.oRichTextEditor.removeCustomButton(1);

		//Assert
		assert.deepEqual(oRemovedCustomButton, oButton3, "RTE should remove only the controls that were proxied.");
		assert.deepEqual(this.oRichTextEditor.getCustomButtons(), [oButton2], "RTE aggregation should return only the aggregated controls.");


		// Act / Remove by index
		oRemovedCustomButton = this.oRichTextEditor.removeCustomButton(99);

		//Assert
		assert.strictEqual(oRemovedCustomButton, null, "RTE should not have removed any buttons.");
		assert.deepEqual(this.oRichTextEditor.getCustomButtons(), [oButton2], "RTE aggregation should return only the aggregated controls.");


		//Clean
		oButton.destroy();
		oButton2.destroy();
		oButton3.destroy();
		oButton4.destroy();
	});
	</script>
	<style>
		#rteArea1 {
			position: absolute;
			top: 0;
			right: 0;
			visibility: hidden;
			display: block;
			height: 300px;
		}
	</style>
</head>

<body>
	<div id="rteArea1"></div>

	<h1 id="qunit-header">qUnit Page for RichTextEditor</h1>
	<h2 id="qunit-banner"></h2>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>
	<div id="qunit-fixture">test markup, will be hidden</div>
</body>

</html>
