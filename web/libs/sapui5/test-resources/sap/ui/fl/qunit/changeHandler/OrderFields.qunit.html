<!DOCTYPE HTML>
<html>
<head>

	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>

	<title>QUnit - sap.ui.fl.changeHandler.OrderFields</title>

	<script id="sap-ui-bootstrap" type="text/javascript"
			src="../../../../../../resources/sap-ui-core.js"
			data-sap-ui-theme="sap_bluecrystal" data-sap-ui-noconflict="true"
			data-sap-ui-libs="sap.ui.comp">
	</script>


	<link rel="stylesheet" href="../../../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen"/>
	<script type="text/javascript" src="../../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
	<script type="text/javascript" src="../../../../../../resources/sap/ui/qunit/qunit-junit.js"></script>
	<script type="text/javascript" src="../../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
	<script type="text/javascript" src="../../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
	<script type="text/javascript" src="../../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>

<script type="text/javascript">
jQuery.sap.require("sap.ui.fl.changeHandler.OrderFields");
jQuery.sap.require("sap.ui.fl.Change");
jQuery.sap.require("sap.ui.comp.smartform.Group");
jQuery.sap.require("sap.ui.comp.smartform.GroupElement");

(function (OrderFieldsChangeHandler, Change, Group, GroupElement) {

	module("sap.ui.fl.changeHandler.OrderFields", {
		setup: function () {
			this.stubs = [];
			this.oChangeHandler = new OrderFieldsChangeHandler();
		},
		teardown: function () {
			this.stubs.forEach(function (stub) {
				stub.restore();
			});
		}
	});

	test('Wrong or no control supplied to applyChange', function () {

		var oGroup;
		var sError;

		var oChangeJson = {
			"selector": {
				"id": "testkey"
			},
			"content": {
				"orderFields": ["noKey", "Key1", "Key2", "Key3"]
			},
			"texts": {
			}
		};

		var oChange = new Change(oChangeJson);

		// no control instance supplied
		try {
			this.oChangeHandler.applyChange(oChange, oGroup);
		} catch (Error) {
			sError = Error.message;
		}

		equal(sError, "No control instance or wrong control instance supplied");

		// wrong control supplied
		var oGroupElement = new GroupElement();

		sError = "";
		try {
			this.oChangeHandler.applyChange(oChange, oGroupElement);
		} catch (Error) {
			sError = Error.message;
		}

		equal(sError, "No control instance or wrong control instance supplied");

	});

	test('Invalid change supplied to applyChange', function () {

		var oGroup = new Group();
		var oControlMap = {};
		var sError;

		// test 1 - content does not contain orderFields attribute
		var oChangeJson = {
			"selector": {
				"id": "testkey1"
			},
			"content": {
			},
			"texts": {
			}
		};

		var oChange = new Change(oChangeJson, function () {
		});

		try {
			this.oChangeHandler.applyChange(oChange, oGroup);
		} catch (Error) {
			sError = Error.message;
		}

		equal(sError, "Change format invalid");

		// test 2 - orderFields array is empty
		oChangeJson = {
			"selector": {
				"id": "testkey2"
			},
			"content": {
				"orderFields": []
			},
			"texts": {
			}
		};

		oChange = new Change(oChangeJson, function(){});

		sError = "";
		try {
			this.oChangeHandler.applyChange(oChange, oGroup);
		} catch (Error) {
			sError = Error.message;
		}

		equal(sError, "Change format invalid");

		// test 3 - selector contains more than one key
		oChangeJson = {
			"selector": {
				"id": "testkey3",
				"id2": "testkey4"
			},
			"content": {
				"orderFields": ["Key1", "Key2", "Key3"]
			},
			"texts": {
			}
		};

		oChange = new Change(oChangeJson, function(){});

		sError = "";
		try {
			this.oChangeHandler.applyChange(oChange, oGroup);
		} catch (Error) {
			sError = Error.message;
		}

		equal(sError, "Change format invalid");

	});

	test('applyChange', function () {

		var oChangeJson = {
			"selector": {
				"id": "testkey5"
			},
			"content": {
				"orderFields": ["Id1", "Id2", "Id3"]
			},
			"texts": {
			}
		};

		var oChange = new Change(oChangeJson);

		var oGroup = new Group();

		var oGroupElement1 = new GroupElement("Id1");
		var oGroupElement2 = new GroupElement("Id2");
		var oGroupElement3 = new GroupElement("Id3");
		// fourth group element is not contained in change
		var oGroupElement4 = new GroupElement("Id4");

		oGroup.addGroupElement(oGroupElement2);
		oGroup.addGroupElement(oGroupElement4);
		oGroup.addGroupElement(oGroupElement3);
		oGroup.addGroupElement(oGroupElement1);

		this.oChangeHandler.applyChange(oChange, oGroup);

		var aGroupElement = oGroup.getGroupElements();

		equal(aGroupElement.length, 4);
		if (aGroupElement[0].getId) {
			equal(aGroupElement[0].getId(), "Id1");
		}
		if (aGroupElement[1].getId) {
			equal(aGroupElement[1].getId(), "Id2");
		}
		if (aGroupElement[2].getId) {
			equal(aGroupElement[2].getId(), "Id3");
		}
		if (aGroupElement[3].getId) {
			equal(aGroupElement[3].getId(), "Id4");
		}
		
		oGroup.destroyGroupElements();

	});

	test('applyChange for group without elements', function () {

		var oChangeJson = {
			"selector": {
				"id": "testkey"
			},
			"content": {
				"orderFields": ["Id1", "Id2", "Id3"]
			},
			"texts": {
			}
		};

		var oChange = new Change(oChangeJson, function () {
		});

		var oGroup = new Group();

		this.oChangeHandler.applyChange(oChange, oGroup);

		var aGroupElement = oGroup.getGroupElements();

		equal(aGroupElement.length, 0);

	});

	test('completeChangeContent', function () {

		var oChangeJson = {
			"selector": {
				"id": "testkey"
			}
		};

		var oChange = new Change(oChangeJson);

		var oSpecificChangeInfo = { orderFields: ["Id1", "Id2", "Id3"] };

		this.oChangeHandler.completeChangeContent(oChange, oSpecificChangeInfo);

		oChangeJson = oChange.getDefinition();

		equal(oChangeJson.content.orderFields.length, 3);
		equal(oChangeJson.content.orderFields[0], "Id1");
		equal(oChangeJson.content.orderFields[1], "Id2");
		equal(oChangeJson.content.orderFields[2], "Id3");

	});

}(sap.ui.fl.changeHandler.OrderFields, sap.ui.fl.Change, sap.ui.comp.smartform.Group, sap.ui.comp.smartform.GroupElement));
	</script>
</head>
<body id="body" class="sapUiBody">
<h1 id="qunit-header">qUnit Page for sap.ui.fl.changeHandler.OrderFields</h1>

<h2 id="qunit-banner"></h2>

<h2 id="qunit-userAgent"></h2>
<ol id="qunit-tests"></ol>
<div id="content"></div>
</body>
</html>
