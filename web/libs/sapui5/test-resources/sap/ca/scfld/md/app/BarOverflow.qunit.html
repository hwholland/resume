<!DOCTYPE HTML>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />

	<title>Qunit - Bar Overflow</title>

	<script src="../../../../../../resources/sap-ui-core.js"
			id="sap-ui-bootstrap"
			data-sap-ui-libs="sap.m"
			data-sap-ui-theme="sap_bluecrystal"
			data-sap-ui-xx-bindingSyntax="complex"
			data-sap-ui-noConflict="true">
	</script>

	<link rel="stylesheet" href="../../../../../../resources/sap/ui/thirdparty/qunit.css" type="text/css" media="screen" />
	<script src="../../../../../../resources/sap/ui/thirdparty/qunit.js"></script>
	<script src="../../../../../../resources/sap/ui/qunit/QUnitUtils.js"></script>
	<script src="../../../../../../resources/sap/ui/thirdparty/sinon.js"></script>
	<script src="../../../../../../resources/sap/ui/thirdparty/sinon-qunit.js"></script>

	<script>
		(function ($) {
			"use strict"

			jQuery.sap.require("sap.ca.scfld.md.app.BarOverflow");
			jQuery.sap.require("sap.ca.scfld.md.app.BarOverflowLayoutData");
			jQuery.sap.require("sap.m.Bar");
			jQuery.sap.require("sap.m.Button");
			jQuery.sap.require("sap.m.ActionSheet");
			jQuery.sap.require("sap.ui.core.ResizeHandler");

			var BarOverflow = sap.ca.scfld.md.app.BarOverflow;
			var BarOverflowLayoutData = sap.ca.scfld.md.app.BarOverflowLayoutData;
			var Bar = sap.m.Bar;
			var Button = sap.m.Button;
			var ActionSheet = sap.m.ActionSheet;
			var ResizeHandler = sap.ui.core.ResizeHandler;

			module("initialization - rendering");

			test("Should not handle a sizechange before the bar's initial rendering", function() {
				// Arrange
				var oBar = new Bar();
				var oResizeSpy = this.spy(BarOverflow.prototype, "_handleSizeChange");

				// System under Test + Act
				var oBarOverflow = new BarOverflow(oBar, new ActionSheet());

				// Assert
				strictEqual(oResizeSpy.callCount, 0, "Did not call handle sizeChange before rendering");

				// Cleanup
				oBarOverflow.destroy();
				oBar.destroy();
			});

			test("Should handle a sizechange after the bar's initial rendering", function() {
				// Arrange
				var oBar = new Bar();
				var oResizeSpy = this.spy(BarOverflow.prototype, "_handleSizeChange");

				// System under Test
				var oBarOverflow = new BarOverflow(oBar, new ActionSheet());

				// Act
				oBar.placeAt("qunit-fixture");
				sap.ui.getCore().applyChanges();

				// rerender again, we make sure its 2 size changes not 3
				oBar.rerender();
				sap.ui.getCore().applyChanges();

				// Assert
				strictEqual(oResizeSpy.callCount, 2, "Did call handle sizeChange after the initial rendering");

				// Cleanup
				oBarOverflow.destroy();
				oBar.destroy();
			});

			test("Should handle a sizechange if the bar was already rendered", function() {
				// Arrange
				var oBar = new Bar();
				var oResizeSpy = this.spy(BarOverflow.prototype, "_handleSizeChange");

				oBar.placeAt("qunit-fixture");
				sap.ui.getCore().applyChanges();

				// System under Test + Act
				var oBarOverflow = new BarOverflow(oBar, new ActionSheet());

				// Assert
				strictEqual(oResizeSpy.callCount, 1, "Did call handle sizeChange");

				// Cleanup
				oBarOverflow.destroy();
				oBar.destroy();
			});

			module("initialization - resizing");

			test("Should handle a resize of the bar", function() {
				// Arrange
				var oBar = new Bar();
				var oResizeSpy = this.spy(BarOverflow.prototype, "_handleSizeChange");
				var oResizeHandlerStub = this.stub(ResizeHandler, "register", $.noop);

				// System under Test
				var oBarOverflow = new BarOverflow(oBar, new ActionSheet());

				// Rendering
				oBar.placeAt("qunit-fixture");
				sap.ui.getCore().applyChanges();

				// Act
				oResizeHandlerStub.callArg(1);

				// Assert
				strictEqual(oResizeSpy.callCount, 2, "Did call handle sizeChange twice initial rendering and size change");

				// Cleanup
				oBarOverflow.destroy();
				oBar.destroy();
			});

			module("destruction");

			test("Should deregister Sizechange on BarOverflows destruction", function() {
				// Arrange
				var oBar = new Bar();
				var oResizeSpy = this.spy(BarOverflow.prototype, "_handleSizeChange");
				var oRegisterStub = this.stub(ResizeHandler, "register", function () {
					return 42;
				});
				var oDeregisterStub = this.stub(ResizeHandler, "deregister", $.noop);

				// System under Test
				var oBarOverflow = new BarOverflow(oBar, new ActionSheet());

				// Render
				oBar.placeAt("qunit-fixture");
				sap.ui.getCore().applyChanges();

				// Act
				oBarOverflow.destroy();

				// Assert
				strictEqual(oDeregisterStub.callCount, 1, "Did deregister");
				strictEqual(oDeregisterStub.getCall(0).args[0], 42, "Did deregister the correct listener");

				// Cleanup
				oBar.destroy();
			});


			test("Should deregister onAfterRendering on BarOverflows destruction", function() {
				// Arrange
				var oBar = new Bar();
				var oResizeSpy = this.spy(BarOverflow.prototype, "_handleSizeChange");

				// System under Test
				var oBarOverflow = new BarOverflow(oBar, new ActionSheet());

				// Render
				oBar.placeAt("qunit-fixture");
				sap.ui.getCore().applyChanges();

				// Act
				oBarOverflow.destroy();

				oBar.rerender();

				// Assert
				strictEqual(oResizeSpy.callCount, 1, "Did call handle sizeChange only once");

				// Cleanup
				oBar.destroy();
			});

			module("overflow handling");

			test("Should move an overflowing button to the overflow action sheet", function() {
				// Arrange
				var oOverflowingButton = new sap.m.Button({
					width : "400px"
				});

				var oBar = new Bar({
					contentRight : [oOverflowingButton]
				});
				var oActionSheet = new sap.m.ActionSheet();
				var oResizeHandler = this.spy();

				$("#qunit-fixture").css("width", "300px");

				// System under Test
				var oBarOverflow = new BarOverflow(oBar, oActionSheet, oResizeHandler);

				// Act
				oBar.placeAt("qunit-fixture");
				sap.ui.getCore().applyChanges();

				// Assert
				strictEqual(oResizeHandler.callCount, 1, "Did add a button to the action sheet");
				ok(oResizeHandler.calledWith([oOverflowingButton]), "The button was the overflowing button");

				// Cleanup
				oActionSheet.destroy();
				oBar.destroy();
				oBarOverflow.destroy();
				$("#qunit-fixture").css("width", "");
			});

			test("Should only move overflowing buttons to the action sheet", function() {
				// Arrange
				var oNotOverflowingButton1 = new sap.m.Button({
					width : "100px"
				});
				var oNotOverflowingButton2 = new sap.m.Button({
					width : "100px"
				});
				var oOverflowingButton1 = new sap.m.Button({
					width : "200px"
				});
				var oOverflowingButton2 = new sap.m.Button({
					width : "200px"
				});

				var oBar = new Bar({
					contentRight : [ oNotOverflowingButton1, oNotOverflowingButton2, oOverflowingButton1, oOverflowingButton2 ]
				});
				var oActionSheet = new sap.m.ActionSheet();
				var oResizeHandler = this.spy();

				$("#qunit-fixture").css("width", "300px");

				// System under Test
				var oBarOverflow = new BarOverflow(oBar, oActionSheet, oResizeHandler);

				// Act
				oBar.placeAt("qunit-fixture");
				sap.ui.getCore().applyChanges();

				// Assert
				strictEqual(oResizeHandler.callCount, 1, "Did add a button to the action sheet");
				ok(oResizeHandler.calledWith([oOverflowingButton1, oOverflowingButton2]), "The button was the overflowing button");

				// Cleanup
				oActionSheet.destroy();
				oBar.destroy();
				oBarOverflow.destroy();
				$("#qunit-fixture").css("width", "");
			});

			module("layout data - move to overflow");

			test("Should not move Buttons that have moveToOverflow = false", function() {
				// Arrange
				var oNotMoveableButton = new sap.m.Button({
					width : "150px",
					layoutData : new BarOverflowLayoutData({
						moveToOverflow : false
					})
				});
				var oOverFlowingButton = new sap.m.Button({
					width : "100px"
				});
				var oNotOverflowingButton = new sap.m.Button({
					width : "100px"
				});

				var oBar = new Bar({
					contentRight : [ oNotMoveableButton, oNotOverflowingButton, oOverFlowingButton ]
				});
				var oActionSheet = new sap.m.ActionSheet();
				var oResizeHandler = this.spy();
				$("#qunit-fixture").css("width", "300px");

				// System under Test
				var oBarOverflow = new BarOverflow(oBar, oActionSheet, oResizeHandler);

				// Act
				oBar.placeAt("qunit-fixture");
				sap.ui.getCore().applyChanges();

				// Assert
				strictEqual(oResizeHandler.callCount, 1, "Did add a button to the action sheet");
				ok(oResizeHandler.calledWith([oOverFlowingButton]), "The first overflowing button is in the actionSheet");

				// Cleanup
				oActionSheet.destroy();
				oBar.destroy();
				oBarOverflow.destroy();
				$("#qunit-fixture").css("width", "");
			});

			module("layout data - stay in overflow");

			test("Should always move Buttons that have stayInOverflow = true", function() {
				// Arrange
				var oSmallButton = new sap.m.Button({
					width : "100px",
					layoutData : new BarOverflowLayoutData({
						stayInOverflow : true
					})
				});

				var oBar = new Bar({
					contentRight : [ oSmallButton ]
				});
				var oActionSheet = new sap.m.ActionSheet();
				var oResizeHandler = this.spy();
				$("#qunit-fixture").css("width", "300px");

				// System under Test
				var oBarOverflow = new BarOverflow(oBar, oActionSheet, oResizeHandler);

				// Act
				oBar.placeAt("qunit-fixture");
				sap.ui.getCore().applyChanges();

				// Assert
				strictEqual(oResizeHandler.callCount, 1, "Did add a button to the action sheet");
				ok(oResizeHandler.calledWith([oSmallButton]), "The first overflowing button is in the actionSheet");

				// Cleanup
				oActionSheet.destroy();
				oBar.destroy();
				oBarOverflow.destroy();
				$("#qunit-fixture").css("width", "");
			});

			function moveAllButtonsToBar (aButtons) {
				this._oActionSheet.getButtons().forEach(function (oButton) {
					this._oBar.addContentRight(oButton);
				}, this);
			}

			test("Should not move Buttons out of the actionSheet that have stayInOverflow = true", function() {
				// Arrange
				var oSmallButton = new sap.m.Button({
					width : "100px"
				});
				var oStayInOverflowButton = new sap.m.Button({
					width : "100px",
					layoutData : new BarOverflowLayoutData({
						stayInOverflow : true
					})
				});

				var oBar = new Bar({
					contentRight : oStayInOverflowButton
				});
				var oActionSheet = new sap.m.ActionSheet({
					buttons : oSmallButton
				});
				var oResizeHandler = this.spy(moveAllButtonsToBar);
				$("#qunit-fixture").css("width", "300px");

				// System under Test
				var oBarOverflow = new BarOverflow(oBar, oActionSheet, oResizeHandler);

				// Act
				oBar.placeAt("qunit-fixture");
				sap.ui.getCore().applyChanges();

				sap.ui.getCore().applyChanges();

				// Assert
				strictEqual(oResizeHandler.callCount, 2, "Did invoke the resize twice");
				ok(oResizeHandler.firstCall.args.length === 0, "First call for clearing the bar");
				ok(oResizeHandler.secondCall.args[0][0] === oStayInOverflowButton, "The actionSheet contains the stayInOverflowButton");

				// Cleanup
				oActionSheet.destroy();
				oBar.destroy();
				oBarOverflow.destroy();
				$("#qunit-fixture").css("width", "");
			});

			test("Should also move big buttons when a small one has stayInOverflow = true", function() {
				// Arrange
				var oSmallButton = new sap.m.Button({
					width : "100px",
					layoutData : new BarOverflowLayoutData({
						stayInOverflow : true
					})
				});
				var oBigButton = new sap.m.Button({
					width : "400px"
				});

				var oBar = new Bar({
					contentRight : [ oSmallButton, oBigButton ]
				});
				var oActionSheet = new sap.m.ActionSheet();
				var oResizeHandler = this.spy();

				$("#qunit-fixture").css("width", "300px");

				// System under Test
				var oBarOverflow = new BarOverflow(oBar, oActionSheet,oResizeHandler);

				// Act
				oBar.placeAt("qunit-fixture");
				sap.ui.getCore().applyChanges();

				// Assert
				strictEqual(oResizeHandler.callCount, 1, "Did add both buttons to the action sheet");
				ok(oResizeHandler.calledWith([oBigButton, oSmallButton]), "The actionSheet contains the stayInOverflowButton");

				// Cleanup
				oActionSheet.destroy();
				oBar.destroy();
				oBarOverflow.destroy();
				$("#qunit-fixture").css("width", "");
			});

			test("Should not reserve space for buttons with stayInOverflow = true", function() {
				// Arrange
				var oSmallButton = new sap.m.Button({
					width : "100px",
				});
				var oBigButton = new sap.m.Button({
					width : "400px",
					layoutData : new BarOverflowLayoutData({
						stayInOverflow : true
					})
				});

				var oBar = new Bar({
					contentRight : [ oSmallButton, oBigButton ]
				});
				var oActionSheet = new sap.m.ActionSheet();
				var oResizeHandler = this.spy();
				$("#qunit-fixture").css("width", "300px");

				// System under Test
				var oBarOverflow = new BarOverflow(oBar, oActionSheet, oResizeHandler);

				// Act
				oBar.placeAt("qunit-fixture");
				sap.ui.getCore().applyChanges();

				// Assert
				strictEqual(oResizeHandler.callCount, 1, "Did add both buttons to the action sheet");
				ok(oResizeHandler.calledWith([oBigButton]), "The big button is in the actionSheet");

				// Cleanup
				oActionSheet.destroy();
				oBar.destroy();
				oBarOverflow.destroy();
				$("#qunit-fixture").css("width", "");
			});

			module("layout data - Overflow button");


			test("Should show the overflow button if there is a button in the actionsheet", function() {
				// Arrange
				var oOverflowButton = new sap.m.Button({
					width : "250px",
					layoutData : new BarOverflowLayoutData({
						overflowButton : true
					})
				});
				var oSmallButton = new sap.m.Button({
					width : "100px",
					layoutData : new BarOverflowLayoutData({
						stayInOverflow : true
					})
				});

				var oBar = new Bar({
					contentRight : [ oSmallButton, oOverflowButton ]
				});
				var oActionSheet = new sap.m.ActionSheet();
				var oResizeHandler = this.spy();
				$("#qunit-fixture").css("width", "300px");

				// System under Test
				var oBarOverflow = new BarOverflow(oBar, oActionSheet, oResizeHandler);

				// Act
				oBar.placeAt("qunit-fixture");
				sap.ui.getCore().applyChanges();

				// Assert
				strictEqual(oResizeHandler.callCount, 1, "Called once");
				ok(oResizeHandler.calledWith([oSmallButton]), "The small button is in the actionSheet");
				strictEqual(oOverflowButton.getVisible(), true, "overflow is visible");

				// Cleanup
				oActionSheet.destroy();
				oBar.destroy();
				oBarOverflow.destroy();
				$("#qunit-fixture").css("width", "");
			});

			module("underflow handling");

			test("Should move buttons out of the actionsheet if there is space in the bar and there are stay in overflow buttons", function() {
				// Arrange
				var oSmallButton = new sap.m.Button({
					width : "150px"
				});
				var oSmallButton2 = new sap.m.Button({
					width : "100px"
				});
				var oOverflowingButton = new sap.m.Button({
					width : "100px"
				});
				var oStayInOverflowButton = new sap.m.Button({
					width : "300px",
					layoutData : new BarOverflowLayoutData({
						stayInOverflow : true
					})
				});

				var oBar = new Bar({
					contentRight : [ oSmallButton, oSmallButton2, oOverflowingButton, oStayInOverflowButton ]
				});
				var oActionSheet = new sap.m.ActionSheet();
				var oResizeHandler = this.spy();
				//make the bar small that no buttons fit anymore
				$("#qunit-fixture").css("width", "0px");

				// System under Test
				var oBarOverflow = new BarOverflow(oBar, oActionSheet, oResizeHandler);

				// Act
				oBar.placeAt("qunit-fixture");
				sap.ui.getCore().applyChanges();

				//make the bar big again to have enough space for all the buttons to fit in there
				$("#qunit-fixture").css("width", "300px");
				//resize handler would trigger this but sinon prevent it from doing so
				oBarOverflow._handleSizeChange();

				// Assert
				strictEqual(oResizeHandler.callCount, 2, "Called twice");
				ok(oResizeHandler.calledWith([oOverflowingButton, oStayInOverflowButton]), "Only overflowing buttons are in the actionSheet");

				// Cleanup
				oActionSheet.destroy();
				oBar.destroy();
				oBarOverflow.destroy();
				$("#qunit-fixture").css("width", "");
			});

			module("Order of buttons");

			function ButtonOrderTestCase (sTestName, oOptions){
				test(sTestName, function () {
					// Arrange
					var oFirstButton = new Button(oOptions.firstButton)
					var oSecondButton = new sap.m.Button(oOptions.secondButton);
					var oThirdButton = new sap.m.Button(oOptions.thirdButton);

					var oBar = new Bar({
						contentRight : [ oFirstButton, oSecondButton, oThirdButton ]
					});
					var oActionSheet = new sap.m.ActionSheet();
					//make the bar small that only the DoNotMoveButton and one small button fits
					$("#qunit-fixture").css("width", "300px");

					// System under Test
					var oBarOverflow = new BarOverflow(oBar, oActionSheet);

					// Act
					oBar.placeAt("qunit-fixture");
					sap.ui.getCore().applyChanges();

					//make the bar big again to have enough space for all the buttons to fit in there
					$("#qunit-fixture").css("width", "400px");
					//resize handler would trigger this but sinon prevent it from doing so
					oBarOverflow._handleSizeChange();
					sap.ui.getCore().applyChanges();

					// Assert
					strictEqual(oBar.getContentRight().length, 3, "Did add a buttons to the bar");
					strictEqual(oBar.getContentRight()[0].sId, oFirstButton.sId, "The first button is still in the same place");
					strictEqual(oBar.getContentRight()[1].sId, oSecondButton.sId, "Second button is correct");
					strictEqual(oBar.getContentRight()[2].sId, oThirdButton.sId, "Third one is also correct");

					// Cleanup
					oActionSheet.destroy();
					oBar.destroy();
					oBarOverflow.destroy();
					$("#qunit-fixture").css("width", "");
				});
			}

			ButtonOrderTestCase("Buttons should be in the same order if the first one is not moveable", {
				firstButton : {
					width : "150px",
					layoutData : new BarOverflowLayoutData({
						moveToOverflow : false
					})
				},
				secondButton : {
					width : "100px"
				},
				thirdButton : {
					width : "100px"
				}
			});

			ButtonOrderTestCase("Buttons should be in the same order if the second one is not moveable", {
				firstButton : {
					width : "150px"
				},
				secondButton : {
					width : "100px",
					layoutData : new BarOverflowLayoutData({
						moveToOverflow : false
					})
				},
				thirdButton : {
					width : "100px"
				}
			});

			ButtonOrderTestCase("Buttons should be in the same order if the third one is not moveable", {
				firstButton : {
					width : "150px"
				},
				secondButton : {
					width : "100px"
				},
				thirdButton : {
					width : "100px",
					layoutData : new BarOverflowLayoutData({
						moveToOverflow : false
					})
				}
			});

			module("Button text modification");

			test("Should move buttons to the action sheet if one gets bigger", function() {
				// Arrange
				var oSmallButton = new sap.m.Button({
					width : "100px"
				});
				var oGrowingButton = new sap.m.Button({
					width : "100px"
				});
				$("#qunit-fixture").css("width", "300px");

				var oBar = new Bar({
					contentRight : [ oGrowingButton, oSmallButton ]
				});
				var oActionSheet = new sap.m.ActionSheet();
				var oResizeSpy = this.spy();

				// System under Test
				var oBarOverflow = new BarOverflow(oBar, oActionSheet, oResizeSpy);

				// Act
				oBar.placeAt("qunit-fixture");
				sap.ui.getCore().applyChanges();

				oGrowingButton.setWidth("250px");
				sap.ui.getCore().applyChanges();

				// Assert
				ok(!oBarOverflow._iTimeout, "Async resize handler not yet registered");
				oBarOverflow.buttonTextChanged();
				ok(oBarOverflow._iTimeout, "Async resize handler registered");

				// Cleanup
				oActionSheet.destroy();
				oBar.destroy();
				oBarOverflow.destroy();
				$("#qunit-fixture").css("width", "");
			});

			module("Non button controls");

			test("Should not move a Slider to the ActionSheet", function() {
				// Arrange
				var oSlider = new sap.m.Slider({
					width : "300px"
				});
				var oOverflowingSelect = new sap.m.Select({
					width : "100px"
				});
				$("#qunit-fixture").css("width", "50px");

				var oBar = new Bar({
					contentRight : [ oSlider, oOverflowingSelect ]
				});
				var oActionSheet = new sap.m.ActionSheet();
				var oResizeSpy = this.spy();

				// System under Test
				var oBarOverflow = new BarOverflow(oBar, oActionSheet, oResizeSpy);

				// Act
				oBar.placeAt("qunit-fixture");
				sap.ui.getCore().applyChanges();

				// Assert
				strictEqual(oResizeSpy.callCount, 1, "Did call resize");
				strictEqual(oResizeSpy.firstCall.args.length, 1, "Only contained one control");
				strictEqual(oResizeSpy.firstCall.args[0][0].sId, oOverflowingSelect.sId, "The select was moved");

				// Cleanup
				oActionSheet.destroy();
				oBar.destroy();
				oBarOverflow.destroy();
				$("#qunit-fixture").css("width", "");
			});
		})(jQuery);
	</script>
</head>
<body id="body" class="sapUiBody">
<h1 id="qunit-header">qUnit Page for sap.ca.scfld.md.app.BarOverflow</h1>
<h2 id="qunit-banner"></h2>
<h2 id="qunit-userAgent"></h2>
<ol id="qunit-tests"></ol>
<div id="qunit-fixture"></div>
</body>
</html>
