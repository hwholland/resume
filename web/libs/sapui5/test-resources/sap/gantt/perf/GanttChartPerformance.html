<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta charset="UTF-8">

<title>GanttChart</title>

<script id="sap-ui-bootstrap"
	data-sap-ui-libs="sap.gantt, sap.m, sap.ui.unified"
	data-sap-ui-theme="sap_bluecrystal"
	src="../../../../resources/sap-ui-core.js">
</script>

<script src="../test.js"></script>
<script src="PerfSetting.js"></script>
<script>
	//Global Variables
	var oModel;
	var oGanttChart;

	var oSettings = sap.ui.jsfragment("sap.gantt.perf.UISettings", this).placeAt("content");
	var oCreateDataModelButton = new sap.m.Button({
		text: "Create Data Model",
		press: fnCreateModel
	});

	var oCreateGanttChartButton = new sap.m.Button({
		text: "Create Gantt Chart",
		press: fnCreateGanttChart
	});
	oSettings.addContent(oCreateDataModelButton);
	oSettings.addContent(oCreateGanttChartButton);

	var oMessageLabel = new sap.m.Label({text: ""});
	new sap.m.Toolbar({content: [oMessageLabel]}).placeAt("content");
	sap.ui.getCore().byId('views').setEnabled(false);

	var byId = sap.ui.getCore().byId;
	var oPerfSetting = new sap.gantt.perf.PerfSetting();
	//Create Data
	function fnCreateModel (){
		//get the input value
		var iRows = parseInt(byId('rows').getValue(), 10);
		var iActivities = parseInt(byId('shapes').getValue(), 10);
		var iHierarchies = parseInt(byId('hierarchy').getValue(), 10);
		var bRelationships = byId('relationship').getSelected();
		var bCalendar = byId('calendar').getSelected();
		var bWarning = byId('warning').getSelected();

		oPerfSetting = new sap.gantt.perf.PerfSetting({
			numberOfRow: iRows,
			numberOfShape: iActivities,
			levelOfHierarchy: iHierarchies,
			includeToolbar: false,
			showCalendar: bCalendar,
			showWarning: bWarning,
			showRelationship: bRelationships
		});
		
		// load test data
		oData = oPerfSetting.generate();
		// create model and load data
		oModel = new sap.ui.model.json.JSONModel();
		oModel.setSizeLimit(1000000);
		oModel.setData(oData);
		oMessageLabel.setText("Data model been created.");
	}
	//Call for the data model creation when load page
	fnCreateModel();

	// create paintServeDef
	jQuery.sap.require("sap.gantt.def.SvgDefs");
	jQuery.sap.require("sap.gantt.def.filter.MorphologyFilter");
	jQuery.sap.require("sap.gantt.def.pattern.SlashPattern");
	jQuery.sap.require("sap.gantt.def.pattern.BackSlashPattern");
	jQuery.sap.require("sap.gantt.def.gradient.LinearGradient");
	jQuery.sap.require("sap.gantt.def.cal.CalendarDefs");
	jQuery.sap.require("sap.gantt.def.cal.Calendar");
	jQuery.sap.require("sap.gantt.def.cal.TimeInterval");
	
	var oSvgDefs = new sap.gantt.def.SvgDefs({
		defs: [new sap.gantt.def.pattern.BackSlashPattern("pattern_backslashFilled_F2F2F2", {
			stroke: "#F2F2F2",
			strokeWidth:1
		}), new sap.gantt.def.pattern.BackSlashPattern("pattern_backslash_grey", {
			stroke: "#CAC7BA"
		}), new sap.gantt.def.pattern.SlashPattern("pattern_slash_grey", {
			stroke: "#CAC7BA"
		}), new sap.gantt.def.pattern.SlashPattern("pattern_slash_blue", {
			stroke: "#008FD3"
		}), new sap.gantt.def.pattern.SlashPattern("pattern_slash_green", {
			stroke: "#99D101"
		}), new sap.gantt.def.pattern.SlashPattern("pattern_slash_orange", {
			stroke: "#F39B02"
		}), new sap.gantt.def.pattern.SlashPattern("pattern_slash_lightblue", {
			stroke: "#9FCFEB"
		}), new sap.gantt.def.filter.MorphologyFilter("PSmorphologyFilter", {})]
	});

	// define order shape class
	sap.ui.define(["sap/gantt/shape/Rectangle"], function (Rectangle) {
		var OrderShape = Rectangle.extend("sap.test.gantt.OrderShape", {});
		OrderShape.prototype.getFill = function(oRawData){
			if (this.mShapeConfig.hasShapeProperty("fill")) {
				return this._configFirst("fill", oRawData);
			}
			if (oRawData.status === 0) {
				return "#FFFFFF";
			} else if (oRawData.status === 1) {
				switch (oRawData.type) {
				case 0:
					return "#CAC7BA";
				case 1:
					return "#008FD3";
				case 2:
					return "#99D101";
				case 3:
					return "#F39B02";
				case 4:
					return "#9FCFEB";
				default:
					return "#CAC7BA";
				}	
			} else if (oRawData.status === 2) {
				switch (oRawData.type) {
				case 0:
					return sap.ui.getCore().byId("pattern_slash_grey").getRefString();
				case 1:
					return sap.ui.getCore().byId("pattern_slash_blue").getRefString();
				case 2:
					return sap.ui.getCore().byId("pattern_slash_green").getRefString();
				case 3:
					return sap.ui.getCore().byId("pattern_slash_orange").getRefString();
				case 4:
					return sap.ui.getCore().byId("pattern_slash_lightblue").getRefString();
				default:
					return sap.ui.getCore().byId("pattern_slash_grey").getRefString();
				}
			}
		};
		OrderShape.prototype.getStroke = function (oRawData) {
			if (this.mShapeConfig.hasShapeProperty("stroke")) {
				return this._configFirst("stroke", oRawData);
			}
			switch (oRawData.type) {
			case 0:
				return "#CAC7BA";
			case 1:
				return "#008FD3";
			case 2:
				return "#99D101";
			case 3:
				return "#F39B02";
			case 4:
				return "#9FCFEB";
			default:
				return "#CAC7BA";
			}	
		};
		return OrderShape;
	}, true);

	// Define group
	sap.ui.define(["sap/gantt/shape/Group"], function (Group) {
		var RectangleGroup = Group.extend("sap.test.gantt.RectangleGroup",{});
		RectangleGroup.prototype.getRLSAnchors = function(oRawData, oObjectInfo){
			var shapes = this.getShapes();
			var rectangleShapeClass;
			for(var i in shapes){
				if(shapes[i] instanceof sap.gantt.shape.Rectangle){
					rectangleShapeClass = shapes[i];
				}
			}
			var _x = rectangleShapeClass.getX(oRawData);
			var _y = rectangleShapeClass.getY(oRawData, oObjectInfo) + rectangleShapeClass.getHeight()/2;
			return {
				startPoint: {
					x: _x,
					y: _y,
					height:rectangleShapeClass.getHeight(oRawData),
				},
				endPoint: {
					x: _x + rectangleShapeClass.getWidth(oRawData),
					y: _y,
					height:rectangleShapeClass.getHeight(oRawData),
				}
			};
		}; 
		return RectangleGroup;
	}, true);

	// define selection class
	sap.ui.define(["sap/gantt/shape/SelectedShape"], function (SelectedShape) {
		var RectPath = SelectedShape.extend("sap.test.gantt.RectPath", {});
		RectPath.prototype.getFill = function(oRawData){
			return "none";
		};
		RectPath.prototype.getStroke = function (oRawData) {
			switch (oRawData.type) {
			case 0:
				return "#000000"; //black
			case 1:
				return "#FFFF00"; //yellow
			case 2:
				return "#FF00FF"; //light purple
			case 4:
				return "#CC0099"; //purple
			case "TOL":
				return "#0000FF"; //blue
			default:
				return "#FF0000"; //red
				
			}
		};
		RectPath.prototype.getStrokeWidth = function (oRawData) {
			return 2;
		};
		return RectPath;
	}, true);

	//Relationship config
	var oRelConfig = new sap.gantt.config.Shape({
		key: "relationship",
		shapeDataName: "relationship",
		modeKeys: ["A"],
		level: 30,
		shapeClassName: "sap.gantt.shape.ext.rls.Relationship",
		shapeProperties: {
			isDuration: false,
			lShapeforTypeFS: true,
			showStart: false,
			showEnd: true,
			stroke: "{stroke}",
			strokeWidth: 1,
			type: "{relation_type}",
			fromObjectPath:"{fromObjectPath}",
			toObjectPath:"{toObjectPath}",
			fromDataId:"{fromDataId}",
			toDataId:"{toDataId}",
			fromShapeId:"{fromShapeId}",
			toShapeId:"{toShapeId}",	
			title: "{tooltip}"
		}
	});



	// create GanttChart
	function fnCreateGanttChart(){
		//Destroy
		oGanttChart && oGanttChart.destroy();
		
		// create configuration objects
		sap.gantt.config.DEFAULT_TIME_AXIS.setPlanHorizon(new sap.gantt.config.TimeHorizon(oPerfSetting.getTimeHorizon()));
		
		sap.gantt.config.DEFAULT_TIME_AXIS.setInitHorizon(new sap.gantt.config.TimeHorizon(oPerfSetting.getTimeHorizon()));

		if (byId('relationship').getSelected() || byId('text').getSelected()){
			var oGroupAggregation = [];
			oGroupAggregation.push(new sap.gantt.config.Shape({
				shapeClassName: "sap.test.gantt.OrderShape",
				shapeProperties: {
					time: "{startTime}",
					endTime: "{endTime}",
					title: "{tooltip}",
					rx: 0,
					ry: 0,
					isDuration: true
				}
			}));
			if(byId('text').getSelected()){
				oGroupAggregation.push(new sap.gantt.config.Shape({
					shapeClassName: "sap.gantt.shape.Text",
					shapeProperties: {
						time: "{startTime}",
						text: "{start_loc_id}",
						xBias: 0,
						yBias: 0,
						textAnchor: "start",
						fill:"black",
						isDuration: false
					}
				}));
				oGroupAggregation.push(new sap.gantt.config.Shape({
					shapeClassName: "sap.gantt.shape.Text",
					shapeProperties: {
						time: "{endTime}",
						text: "{end_loc_id}",
						xBias: 0,
						yBias: 0,
						textAnchor: "end",
						fill:"black",
						isDuration: false
					}
				}));
			}
			// create shape configuration
			var oShapeConfig = new sap.gantt.config.Shape({
				key: "ActivityKey",
				shapeDataName: "activity",
				modeKeys: ["A"],
				level: 10,
				shapeClassName: "sap.test.gantt.RectangleGroup",
				shapeProperties: {
					time: "{startTime}",
					endTime: "{endTime}",
					rx: 0,
					ry: 0,
					isDuration: true
				},
				selectedClassName: "sap.test.gantt.RectPath",
				groupAggregation: oGroupAggregation
			});
		}
		else{
			// create shape configuration
			var oShapeConfig = new sap.gantt.config.Shape({
				key: "activity",
				shapeClassName: "sap.gantt.shape.Rectangle",
				shapeDataName: "activity",
				level: 10,
				shapeProperties: {
					time: "{startTime}",
					endTime: "{endTime}",
					fill: "#A52A2A",
					height: 21,
					rx: 10,
					ry: 10,
					yBias: 0.5,
					isDuration: true
				}
			});
		}
		var oShapeConfigCalendar = new sap.gantt.config.Shape({
			key: "calendar",
			shapeClassName: "sap.gantt.shape.cal.Calendar",
			shapeDataName: "nwt",
			level: 30,
			shapeProperties: {
				height: 33,
				isDuration: false,
				calendarName: "{id}"
			}
		});
		var oImageConfig = new sap.gantt.config.Shape({
			key: "image",
			shapeClassName: "sap.gantt.shape.Image",
			shapeDataName: "warning",
			level: 5,
			shapeProperties: {
				time: "{time}",
				image: "../image/{iconName}.png",
				height: 17,
				filter: sap.ui.getCore().byId("PSmorphologyFilter").getRefString(),
				title: "{tooltip}"
			}
		});
		var oShape=[];
		var oShapeName=[];
		oShape.push(oShapeConfig);
		oShapeName.push("activity");
		if(byId('calendar').getSelected()){
			oShape.push(oShapeConfigCalendar);
			oShapeName.push("nwt");
		}
		if(byId('relationship').getSelected()){
			oShape.push(oRelConfig);
			oShapeName.push("relationship");
		}
		if(byId('warning').getSelected()){
			oShape.push(oImageConfig);
			oShapeName.push("warning");
		}

		//Activate the measurement
		jQuery.sap.measure.setActive(true);
		//Measure Start
		jQuery.sap.measure.start("createGantt");
		jQuery.sap.measure.start("tillRowsUpdated");
		console.info("Track started");
		var tA1 = new Date();


		oGanttChart = new sap.gantt.GanttChart({
			shapeDataNames: oShapeName,
			svgDefs: oSvgDefs,
			locale: sap.gantt.config.DEFAULT_LOCALE_CET,
			shapes: oShape,
			rows: {
				path: "test>/root",
					parameters: {
						arrayNames: ["children"]
					}
			},
			relationships:{
				path: "test>/root/relationships"
			},
			calendarDef: new sap.gantt.def.cal.CalendarDefs({
				defs: {
					path: "test>/calendar",
					template: new sap.gantt.def.cal.Calendar({
						key: "{test>id}",
						timeIntervals: {
							path: "test>data",
							templateShareable: true,
							template: new sap.gantt.def.cal.TimeInterval({
								startTime: "{test>startTime}",
								endTime: "{test>endTime}"
							})
						}
					})
				}
			})
		});
		oGanttChart.setModel(oModel, "test");

		
		oGanttChart.placeAt("content");
		oMessageLabel.setText("Gantt Chart been created.");

		var iCountRendering = 0;
		//Add delegate for rendering event
		oGanttChart.addDelegate({
			onBeforeRendering: function () {
				jQuery.sap.measure.start("onBeforeRendering");
				jQuery.sap.measure.start("rendering");
			},
			onAfterRendering: function () {
				jQuery.sap.measure.start("onAfterRendering");
			}
		}, true);
		oGanttChart.addDelegate({
			onBeforeRendering: function () {
				jQuery.sap.measure.end("onBeforeRendering");
			},
			onAfterRendering: function () {
				jQuery.sap.measure.end("onAfterRendering");
				jQuery.sap.measure.end("rendering");
				oGanttChart.jumpToPosition();
				//Output the rendering time
				var tA2 = new Date();
				var tA3 = tA2 - tA1;
				var iRendering = jQuery.sap.measure.getMeasurement("rendering").duration;
				var iBeforeRendering = jQuery.sap.measure.getMeasurement("onBeforeRendering").duration;
				var iAfterRendering = jQuery.sap.measure.getMeasurement("onAfterRendering").duration;
				console.info("Before Rendering: " + iBeforeRendering + "ms.(Press CTRL+SHIFT+ALT+S for more details.)");
				console.info("Rendering: " + iRendering + "ms.(Press CTRL+SHIFT+ALT+S for more details.)");
				console.info("During event of onAfterRendering: " + iAfterRendering + "ms.(Press CTRL+SHIFT+ALT+S for more details.)");
				//Collect all perf tracking logs
				var allMeasures = jQuery.sap.measure.getAllMeasurements();
				var ganttRelatedMeasures = allMeasures.filter(function(oItem){ 
					return oItem.info && oItem.info.indexOf("GanttPerf") > -1;
				});
				var sortedGanttMeasures = ganttRelatedMeasures.sort(function(oItem1, oItem2){ 
					return oItem1.end - oItem2.end;
				});
				var ganttPerfResult = "";
				for(var i=0; i < sortedGanttMeasures.length; i++) {
					var durationTime = sortedGanttMeasures[i].time.toFixed(2);
					console.info("Perf info:" + sortedGanttMeasures[i].info + " time:" + durationTime + "ms"); 
				}
				//Attach Event
				var iRU = 0;
				var iTime;
				function fnChart(){
					//oGantt.getGanttCharts()[parseInt(oViewsInput.getValue(),10)-1]._oTC.detachEvent("_rowsUpdated", fnChart);
					if(iRU==0){
						jQuery.sap.measure.end("createGantt");
						iTime = jQuery.sap.measure.getMeasurement("createGantt").duration;
					}
					else{
						jQuery.sap.measure.end("eventTemp");
						iTime = iTime + jQuery.sap.measure.getMeasurement("eventTemp").duration;
					}
					//Display the result
					oMessageLabel.setText("Gantt Creation Time- INDEX" + iRU + " -- "+ iTime + "ms.(Press CTRL+SHIFT+ALT+S for more details.)");
					console.info("Gantt Creation Time- INDEX" + iRU + " -- "+ iTime + "ms.");
					jQuery.sap.measure.start("eventTemp");
					iRU++;
				}
				oGanttChart._oTT.attachEvent("_rowsUpdated", fnChart);
				oGanttChart._oTT.addDelegate({
					onBeforeRendering: function () {
						//jQuery.sap.measure.end("onBeforeRendering");
					},
					onAfterRendering: function () {
						fnChart()
					}
				}, false);
			}
		}, false);
	}
</script>
</head>
<body id="body" class="sapUiBody sapUiSizeCompact">
	<h1 id="header">Test Page for <code>sap.gantt.GanttChart</code></h1>
	<div id="content" style="width: 98vw; height: calc(96vh - 200px); margin-bottom: 40px"></div>
</body>
</html>
