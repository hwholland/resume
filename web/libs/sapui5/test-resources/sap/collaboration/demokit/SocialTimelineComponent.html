<!DOCTYPE HTML>
<html data-sap-ui-dk-category="Components/Collaboration" data-sap-ui-dk-controls="sap.collaboration.components.socialtimeline.Component">
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta charset="UTF-8"/>
		<title>Social Timeline Component - SAPUI5 Demo Kit</title>
		<script id="sap-ui-bootstrap"
				src="../../../../resources/sap-ui-core.js"
				data-sap-ui-theme="sap_bluecrystal"
				data-sap-ui-libs="sap.m,sap.ui.commons,sap.ui.demokit"
				>
		</script>
		
		<script>
			jQuery.sap.require("sap.ui.model.odata.ODataAnnotations");
			jQuery.sap.require("sap.collaboration.library");
			jQuery.sap.require("sap.ui.core.util.MockServer");
			jQuery.sap.getObject("sap.ui.demokit", 0)._supportedThemes = ["sap_bluecrystal"];
			
			// OData Timeline Service settings. 
			var oSettings = {
				rootUri: "/sap/opu/odata/sap/Z_TIMELINE_SRV/",
				boCollection: "TestBusinessObjects",
				mockdata: {
						metadata: "mockserver/testserviceodata/ServiceMetadata.xml",
						responses: "mockserver/testserviceodata"
				}
			};
			
			// OData Timeline Service Mock Server. 
			jQuery.sap.require("sap.ui.core.util.MockServer");
			this.oMockServer = new sap.ui.core.util.MockServer({rootUri: oSettings.rootUri});
			this.oMockServer.simulate(oSettings.mockdata.metadata, { bGenerateMissingMockData : false });

			var aRequests = this.oMockServer.getRequests();
			aRequests.push({
				method : "GET",
				path : new RegExp("TestBusinessObjects.*TestTimelineNavigationPath.*"),
				response : function(oXhr) {
					oXhr.respondFile(200, null, 'mockserver/testserviceodata/TimelineEntries.json');
					return true;
				}
			});
			
			this.oMockServer.setRequests(aRequests);
			this.oMockServer.start();

			// OData SM Integration settings. 
			var oSMISettings = {
				rootUri: "/sap/opu/odata/sap/SM_INTEGRATION_V2_SRV/"
			};

			// OData SM Integration Service Mock Server. 
			this.oSMIMockServer = new sap.ui.core.util.MockServer({rootUri: oSMISettings.rootUri});
			this.oSMIMockServer.simulate("mockserver/smiodata/SMIV2_metadata.xml", { bGenerateMissingMockData : false });
			
			var aRequests = this.oSMIMockServer.getRequests();
			aRequests.push({
	 			method: "GET",
	 			path: new RegExp("GetJamConfigurationStatus"),
	 			response: function(oXhr){
	 				oXhr.respondFile(200, null, 'mockserver/smiodata/GetJamConfigurationStatus.json');
	 				return true;
	 			}
	 		});
	 		aRequests.push({
	 			method: "GET",
	 			path: new RegExp("MapInternalBOToExternalBO.+"),
	 			response: function(oXhr){
	 				oXhr.respondFile(200, null, 'mockserver/smiodata/MapInternalBOToExternalBO.json');
	 				return true;
	 			}
	 		});
	 		aRequests.push({
	 			method: "GET",
	 			path: new RegExp("GetCollaborationHostURL"),
	 			response: function(oXhr){
	 				oXhr.respondJSON(200, null, '{"d":{"GetCollaborationHostURL":{"__metadata":{"type":"SM_INTEGRATION_V2_SRV.CollaborationHostURL"},"URL":"http://example.com/"}}}');
	 				return true;
	 			}
	 		});

			this.oSMIMockServer.setRequests(aRequests);
			this.oSMIMockServer.start();                                                   

			// OData Jam Service settings. 
			var oJamSettings = {
				rootUri: "/sap/bc/ui2/smi/rest_tunnel/Jam/api/v1/OData/"
			};
			
			// OData Jam Service Mock Server. 
			this.oJamMockServer = new sap.ui.core.util.MockServer({rootUri: oJamSettings.rootUri});
			this.oJamMockServer.simulate("mockserver/jamodata/JamODataV1_metadata.xml", { bGenerateMissingMockData : false });
			
			var aRequests = this.oJamMockServer.getRequests();			
			aRequests.push({
	 			method: "GET",
	 			path: new RegExp(""),
	 			response: function(oXhr){
	 				oXhr.respondFile(200, { "x-csrf-token" : "123456" }, 'mockserver/jamodata/JamODataRoot.json');
	 				return true;
	 			}
	 		});
			aRequests.push({
	 			method: "GET",
	 			path: new RegExp("Self"),
	 			response: function(oXhr){
					oXhr.respondFile(200, null, 'mockserver/jamodata/Self.json');
					return true;
	 			}
	 		});
			aRequests.push({
	 			method: "POST",
	 			path: new RegExp("ExternalObjects.+"),
	 			response: function(oXhr){
					oXhr.respondFile(200, null, 'mockserver/jamodata/ExternalObjects.json');
					return true;
	 			}
	 		});
			aRequests.push({
				method : "GET",
				path : new RegExp("ExternalObjects.*FeedEntries.*"),
				response : function(oXhr) {
					oXhr.respondFile(200, null, 'mockserver/jamodata/FeedEntries.json');
					return true;
				}
			});
			aRequests.push({
				method : "GET",
				path : new RegExp("Members_Autocomplete.*"),
				response : function(oXhr) {
					oXhr.respondFile(200, null, 'mockserver/jamodata/Members_AutoComplete.json');
					return true;
				}
			});
			aRequests.push({
	 			method: "GET",
	 			path: new RegExp("ExternalObjects_FindByExidAndObjectType.+"),
	 			response: function(oXhr){
					oXhr.respondFile(200, null, 'mockserver/jamodata/ExternalObjects_FindByExidAndObjectType.json');
					return true;
	 			}
	 		});
			aRequests.push({
				method : "GET",
				path : new RegExp("FeedEntries.*Replies.*"),
				response : function(oXhr) {
					oXhr.respondFile(200, null, 'mockserver/jamodata/Replies.json');
					return true;
				}
			});
			aRequests.push({
				method : "POST",
				path : new RegExp("FeedEntries.*Replies"),
				response : function(oXhr) {
					oXhr.respondJSON(201, null, '{"d":{"message": "Reply added..."}}');
					return true;
				}
			});
			aRequests.push({
				method : "POST",
				path : new RegExp("Activities"),
				response : function(oXhr) {
					oXhr.respondFile(201, null, 'mockserver/jamodata/Activities.json');
					return true;
				}
			});
			aRequests.push({
				method : "GET",
				path : new RegExp("Activities.*FeedEntry.*"),
				response : function(oXhr) {
					oXhr.respondFile(200, null, 'mockserver/jamodata/FeedEntryFromActivity.json');
					return true;
				}
			});
			aRequests.push({
				method : "GET",
				path : new RegExp("MemberProfiles.*PhoneNumbers"),
				response : function(oXhr) {
					oXhr.respondFile(200, null, 'mockserver/jamodata/PhoneNumbers.json');
					return true;
				}
			});
			this.oJamMockServer.setRequests(aRequests);
			this.oJamMockServer.start();                                                   
		</script>
		<script>
		var oServiceConfig = {annotationURI: oSettings.rootUri+"$metadata", json: true};
		var oServiceModel = new sap.ui.model.odata.ODataModel( oSettings.rootUri, oServiceConfig);
		
		// WORKAROUND: if the browser is IE, annotations in the oService Models needs to be modified
		// because of a bug in the way the ODataModel gets created with the mockserver
		if (navigator.userAgent.match(/MSIE/g)){
			oServiceModel.oAnnotations.oAnnotations["Z_TIMELINE_SRV.TestBusinessObject"] = 
			{	"com.sap.vocabularies.Timeline.v1.TimelineNavigationPath":
				{ NavigationPropertyPath: "TestTimelineNavigationPath"	
				}
			};
			oServiceModel.oAnnotations.oAnnotations["Z_TIMELINE_SRV.TestTimelineEntry"] = 
			{	"com.sap.vocabularies.Timeline.v1.TimelineEntry":
				{ 	ActionText: {EdmType: "Edm.String", Path: "TestActionText"},
					ActorExtID: {EdmType: "Edm.String", Path: "TestActorExtID"}, 
					ActorID: {EdmType: "Edm.String", Path: "TestActorID"}, 
					ActorName: {EdmType: "Edm.String", Path: "TestActorName"}, 
					ID: {EdmType: "Edm.String", Path: "TestID"},
					Icon: {EdmType: "Edm.String", Path: "TestIcon"}, 
					SummaryText: {EdmType: "Edm.String", Path: "TestSummaryText"}, 
					TimeStamp: {EdmType: "Edm.DateTimeOffset", Path: "TestTimeStamp"}, 
					TimelineDetailNavigationPath: {NavigationPropertyPath: "TestTimelineDetailNavigationPath"}
				}
			};
			oServiceModel.oAnnotations.oAnnotations["Z_TIMELINE_SRV.TestTimelineDetailPropertyValueChange"] = 
			{	"com.sap.vocabularies.Timeline.v1.TimelineDetailPropertyValueChange":
				{ 	AfterValue: {EdmType: "Edm.String", Path: "TestAfterValue"}, 
					BeforeValue: {EdmType: "Edm.String", Path: "TestBeforeValue"}, 
					ChangeType: {EdmType: "Edm.String", Path: "TestChangeType"}, 
					PropertyLabel: {EdmType: "Edm.String", Path: "TestPropertyLabel"}
				}
			};
		}
		</script>
		<script id='SocialTimeline'>
		/* 
		*	Create Social Timeline Component with the event 'customActionPress'.
		*/
			var oSocialTimeline = sap.ui.getCore().createComponent({
				name:"sap.collaboration.components.socialtimeline",
				id:"socialTimeline",
				settings: {
					customActionPress: function(oEventData){				
						var sTimelineEntryId = oEventData.getParameter("timelineEntryId");
						
						 if(oEventData.getParameter('key') === 'key1'){
							 var oDialog = new sap.m.Dialog({
									showHeader: false,
									content:[new sap.m.Text({text: "Enter text to change the content of the Social Timeline Entry."}),
									         new sap.m.Input({})],
									beginButton: new sap.m.Button({
										text: "OK",
										press: function(){
											oDialog.close();
										}
									}),
									afterClose: function(){
										oSocialTimeline.updateTimelineEntry(oDialog.getContent()[1].getValue(), sTimelineEntryId);
									}
								});
								oDialog.open();					 
						} 
						 else if(oEventData.getParameter('key') === 'key2'){
							 var oDialog = new sap.m.Dialog({
								 showHeader: false,
								 content: [new sap.m.Text({text: "Press OK to delete the Social Timeline Entry."})],
								 beginButton: new sap.m.Button({
									 text: "OK",
									 press: function(){
										 oDialog.close();
									 }
								 }),
								 afterClose: function(){
									 oSocialTimeline.deleteTimelineEntry(sTimelineEntryId);
								 }
							 });
							 oDialog.open();
						 }
					}
				}
			});
			/* 
			*	Set the object map by calling the method setBusinessObjectMap. We pass an object that contains information about the 
			*	business object, as well as a customActionCallback.
			*/			
			oSocialTimeline.setBusinessObjectMap({
				serviceModel: oServiceModel,
				collection: oSettings.boCollection,
				applicationContext: "TEST_APP_CONTEXT",
				servicePath: "TestServicePath",
				customActionCallback: function(oOdataEntry){
                	if(oOdataEntry.TestActorID === "CARTER-NORA" || oOdataEntry.TestActorID === "SAINTCRUIS"){
                		return [{key:"key1", value: "Edit"}, {key:"key2", value: "Delete"}]
                	}
				}
			});
			oSocialTimeline.setBusinessObjectKey("'1'");
			/* 	!!!Workaround for the Demokit only!!!
			* 	We need to override the buildImageURL method of the TimelineDataHandler class and insert our own image URLs.
			* 	The function buildImageURL is called by the Social Timeline to build the image URL for the browser to download 
			*	every user's image. Since we want to provide a local copy, we override this method and provide the relative path
			*	to the images.
			*/
			oSocialTimeline._oTimelineDataHandler.buildImageUrl = function(sId, sImageType){
				if(sId == "koDcHD2h5xygJGwV5gNHxS"){
					return "images/logos/SAPAG4.jpg"
				}
				else if(sId == "xCI9iuB0No10Jtko4PXUPP"){
					return "images/logos/SAPAG1.jpg"
				}
				else if(sId == "qhfLzxA31KcZpkk2dJbgPE"){
					return "images/logos/SAPAG2.png"
				}
				else if(sId == "h2QGgLDlDMedlL0fcbEruN"){
					return "images/logos/SAPAG3.png"
				}
				else return ""
			}
			
			/* 
			*	Create Component Container for the Social Timeline Component.
			*/
			var oSocialTimelineContainer = new sap.ui.core.ComponentContainer("socialTimelineContainer", { component: oSocialTimeline });
			oSocialTimelineContainer.setHeight("100%");

			var oSplitter = new sap.ui.commons.Splitter("splitter");
			oSplitter.setSplitterOrientation(sap.ui.commons.Orientation.vertical);
			oSplitter.setSplitterPosition("70%");
			oSplitter.setHeight("800px");
			oSplitter.setWidth("800px");
			oSplitter.addFirstPaneContent(oSocialTimelineContainer);
			oSplitter.placeAt("example1");
		</script>
	</head>
	
	<body class="sapUiDemokitBody" role="application">
		<h1 color="Blue" icon="images/comps/timeline.png">Social Timeline Component</h1>
		
		<h2>Introduction</h2>
		<p>
			The <b>Social Timeline</b> component is an SAPUI5 component that allows you to display "socialized" entries in chronological order from newest to oldest in a SAP Fiori app.<br>
			The source of the entries can come from backend business object events and SAP Jam feeds.<br>
			"Socialized" entries means that users can "Reply" to SAP Jam feeds, view other users' SAP Jam profiles and SAP Jam profile images. In addition, users can also post to SAP Jam.<br>
			
		</p>
		<p>
			The Social Timeline component requires a map containing information for the business object. Use the function <em>setBusinessObjectMap</em> to set the map to the Social Timeline component. <br>
			In addition, the Social Timeline requires the key of the business object to be set.	Use the function <em>setBusinessObjectKey</em> to set the key.<br>
			The details of the map can be found in the API documentation. See link below.
		</p>
		
		<!-- a invisible dummy heading to avoid automatic insertion of a 'settings' section -->
		<h2 id="settings" style="display:none">Settings</h2>
		
		<h2>Example</h2>

		<div code-sample="example1" script="SocialTimeline"></div>
		<br/>
		
		<h2>API Documentation</h2>
		<p>See <a class="sapUiDemokitSrcLink" href="../../../../docs/api/symbols/sap.collaboration.components.socialtimeline.Component.html" >Social Timeline Component </a>API documentation</p>  
						
	</body>
</html>
