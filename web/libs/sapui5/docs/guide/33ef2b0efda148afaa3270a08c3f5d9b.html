<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en-us">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="abstract" content=""/>
<meta name="description" content=""/>

<link rel="stylesheet" type="text/css" href="css/prettify.css?x=8695020320077711"/>
<link rel="stylesheet" type="text/css" href="css/documentation.css?x=8695020320077711"/>
<title>Step 2: Associating the Rule Expression Language</title>
  <link rel="stylesheet" type="text/css" href="../../resources/sap/ui/demokit/themes/base/highlight-query-terms.css" />
    <link rel="stylesheet" type="text/css" href="../../resources/sap/ui/demokit/js/google-code-prettify/prettify.css" />
    <script src="../../resources/sap/ui/demokit/js/sdk-pagehelper.js"></script>
  </head>
<body class="" id="loio33ef2b0efda148afaa3270a08c3f5d9b">
<div id="wrapper"><div id="container">

	<h1 class="title topictitle1">Step 2: Associating the Rule Expression Language</h1>

	
	<div class="body conbody"><p class="shortdesc"/>

		<p class="p">The rule expression language provides the required services for rule authoring, rule
			visualization, and rule content validation. The services provided by the
				<samp class="ph codeph">ExpressionLanguage</samp> object include  expression validations,
			expression parsing, auto-complete suggestions, retrieval of expression metadata and
			tokens, and performing runtime services such as fetching data objects, outputs, and so
			on.</p>

		<p class="p">The vocabulary OData model and the binding context path for the specific vocabulary are
			mandatory input for the rule expression language.</p>

		<p class="p">The <samp class="ph codeph">ExpressionLanguage</samp> object is an association of the
				<samp class="ph codeph">RuleBuilder</samp> object, and it can be associated with multiple
				<samp class="ph codeph">RuleBuilder</samp> objects.</p>

		<div class="section" id="loio33ef2b0efda148afaa3270a08c3f5d9b__section_f5q_rp3_rz"><div class="section_title">Preview</div><div type="Preview">
			
			<div class="fig fignone" id="loio33ef2b0efda148afaa3270a08c3f5d9b__fig_jmj_j2p_rz"><div class="figcontainer">
				
				<img class="image" id="loio33ef2b0efda148afaa3270a08c3f5d9b__image_t1m_l2p_rz" src="loio40a97b449edb4a0dac303a8440d1453e_LowRes.png"/>
			<div class="figcap">Decision Table with Guided Input</div></div></div>

		</div></div>

		<div class="section" id="loio33ef2b0efda148afaa3270a08c3f5d9b__section_mjx_fn3_rz"><div class="section_title">Coding</div><div type="Coding">
			
			<p class="p">You can view and download all files <span class="ph">at <a class="xref" target="_blank" href="../../explored.html#/sample/sap.rules.ui.sample.GuidedDecisionTable/preview" alt="../../explored.html#/sample/sap.rules.ui.sample.GuidedDecisionTable/preview" title="../../explored.html#/sample/sap.rules.ui.sample.GuidedDecisionTable/preview">Rule Builder - Guided Decision
					Table</a></span>.</p>

		</div></div>

		<div class="section" id="loio33ef2b0efda148afaa3270a08c3f5d9b__section_fmw_sp3_rz"><div class="section_title">Page.controller.js</div><div type="Page.controller.js">
			
			<div class="div_pre_codeblock"><pre class="pre codeblock prettyprint lang-js"> 
sap.ui.define([
	'jquery.sap.global',
	'sap/ui/core/mvc/Controller',
	'sap/ui/model/odata/v2/ODataModel',
	'sap/rules/ui/services/ExpressionLanguage',
	'sap/ui/core/util/MockServer',
	'sap/m/MessageToast'
], function (jQuery, Controller, ODataModel, ExpressionLanguage, MockServer, MessageToast) {
	"use strict";

	return Controller.extend("sap.rules.ui.sample.GuidedDecisionTable.Page", {

		onInit: function () {

			sap.ui.getCore().applyTheme("sap_belize");

			// apply compact density for desktop, the cozy design otherwise
			this.getView().addStyleClass(sap.ui.Device.system.desktop ? "sapUiSizeCompact" : "sapUiSizeCozy");

			var mPath = jQuery.sap.getModulePath("sap.rules.ui.sample.GuidedDecisionTable", "/");
			
			// Initialize Expression Language services
			this.oVocabularyMockServer = new MockServer({rootUri: "/sap/opu/odata/SAP/vocabulary_srv/"});
			this.oVocabularyMockServer.simulate(
				mPath + "localService/vocabulary/metadata.xml",
				{'sMockdataBaseUrl': mPath + "localService/vocabulary/mockdata/"}
			);
			this.oVocabularyMockServer.start();
			this.oVocabularyModel = new ODataModel("/sap/opu/odata/SAP/vocabulary_srv/");
			this.oExpressionLanguage = new ExpressionLanguage();
			this.oExpressionLanguage.setModel(this.oVocabularyModel);
			this.oExpressionLanguage.setBindingContextPath("/Vocabularies('FA163E38C6481EE785F409DCAD583D43')");

			// Initialize the Rule Builder
			this.oRuleMockServer = new MockServer({rootUri: "/sap/opu/odata/SAP/RULE_SRV/"});
			this.oRuleMockServer.simulate(
				mPath + "localService/rule/metadata.xml",
				{'sMockdataBaseUrl': mPath + "localService/rule/mockdata/"}
			);

			var aRequests = this.loadRequests(mPath);
			this.oRuleMockServer.setRequests(aRequests);
			this.oRuleMockServer.start();
			this.oRuleModel = new ODataModel({
				serviceUrl: "/sap/opu/odata/SAP/RULE_SRV/",
				defaultBindingMode: sap.ui.model.BindingMode.TwoWay
			});

			var oRuleBuilder = this.byId("ruleBuilder");
			oRuleBuilder.setModel(this.oRuleModel);
			oRuleBuilder.setExpressionLanguage(this.oExpressionLanguage);
			oRuleBuilder.setBindingContextPath("/Rules(Id='FA163E38C6481EE785F409DCAD583D43',Version='000001')");
		},

		handleEditButton: function () {
			var oEditButton = this.byId("editButton");
			var oRuleBuilder = this.byId("ruleBuilder");
			var bEdit = (oEditButton.getText() === "Edit");
			oRuleBuilder.setEditable(bEdit);
			oEditButton.setText(bEdit ? "Display" : "Edit");
		},

		onAfterRendering: function () {

			// Line actions are not supported in this demo
			var oRuleBuilder = this.byId("ruleBuilder");
			var oDecisionTable = oRuleBuilder.getAggregation("_rule");
			var oToolbar = oDecisionTable.getAggregation("_toolbar");
			var arrContent = oToolbar.getContent();
			for (var i = 0; i &lt; arrContent.length; i++) {
				if (arrContent[i].getMetadata().getName() === "sap.m.Button") {
					arrContent[i].detachPress(arrContent[i].mEventRegistry.press[0].fFunction, arrContent[i].mEventRegistry.press[0].oListner);
					arrContent[i].attachPress(function (oEvent) {
							var msg = 'Line action pressed';
							MessageToast.show(msg);
						}
					);
				} else if (arrContent[i].getMetadata().getName() === "sap.m.MenuButton") {
					var oMenu = arrContent[i].getMenu();
					oMenu.detachItemSelected(oMenu.mEventRegistry.itemSelected[1].fFunction, oMenu.mEventRegistry.itemSelected[1].oListner);
					oMenu.attachItemSelected(function (oEvent) {
							var msg = 'Line action pressed';
							MessageToast.show(msg);
						}
					);
				}
			}

		},

		loadRequests: function (mPath) {

			// The mock server does not support 1 to 1 navigation.
			// Hence we provide the responses directly by adding custom requests to the MockServer
			var oRresponses = jQuery.sap.sjax({
				type: "GET",
				url: mPath + "localService/rule/responses.json",
				dataType: "json"
				}	
			).data;
			
			var aRequests = this.oRuleMockServer.getRequests();
			var sMethod = "GET";
			var sPath = /Rules\(Id='FA163E38C6481EE785F409DCAD583D43',Version='000001'\)\/DecisionTable\/DecisionTableRows\/\$count/;
			var fnResponse1 = function (xhr) {
				xhr.respond(200, {
					"Content-Type": "text/plain;charset=utf-8"
				}, "5");
			};
			aRequests.push({method: sMethod, path: sPath, response: fnResponse1});
			
			sPath = /Rules\(Id='FA163E38C6481EE785F409DCAD583D43',Version='000001'\)\/DecisionTable\/DecisionTableRows\?\$skip=0&amp;\$top=\d+&amp;\$orderby=Sequence%20asc&amp;\$expand=Cells/;
			var response_1 = this.response_1;
			var fnResponse2 = function (xhr) {
				xhr.respondJSON(200, {
					"Content-Type": "application/json;charset=utf-8"
				}, oRresponses.response_1);
			};
			aRequests.push({method: sMethod, path: sPath, response: fnResponse2});

			sPath = /Rules\(Id='FA163E38C6481EE785F409DCAD583D43',Version='000001'\)\/DecisionTable\/DecisionTableColumns\/\$count/;
			var fnResponse3 = function (xhr) {
				xhr.respond(200, {
					"Content-Type": "text/plain;charset=utf-8"
				}, "5");
			}
			aRequests.push({method: sMethod, path: sPath, response: fnResponse3});

			sPath = /Rules\(Id='FA163E38C6481EE785F409DCAD583D43',Version='000001'\)\/DecisionTable\/DecisionTableColumns\?\$skip=0&amp;\$top=\d+&amp;\$expand=Condition%2cResult/;
			var response_2 = this.response_2;
			var fnResponse4 = function (xhr) {
				xhr.respondJSON(200, {
					"Content-Type": "application/json;charset=utf-8"
				}, oRresponses.response_2);
			}
			aRequests.push({method: sMethod, path: sPath, response: fnResponse4});

			return aRequests;
		}
	});
});</pre></div>

			<p class="p">This code adds an <samp class="ph codeph">ExpressionLanguage</samp> object to the view controller, and
				connects it to the <samp class="ph codeph">RuleBuilder</samp> as an association. For the
					<samp class="ph codeph">ExpressionLanguage</samp>, this code sets the model and then does all
				the necessary data binding internally (unlike other <span class="ph"><span class="ph pname">SAPUI5</span></span> controls where the
				developer defines the data binding). The data for
					<samp class="ph codeph">ExpressionLanguage</samp> is loaded via the vocabulary OData
				service.</p>

			<p class="p">The code also sets a binding context path on <samp class="ph codeph">RuleBuilder</samp> to the specific rule
				you are currently working on.</p>

			<p class="p">Now, when running the application, the decision table will be rendered filled with rule data
				from the mock server.</p>

			<div class="note note"><span class="notetitle">Note</span> 
				<p class="p"> If you are using a back-end system with the relevant implemented OData services, use the
					following code:</p>

				<div class="div_pre_codeblock"><pre class="pre codeblock prettyprint lang-js">sap.ui.define([
	'sap/ui/core/mvc/Controller',
	'sap/ui/model/odata/v2/ODataModel',
	'sap/rules/ui/services/ExpressionLanguage'
], function ( Controller, ODataModel, ExpressionLanguage) {
	"use strict";

	return Controller.extend("mySample.RuleBuilder.Page", {

		onInit: function () {

			// apply compact density for desktop, the cozy design otherwise
			this.getView().addStyleClass(sap.ui.Device.system.desktop ? "sapUiSizeCompact" : "sapUiSizeCozy");
			
			// Initialize Expression Language services
			this.oVocabularyModel = new ODataModel("/vocabulary_srv/");
			this.oExpressionLanguage = new ExpressionLanguage();
			this.oExpressionLanguage.setModel(this.oVocabularyModel);
			this.oExpressionLanguage.setBindingContextPath("/Vocabularies('<span class="keyword parmname">&lt;your rule ID&gt;</span>')");

			// Initialize the Rule Builder
			this.oRuleModel = new ODataModel({
				serviceUrl: "/sap/opu/odata/SAP/RULE_SRV/",
				defaultBindingMode: sap.ui.model.BindingMode.TwoWay
			});

			var oRuleBuilder = this.byId("ruleBuilder");
			oRuleBuilder.setModel(this.oRuleModel);
			oRuleBuilder.setExpressionLanguage(this.oExpressionLanguage);
			oRuleBuilder.setBindingContextPath("/Rules(Id='<span class="keyword parmname">&lt;your rule ID&gt;</span>',Version='000001')");
		},

		handleEditButton: function () {
			var oEditButton = this.byId("editButton");
			var oRuleBuilder = this.byId("ruleBuilder");
			var bEdit = (oEditButton.getText() === "Edit");
			oRuleBuilder.setEditable(bEdit);
			oEditButton.setText(bEdit ? "Display" : "Edit");
		}
	});
});</pre></div>

			</div>

		</div></div>

	</div>

</div></div>

</body>
</html>